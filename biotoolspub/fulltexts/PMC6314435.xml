<?all-math-mml yes?>
<?use-mml?>
<?properties open_access?>
<?properties manuscript?>
<?ManuscriptPrefix new?>
<?iso-abbr Nat. Methods?>
<?submitter-system ukmss?>
<?submitter-canonical-name Nature Publishing Group?>
<?submitter-canonical-id NATURE-STRUCTUR?>
<?submitter-userid 1005?>
<?submitter-authority publisher?>
<?submitter-login NPG?>
<?submitter-name Nature Publishing Group?>
<?domain wtpa?>
<?origin ukpmcpa?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-journal-id">101215604</journal-id>
    <journal-id journal-id-type="pubmed-jr-id">32338</journal-id>
    <journal-id journal-id-type="nlm-ta">Nat Methods</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat. Methods</journal-id>
    <journal-title-group>
      <journal-title>Nature methods</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1548-7091</issn>
    <issn pub-type="epub">1548-7105</issn>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6314435</article-id>
    <article-id pub-id-type="pmid">29553578</article-id>
    <article-id pub-id-type="doi">10.1038/nmeth.4634</article-id>
    <article-id pub-id-type="manuscript">ems76329</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Identification of spatial expression trends in single-cell gene expression data</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Edsgärd</surname>
          <given-names>Daniel</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Johnsson</surname>
          <given-names>Per</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Sandberg</surname>
          <given-names>Rickard</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A2">2</xref>
        <xref ref-type="corresp" rid="CR1">*</xref>
      </contrib>
    </contrib-group>
    <aff id="A1"><label>1</label>Department of Cell and Molecular Biology, Karolinska Institutet, Sweden</aff>
    <aff id="A2"><label>2</label>Ludwig Institute for Cancer Research, Stockholm, Sweden</aff>
    <author-notes>
      <corresp id="CR1"><label>*</label>correspondence to: <email>Rickard.Sandberg@ki.se</email></corresp>
    </author-notes>
    <pub-date pub-type="nihms-submitted">
      <day>17</day>
      <month>12</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>19</day>
      <month>3</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <month>5</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>02</day>
      <month>1</month>
      <year>2019</year>
    </pub-date>
    <volume>15</volume>
    <issue>5</issue>
    <fpage>339</fpage>
    <lpage>342</lpage>
    <!--elocation-id from pubmed: 10.1038/nmeth.4634-->
    <permissions>
      <license>
        <license-p>Users may view, print, copy, and download text and data-mine the content in such documents, for the purposes of academic research, subject always to the full Conditions of use:<ext-link ext-link-type="uri" xlink:href="http://www.nature.com/authors/editorial_policies/license.html#terms">http://www.nature.com/authors/editorial_policies/license.html#terms</ext-link></license-p>
      </license>
    </permissions>
    <abstract>
      <p id="P1">Methods for spatial gene expression analyses at single-cell resolution are becoming available, whereas computational strategies for spatial gene expression analyses are lacking. We present a computational method (<italic>trendsceek</italic>) based on marked point processes that identifies genes with significant spatial expression trends. <italic>Trendsceek</italic> identifies significant genes in spatial transcriptomics and sequential FISH data and also reveal significant gene expression gradients and hotspots in low-dimensional projections of dissociated single-cell RNA-seq data.</p>
    </abstract>
  </article-meta>
</front>
<body>
  <p id="P2">Analyses of gene expression at single-cell resolution and in spatial contexts will reveal insights into the molecular organizations of tissue and organs. Although transcriptome-wide single-cell gene expression analyses with spatial information is not yet feasible, recent progress in barcoded single-molecule FISH<xref rid="R1" ref-type="bibr">1</xref>,<xref rid="R2" ref-type="bibr">2</xref> have enabled sequential analyses of hundreds of genes in tissues<xref rid="R3" ref-type="bibr">3</xref>. In parallel, tissue sections lysed and reverse-transcribed on barcoded surfaces represents another approach for high-throughput analyses of gene expression with regional spatial information<xref rid="R4" ref-type="bibr">4</xref>. Although these approaches enable gene expression analyses in spatial context, spatial gene expression analyses methods are lacking. For example, cellular and regional expression profiles are typically analysed first without the spatial information and only later projected back onto the spatial structure for visual inspection of spatial trends<xref rid="R3" ref-type="bibr">3</xref>,<xref rid="R4" ref-type="bibr">4</xref>.</p>
  <p id="P3">Here, we introduce a computational method that identifies significant spatial gene expression trends that we named <italic>trendsceek</italic>. In order to identify genes with significant dependencies between the spatial distribution of cells and the gene expression in these cells, we model the data as marked point processes to rank and assess the significance of the spatial expression trends of each individual gene. We first validate the method on simulated data sets and thereafter demonstrate that <italic>trendsceek</italic> can identify genes with significant spatial patterns in spatial transcriptomics data (mouse olfactory bulb and breast cancer sections<xref rid="R4" ref-type="bibr">4</xref>) and in sequential FISH (seqFISH) data (hippocampus)<xref rid="R3" ref-type="bibr">3</xref>. Moreover, <italic>trendsceek</italic> could reveal significant gradients and patterns even for dissociated single-cell RNA-seq data<xref rid="R5" ref-type="bibr">5</xref> that had been projected to a low-dimensional space (t-distributed stochastic neighbour embedding, t-SNE<xref rid="R6" ref-type="bibr">6</xref>). Spatial patterns were found within low-dimensional clusters demonstrating the general utility of simultaneously incorporating expression and location information for finding significant spatial trends. Finally, <italic>trendsceek</italic> has been implemented as an R package to allow for broad applications to many types of spatial gene expression data.</p>
  <p id="P4">To model spatial gene expression we made use of marked point processes, a statistical framework which has previously been applied in the fields of geostatistics, astronomy and material physics<xref rid="R7" ref-type="bibr">7</xref>. For spatial analyses of gene expression, the points represent the spatial locations of cells (or regions) and the marks of each point constitute expression levels. Importantly, this approach is non-parametric and can identify general non-linear expression patterns without the need to specify a distribution or spatial region of interest. Briefly, our method assesses whether a significant dependency exist between the spatial distributions of points and their associated marks (expression levels) through pairwise analyses of points as a function of the distance (<italic>r, radius)</italic> between points. Summary statistics used for assessing dependencies include conditional mean (E-mark), conditional variance (V-mark), Stoyan's mark correlation (not a true correlation measure) and the mark-variogram (<xref ref-type="sec" rid="S2">Methods</xref>). Notably, if marks and the location of points are independent the scores obtained should be constant across the different distances <italic>r</italic>. To assess the significance of a gene’s spatial expression pattern we implemented a resampling procedure where the expression values were permuted, reflecting a null-model with no spatial dependency of the expression. Once a gene with a significant spatial trend has been identified it is also of interest to find the subset of cells in spatial regions of interest. To identify cells located in regions with higher expression than expected by chance, we implemented a method based on weighted kernel density estimation (wKDE) and compared against a null-model derived from permuted expression values.</p>
  <p id="P5">We first investigated the method on simulated spatial expression data (sampled from empirical seqFISH data; <xref ref-type="sec" rid="S2">Methods</xref>) where cells with higher expression were located in local hotspots, step-gradients or non-radial streaks, or where the expression followed a linear gradient (<xref ref-type="fig" rid="F1">Figure 1A</xref>). Exemplifying the analyses of the hotspot pattern, the mark-correlation and mark-variogram were significant at low <italic>r</italic> values (<xref ref-type="fig" rid="F1">Figure 1B</xref>, <italic>P</italic> &lt; 0.05) as determined via 1,000 randomly permuted expression distributions of the same marks (the 5% critical rejection band of these randomizations are shown as grey areas in <xref ref-type="fig" rid="F1">Figure 1B</xref>). Power analysis of the four metrices as a function of the number of cells, expression level, expression level difference and the size of the region with elevated expression are presented in <xref ref-type="supplementary-material" rid="SD13">Supplementary Figures 1, 2.</xref> The analysis revealed that spatial structures are reliably identified if at least 5% of sampled cells have differing expression levels, in particular when the total number of analysed cells exceed 500. For these patterns, the mark-variogram and mark-correlation based tests had the highest detection power, but E-mark and V-mark can have higher power in other cases (see results from real data below). We conclude that the method has sufficient power to reveal a variety of spatial patterns involving a small number of cells.</p>
  <p id="P6">Next, we developed an approach to identify the cells belonging to regions with elevated expression patterns. Using wKDE, we identified cells exceeding a 5% significance level (green surface in <xref ref-type="fig" rid="F1">Figure 1C</xref>) by comparison to the upper 5% quantile of a two-dimensional null distribution generated by resampling the mark distribution (blue surface in <xref ref-type="fig" rid="F1">Figure 1C</xref>). Significant cells are shown on top of the density estimate of the expression in <xref ref-type="fig" rid="F1">Figure 1D</xref>. Having developed a method for the identification of genes with spatial expression trends and an approach to pinpoint the cells belonging to regions of interest within the pattern, we next explored recently published gene expression data.</p>
  <p id="P7">We first analysed spatial transcriptomics data from olfactory bulb tissue<xref rid="R4" ref-type="bibr">4</xref>, and <italic>trendsceek</italic> identified 35 significant genes (<xref ref-type="fig" rid="F2">Figures 2A-B</xref>, <xref ref-type="supplementary-material" rid="SD13">Supplementary Figures 3A, 4A, 5A, 6A-B</xref> and <xref ref-type="supplementary-material" rid="SD2">Supplementary Tables 1</xref>, <xref ref-type="supplementary-material" rid="SD5">2</xref>, <xref ref-type="supplementary-material" rid="SD6">3</xref>; P &lt; 0.05, Benjamini-Hochberg adjusted) with expression primarily in non-granular cells. These genes included <italic>Ptn</italic>, <italic>Nr2f2</italic> and <italic>Fabp7</italic> which has been detected as tissue-domain restricted using principal component analyses (PCA)<xref rid="R4" ref-type="bibr">4</xref> and with clear spatial RNA in situ signatures in the Allen Brain Institute atlas (see <xref ref-type="supplementary-material" rid="SD13">Supplementary Figure 9</xref> in Ståhl et al. 2016<xref rid="R4" ref-type="bibr">4</xref>). We also identified 45 genes with significant expression primarily in granular regions of the bulb (<xref ref-type="fig" rid="F2">Figures 2C-D</xref>, <xref ref-type="supplementary-material" rid="SD13">Supplementary Figures 3B, 4B, 5B, 6C-D</xref> and <xref ref-type="supplementary-material" rid="SD2">Supplementary Tables 1</xref>, <xref ref-type="supplementary-material" rid="SD7">4</xref>, <xref ref-type="supplementary-material" rid="SD8">5</xref>) including known genes such as <italic>Nrgn</italic>, <italic>Camk4</italic> and <italic>Pcp4</italic> but also novel genes such as <italic>Gpsm1</italic> (<xref ref-type="fig" rid="F2">Figure 2C</xref>). A strength of spatial transcriptomics is the ability to profile tumour tissues. Applying <italic>trendsceek</italic> to spatial profiling of human breast cancer tissue (layer 2)<xref rid="R4" ref-type="bibr">4</xref> identified 14 genes with significant spatial expression (<xref ref-type="fig" rid="F2">Figure 2E</xref>, <xref ref-type="supplementary-material" rid="SD13">Supplementary Figures 3C, 4C, 7, 8</xref> and <xref ref-type="supplementary-material" rid="SD2">Supplementary Tables 1</xref>, <xref ref-type="supplementary-material" rid="SD9">6</xref>, <xref ref-type="supplementary-material" rid="SD10">7</xref>). Several genes implicated in breast cancer had significant spatial patterns, including the transcription factor <italic>KLF6</italic><xref rid="R8" ref-type="bibr">8</xref>, the transmembrane protein <italic>TMEPA1</italic><xref rid="R9" ref-type="bibr">9</xref>, and twelve genes related to the extracellular matrix (ECM). We conclude that <italic>trendsceek</italic> can be broadly applied to spatial transcriptomics data to find genes with significant spatial trends.</p>
  <p id="P8">The vast majority of single-cell RNA-sequencing has been performed on dissociated cells that lack spatial information. The analysis of single-cell gene expression data often include clustering and visualization of cells in low-dimensional spaces (using e.g. PCA or t-SNE). We determined whether <italic>trendsceek</italic> could find spatial patterns within two-dimensional representations of dissociated single-cell data. t-SNE analysis of scRNA-seq data from a mouse gastrulation dataset identified a larger cluster of 481 epiblast cells from E6.5 mice<xref rid="R5" ref-type="bibr">5</xref>, still <italic>trendsceek</italic> identified 107 genes with significant spatial expression patterns (<italic>P</italic> &lt; 0.05, Benjamini-Hochberg adjusted) within that cluster of cells (<xref ref-type="supplementary-material" rid="SD13">Supplementary Figure 9</xref>). The vast majority among the significant genes were characterized by an expression gradient with higher expression at the narrow part of the cell cluster (<xref ref-type="supplementary-material" rid="SD13">Supplementary Figure 10</xref>, exemplified by <italic>T</italic> and <italic>Fgf8</italic> in <xref ref-type="fig" rid="F2">Figure 2F</xref>). Moreover, we identified hotspots of male cells that separated from female cells with significant expression of <italic>Eif2s3y</italic> and <italic>Xist</italic>, respectively (<xref ref-type="fig" rid="F2">Figure 2G</xref> and <xref ref-type="supplementary-material" rid="SD2">Supplementary Tables 1</xref>, <xref ref-type="supplementary-material" rid="SD11">8</xref>, <xref ref-type="supplementary-material" rid="SD12">9</xref>; <italic>P</italic> &lt; 0.05, Benjamini-Hochberg adjusted). Different sets of genes were identified by the mark-correlation and mark-variogram based tests, indicating that the inclusion of multiple summary statistics improves sensitivity (<xref ref-type="supplementary-material" rid="SD13">Supplementary Figure 4D,H</xref>). We conclude that <italic>trendsceek</italic> can reveal diverse spatial patterns manifesting as gradients or hotspots within low-dimensional projections of dissociated single-cell data, in a fully unbiased manner without incorporating <italic>a priori</italic> knowledge about candidate genes.</p>
  <p id="P9">Finally, we applied <italic>trendsceek</italic> to sequential FISH data from 21 mouse hippocampus regions<xref rid="R3" ref-type="bibr">3</xref> that in total included approximately 3,500 cells and 249 genes. We identified genes with significant spatial patterns in 15 out of 21 regions (median of 54 genes per region) (<xref ref-type="supplementary-material" rid="SD13">Supplementary Figures 11, 12</xref> and <xref ref-type="supplementary-material" rid="SD3">Supplementary Tables 10</xref>, <xref ref-type="supplementary-material" rid="SD4">11</xref>), representative spatial patterns for five genes are shown in <xref ref-type="fig" rid="F2">Figure 2H</xref>. Regions A, C-F and Q contained no significant genes which may indicate greater homogeneity in these regions. This analysis demonstrated that <italic>trendsceek</italic> can identify a variety of spatial gene expression patterns in multiplexed FISH data.</p>
  <p id="P10">As single-cell gene expression analyses are being broadly applied in biology and biomedicine several computational analysis strategies have been developed<xref rid="R10" ref-type="bibr">10</xref>. Analyses of scRNAseq data often include the identification of variable genes<xref rid="R11" ref-type="bibr">11</xref>, followed by clustering and projections into low-dimensions, e.g using PCA and t-SNE, to identify discrete groups of cells<xref rid="R10" ref-type="bibr">10</xref>. Methods have also been developed to assign cells along continuous processes<xref rid="R12" ref-type="bibr">12</xref>–<xref rid="R15" ref-type="bibr">15</xref>, e.g. along a pseudo-time of development<xref rid="R15" ref-type="bibr">15</xref> or pseudo-space to capture niches<xref rid="R16" ref-type="bibr">16</xref>. These latter methods map the positions of the cells onto a one-dimensional axis which allows for regression against gene expression for the purpose of univariate gene selection. However, there can exist spatial expression trends that are not captured by a pseudo-time analysis, especially since these methods only take the spatial distribution of cells into account regardless of the presence of a spatial segregation with respect to the expression of individual genes. Similarly, a gene with high expression variability among cells may be unrelated to the spatial distribution of the cells.</p>
  <p id="P11"><italic>Trendsceek</italic> differs from these methods as it performs a gene-level test that jointly incorporates spatial and expression-level information. The spatial analysis complements existing methods that first cluster gene expression profiles, without including spatial information, followed by differential expression tests between clusters. In tissue sections comprised by distinct cell-types defined by multiple genes, a clustering strategy has high power, whereas spatial methods have the additional ability to identify continuous gradients or spatial expression patterns defined by a fewer number of genes which would be hard to identify by cell-cell expression profile correlation based clustering of cells (<xref ref-type="supplementary-material" rid="SD13">Supplementary Figure 13</xref>). In general, genes with significant spatial expressions were typically also identified as highly variable, although at widely different ranks (<xref ref-type="supplementary-material" rid="SD13">Supplementary Figure 14</xref>), reflecting that only a subset of highly variable genes have significant spatial expression patterns.</p>
  <p id="P12">For dissociated scRNAseq data, <italic>trendsceek</italic> is not intended to replace existing clustering approaches in high-dimensional space. Instead, <italic>trendsceek</italic> can reveal interesting patters within a cluster of cells, i.e. when clustering and low dimensional projections fail to separate cells into further meaningful groups. However, since projections of cells from n-gene to two-dimensional space distorts distances between cells, e.g. tSNE seeks only to preserve local distances, we recommend users to assess their results using several dimensionality reduction techniques.</p>
  <p id="P13">In this study, we explored various types of two-dimensional gene expression data, but future work could include extending the methodology to 3D data sets. The spatial metrics are currently based on first and second moments of the expression distribution, but higher order moments may be needed to identify certain types of spatial structures. <italic>Trendsceek</italic> runtimes are provided in <xref ref-type="supplementary-material" rid="SD13">Supplementary Figure 15</xref> and could be further sped up by caching the information regarding all pairs of points at each distance. We implemented <italic>trendsceek</italic> as an R package to facilitate the adoption of spatial gene expression analyses.</p>
  <sec sec-type="methods" id="S2" specific-use="web-only">
    <title>Online Methods</title>
    <sec id="S3">
      <title>Mark-segregation hypothesis testing</title>
      <p id="P15">To identify spatial gene expression trends, we made use of the theory for marked point processes, where the spatial distribution of cells are treated as a realization of a two-dimensional point process and the gene expression levels as a mark distribution where each point has a scalar-valued mark attached to it, corresponding to the expression of a gene for that cell. The marked point process can be described by a joint probability density <italic>f</italic><sub>1</sub>(<bold>x</bold>, <italic>m</italic>), denoting the probability of finding a point at <bold>x</bold> with mark m. Similarly, <italic>f</italic><sub>2</sub>((<bold>x</bold><sub>1</sub>, <italic>m</italic><sub>1</sub>), (<bold>x</bold><sub>2</sub>, <italic>m</italic><sub>2</sub>)) quantifies the probability density to find two points at <bold>x</bold><sub>1</sub> and <bold>x</bold><sub>2</sub> with marks m<sub>1</sub> and m<sub>2</sub>. In this study, we use properties of this two-point distribution, and parameterize it by the pair separation <italic>r</italic> = |<bold>x</bold><sub>2</sub> - <bold>x</bold><sub>1</sub>| and the marks m<sub>1</sub>, m<sub>2</sub>. In particular, we are interested in the probability of finding two marks given the separation of two points, <inline-formula><mml:math display="inline" id="M1" overflow="scroll"><mml:mrow><mml:msub><mml:mi>M</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo></mml:mrow></mml:msub><mml:msub><mml:mi>m</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>|</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>f</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mspace width="0.1em"/><mml:msub><mml:mi>m</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mspace width="0.1em"/><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>f</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></inline-formula> Studying the distribution of all pairs at a particular radius, a mark segregation is said to be present if this distribution is dependent on <italic>r</italic>, such that it deviates from what would be expected if the marks would be randomly distributed over the spatial locations of the points, that is, <inline-formula><mml:math display="inline" id="M2" overflow="scroll"><mml:mrow><mml:msub><mml:mi>M</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>|</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>≠</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:math></inline-formula></p>
      <p id="P16">To test for the presence of mark segregation we implemented permutation tests, where the mark distribution was sampled without replacement and expression levels were randomly reassigned to all cells keeping their positions fixed and in effect conditioning on the given spatial locations. Four summary statistics of the pair distribution was calculated for each radius and compared to the null distribution of the summary statistic derived from the permuted expression labels. As one null distribution and corresponding <italic>P</italic>-value was calculated for each radius we implemented a multiple-testing adjustment as to achieve a global <italic>P</italic>-value, which adjusts for that all possible radii are tested. This was done by for each permutation, taking the maximum among all null test-statistic across all radii as the null value for that permutation iteration. To account for that the expectation value of the summary statistic can differ between different radii we used the deviation from the summary statistics sample mean of the null distribution as test-statistic. The implemented tests are two-sided as the absolute value from the null sample mean was used. The resulting <italic>P</italic>-value for each gene was again multiple-testing adjusted to account for that several genes were tested (here the built-in R-function “p.adjust” could be used). Thus, the nominal <italic>P</italic>-value for a gene was calculated by deriving the following entities:</p>
      <p id="P17">A null distribution <inline-formula><mml:math display="inline" id="M3" overflow="scroll"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:munder><mml:mrow><mml:mi>max</mml:mi><mml:mo>⁡</mml:mo></mml:mrow><mml:mi>r</mml:mi></mml:munder><mml:mo>|</mml:mo><mml:mi>O</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:mi>E</mml:mi><mml:mo stretchy="false">[</mml:mo><mml:mi>O</mml:mi><mml:mo stretchy="false">]</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>|</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></inline-formula> where <italic>O(r)</italic> is a null-distribution of the summary statistic for each radius <italic>r</italic> after permuting the expression labels and <italic>D<sub>0</sub></italic> is a null-distribution with <italic>n</italic> values, corresponding to the number of permutations, containing the maximum deviation from the mean for each permutation. An observed deviation for every <italic>r</italic>, <inline-formula><mml:math display="inline" id="M4" overflow="scroll"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mi>Q</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi>=</mml:mi><mml:mo>|</mml:mo><mml:mi>Q</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:mi>E</mml:mi><mml:mo stretchy="false">[</mml:mo><mml:mi>O</mml:mi><mml:mo stretchy="false">]</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>|</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></inline-formula> where <italic>Q</italic> is the value of the summary statistic for the observed (not permuted) data and <italic>D<sub>Q</sub></italic> the observed deviations from the expected mean.</p>
      <p id="P18">Finally, the <italic>P</italic>-value was calculated via the rank, <italic>k</italic>, of the observed value compared to the null: <disp-formula id="FD1"><mml:math display="block" id="M5" overflow="scroll"><mml:mrow><mml:mi>k</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>n</mml:mi></mml:munderover><mml:mrow><mml:mi>I</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mn>0</mml:mn><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle><mml:mo>≥</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mi>Q</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo><mml:mtext>where</mml:mtext><mml:mspace width="0.3em"/><mml:mi>I</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mtable><mml:mtr><mml:mtd><mml:mn>1</mml:mn></mml:mtd><mml:mtd><mml:mrow><mml:mi>i</mml:mi><mml:mi>f</mml:mi><mml:mspace width="0.2em"/><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mn>0</mml:mn><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≥</mml:mo><mml:msub><mml:mi>D</mml:mi><mml:mi>Q</mml:mi></mml:msub></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mn>0</mml:mn></mml:mtd><mml:mtd><mml:mrow><mml:mi>o</mml:mi><mml:mi>t</mml:mi><mml:mi>h</mml:mi><mml:mi>e</mml:mi><mml:mi>r</mml:mi><mml:mi>w</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>e</mml:mi></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mrow></mml:mrow></mml:math></disp-formula>
<inline-formula><mml:math display="inline" id="M6" overflow="scroll"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>k</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math></inline-formula> where <italic>n</italic> is the number of permutations <disp-formula id="FD2"><mml:math display="block" id="M7" overflow="scroll"><mml:mrow><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mtext>nominal</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:munder><mml:mrow><mml:mi>min</mml:mi><mml:mo>⁡</mml:mo></mml:mrow><mml:mi>r</mml:mi></mml:munder><mml:mspace width="0.1em"/><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></disp-formula></p>
    </sec>
    <sec id="S4">
      <title>Mark-segregation summary statistics</title>
      <p id="P19">As mark-segregation summary statistics we used four previously known two-point spatial statistics (as implemented in R-package spatstat). All four statistics calculate a summary statistic for all pairs of points, conditioned on their separation distance, <italic>r</italic>. The four used statistics were, where <italic>P</italic> denotes the set of pairs belonging to pairs of points at distance <italic>r</italic> apart:</p>
      <p id="P20">Stoyan's mark-correlation function which uses the squared geometric mean of the marks for all pairs at a distance <italic>r</italic>, normalized with the squared mean over all points, regardless of distance<xref rid="R17" ref-type="bibr">17</xref>: <disp-formula id="FD3"><mml:math display="block" id="M8" overflow="scroll"><mml:mrow><mml:mi>ρ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>E</mml:mi><mml:msub><mml:mrow><mml:mo stretchy="false">[</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mi>m</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">]</mml:mo></mml:mrow><mml:mi>P</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:msup><mml:mover accent="true"><mml:mi>m</mml:mi><mml:mo>¯</mml:mo></mml:mover><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:math></disp-formula> The mean-mark function, which is the arithmetic mean over all points belonging to pairs of points separated by distance <italic>r</italic><xref rid="R18" ref-type="bibr">18</xref>: <disp-formula id="FD4"><mml:math display="block" id="M9" overflow="scroll"><mml:mrow><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>E</mml:mi><mml:msub><mml:mrow><mml:mo stretchy="false">[</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">]</mml:mo></mml:mrow><mml:mi>P</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:mfrac></mml:mrow></mml:math></disp-formula> The variance-mark function, which is the variance conditioned on the pairs separation<xref rid="R18" ref-type="bibr">18</xref>: <disp-formula id="FD5"><mml:math display="block" id="M10" overflow="scroll"><mml:mrow><mml:msub><mml:mi>V</mml:mi><mml:mrow><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>E</mml:mi><mml:msub><mml:mrow><mml:mo stretchy="false">[</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>−</mml:mo><mml:mi>E</mml:mi><mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>P</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo stretchy="false">]</mml:mo></mml:mrow><mml:mi>P</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></disp-formula> The mark-variogram of a marked point process, which is based on the squared difference of the marks for pairs of points at distance <italic>r</italic> apart<xref rid="R19" ref-type="bibr">19</xref>: <disp-formula id="FD6"><mml:math display="block" id="M11" overflow="scroll"><mml:mrow><mml:mi>γ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>E</mml:mi><mml:msub><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mn>2</mml:mn></mml:mfrac><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mi>P</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></disp-formula> As edge correction Ripley's isotropic correction was used<xref rid="R20" ref-type="bibr">20</xref>,<xref rid="R21" ref-type="bibr">21</xref>. Different summary statistics were included in the <italic>trendsceek</italic> test, since even if they are not all independent of each other, they capture different aspects of the first and second moment of a distribution and thereby have different power depending on the mark and spatial distribution under consideration (<xref ref-type="supplementary-material" rid="SD13">Figure S4</xref>).</p>
    </sec>
    <sec id="S5">
      <title>Run-time optimization</title>
      <p id="P21">The computational time complexity of the described approach is relatively high as all possible pair of points (<italic>O(n<sub>2</sub>)</italic>), for every permutation (<italic>O(k)</italic>) and gene (<italic>O(m)</italic>), needs to be assessed. To alleviate this, two functionalities were added to trendsceek. First, we implemented parallelization with respect to the iteration over genes, using the R Bioconductor package BiocParallel. Second, we implemented an early-stopping procedure where the number of permutations are increased in a step-wise fashion one order of magnitude at a time (10, 100, 1000, …). If the nominal <italic>P</italic>-value exceeds a given threshold (default = 0.2) then no further permutations are done for that gene.</p>
    </sec>
    <sec id="S6">
      <title>Identification of cells located in regions of high expression</title>
      <p id="P22">If a gene has been deemed to have an expression distribution that is conditionally dependent on the spatial location of the cells, according to the mark-segregation tests described above, then trendsceek provides a test to identify cells located in regions with higher expression level than expected if the marks of that gene would be randomly distributed. To test for this a null distribution is generated by holding the spatial distribution of the cells fixed and marks being randomly resampled without replacement. For each such permutation, a two-dimensional weighted kernel density estimation (wKDE) is performed using the expression levels as weights and a normal distribution with diagonal bandwidth as kernel. This generates a two-dimensional smoothed null distribution of expression values against which the wKDE of the observed expression values is compared. A one-sided test is performed to assess if the expression from the observed wKDE has higher expression than that corresponding to an upper significance level and cells located in regions passing the test are extracted.</p>
    </sec>
    <sec id="S7">
      <title>Power-analysis with synthetic data</title>
      <p id="P23">To assess the power of the mark-segregation tests we simulated datasets with four possible spatial expression patterns: local hotspot, step-gradient, linear-gradient and non-radial streaks. Sensitivity was calculated as the number of genes with significant P-value (≤ 0.05) among 100 independently simulated genes. To assess the robustness of the sensitivity estimate this was repeated three times and the mean sensitivity and bootstrap confidence interval (B = 100) of the mean estimate was calculated. The spatial distribution of the cells was generated using a random point pattern Poisson process. For the linear gradient, the expression of cells was linearly increased along one dimension. For the other three patterns, cells in a window shaped as one of the three evaluated spatial patterns were then spiked with higher expression values. As the number of cells present within the window varies for each realization of the simulation this can be viewed as including part of the variation introduced due to that the number of cells of a particular cell type that is retrieved when obtaining a tissue sample can vary. The expression values of the cells were bootstrap-sampled from empirical sequential FISH data<xref rid="R3" ref-type="bibr">3</xref>. Three parameters, apart from the shape of the spike-window, were varied in the power analysis: 1) the number of cells; 2) the size of the of the spike-window, corresponding to the number of cells that were to be spiked, and, 3) the expression values of the spiked cells were sampled from the upper quantile of the expression distribution where the quantile cutoff was set according to how the fold-change between the mean value of the upper quantile and the global mean, was varied. For the linear gradient two parameters were varied, the number of cells and the fold-change between the maximum and minimum expression. To assess the effect of the expression level on sensitivity, 10 out of 100 cells were spiked in a hotspot region and the fold-change (2, 5, 10) and the expression level (1, 10, 100 among the lowly expressed cells) was varied. All combinations of these fold-changes and expression levels were assessed.</p>
    </sec>
    <sec id="S8">
      <title>Comparison to spatially unaware differential expression algorithm</title>
      <p id="P24">To assess the difference between significant genes from <italic>trendsceek</italic> and a differential expression algorithm that does not include spatial information, one representative <italic>trendsceek</italic>-significant gene for each of the seven spatial patterns that was found in the spatial transcriptomics mouse olfactory bulb, the breast cancer and the scRNA-seq dataset was selected. For each of these genes, the cell-groups identified by <italic>trendsceek’s</italic> wKDE-based cell-detection algorithm were input, as to be contrasted, to the differential expression analysis program SCDE<xref rid="R22" ref-type="bibr">22</xref>.</p>
    </sec>
    <sec id="S9">
      <title>Analysis of mouse scRNA-seq data</title>
      <p id="P25">Read counts and cell-annotation meta-data from a mouse scRNA-seq gastrulation dataset<xref rid="R5" ref-type="bibr">5</xref> were downloaded (<ext-link ext-link-type="uri" xlink:href="http://gastrulation.stemcells.cam.ac.uk/data/counts.gz">http://gastrulation.stemcells.cam.ac.uk/data/counts.gz</ext-link>) and the subset of cells (n=481) belonging to cluster 3 was kept. This cluster of cells was implicated in the paper to contain genes exhibiting spatial patterns within the cluster. Genes were filtered on being expressed in at least 3 cells with a read count of at least 5, leaving 17,625 out of 41,388 Ensembl genes. A gene-variability statistic was calculated that adjusted for the mean-variance relationship present in single-cell RNA-seq data. This was done by assuming that the expression distribution of a gene follow a negative binomial for which the variance, <italic>v</italic>, depends on the mean, <italic>m</italic>, v = m + m<sup>2</sup>/r, where r is the overdispersion, implying that the coefficient of variance, cv<sup>2</sup> = v/m<sup>2</sup> = 1/m + 1/r. Assuming that the majority of genes only exhibit technical variability we fitted such a model to the read counts of all genes and a gene-variability statistic was then obtained for each gene by adjusting for the variability present among all genes conditioned on the mean expression level<xref rid="R11" ref-type="bibr">11</xref>. To stabilize the estimate, we performed winsorization of the expression distribution of each gene, setting the most extreme value to the expression of the second most extreme cell. Based on this we selected the 500 most variable genes, which were put forward to analysis by <italic>trendsceek</italic>. Read counts were normalized using size-factors<xref rid="R23" ref-type="bibr">23</xref>, as was done by Scialdone et al<xref rid="R5" ref-type="bibr">5</xref>, and the 500 most variable genes were subsequently selected. To obtain two-dimensional positions of the cells we used the t-SNE, Student's t distributed stochastic neighbourhood embedding, algorithm<xref rid="R6" ref-type="bibr">6</xref>, with 100 dimensions from an initial principal component analysis, perplexity = 96, reflecting the number of nearest neighbours to be used, and 400 iterations to reach convergence. As input to <italic>trendsceek</italic>, the position of the 481 cells in the resulting two-dimensional embedding was used as location of the points and the log<sub>10</sub>-normalized expression levels, after adding a pseudo-count of 1 to the size-factor normalized read counts, were used as marks of the points. 10,000 permutations of the marks were used to obtain the null-distribution representing marks being conditionally independent of the spatial location of the cells.</p>
    </sec>
    <sec id="S10">
      <title>Analysis of spatial transcriptomics data</title>
      <p id="P26">Spatial transcriptomic read counts and micro-array spot positions were downloaded (<ext-link ext-link-type="uri" xlink:href="http://www.spatialtranscriptomicsresearch.org/wp-content/uploads/2016/07">http://www.spatialtranscriptomicsresearch.org/wp-content/uploads/2016/07</ext-link>), containing data from 12 arrays with mouse-olfactory bulbs tissue sections from 5 animals and four arrays with sections from a human breast cancer biopsy from a single individual<xref rid="R4" ref-type="bibr">4</xref>. <italic>Trendsceek</italic> was applied on replicate 3 (n=269 array-spots) and replicate 12 (n=280 array-spots) of mouse-olfactory bulbs tissue sections and layer 2 of human breast cancer biopsy (n=251 array-spots). Genes were filtered on being expressed in at least 3 array-spots with a read count of at least 5. The most variable genes for each array were derived in a similar manner as described above for the scRNA-seq data, but with the difference that the expression distribution was assumed to follow a Poisson distribution without any overdispersion, as no good fit was found when using a negative binomial. This corresponds to that the squared coefficient of variance can be modelled with linear regression with respect to the inverse of the mean expression level (v = m ⇒ cv<sup>2</sup> = 1/m). The 500 most variable genes from each of the 16 arrays were used as input to <italic>trendsceek</italic>, along with the spot-positions as spatial locations for the point pattern. As expression level marks, the log<sub>10</sub>-normalized read counts were used, after adding a pseudo-count of 1, and 10,000 permutations of the marks was performed to obtain the spatially independent null-distribution of marks. To group the spatial patterns detected by <italic>trendsceek</italic>, all significant genes (Benjamini-Hochberg adjusted <italic>P</italic> ≤ 0.05 for at least one of the four statistic tests) were input to <italic>trendsceek’s</italic> wKDE-based cell-detection algorithm. The resulting binary matrix, indicating cells in regions with elevated expression (P ≤ 0.05), was then clustered by hierarchical agglomerative clustering (Euclidean distance, Ward’s criterion).</p>
    </sec>
    <sec id="S11">
      <title>Analysis of mouse hippocampus seqFISH data</title>
      <p id="P27">Raw expression data, cell positioning and vector fields from mouse hippocampus<xref rid="R3" ref-type="bibr">3</xref> were downloaded from (<ext-link ext-link-type="uri" xlink:href="https://ars.els-cdn.com/content/image/1-s2.0-S0896627316307024-mmc6.xlsx">https://ars.els-cdn.com/content/image/1-s2.0-S0896627316307024-mmc6.xlsx</ext-link>). The data set includes a total of 3585 cells and 249 genes from 21 different regions from a single dissected mouse hippocampus. 2050 cells were retained after filtering cells around the edges to eliminate image edge artifacts (keeping cells within 203-822 pixels of x- and y-axis), similar as was done in the original publication. As input to <italic>trendsceek</italic>, we performed winsorization of each gene setting the four most extreme values to the expression of the fifth most extreme value followed by log<sub>10</sub>-normalization after adding a pseudo-count of 1. The positionings of the cells were specified by the x- and y -coordinates within the 21 individual regions. To group the spatial patterns detected by <italic>trendsceek</italic>, all significant genes (Benjamini-Hochberg adjusted <italic>P</italic> &lt; 0.01 for at least one of the four statistic tests, two-sided) were input to <italic>trendsceek’s</italic> wKDE-based cell-detection algorithm. The resulting binary matrix, indicating cells in regions with elevated expression (P &lt; 0.05, one-sided), was then clustered by hierarchical agglomerative clustering (Euclidean distance, Ward’s criterion).</p>
    </sec>
    <sec id="S12">
      <title>Data availability statement</title>
      <p id="P28">The R package <italic>trendsceek</italic> is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/edsgard/trendsceek">https://github.com/edsgard/trendsceek</ext-link>. Apart from the core functions calculating the trend-statistics, a number of additional functions to facilitate the spatial analysis, such as plotting and selection functions are provided. These are documented in the vignette and the reference-manual of the R-package along with examples of usage.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material" id="SM">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="SD1">
      <label>Reporting summary</label>
      <media xlink:href="NIHMS76329-supplement-Reporting_summary.pdf" mimetype="application" mime-subtype="pdf" orientation="portrait" xlink:type="simple" id="d36e1500" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD2">
      <label>Supplementary Table 1</label>
      <media xlink:href="NIHMS76329-supplement-Sup_Table_1.xlsx" mimetype="application" mime-subtype="octet-stream" orientation="portrait" xlink:type="simple" id="d36e1504" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD3">
      <label>Supplementary Table 10</label>
      <media xlink:href="NIHMS76329-supplement-Sup_Table_10.xlsx" mimetype="application" mime-subtype="octet-stream" orientation="portrait" xlink:type="simple" id="d36e1508" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD4">
      <label>Supplementary Table 11</label>
      <media xlink:href="NIHMS76329-supplement-Sup_Table_11.xlsx" mimetype="application" mime-subtype="octet-stream" orientation="portrait" xlink:type="simple" id="d36e1512" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD5">
      <label>Supplementary Table 2</label>
      <media xlink:href="NIHMS76329-supplement-Sup_Table_2.xlsx" mimetype="application" mime-subtype="octet-stream" orientation="portrait" xlink:type="simple" id="d36e1516" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD6">
      <label>Supplementary Table 3</label>
      <media xlink:href="NIHMS76329-supplement-Sup_Table_3.xlsx" mimetype="application" mime-subtype="octet-stream" orientation="portrait" xlink:type="simple" id="d36e1520" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD7">
      <label>Supplementary Table 4</label>
      <media xlink:href="NIHMS76329-supplement-Sup_Table_4.xls" mimetype="application" mime-subtype="vnd.ms-excel" orientation="portrait" xlink:type="simple" id="d36e1524" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD8">
      <label>Supplementary Table 5</label>
      <media xlink:href="NIHMS76329-supplement-Sup_Table_5.xlsx" mimetype="application" mime-subtype="octet-stream" orientation="portrait" xlink:type="simple" id="d36e1528" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD9">
      <label>Supplementary Table 6</label>
      <media xlink:href="NIHMS76329-supplement-Sup_Table_6.xls" mimetype="application" mime-subtype="vnd.ms-excel" orientation="portrait" xlink:type="simple" id="d36e1532" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD10">
      <label>Supplementary Table 7</label>
      <media xlink:href="NIHMS76329-supplement-Sup_Table_7.xlsx" mimetype="application" mime-subtype="octet-stream" orientation="portrait" xlink:type="simple" id="d36e1536" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD11">
      <label>Supplementary Table 8</label>
      <media xlink:href="NIHMS76329-supplement-Sup_Table_8.xls" mimetype="application" mime-subtype="vnd.ms-excel" orientation="portrait" xlink:type="simple" id="d36e1541" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD12">
      <label>Supplementary Table 9</label>
      <media xlink:href="NIHMS76329-supplement-Sup_Table_9.xlsx" mimetype="application" mime-subtype="octet-stream" orientation="portrait" xlink:type="simple" id="d36e1545" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD13">
      <label>Supplementary Figures</label>
      <media xlink:href="NIHMS76329-supplement-Supplementary_figures.docx" mimetype="application" mime-subtype="octet-stream" orientation="portrait" xlink:type="simple" id="d36e1549" position="anchor"/>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack id="S13">
    <title>Acknowledgements</title>
    <p>This work was supported by grants from the Swedish Research Council, the European Research Council (CoG 648842) and the Vallee Foundation.</p>
  </ack>
  <fn-group>
    <fn fn-type="con" id="FN1">
      <p id="P29">
        <bold>Author Contributions</bold>
      </p>
      <p id="P30">D.E. conceived the idea, developed the method, performed the analyses and wrote the manuscript. P.J. performed seqFISH and clustering analyses. R.S. supervised the project and wrote the manuscript.</p>
    </fn>
    <fn fn-type="COI-statement" id="FN2">
      <p id="P31">
        <bold>Competing Financial Interests</bold>
      </p>
      <p id="P32">The authors declare no competing financial interests.</p>
    </fn>
  </fn-group>
  <ref-list>
    <ref id="R1">
      <label>1</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lubeck</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Coskun</surname>
            <given-names>AF</given-names>
          </name>
          <name>
            <surname>Zhiyentayev</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Ahmad</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Cai</surname>
            <given-names>L</given-names>
          </name>
        </person-group>
        <article-title>Single-cell in situ RNA profiling by sequential hybridization</article-title>
        <source>Nat Methods</source>
        <year>2014</year>
        <volume>11</volume>
        <fpage>360</fpage>
        <lpage>361</lpage>
        <pub-id pub-id-type="pmid">24681720</pub-id>
      </element-citation>
    </ref>
    <ref id="R2">
      <label>2</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Chen</surname>
            <given-names>KH</given-names>
          </name>
          <name>
            <surname>Boettiger</surname>
            <given-names>AN</given-names>
          </name>
          <name>
            <surname>Moffitt</surname>
            <given-names>JR</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Zhuang</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>RNA imaging. Spatially resolved, highly multiplexed RNA profiling in single cells</article-title>
        <source>Science</source>
        <year>2015</year>
        <volume>348</volume>
        <comment>aaa6090</comment>
      </element-citation>
    </ref>
    <ref id="R3">
      <label>3</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Shah</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Lubeck</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Zhou</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Cai</surname>
            <given-names>L</given-names>
          </name>
        </person-group>
        <article-title>In Situ Transcription Profiling of Single Cells Reveals Spatial Organization of Cells in the Mouse Hippocampus</article-title>
        <source>Neuron</source>
        <year>2016</year>
        <volume>92</volume>
        <fpage>342</fpage>
        <lpage>357</lpage>
        <pub-id pub-id-type="pmid">27764670</pub-id>
      </element-citation>
    </ref>
    <ref id="R4">
      <label>4</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ståhl</surname>
            <given-names>PL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Visualization and analysis of gene expression in tissue sections by spatial transcriptomics</article-title>
        <source>Science</source>
        <year>2016</year>
        <volume>353</volume>
        <fpage>78</fpage>
        <lpage>82</lpage>
        <pub-id pub-id-type="pmid">27365449</pub-id>
      </element-citation>
    </ref>
    <ref id="R5">
      <label>5</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Scialdone</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Resolving early mesoderm diversification through single-cell expression profiling</article-title>
        <source>Nature</source>
        <year>2016</year>
        <volume>535</volume>
        <fpage>289</fpage>
        <lpage>293</lpage>
        <pub-id pub-id-type="pmid">27383781</pub-id>
      </element-citation>
    </ref>
    <ref id="R6">
      <label>6</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>van der Maaten</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Hinton</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Visualizing Data using t-SNE</article-title>
        <source>Journal of Machine Learning Research</source>
        <year>2008</year>
        <fpage>1</fpage>
        <lpage>27</lpage>
      </element-citation>
    </ref>
    <ref id="R7">
      <label>7</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Illian</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Penttinen</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Stoyan</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Stoyan</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <chapter-title>Modelling and Simulation of Stationary Point Processes</chapter-title>
        <source>Statistical Analysis and Modelling of Spatial Point Patterns</source>
        <publisher-name>John Wiley &amp; Sons, Ltd</publisher-name>
        <year>2008</year>
        <fpage>363</fpage>
        <lpage>444</lpage>
        <pub-id pub-id-type="doi">10.1002/9780470725160.ch6</pub-id>
      </element-citation>
    </ref>
    <ref id="R8">
      <label>8</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hatami</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>KLF6-SV1 drives breast cancer metastasis and is associated with poor survival</article-title>
        <source>Sci Transl Med</source>
        <year>2013</year>
        <volume>5</volume>
        <fpage>169ra12</fpage>
        <lpage>169ra12</lpage>
      </element-citation>
    </ref>
    <ref id="R9">
      <label>9</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Singha</surname>
            <given-names>PK</given-names>
          </name>
          <name>
            <surname>Yeh</surname>
            <given-names>I-T</given-names>
          </name>
          <name>
            <surname>Venkatachalam</surname>
            <given-names>MA</given-names>
          </name>
          <name>
            <surname>Saikumar</surname>
            <given-names>P</given-names>
          </name>
        </person-group>
        <article-title>Transforming growth factor-beta (TGF-beta)-inducible gene TMEPAI converts TGF-beta from a tumor suppressor to a tumor promoter in breast cancer</article-title>
        <source>Cancer Res</source>
        <year>2010</year>
        <volume>70</volume>
        <fpage>6377</fpage>
        <lpage>6383</lpage>
        <pub-id pub-id-type="pmid">20610632</pub-id>
      </element-citation>
    </ref>
    <ref id="R10">
      <label>10</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wagner</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Yosef</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Revealing the vectors of cellular identity with single-cell genomics</article-title>
        <source>Nat Biotechnol</source>
        <year>2016</year>
        <volume>34</volume>
        <fpage>1145</fpage>
        <lpage>1160</lpage>
        <pub-id pub-id-type="pmid">27824854</pub-id>
      </element-citation>
    </ref>
    <ref id="R11">
      <label>11</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Brennecke</surname>
            <given-names>P</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Accounting for technical noise in single-cell RNA-seq experiments</article-title>
        <source>Nat Methods</source>
        <year>2013</year>
        <volume>10</volume>
        <fpage>1093</fpage>
        <lpage>1095</lpage>
        <pub-id pub-id-type="pmid">24056876</pub-id>
      </element-citation>
    </ref>
    <ref id="R12">
      <label>12</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Trapnell</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The dynamics and regulators of cell fate decisions are revealed by pseudotemporal ordering of single cells</article-title>
        <source>Nat Biotechnol</source>
        <year>2014</year>
        <volume>32</volume>
        <fpage>381</fpage>
        <lpage>386</lpage>
        <pub-id pub-id-type="pmid">24658644</pub-id>
      </element-citation>
    </ref>
    <ref id="R13">
      <label>13</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bendall</surname>
            <given-names>SC</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell trajectory detection uncovers progression and regulatory coordination in human B cell development</article-title>
        <source>Cell</source>
        <year>2014</year>
        <volume>157</volume>
        <fpage>714</fpage>
        <lpage>725</lpage>
        <pub-id pub-id-type="pmid">24766814</pub-id>
      </element-citation>
    </ref>
    <ref id="R14">
      <label>14</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Haghverdi</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Büttner</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Buettner</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>Diffusion pseudotime robustly reconstructs lineage branching</article-title>
        <source>Nat Methods</source>
        <year>2016</year>
        <volume>13</volume>
        <fpage>845</fpage>
        <lpage>848</lpage>
        <pub-id pub-id-type="pmid">27571553</pub-id>
      </element-citation>
    </ref>
    <ref id="R15">
      <label>15</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Petropoulos</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-Cell RNA-Seq Reveals Lineage and X Chromosome Dynamics in Human Preimplantation Embryos</article-title>
        <source>Cell</source>
        <year>2016</year>
        <volume>165</volume>
        <fpage>1012</fpage>
        <lpage>1026</lpage>
        <pub-id pub-id-type="pmid">27062923</pub-id>
      </element-citation>
    </ref>
    <ref id="R16">
      <label>16</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Joost</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-Cell Transcriptomics Reveals that Differentiation and Spatial Signatures Shape Epidermal and Hair Follicle Heterogeneity</article-title>
        <source>Cell Syst</source>
        <year>2016</year>
        <volume>3</volume>
        <fpage>221</fpage>
        <lpage>237.e9</lpage>
        <pub-id pub-id-type="pmid">27641957</pub-id>
      </element-citation>
    </ref>
    <ref id="R17">
      <label>17</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Stoyan</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Stoyan</surname>
            <given-names>H</given-names>
          </name>
        </person-group>
        <source>Fractals, random shapes, and point fields</source>
        <publisher-name>John Wiley &amp; Sons Inc</publisher-name>
        <year>1994</year>
      </element-citation>
    </ref>
    <ref id="R18">
      <label>18</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schlather</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Ribeiro</surname>
            <given-names>PJ</given-names>
          </name>
          <name>
            <surname>Diggle</surname>
            <given-names>PJ</given-names>
          </name>
        </person-group>
        <article-title>Detecting dependence between marks and locations of marked point processes</article-title>
        <source>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</source>
        <year>2004</year>
        <volume>66</volume>
        <fpage>79</fpage>
        <lpage>93</lpage>
      </element-citation>
    </ref>
    <ref id="R19">
      <label>19</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Cressie</surname>
            <given-names>NAC</given-names>
          </name>
        </person-group>
        <source>Statistics for Spatial Data</source>
        <publisher-name>John Wiley &amp; Sons</publisher-name>
        <year>1991</year>
      </element-citation>
    </ref>
    <ref id="R20">
      <label>20</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Ripley</surname>
            <given-names>BD</given-names>
          </name>
        </person-group>
        <source>Quantitative Analysis of Mineral and Energy Resources</source>
        <publisher-name>Springer</publisher-name>
        <publisher-loc>Netherlands</publisher-loc>
        <year>1988</year>
        <fpage>301</fpage>
        <lpage>322</lpage>
        <pub-id pub-id-type="doi">10.1007/978-94-009-4029-1_18</pub-id>
      </element-citation>
    </ref>
    <ref id="R21">
      <label>21</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ohser</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>On estimators for the reduced second moment measure of point processes</article-title>
        <source>Series Statistics</source>
        <year>1983</year>
        <volume>14</volume>
        <fpage>63</fpage>
        <lpage>71</lpage>
      </element-citation>
    </ref>
    <ref id="R22">
      <label>22</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kharchenko</surname>
            <given-names>PV</given-names>
          </name>
          <name>
            <surname>Silberstein</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Scadden</surname>
            <given-names>DT</given-names>
          </name>
        </person-group>
        <article-title>Bayesian approach to single-cell differential expression analysis</article-title>
        <source>Nat Methods</source>
        <year>2014</year>
        <volume>11</volume>
        <fpage>740</fpage>
        <lpage>742</lpage>
        <pub-id pub-id-type="pmid">24836921</pub-id>
      </element-citation>
    </ref>
    <ref id="R23">
      <label>23</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Love</surname>
            <given-names>MI</given-names>
          </name>
          <name>
            <surname>Huber</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Anders</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Moderated estimation of fold change and dispersion for RNA-seq data with DESeq2</article-title>
        <source>Genome Biol</source>
        <year>2014</year>
        <volume>15</volume>
        <fpage>550</fpage>
        <pub-id pub-id-type="pmid">25516281</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig id="F1" orientation="portrait" position="float">
    <label>Figure 1</label>
    <caption>
      <title>Illustrating <italic>trendsceek</italic> on simulated data.</title>
      <p>(<bold>A</bold>) Simulated mark distributions with local hotspot, step gradients, non-radial streaks and linear gradient patters. Expression values were sampled from empirical seqFISH data<xref rid="R3" ref-type="bibr">3</xref> and cells in certain regions were spiked by sampling from the upper quantile of the expression distribution (cells n=500, spiked cells n=˜50, mean expression spiked cells / mean expression background = ˜10). (<bold>B</bold>) Marked point pattern statistics (<xref ref-type="sec" rid="S2">Methods</xref>) for the simulated hotspot shown in (A). The mark correlation and mark variogram clearly indicate a significant spatial pattern as the band, which indicates the 5% significance level of a null distribution based on resampling of the mark distribution, is exceeded at certain radii. <bold>(C)</bold> 3D-representations of the spatial expression trend, where the green surfaces show weighted kernel density estimation (wKDE) of the simulated datasets. The blue surfaces indicate the upper 5% quantile of a null distribution generated by wKDE of the resampled mark distribution for each dataset. (<bold>D</bold>) Density plot of the simulated datasets (A) with cells colored red if they exceeded a 5% significance level based on wKDE, indicated by the blue surface in (C). Scale bars in (A) and (D) apply to all items of the figure, including the radius shown in (B).</p>
    </caption>
    <graphic xlink:href="emss-76329-f001"/>
  </fig>
  <fig id="F2" orientation="portrait" position="float">
    <label>Figure 2</label>
    <caption>
      <title>Applications of <italic>trendsceek</italic> on spatial and single-cell gene expression data.</title>
      <p>(<bold>A</bold>) Spatial transcriptomics data from mouse olfactory bulb (replicate 3, n=269 array-spots). Left: hematoxylin and eosin stained tissue-sections (from Ståhl et al<xref rid="R4" ref-type="bibr">4</xref>), followed by examples of genes with significant expression trends. Expression was scaled to the range zero to one by unity-based normalization. (<bold>B</bold>) Density plots of gene expression with cells in regions of significantly elevated expression coloured red. (<bold>C</bold>) Spatial transcriptomics data from mouse olfactory bulb (replicate 12, n=280 array-spots), as in (A). (<bold>D</bold>) As in (C) for mouse olfactory bulb, replicate 12. (<bold>E</bold>) Spatial transcriptomics data from breast cancer biopsy (histological section “Layer 2”, n=251 array-spots), with examples of genes with significant expression trends. The distance between array-spots is 200μm, each spot covering multiple cells. (<bold>F</bold>) Examples of distinct spatial expression patterns identified by <italic>trendsceek</italic> within E6.5 mouse epiblast cells (cluster 3 in Scialdone et al.<xref rid="R5" ref-type="bibr">5</xref>, n=481 cells). (<bold>G</bold>) Identification of spatial patterns related to the positions of male and female cells within the cluster, with mutually exclusive expression of <italic>Xist</italic> (expressed in female cells) and <italic>Eif2s3y</italic> (located on the Y-chromosome, only expressed in male cells). (<bold>H</bold>) Examples of spatial expression patterns identified in mouse hippocampus seqFISH data (cells imaged; H=93, O=89, T=208). Left: Cartoon of hippocampus with the 21 imaged regions labelled according to previous publication<xref rid="R3" ref-type="bibr">3</xref>. P-values represent (A-E) mark-correlation (F-G) mark-variogram and (H) Emark (two-sided, Benjamini-Hochberg adjusted).</p>
    </caption>
    <graphic xlink:href="emss-76329-f002"/>
  </fig>
</floats-group>
