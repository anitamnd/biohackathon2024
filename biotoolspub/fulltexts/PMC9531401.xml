<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Genome Biol</journal-id>
    <journal-id journal-id-type="iso-abbrev">Genome Biol</journal-id>
    <journal-title-group>
      <journal-title>Genome Biology</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1474-7596</issn>
    <issn pub-type="epub">1474-760X</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">9531401</article-id>
    <article-id pub-id-type="publisher-id">2771</article-id>
    <article-id pub-id-type="doi">10.1186/s13059-022-02771-2</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Method</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>KAGE: fast alignment-free graph-based genotyping of SNPs and short indels</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0001-8941-942X</contrib-id>
        <name>
          <surname>Grytten</surname>
          <given-names>Ivar</given-names>
        </name>
        <address>
          <email>ivargry@ifi.uio.no</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Dagestad Rand</surname>
          <given-names>Knut</given-names>
        </name>
        <address>
          <email>knutdr@math.uio.no</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Sandve</surname>
          <given-names>Geir Kjetil</given-names>
        </name>
        <address>
          <email>geirksa@ifi.uio.no</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.5510.1</institution-id><institution-id institution-id-type="ISNI">0000 0004 1936 8921</institution-id><institution>Department of Informatics, </institution><institution>University of Oslo, </institution></institution-wrap>Gaustadalleen 23 B, 0371 Oslo, Norway </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.5510.1</institution-id><institution-id institution-id-type="ISNI">0000 0004 1936 8921</institution-id><institution>Centre for Bioinformatics, </institution><institution>University of Oslo, </institution></institution-wrap>Gaustadalleen 30, 0373 Oslo, Norway </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>4</day>
      <month>10</month>
      <year>2022</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>4</day>
      <month>10</month>
      <year>2022</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2022</year>
    </pub-date>
    <volume>23</volume>
    <elocation-id>209</elocation-id>
    <history>
      <date date-type="received">
        <day>18</day>
        <month>12</month>
        <year>2021</year>
      </date>
      <date date-type="accepted">
        <day>9</day>
        <month>9</month>
        <year>2022</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2022</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold>This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons licence, and indicate if changes were made. The images or other third party material in this article are included in the article's Creative Commons licence, unless indicated otherwise in a credit line to the material. If material is not included in the article's Creative Commons licence and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this licence, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>. The Creative Commons Public Domain Dedication waiver (<ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/publicdomain/zero/1.0/">http://creativecommons.org/publicdomain/zero/1.0/</ext-link>) applies to the data made available in this article, unless otherwise stated in a credit line to the data.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Genotyping is a core application of high-throughput sequencing. We present KAGE, a genotyper for SNPs and short indels that is inspired by recent developments within graph-based genome representations and alignment-free methods. KAGE uses a pan-genome representation of the population to efficiently and accurately predict genotypes. Two novel ideas improve both the speed and accuracy: a Bayesian model incorporates genotypes from thousands of individuals to improve prediction accuracy, and a computationally efficient method leverages correlation between variants. We show that the accuracy of KAGE is at par with the best existing alignment-free genotypers, while being an order of magnitude faster.</p>
      <sec>
        <title>Supplementary Information</title>
        <p>The online version contains supplementary material available at 10.1186/s13059-022-02771-2.</p>
      </sec>
    </abstract>
    <kwd-group xml:lang="en">
      <title>Keywords</title>
      <kwd>Genotyping</kwd>
      <kwd>Variant calling</kwd>
      <kwd>Pangenomes</kwd>
      <kwd>Graph genomes</kwd>
      <kwd>Alignment-free</kwd>
    </kwd-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2022</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Background</title>
    <p id="Par2">Recent studies such as the 1000 Genomes Project [<xref ref-type="bibr" rid="CR1">1</xref>] have produced large catalogues of known human genetic variation. Researchers now have access to genotype information for thousands of individuals at known variant sites, providing unprecedented knowledge about how often genetic variants occur together at sub-population and individual levels.</p>
    <p id="Par3">Discovery and characterization of an individual’s genetic variation have traditionally been done in two steps: 1) <italic>variant calling</italic>: discovering genetic variation in the genome, and 2) <italic>genotyping</italic> those called variants: determining whether each genetic variant is present in one or both of the chromosomes of the individual. Variant calling is a computationally expensive task, usually performed by first sequencing the genome of interest at high coverage, followed by mapping the sequenced reads to a reference genome and inferring variants according to where the mapped reads differ from the reference. It is now possible to skip the variant calling step, instead relying on catalogues of known genetic variation to directly genotype a given individual. For humans, the huge amount of already detected genomic variation means that a large amount (&gt;90%) of an individual’s genetic variation can be detected this way [<xref ref-type="bibr" rid="CR1">1</xref>]. Genotyping individuals at sites of known variation has in principle been performed already since the early 2000’s based on SNP chips (microarrays). This has however been restricted to a limited set of fixed sites that a given chip has been designed to capture. While these chip-based techniques are still popular today due to their low cost, e.g. in GWAS studies [<xref ref-type="bibr" rid="CR2">2</xref>], they are limited by chip architecture and thus only able to genotype about 1-2 million variants. Contrary to this, <italic>sequence-based</italic> genotyping techniques are, while being more expensive to perform, in theory able to genotype any genetic variant that has already been detected in the population.</p>
    <p id="Par4">Sequence-based genotyping is traditionally performed by aligning sequenced reads to a reference genome and examining how the reads support genotypes locally at each variant [<xref ref-type="bibr" rid="CR3">3</xref>, <xref ref-type="bibr" rid="CR4">4</xref>]. While these methods generally have high accuracy, they are slow, mostly because read-mapping/alignment is computationally expensive. Also, since these methods require the mapping of reads to a reference genome, they have a tendency to perform poorly in regions where the reference genome is very different from the sequenced genome, such as in variant-rich regions. Furthermore, since reads are more likely to be correctly mapped when they are similar to the reference, reads supporting variant-alleles may be underrepresented among the mapped reads, resulting in a bias towards the reference alleles, a problem referred to as reference bias [<xref ref-type="bibr" rid="CR5">5</xref>].</p>
    <p id="Par5">In an attempt to both speed up genotyping and avoid reference bias, several <italic>alignment-free</italic> approaches have emerged during the last few years [<xref ref-type="bibr" rid="CR6">6</xref>–<xref ref-type="bibr" rid="CR9">9</xref>]. These methods work by representing genetic variants by their surrounding kmers (sequences with length k covering each variant) and looking for support for these kmers in the sequenced reads. Since these methods do not map reads to a reference genome, they mitigate the problem of reference bias, and are usually computationally very efficient since kmer-lookup is fast compared to read mapping. However, these methods struggle when variant alleles cannot be represented by unique kmers, e.g. because a variant allele shares one or more kmers with another location in the genome. The genotyping method Malva [<xref ref-type="bibr" rid="CR8">8</xref>] attempts to solve this problem by using larger kmers in cases where kmers are non-unique, but is still not able to genotype all variants using this approach. The more recent method PanGenie [<xref ref-type="bibr" rid="CR10">10</xref>] takes the approach of Malva one step further and uses known population haplotype information to infer the likelihood of genotypes for variants that do not have unique kmers, such as variants in repetitive regions of the genome. PanGenie does this by using a Hidden Markov Model (HMM) with one state for each possible pair of haplotypes from the set of known haplotypes in the population. While this approach works well for relatively few input haplotypes and variants (PanGenie was tested using haplotypes from around 10 individuals and about 7 million variants), the number of states in the HMM increases quadratically with the number of haplotypes, and the method scales poorly when more than a few haplotypes are used. This means that the more than 5000 haplotypes and 80 million variants available in the 1000 Genomes Project cannot easily be utilised by an approach like PanGenie. Furthermore, PanGenie does not use kmer-information at all for variants with non-unique kmers.</p>
    <p id="Par6">We here describe KAGE – a new genotyper for SNPs and short indels that builds on recent ideas of alignment-free genotyping from Malva and PanGenie for computationally efficiency. KAGE implements two novel ideas for utilising all previously known haplotype information from repositories such as the 1000 Genomes Project in order to improve genotyping accuracy. We show that combining these ideas leads to a genotyper that is both more accurate and computationally efficient than existing alignment-free genotypers.<fig id="Fig1"><label>Fig. 1</label><caption><p>Overview of a typical alignment-free genotyping approach. First, kmers covering each allele of each variant is stored (step 1), e.g. by choosing kmers from a graph representation of the variants. All kmers from the reads are then collected (step 2), and genotype probabilities are computed using Bayes rule with genotype probabilities from a known population used as priors (step 3). The most likely genotype is chosen</p></caption><graphic xlink:href="13059_2022_2771_Fig1_HTML" id="MO1"/></fig></p>
  </sec>
  <sec id="Sec2">
    <title>Results</title>
    <p id="Par7">We here present KAGE, which is based on two new ideas that are inspired by recent progress in alignment-free genotyping and imputation. We first show how each idea can improve genotyping accuracy for alignment-free genotyping methods, and then show that when these ideas are combined into KAGE, we get a graph-based alignment-free genotyper that is highly accurate and considerably more computationally efficient than existing alignment-free genotyping methods.</p>
    <sec id="Sec3">
      <title>Idea 1: Modelling expected kmer-counts from the population</title>
      <p id="Par8">Alignment-free genotypers, like Malva and PanGenie, compute genotype likelihoods by counting the number of kmers from the read set that support each allele of every variant to be genotyped, as illustrated in Fig. <xref rid="Fig1" ref-type="fig">1</xref>. A problem with this approach is that some variants may have alleles that are covered by kmers that also match elsewhere in the genome (for some or many individuals), making such variants difficult to genotype, as illustrated in Fig. <xref rid="Fig2" ref-type="fig">2</xref>. We hypothesise that this problem may be addressed by modelling the expected match count for each individual kmer based on population data, such as data from the 1000 Genomes Project.</p>
      <p id="Par9">To test this hypothesis, we implemented a baseline genotyper that follows the scheme in Fig. <xref rid="Fig1" ref-type="fig">1</xref>: each variant is represented by kmers, and the genotyper counts how many times each kmer exists in the read data sets, computing genotype probabilities using Bayes formula (naively assuming each kmer is unique in the genome). We also created a more sophisticated version of this genotyper, where we assume that each kmer exists with a given frequency in the population, and use this information when computing the probability of observing the given number of kmers for each variant (Section <xref rid="Sec8" ref-type="sec">5</xref>). We benchmark both these methods against Malva. As shown in Fig. <xref rid="Fig3" ref-type="fig">3</xref>, our naive method performs worse than Malva, whereas the approach where expected kmer counts are modelled from the population performs better. In Table <xref rid="Tab1" ref-type="table">1</xref> we show the accuracy of the two methods on SNPs that have unique and non-unique kmers. As can seen in the table, the accuracy on SNPs with non-unique kmers drastically increases for the more sophisticated genotyper that uses information about the kmer frequency from the population. Although this is an experiment performed on a single small benchmark dataset, these findings provide an indication that the idea of comparing observed kmer counts to expected kmer counts based on a population may work.<fig id="Fig2"><label>Fig. 2</label><caption><p>Graph with duplicate kmers. The SNP G/T has a kmer CTA (green) on the variant allele that also exists on the reference path (blue). If we observe each of the kmers CTA and CGA once in the read set, we might be fooled to believe that GT is the most likely genotype for this variant. However, when knowing that the kmer CTA is expected to occur at least once in the read data set, due to the duplication, we might conclude otherwise. This information can be used to adjust the probabilities used to compute the binomial probabilities of observing kmer counts given genotypes</p></caption><graphic xlink:href="13059_2022_2771_Fig2_HTML" id="MO2"/></fig></p>
      <p id="Par10">
        <fig id="Fig3">
          <label>Fig. 3</label>
          <caption>
            <p>Genotype accuracy increases when expected kmer counts are modelled from the population. Our prototype alignment-free genotyper (naive KAGE) performs a bit worse than Malva, as expected. However, when we compute expected kmer counts from the population, using 1000 Genomes data, and use these counts to compute the probability of observing the given kmers in our data, the genotyping accuracy greatly improves. Note: KAGE here refers to a simplified version of the full genotyper that we present in the next section (here KAGE does not use variants to adjust prior probabilities)</p>
          </caption>
          <graphic xlink:href="13059_2022_2771_Fig3_HTML" id="MO3"/>
        </fig>
      </p>
    </sec>
    <sec id="Sec4">
      <title>Idea 2: Using a single variant to adjust the prior</title>
      <p id="Par11">While Malva uses the allele frequency from the population as priors for genotype likelihoods, PanGenie uses a more sophisticated approach where genotypes are inferred using a Hidden Markov Model (HMM), meaning that the predicted genotype of one variant provides information that can support the determination of the genotypes of other variants. While this approach may allow PanGenie to predict genotypes with higher accuracy than Malva, this method does not scale to handle a large number of known haplotypes, since the HMM must represent every possible pair of haplotypes as a separate state, making the number of HMM states grow quadratically with the number of haplotypes. We hypothesise that a simpler approach may be better for two reasons: First, a simple approach may be able to utilise all the haplotype information available (e.g. the 2548 individuals available from the 1000 Genomes project, rather than only a handful that the PanGenie approach would typically employ), and second, such an approach may be computationally faster than an HMM-approach that requires inference on hidden states. To test this hypothesis, we implement a way of efficiently computing prior probabilities for each genotype of each variant given genotype probabilities of other variants (Section <xref rid="Sec8" ref-type="sec">5</xref>). We let every variant only depend on a single other variant, which leads to a very efficient way of genotyping all variants, and allows us to use as many underlying haplotypes as we would like. The determination of a single best suited helper variant for each known variant in the genome is performed only once, in a general pre-processing step. The genotyping of individuals then only needs to perform a fast lookup in this precomputed table. We test this approach against PanGenie, where PanGenie is run with a varying number of known haplotypes as input. In order to test PanGenie with as many haplotypes as possible from the 1000 Genomes Projects, we perform this experiment on a small test data set (5 million base pairs of chromosome 1).<fig id="Fig4"><label>Fig. 4</label><caption><p>Accuracy of Pangenie and KAGE as a function of the number of individuals included in the model on a small test dataset. Recall and precision (shown as F1 score) are computed for the predicted genotypes by the various methods on a small test dataset (genome size 5 million bp) with reads simulated from HG002, in order to test whether the accuracy of PanGenie and KAGE increases with a larger number of individuals in the model. The F1 score of Malva and “our naive approach” are shown as a single dot, since both of these only use the whole population genotype frequency when estimating genotype probabilities</p></caption><graphic xlink:href="13059_2022_2771_Fig4_HTML" id="MO4"/></fig></p>
      <p id="Par12">The result of this experiment is shown in Fig. <xref rid="Fig4" ref-type="fig">4</xref>, where it can be seen that the accuracy of both this approach (KAGE) and PanGenie increase with the number of known haplotypes. This experiment is performed on a small test dataset, so as to allow the inclusion of a larger number of individuals in PanGenie, and is not meant as a benchmarking of the methods per se. These findings provide an indication that the use of a single variant as prior still allows us to leverage information from a large number of individuals.<table-wrap id="Tab1"><label>Table 1</label><caption><p>Accuracy on SNPs that can be represented with unique kmers vs. SNPs that cannot. The accuracy increases for variants that cannot be represented with unique kmers after implementing idea 1 (KAGE with model of kmer counts) and increases further when introducing idea 2 (KAGE full). The accuracy on SNPs that can be represented with unique kmers is always high, since these SNPs are easy to genotype</p></caption><table frame="hsides" rules="groups"><thead><tr><th align="left">Method</th><th align="left">Accuracy on SNPs with non-unique kmers</th><th align="left">Accuracy on SNPs with unique kmers</th></tr></thead><tbody><tr><td align="left">Naive KAGE</td><td align="left">64 %</td><td align="left">97 %</td></tr><tr><td align="left">KAGE with model of kmer counts</td><td align="left">77 %</td><td align="left">97 %</td></tr><tr><td align="left">KAGE (full)</td><td align="left">92 %</td><td align="left">99 %</td></tr></tbody></table></table-wrap></p>
    </sec>
    <sec id="Sec5">
      <title>A new graph-based alignment-free genotyper</title>
      <p id="Par13">We combine the two ideas discussed above into a new alignment-free genotyper KAGE, and compare this genotyper in terms of running time, memory usage and accuracy against existing alignment-free genotypers as well as the most commonly used alignment-based genotypers. We follow the guidelines from “Best practises for benchmarking germline small-variant calls in human genomes” [<xref ref-type="bibr" rid="CR11">11</xref>] and compare the output of each genotyper against a truth data set (similarly to how PanGenie and Malva assess their methods).</p>
      <p id="Par14">In the following experiments, we run PanGenie with 64 input haplotypes (from 32 individuals), since a larger number of haplotypes make PanGenie too slow and memory demanding when run on whole-genome data. We run KAGE with all of the 5096 haplotypes available from the 1000 Genomes Project. When listing run times, we consider only the time used to genotype a given sample, not the time used to index the reference genomes, graphs, or variants, since such indices can be created once and then be re-used for genotyping an arbitrary number of samples. All experiments are based on genotyping variants from the 1000 Genomes Project using short reads as input. Accuracy is presented by recall and precision when predicted genotypes are compared against a truth dataset. Further details about these experiments can be found in the Section <xref rid="Sec8" ref-type="sec">5</xref>, and a Snakemake pipeline for reproducing all the results can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/ivargr/genotyping-benchmarking">https://github.com/ivargr/genotyping-benchmarking</ext-link>.</p>
      <p id="Par15">In the experiments, we compare the genotypers listed in Table <xref rid="Tab2" ref-type="table">2</xref>, which includes the alignment-based genotyper Graphtyper as well as all alignment-free genotypers we believe are relevant or commonly used. For comparison, we also run the commonly used variant caller GATK [<xref ref-type="bibr" rid="CR3">3</xref>], which does not only genotype a specified set of variants, but tries to detect any variation from the reference. We include GATK so that the results of the genotypers can be contrasted to the alternative approach of performing full variant calling.</p>
      <p id="Par16">We genotype the individual HG002 from GIAB, which is an individual commonly used to benchmark variant callers and genotypers. The results can be seen in Table <xref rid="Tab3" ref-type="table">3</xref> and Fig. <xref rid="Fig5" ref-type="fig">5</xref>. We ran the final version of KAGE also on another individual (HG006, also from GIAB), which was not consulted until after we finalised all method and parameter choices, and verified that the results are similar (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S2 and S3). The results from genotyping HG002 using 30x read coverage can be found in Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1, and are similar to the results from 15x coverage. The experiments performed show that KAGE is about as accurate as, or more accurate than, all the other genotypers and considerably faster than any of the methods. GATK comes out as clearly more accurate than the genotype methods, but is as expected considerably slower than most of the genotypers. KAGE is about as accurate as the alignment-based method Graphtyper while being more than 30 times faster. KAGE is able to genotype a sample fast by pre-building all indexes (Section <xref rid="Sec8" ref-type="sec">5</xref>). While creating these indexes is quite time-consuming (a couple of days), once indexes are built for a set of variants and a reference population, genotyping a new sample takes a short fixed amount of time, which is independent of the number of individuals in the reference population. For the experiment presented in Table <xref rid="Tab3" ref-type="table">3</xref>, KAGE spends about 2 minutes on genotyping and 10 minutes on counting kmers.</p>
      <p id="Par17">The idea of using a single variant to adjust the prior probabilities when genotyping can be seen as a way of using information at some variants to “impute” the genotypes at other variants. While this seems to work well for KAGE, and leads to fast genotyping, we were curious as to whether higher accuracy could be achieved by using established and more sophisticated imputation tools. To test this hypothesis, we ran KAGE without the builtin imputation, producing a VCF with genotype likelihoods that reflect the probability of the possible genotypes given only kmer information. We then ran the imputation tool GLIMPSE [<xref ref-type="bibr" rid="CR12">12</xref>] on this VCF. As seen in Table <xref rid="Tab3" ref-type="table">3</xref> (KAGE + GLIMPSE), this combination of KAGE and GLIMPSE leads to higher accuracy than only running KAGE, showing the strength of imputation to improve genotyping accuracy.<table-wrap id="Tab2"><label>Table 2</label><caption><p>Overview of genotypers</p></caption><table frame="hsides" rules="groups"><thead><tr><th align="left">Genotyper</th><th align="left">Alignment-free/alignment-based</th><th align="left">Uses prior haplotype-information</th></tr></thead><tbody><tr><td align="left">Malva</td><td align="left">Alignment-free</td><td align="left">No</td></tr><tr><td align="left">Bayestyper</td><td align="left">Alignment-free</td><td align="left">No</td></tr><tr><td align="left">PanGenie</td><td align="left">Alignment-free</td><td align="left">Yes</td></tr><tr><td align="left">Graphtyper</td><td align="left">Alignment-based</td><td align="left">No</td></tr><tr><td align="left">GATK</td><td align="left">Alignment-based</td><td align="left">No</td></tr></tbody></table></table-wrap></p>
      <p id="Par18">
        <table-wrap id="Tab3">
          <label>Table 3</label>
          <caption>
            <p>Results from genotyping HG002</p>
          </caption>
          <table frame="hsides" rules="groups">
            <thead>
              <tr>
                <th align="left"/>
                <th align="left">Indels recall</th>
                <th align="left">Indels precision</th>
                <th align="left">Indels F1</th>
                <th align="left">SNPs recall</th>
                <th align="left">SNPs precision</th>
                <th align="left">SNPs F1</th>
                <th align="left">Runtime</th>
                <th align="left">Memory usage</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td align="left">KAGE</td>
                <td align="left">0.582</td>
                <td align="left">0.908</td>
                <td align="left">0.709</td>
                <td align="left">0.929</td>
                <td align="left">0.981</td>
                <td align="left">0.955</td>
                <td align="left">12 min</td>
                <td align="left">18 GB</td>
              </tr>
              <tr>
                <td align="left">KAGE + GLIMPSE</td>
                <td align="left">0.594</td>
                <td align="left">0.894</td>
                <td align="left">0.713</td>
                <td align="left">0.948</td>
                <td align="left">0.99</td>
                <td align="left">0.968</td>
                <td align="left">1.4 hours</td>
                <td align="left">18 GB</td>
              </tr>
              <tr>
                <td align="left">PanGenie</td>
                <td align="left">0.561</td>
                <td align="left">0.926</td>
                <td align="left">0.699</td>
                <td align="left">0.905</td>
                <td align="left">0.979</td>
                <td align="left">0.941</td>
                <td align="left">3.9 hours</td>
                <td align="left">111 GB</td>
              </tr>
              <tr>
                <td align="left">Bayestyper</td>
                <td align="left">0.485</td>
                <td align="left">0.993</td>
                <td align="left">0.652</td>
                <td align="left">0.834</td>
                <td align="left">0.997</td>
                <td align="left">0.908</td>
                <td align="left">7.9 hours</td>
                <td align="left">30 GB</td>
              </tr>
              <tr>
                <td align="left">Malva</td>
                <td align="left">0.537</td>
                <td align="left">0.856</td>
                <td align="left">0.659</td>
                <td align="left">0.849</td>
                <td align="left">0.921</td>
                <td align="left">0.883</td>
                <td align="left">14.9 hours</td>
                <td align="left">50 GB</td>
              </tr>
              <tr>
                <td align="left">Graphtyper</td>
                <td align="left">0.568</td>
                <td align="left">0.941</td>
                <td align="left">0.708</td>
                <td align="left">0.909</td>
                <td align="left">0.993</td>
                <td align="left">0.949</td>
                <td align="left">5.1 hours</td>
                <td align="left">23 GB</td>
              </tr>
              <tr>
                <td align="left">GATK</td>
                <td align="left">0.898</td>
                <td align="left">0.96</td>
                <td align="left">0.928</td>
                <td align="left">0.966</td>
                <td align="left">0.981</td>
                <td align="left">0.973</td>
                <td align="left">9.0 hours</td>
                <td align="left">64 GB</td>
              </tr>
            </tbody>
          </table>
        </table-wrap>
      </p>
      <p id="Par19">
        <fig id="Fig5">
          <label>Fig. 5</label>
          <caption>
            <p>Accuracy and runtime of methods. Showing <bold>a</bold> the F1 score on SNPs and Indels combined and <bold>b</bold> the runtime of each of the methods when genotyping HG002 using read data with 15x coverage. All tools, except Malva, are run with 16 compute cores</p>
          </caption>
          <graphic xlink:href="13059_2022_2771_Fig5_HTML" id="MO5"/>
        </fig>
      </p>
    </sec>
  </sec>
  <sec id="Sec6">
    <title>Discussion</title>
    <p id="Par20">We find that KAGE has as high or higher accuracy than the other genotypers. PanGenie seems to perform similarly on indels, but performs slightly worse on SNPs. Malva performs worse than all the other methods, which we believe makes sense considering that Malva does not have a good way of dealing with variants represented by non-unique kmers. While PanGenie has almost as good accuracy as KAGE, it requires more than 20 times the run time and considerably more memory than KAGE on the experiments we have run. KAGE is able to genotype a full sample with 15x coverage in only about 12 minutes using 16 compute cores, while all the other methods require several hours. This means that with KAGE, given pre-built indexes, it is now possible to genotype a sample quickly and easily on a standard laptop, such as in a clinical setting. The computational efficiency of KAGE also allows for a reduced energy footprint when large numbers of samples are to be genotyped. This is highly relevant given current plans of sequencing more than a million genomes in the coming years [<xref ref-type="bibr" rid="CR13">13</xref>].</p>
    <p id="Par21">We confirm that performing full variant calling with a method such as GATK yields considerably higher accuracy than only genotyping a preset of specified variants. One should therefore be aware of this speed/accuracy tradeoff: genotyping a preset of known variants can be very efficient and give decent accuracy now that a lot of genomic variation is known. However, when the aim is to accurately discover as many variants in a sample as possible, and runtime is not an issue, a variant caller like GATK or DeepVariant [<xref ref-type="bibr" rid="CR14">14</xref>] would be the best option. We note that GATK has higher accuracy in our experiments than what has been found in the previous benchmarks presented in the Graphtyper [<xref ref-type="bibr" rid="CR4">4</xref>] and Malva [<xref ref-type="bibr" rid="CR8">8</xref>] papers, where Malva and Graphtyper are both shown to have as good as and in some cases better genotyping accuracy than GATK. We believe this might be because GATK has been significantly improved in the last few years since these papers were published [<xref ref-type="bibr" rid="CR3">3</xref>]. It should be noted that GATK was used among other tools to create the GIAB truth dataset, which could potentially influence the measured performance of GATK in our experiments.</p>
    <p id="Par22">We are surprised to see that KAGE and PanGenie, which are completely alignment-free, are able to achieve very close accuracy to Graphtyper, which first maps and aligns all reads using BWA-MEM and then locally realigns all reads to a sequence graph. We believe the reason must be that KAGE and PanGenie exploit population information in a more sophisticated way when computing the genotype likelihoods. We speculate that PanGenie should be able to achieve even better accuracy by using more known haplotypes as input, but this would lead to very long run-time and high memory usage due to the quadratic complexity of the Hidden Markov Model used.</p>
    <p id="Par23">While KAGE’s fairly simple builtin “imputation” that uses only a single variant to help genotype another variant seems to work well, we observe higher accuracy when running the more sophisticated imputation tool GLIMPSE on the output from KAGE. We have developed KAGE so that it can optionally be run without the builtin imputation, so that any other imputation tool can be run on the output if the user wishes. We believe that making software modular like this is beneficial for the bioinformatics community, as it enables coupling of different software that are specialised in certain tasks. We believe the high accuracy achieved by KAGE and GLIMPSE together highlights the strength of using reference populations/pangenomes to improve genotyping performance, since in our experiments, this combination clearly outperforms all the other genotypers in run-time, and all except GATK in accuracy.</p>
    <p id="Par24">While Malva’s strength is supposed to be a relatively low run-time, Malva is unfortunately not optimised to run on multiple compute cores/threads. We believe Malva would be able to run considerably faster if it was able to utilise multiple compute cores in the genotyping step. We observe that Bayestyper differs from the other methods by having a lower recall and a higher precision, meaning that Bayestyper is likely more conservative when genotyping. We were not able to tune Bayestyper to provide higher recall at the cost of lower precision.</p>
    <p id="Par25">There are a few limitations of KAGE. First, KAGE is for now only able to genotype SNPs and short indels, and it is important to note that our benchmarks only compare the tools on SNPs and short indels, while several of the methods have been developed also for structural variation. We believe, however, that the ideas that KAGE are based on can be generalised to structural variant calling with short reads, which would be an interesting opportunity for further work. Second, KAGE relies on a relatively good database of known variation from a population. This is important to remember, as not all individuals are well represented in e.g. the 1000 Genomes Project, and genotyping accuracy for such individuals is likely to be lower. The fact that more and more genotypers are using population information to improve accuracy highlights the importance of good reference populations (pangenomes) that represent and cover all ancestries. In the same way, KAGE will not work on other species where pangenomes are not yet available. This does, however, also mean that we expect KAGE to potentially perform even better in the future when more genetic variation data from more individuals will be available. Finally, KAGE and the other kmer-based methods are not able to use information from paired-end reads. We do not consider this a major problem, however, since single-end sequencing is very common and cheaper to perform than paired-end sequencing.</p>
  </sec>
  <sec id="Sec7">
    <title>Conclusions</title>
    <p id="Par26">KAGE allows genotyping of SNPs and short indels by an alignment-free approach that is more than 20 times faster than existing methods, while offering competitive accuracy. We see KAGE as a highly timely contribution to the field, given the plans of large international consortia to sequence and genotype millions of genomes in the coming years.</p>
  </sec>
  <sec id="Sec8">
    <title>Methods</title>
    <sec id="Sec9">
      <title>Model description</title>
      <p id="Par27">The following describes the model and assumptions used in KAGE. We here assume all variants are biallelic variants, each with two <italic>alleles</italic> – a <italic>reference allele</italic> and an <italic>alternative allele</italic>. An individual can thus have the following three genotypes at a variant: Having the reference allele in both chromosomes (we refer to this as having the genotype 0/0), having the alternative allele in both chromosomes (1/1), or having the reference allele in one chromosome and the alternative allele in the other (0/1). Note that we are not concerned with the phasing of genotypes, so 1/0 and 0/1 are considered as being the same genotype.</p>
      <p id="Par28">Assuming a variant of interest <italic>i</italic>, we define <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(G_{i}=g)$$\end{document}</tex-math><mml:math id="M2"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>g</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq1.gif"/></alternatives></inline-formula> as the probability of having the genotype <italic>g</italic> at this variant, where <italic>g</italic> is either 0/0, 0/1 or 1/1. We let <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$K_{i} = (K_{ir}, K_{ia})$$\end{document}</tex-math><mml:math id="M4"><mml:mrow><mml:msub><mml:mi>K</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi mathvariant="italic">ir</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi mathvariant="italic">ia</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq2.gif"/></alternatives></inline-formula> be the observed kmer counts on the reference and variant allele of variant <italic>i</italic>. Every variant of interest <italic>i</italic> has a preselected helper variant <italic>h</italic> with kmer counts <inline-formula id="IEq3"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$K_{h}$$\end{document}</tex-math><mml:math id="M6"><mml:msub><mml:mi>K</mml:mi><mml:mi>h</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq3.gif"/></alternatives></inline-formula>. KAGE genotypes a variant <italic>i</italic> by selecting the most likely genotype. This is done by calculating the posterior probabilities <inline-formula id="IEq4"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(G_{i}|K_{i}, K_{h})$$\end{document}</tex-math><mml:math id="M8"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq4.gif"/></alternatives></inline-formula>:<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} P(G_{i}|K_{i},K_{h}) = P(K_{i}|G_{i}) \sum \limits _{G_{h} \in G} P(G_{h}) P(G_{i} | G_{h}) P(K_{h} | G_{h}) \end{aligned}$$\end{document}</tex-math><mml:math id="M10" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:munder><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:msub><mml:mi>G</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo>∈</mml:mo><mml:mi>G</mml:mi></mml:mrow></mml:munder><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2022_2771_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula>In the above formula, <inline-formula id="IEq5"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(K_{i}|G_{i})$$\end{document}</tex-math><mml:math id="M12"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq5.gif"/></alternatives></inline-formula> is the likelihood of observing the kmer counts <inline-formula id="IEq6"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$K_{i}$$\end{document}</tex-math><mml:math id="M14"><mml:msub><mml:mi>K</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq6.gif"/></alternatives></inline-formula> on the variant of interest given a genotype <inline-formula id="IEq7"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$G_{i}$$\end{document}</tex-math><mml:math id="M16"><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq7.gif"/></alternatives></inline-formula>. The summation corresponds to a prior probability of the genotype <inline-formula id="IEq8"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$G_{i}$$\end{document}</tex-math><mml:math id="M18"><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq8.gif"/></alternatives></inline-formula> given the observed counts on the helper variant and the population structure, with the individual probabilities corresponding to the following:<list list-type="bullet"><list-item><p id="Par29"><inline-formula id="IEq9"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(G_{h})$$\end{document}</tex-math><mml:math id="M20"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq9.gif"/></alternatives></inline-formula> is the probability (over the population) of genotype <inline-formula id="IEq10"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$G_{h}$$\end{document}</tex-math><mml:math id="M22"><mml:msub><mml:mi>G</mml:mi><mml:mi>h</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq10.gif"/></alternatives></inline-formula> at the helper variant.</p></list-item><list-item><p id="Par30"><inline-formula id="IEq11"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(G_{i}|G_{h})$$\end{document}</tex-math><mml:math id="M24"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq11.gif"/></alternatives></inline-formula> is the probability (over the population) of having genotype <inline-formula id="IEq12"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$G_{i}$$\end{document}</tex-math><mml:math id="M26"><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq12.gif"/></alternatives></inline-formula> on the variant of interest given genotype <inline-formula id="IEq13"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$G_{h}$$\end{document}</tex-math><mml:math id="M28"><mml:msub><mml:mi>G</mml:mi><mml:mi>h</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq13.gif"/></alternatives></inline-formula> at the helper variant</p></list-item><list-item><p id="Par31"><inline-formula id="IEq14"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(K_{h}|G_{h})$$\end{document}</tex-math><mml:math id="M30"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq14.gif"/></alternatives></inline-formula> is the likelihood of observing the kmer counts <inline-formula id="IEq15"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$K_{h}$$\end{document}</tex-math><mml:math id="M32"><mml:msub><mml:mi>K</mml:mi><mml:mi>h</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq15.gif"/></alternatives></inline-formula> given genotype <inline-formula id="IEq16"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$G_{h}$$\end{document}</tex-math><mml:math id="M34"><mml:msub><mml:mi>G</mml:mi><mml:mi>h</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq16.gif"/></alternatives></inline-formula> at the helper variant, similarly to <inline-formula id="IEq17"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(K_{i}|G_{i})$$\end{document}</tex-math><mml:math id="M36"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq17.gif"/></alternatives></inline-formula>.</p></list-item></list>The probability distributions for <inline-formula id="IEq18"><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(K_{i}| G_{i})$$\end{document}</tex-math><mml:math id="M38"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq18.gif"/></alternatives></inline-formula> and <inline-formula id="IEq19"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(K_{h} | G_{h})$$\end{document}</tex-math><mml:math id="M40"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>h</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq19.gif"/></alternatives></inline-formula> are modelled as mixtures of Poisson distributions, one Poisson distribution for each individual in the reference population that has the given genotype:<disp-formula id="Equ2"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} P(K_{ir}|G_{i}) = \sum \limits _{t:g_{i}(t)=G_{i}} Pois(K_{ir}; \lambda _{irt})/|\{t:g_{i}(t)=G_{i}\}| \end{aligned}$$\end{document}</tex-math><mml:math id="M42" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi mathvariant="italic">ir</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:munder><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>:</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:munder><mml:mi>P</mml:mi><mml:mi>o</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi mathvariant="italic">ir</mml:mi></mml:mrow></mml:msub><mml:mo>;</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mi mathvariant="italic">irt</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo stretchy="false">/</mml:mo><mml:mrow><mml:mo stretchy="false">|</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mi>t</mml:mi><mml:mo>:</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">}</mml:mo></mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2022_2771_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq20"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$g_{i}(t)$$\end{document}</tex-math><mml:math id="M44"><mml:mrow><mml:msub><mml:mi>g</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq20.gif"/></alternatives></inline-formula> is the genotype of individual <italic>t</italic> at variant <italic>i</italic>. The rate <inline-formula id="IEq21"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda _{irt}$$\end{document}</tex-math><mml:math id="M46"><mml:msub><mml:mi>λ</mml:mi><mml:mrow><mml:mi mathvariant="italic">irt</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq21.gif"/></alternatives></inline-formula> of each individual is proportional to the number of times the kmer <inline-formula id="IEq22"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$s_{ir}$$\end{document}</tex-math><mml:math id="M48"><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mi mathvariant="italic">ir</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq22.gif"/></alternatives></inline-formula> occurs in that individual’s genome (<inline-formula id="IEq23"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d_{irt}$$\end{document}</tex-math><mml:math id="M50"><mml:msub><mml:mi>d</mml:mi><mml:mrow><mml:mi mathvariant="italic">irt</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq23.gif"/></alternatives></inline-formula>) (plus an error term). This gives us:<disp-formula id="Equ3"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} P(K_{ir}|G_{i}) = \sum \limits _{t=1:g_{i}(t)=G_{i}}^{n} Pois(K_{ir}; \lambda _{0}(d_{irt}+\epsilon )/|\{t:g_{i}(t)=G_{i}\}| \end{aligned}$$\end{document}</tex-math><mml:math id="M52" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi mathvariant="italic">ir</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mi>n</mml:mi></mml:munderover><mml:mrow><mml:mi>P</mml:mi><mml:mi>o</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mo stretchy="false">(</mml:mo></mml:mrow><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi mathvariant="italic">ir</mml:mi></mml:mrow></mml:msub><mml:mo>;</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>d</mml:mi><mml:mrow><mml:mi mathvariant="italic">irt</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>ϵ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo stretchy="false">/</mml:mo><mml:mrow><mml:mo stretchy="false">|</mml:mo><mml:mrow><mml:mo stretchy="false">{</mml:mo><mml:mi>t</mml:mi><mml:mo>:</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">}</mml:mo></mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2022_2771_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula>We note that, implementation-wise, the above sum is calculated in a more efficient manner.</p>
      <p id="Par32">The corresponding probabilities <inline-formula id="IEq24"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(K_{ia} |G_{i})$$\end{document}</tex-math><mml:math id="M54"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi mathvariant="italic">ia</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq24.gif"/></alternatives></inline-formula>, <inline-formula id="IEq25"><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(K_{hr} | G_{r})$$\end{document}</tex-math><mml:math id="M56"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi mathvariant="italic">hr</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq25.gif"/></alternatives></inline-formula> and <inline-formula id="IEq26"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(K_{ha} | G_{a})$$\end{document}</tex-math><mml:math id="M58"><mml:mrow><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi mathvariant="italic">ha</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>G</mml:mi><mml:mi>a</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq26.gif"/></alternatives></inline-formula> are calculated using the same setup. The next sections describe further how this is implemented in KAGE, and we refer to the Additional material for more details.</p>
    </sec>
    <sec id="Sec10">
      <title>KAGE implementation</title>
      <p id="Par33">Given the model described in the previous section, the following explains more in detail how KAGE works. KAGE roughly consists of three steps: <italic>indexing</italic>, <italic>kmer counting</italic> and <italic>genotyping</italic>.</p>
      <sec id="Sec11">
        <title>Indexing: Creating a kmer-to-graph-node index, choosing helper variants and finding expected kmer counts</title>
        <p id="Par34">All the following indexes are built once for a reference population and a set of variants one wants to genotype.</p>
        <p id="Par35">In order to genotype a variant, KAGE needs to know how many kmers in the read data set support each allele of the variant. For this, we build an index that enables lookup from any kmer to nodes (if any) in the graph the kmer maps to. Given a set of bi-allelic variants, kmers representing each allele are selected so that every allele of every variant is represented by at least one kmer. This is done by representing the variants as a genome graph (using the Python package obgraph), and for each variant considering all kmers covering the alleles of the variants. A set of kmers is chosen by trying to pick the kmers with lowest maximum “population frequency”, where population frequency is the expected number of times this kmer is found in the population (Fig. <xref rid="Fig6" ref-type="fig">6</xref>). The resulting kmers are stored in an index that enables direct lookup from any kmer to the nodes in the graph that the kmer covers.</p>
        <p id="Par36">For each variant of interest, we also want to find one other variant that correlates well with our variant of interest. This means that for a good helper variant, individuals tend to have the same genotype on the helper variant as on the variant of interest. Using such variants we can improve our prediction of the interest-genotype in cases where the count model for the variant of interest gives ambiguous results. In order to find good helper variants, we evaluate the metric <inline-formula id="IEq27"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sum \nolimits _{G \in \mathcal {G}} \log \pi _{v}(G, G)$$\end{document}</tex-math><mml:math id="M60"><mml:mrow><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>G</mml:mi><mml:mo>∈</mml:mo><mml:mi mathvariant="script">G</mml:mi></mml:mrow></mml:msub><mml:mo>log</mml:mo><mml:msub><mml:mi>π</mml:mi><mml:mi>v</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>G</mml:mi><mml:mo>,</mml:mo><mml:mi>G</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq27.gif"/></alternatives></inline-formula> for the neighbouring 200 variants to the variant of interest, and choose as helper the variant <italic>v</italic> with the highest score.</p>
        <p id="Par37">KAGE also needs a model for expected kmer counts for a “random” individual in the population. For each possible genotype at a variant, we simply count, for each variant allele, how many individuals with the given genotype in a reference population have 0, 1, 2, 3, <inline-formula id="IEq28"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\ldots$$\end{document}</tex-math><mml:math id="M62"><mml:mo>…</mml:mo></mml:math><inline-graphic xlink:href="13059_2022_2771_Article_IEq28.gif"/></alternatives></inline-formula> and so on kmer counts on that allele and store this information in an index.</p>
      </sec>
      <sec id="Sec12">
        <title>Counting kmers in a read data set</title>
        <p id="Par38">Given the kmer indexes described in the previous section, we can count how many times kmers from a read data set maps to nodes representing variant alleles in the graph. The result from this procedure is a count for each node in the graph, saying how many times kmers from the read data set mapped to that node.</p>
      </sec>
      <sec id="Sec13">
        <title>Genotyping</title>
        <p id="Par39">KAGE genotypes a bi-allelic variant in the following way. Given kmer counts for each allele of the variant, the probabilities of observing those counts given the different possible genotypes are calculated using combinations of Poisson models. These models take into account how common it is to observe various kmer counts in a reference population. Similar probabilities are also calculated for the helper variant. We can then calculate the probability of getting the observed counts given each combination of genotypes on the two variants (9 combinations). When combining this with the prior probabilities of each genotype combination (calculated from the observed genotype-combinations in a reference population), we can use Bayes rule to calculate the probabilities of the different genotype combinations given the observed counts. In order to find the marginal probabilities for each genotype of the main variant, we simply sum over the probabilities for each genotype on the helper variant. A more mathematical description is given previously under the section <italic>Model description</italic>, and the full details can be found in the additional material.<fig id="Fig6"><label>Fig. 6</label><caption><p>Illustration of kmer selection. Example of how 3-mers can be selected for the SNP T/G (grey box). KAGE uses a graph-representation of all variants, and considers all possible ways to pick kmers around the two alleles of a variant. Here, there are three possible ways to pick a set of kmers, illustrated by red, blue and purple boxes. In this case, the kmers marked in red will be preferred, as the blue kmers include TTA which is not unique (exists elsewhere in the graph), and the purple kmers similarly include the non-unique kmer GAT</p></caption><graphic xlink:href="13059_2022_2771_Fig6_HTML" id="MO9"/></fig></p>
      </sec>
    </sec>
    <sec id="Sec14">
      <title>Benchmarking genotypers</title>
      <p id="Par40">We compared KAGE against the following other tools: GATK HaplotypeCaller version 4.2.3.0, Graphtyper version 2.7.1 (using the genotype subcommand), Malva version 1.3.1, PanGenie (commit ID da87f55cdccf31cd2c0008fd4848e33ba42021fc) and Bayestyper version 1.5. We also tried including Platypus in the comparison, but were not able to get the tool to work. Both Bayestyper and Malva use kmer-counts from kmc [<xref ref-type="bibr" rid="CR15">15</xref>]. We ran kmc version 3.1.1 and included singleton kmers (using the flag -ci1) for Bayestyper and Malva, as this seemed to give the best results. For Bayestyper and Malva, we used the suggested k specified by the tool documentation, which was 51 for Bayestyper and 31 (short kmers) and 45 (long kmers) for Malva. We ran KAGE and PanGenie with the recommended k=31. While GATK has the option to genotype a specified set of variants, we did not use this option. The reason is that even when this option is specified, GATK will also call other alleles at the specified sites. We also experienced slower run time using this option. Thus, we chose to let GATK just do full variant calling, which is also what it is built for.</p>
      <p id="Par41">GATK and Graphtyper were run on reads mapped to GRCh38 using BWA-MEM [<xref ref-type="bibr" rid="CR16">16</xref>] version 0.7.17-r1188. A Snakemake [<xref ref-type="bibr" rid="CR17">17</xref>] pipeline for running all the experiments and a conda environment with all the necessary tools can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/ivargr/genotyping-benchmarking">https://github.com/ivargr/genotyping-benchmarking</ext-link>. Reads were simulated using Graph Read Simulator (version 0.0.9) with substitution, deletion and insertion rate all set to 0.001. When using experimental data all reads were obtained from the GIAB repository and downsampled to the given coverage used in the experiment. Exact data URLs can be found in the config file of the Snakemake pipeline.</p>
      <p id="Par42">Variants genotyped in the experiments are from the 1000 Genomes Project v2a. Only variants with allele frequency &gt;0.1% were used. Accuracy (precision and recall) was measured using Happy version 0.3.14 against GIAB truth datasets [<xref ref-type="bibr" rid="CR18">18</xref>]. Accuracy was measured within high-confidence regions using the Happy -f flag with the regions file that accompany each GIAB data set. We did not filter any variants on quality or other criteria before running Happy.</p>
      <p id="Par43">To create Table <xref rid="Tab1" ref-type="table">1</xref>, we for simplicity only measure the accuracy on SNPs that exist in the truth dataset, and define a correctly genotyped variant as a variant with the same predicted genotype as the genotype of the variant in the truth data set. The percentages are computed by dividing by the number of correctly genotyped variants with the total number of variants in the truth data set that have unique/non-unique kmers. A variant is defined as having unique kmers if, for both alleles of the variant, there exists at least one kmer that does not exist anywhere else in the genome graph that represents all the variants in the population.</p>
    </sec>
    <sec id="Sec15">
      <title>Software implementation</title>
      <p id="Par44">KAGE was implemented using Python 3, and some run-time critical code (kmer lookup) were written in Cython. All code developed as part of this method has been modularized into four Python packages, each available through the PyPi package repository: kage-genotyper (main tool for genotyping), graph_kmer_index (building and using the kmer indexes necessary for the genotyping), kmer-mapper (counting kmers) and obgraph (building and working with the sequence graphs). KAGE with all dependencies can be installed directly by installing only the kage-genotyper package.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Information</title>
    <sec id="Sec16">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="13059_2022_2771_MOESM1_ESM.pdf">
            <caption>
              <p>Additional file 1. Includes supplementary Tables S1-S3 and further details of method.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="13059_2022_2771_MOESM2_ESM.pdf">
            <caption>
              <p>Additional file 2. Review history.</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p>
        <bold>Publisher’s Note</bold>
      </p>
      <p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <ack>
    <sec id="FPar1">
      <title>Peer review information</title>
      <p id="Par45">Kevin Pang was the primary editor of this article and managed its editorial process and peer review in collaboration with the rest of the editorial team.</p>
    </sec>
    <sec id="FPar2">
      <title>Review history</title>
      <p id="Par46">The review history is available as Additional file <xref rid="MOESM2" ref-type="media">2</xref>.</p>
    </sec>
  </ack>
  <notes notes-type="author-contribution">
    <title>Authors’ contributions</title>
    <p>IG, KDR and GKS drafted the manuscript. IG and KDR developed the software. IG, KDR and GKS contributed to the conception and design of the study, and to the interpretation of data. All authors have read and approved the final version of the manuscript.</p>
  </notes>
  <notes notes-type="funding-information">
    <title>Funding</title>
    <p>This work was supported by the Centre for Computational Inference in Evolutionary Life Science (CELS). We also acknowledge generous support by the Research Council of Norway for an IKTPLUSS project (#311341) to KR and GKS.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Availability of data and materials</title>
    <p>The datasets generated and/or analysed during the current study are available through the following git repository: <ext-link ext-link-type="uri" xlink:href="https://github.com/ivargr/genotyping-benchmarking">https://github.com/ivargr/genotyping-benchmarking</ext-link> (version 0.0.2). An index that can be used with KAGE to reproduce the experiments is available at <ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/6674055/files/index_2548all.npz">https://zenodo.org/record/6674055/files/index_2548all.npz</ext-link>. KAGE is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/ivargr/kage">https://github.com/ivargr/kage</ext-link> (version 0.1.1, GNU General Public Licence v3.0) and through Zenodo (DOI: 10.5281/zenodo.7065145).</p>
  </notes>
  <notes>
    <title>Declarations</title>
    <notes id="FPar3">
      <title>Ethics approval and consent to participate</title>
      <p id="Par47">Not applicable</p>
    </notes>
    <notes id="FPar4">
      <title>Consent for publication</title>
      <p id="Par48">Not applicable</p>
    </notes>
    <notes id="FPar5" notes-type="COI-statement">
      <title>Competing interests</title>
      <p id="Par49">The authors declare that they have no competing interests.</p>
    </notes>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <mixed-citation publication-type="other">1000 Genomes Project Consortium, et al. A global reference for human genetic variation. Nature. 2015;526(7571):68.</mixed-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Korte</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Farlow</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>The advantages and limitations of trait analysis with GWAS: a review</article-title>
        <source>Plant Methods.</source>
        <year>2013</year>
        <volume>9</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>9</lpage>
        <pub-id pub-id-type="doi">10.1186/1746-4811-9-29</pub-id>
        <pub-id pub-id-type="pmid">23286457</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <mixed-citation publication-type="other">Poplin R, Ruano-Rubio V, DePristo MA, Fennell TJ, Carneiro MO, Van der Auwera GA, et al. Scaling accurate genetic variant discovery to tens of thousands of samples. BioRxiv. 2017:201178.</mixed-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Eggertsson</surname>
            <given-names>HP</given-names>
          </name>
          <name>
            <surname>Jonsson</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Kristmundsdottir</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Hjartarson</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Kehr</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Masson</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Graphtyper enables population-scale genotyping using pangenome graphs</article-title>
        <source>Nat Genet.</source>
        <year>2017</year>
        <volume>49</volume>
        <issue>11</issue>
        <fpage>1654</fpage>
        <lpage>60</lpage>
        <pub-id pub-id-type="doi">10.1038/ng.3964</pub-id>
        <pub-id pub-id-type="pmid">28945251</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Martiniano</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Garrison</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Jones</surname>
            <given-names>ER</given-names>
          </name>
          <name>
            <surname>Manica</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Durbin</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Removing reference bias and improving indel calling in ancient DNA data analysis by mapping to a sequence variation graph</article-title>
        <source>Genome Biol.</source>
        <year>2020</year>
        <volume>21</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>18</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-020-02160-7</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Shajii</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Yorukoglu</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>William</surname>
            <given-names>YuY</given-names>
          </name>
          <name>
            <surname>Berger</surname>
            <given-names>B</given-names>
          </name>
        </person-group>
        <article-title>Fast genotyping of known SNPs through approximate k-mer matching</article-title>
        <source>Bioinformatics.</source>
        <year>2016</year>
        <volume>32</volume>
        <issue>17</issue>
        <fpage>i538</fpage>
        <lpage>44</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btw460</pub-id>
        <pub-id pub-id-type="pmid">27587672</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sun</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Medvedev</surname>
            <given-names>P</given-names>
          </name>
        </person-group>
        <article-title>Toward fast and accurate SNP genotyping from whole genome sequencing data for bedside diagnostics</article-title>
        <source>Bioinformatics.</source>
        <year>2019</year>
        <volume>35</volume>
        <issue>3</issue>
        <fpage>415</fpage>
        <lpage>20</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/bty641</pub-id>
        <pub-id pub-id-type="pmid">30032192</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Denti</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Previtali</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Bernardini</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Schönhuth</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Bonizzoni</surname>
            <given-names>P</given-names>
          </name>
        </person-group>
        <article-title>MALVA: genotyping by Mapping-free ALlele detection of known VAriants</article-title>
        <source>Iscience.</source>
        <year>2019</year>
        <volume>18</volume>
        <fpage>20</fpage>
        <lpage>7</lpage>
        <pub-id pub-id-type="doi">10.1016/j.isci.2019.07.011</pub-id>
        <pub-id pub-id-type="pmid">31352182</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sibbesen</surname>
            <given-names>JA</given-names>
          </name>
          <name>
            <surname>Maretty</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Krogh</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Accurate genotyping across variant classes and lengths using variant graphs</article-title>
        <source>Nat Genet.</source>
        <year>2018</year>
        <volume>50</volume>
        <issue>7</issue>
        <fpage>1054</fpage>
        <lpage>9</lpage>
        <pub-id pub-id-type="doi">10.1038/s41588-018-0145-5</pub-id>
        <pub-id pub-id-type="pmid">29915429</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ebler</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Ebert</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Clarke</surname>
            <given-names>WE</given-names>
          </name>
          <name>
            <surname>Rausch</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Audano</surname>
            <given-names>PA</given-names>
          </name>
          <name>
            <surname>Houwaart</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Pangenome-based genome inference allows efficient and accurate genotyping across a wide spectrum of variant classes</article-title>
        <source>Nat Genet.</source>
        <year>2022</year>
        <volume>54</volume>
        <issue>4</issue>
        <fpage>518</fpage>
        <lpage>25</lpage>
        <pub-id pub-id-type="doi">10.1038/s41588-022-01043-w</pub-id>
        <pub-id pub-id-type="pmid">35410384</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Krusche</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Trigg</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Boutros</surname>
            <given-names>PC</given-names>
          </name>
          <name>
            <surname>Mason</surname>
            <given-names>CE</given-names>
          </name>
          <name>
            <surname>Francisco</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Moore</surname>
            <given-names>BL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Best practices for benchmarking germline small-variant calls in human genomes</article-title>
        <source>Nat Biotechnol.</source>
        <year>2019</year>
        <volume>37</volume>
        <issue>5</issue>
        <fpage>555</fpage>
        <lpage>60</lpage>
        <pub-id pub-id-type="doi">10.1038/s41587-019-0054-x</pub-id>
        <pub-id pub-id-type="pmid">30858580</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rubinacci</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Ribeiro</surname>
            <given-names>DM</given-names>
          </name>
          <name>
            <surname>Hofmeister</surname>
            <given-names>RJ</given-names>
          </name>
          <name>
            <surname>Delaneau</surname>
            <given-names>O</given-names>
          </name>
        </person-group>
        <article-title>Efficient phasing and imputation of low-coverage sequencing data using large reference panels</article-title>
        <source>Nat Genet.</source>
        <year>2021</year>
        <volume>53</volume>
        <issue>1</issue>
        <fpage>120</fpage>
        <lpage>6</lpage>
        <pub-id pub-id-type="doi">10.1038/s41588-020-00756-0</pub-id>
        <pub-id pub-id-type="pmid">33414550</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Saunders</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Baudis</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Becker</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Beltran</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Béroud</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Birney</surname>
            <given-names>E</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Leveraging European infrastructures to access 1 million human genomes by 2022</article-title>
        <source>Nat Rev Genet.</source>
        <year>2019</year>
        <volume>20</volume>
        <issue>11</issue>
        <fpage>693</fpage>
        <lpage>701</lpage>
        <pub-id pub-id-type="doi">10.1038/s41576-019-0156-9</pub-id>
        <pub-id pub-id-type="pmid">31455890</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Poplin</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Chang</surname>
            <given-names>PC</given-names>
          </name>
          <name>
            <surname>Alexander</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Schwartz</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Colthurst</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Ku</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A universal SNP and small-indel variant caller using deep neural networks</article-title>
        <source>Nat Biotechnol.</source>
        <year>2018</year>
        <volume>36</volume>
        <issue>10</issue>
        <fpage>983</fpage>
        <lpage>7</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.4235</pub-id>
        <pub-id pub-id-type="pmid">30247488</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kokot</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Długosz</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Deorowicz</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>KMC 3: counting and manipulating k-mer statistics</article-title>
        <source>Bioinformatics.</source>
        <year>2017</year>
        <volume>33</volume>
        <issue>17</issue>
        <fpage>2759</fpage>
        <lpage>61</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btx304</pub-id>
        <pub-id pub-id-type="pmid">28472236</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <mixed-citation publication-type="other">Li H. Aligning sequence reads, clone sequences and assembly contigs with BWA-MEM. arXiv preprint <ext-link ext-link-type="uri" xlink:href="http://arxiv.org/abs/1303.3997">arXiv:1303.3997</ext-link>. 2013.</mixed-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <mixed-citation publication-type="other">Mölder F, Jablonski KP, Letcher B, Hall MB, Tomkins-Tinch CH, Sochat V, et al. Sustainable data analysis with Snakemake. F1000Research. 2021;10.</mixed-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zook</surname>
            <given-names>JM</given-names>
          </name>
          <name>
            <surname>Catoe</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>McDaniel</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Vang</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Spies</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Sidow</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Extensive sequencing of seven human genomes to characterize benchmark reference materials</article-title>
        <source>Sci Data.</source>
        <year>2016</year>
        <volume>3</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>26</lpage>
        <pub-id pub-id-type="doi">10.1038/sdata.2016.25</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
