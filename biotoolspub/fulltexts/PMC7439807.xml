<?all-math-mml yes?>
<?use-mml?>
<?properties open_access?>
<?properties manuscript?>
<?origin nihpa?>
<?iso-abbr Nat. Methods?>
<?submitter-system nihms?>
<?submitter-canonical-name Nature Publishing Group?>
<?submitter-canonical-id NATURE-STRUCTUR?>
<?submitter-userid 8068858?>
<?submitter-authority myNCBI?>
<?submitter-login nature-structure?>
<?submitter-name Nature Publishing Group?>
<?domain nihpa?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-journal-id">101215604</journal-id>
    <journal-id journal-id-type="pubmed-jr-id">32338</journal-id>
    <journal-id journal-id-type="nlm-ta">Nat Methods</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat. Methods</journal-id>
    <journal-title-group>
      <journal-title>Nature methods</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1548-7091</issn>
    <issn pub-type="epub">1548-7105</issn>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">7439807</article-id>
    <article-id pub-id-type="pmid">32123397</article-id>
    <article-id pub-id-type="doi">10.1038/s41592-020-0748-5</article-id>
    <article-id pub-id-type="manuscript">nihpa1549979</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>TooManyCells identifies and visualizes relationships of single-cell clades</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Schwartz</surname>
          <given-names>Gregory W.</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Zhou</surname>
          <given-names>Yeqiao</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Petrovic</surname>
          <given-names>Jelena</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Fasolino</surname>
          <given-names>Maria</given-names>
        </name>
        <xref ref-type="aff" rid="A2">2</xref>
        <xref ref-type="aff" rid="A3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Xu</surname>
          <given-names>Lanwei</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Shaffer</surname>
          <given-names>Sydney M.</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Pear</surname>
          <given-names>Warren S.</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Vahedi</surname>
          <given-names>Golnaz</given-names>
        </name>
        <xref ref-type="aff" rid="A2">2</xref>
        <xref ref-type="aff" rid="A3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Faryabi</surname>
          <given-names>Robert B.</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A4">4</xref>
      </contrib>
    </contrib-group>
    <aff id="A1"><label>1</label>Department of Pathology and Laboratory Medicine, Perelman School of Medicine, University of Pennsylvania, Philadelphia, PA 19104, USA</aff>
    <aff id="A2"><label>2</label>Department of Genetics, Perelman School of Medicine, University of Pennsylvania, Philadelphia, PA 19104, USA</aff>
    <aff id="A3"><label>3</label>Penn Epigenetics Institute, Perelman School of Medicine, University of Pennsylvania, Philadelphia, PA 19104, USA</aff>
    <aff id="A4"><label>4</label>Abramson Family Cancer Research Institute, Perelman School of Medicine, University of Pennsylvania, Philadelphia, PA 19104, USA</aff>
    <author-notes>
      <fn fn-type="con" id="FN1">
        <p id="P1">Authors Contributions</p>
        <p id="P2">Conceptualization: R.B.F., G.W.S.; Methodology: G.W.S., R.B.F.; Software: G.W.S.; Investigation: G.W.S., R.B.F., J.P., Y.Z.; Formal Analysis: G.W.S., R.B.F., J.P., M.F., S.M.S., L.X., Y.Z.; Resources and Reagents: R.B.F., G.V.; Writing-Review &amp; Editing: G.W.S., R.B.F., W.S.P., J.P., Y.Z.; Writing-Original Draft: G.W.S., R.B.F.; Supervision: R.B.F.; Funding Acquisition: R.B.F.</p>
      </fn>
      <corresp id="CR1">
        <email>faryabi@pennmedicine.upenn.edu</email>
      </corresp>
    </author-notes>
    <pub-date pub-type="nihms-submitted">
      <day>29</day>
      <month>7</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>02</day>
      <month>3</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <month>4</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>02</day>
      <month>9</month>
      <year>2020</year>
    </pub-date>
    <volume>17</volume>
    <issue>4</issue>
    <fpage>405</fpage>
    <lpage>413</lpage>
    <!--elocation-id from pubmed: 10.1038/s41592-020-0748-5-->
    <permissions>
      <license xlink:href="http://www.nature.com/authors/editorial_policies/license.html#terms">
        <license-p>Users may view, print, copy, and download text and data-mine the content in such documents, for the purposes of academic research, subject always to the full Conditions of use:<ext-link ext-link-type="uri" xlink:href="http://www.nature.com/authors/editorial_policies/license.html#terms">http://www.nature.com/authors/editorial_policies/license.html#terms</ext-link></license-p>
      </license>
    </permissions>
    <abstract id="ABS1">
      <p id="P3">Identifying and visualizing transcriptionally similar cells is instrumental for accurate exploration of cellular diversity revealed by single-cell transcriptomics. However, widely used clustering and visualization algorithms produce a fixed number of cell clusters. A fixed clustering “resolution” hampers our ability to identify and visualize echelons of cell states. We developed TooManyCells, a suite of graph-based algorithms for efficient and unbiased identification and visualization of cell clades. TooManyCells introduces a novel visualization model built on a concept intentionally orthogonal to dimensionality reduction methods. TooManyCells is also equipped with an efficient matrix-free divisive hierarchical spectral clustering wholly different from prevalent single-resolution clustering methods. Together, TooManyCells enables multi-resolution and multifaceted exploration of single-cell clades. An advantage of this paradigm is the immediate detection of rare and common populations that outperforms popular clustering and visualization algorithms as demonstrated using existing single-cell transcriptomic data sets and new data modeling drug resistance acquisition in leukemic T cells.</p>
    </abstract>
  </article-meta>
</front>
<body>
  <sec id="S1">
    <title>Introduction</title>
    <p id="P4">Transcription is an important contributor to phenotypic and functional cell states. Emergent technologies such as single-cell RNA sequencing (scRNA-seq) have markedly improved identification and characterization of cell state heterogeneity. To this end, algorithms for unsupervised delineation and visualization of cells with similar expression patterns have improved the understanding of cell lineage complexity, tumor heterogeneity, and diversity of response to oncology drugs<sup><xref rid="R1" ref-type="bibr">1</xref>–<xref rid="R5" ref-type="bibr">5</xref></sup>. Nevertheless, it remains challenging to simultaneously stratify rare and common cell populations and explore their relationships.</p>
    <p id="P5">Clustering algorithms have been proposed to partition scRNA-seq data to identify groups of cells with related transcriptional programs<sup><xref rid="R1" ref-type="bibr">1</xref>,<xref rid="R6" ref-type="bibr">6</xref>–<xref rid="R10" ref-type="bibr">10</xref></sup>. In most scRNA-seq analyses, the identified cell clusters are visualized using dimensionality reduction algorithms such as t-SNE or UMAP<sup><xref rid="R11" ref-type="bibr">11</xref>–<xref rid="R13" ref-type="bibr">13</xref></sup>. These workflows produce and visualize single-resolution cell clustering using methods that mostly lack quantitative presentation of relationships among the clusters.</p>
    <p id="P6">Resolution of cell state stratification unduly influences findings in scRNA-seq experiments. For instance, a resolution separating lymphocytes from monocytes may not readily subdivide various lymphocyte lineages. Given that varying cell states are inherently nested, we postulated that algorithms delineating hierarchies of groups and visualizing their relationships can be used to effectively interrogate echelons of cell states. To this end, we developed TooManyCells for scRNA-seq data visualization and exploration. TooManyCells implements a suite of novel graph-based algorithms and tools for efficient, global, and unbiased identification and visualization of cell clades. TooManyCells maintains and presents cluster relationships within and across varying clustering resolutions, and enables delineation of context-dependent rare and abundant cell populations.</p>
    <p id="P7">We demonstrated the effectiveness of TooManyCells in reliably identifying and clearly visualizing abundant and rare subpopulations using several analyses. Three publicly available scRNA-seq data sets, synthetic data, and controlled subsetting and mixing experiments of single-cell populations were used for comparative benchmarking. TooManyCells outperforms other popular methods to detect and visualize rare populations down to the smallest tested benchmark of 0.5% prevalence in several controlled cell admixtures and simulated data. Additionally, TooManyCells assisted in a fine-grain B cell lineage stratification within mouse splenocytes and was able to identify rare plasmablasts<sup><xref rid="R14" ref-type="bibr">14</xref></sup> that were overlooked by popular Louvain-based clustering and projection-based visualization algorithms.</p>
    <p id="P8">We further used TooManyCells to explore the effect of dosage on acquiring resistance to a gamma-secretase inhibitor (GSI), a targeted Notch signaling antagonist. While other popular methods failed, TooManyCells revealed a rare resistant-like subpopulation of parental cells. TooManyCells and its individual components are available through <ext-link ext-link-type="uri" xlink:href="https://github.com/faryabib/too-many-cells">https://github.com/faryabib/too-many-cells</ext-link>.</p>
  </sec>
  <sec id="S2">
    <title>Results</title>
    <sec id="S3">
      <title>TooManyCells for visualization of cell clade relationships.</title>
      <p id="P9">Clear visualization is critical for scRNA-seq data exploration and is dominated by projection-based algorithms such as t-SNE and UMAP. For large and complex cell admixtures, projection methods suffer from rendering many overlapping cells that overwhelms the single-cell resolution visualization. More importantly, these algorithms generally do not report quantitative inter-cluster relationships and lack interpretable visualizations across clustering resolutions. To address these limitations, we developed TooManyCells for fully customizable visualization of inter-cluster relationships in a tree data abstraction (<xref rid="F1" ref-type="fig">Figure 1</xref>).</p>
      <p id="P10">Multiple algorithms use traditional dendrogram plots to infer cell clades from scRNA-seq profiles<sup><xref rid="R15" ref-type="bibr">15</xref>–<xref rid="R18" ref-type="bibr">18</xref></sup>. Yet, robust cell clade inference remains challenging. Alternatively, outputs of flat clustering algorithms at different resolutions can be related in a tree structure<sup><xref rid="R18" ref-type="bibr">18</xref></sup>; however, this method relies on arbitrary numbers of resolutions and tuning parameters. We reasoned that divisive hierarchical spectral clustering can overcome these limitations by using all information embedded in the cell-cell similarity graph. To enable efficient generation of the hierarchy, TooManyCells implements a transformation of the gene expression matrix that eliminates the explicit calculation of cell-cell similarity and Laplacian matrices followed by full matrix factorization, which were otherwise required for finding the most informative bipartition of cells at each branching point (<xref rid="F1" ref-type="fig">Figure 1b</xref>). This novel “matrix-free” approach substantially improves the memory and time requirements of divisive clustering and recursively identifies candidate bipartitions to create a hierarchy of cell clades. By using Newman-Girvan modularity<sup><xref rid="R19" ref-type="bibr">19</xref></sup> as a stopping criteria instead of an optimization parameter, TooManyCells bypasses limitations associated with heuristic global optimization-based clustering such as Louvain-based algorithms<sup><xref rid="R20" ref-type="bibr">20</xref>,<xref rid="R21" ref-type="bibr">21</xref></sup>, avoids creating arbitrarily small clusters, and allows simultaneous detection of large and small clusters (see <xref rid="S10" ref-type="sec">Online Methods</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 1</xref>).</p>
      <p id="P11">For clear and interpretable displays of cell clades, TooManyCells is designed with many features that facilitate data exploration and assist with finding relevant populations, including branch scaling, weighted average color blending, and statistically-driven tree pruning (<xref rid="F2" ref-type="fig">Figure 2</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 1</xref>). To enhance data visualization versatility and complement existing single-resolution methods, TooManyCells can display any tree data structure and outputs of other clustering algorithms (<xref rid="SD1" ref-type="supplementary-material">Figures S1</xref> – <xref rid="SD1" ref-type="supplementary-material">S4</xref>). To this end, TooManyCells produces visually informative hierarchies of nested cell clusters. Inner nodes are clusters at a given resolution and leaf nodes are finer-grain clusters, where additional bipartitioning would be as informative as random bipartitioning. To enable an end-to-end built-in scRNA-seq analysis solution, we also equipped TooManyCells with a suite of tools and functionalities including, but not limited to, data normalizations, data filtrations, similarity measure calculation, subtree generation, differential expression, data import/export, and novel algorithms for scRNA-seq diversity quantification and rarefaction analysis (<xref rid="SD1" ref-type="supplementary-material">Figure S5</xref>, <xref rid="S10" ref-type="sec">Online Methods</xref>, and <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 2</xref>).</p>
    </sec>
    <sec id="S4">
      <title>TooManyCells efficiently identifies pure cell clusters.</title>
      <p id="P12">To assess TooManyCells’ performance, we first used the <italic>Tabula Muris</italic> data sets<sup><xref rid="R22" ref-type="bibr">22</xref></sup> to examine the extent of cell homogeneity in cluster identification. As part of the <italic>Tabula Muris</italic>, 11 organs of three month old mice were profiled by scRNA-seq, and their cell type composition was determined using organ-specific optimized analyses<sup><xref rid="R22" ref-type="bibr">22</xref></sup>. TooManyCells clusters were compared with the clusters generated by widely used Cell Ranger<sup><xref rid="R23" ref-type="bibr">23</xref></sup>, Monocle<sup><xref rid="R8" ref-type="bibr">8</xref></sup>, Phenograph<sup><xref rid="R6" ref-type="bibr">6</xref></sup>, Seurat<sup><xref rid="R7" ref-type="bibr">7</xref></sup>, RaceID<sup><xref rid="R24" ref-type="bibr">24</xref></sup>, CIDR<sup><xref rid="R16" ref-type="bibr">16</xref></sup>, and BackSPIN<sup><xref rid="R15" ref-type="bibr">15</xref></sup> algorithms, the latter two being agglomerative and divisive hierarchical algorithms, respectively (<xref rid="F3" ref-type="fig">Figures 3a</xref>–<xref rid="F3" ref-type="fig">d</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 3</xref>).</p>
      <p id="P13">For each algorithm, default or suggested filters and parameters were considered (see <xref rid="S10" ref-type="sec">Online Methods</xref>). The first comparative analysis was performed based on an increased level of cell mixture complexity, where the first 3, 6, 9, and finally all 11 data sets from thymus, spleen, bone marrow, limb muscle, tongue, heart, lung, mammary gland, bladder, kidney, and liver were considered (<xref rid="F3" ref-type="fig">Figures 3a</xref> and <xref rid="SD1" ref-type="supplementary-material">S6</xref>). Further comparisons were carried out using three additional data sets of cell lines or fluorescence activated cell sorting (FACS)-purified cells: CD14+ monocytes, CD19+ B, and CD4+ T cells<sup><xref rid="R23" ref-type="bibr">23</xref></sup> (<xref rid="F3" ref-type="fig">Figure 3b</xref>), seven cancer lines<sup><xref rid="R17" ref-type="bibr">17</xref></sup> (<xref rid="F3" ref-type="fig">Figure 3c</xref>), and B lymphocytes/natural killer, megakaryocyte-erythroid, and granulocyte–monocyte progenitors<sup><xref rid="R25" ref-type="bibr">25</xref></sup> (<xref rid="F3" ref-type="fig">Figure 3d</xref>).</p>
      <p id="P14">Rare-cell-clustering RaceID and hierarchical CIDR and BackSPIN methods failed to finish analyses of the high complexity data sets of ~30,000 to 40,000 cells within four days (<xref rid="F3" ref-type="fig">Figures 3a</xref> and <xref rid="F3" ref-type="fig">3b</xref>). Across all complexities and evaluation metrics in the <italic>Tabula Muris</italic> data sets, TooManyCells was the most successful in separating cell type labels (<xref rid="F3" ref-type="fig">Figure 3a</xref>). All the scalable algorithms that clustered the immune cells generally performed well. However, TooManyCells again marginally outperformed all others (<xref rid="F3" ref-type="fig">Figure 3b</xref>). Similarly, TooManyCells performed the best in separating seven distinct cancer cell lines (<xref rid="F3" ref-type="fig">Figure 3c</xref>). However, TooManyCells was close with Seurat and Cell Ranger in separating lineage negative hematopoietic progenitor cells (<xref rid="F3" ref-type="fig">Figure 3d</xref>). We note that these cells are highly heterogeneous and their population structures, defined by a few cell surface markers, remain enigmatic<sup><xref rid="R25" ref-type="bibr">25</xref>,<xref rid="R26" ref-type="bibr">26</xref></sup>. Comparison of different normalization procedures showed that TooManyCells’ performance was only marginally influenced by normalization choice (<xref rid="F3" ref-type="fig">Figures 3e</xref>–<xref rid="F3" ref-type="fig">h</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 4</xref>).</p>
      <p id="P15">While not scalable to large data sets (<xref rid="F3" ref-type="fig">Figure 3a</xref>), BackSPIN, another divisive clustering algorithm, exhibited the best performance in separating highly diverse hematopoietic progenitor cells (<xref rid="F3" ref-type="fig">Figure 3d</xref>). Importantly, all the scalable algorithms only report single-resolution cluster outputs at a time, while TooManyCells’ multilayer output identifies context-dependent clades from the entire presented cluster hierarchy. The TooManyCells-rendered cluster tree further guides the choice of clustering granularity by contextualizing cluster features such as relative size, modularity (<xref rid="F2" ref-type="fig">Figure 2d</xref>), and distance from the root. This unique TooManyCells feature sets it apart from existing visualization algorithms that lack interpretable rendering of relationships across varying clustering resolutions. Furthermore, the run time of TooManyCells’ multi-resolution clustering was comparable to run times of single-resolution clustering algorithms for small data sets (<xref rid="SD1" ref-type="supplementary-material">Figure S7</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 5</xref>), and markedly outperformed them for large data sets (<xref rid="F3" ref-type="fig">Figures 3a</xref> and <xref rid="F3" ref-type="fig">3b</xref>). Together, these data show that in contrast to rare-cell-detection (RaceID) and hierarchical clustering (BackSPIN, CIDR), TooManyCells provides accurate and scalable clustering.</p>
    </sec>
    <sec id="S5">
      <title>TooManyCells accurately delineates both rare and common subpopulations of controlled admixtures.</title>
      <p id="P16">Simultaneous detection of rare and common cell populations is a major challenge in scRNA-seq analysis. While many clustering algorithms claim to identify rare populations, few have explicitly benchmarked this ability. To rigorously assess each algorithm’s affinity to delineate rare populations, we simulated different levels of rare and common populations based on cells from different mouse organs. An accurate clustering is expected to not only detect the rare populations from the common but also distinguish the rare populations from each other. To this end, two equal-size “rare” populations were mixed with a “common” cell population. TooManyCells recapitulated known relationships between cell types within mouse organs (<xref rid="SD1" ref-type="supplementary-material">Figures S8</xref> – <xref rid="SD1" ref-type="supplementary-material">S18</xref>) and showed that T cells were dissimilar from both macrophages and dendritic cells, as expected (<xref rid="SD1" ref-type="supplementary-material">Figure S19</xref>). Based on these data, ten different cell admixtures with different ratios of “common” T and “rare” macrophage and dendritic cell populations were generated (see <xref rid="S10" ref-type="sec">Online Methods</xref>).</p>
      <p id="P17">Visual inspection of t-SNE projections showed discrepancies between the actual cell types and their cluster labels (<xref rid="F4" ref-type="fig">Figures 4a</xref>, <xref rid="F4" ref-type="fig">4b</xref>, and <xref rid="SD1" ref-type="supplementary-material">S20</xref>). Regardless of the clustering algorithm, t-SNE plots were limited in clearly distinguishing the two rare populations in an admixture. t-SNE plots’ visual inspections identified numerous small islands (<xref rid="F4" ref-type="fig">Figures 4a</xref>, <xref rid="F4" ref-type="fig">4b</xref> left columns, and <xref rid="SD1" ref-type="supplementary-material">S20</xref>). However, it was impossible to visually localize the true rare populations in the absence of cell type labels. This issue is inherent to t-SNE, where distance and density are converted to local density. UMAP projections had similarly poor performance (<xref rid="SD1" ref-type="supplementary-material">Figure S21</xref>). By contrast, TooManyCells is specifically designed to plot cluster relationships and thus readily presented the rare populations (<xref rid="F4" ref-type="fig">Figures 4c</xref>, <xref rid="SD1" ref-type="supplementary-material">S22</xref>, and <xref rid="SD1" ref-type="supplementary-material">S23</xref>). In the 10% rare populations admixture, TooManyCells separated the rare and common populations followed by splitting the two rare groups, keeping the common cells in large clusters (<xref rid="F4" ref-type="fig">Figure 4c</xref> left panel). Interestingly, rare populations would have been easily identifiable even in the absence of cell type labels as the branch thickness and modularity values (shown by black circles) pointed out the rare subpopulations (<xref rid="F4" ref-type="fig">Figure 4c</xref> left panel). In 1% rare population mixing experiment, TooManyCells again delineated the rare populations and readily presented them with the help of a drastically smaller subtree (<xref rid="F4" ref-type="fig">Figure 4c</xref> right panel). Similar observations were made for eight other mixing experiments with different admixture ratios (<xref rid="SD1" ref-type="supplementary-material">Figures S22</xref> and <xref rid="SD1" ref-type="supplementary-material">S23</xref>).</p>
      <p id="P18">We next quantitatively compared the performance of TooManyCells in the detection of rare populations (<xref rid="SD1" ref-type="supplementary-material">Figures S20</xref> – <xref rid="SD1" ref-type="supplementary-material">S23</xref>) with other commonly used clustering algorithms (see <xref rid="S10" ref-type="sec">Online methods</xref>). These analyses showed that regardless of the purity benchmark (<xref rid="F3" ref-type="fig">Figure 3a</xref>), TooManyCells frequently outperformed other algorithms (<xref rid="F4" ref-type="fig">Figure 4d</xref>).</p>
      <p id="P19">Given that the organ-of-origin would provide an unbiased cell labeling, we further quantified how TooManyCells and other algorithms simultaneously segregated common and rare subpopulations in controlled admixtures consisting of cells from distinct mouse organs. In both the “common” bladder cells with “rare” cells from heart and tongue (<xref rid="F4" ref-type="fig">Figure 4e</xref>) and “common” tongue cells with more dissimilar (<xref rid="SD1" ref-type="supplementary-material">Figure S19</xref>) “rare” bone marrow and mammary gland cells (<xref rid="SD1" ref-type="supplementary-material">Figure S24</xref>), TooManyCells more accurately separated common and rare cells from different mouse organs.</p>
      <p id="P20">Furthermore, controlled admixtures of FACS-purified CD14+ monocytes, CD19+ B, and CD4+ T cells from healthy human peripheral blood mononuclear cells (PBMCs)<sup><xref rid="R23" ref-type="bibr">23</xref></sup> confirmed that TooManyCells produces the best segregation of “common” B cells, and “rare” monocytes and T cells (<xref rid="F4" ref-type="fig">Figure 4f</xref>). More importantly, while t-SNE and UMAP embeddings lacked clear guidance toward the location of rare cells (<xref rid="SD1" ref-type="supplementary-material">Figures S25</xref> and <xref rid="SD1" ref-type="supplementary-material">S26</xref>), structural features of the TooManyCells tree highlighted the rare subpopulations (<xref rid="SD1" ref-type="supplementary-material">Figures S27</xref> and <xref rid="SD1" ref-type="supplementary-material">S28</xref>).</p>
      <p id="P21">Lastly, we sought to characterize performance using synthetic data. Not only did TooManyCells accurately identify the number of populations in a controlled synthetic admixture (<xref rid="SD1" ref-type="supplementary-material">Figure S29</xref>), the algorithm also outperformed all other tested methods (<xref rid="F4" ref-type="fig">Figures 4f</xref>, <xref rid="SD1" ref-type="supplementary-material">S30</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 6</xref>). Together, these data suggest that TooManyCells robustly outperformed the other algorithms in stratifying both common and rare subpopulations, and further revealed that the performance of BackSPIN, RaceID, and Seurat markedly varied across benchmarking experiments.</p>
    </sec>
    <sec id="S6">
      <title>TooManyCells identifies rare plasmablasts in mouse spleen.</title>
      <p id="P22">To further demonstrate TooManyCells’ ability to simultaneously stratify rare and common cell populations <italic>de novo</italic>, we analyzed the immune cell composition of the C57BL/6 mouse spleen. TooManyCells with a restricted modularity pruning threshold (<xref rid="SD1" ref-type="supplementary-material">Figure S31</xref>) readily separated B cells, T cells, macrophages, and dendritic cells (<xref rid="F5" ref-type="fig">Figure 5a</xref>). As expected, B and T cells comprised the majority of profiled splenocytes, and were mostly separated at the first bifurcation. The macrophages were less abundant and were separated from the T cells and further subgrouped. High modularity throughout the macrophage subtree suggested heterogeneity of splenic resident macrophages, confirming flow cytometry analysis<sup><xref rid="R27" ref-type="bibr">27</xref>,<xref rid="R28" ref-type="bibr">28</xref></sup>. Similarly, heterogenous and relatively rare dendritic cells were also partitioned in high modularity locations (<xref rid="F5" ref-type="fig">Figure 5a</xref>), as expected<sup><xref rid="R29" ref-type="bibr">29</xref></sup>.</p>
      <p id="P23">Given the diversity of lymphocytes, we repeated the TooManyCells analysis with less restricted modularity pruning threshold (<xref rid="F5" ref-type="fig">Figures 5b</xref> and <xref rid="SD1" ref-type="supplementary-material">S31</xref>). Traversing further along the TooManyCells clustering hierarchy, T and B cells separated into more refined clusters (<xref rid="F5" ref-type="fig">Figure 5b</xref>). Interestingly, TooManyCells successfully separated CD4+ and CD8+ T cells (<xref rid="F5" ref-type="fig">Figures 5b</xref> and <xref rid="SD1" ref-type="supplementary-material">S32</xref>), and stratified more common marginal zone, germinal center and follicular B lymphocytes (<xref rid="F5" ref-type="fig">Figure 5c</xref>). Importantly, labeling of the splenic TooManyCells tree by B cell subtype signatures<sup><xref rid="R30" ref-type="bibr">30</xref></sup> identified two branches enriched for rare splenic<sup><xref rid="R14" ref-type="bibr">14</xref></sup> Igj-expressing plasma and plasmablasts B cells (<xref rid="F5" ref-type="fig">Figures 5b</xref>–<xref rid="F5" ref-type="fig">d</xref> and <xref rid="S10" ref-type="sec">Online Methods</xref>). Together, these analyses showed TooManyCells’ ability to stratify both rare and common cell types in mouse spleen and showcased TooManyCells-enabled multilayer exploration of single-cell clades <italic>de novo</italic>.</p>
      <p id="P24">To further assess the ability of popular methods to identify rare plasmablasts in mouse spleen, we used Seurat to generate t-SNE plots and cluster splenocytes. Overlaying cells in the t-SNE projection with their respective leaves from the TooManyCells tree (<xref rid="SD1" ref-type="supplementary-material">Figure S16</xref>) showed that for the most part cells nearby in the tree were nearby in the t-SNE projection (<xref rid="F5" ref-type="fig">Figure 5e</xref>). However, there were some discrepancies where cells farther apart in the tree were proximal on the t-SNE plot (e.g. mixing of green and pink labeled cells on the top-right of the t-SNE plot). Overlaying the B cell subtypes as defined by TooManyCells and validated by B cell subtype signatures (<xref rid="F5" ref-type="fig">Figures 5c</xref> and <xref rid="F5" ref-type="fig">5d</xref>) onto the t-SNE coordinates failed to visually separate plasmablasts from other B cell subtypes (<xref rid="F5" ref-type="fig">Figure 5f</xref>). Furthermore, default Seurat clustering was unable to identify the distinct cluster of rare splenic plasmablasts (<xref rid="F5" ref-type="fig">Figure 5g</xref>). Together, these results further support the advantage of TooManyCells’ visualization and clustering over widely used algorithms in guiding simultaneous detection of rare and common splenocyte subpopulations.</p>
    </sec>
    <sec id="S7">
      <title>Different GSI treatment regimens lead to distinct drug-resistant T-ALL populations.</title>
      <p id="P25">T-cell acute lymphoblastic leukemia (T-ALL) is an aggressive malignancy in children and adults<sup><xref rid="R31" ref-type="bibr">31</xref>,<xref rid="R32" ref-type="bibr">32</xref></sup>. Identification of Notch as the most frequently mutated gene in T-ALL led to clinical testing of gamma-secretase inhibitor (GSI), a targeted Notch signaling antagonist<sup><xref rid="R33" ref-type="bibr">33</xref></sup>. However, GSI-resistance development may limit its clinical efficacy<sup><xref rid="R34" ref-type="bibr">34</xref></sup>. We generated new scRNA-seq data and used TooManyCells to investigate the effect of GSI on individual resistant DND-41 T-ALL cells that were selected under two distinct treatment regimens. Ascending-dose GSI-resistant cells (referred to as ascending resistant) were selected by gradually doubling the GSI dose from ∼200% to 1,600% of the DND-41 IC<sub>50</sub>, while sustained high-dose GSI-resistant cells (referred to as sustained resistant) were selected by a prolonged treatment with ~1,600% of the IC<sub>50</sub> (<xref rid="F6" ref-type="fig">Figures 6a</xref> and <xref rid="SD1" ref-type="supplementary-material">33a</xref>). Transcriptomes of ~10,000 DND-41 cells from ascending resistant, sustained resistant, untreated parental, and short-term (24 hours) GSI-treated parental populations were profiled.</p>
      <p id="P26">The TooManyCells tree of these four populations showed mixing of untreated and short-term treated parental cells and the heterogeneity of response to GSI in genetically homogeneous DND-41 parental cells (<xref rid="F6" ref-type="fig">Figure 6b</xref>), which was not due to technical biases (<xref rid="SD1" ref-type="supplementary-material">Figure S33b</xref> and independent bulk RNA-seq (data not shown)). While the sustained resistant population occupied a distinct part of the tree (<xref rid="F6" ref-type="fig">Figure 6b</xref>), the ascending resistant cells showed markedly diverse gene expression profiles (<xref rid="F6" ref-type="fig">Figure 6b</xref>) and were significantly more heterogeneous (<xref rid="SD1" ref-type="supplementary-material">Figure S33c</xref>, <italic>p</italic> = 0.0140). Visualizing and quantifying relationships among the populations further showed that ascending resistant cells partially resembled both sustained resistant and parental cells (<xref rid="F6" ref-type="fig">Figures 6b</xref> and <xref rid="SD1" ref-type="supplementary-material">33d</xref>). TooManyCells revealed that ~40% of the ascending resistant cells were transcriptionally similar to the parental cells (<xref rid="F6" ref-type="fig">Figure 6b</xref>) and the remaining ascending resistant cells were more closely related to the sustained resistant population. Nevertheless, the expressions of several genes in this group of ascending resistant cells, including proto-oncogene <italic>MYC</italic> and anti-apoptotic gene <italic>ATF5</italic><sup><xref rid="R35" ref-type="bibr">35</xref>–<xref rid="R39" ref-type="bibr">39</xref></sup>, were significantly different from the sustained resistant population (<xref rid="F6" ref-type="fig">Figures 6c</xref>, <xref rid="F6" ref-type="fig">6d</xref>, <xref rid="SD1" ref-type="supplementary-material">S33e</xref>, <xref rid="SD1" ref-type="supplementary-material">S33f</xref>, and <xref rid="SD2" ref-type="supplementary-material">Table S1</xref>). Together, these single-cell resolution analyses identified a subpopulation of ascending resistant cells that, despite similarities with their sustained resistant counterparts, evolved differently to acquire GSI resistance and exhibited significantly lower expression of pro-survival genes — potentially enabling gradual adaptation to elevated GSI.</p>
    </sec>
    <sec id="S8">
      <title>TooManyCells identifies a rare GSI-resistant-like subpopulation.</title>
      <p id="P27">To investigate the underpinning GSI-resistance mechanisms, we next focused on the sustained resistant cells (<xref rid="F6" ref-type="fig">Figure 6e</xref>), which were more distinct from the parental cells (<xref rid="F6" ref-type="fig">Figures 6b</xref> and <xref rid="SD1" ref-type="supplementary-material">S33d</xref>). GSI treatment equally blunted expression of Notch and its known targets in drug-responsive and sustained resistant cells (<xref rid="SD1" ref-type="supplementary-material">Figures S33f</xref>–<xref rid="SD1" ref-type="supplementary-material">j</xref> and <xref rid="SD3" ref-type="supplementary-material">Tables S2</xref> and <xref rid="SD4" ref-type="supplementary-material">S3</xref>). By contrast, while short-term GSI treatment significantly reduced expression of <italic>MYC</italic> and its known targets in most of the parental cells (<xref rid="SD1" ref-type="supplementary-material">Figures S33f</xref> and <xref rid="SD1" ref-type="supplementary-material">S33i</xref>), it had no significant effect on their expression in the sustained resistant cells (<xref rid="SD1" ref-type="supplementary-material">Figures S33f</xref> and <xref rid="SD1" ref-type="supplementary-material">S33j</xref>). Together, these data imply that Notch-independent elevated <italic>MYC</italic> expression contributes to high GSI dosage tolerance.</p>
      <p id="P28">To further test this hypothesis, we compared individual resistant and parental cells. Interestingly, this single-cell resolution analysis revealed a rare (&lt; 1%) parental subpopulation that was transcriptionally similar to sustained resistant cells and localized at their encompassing subtree (<xref rid="F6" ref-type="fig">Figure 6e</xref>).This rare resistant-like subpopulation showed markedly elevated <italic>MYC</italic> levels compared to the other parental cells (<xref rid="F6" ref-type="fig">Figures 6f</xref> and <xref rid="F6" ref-type="fig">6g</xref>, 2.85 fold change, <italic>p</italic> = 4.01 × 10<sup>−8</sup>). Furthermore, Gene Set Enrichment Analysis (GSEA)<sup><xref rid="R40" ref-type="bibr">40</xref></sup> showed that known <italic>MYC</italic> targets<sup><xref rid="R41" ref-type="bibr">41</xref></sup> were the most differentially expressed pathways in the rare resistant-like cells compared to both other parental (<xref rid="SD1" ref-type="supplementary-material">Figure S33k</xref>, <xref rid="SD5" ref-type="supplementary-material">Table S4</xref>) and sustained resistant cells (<xref rid="SD1" ref-type="supplementary-material">Figure S33l</xref>, <xref rid="SD6" ref-type="supplementary-material">Table S5</xref>). Single-molecule RNA fluorescence in situ hybridization (FISH) analysis independently showed the prevalence and rarity of high <italic>MYC</italic> levels in sustained resistant and parental DND-41 cells, respectively (<xref rid="F6" ref-type="fig">Figure 6h</xref>, <xref rid="SD7" ref-type="supplementary-material">Table S6</xref>).</p>
      <p id="P29">Having verified the existence of high <italic>MYC</italic>-expressing resistant-like cells, we sought to find this rare parental subpopulation using other algorithms to compare against TooManyCells. These analyses showed that both t-SNE projection (<xref rid="F6" ref-type="fig">Figure 6i</xref>) and Seurat clustering (<xref rid="F6" ref-type="fig">Figure 6j</xref>) were unable to visually and algorithmically stratify this rare resistant-like subpopulation from the rest of the parental cells (<xref rid="SD1" ref-type="supplementary-material">Figure S33m</xref>). Together, these analyses demonstrate the unique ability of TooManyCells to guide discovery of a rare DND-41 subpopulation that could potentially tolerate high GSI doses, and hint at underpinning resistance mechanisms.</p>
    </sec>
  </sec>
  <sec id="S9">
    <title>Discussion</title>
    <p id="P30">Popular single-cell clustering and visualization methods have been firmly set in variations of single-resolution clustering and projection-based visualization algorithms. While these methods are inherently useful for single-cell analysis, they may be unsuitable for certain applications as demonstrated in this study. Here, we developed TooManyCells which provides complementary algorithms for clustering and visualization. TooManyCells uses a recursive technique to repeatedly identify subpopulations whose relationships are maintained in a tree. Compared to projection-based algorithms, the TooManyCells visualization model is fundamentally different and, in conjunction with an array of visualization features, enables a flexible platform for cell state stratification, exploration, and rare population detection. In addition to clustering and visualization, TooManyCells also provides other capabilities including, but not limited, to heterogeneity assessment, clumpiness measurement, and diversity and rarefaction statistics. In addition to synthetic data, the superior performance of TooManyCells to simultaneously identify rare and common cell populations was demonstrated in three independent contexts. In controlled settings, TooManyCells not only separated the two rare cell populations from an admixture of common and rare cells, but successfully sequestered the two rare populations from each other. Applying TooManyCells to cell lineage identification showed its ability to isolate rare plasmablasts from total mouse splenocytes, while a popular single-cell tool and visualization failed to do so. Lastly, TooManyCells was able to detect a resistant-like subclone in DND-41 cells with exceptionally high <italic>MYC</italic> levels that was separately verified by single-molecule RNA FISH and could potentially tolerate high doses of Notch inhibitor GSI, leading to the development of drug resistance in Notch-mutated T-ALL.</p>
    <p id="P31">In addition to performance, scalability, and usability, we considered flexibility and versatility in the TooManyCells design. TooManyCells is a generic framework consist of several algorithms that may be interchanged with other existing algorithms. The TooManyCells clustering and visualization modules, ClusterTree and BirchBeer respectively, can be potentially used for analysis of other single-cell genomic or observation-feature data. Together, our studies suggest that further improvement of clustering and visualization techniques are warranted to fully explore outputs of various single-cell measurement technologies. TooManyCells is a step in that direction.</p>
  </sec>
  <sec id="S10">
    <title>Online Methods</title>
    <sec id="S11">
      <title>Clustering</title>
      <p id="P32">TooManyCells implements a generalized adaptation of a matrix-free hierarchical spectral clustering process originally proposed for text mining<sup><xref rid="R42" ref-type="bibr">42</xref></sup>. Spectral clustering using normalized cuts is a technique to partition data into groups, or clusters, where the items within a cluster are more similar to each other than they are to items in other clusters<sup><xref rid="R43" ref-type="bibr">43</xref></sup>. This analysis is based on the pairwise similarity between items, leading to a computational complexity of <italic>O</italic>(<italic>m</italic><sup>2</sup>) with <italic>m</italic> items<sup><xref rid="R42" ref-type="bibr">42</xref></sup>. Let <bold>A</bold> be a similarity matrix where <bold>A</bold>(<italic>i</italic>, <italic>j</italic>) represents the similarity between items <italic>i</italic> and <italic>j</italic> and <bold>D</bold> = diag(<bold>A1</bold>) be the diagonal matrix where <bold>1</bold> is a column vector of 1’s. Then</p>
      <disp-formula id="FD1">
        <mml:math display="block" id="M1">
          <mml:mrow>
            <mml:mi>ℒ</mml:mi>
            <mml:mo stretchy="false">(</mml:mo>
            <mml:mstyle mathvariant="bold" mathsize="normal">
              <mml:mi>A</mml:mi>
            </mml:mstyle>
            <mml:mo stretchy="false">)</mml:mo>
            <mml:mo>=</mml:mo>
            <mml:mstyle mathvariant="bold" mathsize="normal">
              <mml:mi>I</mml:mi>
            </mml:mstyle>
            <mml:mo>−</mml:mo>
            <mml:msup>
              <mml:mstyle mathvariant="bold" mathsize="normal">
                <mml:mi>D</mml:mi>
              </mml:mstyle>
              <mml:mrow>
                <mml:mo>−</mml:mo>
                <mml:mn>1</mml:mn>
                <mml:mo>/</mml:mo>
                <mml:mn>2</mml:mn>
              </mml:mrow>
            </mml:msup>
            <mml:mstyle mathvariant="bold" mathsize="normal">
              <mml:mi>A</mml:mi>
            </mml:mstyle>
            <mml:msup>
              <mml:mstyle mathvariant="bold" mathsize="normal">
                <mml:mi>D</mml:mi>
              </mml:mstyle>
              <mml:mrow>
                <mml:mo>−</mml:mo>
                <mml:mn>1</mml:mn>
                <mml:mo>/</mml:mo>
                <mml:mn>2</mml:mn>
              </mml:mrow>
            </mml:msup>
          </mml:mrow>
        </mml:math>
      </disp-formula>
      <p id="P33">defines the normalized Laplacian of <bold>A</bold>. A partition into two clusters denoted by 0 and 1 labels can be defined as</p>
      <disp-formula id="FD2">
        <mml:math display="block" id="M2">
          <mml:mrow>
            <mml:mi>C</mml:mi>
            <mml:mo stretchy="false">(</mml:mo>
            <mml:mi>i</mml:mi>
            <mml:mo stretchy="false">)</mml:mo>
            <mml:mo>=</mml:mo>
            <mml:mrow>
              <mml:mo>{</mml:mo>
              <mml:mrow>
                <mml:mtable columnalign="left">
                  <mml:mtr columnalign="left">
                    <mml:mtd columnalign="left">
                      <mml:mrow>
                        <mml:mn>1</mml:mn>
                        <mml:mo>,</mml:mo>
                      </mml:mrow>
                    </mml:mtd>
                    <mml:mtd columnalign="left">
                      <mml:mrow>
                        <mml:mstyle mathvariant="bold" mathsize="normal">
                          <mml:mi>V</mml:mi>
                        </mml:mstyle>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mi>i</mml:mi>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo>≥</mml:mo>
                        <mml:mn>0</mml:mn>
                      </mml:mrow>
                    </mml:mtd>
                  </mml:mtr>
                  <mml:mtr columnalign="left">
                    <mml:mtd columnalign="left">
                      <mml:mrow>
                        <mml:mn>0</mml:mn>
                        <mml:mo>,</mml:mo>
                      </mml:mrow>
                    </mml:mtd>
                    <mml:mtd columnalign="left">
                      <mml:mrow>
                        <mml:mstyle mathvariant="bold" mathsize="normal">
                          <mml:mi>V</mml:mi>
                        </mml:mstyle>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mi>i</mml:mi>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo>&lt;</mml:mo>
                        <mml:mn>0</mml:mn>
                      </mml:mrow>
                    </mml:mtd>
                  </mml:mtr>
                </mml:mtable>
              </mml:mrow>
            </mml:mrow>
            <mml:mo>,</mml:mo>
          </mml:mrow>
        </mml:math>
      </disp-formula>
      <p id="P34">where <bold>V</bold> is the eigenvector corresponding to the second smallest eigenvalue of ℒ(<bold>A</bold>)<sup><xref rid="R43" ref-type="bibr">43</xref></sup>. Alternatively, the eigenvector corresponding to the second largest eigenvalue of the shifted Laplacian,</p>
      <disp-formula id="FD3">
        <mml:math display="block" id="M3">
          <mml:mrow>
            <mml:mover accent="true">
              <mml:mi>ℒ</mml:mi>
              <mml:mo stretchy="true">^</mml:mo>
            </mml:mover>
            <mml:mo stretchy="false">(</mml:mo>
            <mml:mstyle mathvariant="bold" mathsize="normal">
              <mml:mi>A</mml:mi>
            </mml:mstyle>
            <mml:mo stretchy="false">)</mml:mo>
            <mml:mo>=</mml:mo>
            <mml:mstyle mathvariant="bold" mathsize="normal">
              <mml:mi>I</mml:mi>
            </mml:mstyle>
            <mml:mo>+</mml:mo>
            <mml:msup>
              <mml:mstyle mathvariant="bold" mathsize="normal">
                <mml:mi>D</mml:mi>
              </mml:mstyle>
              <mml:mrow>
                <mml:mo>−</mml:mo>
                <mml:mn>1</mml:mn>
                <mml:mo>/</mml:mo>
                <mml:mn>2</mml:mn>
              </mml:mrow>
            </mml:msup>
            <mml:mstyle mathvariant="bold" mathsize="normal">
              <mml:mi>A</mml:mi>
            </mml:mstyle>
            <mml:msup>
              <mml:mstyle mathvariant="bold" mathsize="normal">
                <mml:mi>D</mml:mi>
              </mml:mstyle>
              <mml:mrow>
                <mml:mo>−</mml:mo>
                <mml:mn>1</mml:mn>
                <mml:mo>/</mml:mo>
                <mml:mn>2</mml:mn>
              </mml:mrow>
            </mml:msup>
          </mml:mrow>
        </mml:math>
      </disp-formula>
      <p id="P35">can be used instead of the second smallest eigenvalue of the Laplacian matrix. While this process bipartitions the data into two clusters, its inefficiency in both time and space makes the algorithm impractical for recurrent clustering of a large number of single cells. To improve the speed of spectral clustering while retaining the original accuracy, TooManyCells implements a generalized version of an algorithm that was originally proposed for text mining<sup><xref rid="R42" ref-type="bibr">42</xref></sup> and can be used with sparse scRNA-seq matrices or any other observation / feature matrix. This implementation explicitly circumvents calculating <bold>A</bold> and the complete singular vector decomposition (SVD) of <italic>ℒ</italic>(<bold>A</bold>).</p>
      <p id="P36">To this end, let <bold>B</bold><sub>1</sub> be an <italic>m</italic> × <italic>n</italic> matrix with <italic>m</italic> rows of cells and <italic>n</italic> columns of read counts. TooManyCells takes as input a transpose of this matrix to conform to the current single-cell matrix file format standards where the cells are columns. By default, TooManyCells offers the option to remove columns (genes) with no reads and rows (cells) with &lt; 250 read counts. Then, for all 1 ≤ <italic>i</italic> ≤ <italic>m</italic>, 1 ≤ <italic>j</italic> ≤ <italic>n</italic>,</p>
      <disp-formula id="FD4">
        <mml:math display="block" id="M4">
          <mml:mrow>
            <mml:msub>
              <mml:mstyle mathvariant="bold" mathsize="normal">
                <mml:mi>B</mml:mi>
              </mml:mstyle>
              <mml:mn>2</mml:mn>
            </mml:msub>
            <mml:mo>=</mml:mo>
            <mml:mi>log</mml:mi>
            <mml:mrow>
              <mml:mo>(</mml:mo>
              <mml:mrow>
                <mml:mi>m</mml:mi>
                <mml:mo>/</mml:mo>
                <mml:msub>
                  <mml:mi>d</mml:mi>
                  <mml:mi>j</mml:mi>
                </mml:msub>
              </mml:mrow>
              <mml:mo>)</mml:mo>
            </mml:mrow>
            <mml:msub>
              <mml:mstyle mathvariant="bold" mathsize="normal">
                <mml:mi>B</mml:mi>
              </mml:mstyle>
              <mml:mn>1</mml:mn>
            </mml:msub>
            <mml:mo stretchy="false">(</mml:mo>
            <mml:mi>i</mml:mi>
            <mml:mo>,</mml:mo>
            <mml:mi>j</mml:mi>
            <mml:mo stretchy="false">)</mml:mo>
            <mml:mo>,</mml:mo>
          </mml:mrow>
        </mml:math>
      </disp-formula>
      <p id="P37">where <inline-formula><mml:math display="inline" id="M5"><mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>m</mml:mi></mml:msubsup><mml:mi>δ</mml:mi></mml:mstyle><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>B</mml:mi></mml:mstyle><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> and <italic>δ</italic>(<italic>x</italic>) is 1 if <italic>x</italic> ≥ 1 and 0 if <italic>x</italic> = 0, for all <inline-formula><mml:math display="inline" id="M6"><mml:mrow><mml:mi>x</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mi>ℤ</mml:mi><mml:mo>+</mml:mo></mml:msup><mml:mo>.</mml:mo></mml:mrow></mml:math></inline-formula> This normalization transforms <bold>B</bold><sub>1</sub> into a term frequency-inverse document frequency (tf-idf) matrix <bold>B</bold><sub>2</sub><sup><xref rid="R44" ref-type="bibr">44</xref>,<xref rid="R45" ref-type="bibr">45</xref></sup>, where the importance of common genes is de-emphasized for clustering. Intuitively, a ubiquitously expressed gene is unlikely to be as important for cell clustering compared to a gene only expressed in a given subpopulation. Other data normalizations can be performed prior to this transformation or replace the tf-idf process entirely. For instance, one may normalize each cell based on its total read count followed by the normalization of each gene by that gene’s median positive read count. In order to relate cells in a matrix-free manner, cosine similarity was used<sup><xref rid="R46" ref-type="bibr">46</xref></sup>. It has been shown<sup><xref rid="R42" ref-type="bibr">42</xref></sup> that the similarity matrix <bold>A</bold> can be derived from <bold>B</bold><sub>2</sub> with</p>
      <disp-formula id="FD5">
        <mml:math display="block" id="M7">
          <mml:mrow>
            <mml:mstyle mathvariant="bold" mathsize="normal">
              <mml:mi>A</mml:mi>
            </mml:mstyle>
            <mml:mo stretchy="false">(</mml:mo>
            <mml:mi>i</mml:mi>
            <mml:mo>,</mml:mo>
            <mml:mi>j</mml:mi>
            <mml:mo stretchy="false">)</mml:mo>
            <mml:mo>=</mml:mo>
            <mml:mfrac>
              <mml:mrow>
                <mml:mstyle displaystyle="true">
                  <mml:msubsup>
                    <mml:mo>∑</mml:mo>
                    <mml:mrow>
                      <mml:mi>k</mml:mi>
                      <mml:mo>=</mml:mo>
                      <mml:mn>1</mml:mn>
                    </mml:mrow>
                    <mml:mi>n</mml:mi>
                  </mml:msubsup>
                  <mml:mrow>
                    <mml:msub>
                      <mml:mstyle mathvariant="bold" mathsize="normal">
                        <mml:mi>B</mml:mi>
                      </mml:mstyle>
                      <mml:mn>2</mml:mn>
                    </mml:msub>
                  </mml:mrow>
                </mml:mstyle>
                <mml:mo stretchy="false">(</mml:mo>
                <mml:mi>i</mml:mi>
                <mml:mo>,</mml:mo>
                <mml:mi>k</mml:mi>
                <mml:mo stretchy="false">)</mml:mo>
                <mml:msub>
                  <mml:mstyle mathvariant="bold" mathsize="normal">
                    <mml:mi>B</mml:mi>
                  </mml:mstyle>
                  <mml:mn>2</mml:mn>
                </mml:msub>
                <mml:mo stretchy="false">(</mml:mo>
                <mml:mi>j</mml:mi>
                <mml:mo>,</mml:mo>
                <mml:mi>k</mml:mi>
                <mml:mo stretchy="false">)</mml:mo>
              </mml:mrow>
              <mml:mrow>
                <mml:msqrt>
                  <mml:mrow>
                    <mml:mstyle displaystyle="true">
                      <mml:msubsup>
                        <mml:mo>∑</mml:mo>
                        <mml:mrow>
                          <mml:mi>k</mml:mi>
                          <mml:mo>=</mml:mo>
                          <mml:mn>1</mml:mn>
                        </mml:mrow>
                        <mml:mi>n</mml:mi>
                      </mml:msubsup>
                      <mml:mrow>
                        <mml:msubsup>
                          <mml:mstyle mathvariant="bold" mathsize="normal">
                            <mml:mi>B</mml:mi>
                          </mml:mstyle>
                          <mml:mn>2</mml:mn>
                          <mml:mn>2</mml:mn>
                        </mml:msubsup>
                      </mml:mrow>
                    </mml:mstyle>
                    <mml:mo stretchy="false">(</mml:mo>
                    <mml:mi>i</mml:mi>
                    <mml:mo>,</mml:mo>
                    <mml:mi>k</mml:mi>
                    <mml:mo stretchy="false">)</mml:mo>
                  </mml:mrow>
                </mml:msqrt>
                <mml:msqrt>
                  <mml:mrow>
                    <mml:mstyle displaystyle="true">
                      <mml:msubsup>
                        <mml:mo>∑</mml:mo>
                        <mml:mrow>
                          <mml:mi>k</mml:mi>
                          <mml:mo>=</mml:mo>
                          <mml:mn>1</mml:mn>
                        </mml:mrow>
                        <mml:mi>n</mml:mi>
                      </mml:msubsup>
                      <mml:mrow>
                        <mml:msubsup>
                          <mml:mstyle mathvariant="bold" mathsize="normal">
                            <mml:mi>B</mml:mi>
                          </mml:mstyle>
                          <mml:mn>2</mml:mn>
                          <mml:mn>2</mml:mn>
                        </mml:msubsup>
                      </mml:mrow>
                    </mml:mstyle>
                    <mml:mo stretchy="false">(</mml:mo>
                    <mml:mi>j</mml:mi>
                    <mml:mo>,</mml:mo>
                    <mml:mi>k</mml:mi>
                    <mml:mo stretchy="false">)</mml:mo>
                  </mml:mrow>
                </mml:msqrt>
              </mml:mrow>
            </mml:mfrac>
            <mml:mo>.</mml:mo>
          </mml:mrow>
        </mml:math>
      </disp-formula>
      <p id="P38">However, in order to lower the computational complexity, TooManyCells does not calculate this matrix. Instead, a new matrix <bold>B</bold> is defined as</p>
      <disp-formula id="FD6">
        <mml:math display="block" id="M8">
          <mml:mrow>
            <mml:mstyle mathvariant="bold" mathsize="normal">
              <mml:mi>B</mml:mi>
            </mml:mstyle>
            <mml:mo stretchy="false">(</mml:mo>
            <mml:mi>i</mml:mi>
            <mml:mo>,</mml:mo>
            <mml:mi>j</mml:mi>
            <mml:mo stretchy="false">)</mml:mo>
            <mml:mo>=</mml:mo>
            <mml:msubsup>
              <mml:mi>e</mml:mi>
              <mml:mi>i</mml:mi>
              <mml:mrow>
                <mml:mo>−</mml:mo>
                <mml:mn>1</mml:mn>
              </mml:mrow>
            </mml:msubsup>
            <mml:msub>
              <mml:mstyle mathvariant="bold" mathsize="normal">
                <mml:mi>B</mml:mi>
              </mml:mstyle>
              <mml:mn>2</mml:mn>
            </mml:msub>
            <mml:mo stretchy="false">(</mml:mo>
            <mml:mi>i</mml:mi>
            <mml:mo>,</mml:mo>
            <mml:mi>j</mml:mi>
            <mml:mo stretchy="false">)</mml:mo>
            <mml:mo>,</mml:mo>
          </mml:mrow>
        </mml:math>
      </disp-formula>
      <p id="P39">where <inline-formula><mml:math display="inline" id="M9"><mml:mrow><mml:msub><mml:mi>e</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msqrt><mml:mrow><mml:mstyle displaystyle="true"><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>n</mml:mi></mml:msubsup><mml:mrow><mml:msubsup><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>B</mml:mi></mml:mstyle><mml:mn>2</mml:mn><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msqrt></mml:mrow></mml:math></inline-formula> is the Euclidean norm of <bold>B</bold><sub>2</sub> row <italic>i</italic>.</p>
      <p id="P40">To prepare the matrix as a form of a normalized Laplacian, let</p>
      <disp-formula id="FD7">
        <mml:math display="block" id="M10">
          <mml:mrow>
            <mml:mstyle mathvariant="bold" mathsize="normal">
              <mml:mi>D</mml:mi>
            </mml:mstyle>
            <mml:mo>=</mml:mo>
            <mml:mi>diag</mml:mi>
            <mml:mrow>
              <mml:mo>(</mml:mo>
              <mml:mrow>
                <mml:mstyle mathvariant="bold" mathsize="normal">
                  <mml:mi>B</mml:mi>
                </mml:mstyle>
                <mml:mrow>
                  <mml:mo>(</mml:mo>
                  <mml:mrow>
                    <mml:msup>
                      <mml:mstyle mathvariant="bold" mathsize="normal">
                        <mml:mi>B</mml:mi>
                      </mml:mstyle>
                      <mml:mi>T</mml:mi>
                    </mml:msup>
                    <mml:mstyle mathvariant="bold" mathsize="normal">
                      <mml:mn>1</mml:mn>
                    </mml:mstyle>
                  </mml:mrow>
                  <mml:mo>)</mml:mo>
                </mml:mrow>
              </mml:mrow>
              <mml:mo>)</mml:mo>
            </mml:mrow>
          </mml:mrow>
        </mml:math>
      </disp-formula>
      <p id="P41">and</p>
      <disp-formula id="FD8">
        <mml:math display="block" id="M11">
          <mml:mrow>
            <mml:mstyle mathvariant="bold" mathsize="normal">
              <mml:mi>C</mml:mi>
            </mml:mstyle>
            <mml:mo>=</mml:mo>
            <mml:msup>
              <mml:mstyle mathvariant="bold" mathsize="normal">
                <mml:mi>D</mml:mi>
              </mml:mstyle>
              <mml:mrow>
                <mml:mo>−</mml:mo>
                <mml:mn>1</mml:mn>
                <mml:mo>/</mml:mo>
                <mml:mn>2</mml:mn>
              </mml:mrow>
            </mml:msup>
            <mml:mstyle mathvariant="bold" mathsize="normal">
              <mml:mi>B</mml:mi>
            </mml:mstyle>
            <mml:mo>.</mml:mo>
          </mml:mrow>
        </mml:math>
      </disp-formula>
      <p id="P42">Then the eigenvector of <italic>ℒ</italic>(<bold>A</bold>) corresponding to the second smallest eigenvalue is the second left singular vector corresponding to the second largest singular value of <bold>C</bold>, which can be found using truncated SVD<sup><xref rid="R42" ref-type="bibr">42</xref></sup>. It has been shown that the computation complexity of this process is <italic>O</italic>(<italic>Jm</italic>), the number of non-zero entries of <bold>C</bold>, where <italic>J</italic> is the average number of expressed genes within a cell. This bipartition can be recursively applied to each delineated cluster until a stopping criteria is reached, which results in a divisive hierarchical cluster structure.</p>
      <p id="P43">In accordance with the original implementation<sup><xref rid="R42" ref-type="bibr">42</xref></sup>, TooManyCells uses Newman-Girvan modularity (<italic>Q</italic>)<sup><xref rid="R19" ref-type="bibr">19</xref></sup> as a stopping criteria. Modularity is a measure from community detection which has also been used in single-cell clustering through optimization using the Louvain method<sup><xref rid="R6" ref-type="bibr">6</xref>,<xref rid="R7" ref-type="bibr">7</xref>,<xref rid="R21" ref-type="bibr">21</xref></sup>. Let <italic>G</italic> = (<italic>V</italic>, <italic>E</italic>) be a weighted graph of <italic>m</italic> nodes (cells) with <italic>e</italic> edges. Then, as <bold>A</bold> represents the connectivity strength among nodes, Newman-Girvan modularity measures the strength of the partition of nodes. For a bipartition,</p>
      <disp-formula id="FD9">
        <mml:math display="block" id="M12">
          <mml:mrow>
            <mml:mi>Q</mml:mi>
            <mml:mrow>
              <mml:mo>(</mml:mo>
              <mml:mrow>
                <mml:msub>
                  <mml:mi>C</mml:mi>
                  <mml:mn>1</mml:mn>
                </mml:msub>
                <mml:mo>,</mml:mo>
                <mml:msub>
                  <mml:mi>C</mml:mi>
                  <mml:mn>2</mml:mn>
                </mml:msub>
              </mml:mrow>
              <mml:mo>)</mml:mo>
            </mml:mrow>
            <mml:mo>=</mml:mo>
            <mml:mstyle displaystyle="true">
              <mml:munderover>
                <mml:mo>∑</mml:mo>
                <mml:mrow>
                  <mml:mi>k</mml:mi>
                  <mml:mo>=</mml:mo>
                  <mml:mn>1</mml:mn>
                </mml:mrow>
                <mml:mn>2</mml:mn>
              </mml:munderover>
              <mml:mrow>
                <mml:mrow>
                  <mml:mo>(</mml:mo>
                  <mml:mrow>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:msub>
                          <mml:mi>O</mml:mi>
                          <mml:mrow>
                            <mml:mi>k</mml:mi>
                            <mml:mi>k</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                      </mml:mrow>
                      <mml:mi>L</mml:mi>
                    </mml:mfrac>
                    <mml:mo>−</mml:mo>
                    <mml:msup>
                      <mml:mrow>
                        <mml:mrow>
                          <mml:mo>(</mml:mo>
                          <mml:mrow>
                            <mml:mfrac>
                              <mml:mrow>
                                <mml:msub>
                                  <mml:mi>L</mml:mi>
                                  <mml:mi>k</mml:mi>
                                </mml:msub>
                              </mml:mrow>
                              <mml:mi>L</mml:mi>
                            </mml:mfrac>
                          </mml:mrow>
                          <mml:mo>)</mml:mo>
                        </mml:mrow>
                      </mml:mrow>
                      <mml:mn>2</mml:mn>
                    </mml:msup>
                  </mml:mrow>
                  <mml:mo>)</mml:mo>
                </mml:mrow>
              </mml:mrow>
            </mml:mstyle>
            <mml:mo>,</mml:mo>
          </mml:mrow>
        </mml:math>
      </disp-formula>
      <p id="P44">where <inline-formula><mml:math display="inline" id="M13"><mml:mrow><mml:msub><mml:mi>O</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>j</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>A</mml:mi></mml:mstyle></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> is the total degree of nodes in cluster <italic>C</italic><sub><italic>k</italic></sub>, if <inline-formula><mml:math display="inline" id="M14"><mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>m</mml:mi></mml:msubsup><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>A</mml:mi></mml:mstyle></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> is the degree of node <italic>i</italic> then <inline-formula><mml:math display="inline" id="M15"><mml:mrow><mml:msub><mml:mi>L</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mstyle></mml:mrow></mml:math></inline-formula> is the total degree of nodes in <italic>C</italic><sub><italic>k</italic></sub>, and <inline-formula><mml:math display="inline" id="M16"><mml:mrow><mml:mi>L</mml:mi><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>m</mml:mi></mml:msubsup><mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mstyle></mml:mrow></mml:math></inline-formula> is the degree of all nodes in the network. <italic>Q</italic> measures the distance of edges within clusters to the random distribution of clusters, such that <italic>Q</italic> &gt; 0 denotes non-random communities and <italic>Q</italic> ≤ 0 demonstrates communities randomly found<sup><xref rid="R19" ref-type="bibr">19</xref>,<xref rid="R42" ref-type="bibr">42</xref></sup>.</p>
      <p id="P45">TooManyCells uses <italic>Q</italic> to assess a candidate bipartition of cells to determine whether to continue the recursion or stop as a leaf in the divisive hierarchical clustering. That is, at each bipartion, if <italic>Q</italic> &gt; 0 then continue the recursion, otherwise stop. Thus, the end result of this top-down clustering is a tree structure of clusters, where each inner node is a cluster and the leaves are the most fine-grain clusters where any additional splitting would lead to random partitioning of cells. This process has <italic>O</italic>(<italic>Jm</italic> log <italic>m</italic>) computational complexity<sup><xref rid="R42" ref-type="bibr">42</xref></sup>. The code for the TooManyCells implementation of this algorithm is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/faryabib/too-many-cells">https://github.com/faryabib/too-many-cells</ext-link>.</p>
    </sec>
  </sec>
  <sec id="S12">
    <title>Visualization</title>
    <p id="P46">The TooManyCells clustering algorithm results in a tree structure, where each inner node is a coarse cluster and each leaf is the most refined cluster per modularity measure. The BirchBeer rendering method was developed for displaying single-cell cluster hierarchies. To this end, BirchBeer utilizes graphviz for node coordinate placement and the Haskell diagrams library as rendering engine.</p>
    <p id="P47">BirchBeer provides a multitude of graphical features to assist in the detection and interpretation of cell clusters. The tree leaves can be displayed in various ways. Single-cell resolution exploration is facilitated by drawing color-coded individual cells at the tree leaves. Alternatively, a pie chart can be shown to visualize a summary of the cell composition of the clusters at the tree leaves. Both single-cell resolution and statistical summarization can be shown using a “pie ring”. Each tree branch can be scaled to the relative number of cells within each subtree, allowing for quick inspection of cell population sizes of various clustering levels and visualizing clusters of rare and common populations. Furthermore, colors can be applied to each branch such that the weighted average blend of the colors of each label in the subtree is used, allowing for immediate detection of subtrees with large differences or similarities. Cluster numbers can be displayed on each node, tracing the data back into a human readable interpretation of differences between the clusters at various hierarchy levels. Furthermore, the modularity of each candidate split can be displayed at each node as a black circle with varying darkness to demonstrate the dissimilarity of cell populations encompassing that assay. Large trees may result in busy figures, much like large t-SNE plots, so options to prune the tree are available. Cutting the tree at certain levels, node sizes, or modularity are some options, but additionally there is a statistically driven option called --smart-cutoff which cuts the tree depending on the median absolute deviation (MAD). For instance, a stopping criteria of four MADs from the median node size to keep the structure of the tree but prune smaller branches. BirchBeer accepts JSON trees as a standard input. The code for BirchBeer is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/faryabib/birch-beer">https://github.com/faryabib/birch-beer</ext-link>.</p>
  </sec>
  <sec id="S13">
    <title>Differential expression</title>
    <p id="P48">Given multiple cluster identification numbers, TooManyCells can perform differential expression analysis to identify the difference between the gene expression of cells in these clusters. TooManyCells interfaces with edgeR for differential expression analysis<sup><xref rid="R47" ref-type="bibr">47</xref></sup>. Cells were processed using the recommended edgeR settings for single-cell analysis: genes with at least 1 count per million (cpm) in at least two cells were kept, normalized with calcNormFactors, and analyzed with estimateDisp, glmFit, and glmLRT respectively. To visually facilitate this analysis, BirchBeer can label clusters with their identification numbers. All the presented differential expression analyses and statistics use this feature of TooManyCells.</p>
  </sec>
  <sec id="S14">
    <title>Diversity analysis</title>
    <p id="P49">While Shannon entropy is frequently used as a measure of “diversity”, the effective number of species is a more meaningful measure of diversity in biological settings. For example, a population with 16 equally abundant species should be twice as diverse as a population with 8 equally abundant species. Assuming each cell is an “organism” belonging to a “species” group defined by the clustering algorithm, then a diversity index can be applied to find the effective number of cell states in a population.</p>
    <p id="P50">The diversity satisfying such a property can be defined as<sup><xref rid="R48" ref-type="bibr">48</xref></sup></p>
    <disp-formula id="FD10">
      <label>(1)</label>
      <mml:math display="block" id="M17">
        <mml:mrow>
          <mml:msup>
            <mml:mrow/>
            <mml:mi>q</mml:mi>
          </mml:msup>
          <mml:mi>D</mml:mi>
          <mml:mo>=</mml:mo>
          <mml:msup>
            <mml:mrow>
              <mml:mrow>
                <mml:mo>(</mml:mo>
                <mml:mrow>
                  <mml:mstyle displaystyle="true">
                    <mml:munderover>
                      <mml:mo>∑</mml:mo>
                      <mml:mrow>
                        <mml:mi>i</mml:mi>
                        <mml:mo>=</mml:mo>
                        <mml:mn>1</mml:mn>
                      </mml:mrow>
                      <mml:mi>R</mml:mi>
                    </mml:munderover>
                    <mml:mrow>
                      <mml:msubsup>
                        <mml:mi>p</mml:mi>
                        <mml:mi>i</mml:mi>
                        <mml:mi>q</mml:mi>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mstyle>
                </mml:mrow>
                <mml:mo>)</mml:mo>
              </mml:mrow>
            </mml:mrow>
            <mml:mrow>
              <mml:mo stretchy="false">(</mml:mo>
              <mml:mn>1</mml:mn>
              <mml:mo>/</mml:mo>
              <mml:mo stretchy="false">(</mml:mo>
              <mml:mn>1</mml:mn>
              <mml:mo>−</mml:mo>
              <mml:mi>q</mml:mi>
              <mml:mo stretchy="false">)</mml:mo>
              <mml:mo stretchy="false">)</mml:mo>
            </mml:mrow>
          </mml:msup>
          <mml:mo>,</mml:mo>
        </mml:mrow>
      </mml:math>
    </disp-formula>
    <p id="P51">where <italic>p</italic><sub><italic>i</italic></sub> is the frequency of species <italic>i</italic>, <italic>R</italic> is the total number of species in the population, and <italic>q</italic> is the “order” of diversity. <italic>q</italic> &gt; 1 gives additional weight towards common species, while more weight is given to rare species when <italic>q</italic> &lt; 1. <italic>q</italic> = 1 gives equal weight to all the species regardless of their commonality and is defined as</p>
    <disp-formula id="FD11">
      <mml:math display="block" id="M18">
        <mml:mrow>
          <mml:msup>
            <mml:mrow/>
            <mml:mn>1</mml:mn>
          </mml:msup>
          <mml:mi>D</mml:mi>
          <mml:mo>=</mml:mo>
          <mml:mi>exp</mml:mi>
          <mml:mrow>
            <mml:mo>(</mml:mo>
            <mml:mrow>
              <mml:mo>−</mml:mo>
              <mml:mstyle displaystyle="true">
                <mml:munderover>
                  <mml:mo>∑</mml:mo>
                  <mml:mrow>
                    <mml:mi>i</mml:mi>
                    <mml:mo>=</mml:mo>
                    <mml:mn>1</mml:mn>
                  </mml:mrow>
                  <mml:mi>R</mml:mi>
                </mml:munderover>
                <mml:mrow>
                  <mml:msub>
                    <mml:mi>p</mml:mi>
                    <mml:mi>i</mml:mi>
                  </mml:msub>
                </mml:mrow>
              </mml:mstyle>
              <mml:mi>ln</mml:mi>
              <mml:msub>
                <mml:mi>p</mml:mi>
                <mml:mi>i</mml:mi>
              </mml:msub>
            </mml:mrow>
            <mml:mo>)</mml:mo>
          </mml:mrow>
          <mml:mo>.</mml:mo>
        </mml:mrow>
      </mml:math>
    </disp-formula>
    <p id="P52">Several diversity measures can be derived from <xref rid="FD10" ref-type="disp-formula">equation (1)</xref> For instance, <sup>0</sup><italic>D</italic> defines richness, or the number of species, in the population. <sup>1</sup><italic>D</italic> relates to exp (Shannon entropy) and <sup>2</sup><italic>D</italic> is the inverse of the Simpson index. Various diversity measures have been used previously in domains such as lymphocyte receptor repertoires and cell clones<sup><xref rid="R49" ref-type="bibr">49</xref>–<xref rid="R51" ref-type="bibr">51</xref></sup>. Here, we use the diversity in TooManyCells to quantitate the effective number of cell states within a population.</p>
    <p id="P53">TooManyCells implements the concept of rarefaction curve from ecology<sup><xref rid="R52" ref-type="bibr">52</xref></sup> to estimate the number of detectable species in a given number of profiled single cells. Briefly, the estimated number of species in a population can be calculated from a given number of samples taken from a population through random subsampling. The estimated number of species in a subsample of size <italic>n</italic> representing <italic>X</italic><sub><italic>n</italic></sub> species can be calculated as</p>
    <disp-formula id="FD12">
      <label>(2)</label>
      <mml:math display="block" id="M19">
        <mml:mrow>
          <mml:mi>E</mml:mi>
          <mml:mrow>
            <mml:mo>[</mml:mo>
            <mml:mrow>
              <mml:msub>
                <mml:mi>X</mml:mi>
                <mml:mi>n</mml:mi>
              </mml:msub>
            </mml:mrow>
            <mml:mo>]</mml:mo>
          </mml:mrow>
          <mml:mo>=</mml:mo>
          <mml:mi>R</mml:mi>
          <mml:mo>−</mml:mo>
          <mml:msup>
            <mml:mrow>
              <mml:mrow>
                <mml:mo>(</mml:mo>
                <mml:mrow>
                  <mml:mtable>
                    <mml:mtr>
                      <mml:mtd>
                        <mml:mi>N</mml:mi>
                      </mml:mtd>
                    </mml:mtr>
                    <mml:mtr>
                      <mml:mtd>
                        <mml:mi>n</mml:mi>
                      </mml:mtd>
                    </mml:mtr>
                  </mml:mtable>
                </mml:mrow>
                <mml:mo>)</mml:mo>
              </mml:mrow>
            </mml:mrow>
            <mml:mrow>
              <mml:mo>−</mml:mo>
              <mml:mn>1</mml:mn>
            </mml:mrow>
          </mml:msup>
          <mml:mstyle displaystyle="true">
            <mml:munderover>
              <mml:mo>∑</mml:mo>
              <mml:mrow>
                <mml:mi>i</mml:mi>
                <mml:mo>=</mml:mo>
                <mml:mn>1</mml:mn>
              </mml:mrow>
              <mml:mi>R</mml:mi>
            </mml:munderover>
            <mml:mrow>
              <mml:mrow>
                <mml:mo>(</mml:mo>
                <mml:mrow>
                  <mml:mtable>
                    <mml:mtr>
                      <mml:mtd>
                        <mml:mrow>
                          <mml:mi>N</mml:mi>
                          <mml:mo>−</mml:mo>
                          <mml:msub>
                            <mml:mi>N</mml:mi>
                            <mml:mi>i</mml:mi>
                          </mml:msub>
                        </mml:mrow>
                      </mml:mtd>
                    </mml:mtr>
                    <mml:mtr>
                      <mml:mtd>
                        <mml:mi>n</mml:mi>
                      </mml:mtd>
                    </mml:mtr>
                  </mml:mtable>
                </mml:mrow>
                <mml:mo>)</mml:mo>
              </mml:mrow>
            </mml:mrow>
          </mml:mstyle>
          <mml:mo>,</mml:mo>
        </mml:mrow>
      </mml:math>
    </disp-formula>
    <p id="P54">where <italic>N</italic> is the total number of cells, <italic>R</italic> is the total number of cell states in all samples, and <italic>N</italic><sub><italic>i</italic></sub> is the number of cells belonging to state <italic>i</italic>. For the interval [0, <italic>R</italic>], <xref rid="FD12" ref-type="disp-formula">equation (2)</xref> generates a rarefaction curve that shows the estimated number of species for a given number of profiled cells. The steepness of the rarefaction curve may represent the heterogeneity of a population. For a given number of subsamples, the estimated number of species across multiple populations can be compared based on their respective rarefaction curves. This property is useful for comparing populations with different sample sizes. A plateau in the curves indicates no substantial increase in the number of new cell states, implying a sufficient sampling to observe all the cell states in a sample. TooManyCells implements this procedure to rarefy populations.</p>
  </sec>
  <sec id="S15">
    <title>Cluster purity</title>
    <p id="P55">To compare the accuracy of clustering algorithms, we used measures that quantify the extent of clustering output “purity”. We considered cluster output “purity” measures since they mitigate lack of information about markers accurately defining “true” cell identity. Moreover, these measures are robust to cluster size variability. For instance, FACS-purified CD4+ cells lack the resolution to accurately define “ground truth” cell types, as these cells comprised of several functionally well-characterized subtypes (e.g. various Th1, Th2, Th17, Treg, and many more CD4+ T cell types). To assess cluster “purity”, three measures were used: purity, entropy, and normalized mutual information (NMI). All three measures are commonly used in scRNA-seq comparative analysis<sup><xref rid="R53" ref-type="bibr">53</xref>–<xref rid="R55" ref-type="bibr">55</xref></sup>.</p>
    <p id="P56">Purity is based on the frequency of the most abundant class (e.g. cell type) in a cluster. Let Ω = {<italic>ω</italic><sub>1</sub>, <italic>ω</italic><sub>2</sub>, . . . , <italic>ω</italic><sub><italic>K</italic></sub>} be the set of clusters and <inline-formula><mml:math display="inline" id="M20"><mml:mrow><mml:mi>ℂ</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:msub><mml:mi>c</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>c</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mi>c</mml:mi><mml:mi>J</mml:mi></mml:msub></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> be the set of classes. Then purity is defined as</p>
    <disp-formula id="FD13">
      <mml:math display="block" id="M21">
        <mml:mrow>
          <mml:mtext> purity </mml:mtext>
          <mml:mo stretchy="false">(</mml:mo>
          <mml:mtext>Ω</mml:mtext>
          <mml:mo>,</mml:mo>
          <mml:mi>ℂ</mml:mi>
          <mml:mo stretchy="false">)</mml:mo>
          <mml:mo>=</mml:mo>
          <mml:mfrac>
            <mml:mn>1</mml:mn>
            <mml:mi>N</mml:mi>
          </mml:mfrac>
          <mml:mstyle displaystyle="true">
            <mml:munder>
              <mml:mo>∑</mml:mo>
              <mml:mi>k</mml:mi>
            </mml:munder>
            <mml:mrow>
              <mml:munder>
                <mml:mrow>
                  <mml:mi>max</mml:mi>
                </mml:mrow>
                <mml:mi>j</mml:mi>
              </mml:munder>
            </mml:mrow>
          </mml:mstyle>
          <mml:mrow>
            <mml:mo>|</mml:mo>
            <mml:mrow>
              <mml:msub>
                <mml:mi>ω</mml:mi>
                <mml:mi>k</mml:mi>
              </mml:msub>
              <mml:mo>∩</mml:mo>
              <mml:msub>
                <mml:mi>c</mml:mi>
                <mml:mi>j</mml:mi>
              </mml:msub>
            </mml:mrow>
            <mml:mo>|</mml:mo>
          </mml:mrow>
          <mml:mo>,</mml:mo>
        </mml:mrow>
      </mml:math>
    </disp-formula>
    <p id="P57">where <italic>N</italic> is the total number of cells, <italic>ω</italic><sub><italic>k</italic></sub> is the set of cells in cluster <italic>k</italic>, and <italic>c</italic><sub><italic>j</italic></sub> is the set of cells in class <italic>j</italic><sup><xref rid="R45" ref-type="bibr">45</xref></sup>. This measure ranges from 0, poor clustering, to 1, perfect clustering.</p>
    <p id="P58">Entropy as a measure of cluster accuracy uses Shannon entropy to measure the expected amount of information from the clusters. The entropy of each cluster <italic>k</italic> is defined by</p>
    <disp-formula id="FD14">
      <mml:math display="block" id="M22">
        <mml:mrow>
          <mml:mi>H</mml:mi>
          <mml:mrow>
            <mml:mo>(</mml:mo>
            <mml:mrow>
              <mml:msub>
                <mml:mi>ω</mml:mi>
                <mml:mi>k</mml:mi>
              </mml:msub>
            </mml:mrow>
            <mml:mo>)</mml:mo>
          </mml:mrow>
          <mml:mo>=</mml:mo>
          <mml:mstyle displaystyle="true">
            <mml:munder>
              <mml:mo>∑</mml:mo>
              <mml:mi>j</mml:mi>
            </mml:munder>
            <mml:mrow>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mo>|</mml:mo>
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>ω</mml:mi>
                        <mml:mrow>
                          <mml:mi>k</mml:mi>
                          <mml:mi>j</mml:mi>
                        </mml:mrow>
                      </mml:msub>
                    </mml:mrow>
                    <mml:mo>|</mml:mo>
                  </mml:mrow>
                </mml:mrow>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mo>|</mml:mo>
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>ω</mml:mi>
                        <mml:mi>k</mml:mi>
                      </mml:msub>
                    </mml:mrow>
                    <mml:mo>|</mml:mo>
                  </mml:mrow>
                </mml:mrow>
              </mml:mfrac>
            </mml:mrow>
          </mml:mstyle>
          <mml:mi>log</mml:mi>
          <mml:mfrac>
            <mml:mrow>
              <mml:mrow>
                <mml:mo>|</mml:mo>
                <mml:mrow>
                  <mml:msub>
                    <mml:mi>ω</mml:mi>
                    <mml:mrow>
                      <mml:mi>k</mml:mi>
                      <mml:mi>j</mml:mi>
                    </mml:mrow>
                  </mml:msub>
                </mml:mrow>
                <mml:mo>|</mml:mo>
              </mml:mrow>
            </mml:mrow>
            <mml:mrow>
              <mml:mrow>
                <mml:mo>|</mml:mo>
                <mml:mrow>
                  <mml:msub>
                    <mml:mi>ω</mml:mi>
                    <mml:mi>k</mml:mi>
                  </mml:msub>
                </mml:mrow>
                <mml:mo>|</mml:mo>
              </mml:mrow>
            </mml:mrow>
          </mml:mfrac>
          <mml:mo>,</mml:mo>
        </mml:mrow>
      </mml:math>
    </disp-formula>
    <p id="P59">where <italic>ω</italic><sub><italic>kj</italic></sub> is the set of cells from <italic>ω</italic><sub><italic>k</italic></sub> ∩ <italic>c</italic><sub><italic>j</italic></sub>. Then the entropy for the entire clustering is<sup><xref rid="R56" ref-type="bibr">56</xref></sup></p>
    <disp-formula id="FD15">
      <mml:math display="block" id="M23">
        <mml:mrow>
          <mml:mtext> entropy </mml:mtext>
          <mml:mo stretchy="false">(</mml:mo>
          <mml:mtext>Ω</mml:mtext>
          <mml:mo>,</mml:mo>
          <mml:mi>ℂ</mml:mi>
          <mml:mo stretchy="false">)</mml:mo>
          <mml:mo>=</mml:mo>
          <mml:mstyle displaystyle="true">
            <mml:munder>
              <mml:mo>∑</mml:mo>
              <mml:mi>k</mml:mi>
            </mml:munder>
            <mml:mrow>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mo>|</mml:mo>
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>ω</mml:mi>
                        <mml:mi>k</mml:mi>
                      </mml:msub>
                    </mml:mrow>
                    <mml:mo>|</mml:mo>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>N</mml:mi>
              </mml:mfrac>
            </mml:mrow>
          </mml:mstyle>
          <mml:mi>H</mml:mi>
          <mml:mrow>
            <mml:mo>(</mml:mo>
            <mml:mrow>
              <mml:msub>
                <mml:mi>ω</mml:mi>
                <mml:mi>k</mml:mi>
              </mml:msub>
            </mml:mrow>
            <mml:mo>)</mml:mo>
          </mml:mrow>
          <mml:mo>.</mml:mo>
        </mml:mrow>
      </mml:math>
    </disp-formula>
    <p id="P60">Here, lower entropy of a clustering indicates higher accuracy.</p>
    <p id="P61">Normalized mutual information (NMI) measures the normalized dependency of the class labels on the cluster labels, or the amount of information about the class labels gained when the cluster labels are given. Mutual information is defined by</p>
    <disp-formula id="FD16">
      <mml:math display="block" id="M24">
        <mml:mrow>
          <mml:mi>I</mml:mi>
          <mml:mo stretchy="false">(</mml:mo>
          <mml:mtext>Ω</mml:mtext>
          <mml:mo>;</mml:mo>
          <mml:mi>ℂ</mml:mi>
          <mml:mo stretchy="false">)</mml:mo>
          <mml:mo>=</mml:mo>
          <mml:mstyle displaystyle="true">
            <mml:munder>
              <mml:mo>∑</mml:mo>
              <mml:mi>k</mml:mi>
            </mml:munder>
            <mml:mrow>
              <mml:mstyle displaystyle="true">
                <mml:munder>
                  <mml:mo>∑</mml:mo>
                  <mml:mi>j</mml:mi>
                </mml:munder>
                <mml:mrow>
                  <mml:mfrac>
                    <mml:mrow>
                      <mml:mrow>
                        <mml:mo>|</mml:mo>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mi>ω</mml:mi>
                            <mml:mi>k</mml:mi>
                          </mml:msub>
                          <mml:mo>∩</mml:mo>
                          <mml:msub>
                            <mml:mi>c</mml:mi>
                            <mml:mi>j</mml:mi>
                          </mml:msub>
                        </mml:mrow>
                        <mml:mo>|</mml:mo>
                      </mml:mrow>
                    </mml:mrow>
                    <mml:mi>N</mml:mi>
                  </mml:mfrac>
                </mml:mrow>
              </mml:mstyle>
            </mml:mrow>
          </mml:mstyle>
          <mml:mi>log</mml:mi>
          <mml:mfrac>
            <mml:mrow>
              <mml:mi>N</mml:mi>
              <mml:mrow>
                <mml:mo>|</mml:mo>
                <mml:mrow>
                  <mml:msub>
                    <mml:mi>ω</mml:mi>
                    <mml:mi>k</mml:mi>
                  </mml:msub>
                  <mml:mo>∩</mml:mo>
                  <mml:msub>
                    <mml:mi>c</mml:mi>
                    <mml:mi>j</mml:mi>
                  </mml:msub>
                </mml:mrow>
                <mml:mo>|</mml:mo>
              </mml:mrow>
            </mml:mrow>
            <mml:mrow>
              <mml:mrow>
                <mml:mo>|</mml:mo>
                <mml:mrow>
                  <mml:msub>
                    <mml:mi>ω</mml:mi>
                    <mml:mi>k</mml:mi>
                  </mml:msub>
                </mml:mrow>
                <mml:mo>|</mml:mo>
              </mml:mrow>
              <mml:mrow>
                <mml:mo>|</mml:mo>
                <mml:mrow>
                  <mml:msub>
                    <mml:mi>c</mml:mi>
                    <mml:mi>j</mml:mi>
                  </mml:msub>
                </mml:mrow>
                <mml:mo>|</mml:mo>
              </mml:mrow>
            </mml:mrow>
          </mml:mfrac>
          <mml:mo>.</mml:mo>
        </mml:mrow>
      </mml:math>
    </disp-formula>
    <p id="P62">To compare mutual information across clusterings, <italic>I</italic>(Ω; <inline-formula><mml:math display="inline" id="M25"><mml:mi>ℂ</mml:mi></mml:math></inline-formula> ) is normalized to the interval [0, 1]. As <italic>I</italic>(Ω; <inline-formula><mml:math display="inline" id="M26"><mml:mi>ℂ</mml:mi></mml:math></inline-formula>) is bounded by min[<italic>H</italic>(Ω), <italic>H</italic>(<inline-formula><mml:math display="inline" id="M27"><mml:mi>ℂ</mml:mi></mml:math></inline-formula>)], where</p>
    <disp-formula id="FD17">
      <mml:math display="block" id="M28">
        <mml:mrow>
          <mml:mi>H</mml:mi>
          <mml:mo stretchy="false">(</mml:mo>
          <mml:mtext>Ω</mml:mtext>
          <mml:mo stretchy="false">)</mml:mo>
          <mml:mo>=</mml:mo>
          <mml:mo>−</mml:mo>
          <mml:mstyle displaystyle="true">
            <mml:munder>
              <mml:mo>∑</mml:mo>
              <mml:mi>k</mml:mi>
            </mml:munder>
            <mml:mrow>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mo>|</mml:mo>
                    <mml:mrow>
                      <mml:msub>
                        <mml:mi>ω</mml:mi>
                        <mml:mi>k</mml:mi>
                      </mml:msub>
                    </mml:mrow>
                    <mml:mo>|</mml:mo>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>N</mml:mi>
              </mml:mfrac>
            </mml:mrow>
          </mml:mstyle>
          <mml:mi>log</mml:mi>
          <mml:mfrac>
            <mml:mrow>
              <mml:mrow>
                <mml:mo>|</mml:mo>
                <mml:mrow>
                  <mml:msub>
                    <mml:mi>ω</mml:mi>
                    <mml:mi>k</mml:mi>
                  </mml:msub>
                </mml:mrow>
                <mml:mo>|</mml:mo>
              </mml:mrow>
            </mml:mrow>
            <mml:mi>N</mml:mi>
          </mml:mfrac>
        </mml:mrow>
      </mml:math>
    </disp-formula>
    <p id="P63">is the entropy of Ω along with the analogous <italic>H</italic>(<inline-formula><mml:math display="inline" id="M29"><mml:mi>ℂ</mml:mi></mml:math></inline-formula>), total normalization NMI can be defined by</p>
    <disp-formula id="FD18">
      <mml:math display="block" id="M30">
        <mml:mrow>
          <mml:mtext>NMI</mml:mtext>
          <mml:mo stretchy="false">(</mml:mo>
          <mml:mtext>Ω</mml:mtext>
          <mml:mo>,</mml:mo>
          <mml:mi>ℂ</mml:mi>
          <mml:mo stretchy="false">)</mml:mo>
          <mml:mo>=</mml:mo>
          <mml:mfrac>
            <mml:mrow>
              <mml:mi>I</mml:mi>
              <mml:mo stretchy="false">(</mml:mo>
              <mml:mtext>Ω</mml:mtext>
              <mml:mo>;</mml:mo>
              <mml:mi>ℂ</mml:mi>
              <mml:mo stretchy="false">)</mml:mo>
            </mml:mrow>
            <mml:mrow>
              <mml:mi>min</mml:mi>
              <mml:mo stretchy="false">[</mml:mo>
              <mml:mi>H</mml:mi>
              <mml:mo stretchy="false">(</mml:mo>
              <mml:mtext>Ω</mml:mtext>
              <mml:mo stretchy="false">)</mml:mo>
              <mml:mo>,</mml:mo>
              <mml:mi>H</mml:mi>
              <mml:mo stretchy="false">(</mml:mo>
              <mml:mi>ℂ</mml:mi>
              <mml:mo stretchy="false">)</mml:mo>
              <mml:mo stretchy="false">]</mml:mo>
            </mml:mrow>
          </mml:mfrac>
          <mml:mo>,</mml:mo>
        </mml:mrow>
      </mml:math>
    </disp-formula>
    <p id="P64">where higher values indicate more accurate clustering based on <inline-formula><mml:math display="inline" id="M31"><mml:mi>ℂ</mml:mi></mml:math></inline-formula><sup><xref rid="R57" ref-type="bibr">57</xref></sup>.</p>
    <p id="P65">For <italic>Tabula Muris</italic>, four data sets were generated based on organ admixture complexity: either the first 3, first 6, first 9, or all 11 organs were considered from thymus, spleen, bone marrow, limb muscle, tongue, heart, lung, mammary gland, bladder, kidney, and liver. Other data sets were not subsampled as the complexity was lower or controlled.</p>
    <p id="P66">Each algorithm was run on each data set with default or suggested settings. Suggested settings: for Monocle, densityPeak method was used. For Seurat, Louvain clustering after <italic>K</italic>-nearest neighbor graph construction was used with 10 dimensions from PCA (as in the PBMC3k vignette, which was followed as the recommended Seurat processes). More lenient filtering thresholds from the <italic>Tabula Muris</italic> Organ Annotation Vignette were used for data sets with fewer cells. For BackSPIN, the number of levels was set to 4, as shown in the documentation.</p>
  </sec>
  <sec id="S16">
    <title>Rare population benchmark</title>
    <p id="P67">Rare population detection was determined by the ability of algorithms to separate two known rare populations from each other. Three cell types were considered for one common and two rare cell populations. As T cells cells were dissimilar from both macrophage and dendritic cells (<xref rid="SD1" ref-type="supplementary-material">Figure S19</xref>), T cells were chosen as the common population with macrophages and dendritic cells as the rare populations, all from mouse spleen. To benchmark clustering accuracy in separating rare cells, we also performed two additional experiments based on mixings cells from different mouse organs: 1) tongue (common), mammary (rare), and bone marrow (rare); 2) bladder (common), heart (rare), and tongue (rare). Likewise for the immune population data set: CD4+ T (common), CD14+ monocytes (rare), CD19+ B (rare) cells were used<sup><xref rid="R23" ref-type="bibr">23</xref></sup>. 100 data sets of 1,000 cells were generated by randomly subsampling from each cell type or organ. These 1,000 cells per data set ranged from 900 to 990 common cells and 100 to 10 rare cells (e.g. half macrophages and half dendritic cells), with ten runs each. For instance, the smallest common data set was comprised of 900 common cells (90%) and 100 rare cells (10%, 5% for each rare population). The largest common data set was comprised of 990 common cells (99%) and 10 rare cells (1%, 0.5% for each rare population). All algorithms were run on these data sets with default or suggested settings in the same fashion as in the cluster purity benchmark. These results were visualized using t-SNE for each package (Monocle: reduceDimension with t-SNE method, Phenograph: TSNE from scikit-learn which is not included in Phenograph, BackSPIN: TSNE from scikit-learn which is not included in BackSPIN, Seurat: RunTSNE with dim.use of 10 dimensions, CIDR: Rtsne from Rtsne which is not included in CIDR, RaceID: comptsne, and Cell Ranger: output t-SNE projections). UMAP visualization was calculated with the umap-learn python package. TooManyCells output was visualized using BirchBeer trees and given rare population priority with --smart-cutoff 5 --min-distance-search 1.</p>
    <p id="P68">To quantify these benchmarks, a contingency table of the fraction of pairwise labels was used. For all rare cell pairs, a true pair was called if the two cells were of the same cell type (e.g. a macrophage with another macrophage or a dendritic cell with another dendritic cell), while a false pair was called if the two cells were of different cell types (e.g. a macrophage with a dendritic cell). Then, the measure for accuracy in this benchmark was the fraction of true pairs in all pairs.</p>
    <p id="P69">For the simulated rare population benchmark, Splatter<sup><xref rid="R58" ref-type="bibr">58</xref></sup> with default settings was used to generate data sets of 1,000 cells in three groups, identical in composition to the previous subsampled rare population benchmark. Here, TooManyCells was run with --pca 50 (in concordance with Seurat) to account for the synthetic nature of the Splatter model, and --min-modularity −0.05 to accommodate the PCA transformation. BackSPIN, RaceID, and Phenograph did not use dimensionality reduction by default, as with TooManyCells, so additional benchmarks were run with dimensionality reduction through the TooManyCells PCA matrix for BackSPIN and Phenograph (which do not have any function for reduction in their libraries), and CCcorrect for RaceID.</p>
  </sec>
  <sec id="S17">
    <title>Timing benchmark</title>
    <p id="P70">1,000 cells were used to benchmark clustering algorithm times in order to accommodate RaceID, CIDR, and BackSPIN, which did not finish on larger data sets from the purity benchmark after 4 days. Each algorithm was run 10 times to determine an average runtime.</p>
  </sec>
  <sec id="S18">
    <title>Distribution-based pruning and stopping criteria</title>
    <p id="P71">TooManyCells can prune the tree by including a stopping criteria in a variety of ways, including specific nodes, the minimum size of a node (i.e. number of cells) , and the proportion of cells in each child node. To simultaneously identify both rare and common cell populations, TooManyCells uses modularity to guide the tree pruning. TooManyCells quantifies the distribution of modularity for all non-leaf nodes and chooses a value of modularity based on the specified number of median absolute deviations from the median (or a chosen value). The algorithm preserves all paths to all nodes of this value or greater, and cuts all levels below. This results in large nodes with low modularity in their descendents and small nodes with high modularity.</p>
  </sec>
  <sec id="S19">
    <title>Clumpiness</title>
    <p id="P72">The hierarchical structure generated from any hierarchical clustering, both divisive and agglomerative, holds cells in the leaf nodes. Each cell can be assigned a label, such as an organ of origin, cell type, or expression level of high or low. In order to quantify the level of aggregation within the tree, a measure of “clumpiness” is needed<sup><xref rid="R59" ref-type="bibr">59</xref></sup>. For instance, the degree of how “clumped”, or co-localized, are CD4 T cells and CD8 T cells within the tree. Here, one would expect those T cells to be grouped together more closely than CD4 T cells with B cells. A clumpiness measure enables the quantification of this similarity.</p>
    <p id="P73">The clumpiness measure used here was specifically designed for hierarchical structures and was previously described in more detail<sup><xref rid="R59" ref-type="bibr">59</xref></sup>. Briefly, consider a rooted <italic>k</italic>-ary tree. The clumpiness of the set of leaves <italic>M</italic> when partitioned according to <italic>L</italic> = {<italic>L</italic><sub>1</sub>, <italic>L</italic><sub>2</sub>, . . . , <italic>L</italic><sub><italic>n</italic></sub>} is defined as</p>
    <disp-formula id="FD19">
      <label>(3)</label>
      <mml:math display="block" id="M32">
        <mml:mrow>
          <mml:mi>C</mml:mi>
          <mml:mo stretchy="false">(</mml:mo>
          <mml:mi>L</mml:mi>
          <mml:mo stretchy="false">)</mml:mo>
          <mml:mo>=</mml:mo>
          <mml:mfrac>
            <mml:mn>1</mml:mn>
            <mml:mi>n</mml:mi>
          </mml:mfrac>
          <mml:msup>
            <mml:mrow>
              <mml:mrow>
                <mml:mo>(</mml:mo>
                <mml:mrow>
                  <mml:mstyle displaystyle="true">
                    <mml:munderover>
                      <mml:mo>∏</mml:mo>
                      <mml:mrow>
                        <mml:mi>i</mml:mi>
                        <mml:mo>=</mml:mo>
                        <mml:mn>1</mml:mn>
                      </mml:mrow>
                      <mml:mi>n</mml:mi>
                    </mml:munderover>
                    <mml:mrow>
                      <mml:mfrac>
                        <mml:mi>x</mml:mi>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mi>y</mml:mi>
                            <mml:mi>i</mml:mi>
                          </mml:msub>
                        </mml:mrow>
                      </mml:mfrac>
                    </mml:mrow>
                  </mml:mstyle>
                </mml:mrow>
                <mml:mo>)</mml:mo>
              </mml:mrow>
            </mml:mrow>
            <mml:mrow>
              <mml:mn>1</mml:mn>
              <mml:mo>/</mml:mo>
              <mml:mi>n</mml:mi>
            </mml:mrow>
          </mml:msup>
          <mml:mo>.</mml:mo>
        </mml:mrow>
      </mml:math>
    </disp-formula>
    <p id="P74">This measure takes the geometric mean of <italic>x</italic> weighted by <italic>y</italic><sub><italic>i</italic></sub>. <italic>x</italic> represents the weighted number (weighted by distance to the descendant leaves) of “viable” non-root inner nodes, and <italic>y</italic><sub><italic>i</italic></sub> is the frequency of leaves in <italic>L</italic><sub><italic>i</italic></sub> in all leaves not connected to the root node. Viable nodes are comprised of inner nodes that have at least one vertex of each label in their descendant leaves. The clumpiness of a label <italic>L</italic><sub><italic>i</italic></sub> with itself is simply considering an <italic>L</italic>ʹ containing two sets — leaves in <italic>L</italic><sub><italic>i</italic></sub> and all other leaves. Then the clumpiness of <italic>L</italic><sub><italic>i</italic></sub> with itself is 1 − <italic>C</italic>(<italic>L</italic>ʹ)<sup><xref rid="R59" ref-type="bibr">59</xref></sup>.</p>
  </sec>
  <sec id="S20">
    <title>Splenic cell markers</title>
    <p id="P75">Branches of the TooManyCells tree were defined in two ways. First, differential expression analysis was carried out for each node, and the following lineage markers were used to designate enriched cell type in each leaf node. Second, listed populations were classified using ImmGen: the top 100 differential genes in those nodes were used as input to ImmGen MyGeneSet in order to find enrichment for markers from the designated cell type<sup><xref rid="R30" ref-type="bibr">30</xref></sup>.</p>
    <table-wrap id="T1" position="anchor" orientation="portrait">
      <table frame="void" rules="none">
        <colgroup span="1">
          <col align="left" valign="middle" span="1"/>
          <col align="left" valign="middle" span="1"/>
        </colgroup>
        <thead>
          <tr>
            <th align="left" valign="top" rowspan="1" colspan="1">Cell type</th>
            <th align="left" valign="top" rowspan="1" colspan="1">Genes</th>
          </tr>
          <tr>
            <th colspan="2" align="left" valign="top" rowspan="1">
              <hr/>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td align="left" valign="top" rowspan="1" colspan="1">Plasma cell</td>
            <td align="left" valign="top" rowspan="1" colspan="1">
              <italic>Igj</italic>
            </td>
          </tr>
          <tr>
            <td align="left" valign="top" rowspan="1" colspan="1">Germinal center cell</td>
            <td align="left" valign="top" rowspan="1" colspan="1">Classified using ImmGen</td>
          </tr>
          <tr>
            <td align="left" valign="top" rowspan="1" colspan="1">Follicular cell</td>
            <td align="left" valign="top" rowspan="1" colspan="1">
              <italic>Fcer2a, Klf2</italic>
            </td>
          </tr>
          <tr>
            <td align="left" valign="top" rowspan="1" colspan="1">Marginal zone cell</td>
            <td align="left" valign="top" rowspan="1" colspan="1">
              <italic>Tcf4, Crebl2</italic>
            </td>
          </tr>
          <tr>
            <td align="left" valign="top" rowspan="1" colspan="1">Transitional cell</td>
            <td align="left" valign="top" rowspan="1" colspan="1">
              <italic>Gfi1, Myb, Uhrf1</italic>
            </td>
          </tr>
          <tr>
            <td align="left" valign="top" rowspan="1" colspan="1">Plasmablast</td>
            <td align="left" valign="top" rowspan="1" colspan="1">Classified using ImmGen</td>
          </tr>
        </tbody>
      </table>
    </table-wrap>
    <p id="P76">Lineage-specific transcription factors in addition to cell surface markers were used, since scRNA-seq can not differentiate between cytoplasmic and surface expression of markers.</p>
  </sec>
  <sec id="S21">
    <title>GSI-resistant T-ALL cell culture</title>
    <p id="P77">DND-41 cells (DSMZ, cat# ACC525) were purchased from the Leibniz-Institute DSMZ-German Collection of Microorganisms and Cell Lines. Cells were cultured in RPMI 1,640 (Corning, cat# 10–040-CM) supplemented with 10% fetal bovine serum (Thermo Fisher Scientific, cat# SH30070.03), 2 mM L-glutamine (Corning, cat# 25–005-CI), 100 U/mL and 100 μg mL<sup>−1</sup> penicillin/streptomycin (Corning, cat# 30–002-CI), 100 mM nonessential amino acids (Gibco, cat# 11140–050), 1 mM sodium pyruvate (Gibco, cat# 11360–070) and 0.1 mM of 2-mercaptoethanol (Sigma, cat# M6250). All cells were grown at 37 °C and 5% CO2 with media refreshed every 3–4 days. Cells were regularly tested for mycoplasma contamination.</p>
    <p id="P78">IC<sub>50</sub> values for gamma-secretase inhibitor (GSI) compound E (Calbiochem, cat# 565790) were calculated from dose-response curves using CellTiter Glo Luminescent Cell Viability Assay (Promega, cat# G7571). Briefly, 1,000 treatment-naïve DND-41 cells in 5 replicates/condition were plated in 96-well plates with vehicle or increasing concentrations of GSI (0.016, 0.031, 0.062, 0.125, 0.25, 0.5, 1, 2 μM). Luminescence was measured on day 7 with CellTiter Glo Luminescent Cell Viability Assay according to the manufacturer’s instructions. DND-41 IC<sub>50</sub> of GSI was determined to be 5 nM.</p>
    <p id="P79">To generate ascending GSI-resistant cells, DND-41 treatment-naïve cells were cultured in the presence of 10, 20, 40, 80, 125 nM GSI with concentration increasing every week for six weeks and maintained in 125 nM GSI. To generate sustained high-dose GSI-resistant cells, DND-41 treatment-naïve cells were cultured in the presence of 125 nM GSI for at least six weeks. The establishment of GSI-resistance was determined with IC<sub>50</sub> assay as described above. Both ascending and sustained high-dose GSI-resistant DND-41 cells can tolerate 10 μM GSI with less than 20% cell death. Short-term DMSO/GSI treatment was performed on treatment-naïve DND-41 cells with 125 nM DMSO/GSI for 24 hours.</p>
  </sec>
  <sec id="S22">
    <title>GSI-resistant T-ALL single-cell RNA sequencing</title>
    <p id="P80">Prior to single–cell transcriptomic profiling, cells were washed with 1 x PBS (Corning, cat# 21031CV) and stained with DAPI (Sigma-Aldrich, cat# D9542) and live cells were sorted on BD FACS Aria II using 100 μm nozzle. Cells were washed twice with RPMI, counted and single-cell RNA-seq was performed using 10X Genomics Single Cell 3’ Library and Gel Bead Kit v2 (10 x Genomics, cat# 1000092) following the manufacturer’s instruction. Briefly, cells were loaded onto independent channels of a Chromium Controller (10 x Genomics) for targeted recovery of 3,000 cells/condition. Complementary DNA was synthesized and amplified with PCR for 13 cycles. Amplified cDNA was assessed for QC and quantified on Agilent TapeStation using High sensitivity D5000 chip and subsequently used for library construction. Libraries were quantified using KAPA Library Quantification Kits for Illumina® platform (KAPA Biosystems, Roche, cat# KK4824) and pair-end sequenced on NextSeq 550 using 150 cycles High Output kit.</p>
    <p id="P81">FASTQ file generation and alignment to GRCh38 were performed using Cell Ranger v2.1.1 with default arguments. In total, 10,109 cells passed the Cell Ranger QC and showed the typical “knee” plots indicating high quality from untreated (2,340), short-term (2,618), ascending (2,734), and sustained high-dose (2,417). These cell were aggregated using Cell Ranger. The fraction of reads in cells was 94.1%. The total number of post-normalization reads was 786,185,264, with mean reads per cell at 66,768 and median genes per cell of 3,333. Multiplets were identified with Scrublet<sup><xref rid="R60" ref-type="bibr">60</xref></sup> and removed from the Cell Ranger filtered matrix, which was then used as input to TooManyCells or Seurat with default settings.</p>
  </sec>
  <sec id="S23">
    <title>RNA FISH</title>
    <p id="P82">Parental DND-41 cells treated with 125 nM DMSO or GSI and sustained GSI-resistant cells were harvested and resuspended in PBS at a concentration of 4.5 × 10<sup>6</sup> cells mL<sup>−1</sup>. 80 μL of the cells in each condition were added to the same polysine microscope slide (Thermo Scientific, cat# P4981) using silicone isolators (Electron Microscopy Sciences, cat# 7033905) and adhered to the slide for 30 min at room temperature in a humidified chamber. Cells were then fixed in 4% formaldehyde (Fisher Scientific, cat# PI28908) in 1xPBS for 10 min, and then dipped in 1xPBS. Cells were permeabilized in 0.5% Triton (Sigma-Aldrich Roche, cat# 10789704001) in 1xPBS for 15 min and dehydrated with an ethanol row of 70%, 80%, and 100% ethanol for 2 min each. Cells were washed in wash buffer containing 2X SSC, 10% formamide (Thermo Fisher, cat# 3442061L), in Nuclease-free water (Ambion, cat# AM9937) to remove remaining ethanol. 50 μL of hybridization mix (10% dextran sulfate, 10% formamide, 2X SSC) and 1 μL of RNA FISH probes against <italic>MYC</italic> (Alexa594) and <italic>GAPDH</italic> (Alexa 647) (gift from Dr. Arjun Raj) were added to a 24×50 coverslip, attached to the slide and sealed with no-wrinkle rubber cement (Elmer/s). Hybridization was performed overnight in a 37 °C humidified chamber. Rubber cement was removed and cells were washed for 30 min in wash buffer. Cells were then stained with 0.1 μg mL<sup>−1</sup> DAPI in 2XSSC for 15 min in a coplin jar with shaking. Slide was allowed to completely dry before mounting on coverslip with Slowfade Gold Antifade Reagent (Invitrogen, cat# S36936) and sealing with transparent nail polish.</p>
    <p id="P83">Imaging was carried out on a Nikon widefield fluorescent microscope (Nikon Ti-E with a 60xPlan-Apo objective) and <italic>z</italic> stack size of 10 μM with a <italic>z</italic> step size of 330 nM (Nikon Elements software). DAPI signal was used for manual nuclei segmentation and the number of <italic>MYC</italic> or <italic>GAPDH</italic> mRNA in each cell were determined as described in<sup><xref rid="R61" ref-type="bibr">61</xref></sup> (<ext-link ext-link-type="uri" xlink:href="https://bitbucket.org/arjunrajlaboratory/rajlabimagetools/wiki/Home">https://bitbucket.org/arjunrajlaboratory/rajlabimagetools/wiki/Home</ext-link>). 250, 261, and 222 DMSO-, GSI-treated parental and sustained resistant cells were analyzed, respectively. The number of <italic>MYC</italic> or <italic>GAPDH</italic> RNA FISH count were compared by t.test in R. Example images of DMSO-treated parental and sustained GSI-resistant cells were selected on the brightest <italic>z</italic> plane and adjusted in ImageJ such that the brightness of each channel is comparable across the two conditions.</p>
  </sec>
  <sec id="S24">
    <title>Reporting Summary</title>
    <p id="P84">Further information on research design is available in the Nature Life Sciences Reporting Summary linked to this article.</p>
  </sec>
  <sec sec-type="data-availability" id="S25">
    <title>Data availability</title>
    <p id="P85">The accession number for the new datasets reported in this paper is GEO: GSE138892. Microfluidics single-cell RNA-seq count data from 11 organs in 3 female and 4 male, C57BL/6 NIA, three-month-old mice were obtained from <ext-link ext-link-type="uri" xlink:href="https://figshare.com/articles/_/5715025">https://figshare.com/articles/_/5715025</ext-link>, removing P8 libraries due to outlier cell counts<sup><xref rid="R22" ref-type="bibr">22</xref></sup>. FACS-purified CD14+ monocytes, CD19+ B, and CD4+ T cells were obtained from <ext-link ext-link-type="uri" xlink:href="https://support.10xgenomics.com/single-cell-gene-expression/">https://support.10xgenomics.com/single-cell-gene-expression/datasets<sup><xref rid="R23" ref-type="bibr">23</xref></sup></ext-link>. Data for seven cancer cell lines were obtained from GSE81861<xref rid="R17" ref-type="bibr">17</xref>. FACS-purified B lymphocytes/natural killer, megakaryocyte-erythroid, and granulocyte–monocyte progenitors were obtained from GSE117498<xref rid="R25" ref-type="bibr">25</xref>.</p>
  </sec>
  <sec id="S26">
    <title>Code availability</title>
    <p id="P86">TooManyCells is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/faryabib/too-many-cells">https://github.com/faryabib/too-many-cells</ext-link> or as a Docker image <ext-link ext-link-type="uri" xlink:href="https://cloud.docker.com/repository/docker/gregoryschwartz/too-many-cells/">https://cloud.docker.com/repository/docker/gregoryschwartz/too-many-cells/</ext-link>. An R wrapper for TooManyCells is available at <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/web/packages/TooManyCellsR.BirchBeer">https://cran.r-project.org/web/packages/TooManyCellsR.BirchBeer</ext-link> is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/faryabib/birch-beer">https://github.com/faryabib/birch-beer</ext-link> or as a Docker image <ext-link ext-link-type="uri" xlink:href="https://cloud.docker.com/repository/docker/gregoryschwartz/birch-beer">https://cloud.docker.com/repository/docker/gregoryschwartz/birch-beer</ext-link>. Codes necessary to reproduce the presented analyses are available at <ext-link ext-link-type="uri" xlink:href="https://github.com/faryabib/NatMethods_TooManyCells_analysis">https://github.com/faryabib/NatMethods_TooManyCells_analysis</ext-link>.</p>
  </sec>
  <sec sec-type="supplementary-material" id="SM1">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="SD1">
      <label>1549979_SuppInfo</label>
      <media xlink:href="NIHMS1549979-supplement-1549979_SuppInfo.pdf" orientation="portrait" id="d39e3308" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD2">
      <label>1549979_TableS1</label>
      <media xlink:href="NIHMS1549979-supplement-1549979_TableS1.csv" orientation="portrait" id="d39e3312" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD3">
      <label>1549979_TableS2</label>
      <media xlink:href="NIHMS1549979-supplement-1549979_TableS2.csv" orientation="portrait" id="d39e3316" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD4">
      <label>1549979_TableS3</label>
      <media xlink:href="NIHMS1549979-supplement-1549979_TableS3.csv" orientation="portrait" id="d39e3320" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD5">
      <label>1549979_TableS4</label>
      <media xlink:href="NIHMS1549979-supplement-1549979_TableS4.csv" orientation="portrait" id="d39e3324" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD6">
      <label>1549979_TableS5</label>
      <media xlink:href="NIHMS1549979-supplement-1549979_TableS5.csv" orientation="portrait" id="d39e3328" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD7">
      <label>1549979_TableS6</label>
      <media xlink:href="NIHMS1549979-supplement-1549979_TableS6.xlsx" orientation="portrait" id="d39e3332" position="anchor"/>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack id="S27">
    <title>Acknowledgments</title>
    <p id="P87">This work was supported by T32-CA-009140 (to G.W.S.), LLS-5456–17 (to J.P.), R01-CA-215518 (to W.S.P.), R01-HL-145754, the Penn Epigenetics pilot award, and the Sloan Foundation Grant (to G.V.), Therapeutics Translational Medicine and Therapeutics program for Transdisciplinary Awards Program in Translational Medicine and Therapeutics, Concern Foundation’s The Conquer Cancer Now Award, Susan G. Komen CCR185472448, and R01-CA-230800 (to R.B.F.).</p>
  </ack>
  <fn-group>
    <fn id="FN2">
      <p id="P88">Competing Interests</p>
      <p id="P89">The authors declare no competing interests.</p>
    </fn>
  </fn-group>
  <ref-list>
    <title>References</title>
    <ref id="R1">
      <label>1.</label>
      <mixed-citation publication-type="journal"><name><surname>Lafzi</surname><given-names>A</given-names></name>, <name><surname>Moutinho</surname><given-names>C</given-names></name>, <name><surname>Picelli</surname><given-names>S</given-names></name>. &amp; <name><surname>Heyn</surname><given-names>H</given-names></name>. <article-title>Tutorial: Guidelines for the Experimental Design of Single-Cell RNA Sequencing Studies</article-title>. <source>Nat. Protoc</source>
<volume>13</volume>, <fpage>2742</fpage> (<year>2018</year>).<pub-id pub-id-type="pmid">30446749</pub-id></mixed-citation>
    </ref>
    <ref id="R2">
      <label>2.</label>
      <mixed-citation publication-type="journal"><name><surname>Trapnell</surname><given-names>C</given-names></name>. <article-title>Defining Cell Types and States with Single-Cell Genomics</article-title>. <source>Genome Res</source>. <volume>25</volume>, <fpage>1491</fpage>–<lpage>1498</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">26430159</pub-id></mixed-citation>
    </ref>
    <ref id="R3">
      <label>3.</label>
      <mixed-citation publication-type="journal"><name><surname>Packer</surname><given-names>J</given-names></name>. &amp; <name><surname>Trapnell</surname><given-names>C</given-names></name>. <article-title>Single-Cell Multi-Omics: An Engine for New Quantitative Models of Gene Regulation</article-title>. <source>Trends in Genet</source>. <volume>34</volume>, <fpage>653</fpage>–<lpage>665</lpage> (<year>2018</year>).<pub-id pub-id-type="pmid">30007833</pub-id></mixed-citation>
    </ref>
    <ref id="R4">
      <label>4.</label>
      <mixed-citation publication-type="journal"><name><surname>Liu</surname><given-names>S</given-names></name>. &amp; <name><surname>Trapnell</surname><given-names>C</given-names></name>. <article-title>Single-Cell Transcriptome Sequencing: Recent Advances and Remaining Challenges</article-title>. <source>F1000Res</source>
<volume>5</volume> (<year>2016</year>).</mixed-citation>
    </ref>
    <ref id="R5">
      <label>5.</label>
      <mixed-citation publication-type="journal"><name><surname>Svensson</surname><given-names>V</given-names></name>, <name><surname>Vento-Tormo</surname><given-names>R</given-names></name>. &amp; <name><surname>Teichmann</surname><given-names>SA</given-names></name>. <article-title>Exponential Scaling of Single-Cell RNA-Seq in the Past Decade</article-title>. <source>Nat. Protoc</source>
<volume>13</volume>, <fpage>599</fpage>–<lpage>604</lpage> (<year>2018</year>).<pub-id pub-id-type="pmid">29494575</pub-id></mixed-citation>
    </ref>
    <ref id="R6">
      <label>6.</label>
      <mixed-citation publication-type="journal"><name><surname>Levine</surname><given-names>JH</given-names></name><etal/><article-title>Data-Driven Phenotypic Dissection of AML Reveals Progenitor-like Cells That Correlate with Prognosis</article-title>. <source>Cell</source><volume>162</volume>, <fpage>184</fpage>–<lpage>197</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">26095251</pub-id></mixed-citation>
    </ref>
    <ref id="R7">
      <label>7.</label>
      <mixed-citation publication-type="journal"><name><surname>Butler</surname><given-names>A</given-names></name>, <name><surname>Hoffman</surname><given-names>P</given-names></name>, <name><surname>Smibert</surname><given-names>P</given-names></name>, <name><surname>Papalexi</surname><given-names>E</given-names></name>. &amp; <name><surname>Satija</surname><given-names>R</given-names></name>. <article-title>Integrating Single-Cell Transcriptomic Data across Different Conditions, Technologies, and Species</article-title>. <source>Nat. Biotechnol</source> (<year>2018</year>).</mixed-citation>
    </ref>
    <ref id="R8">
      <label>8.</label>
      <mixed-citation publication-type="journal"><name><surname>Qiu</surname><given-names>X</given-names></name>. <etal/><article-title>Reversed Graph Embedding Resolves Complex Single-Cell Trajectories</article-title>. <source>Nat. Methods</source><volume>14</volume>, <fpage>979</fpage>–<lpage>982</lpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28825705</pub-id></mixed-citation>
    </ref>
    <ref id="R9">
      <label>9.</label>
      <mixed-citation publication-type="journal"><name><surname>Azizi</surname><given-names>E</given-names></name>, <name><surname>Prabhakaran</surname><given-names>S</given-names></name>, <name><surname>Carr</surname><given-names>A</given-names></name>. &amp; <name><surname>Pe’er</surname><given-names>D</given-names></name>. <article-title>Bayesian Inference for Single-Cell Clustering and Imputing</article-title>. <source>Genomics Comput. Biol</source>
<volume>3</volume>, <fpage>46</fpage> (<year>2017</year>).</mixed-citation>
    </ref>
    <ref id="R10">
      <label>10.</label>
      <mixed-citation publication-type="journal"><name><surname>Ho</surname><given-names>Y-J</given-names></name><etal/><article-title>Single-Cell RNA-Seq Analysis Identifies Markers of Resistance to Targeted BRAF Inhibitors in Melanoma Cell Populations</article-title>. <source>Genome Res</source>. <volume>28</volume>, <fpage>1353</fpage>–<lpage>1363</lpage> (<year>2018</year>).<pub-id pub-id-type="pmid">30061114</pub-id></mixed-citation>
    </ref>
    <ref id="R11">
      <label>11.</label>
      <mixed-citation publication-type="journal"><name><surname>Van der Maaten</surname><given-names>L</given-names></name>. &amp; <name><surname>Hinton</surname><given-names>G</given-names></name>. <article-title>Visualizing Data Using T-SNE</article-title>. <source>J. Mach. Learn. Res</source>
<volume>9</volume>, <fpage>2579</fpage>–<lpage>2605</lpage> (<month>11</month>
<year>2008</year>).</mixed-citation>
    </ref>
    <ref id="R12">
      <label>12.</label>
      <mixed-citation publication-type="journal"><name><surname>McInnes</surname><given-names>L</given-names></name>, <name><surname>Healy</surname><given-names>J</given-names></name>. &amp; <name><surname>Melville</surname><given-names>J</given-names></name>. <source>UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction</source> (<year>2018</year>).</mixed-citation>
    </ref>
    <ref id="R13">
      <label>13.</label>
      <mixed-citation publication-type="journal"><name><surname>Becht</surname><given-names>E</given-names></name>. <etal/><article-title>Dimensionality Reduction for Visualizing Single-Cell Data Using UMAP</article-title>. <source>Nat. Biotechnol</source><volume>37</volume>, <fpage>38</fpage>–<lpage>44</lpage> (<year>2019</year>).</mixed-citation>
    </ref>
    <ref id="R14">
      <label>14.</label>
      <mixed-citation publication-type="journal"><name><surname>Nutt</surname><given-names>SL</given-names></name>, <name><surname>Hodgkin</surname><given-names>PD</given-names></name>, <name><surname>Tarlinton</surname><given-names>DM</given-names></name> &amp; <name><surname>Corcoran</surname><given-names>LM</given-names></name>
<article-title>The Generation of Antibody-Secreting Plasma Cells</article-title>. <source>Nat. Rev. Immunol</source>
<volume>15</volume>, <fpage>160</fpage>–<lpage>171</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">25698678</pub-id></mixed-citation>
    </ref>
    <ref id="R15">
      <label>15.</label>
      <mixed-citation publication-type="journal"><name><surname>Zeisel</surname><given-names>A</given-names></name>. <etal/><article-title>Cell Types in the Mouse Cortex and Hippocampus Revealed by Single-Cell RNA-Seq</article-title>. <source>Science</source><volume>347</volume>, <fpage>1138</fpage>–<lpage>1142</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">25700174</pub-id></mixed-citation>
    </ref>
    <ref id="R16">
      <label>16.</label>
      <mixed-citation publication-type="journal"><name><surname>Lin</surname><given-names>P</given-names></name>, <name><surname>Troup</surname><given-names>M</given-names></name>. &amp; <name><surname>Ho</surname><given-names>JWK</given-names></name>
<article-title>CIDR: Ultrafast and Accurate Clustering through Imputation for Single-Cell RNA-Seq Data</article-title>. <source>Genome Biology</source>
<volume>18</volume>, <fpage>59</fpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28351406</pub-id></mixed-citation>
    </ref>
    <ref id="R17">
      <label>17.</label>
      <mixed-citation publication-type="journal"><name><surname>Li</surname><given-names>H</given-names></name>. <etal/><article-title>Reference Component Analysis of Single-Cell Transcriptomes Elucidates Cellular Heterogeneity in Human Colorectal Tumors</article-title>. <source>Nat. Genet</source><volume>49</volume>, <fpage>708</fpage>–<lpage>718</lpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28319088</pub-id></mixed-citation>
    </ref>
    <ref id="R18">
      <label>18.</label>
      <mixed-citation publication-type="journal"><name><surname>Zappia</surname><given-names>L</given-names></name>. &amp; <name><surname>Oshlack</surname><given-names>A</given-names></name>. <article-title>Clustering Trees: A Visualization for Evaluating Clusterings at Multiple Resolutions</article-title>. <source>Gigascience</source> 7 (<year>2018</year>).</mixed-citation>
    </ref>
    <ref id="R19">
      <label>19.</label>
      <mixed-citation publication-type="journal"><name><surname>Newman</surname><given-names>MEJ</given-names></name> &amp; <name><surname>Girvan</surname><given-names>M</given-names></name>. <article-title>Finding and Evaluating Community Structure in Networks</article-title>. <source>Phys. Rev. E</source>
<volume>69</volume> (<year>2004</year>).</mixed-citation>
    </ref>
    <ref id="R20">
      <label>20.</label>
      <mixed-citation publication-type="journal"><name><surname>Lancichinetti</surname><given-names>A</given-names></name>. &amp; <name><surname>Fortunato</surname><given-names>S</given-names></name>. <article-title>Limits of Modularity Maximization in Community Detection</article-title>. <source>Phys. Rev. E</source>
<volume>84</volume>, <fpage>066122</fpage> (<year>2011</year>).</mixed-citation>
    </ref>
    <ref id="R21">
      <label>21.</label>
      <mixed-citation publication-type="journal"><name><surname>Blondel</surname><given-names>VD</given-names></name>, <name><surname>Guillaume</surname><given-names>J-L</given-names></name>, <name><surname>Lambiotte</surname><given-names>R</given-names></name>. &amp; <name><surname>Lefebvre</surname><given-names>E</given-names></name>. <article-title>Fast Unfolding of Communities in Large Networks</article-title>. <source>J. Stat. Mech</source>
<volume>2008</volume>, <comment>P10008</comment> (<year>2008</year>).</mixed-citation>
    </ref>
    <ref id="R22">
      <label>22.</label>
      <mixed-citation publication-type="journal"><collab>The Tabula Muris Consortium</collab><etal/><article-title>Single-Cell Transcriptomics of 20 Mouse Organs Creates a Tabula Muris</article-title>. <source>Nature</source><volume>562</volume>, <fpage>367</fpage>–<lpage>372</lpage> (<year>2018</year>).<pub-id pub-id-type="pmid">30283141</pub-id></mixed-citation>
    </ref>
    <ref id="R23">
      <label>23.</label>
      <mixed-citation publication-type="journal"><name><surname>Zheng</surname><given-names>GXY</given-names></name><etal/><article-title>Massively Parallel Digital Transcriptional Profiling of Single Cells</article-title>. <source>Nat. Commun</source><volume>8</volume>, <fpage>14049</fpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28091601</pub-id></mixed-citation>
    </ref>
    <ref id="R24">
      <label>24.</label>
      <mixed-citation publication-type="journal"><name><surname>Herman</surname><given-names>JS</given-names></name>, <name><surname>Sagar &amp; Grün</surname><given-names>D</given-names></name>. <article-title>FateID Infers Cell Fate Bias in Multipotent Progenitors from Single-Cell RNA-Seq Data</article-title>. <source>Nat. Methods</source><volume>15</volume>, <fpage>379</fpage>–<lpage>386</lpage> (<year>2018</year>).<pub-id pub-id-type="pmid">29630061</pub-id></mixed-citation>
    </ref>
    <ref id="R25">
      <label>25.</label>
      <mixed-citation publication-type="journal"><name><surname>Pellin</surname><given-names>D</given-names></name>. <etal/><article-title>A Comprehensive Single Cell Transcriptional Landscape of Human Hematopoietic Progenitors</article-title>. <source>Nat Commun</source><volume>10</volume>, <fpage>1</fpage>–<lpage>15</lpage> (<year>2019</year>).<pub-id pub-id-type="pmid">30602773</pub-id></mixed-citation>
    </ref>
    <ref id="R26">
      <label>26.</label>
      <mixed-citation publication-type="journal"><name><surname>Dahlin</surname><given-names>JS</given-names></name><etal/><article-title>A single-cell hematopoietic landscape resolves 8 lineage trajectories and defects in Kit mutant mice</article-title>. <source>Blood</source><volume>131</volume>, <fpage>e1</fpage><comment>e11</comment> (<year>2018</year>).<pub-id pub-id-type="pmid">29588278</pub-id></mixed-citation>
    </ref>
    <ref id="R27">
      <label>27.</label>
      <mixed-citation publication-type="journal"><name><surname>Borges da Silva</surname><given-names>H</given-names></name>. <etal/><article-title>Splenic Macrophage Subsets and Their Function during Blood-Borne Infections</article-title>. <source>Front. Immunol</source><volume>6</volume> (<year>2015</year>).</mixed-citation>
    </ref>
    <ref id="R28">
      <label>28.</label>
      <mixed-citation publication-type="journal"><name><surname>Den Haan</surname><given-names>JMM</given-names></name> &amp; <name><surname>Kraal</surname><given-names>G</given-names></name>. <article-title>Innate Immune Functions of Macrophage Subpopulations in the Spleen</article-title>. <source>JIN</source>
<volume>4</volume>, <fpage>437</fpage>–<lpage>445</lpage> (<year>2012</year>).</mixed-citation>
    </ref>
    <ref id="R29">
      <label>29.</label>
      <mixed-citation publication-type="journal"><name><surname>Hey</surname><given-names>YY</given-names></name> &amp; <name><surname>O’Neill</surname><given-names>HC</given-names></name>
<article-title>Murine Spleen Contains a Diversity of Myeloid and Dendritic Cells Distinct in Antigen Presenting Function</article-title>. <source>J. Cell. Mol. Med</source>
<volume>16</volume>, <fpage>2611</fpage>–<lpage>2619</lpage> (<year>2012</year>).<pub-id pub-id-type="pmid">22862733</pub-id></mixed-citation>
    </ref>
    <ref id="R30">
      <label>30.</label>
      <mixed-citation publication-type="journal"><name><surname>Jojic</surname><given-names>V</given-names></name>. <etal/><article-title>Identification of Transcriptional Regulators in the Mouse Immune System</article-title>. <source>Nat. Immunol</source><volume>14</volume>, <fpage>633</fpage>–<lpage>643</lpage> (<year>2013</year>).<pub-id pub-id-type="pmid">23624555</pub-id></mixed-citation>
    </ref>
    <ref id="R31">
      <label>31.</label>
      <mixed-citation publication-type="journal"><name><surname>Winter</surname><given-names>SS</given-names></name><etal/><article-title>Improved Survival for Children and Young Adults With T-Lineage Acute Lymphoblastic Leukemia: Results From the Children’s Oncology Group AALL0434 Methotrexate Randomization</article-title>. <source>J Clin Oncol</source><volume>36</volume>, <fpage>2926</fpage>–<lpage>2934</lpage> (<year>2018</year>).<pub-id pub-id-type="pmid">30138085</pub-id></mixed-citation>
    </ref>
    <ref id="R32">
      <label>32.</label>
      <mixed-citation publication-type="journal"><name><surname>Marks</surname><given-names>DI</given-names></name><etal/><article-title>T-Cell Acute Lymphoblastic Leukemia in Adults: Clinical Features, Immunophenotype, Cytogenetics, and Outcome from the Large Randomized Prospective Trial (UKALL XII/ECOG 2993)</article-title>. <source>Blood</source><volume>114</volume>, <fpage>5136</fpage>–<lpage>5145</lpage> (<year>2009</year>).<pub-id pub-id-type="pmid">19828704</pub-id></mixed-citation>
    </ref>
    <ref id="R33">
      <label>33.</label>
      <mixed-citation publication-type="journal"><name><surname>Aster</surname><given-names>JC</given-names></name>, <name><surname>Pear</surname><given-names>WS</given-names></name> &amp; <name><surname>Blacklow</surname><given-names>SC</given-names></name>
<article-title>The Varied Roles of Notch in Cancer</article-title>. <source>Annu. Rev. Pathol. Mech. Dis</source>
<volume>12</volume>, <fpage>245</fpage>–<lpage>275</lpage> (<year>2017</year>).</mixed-citation>
    </ref>
    <ref id="R34">
      <label>34.</label>
      <mixed-citation publication-type="journal"><name><surname>Knoechel</surname><given-names>B</given-names></name>. <etal/><article-title>An Epigenetic Mechanism of Resistance to Targeted Therapy in T Cell Acute Lymphoblastic Leukemia</article-title>. <source>Nat. Genet</source><volume>46</volume>, <fpage>364</fpage>–<lpage>370</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24584072</pub-id></mixed-citation>
    </ref>
    <ref id="R35">
      <label>35.</label>
      <mixed-citation publication-type="journal"><name><surname>Dluzen</surname><given-names>D</given-names></name>, <name><surname>Li</surname><given-names>G</given-names></name>, <name><surname>Tacelosky</surname><given-names>D</given-names></name>, <name><surname>Moreau</surname><given-names>M</given-names></name>. &amp; <name><surname>Liu</surname><given-names>DX</given-names></name>
<article-title>BCL-2 Is a Downstream Target of ATF5 That Mediates the Prosurvival Function of ATF5 in a Cell Type-Dependent Manner</article-title>. <source>J. Biol. Chem</source>
<volume>286</volume>, <fpage>7705</fpage>–<lpage>7713</lpage> (<year>2011</year>).<pub-id pub-id-type="pmid">21212266</pub-id></mixed-citation>
    </ref>
    <ref id="R36">
      <label>36.</label>
      <mixed-citation publication-type="journal"><name><surname>Yamazaki</surname><given-names>T</given-names></name>. <etal/><article-title>Regulation of the Human CHOP Gene Promoter by the Stress Response Transcription Factor ATF5 via the AARE1 Site in Human Hepatoma HepG2 Cells</article-title>. <source>Life Sci</source>. <volume>87</volume>, <fpage>294</fpage>–<lpage>301</lpage> (<year>2010</year>).<pub-id pub-id-type="pmid">20654631</pub-id></mixed-citation>
    </ref>
    <ref id="R37">
      <label>37.</label>
      <mixed-citation publication-type="journal"><name><surname>Liu</surname><given-names>DX</given-names></name>, <name><surname>Qian</surname><given-names>D</given-names></name>, <name><surname>Wang</surname><given-names>B</given-names></name>, <name><surname>Yang</surname><given-names>J-M</given-names></name> &amp; <name><surname>Lu</surname><given-names>Z</given-names></name>. <article-title>P300-Dependent ATF5 Acetylation Is Essential for Egr-1 Gene Activation and Cell Proliferation and Survival</article-title>. <source>Mol. Cell. Biol</source>
<volume>31</volume>, <fpage>3906</fpage>–<lpage>3916</lpage> (<year>2011</year>).<pub-id pub-id-type="pmid">21791614</pub-id></mixed-citation>
    </ref>
    <ref id="R38">
      <label>38.</label>
      <mixed-citation publication-type="journal"><name><surname>Angelastro</surname><given-names>JM</given-names></name><article-title>Targeting ATF5 in Cancer</article-title>. <source>Trends Cancer</source><volume>3</volume>, <fpage>471</fpage>–<lpage>474</lpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28718401</pub-id></mixed-citation>
    </ref>
    <ref id="R39">
      <label>39.</label>
      <mixed-citation publication-type="journal"><name><surname>Karpel-Massler</surname><given-names>G</given-names></name>. <etal/><article-title>A Synthetic Cell-Penetrating Dominant-Negative ATF5 Peptide Exerts Anticancer Activity against a Broad Spectrum of Treatment-Resistant Cancers</article-title>. <source>Clin. Cancer. Res</source><volume>22</volume>, <fpage>4698</fpage>–<lpage>4711</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">27126996</pub-id></mixed-citation>
    </ref>
    <ref id="R40">
      <label>40.</label>
      <mixed-citation publication-type="journal"><name><surname>Subramanian</surname><given-names>A</given-names></name>. <etal/><article-title>Gene Set Enrichment Analysis: A Knowledge-Based Approach for Interpreting Genome-Wide Expression Profiles</article-title>. <source>Proc. Natl. Acad. Sci</source><volume>102</volume>, <fpage>15545</fpage>–<lpage>15550</lpage> (<year>2005</year>).<pub-id pub-id-type="pmid">16199517</pub-id></mixed-citation>
    </ref>
    <ref id="R41">
      <label>41.</label>
      <mixed-citation publication-type="journal"><name><surname>Liberzon</surname><given-names>A</given-names></name>. <etal/><article-title>The Molecular Signatures Database Hallmark Gene Set Collection</article-title>. <source>Cell Systems</source><volume>1</volume>, <fpage>417</fpage>–<lpage>425</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">26771021</pub-id></mixed-citation>
    </ref>
    <ref id="R42">
      <label>42.</label>
      <mixed-citation publication-type="journal"><name><surname>Shu</surname><given-names>L</given-names></name>, <name><surname>Chen</surname><given-names>A</given-names></name>, <name><surname>Xiong</surname><given-names>M</given-names></name>. &amp; <name><surname>Meng</surname><given-names>W</given-names></name>. <source>Efficient SPectrAl Neighborhood Blocking for Entity Resolution</source> in (<comment>IEEE</comment>, <year>2011</year>), <fpage>1067</fpage>–<lpage>1078</lpage>.</mixed-citation>
    </ref>
    <ref id="R43">
      <label>43.</label>
      <mixed-citation publication-type="journal"><name><surname>Shi</surname><given-names>J</given-names></name>. &amp; <name><surname>Malik</surname><given-names>J</given-names></name>. <article-title>Normalized Cuts and Image Segmentation</article-title>. <source>IEEE Trans. Pattern Anal. Mach. Intell</source>
<volume>22</volume>, <fpage>18</fpage> (<year>2000</year>).</mixed-citation>
    </ref>
    <ref id="R44">
      <label>44.</label>
      <mixed-citation publication-type="journal"><name><surname>Sparck Jones</surname><given-names>K</given-names></name>. <article-title>A Statistical Interpretation of Term Specificity and Its Application in Retrieval</article-title>. <source>Journal of Documentation</source><volume>28</volume>, <fpage>11</fpage>–<lpage>21</lpage> (<year>1972</year>).</mixed-citation>
    </ref>
    <ref id="R45">
      <label>45.</label>
      <mixed-citation publication-type="book"><name><surname>Manning</surname><given-names>CD</given-names></name>, <name><surname>Raghavan</surname><given-names>P</given-names></name>. &amp; <name><surname>Schütze</surname><given-names>H</given-names></name>. <source>Introduction to Information Retrieval OCLC: ocn190786122</source>. <fpage>482</fpage> pp. (<publisher-name>Cambridge University Press</publisher-name>, <publisher-loc>New York</publisher-loc>, <year>2008</year>).</mixed-citation>
    </ref>
    <ref id="R46">
      <label>46.</label>
      <mixed-citation publication-type="journal"><name><surname>Salton</surname><given-names>G</given-names></name>, <name><surname>Wong</surname><given-names>A</given-names></name>. &amp; <name><surname>Yang</surname><given-names>CS</given-names></name>. <article-title>A Vector Space Model for Automatic Indexing</article-title>. <source>Commun. ACM</source>
<volume>18</volume>, <fpage>613</fpage>–<lpage>620</lpage> (<year>1975</year>).</mixed-citation>
    </ref>
    <ref id="R47">
      <label>47.</label>
      <mixed-citation publication-type="journal"><name><surname>Robinson</surname><given-names>MD</given-names></name>, <name><surname>McCarthy</surname><given-names>DJ</given-names></name> &amp; <name><surname>Smyth</surname><given-names>GK</given-names></name>
<article-title>edgeR: A Bioconductor Package for Differential Expression Analysis of Digital Gene Expression Data</article-title>. <source>Bioinformatics</source>
<volume>26</volume>, <fpage>139</fpage>– <lpage>140</lpage> (<year>2010</year>).<pub-id pub-id-type="pmid">19910308</pub-id></mixed-citation>
    </ref>
    <ref id="R48">
      <label>48.</label>
      <mixed-citation publication-type="journal"><name><surname>Hill</surname><given-names>MO</given-names></name><article-title>Diversity and Evenness: A Unifying Notation and Its Consequences</article-title>. <source>Ecology</source><volume>54</volume>, <fpage>427</fpage> (<year>1973</year>).</mixed-citation>
    </ref>
    <ref id="R49">
      <label>49.</label>
      <mixed-citation publication-type="journal"><name><surname>Schwartz</surname><given-names>GW</given-names></name> &amp; <name><surname>Hershberg</surname><given-names>U</given-names></name>. <article-title>Conserved Variation: Identifying Patterns of Stability and Variability in BCR and TCR V Genes with Different Diversity and Richness Metrics</article-title>. <source>Phys. Biol</source>
<volume>10</volume>, <fpage>035005</fpage> (<year>2013</year>).<pub-id pub-id-type="pmid">23735612</pub-id></mixed-citation>
    </ref>
    <ref id="R50">
      <label>50.</label>
      <mixed-citation publication-type="journal"><name><surname>Schwartz</surname><given-names>GW</given-names></name> &amp; <name><surname>Hershberg</surname><given-names>U</given-names></name>. <article-title>Germline Amino Acid Diversity in B Cell Receptors Is a Good Predictor of Somatic Selection Pressures</article-title>. <source>Front. Immunol</source>
<volume>4</volume> (<year>2013</year>).</mixed-citation>
    </ref>
    <ref id="R51">
      <label>51.</label>
      <mixed-citation publication-type="journal"><name><surname>Meng</surname><given-names>W</given-names></name>. <etal/><article-title>An Atlas of B-Cell Clonal Distribution in the Human Body</article-title>. <source>Nat. Biotechnol</source> (<year>2017</year>).</mixed-citation>
    </ref>
    <ref id="R52">
      <label>52.</label>
      <mixed-citation publication-type="journal"><name><surname>Heck</surname><given-names>KL</given-names></name>, <name><surname>van Belle</surname><given-names>G</given-names></name>. &amp; <name><surname>Simberloff</surname><given-names>D</given-names></name>. <article-title>Explicit Calculation of the Rarefaction Diversity Measurement and the Determination of Sufficient Sample Size</article-title>. <source>Ecology</source>
<volume>56</volume>, <fpage>1459</fpage> (<year>1975</year>).</mixed-citation>
    </ref>
    <ref id="R53">
      <label>53.</label>
      <mixed-citation publication-type="journal"><name><surname>Tian</surname><given-names>L</given-names></name>. <etal/><article-title>Benchmarking Single Cell RNA-Sequencing Analysis Pipelines Using Mixture Control Experiments</article-title>. <source>Nat Methods</source><volume>16</volume>, <fpage>479</fpage>–<lpage>487</lpage> (<year>2019</year>).<pub-id pub-id-type="pmid">31133762</pub-id></mixed-citation>
    </ref>
    <ref id="R54">
      <label>54.</label>
      <mixed-citation publication-type="journal"><name><surname>Ronen</surname><given-names>J</given-names></name>. &amp; <name><surname>Akalin</surname><given-names>A</given-names></name>. <article-title>netSmooth: Network-Smoothing Based Imputation for Single Cell RNA-Seq</article-title>. <source>F1000Res</source>
<volume>7</volume> (<year>2018</year>).</mixed-citation>
    </ref>
    <ref id="R55">
      <label>55.</label>
      <mixed-citation publication-type="journal"><name><surname>Dai</surname><given-names>H</given-names></name>, <name><surname>Li</surname><given-names>L</given-names></name>, <name><surname>Zeng</surname><given-names>T</given-names></name>. &amp; <name><surname>Chen</surname><given-names>L</given-names></name>. <article-title>Cell-Specific Network Constructed by Single-Cell RNA Sequencing Data</article-title>. <source>Nucleic Acids Res</source>
<volume>47</volume>, <fpage>e62</fpage> (<year>2019</year>).<pub-id pub-id-type="pmid">30864667</pub-id></mixed-citation>
    </ref>
    <ref id="R56">
      <label>56.</label>
      <mixed-citation publication-type="book"><name><surname>Tan</surname><given-names>P-N</given-names></name>, <name><surname>Steinbach</surname><given-names>M</given-names></name>, <name><surname>Karpatne</surname><given-names>A</given-names></name>. &amp; <name><surname>Kumar</surname><given-names>V</given-names></name>. <source>Introduction to Data Mining Second edition</source>. <fpage>839</fpage> pp. (<publisher-loc>Pearson, NY NY</publisher-loc>, <year>2019</year>).</mixed-citation>
    </ref>
    <ref id="R57">
      <label>57.</label>
      <mixed-citation publication-type="journal"><name><surname>Kvålseth</surname><given-names>TO</given-names></name><source>On Normalized Mutual Information: Measure Derivations and Properties</source>, <volume>14</volume> (<year>2017</year>).</mixed-citation>
    </ref>
    <ref id="R58">
      <label>58.</label>
      <mixed-citation publication-type="journal"><name><surname>Zappia</surname><given-names>L</given-names></name>, <name><surname>Phipson</surname><given-names>B</given-names></name>. &amp; <name><surname>Oshlack</surname><given-names>A</given-names></name>. <article-title>Splatter: Simulation of Single-Cell RNA Sequencing Data</article-title>. <source>Genome Biology</source>
<volume>18</volume>, <fpage>174</fpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28899397</pub-id></mixed-citation>
    </ref>
    <ref id="R59">
      <label>59.</label>
      <mixed-citation publication-type="journal"><name><surname>Schwartz</surname><given-names>GW</given-names></name>, <name><surname>Shokoufandeh</surname><given-names>A</given-names></name>, <name><surname>Ontañón</surname><given-names>S</given-names></name>. &amp; <name><surname>Hershberg</surname><given-names>U</given-names></name>. <article-title>Using a Novel Clumpiness Measure to Unite Data with Metadata: Finding Common Sequence Patterns in Immune Receptor Germline V Genes</article-title>. <source>Pattern Recognit. Lett</source>
<volume>74</volume>, <fpage>24</fpage>–<lpage>29</lpage> (<year>2016</year>).</mixed-citation>
    </ref>
    <ref id="R60">
      <label>60.</label>
      <mixed-citation publication-type="journal"><name><surname>Wolock</surname><given-names>SL</given-names></name>, <name><surname>Lopez</surname><given-names>R</given-names></name>. &amp; <name><surname>Klein</surname><given-names>AM</given-names></name>
<article-title>Scrublet: Computational Identification of Cell Doublets in Single-Cell Transcriptomic Data</article-title>. <source>Cell Systems</source>
<volume>8</volume>, <fpage>281</fpage>–<lpage>291</lpage>.<comment>e9</comment> (<year>2019</year>).<pub-id pub-id-type="pmid">30954476</pub-id></mixed-citation>
    </ref>
    <ref id="R61">
      <label>61.</label>
      <mixed-citation publication-type="journal"><name><surname>Raj</surname><given-names>A</given-names></name>, <name><surname>van den Bogaard</surname><given-names>P</given-names></name>, <name><surname>Rifkin</surname><given-names>SA</given-names></name>, <name><surname>van Oudenaarden</surname><given-names>A</given-names></name>. &amp; <name><surname>Tyagi</surname><given-names>S</given-names></name>. <article-title>Imaging Individual mRNA Molecules Using Multiple Singly Labeled Probes</article-title>. <source>Nat. Methods</source>
<volume>5</volume>, <fpage>877</fpage>– <lpage>879</lpage> (<year>2008</year>).<pub-id pub-id-type="pmid">18806792</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig id="F1" orientation="portrait" position="float">
    <label>Figure 1:</label>
    <caption>
      <p id="P90">The TooManyCells visualization and clustering algorithms. (a) TooManyCells visualizes inter-cluster relationships while providing many capabilities and options including, but not limited to, weighted average blending of colors, scaling branches, modularity overlays, smart tree pruning, and several leaf node visualizations. Cells from 11 mouse organs are color coded based on their organ-of-origin. (b) TooManyCells matrix-free divisive hierarchical spectral clustering. TooManyCells is conceptually similar to recursive separation of cells based on their color (state/type) similarities, first separating green and blue from red, purple, orange, and gray cells, followed by separation of green from blue, gray from red, purple, and orange, etc. The network of cells (nodes) connected by their cosine similarities (edges) is recursively bipartitioned (red dashed lines) using truncated singular value decomposition (SVD) of the transformed matrix <bold>C</bold> that is directly calculated from the gene expression matrix. Here, truncated SVD only calculates the first two left singular vectors corresponding to the two largest singular values instead of full matrix factorization. This “matrix-free” process eliminates the need for the explicit calculation of cell-cell similarity (<bold>A</bold>) and the normalized Laplacian (<italic>L</italic>(<bold>A</bold>)) matrices followed by full eigenvalue decomposition (calculation of all the matrices on the right hand side of the equation instead of only the red-marked column) at each bipartitioning. Recursive bipartitioning is terminated when a candidate split results in non-positive Newman-Girvan modularity (<italic>Q</italic>).</p>
    </caption>
    <graphic xlink:href="nihms-1549979-f0001"/>
  </fig>
  <fig id="F2" orientation="portrait" position="float">
    <label>Figure 2:</label>
    <caption>
      <p id="P91">Example of TooManyCells visualization capabilities using 11 mouse organs. (a) The complete tree with default settings. (b) Different leaf rendering options (clockwise from bottom: gene expression, “pie ring”, pie chart) and example of scaling and average weighted color blending for branches. (c) Tree from (a) pruned with median(node size)+3*MAD(node size), which is used in panels d to k. (d) Tree with modularity of bipartitioning at each internal node displayed as black circles, where higher modularity is represented by darker circumference intensity. (e) Tree with numbered nodes. (f) Color-coded tree with a continuous variable (e.g. cell diversity of organs, increasing color intensity represents increasing diversity). For clarity, inner and leaf nodes use different intensity scales. (g) Color-coded tree with a discrete variable presenting UMI counts. (h) Color-coded tree with expression level of a specific gene (<italic>Cd4</italic> expression level). (i) Color-coded tree with expression level of multiple genes (<italic>Cd4</italic> and <italic>Cd8</italic> expression levels). (j) Tree with non-default scaling width. (k) Tree with disabled branch scaling.</p>
    </caption>
    <graphic xlink:href="nihms-1549979-f0002"/>
  </fig>
  <fig id="F3" orientation="portrait" position="float">
    <label>Figure 3:</label>
    <caption>
      <p id="P92">Comparative analysis of clustering performance and scalability. (a) From <italic>Tabula Muris</italic><sup><xref rid="R22" ref-type="bibr">22</xref></sup> (<italic>n</italic> = 41,689 cells), the population analyzed is represented by the number of organs on the <italic>x</italic>-axis taken from the left of the ordering {Thymus, Spleen, Bone marrow, Limb muscle, Tongue, Heart, Lung, Mammary gland, Bladder, Kidney, Liver}. Purity (left), entropy (middle), or normalized mutual information (NMI, right) performance measures are calculated. Higher purity and NMI represent higher accuracy, while lower entropy indicates better performance. Default or suggested filterings and parameters were used for all algorithms (see <xref rid="S10" ref-type="sec">Online methods</xref>). A dashed border indicates the algorithm did not complete within four days. (b-d) Same measures as (a) are used to compare clustering accuracy based on data from Zheng <italic>et al.</italic><sup><xref rid="R23" ref-type="bibr">23</xref></sup> (<italic>n</italic> = 23,910 cells) (b), Li <italic>et al.</italic><sup><xref rid="R17" ref-type="bibr">17</xref></sup> (<italic>n</italic> = 561 cells) (c), and Pellin <italic>et al.</italic><sup><xref rid="R25" ref-type="bibr">25</xref></sup> (<italic>n</italic> = 2,815 cells) (d). (e-h) Equivalent data sets as (a-d) for different TooManyCells normalization procedures: the TooManyCells default normalization (Default) term frequency-inverse document frequency (tf-idf), Log Counts-Per-Million (Log CPM), total and gene median count normalization (Cell and Gene), upper quartile normalization (Upper Quartile), total and gene median count normalization followed by tf-idf normalization (Cell and Gene / TF-IDF).</p>
    </caption>
    <graphic xlink:href="nihms-1549979-f0003"/>
  </fig>
  <fig id="F4" orientation="portrait" position="float">
    <label>Figure 4:</label>
    <caption>
      <p id="P93">Detection of cells from two “rare” populations mixed with a “common” population was benchmarked for widely used clustering algorithms. (a, b) Columns from left to right: cells labeled by actual cell types and assigned clusters of a clustering algorithm. Rows from top to bottom: Monocle, Phenograph, Seurat, and RaceID t-SNE projections. Each projection used the corresponding package’s implementation of t-SNE with the same seed (see <xref rid="S10" ref-type="sec">Online Methods</xref>). Analysis for 900 common (T cells) and 100 rare cells (50 macrophages and 50 dendritic cells) (a) and 990 common and 10 rare cells (5 macrophages and 5 dendritic cells) (b) are presented. (c) TooManyCells with priority given to rare cells (pruning median(modularity)+5*MAD(modularity)). Left: 900 common and 100 rare cells. Right: 990 common and 10 rare cells. Magnified rare-population-containing subtree showed in insert. Black to white colored circles represent high to low modularity. (d-g) Box-Whisker plots (center line, median; box limits, upper (75<sup>th</sup>) and lower (25<sup>th</sup>) percentiles; whiskers, 1.5x interquartile range; points, outliers) quantifying accuracy of rare population detection in admixtures from various data sets (<italic>m</italic> = 10 admixtures, <italic>n</italic> = 1,000 cells): (d) T cells (Common), macrophages (Rare1), and dendritic cells (Rare2); (e) mouse bladder (Common), heart (Rare1), and tongue cells (Rare2); (f) human PBMC FACS-purified CD19+ B (Common), CD14+ monocytes (Rare1) and CD4+ T (Rare2) cells; and (g) three subpopulations of synthetic data. Each point represents average performance of ten experiments from an admixture (ten admixtures overall, from 90% common to 99% common). Performance indicates true rare pairs (i.e. Rare1 with Rare1 in the same cluster) / total rare pairs (true rare pairs, and Rare1 with Rare2). TooManyCells was evaluated with default normalization. To accommodate the Splatter model in (g), TooManyCells was run with PCA and relaxed modularity cutoff to account for the transformation.</p>
    </caption>
    <graphic xlink:href="nihms-1549979-f0004"/>
  </fig>
  <fig id="F5" orientation="portrait" position="float">
    <label>Figure 5:</label>
    <caption>
      <p id="P94">TooManyCells stratifies rare plasmablasts in mouse spleen. (a, b) TooManyCells clustering tree of the mouse splenocytes labeled with major immune cell lineages based on predefined lineage markers<sup><xref rid="R22" ref-type="bibr">22</xref></sup> with (a) more (0.1 modularity) and (b) less (0.025 modularity) restricted modularity pruning thresholds, respectively. (c) Tree from (b) colored with newly identified B cell subtypes (see <xref rid="S10" ref-type="sec">Online Methods</xref>). (d) ImmGen MyGeneSet<sup><xref rid="R30" ref-type="bibr">30</xref></sup> gene expressions for the top <italic>n</italic> = 100 differentially expressed genes of the plasmablast node from (c) compared to all other B cell subtypes (box-whisker plots: center line, median; box limits, upper (75<sup>th</sup>) and lower (25<sup>th</sup>) percentiles; whiskers, 1.5x interquartile range; points, outliers). (e) Cells from <xref rid="SD1" ref-type="supplementary-material">Figure S16</xref> projected using Seurat’s processing and t-SNE, colored by TooManyCells clustering tree leaves, where each leaf is assigned a different color (top-right insert). Similar colors represent nearby locations within the tree, for example pink and purple are closer in the tree than pink and green. (f) Coordinates from t-SNE projection in (e) colored by subset populations from (c). Orange color-coded plasmablasts are indistinguishable from other B lymphocytes. (g) Coordinates from the t-SNE projection in (e) colored by Seurat-generated cluster labels fails to separate plasmablasts. Circles colored from black to white base on high to low modularity. Definitions of <italic>x</italic>-axis ticks from (d), T1: Splenic T1 (transitional), T2: Splenic T2, T3: Splenic T3, B: Splenic B cells, Fem: Female Splenic B cells, Fo: Splenic Follicular, MZ: Splenic Marginal Zone, mem: Splenic Memory, GC_CB: Splenic Germinal Center Centroblasts, GC_CC: Splenic Germinal Center Centrocytes, PB: Splenic Plasmablasts, PC: Splenic Plasma Cells. <italic>n</italic> = 9,552 cells in all the panels.</p>
    </caption>
    <graphic xlink:href="nihms-1549979-f0005"/>
  </fig>
  <fig id="F6" orientation="portrait" position="float">
    <label>Figure 6:</label>
    <caption>
      <p id="P95">TooManyCells identifies GSI-resistant cell heterogeneity and detects resistant-like T-ALL cells. (a) Treatment strategies for untreated (<italic>n</italic> = 2,338 cells), short-term (<italic>n</italic> = 2,616 cells), ascending (<italic>n</italic> = 2,727 cells), and sustained (<italic>n</italic> = 2,417 cells) DND-41 populations. (b) TooManyCells tree showing distinct GSI-resistant populations (<italic>n</italic> = 10,098 cells). (c, d) Upper quartile normalized (UQ) <italic>MYC</italic> (c) and <italic>ATF5</italic> (d) expressions overlaid onto (b). Gray to red: low to high expression. (e) TooManyCells tree of parental and sustained populations (<italic>n</italic> = 7,371 cells). Magnified resistant-like subtree in insert. (f) UQ <italic>MYC</italic> expression overlaid onto (e). Magnified resistant-like subtree in insert. Black to white circles represent high to low modularity. (g) Violin plots (center line, median; upper and lower lines, 75<sup>th</sup> and 25<sup>th</sup> percentiles; lower and upper bounds, minimum and maximum) normalized <italic>MYC</italic> expression of resistant-like (<italic>n</italic> = 28 cells) and other parental (<italic>n</italic> = 4,926 cells) cells (two-tailed Mann-Whitney <italic>U</italic> test, <italic>p</italic> = 4.16 × 10<sup>−8</sup>). (h) Box-Whisker plots (center line, median; box limits, upper (75<sup>th</sup>) and lower (25<sup>th</sup>) percentiles; whiskers, 1.5x interquartile range; points, outliers) showing single-cell <italic>MYC</italic> (left) and <italic>GAPDH</italic> (center) RNA FISH signal distributions for untreated (<italic>n</italic> = 250 cells), short-term (<italic>n</italic> = 261 cells; two-tailed <italic>t</italic> test, <italic>MYC</italic>: <italic>p</italic> = 1.5 × 10<sup>−11</sup>), and sustained (<italic>n</italic> = 222 cells; two-tailed <italic>t</italic> test, <italic>MYC</italic>: <italic>p</italic> = 2 × 10<sup>−4</sup>) populations. Cell images (right) of RNA FISH signals for <italic>GAPDH</italic> (pseudo-color red) and <italic>MYC</italic> (pseudo-color yellow) in untreated (top) and sustained (bottom) cells. Top 3<sup>rd</sup> and 4<sup>th</sup> columns showing two untreated cells with high <italic>MYC</italic> and low <italic>MYC</italic> expression, respectively. Bottom 3<sup>rd</sup> and 4<sup>th</sup> columns showing two sustained cells with high <italic>MYC</italic> expression. Cell nuclei in purple. NS: <italic>p</italic> &gt; 0.005 (i) Cells from (e) projected using Seurat (<italic>n</italic> = 4,954 cells), colored by resistant-like population (red) from (e). (j) Coordinates from (i) colored by Seurat-generated clusters.</p>
    </caption>
    <graphic xlink:href="nihms-1549979-f0006"/>
  </fig>
</floats-group>
