<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.0 20120330//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.0?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 2?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">PeerJ</journal-id>
    <journal-id journal-id-type="iso-abbrev">PeerJ</journal-id>
    <journal-id journal-id-type="pmc">PeerJ</journal-id>
    <journal-id journal-id-type="publisher-id">PeerJ</journal-id>
    <journal-title-group>
      <journal-title>PeerJ</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2167-8359</issn>
    <publisher>
      <publisher-name>PeerJ Inc.</publisher-name>
      <publisher-loc>San Francisco, USA</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">4359046</article-id>
    <article-id pub-id-type="publisher-id">824</article-id>
    <article-id pub-id-type="doi">10.7717/peerj.824</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Bioinformatics</subject>
      </subj-group>
      <subj-group subj-group-type="heading">
        <subject>Mathematical Biology</subject>
      </subj-group>
      <subj-group subj-group-type="heading">
        <subject>Computational Science</subject>
      </subj-group>
      <subj-group subj-group-type="heading">
        <subject>Coupled Natural and Human Systems</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>CauseMap: fast inference of causality from complex time series</article-title>
    </title-group>
    <contrib-group>
      <contrib id="author-1" contrib-type="author" corresp="yes">
        <name>
          <surname>Maher</surname>
          <given-names>M. Cyrus</given-names>
        </name>
        <xref ref-type="aff" rid="aff-1">1</xref>
        <email>cyrusmaher@gmail.com</email>
      </contrib>
      <contrib id="author-2" contrib-type="author">
        <name>
          <surname>Hernandez</surname>
          <given-names>Ryan D.</given-names>
        </name>
        <xref ref-type="aff" rid="aff-2">2</xref>
        <xref ref-type="aff" rid="aff-3">3</xref>
        <xref ref-type="aff" rid="aff-4">4</xref>
      </contrib>
      <aff id="aff-1"><label>1</label><institution>Department of Epidemiology and Biostatistics, University of California</institution>, <addr-line>San Francisco, CA</addr-line>, <country>USA</country></aff>
      <aff id="aff-2"><label>2</label><institution>Department of Bioengineering and Therapeutic Sciences</institution>, <country>USA</country></aff>
      <aff id="aff-3"><label>3</label><institution>Institute for Human Genetics</institution>, <country>USA</country></aff>
      <aff id="aff-4"><label>4</label><institution>Institute for Quantitative Biosciences (QB3), University of California</institution>, <addr-line>San Francisco, CA</addr-line>, <country>USA</country></aff>
    </contrib-group>
    <contrib-group>
      <contrib id="editor-1" contrib-type="editor">
        <name>
          <surname>Wilke</surname>
          <given-names>Claus</given-names>
        </name>
      </contrib>
    </contrib-group>
    <pub-date pub-type="epub" date-type="pub" iso-8601-date="2015-03-05">
      <day>5</day>
      <month>3</month>
      <year iso-8601-date="2015">2015</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2015</year>
    </pub-date>
    <volume>3</volume>
    <elocation-id>e824</elocation-id>
    <history>
      <date date-type="received" iso-8601-date="2014-11-03">
        <day>3</day>
        <month>11</month>
        <year iso-8601-date="2014">2014</year>
      </date>
      <date date-type="accepted" iso-8601-date="2015-02-17">
        <day>17</day>
        <month>2</month>
        <year iso-8601-date="2015">2015</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© 2015 Maher and Hernandez</copyright-statement>
      <copyright-year>2015</copyright-year>
      <copyright-holder>Maher and Hernandez</copyright-holder>
      <license license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/4.0/">
        <license-p>This is an open access article distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use, distribution, reproduction and adaptation in any medium and for any purpose provided that it is properly attributed. For attribution, the original author(s), title, publication source (PeerJ) and either DOI or URL of the article must be cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="https://peerj.com/articles/824"/>
    <abstract>
      <p><bold>Background.</bold> Establishing health-related causal relationships is a central pursuit in biomedical research. Yet, the interdependent non-linearity of biological systems renders causal dynamics laborious and at times impractical to disentangle. This pursuit is further impeded by the dearth of time series that are sufficiently long to observe and understand recurrent patterns of flux. However, as data generation costs plummet and technologies like wearable devices democratize data collection, we anticipate a coming surge in the availability of biomedically-relevant time series data. Given the life-saving potential of these burgeoning resources, it is critical to invest in the development of open source software tools that are capable of drawing meaningful insight from vast amounts of time series data.</p>
      <p><bold>Results.</bold> Here we present CauseMap, the first open source implementation of convergent cross mapping (CCM), a method for establishing causality from long time series data (≳25 observations). Compared to existing time series methods, CCM has the advantage of being model-free and robust to unmeasured confounding that could otherwise induce spurious associations. CCM builds on Takens’ Theorem, a well-established result from dynamical systems theory that requires only mild assumptions. This theorem allows us to reconstruct high dimensional system dynamics using a time series of only a single variable. These reconstructions can be thought of as shadows of the true causal system. If reconstructed shadows can predict points from opposing time series, we can infer that the corresponding variables are providing views of the same causal system, and so are causally related. Unlike traditional metrics, this test can establish the directionality of causation, even in the presence of feedback loops. Furthermore, since CCM can extract causal relationships from times series of, e.g., a single individual, it may be a valuable tool to personalized medicine. We implement CCM in Julia, a high-performance programming language designed for facile technical computing. Our software package, CauseMap, is platform-independent and freely available as an official Julia package.</p>
      <p><bold>Conclusions.</bold> CauseMap is an efficient implementation of a state-of-the-art algorithm for detecting causality from time series data. We believe this tool will be a valuable resource for biomedical research and personalized medicine.</p>
    </abstract>
    <kwd-group kwd-group-type="author">
      <kwd>Causality</kwd>
      <kwd>Open source software</kwd>
      <kwd>Time series methods</kwd>
      <kwd>Dynamical systems</kwd>
      <kwd>Personalized medicine</kwd>
    </kwd-group>
    <funding-group>
      <award-group id="fund-1">
        <funding-source>National Institutes of Health F31 Predoctoral Fellowship</funding-source>
        <award-id>F31 CA180609-01</award-id>
      </award-group>
      <award-group id="fund-2">
        <funding-source>University of California, San Francisco Lloyd M. Kozloff Fellowship</funding-source>
      </award-group>
      <award-group id="fund-3">
        <funding-source>National Institutes of Health</funding-source>
        <award-id>P60MD006902</award-id>
        <award-id>UL1RR024131</award-id>
        <award-id>1R21HG007233</award-id>
        <award-id>1R21CA178706</award-id>
        <award-id>1R01HL117004</award-id>
      </award-group>
      <award-group id="fund-4">
        <funding-source>Alfred P. Sloan Foundation Research Fellowship</funding-source>
      </award-group>
      <funding-statement>M. Cyrus Maher was supported by the National Institutes of Health F31 Predoctoral Fellowship (grant number 1 F31 CA180609-01), and a University of California, San Francisco Lloyd M. Kozloff Fellowship. This work was also partially supported by the National Institutes of Health (grant numbers P60MD006902, UL1RR024131, 1R21HG007233, 1R21CA178706, and 1R01HL117004) and an Alfred P. Sloan Foundation Research Fellowship to Ryan D. Hernandez. The funders had no role in study design, data collection and analysis, decision to publish, or preparation of the manuscript.</funding-statement>
    </funding-group>
  </article-meta>
</front>
<body>
  <sec sec-type="intro">
    <title>Introduction</title>
    <p>Establishing health-related causal relationships is a pivotal objective in biomedical research. Yet, the interdependent non-linearity of biological systems often impedes a thorough understanding of causal dynamics. Existing and forthcoming time series data will likely play an important role in taming this complexity. Traditional cross-sectional sampling have the limitation that they may average out non-linear patterns by pooling heterogeneous signals across subjects. Long time series from a single source, on the other hand, can allow us to understand dynamic and context-specific patterns of change.</p>
    <p>We are just beginning to grasp the biomedical relevance of such a dynamical systems perspective. Consider, for example, the human microbiome. Dysbiosis in the gut has been implicated in, e.g., irritable bowel disease (IBD), obesity, diabetes, asthma, anxiety, and depression (<xref rid="ref-5" ref-type="bibr">Foster &amp; McVey Neufeld, 2013</xref>; <xref rid="ref-1" ref-type="bibr">Arrieta et al., 2014</xref>). Meanwhile, recent studies on microbiome dynamics have found that the ecological makeup of the human microbiome is dynamic and individual-specific. These dynamics may also interact with pathogens in interesting and therapeutically important ways. For example, there is evidence that ecological time series dynamics within the body may play a role in the progression from HIV to AIDS (<xref rid="ref-14" ref-type="bibr">Vujkovic-Cvijin et al., 2013</xref>).</p>
    <p>Complex, dynamically evolving interdependent systems such as the microbiome pose a significant challenge to existing time series methods. Several metrics exist for detecting static non-linear relationships. These include: Spearman rank correlation, (<xref rid="ref-9" ref-type="bibr">Spearman, 1904</xref>), distance correlation (<xref rid="ref-11" ref-type="bibr">Székely &amp; Rizzo, 2009</xref>), and mutual information content (<xref rid="ref-8" ref-type="bibr">Kullback &amp; Leibler, 1951</xref>). Causal relationships, on the other hand, can be examined using methods such as time-lagged regression, instrumental variables, and dynamical Bayesian networks (<xref rid="ref-6" ref-type="bibr">Granger, 1969</xref>).</p>
    <p>These causal methods are heavily model-based, however. As a result, they often falter when examining arbitrary non-linear or context-dependent relationships. Furthermore, the approaches mentioned above cannot adequately handle feedback loops, and they frequently generate both false positives and false negatives due to the influence of unmeasured confounders (<xref rid="ref-10" ref-type="bibr">Sugihara et al., 2012</xref>). These are significant liabilities, particularly in biomedicine, where relationships are usually embedded within a broad network of incompletely observed interactions.</p>
    <p>In this paper, we present the first publicly available, open source implementation of convergent cross mapping (CCM), a model-free approach to detecting dependencies and inferring causality in complex non-linear systems (even in the presence of feedback loops and unmeasured confounding; <xref rid="ref-10" ref-type="bibr">Sugihara et al., 2012</xref>). CCM derives this power from explicitly capturing time-dependent dynamics through a technique known as state-space reconstruction (SSR). SSR has demonstrated utility for problems as diverse as wildlife management and cerebral autoregulation (<xref rid="ref-12" ref-type="bibr">Vanderweele &amp; Arah, 2011</xref>). In practice, this analysis typically requires at least 25 data points, measured with relatively high accuracy and with sufficient density to capture system dynamics. One benefit of this approach is that, unlike most causal inference methods, the performance of CCM improves for increasingly non-linear systems. In addition, CCM can properly disentangle causal relationships that involve feedback loops, provided that strong forcing from external variables does not overwhelm the dynamics of the relationships of interest.</p>
    <p>CCM leverages the fact that time series can be viewed as projections of higher-dimensional system dynamics (<xref rid="ref-10" ref-type="bibr">Sugihara et al., 2012</xref>). As a logical result of this property, the time series of individual variables must contain information about the full causal system. Causal dynamics (conceptualized as the state space, or manifold) can then be reconstructed using individual time series. These reconstructions can be thought of as shadows of the true causal system. If the shadows reconstructed from distinct variables can be used to predict points from each other’s time series, we can infer that these variables provide views of the same causal system and so are causally related. Since these relationships are fundamentally asymmetric, this test can also establish the directionality of causation.</p>
    <p>Further details on CCM are available in the <xref ref-type="supplementary-material" rid="supp-1">Supplemental Information</xref> of this paper, as well as in that of <xref rid="ref-10" ref-type="bibr">Sugihara et al. (2012)</xref>. Additional explanatory resources can also be accessed through the project website (<uri xlink:href="http://cyrusmaher.github.io/CauseMap.jl">http://cyrusmaher.github.io/CauseMap.jl</uri>).</p>
  </sec>
  <sec sec-type="materials|methods">
    <title>Materials and Methods</title>
    <sec>
      <title>Convergent cross mapping algorithm</title>
      <p>Consider time series of hypothetical variables <italic>X</italic> and <italic>Y</italic>. Convergent cross mapping (CCM) employs time-lagged coordinates of each of these variables to produce shadow versions of their respective source manifolds. To illustrate, suppose the time series for <italic>X</italic> were {1, 2, 3, 4}. Reconstructing a two-dimensional shadow manifold for <italic>X</italic> using a time lag of one would yield the following path: (2, 1) → (3, 2) → (4, 3). For sufficiently long time series, the path of this shadow manifold is expected to reveal important properties of the full causal system.</p>
      <p>We will refer to the shadow manifolds reconstructed from <italic>X</italic> and <italic>Y</italic> as <italic>M<sub>x</sub></italic> and <italic>M<sub>y</sub></italic>, respectively. To test whether <italic>X</italic> causes <italic>Y</italic>, CCM applies the following logic: because manifold reconstruction preserves important structural components of the original system (i.e., the Lyapunov exponents; <xref rid="ref-2" ref-type="bibr">Casdagli et al., 1991</xref>), if <italic>X</italic> causes <italic>Y</italic>, then time points that are close in <italic>M<sub>y</sub></italic> should also be close in <italic>M<sub>x</sub></italic>. Since <italic>M<sub>x</sub></italic> is constructed from lags of the observations of <italic>X</italic>, the points that are close in <italic>M<sub>x</sub></italic> will also have similar values in the corresponding time series. Therefore, if <italic>X</italic> causes <italic>Y</italic>, then <italic>M<sub>y</sub></italic> can tell us which observations of <italic>X</italic> should best predict a given held-out point from <italic>X</italic>. Furthermore, predictability should increase with the number of manifold points in <italic>M<sub>y</sub></italic> that are considered.</p>
    </sec>
    <sec>
      <title>Assessing predictive skill</title>
      <p>To test whether <italic>X</italic> causes <italic>Y</italic>, <italic>M<sub>y</sub></italic> is used to infer the points in <italic>X</italic> that will best predict a given held-out point from <italic>X</italic>. We measure this performance using predictive skill, quantified by <italic>ρ</italic><sub>ccm</sub> as follows. To begin, we withhold a point from <italic>X</italic> that we will then attempt to predict. We use <italic>M<sub>y</sub></italic> to infer the points in <italic>M<sub>x</sub></italic> that will be closest to this point of interest. This is accomplished using relative pairwise distances of corresponding points in <italic>M<sub>y</sub></italic>. We then perform a weighted average of the corresponding observations in <italic>X</italic> using exponential weights derived from these pairwise distances in <italic>M<sub>y</sub></italic>. We similarly produce predicted values for each held-out point in <italic>X</italic>. <italic>ρ</italic><sub>ccm</sub> is then calculated as the Pearson correlation between held-out and predicted points. The cross validated nature of this measure serves to reduce over-fitting with respect to the model’s tuning parameters described below. To examine whether the signal converges as expected for a causal relationship, these steps are repeated using increasing numbers of points from <italic>M<sub>y</sub></italic> and <italic>M<sub>x</sub></italic>.</p>
    </sec>
    <sec>
      <title>CauseMap is fast</title>
      <p>CauseMap implements CCM in Julia, a high-performance programming language designed for facile technical computing. By way of an intelligent JIT (just in time) compilation, Julia offers much of the speed of low-level, low-productivity languages like C, while also providing the ease of use and platform independence of much slower high-level languages like Python, R, or Matlab.</p>
      <p>At the core of CauseMap is the calculation of distances between a large number of manifold points in potentially high dimensional spaces. To optimize efficiency, CauseMap precomputes all necessary manifolds and pairwise distances using a state-of-the-art, BLAS-based protocol (for benchmarks, see: <uri xlink:href="https://github.com/JuliaStats/Distance.jl">https://github.com/JuliaStats/Distance.jl</uri>).</p>
      <p>To illustrate the speed of CauseMap as a function of time series length, in <xref ref-type="table" rid="table-1">Table 1</xref> we present the runtimes for successive catenations of the time series presented in <xref ref-type="fig" rid="fig-1">Fig. 1</xref>. For our time series of length 71, CauseMap finishes in approximately 10 s. For a time series of over 400 observations, CauseMap still finishes in less than 20 min on a single CPU. Note that for this dataset, predictive skill was nearly perfect at a time series length of 213. This calculation finished in less than two minutes. Through this example, we observe that CauseMap can reach superb levels of performance long before increasing time series length generates significant computational challenge.</p>
      <fig id="fig-1" orientation="portrait" position="float">
        <object-id pub-id-type="doi">10.7717/peerj.824/fig-1</object-id>
        <label>Figure 1</label>
        <caption>
          <title>An example visualization from CauseMap using abundances of <italic>Paramecium aurelia</italic> and <italic>Didinium nasutum</italic>.</title>
          <p>See <xref ref-type="supplementary-material" rid="supp-1">Supplemental Information</xref> for more information on this system. (A) For optimal parameter values, the convergence of the cross-map correlation with library size. (B–C). The dependence of the maximum cross-map correlation on assumed dimensionality (measured by <italic>E</italic>) and the time lag of the causal effect (measured by <italic>τ<sub>p</sub></italic>). Note that the second maximum at <italic>τ<sub>p</sub></italic> = 5 corresponds to the principal frequency of the <italic>P. aurelia</italic> and <italic>D. nasutum</italic> time series, as determined by Fourier transform analysis.</p>
        </caption>
        <graphic xlink:href="peerj-03-824-g001"/>
      </fig>
      <table-wrap id="table-1" orientation="portrait" position="float">
        <object-id pub-id-type="doi">10.7717/peerj.824/table-1</object-id>
        <label>Table 1</label>
        <caption>
          <title>Runtime versus time series length.</title>
          <p>Results are presented for one to six catenations of the dataset presented in <xref ref-type="fig" rid="fig-1">Fig. 1</xref>. Runtime values are for comprehensive parameter optimizations on a single 2.6 GHz Intel Core i7 processor.</p>
        </caption>
        <alternatives>
          <graphic xlink:href="peerj-03-824-g003"/>
          <table frame="hsides" rules="groups">
            <colgroup span="1">
              <col span="1"/>
              <col span="1"/>
            </colgroup>
            <thead>
              <tr>
                <th rowspan="1" colspan="1">Time series length</th>
                <th rowspan="1" colspan="1">Runtime (s)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td rowspan="1" colspan="1">71</td>
                <td rowspan="1" colspan="1">10.2</td>
              </tr>
              <tr>
                <td rowspan="1" colspan="1">142</td>
                <td rowspan="1" colspan="1">40.4</td>
              </tr>
              <tr>
                <td rowspan="1" colspan="1">213</td>
                <td rowspan="1" colspan="1">116.6</td>
              </tr>
              <tr>
                <td rowspan="1" colspan="1">284</td>
                <td rowspan="1" colspan="1">317.2</td>
              </tr>
              <tr>
                <td rowspan="1" colspan="1">355</td>
                <td rowspan="1" colspan="1">534.7</td>
              </tr>
              <tr>
                <td rowspan="1" colspan="1">426</td>
                <td rowspan="1" colspan="1">1080.5</td>
              </tr>
            </tbody>
          </table>
        </alternatives>
      </table-wrap>
    </sec>
    <sec>
      <title>Tuning parameter values aid causal interpretation</title>
      <p>Beyond the speed and comparative simplicity resulting from cutting-edge JIT compilation, CauseMap offers a number of conveniences and performance enhancements. For CCM, it is particularly important to optimize two tuning parameters: <italic>E</italic> and <italic>τ<sub>p</sub></italic>.</p>
      <p><italic>E</italic> is the number of dimensions of the reconstructed shadow manifold. If <italic>E</italic><sub>max</sub> is the optimal embedding dimension, Whitney’s Theorem tells us that the dimensionality of the full causal system is generically between (<italic>E</italic><sub>max</sub> − 1)/2 and <italic>E</italic><sub>max</sub>, inclusive (<xref rid="ref-4" ref-type="bibr">Eelles &amp; Toledo, 1992</xref>; <xref rid="ref-3" ref-type="bibr">Deyle &amp; Sugihara, 2011</xref>). Note though that <italic>E</italic><sub>max</sub> is usually unknown and must be inferred from the data. This procedure is described in the following section.</p>
      <p><italic>τ<sub>p</sub></italic> denotes the time delay of the causal effect of interest. By examining the optimal values of these two parameters, we may place bounds on the number of variables involved in the full causal system, gain insight into the timeframe of causal effects, and obtain a built-in sensitivity analysis of the final results. The estimation of these parameters is described below.</p>
    </sec>
    <sec>
      <title>CauseMap optimizes and visualizes tuning parameters</title>
      <p><italic>E</italic> and <italic>τ<sub>p</sub></italic> are optimized by multiple iterations of cyclic coordinate descent. This process chooses the values of <italic>E</italic> and <italic>τ<sub>p</sub></italic> that optimize the predictive skill of the model for held-out data points. Typically convergence of the cross map signal as a function of the time series length (<italic>L</italic>) alone is taken as the practical criterion for causality. However, measuring the dependence of this signal on <italic>E</italic> and <italic>τ<sub>p</sub></italic> is also useful for evaluating whether the result is suitably specific with respect to the assumed structure of the causal system. CauseMap therefore also includes a plotting function to visualize the dependence of the predictive skill (<italic>ρ</italic><sub>ccm</sub>) on <italic>L</italic>, as well as on the joint values of <italic>E</italic> and <italic>τ<sub>p</sub></italic>.</p>
      <sec>
        <title>Interpretation of output</title>
        <p>The systematic increase of predictive skill (<italic>ρ</italic><sub>ccm</sub>) with <italic>L</italic> constitutes a practical, qualitative criterion for causality (<xref rid="ref-10" ref-type="bibr">Sugihara et al., 2012</xref>). Generally, non-causal <italic>ρ</italic><sub>ccm</sub> curves are flat with respect to <italic>L</italic>, while <italic>ρ</italic><sub>ccm</sub> signals associated with causal signals show striking convergence given sufficient data. One exception is in the case of strong external forcing. An outside variable can introduce a cross map correlation between two quantities if it exerts a sufficiently strong influence over both. We speculate that such situations can produce <italic>ρ</italic><sub>ccm</sub> values that, compared to true causal relationships, have a noisier or less interpretable dependence on <italic>E</italic> and <italic>τ<sub>p</sub></italic>. Furthermore, it is necessary to inspect the dependence of the cross map correlation on the joint distribution of <italic>E</italic> and <italic>τ<sub>p</sub></italic> in order to properly understand the meaning of the maximal values of these two variables. Note that for high throughput analyses, convergence with respect to <italic>L</italic> and sensitivity to <italic>E</italic> and <italic>τ<sub>p</sub></italic> could be assessed with, e.g., relative difference- and entropy-based measures, respectively.</p>
      </sec>
    </sec>
    <sec>
      <title>CauseMap is easy to use</title>
      <p>Beyond the tuning parameters mentioned above, CCM requires one to specify a range of library sizes, as well as the window of time points for which cross mapping should be performed. Valid values for these parameters depend in turn on <italic>E</italic> and <italic>τ<sub>p</sub></italic>. To reduce complexity for the user, CauseMap calculates intelligent defaults for these parameters, while also offering the option of specifying them directly.</p>
    </sec>
    <sec>
      <title>Caveats and considerations</title>
      <p>The strengths and weaknesses of CCM make it nicely complementary to the existing tools for causal inference. Unlike most algorithms for this task, the performance of CCM improves for increasingly non-linear systems. However, this capacity depends upon relatively long time series. CCM requires at least 25 data points, measured with relatively high accuracy and with sufficient density to capture system dynamics.</p>
      <p>There are also theoretical and practical limitations to the types of relationships that CCM can disentangle. For example, if both <italic>X</italic> and <italic>Y</italic> are almost entirely determined by a third variable <italic>Z</italic>, we would be at risk of inferring a spurious relationship between <italic>X</italic> and <italic>Y</italic> (as we would be with any other causal inference method). If the forcing from <italic>Z</italic> is relatively weak, however, CCM is expected to provide a lower false positive rate relative to other methods (<xref rid="ref-10" ref-type="bibr">Sugihara et al., 2012</xref>).</p>
      <p>CCM also examines relationships between variables in a pairwise fashion. However, by leveraging dynamical systems theory, it has the ability to measure possibly bidirectional causal effects even in the presence of unmeasured confounding. Finally, CCM performs best with complete data sampled at regular intervals. This is particularly important for inferring the time lag of the causal effect. This limitation can be partially addressed through filtering or appropriate interpolation of input data.</p>
    </sec>
  </sec>
  <sec>
    <title>Results and Discussion</title>
    <p>To demonstrate CauseMap’s functionality and performance, we examined the predator–prey relationship between <italic>Paramecium aurelia</italic> and <italic>Didinium nasutum</italic> (<xref rid="ref-7" ref-type="bibr">Heskamp et al., 2013</xref>). Observations were collected every 12 h for 30 days, yielding a total of 60 data points (<xref rid="ref-13" ref-type="bibr">Veilleux, 1976</xref>). Plotted in <xref ref-type="fig" rid="fig-1">Fig. 1</xref> is the CauseMap visualization of the dependence of predictive skill (<italic>ρ</italic><sub>ccm</sub>) on <italic>L</italic>, <italic>E</italic>, and <italic>τ<sub>p</sub></italic>. In <xref ref-type="fig" rid="fig-1">Fig. 1A</xref>, we observe convergence in <italic>ρ</italic><sub>ccm</sub> with respect to <italic>L</italic>, the number of data points used for prediction of held-out observations. This convergence is a practical criterion for causality and the source of the name <italic>convergent</italic> cross mapping.</p>
    <p>The interpretation of this result is that the causal relationship between <italic>P. aurelia</italic> and <italic>D. nasutum</italic> is bi-directional. That is, the number of predators influences the number of prey, and vice-versa. Furthermore, relative strengths of convergence indicate that the top-down influence of the predator (<italic>D. nasutum</italic>) is stronger than the bottom-up influence of the prey (<italic>P. Aurelia)</italic>. As pointed out by <xref rid="ref-10" ref-type="bibr">Sugihara et al.</xref>, this finding is consistent with experimental results and illustrates the ability of CCM to investigate asymmetrical bi-directional coupling in non-linear systems.</p>
    <p><xref ref-type="fig" rid="fig-1">Figures 1B</xref> and <xref ref-type="fig" rid="fig-1">1C</xref> show the dependence of the max <italic>ρ</italic><sub>ccm</sub> on <italic>E</italic> (the dimensionality of the reconstructed system), and the supposed time lag of the causal effect (<italic>τ<sub>p</sub></italic>). Overall, the patterning of these heatmaps demonstrates that max <italic>ρ<sub>ccm</sub></italic> has a reasonable and moderately specific dependence on the dimensionality of the reconstructed system (<italic>E</italic>) and on the time lag of the causal effect (<italic>τ<sub>p</sub></italic>). We expect this built-in sensitivity analysis to rule out some cases of spurious convergent signal caused by external forcing. In addition, this analysis can alert the researcher when alternative combinations of <italic>E</italic> and <italic>τ<sub>p</sub></italic> explain the data approximately as well as the optimal values of <italic>E</italic> and <italic>τ<sub>p</sub></italic>.</p>
    <p>For the system presented in <xref ref-type="fig" rid="fig-1">Fig. 1</xref>, while the max <italic>ρ</italic><sub>ccm</sub> is relatively insensitive to the assumed dimensionality, the best-performing <italic>τ<sub>p</sub></italic> values correspond to either immediate causal effects, or those delayed by five days. Note that <italic>τ<sub>p</sub></italic> = 5 corresponds to the principal frequency of the <italic>Paramecium aurelia</italic> and <italic>Didinium nasutum</italic> time series, as determined by Fourier transform analysis (see <xref ref-type="supplementary-material" rid="supp-1">Supplemental Information</xref> for further details). This suggests that the peak at <italic>τ<sub>p</sub></italic> = 5 is artifactual. Therefore, we are able to infer from the data that, as we would expect, predator and prey populations exert bidirectional effects in real-time.</p>
    <sec>
      <title>Performance</title>
      <p>Approximately 100 CCM evaluations were conducted to produce <xref ref-type="fig" rid="fig-1">Fig. 1</xref>. These calculations finished in approximately 10 s on a single 2.6 GHz processor. Each of these evaluations involved the prediction of over 60,000 points, compiled across all sliding windows of libraries of varying lengths. At an average of 1.7 ms per prediction, this is a highly efficient implementation given the computational challenges.</p>
    </sec>
    <sec>
      <title>Dependence of predictive skill on time series length</title>
      <p>CauseMap is designed to examine causal relationships in time series with 25 or more observations. In order to illustrate the effects of shorter time series, we thinned the <italic>Paramedium-Didinium</italic> data set by one-half and by one-third, yielding series of 30 and 20 observations, respectively. <xref ref-type="fig" rid="fig-2">Figure 2</xref> demonstrates the effect of this reduction on the convergence of predictive skill (<italic>ρ</italic><sub>ccm</sub>). We see that the 1/2 thinned data set recapitulates the trends observed in the full series, including the relative magnitudes of <italic>ρ</italic><sub>ccm</sub> between the mappings of <italic>Didinium</italic> to <italic>Paramecium</italic> and vice versa. The 1/3 thinned sample set, on the other hand, no longer demonstrates convergence. In addition, compared to the longer sets, it exhibits the opposite trend in relative predictive skill between the two mappings. Patterns in max <italic>ρ</italic><sub>ccm</sub> versus <italic>E</italic> and <italic>τ<sub>p</sub></italic> are approximately conserved, however (<xref ref-type="supplementary-material" rid="supp-2">Fig. S1</xref>).</p>
      <fig id="fig-2" orientation="portrait" position="float">
        <object-id pub-id-type="doi">10.7717/peerj.824/fig-2</object-id>
        <label>Figure 2</label>
        <caption>
          <title>The effect of time series length on <italic>ρ</italic><sub>ccm</sub> convergence.</title>
          <p>Black, blue, and red lines illustrate <italic>ρ</italic><sub>ccm</sub> for the full, 1/2 thinned, and 1/3 thinned datasets, respectively. For a given color, darker lines show <italic>ρ</italic><sub>ccm</sub> for the test of whether <italic>Didinium</italic> abundance influences <italic>Paramecium</italic> abundance. Lighter lines examine the converse.</p>
        </caption>
        <graphic xlink:href="peerj-03-824-g002"/>
      </fig>
      <p>This example illustrates that CCM performance drops off sharply between 20 and 30 data points. This behavior is partially due to the fact that the predictive skill for a given library size is averaged across sliding windows of that size. As time series get shorter, there are fewer windows of appropriate size across which to average, so the estimate for predictive skill becomes much less reliable.</p>
    </sec>
  </sec>
  <sec>
    <title>Potential Biomedical Applications</title>
    <p>Despite its requirement for relatively long time series (&gt;25 observations), CauseMap has the advantage of requiring only a single time series for each variable. In dynamical systems with widely varying or context-specific behavior, this would allow researchers to draw conclusions that are tailored to a given patient, for example. Rather than acting on population averages, biomedical researchers would be free to fully personalize therapy to the unique biology and ecology of the patient. One example of this is in the treatment of microbiome dysbiosis. Imbalances in the microbiome have been implicated in, e.g., irritable bowel disease (IBD), obesity, diabetes, asthma, anxiety, and depression. While fecal transplantation therapy is effective in treating specific types of dysbiosis, next generation therapeutics may offer a blend of purified strains, tailored to the gut ecology of the patient. We believe CauseMap has the potential to be a valuable tool for designing such breakthrough therapies.</p>
    <p>Additional examples include understanding patient-to-patient variability in drug response using time series metabolomics, and examining the basis of, for example, influenza seasonality using global time series. We expect that such applications will continue to proliferate as the costs of data collection decrease over the coming years. For this reason, we believe it is vitally important that the biomedical research community have access to an efficient implementation of CCM that is user-friendly and available for immediate field testing.</p>
    <sec>
      <title>Planned future development</title>
      <p>In future versions, we will include S-map calculations to evaluate the non-linearity of the causal system. We will also add a bootstrap-based procedure for library selection, as opposed to the current approach using sliding windows. This has been shown to reduce the effect of secular trends on the cross map correlation (H Ye &amp; G Sugihara, pers. comm., 2014). In addition, we will re-implement the plotting functionality in Julia, removing the requirements of Python and matplotlib for visualization. Finally, we will design Python and R wrappers for CauseMap functions so that our codebase can be easily leveraged from those environments as well. User suggestions will also be considered as we decide how best to develop the tool.</p>
    </sec>
  </sec>
  <sec sec-type="conclusions">
    <title>Conclusions</title>
    <p>CauseMap provides a fast, user-friendly implementation of CCM, a powerful new method for exploring dependencies and even establishing causality in complex, highly non-linear datasets with many unobserved variables. We believe that CCM holds a great deal of promise for a wide range of applications, including personalized microbiome therapy and metabolic dynamics analysis. As novel time series datasets continue to emerge, it is our hope that CauseMap will allow researchers to uncover interesting and biomedically actionable causal relationships using this next-generation time series method.</p>
  </sec>
  <sec sec-type="supplementary-material" id="supplemental-information">
    <title>Supplemental Information</title>
    <supplementary-material content-type="local-data" id="supp-1">
      <object-id pub-id-type="doi">10.7717/peerj.824/supp-1</object-id>
      <label>Supplemental Information</label>
      <caption>
        <title>Supplemental materials</title>
      </caption>
      <media xlink:href="peerj-03-824-s001.docx">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="supp-2">
      <object-id pub-id-type="doi">10.7717/peerj.824/supp-2</object-id>
      <label>Figure S1</label>
      <caption>
        <title>The maximal predictive skill as a function of <italic>E</italic>, <italic>τ</italic><sub>p</sub>, and the number of included points</title>
      </caption>
      <media xlink:href="peerj-03-824-s002.jpg">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack>
    <p>We would like to thank George Sugihara, Hao Ye, and Ethan Deyle for their invaluable help in understanding the core details of the CCM algorithm, and Lawrence Uricchio, Nicolas Strauli, and Raul Torres for comments on this manuscript.</p>
  </ack>
  <glossary content-type="abbreviations" id="glossary-1">
    <title>List of abbreviations</title>
    <def-list>
      <def-item>
        <term>CCM</term>
        <def>
          <p>Convergent cross mapping</p>
        </def>
      </def-item>
      <def-item>
        <term>SSR</term>
        <def>
          <p>State space reconstruction</p>
        </def>
      </def-item>
    </def-list>
  </glossary>
  <sec sec-type="additional-information">
    <title>Additional Information and Declarations</title>
    <fn-group content-type="competing-interests">
      <title>Competing Interests</title>
      <fn id="conflict-1" fn-type="conflict">
        <p>The authors declare there are no competing interests.</p>
      </fn>
    </fn-group>
    <fn-group content-type="author-contributions">
      <title>Author Contributions</title>
      <fn id="contribution-1" fn-type="con">
        <p><xref ref-type="contrib" rid="author-1">M. Cyrus Maher</xref> conceived and designed the experiments, performed the experiments, analyzed the data, contributed reagents/materials/analysis tools, wrote the paper, prepared figures and/or tables, reviewed drafts of the paper.</p>
      </fn>
      <fn id="contribution-2" fn-type="con">
        <p><xref ref-type="contrib" rid="author-2">Ryan D. Hernandez</xref> contributed reagents/materials/analysis tools, wrote the paper, prepared figures and/or tables, reviewed drafts of the paper.</p>
      </fn>
    </fn-group>
    <fn-group content-type="other">
      <title>Data Deposition</title>
      <fn id="addinfo-1" fn-type="other">
        <p>The following information was supplied regarding the deposition of related data:</p>
        <p>All examples and associated data are available in the project repository (<uri xlink:href="https://github.com/cyrusmaher/CauseMap.jl">https://github.com/cyrusmaher/CauseMap.jl</uri>).</p>
      </fn>
    </fn-group>
  </sec>
  <ref-list content-type="authoryear">
    <title>References</title>
    <ref id="ref-1">
      <label>Arrieta et al. (2014)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Arrieta</surname>
            <given-names>M-C</given-names>
          </name>
          <name>
            <surname>Stiemsma</surname>
            <given-names>LT</given-names>
          </name>
          <name>
            <surname>Amenyogbe</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Brown</surname>
            <given-names>EM</given-names>
          </name>
          <name>
            <surname>Finlay</surname>
            <given-names>B</given-names>
          </name>
        </person-group>
        <article-title>The intestinal microbiome in early life: health and disease</article-title>
        <source>Frontiers in Immunology</source>
        <year>2014</year>
        <volume>5</volume>
        <fpage>427</fpage>
        <pub-id pub-id-type="doi">10.3389/fimmu.2014.00427</pub-id>
        <pub-id pub-id-type="pmid">25250028</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-2">
      <label>Casdagli et al. (1991)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Casdagli</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Eubank</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Farmer</surname>
            <given-names>JD</given-names>
          </name>
          <name>
            <surname>Gibson</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>State space reconstruction in the presence of noise</article-title>
        <source>Physica D: Nonlinear Phenomena</source>
        <year>1991</year>
        <volume>51</volume>
        <fpage>52</fpage>
        <lpage>98</lpage>
        <pub-id pub-id-type="doi">10.1016/0167-2789(91)90222-U</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-3">
      <label>Deyle &amp; Sugihara (2011)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Deyle</surname>
            <given-names>ER</given-names>
          </name>
          <name>
            <surname>Sugihara</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Generalized theorems for nonlinear state space reconstruction</article-title>
        <source>PLoS ONE</source>
        <year>2011</year>
        <volume>6</volume>
        <elocation-id>e824</elocation-id>
        <pub-id pub-id-type="doi">10.1371/journal.pone.0018295</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-4">
      <label>Eelles &amp; Toledo (1992)</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Eelles</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Toledo</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <source>Collected papers of Hassler Whitney</source>
        <year>1992</year>
        <publisher-loc>Boston</publisher-loc>
        <publisher-name>Birkhauser Publications</publisher-name>
      </element-citation>
    </ref>
    <ref id="ref-5">
      <label>Foster &amp; McVey Neufeld (2013)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Foster</surname>
            <given-names>JA</given-names>
          </name>
          <name>
            <surname>McVey Neufeld</surname>
            <given-names>K-A</given-names>
          </name>
        </person-group>
        <article-title>Gut-brain axis: how the microbiome influences anxiety and depression</article-title>
        <source>Trends in Neurosciences</source>
        <year>2013</year>
        <volume>36</volume>
        <fpage>305</fpage>
        <lpage>312</lpage>
        <pub-id pub-id-type="doi">10.1016/j.tins.2013.01.005</pub-id>
        <pub-id pub-id-type="pmid">23384445</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-6">
      <label>Granger (1969)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Granger</surname>
            <given-names>CWJ</given-names>
          </name>
        </person-group>
        <article-title>Investigating causal relations by econometric models and cross-spectral methods title</article-title>
        <source>Econometrica</source>
        <year>1969</year>
        <volume>37</volume>
        <fpage>424</fpage>
        <lpage>438</lpage>
        <pub-id pub-id-type="doi">10.2307/1912791</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-7">
      <label>Heskamp et al. (2013)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Heskamp</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Meel-van den Abeelen</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Katsogridakis</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Panerai</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Simpson</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Lagro</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Claassen</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Convergent cross mapping: a promising technique for future cerebral autoregulation estimation</article-title>
        <source>Cerebrovascular Diseases</source>
        <year>2013</year>
        <volume>35</volume>
        <fpage>15</fpage>
        <lpage>16</lpage>
      </element-citation>
    </ref>
    <ref id="ref-8">
      <label>Kullback &amp; Leibler (1951)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kullback</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Leibler</surname>
            <given-names>RA</given-names>
          </name>
        </person-group>
        <article-title>On information and sufficiency</article-title>
        <source>The Annals of Mathematical Statistics</source>
        <year>1951</year>
        <volume>22</volume>
        <fpage>79</fpage>
        <lpage>86</lpage>
        <pub-id pub-id-type="doi">10.1214/aoms/1177729694</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-9">
      <label>Spearman (1904)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Spearman</surname>
            <given-names>C</given-names>
          </name>
        </person-group>
        <article-title>The proof and measurement of association between two things</article-title>
        <source>American Journal of Psychology</source>
        <year>1904</year>
        <volume>15</volume>
        <fpage>72</fpage>
        <lpage>101</lpage>
        <pub-id pub-id-type="doi">10.2307/1412159</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-10">
      <label>Sugihara et al. (2012)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sugihara</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>May</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Ye</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Hsieh</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Deyle</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Fogarty</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Munch</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Detecting causality in complex ecosystems</article-title>
        <source>Science</source>
        <year>2012</year>
        <volume>338</volume>
        <fpage>496</fpage>
        <lpage>500</lpage>
        <pub-id pub-id-type="doi">10.1126/science.1227079</pub-id>
        <pub-id pub-id-type="pmid">22997134</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-11">
      <label>Székely &amp; Rizzo (2009)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Székely</surname>
            <given-names>GJ</given-names>
          </name>
          <name>
            <surname>Rizzo</surname>
            <given-names>ML</given-names>
          </name>
        </person-group>
        <article-title>Brownian distance covariance</article-title>
        <source>The Annals of Applied Statistics</source>
        <year>2009</year>
        <volume>3</volume>
        <fpage>1236</fpage>
        <lpage>1265</lpage>
        <pub-id pub-id-type="doi">10.1214/09-AOAS312</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-12">
      <label>Vanderweele &amp; Arah (2011)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Vanderweele</surname>
            <given-names>TJ</given-names>
          </name>
          <name>
            <surname>Arah</surname>
            <given-names>OA</given-names>
          </name>
        </person-group>
        <article-title>Bias formulas for sensitivity analysis of unmeasured confounding for general outcomes, treatments, and confounders</article-title>
        <source>Epidemiology</source>
        <year>2011</year>
        <volume>22</volume>
        <fpage>42</fpage>
        <lpage>52</lpage>
        <pub-id pub-id-type="doi">10.1097/EDE.0b013e3181f74493</pub-id>
        <pub-id pub-id-type="pmid">21052008</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-13">
      <label>Veilleux (1976)</label>
      <element-citation publication-type="thesis">
        <person-group person-group-type="author">
          <name>
            <surname>Veilleux</surname>
            <given-names>BG</given-names>
          </name>
        </person-group>
        <article-title>The analysis of a predatory interaction between Didinium and Paramecium</article-title>
        <source>Master’s Thesis</source>
        <year>1976</year>
        <institution>University of Alberta</institution>
      </element-citation>
    </ref>
    <ref id="ref-14">
      <label>Vujkovic-Cvijin et al. (2013)</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Vujkovic-Cvijin</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Dunham</surname>
            <given-names>RM</given-names>
          </name>
          <name>
            <surname>Iwai</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Maher</surname>
            <given-names>MC</given-names>
          </name>
          <name>
            <surname>Albright</surname>
            <given-names>RG</given-names>
          </name>
          <name>
            <surname>Broadhurst</surname>
            <given-names>MJ</given-names>
          </name>
          <name>
            <surname>Hernandez</surname>
            <given-names>RD</given-names>
          </name>
          <name>
            <surname>Lederman</surname>
            <given-names>MM</given-names>
          </name>
          <name>
            <surname>Huang</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Somsouk</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Deeks</surname>
            <given-names>SG</given-names>
          </name>
          <name>
            <surname>Hunt</surname>
            <given-names>PW</given-names>
          </name>
          <name>
            <surname>Lynch</surname>
            <given-names>SV</given-names>
          </name>
          <name>
            <surname>McCune</surname>
            <given-names>JM</given-names>
          </name>
        </person-group>
        <article-title>Dysbiosis of the gut microbiota is associated with HIV disease progression and tryptophan catabolism</article-title>
        <source>Science Translational Medicine</source>
        <year>2013</year>
        <volume>5</volume>
        <elocation-id>e824</elocation-id>
        <pub-id pub-id-type="doi">10.1126/scitranslmed.3006438</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
