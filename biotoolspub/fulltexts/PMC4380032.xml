<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD Journal Publishing DTD v2.3 20070202//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName journalpublishing.dtd?>
<?SourceDTD.Version 2.3?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 2?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">Bioinformatics</journal-id>
    <journal-id journal-id-type="publisher-id">bioinformatics</journal-id>
    <journal-id journal-id-type="hwp">bioinfo</journal-id>
    <journal-title-group>
      <journal-title>Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1367-4803</issn>
    <issn pub-type="epub">1367-4811</issn>
    <publisher>
      <publisher-name>Oxford University Press</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">4380032</article-id>
    <article-id pub-id-type="pmid">25398611</article-id>
    <article-id pub-id-type="doi">10.1093/bioinformatics/btu749</article-id>
    <article-id pub-id-type="publisher-id">btu749</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Original Papers</subject>
        <subj-group subj-group-type="heading">
          <subject>Genome Analysis</subject>
        </subj-group>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>M<sup>3</sup>D: a kernel-based test for spatially correlated changes in methylation profiles</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Mayo</surname>
          <given-names>Tom R.</given-names>
        </name>
        <xref ref-type="aff" rid="btu749-AFF1">
          <sup>1</sup>
        </xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Schweikert</surname>
          <given-names>Gabriele</given-names>
        </name>
        <xref ref-type="aff" rid="btu749-AFF1">
          <sup>1</sup>
        </xref>
        <xref ref-type="aff" rid="btu749-AFF1">
          <sup>2</sup>
        </xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Sanguinetti</surname>
          <given-names>Guido</given-names>
        </name>
        <xref ref-type="aff" rid="btu749-AFF1">
          <sup>1</sup>
        </xref>
        <xref ref-type="corresp" rid="btu749-COR1">*</xref>
      </contrib>
      <aff id="btu749-AFF1"><sup>1</sup>IANC, School of Informatics, University of Edinburgh, Edinburgh EH8 9AB and <sup>2</sup>Wellcome Trust Centre for Cell Biology, University of Edinburgh, Edinburgh EH9 3JR, UK</aff>
    </contrib-group>
    <author-notes>
      <corresp id="btu749-COR1">*To whom correspondence should be addressed.</corresp>
      <fn id="FN1">
        <p>Associate Editor: Inanc Birol</p>
      </fn>
    </author-notes>
    <pub-date pub-type="ppub">
      <day>15</day>
      <month>3</month>
      <year>2015</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>13</day>
      <month>11</month>
      <year>2014</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>13</day>
      <month>11</month>
      <year>2014</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on the
							<pub-date pub-type="epub"/>. -->
    <volume>31</volume>
    <issue>6</issue>
    <fpage>809</fpage>
    <lpage>816</lpage>
    <history>
      <date date-type="received">
        <day>7</day>
        <month>7</month>
        <year>2014</year>
      </date>
      <date date-type="rev-recd">
        <day>21</day>
        <month>10</month>
        <year>2014</year>
      </date>
      <date date-type="accepted">
        <day>8</day>
        <month>11</month>
        <year>2014</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author 2014. Published by Oxford University Press.</copyright-statement>
      <copyright-year>2014</copyright-year>
      <license xlink:href="http://creativecommons.org/licenses/by/4.0/" license-type="creative-commons">
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted reuse, distribution, and reproduction in any medium, provided the original work is properly cited.</license-p>
      </license>
    </permissions>
    <abstract>
      <p><bold>Motivation:</bold> DNA methylation is an intensely studied epigenetic mark implicated in many biological processes of direct clinical relevance. Although sequencing-based technologies are increasingly allowing high-resolution measurements of DNA methylation, statistical modelling of such data is still challenging. In particular, statistical identification of differentially methylated regions across different conditions poses unresolved challenges in accounting for spatial correlations within the statistical testing procedure.</p>
      <p><bold>Results:</bold> We propose a non-parametric, kernel-based method, M<sup>3</sup>D, to detect higher order changes in methylation profiles, such as shape, across pre-defined regions. The test statistic explicitly accounts for differences in coverage levels between samples, thus handling in a principled way a major confounder in the analysis of methylation data. Empirical tests on real and simulated datasets show an increased power compared to established methods, as well as considerable robustness with respect to coverage and replication levels.</p>
      <p><bold>Availability and implementation:</bold> R/Bioconductor package M<sup>3</sup>D.</p>
      <p>
        <bold>Contact:</bold>
        <email>G.Sanguinetti@ed.ac.uk</email>
      </p>
      <p><bold>Supplementary information:</bold><ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary data</ext-link> are available at <italic>Bioinformatics</italic> online.</p>
    </abstract>
    <counts>
      <page-count count="8"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec>
    <title>1 Introduction</title>
    <p>DNA methylation is an epigenetic mark associated with many fundamental biological processes of direct clinical relevance, such as imprinting, retrotransposon silencing and cell differentiation (<xref rid="btu749-B13" ref-type="bibr">Gopalakrishnan <italic>et al</italic>., 2008</xref>; <xref rid="btu749-B20" ref-type="bibr">Laurent <italic>et al</italic>., 2010</xref>). Methylation occurs when a methyl group is attached to a cytosine. In mammals, methylation is observed predominantly in the CpG context, and, consequently, studies tend to focus on these loci. The canonical understanding is that methylation of CpG regions in promoter regions (CGIs) is associated with gene silencing; however, recent studies have shown that CpG methylation correlates with gene expression in a more complex and context-dependent manner (<xref rid="btu749-B28" ref-type="bibr">Varley <italic>et al</italic>., 2013</xref>). Methylation profiles are altered in many diseases, most notably cancer (<xref rid="btu749-B8" ref-type="bibr">Das and Singal, 2004</xref>; <xref rid="btu749-B24" ref-type="bibr">Sharma <italic>et al</italic>., 2010</xref>), and as such epigenetic therapies are being developed, which specifically target methylation (<xref rid="btu749-B29" ref-type="bibr">Yang <italic>et al</italic>., 2010</xref>).</p>
    <p>Bisulfite treatment of DNA followed by next-generation sequencing provides quantitative methylation data with base pair resolution. Unmethylated cytosines are deaminated into uracils, which amplify as thymines during PCR (<xref rid="btu749-B19" ref-type="bibr">Krueger <italic>et al</italic>., 2012</xref>). Reads are then aligned to a reference genome, permitting changes of C to T. The resulting counts of cytosine and thymine at registered cytosine loci form the basis of further analysis. This general procedure has been adapted in various ways, with reduced representation bisulfite sequencing (RRBS) being one of the most widely used. RRBS involves using a restriction enzyme such as MspI (or TaqI) to cleave the DNA at CCGG (or TCGA) loci and selecting short reads for sequencing (<xref rid="btu749-B16" ref-type="bibr">Gu <italic>et al</italic>., 2011</xref>). This results in greater coverage of CpG dense regions at lower cost.</p>
    <p>Several methods have been proposed to statistically test for differentially methylated region (DMRs). Almost all these methods perform a search for DMRs by testing individual cytosines followed by a post hoc aggregation procedure. Early methylation studies used Fisher's exact test (FET) to identify differentially methylated cytosines (DMCs) (<xref rid="btu749-B21" ref-type="bibr">Li <italic>et al</italic>., 2010</xref>; <xref rid="btu749-B7" ref-type="bibr">Challen <italic>et al</italic>., 2012</xref>). BSmooth (<xref rid="btu749-B17" ref-type="bibr">Hansen <italic>et al</italic>., 2012</xref>), one of the most widely used methods, performs local likelihood smoothing to generate methylation profiles for each sample, before testing individual locations in the profiles to identify DMCs. More recent methods, such as BiSeq (<xref rid="btu749-B18" ref-type="bibr">Hebestreit <italic>et al</italic>., 2013</xref>) and methylSig (<xref rid="btu749-B22" ref-type="bibr">Park <italic>et al</italic>., 2014</xref>), also employ local smoothing, together with a beta-binomial model of methylation at individual cytosines; both of these methods then aggregate the results of tests at individual loci to compute a measure of significance for DMRs. The beta-binomial method models biological variability at each cytosine location and hence requires a high replication level to achieve power. Coverage can also be problematic, as low coverage precludes statistical significance and high coverage can lead to over-confidence in calling DMRs, although the latter effect can be ameliorated by having a larger number of replicates. For instance, methylSig requires a minimum of three replicates per group and ignores loci which are covered by fewer than 10 reads by default. A recent method, MAGI (<xref rid="btu749-B2" ref-type="bibr">Baumann and Doerge, 2014</xref>), takes a different approach by testing directly for DMRs, rather than computing region-wide measures of significance from tests of individual cytosines. MAGI assumes the availability of genome-wide decision boundary methylation levels (which can be determined either from annotation or in a data-driven fashion). Methylation levels at each cytosine are then given a binary representation based on whether they exceed the decision boundary, and a single FET is performed over each region by counting how many cytosines have changed state.</p>
    <p>Although these methods can be highly effective, no current method explicitly accounts for spatial covariation (MAGI implicitly assumes spatial homogeneity across a region). DNA methylation levels are often strongly spatially correlated: accounting for such correlations in a testing procedure could then lead to considerable increases in statistical power. Some examples of spatially correlated changes in the ENCODE data analysed in Section 3.2 are shown in <xref ref-type="fig" rid="btu749-F1">Figure 1</xref> and <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Figure 1</ext-link>; notice that in all these examples, the change at individual cytosines is modest, and hence these regions would not be called as DMRs by currently existing methods. We remark that, although local smoothing methods like BSmooth (<xref rid="btu749-B17" ref-type="bibr">Hansen <italic>et al</italic>., 2012</xref>) attempt to capture spatial coherence, the local coherence is not an integral part of the testing procedure. Smoothing in this setting serves the dual purposes of filtering noise and highlighting large-scale changes in the methylation profile. Moreover, the shape of the methylation profile has been suggested as an important factor in predicting gene expression (<xref rid="btu749-B26" ref-type="bibr">VanderKraats <italic>et al</italic>., 2013</xref>), leading to a potentially functional role for methylation patterns. To our knowledge, there are no methods that test higher order properties, such as shape, of the methylation profiles over a region.
<fig id="btu749-F1" position="float"><label>Fig. 1.</label><caption><p>Methylation profiles of CpG clusters uniquely identified by the M<sup>3</sup>D method in a comparison of leukaemia (K562) and ESC cells, Sections 2.3 and 3.3. DMCs are not individually very different, yet the profile has changed shape in each case</p></caption><graphic xlink:href="btu749f1p"/></fig>
</p>
    <p>Here, we present maximum mean methylation discrepancy (M<sup>3</sup>D), a non-parametric statistical test for identifying DMRs from pre-defined regions, explicitly accounting for shape changes in methylation profiles. Our method is based on the maximum mean discrepancy (MMD), a recent technique from the machine learning literature, which tests whether two samples have been generated from the same probability distribution (<xref rid="btu749-B14" ref-type="bibr">Gretton <italic>et al</italic>., 2007</xref>, <xref rid="btu749-B15" ref-type="bibr">2012</xref>). Similar non-parametric tests have already been applied to ChIP-Seq and RNA-Seq data (<xref rid="btu749-B23" ref-type="bibr">Schweikert <italic>et al</italic>., 2013</xref>; <xref rid="btu749-B9" ref-type="bibr">Drewe <italic>et al</italic>., 2013</xref>). Our contribution is to adapt the method for the specific challenges of bisulfite sequencing data, introducing an explicit control for confounding changes in coverage levels. Our method is used to test for changes in methylation profiles across regions, as opposed to individual cytosines, and we call as DMRs those regions whose variation cannot be explained by inter-replicate variability. We demonstrate the performance of M<sup>3</sup>D against existing methods on real and simulated data, showing a considerable increase in power and improved robustness against reduced replication and coverage levels.</p>
  </sec>
  <sec>
    <title>2 Methods</title>
    <p>The M<sup>3</sup>D method is designed to analyse aligned methylation data. Rather than testing individual cytosines and pooling them into putative DMRs, M<sup>3</sup>D considers changes in the methylation profile’s shape over a given region. To quantify shape changes, we compute the MMD over each region and adjust it to account for changes in the coverage profile across samples. Finally, we use a data-driven approach to compare test statistics based on the empirical likelihood of observing between-group differences among replicates. We restrict our analysis to CpGs only and combine data from both strands.</p>
    <p>Selecting which regions to test is an important feature of a differential methylation study and must reflect the specific question being asked. Regions can either be pre-defined, such as a list of promoter regions, or generated from the data by selecting regions of dense CpGs (clusters) as in (<xref rid="btu749-B18" ref-type="bibr">Hebestreit <italic>et al</italic>., 2013</xref>). We keep this as a flexible option and instead focus on a general framework for region-based methylation analysis.</p>
    <sec>
      <title>2.1 Maximum mean discrepancy</title>
      <p>Formally, the MMD is defined as follows. Let <inline-formula><mml:math id="MM1"><mml:mi mathvariant="script" class="calligraphy">F</mml:mi></mml:math></inline-formula> be a class of functions <inline-formula><mml:math id="MM2"><mml:mrow><mml:mi>f</mml:mi><mml:mo>:</mml:mo><mml:mi mathvariant="script" class="calligraphy">X</mml:mi><mml:mo>→</mml:mo><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow></mml:math></inline-formula> over a metric space <inline-formula><mml:math id="MM3"><mml:mi mathvariant="script" class="calligraphy">X</mml:mi></mml:math></inline-formula> with Borel probability measures <italic>p</italic>, <italic>q</italic>. We define the MMD as
<disp-formula id="btu749-M1"><label>(1)</label><mml:math id="MM4"><mml:mrow><mml:mtext>MMD</mml:mtext><mml:mo stretchy="false">[</mml:mo><mml:mi mathvariant="script" class="calligraphy">F</mml:mi><mml:mo>,</mml:mo><mml:mi>p</mml:mi><mml:mo>,</mml:mo><mml:mi>q</mml:mi><mml:mo stretchy="false">]</mml:mo><mml:mo>=</mml:mo><mml:munder><mml:mrow><mml:mi>sup</mml:mi><mml:mo>⁡</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mo>∈</mml:mo><mml:mi mathvariant="script" class="calligraphy">F</mml:mi></mml:mrow></mml:munder><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>E</mml:mi></mml:mstyle><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>p</mml:mi></mml:mstyle></mml:msub><mml:mo stretchy="false">[</mml:mo><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">]</mml:mo><mml:mo>−</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>E</mml:mi></mml:mstyle><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>q</mml:mi></mml:mstyle></mml:msub><mml:mo stretchy="false">[</mml:mo><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">]</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></disp-formula>
Intuitively, we are finding the mean over a bounded function that maximizes the difference between the probability distributions. For a sufficiently dense function class, this is equal to 0 if, and only if, <italic>p</italic> = <italic>q</italic>. Choosing <inline-formula><mml:math id="MM5"><mml:mi mathvariant="script" class="calligraphy">F</mml:mi></mml:math></inline-formula> to be the unit ball in a reproducing kernel Hilbert space (RKHS) on <inline-formula><mml:math id="MM6"><mml:mi mathvariant="script" class="calligraphy">X</mml:mi></mml:math></inline-formula> provides a searchable class of functions that retains this result (<xref rid="btu749-B14" ref-type="bibr">Gretton <italic>et al</italic>., 2007</xref>). For <inline-formula><mml:math id="MM7"><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi><mml:mo>′</mml:mo></mml:mrow></mml:math></inline-formula>-independent random variables with distribution <italic>p</italic> and <inline-formula><mml:math id="MM8"><mml:mrow><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>′</mml:mo></mml:mrow></mml:math></inline-formula>-independent random variables with distribution <italic>q</italic>, the square of the MMD becomes:
<disp-formula id="btu749-M2"><label>(2)</label><mml:math id="MM9"><mml:mrow><mml:mtext>MM</mml:mtext><mml:msup><mml:mtext>D</mml:mtext><mml:mn>2</mml:mn></mml:msup><mml:mo stretchy="false">[</mml:mo><mml:mi mathvariant="script" class="calligraphy">F</mml:mi><mml:mo>,</mml:mo><mml:mi>p</mml:mi><mml:mo>,</mml:mo><mml:mi>q</mml:mi><mml:mo stretchy="false">]</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>E</mml:mi></mml:mstyle><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>p</mml:mi></mml:mstyle></mml:msub><mml:mo stretchy="false">[</mml:mo><mml:mi>k</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi><mml:mo>′</mml:mo><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">]</mml:mo><mml:mo>−</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>E</mml:mi></mml:mstyle><mml:mrow><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>p</mml:mi></mml:mstyle><mml:mo>,</mml:mo><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>q</mml:mi></mml:mstyle></mml:mrow></mml:msub><mml:mo stretchy="false">[</mml:mo><mml:mi>k</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">]</mml:mo><mml:mo>+</mml:mo><mml:msub><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>E</mml:mi></mml:mstyle><mml:mstyle mathvariant="bold" mathsize="normal"><mml:mi>q</mml:mi></mml:mstyle></mml:msub><mml:mo stretchy="false">[</mml:mo><mml:mi>k</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>y</mml:mi><mml:mo>,</mml:mo><mml:mi>y</mml:mi><mml:mo>′</mml:mo><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:math></disp-formula>
In practice, for <inline-formula><mml:math id="MM10"><mml:mrow><mml:mi>X</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="true">{</mml:mo><mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mn>....</mml:mn><mml:mo>,</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>m</mml:mi></mml:msub></mml:mrow><mml:mo stretchy="true">}</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mi>Y</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="true">{</mml:mo><mml:mrow><mml:msub><mml:mi>y</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mi>n</mml:mi></mml:msub></mml:mrow><mml:mo stretchy="true">}</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> observations independently and identically distributed from <italic>p</italic> and <italic>q</italic><italic>,</italic> respectively, we can compute a sample-based approximation to the MMD metric, giving rise to a feature representation in the RKHS, as
<disp-formula id="btu749-M3"><label>(3)</label><mml:math id="MM11"><mml:mrow><mml:mtext>MMD</mml:mtext><mml:mo stretchy="false">[</mml:mo><mml:mi>X</mml:mi><mml:mo>,</mml:mo><mml:mi>Y</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi><mml:mo stretchy="false">]</mml:mo><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo stretchy="true">[</mml:mo><mml:mrow><mml:mfrac><mml:mrow><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mi>x</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msup><mml:mi>m</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mn>2</mml:mn><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>n</mml:mi></mml:mrow></mml:mfrac><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi>y</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msup><mml:mi>n</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac></mml:mrow><mml:mo stretchy="true">]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mn>2</mml:mn></mml:mfrac></mml:mrow></mml:msup></mml:mrow></mml:math></disp-formula>
<disp-formula><mml:math id="MM12"><mml:mrow><mml:mtext>where</mml:mtext><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>m</mml:mi></mml:munderover><mml:mi>k</mml:mi></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mo>,</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:munderover><mml:mi>k</mml:mi></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>
<disp-formula><mml:math id="MM13"><mml:mrow><mml:mtext>and</mml:mtext><mml:msub><mml:mi>K</mml:mi><mml:mrow><mml:mi>y</mml:mi><mml:mi>y</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>n</mml:mi></mml:munderover><mml:mi>k</mml:mi></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></disp-formula>
</p>
    </sec>
    <sec>
      <title>2.2 The M<sup>3</sup>D statistic</title>
      <p>We represent a RRBS dataset as a set of vectors <italic>x<sub>i</sub></italic>, where each <italic>x<sub>i</sub></italic> is composed of the genomic location of a cytosine <italic>C<sub>i</sub></italic>, and the methylation status of that <italic>C<sub>i</sub></italic> on one mapped read, <inline-formula><mml:math id="MM14"><mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mtext>Meth</mml:mtext></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula>. Thus, there are as many <italic>x<sub>i</sub></italic>s in a dataset as the number of mapped cytosines (within a CpG context). To define an MMD between datasets, we need to define a kernel function operating on pairs of vectors <italic>x<sub>i</sub></italic>, <italic>x<sub>j</sub></italic> to evaluate <xref ref-type="disp-formula" rid="btu749-M3">Equation (3)</xref>. A natural choice is a composite kernel given by the product of a radial basis function (RBF) kernel on the genomic location and a string kernel on the methylation status:
<disp-formula id="btu749-M4"><label>(4)</label><mml:math id="MM15"><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mrow><mml:mtext>full</mml:mtext></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mrow><mml:mtext>RBF</mml:mtext></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mrow><mml:mtext>STR</mml:mtext></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></disp-formula>
<disp-formula id="btu749-M5"><label>(5)</label><mml:math id="MM16"><mml:mrow><mml:mtext>Where</mml:mtext><mml:msub><mml:mi>k</mml:mi><mml:mrow><mml:mtext>RBF</mml:mtext></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mtext>exp</mml:mtext><mml:mo stretchy="false">[</mml:mo><mml:mo>−</mml:mo><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>/</mml:mo><mml:mn>2</mml:mn><mml:msup><mml:mi>σ</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:math></disp-formula>
<disp-formula id="btu749-M6"><label>(6)</label><mml:math id="MM17"><mml:mrow><mml:mtext>and</mml:mtext><mml:msub><mml:mi>k</mml:mi><mml:mrow><mml:mtext>STR</mml:mtext></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="true">{</mml:mo><mml:mrow><mml:mtable><mml:mtr><mml:mtd><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mtext>if</mml:mtext><mml:msub><mml:mrow><mml:mtext>Meth</mml:mtext></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mtext>Meth</mml:mtext></mml:mrow><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mtext>otherwise</mml:mtext></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mrow></mml:mrow></mml:math></disp-formula>
</p>
      <p>The RBF kernel, <inline-formula><mml:math id="MM18"><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mrow><mml:mtext>RBF</mml:mtext></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> retains spatial information at a scale determined by the hyper-parameter <italic>σ</italic>, which corresponds to the distance along the genome that displays methylation correlation. We model this parameter independently for each region, <italic>R</italic>, to reflect the local correlation structure, as <inline-formula><mml:math id="MM19"><mml:mrow><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>R</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>=</mml:mo><mml:msup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo>¯</mml:mo></mml:mover><mml:mn>2</mml:mn></mml:msup><mml:mo>/</mml:mo><mml:mn>2</mml:mn><mml:mo>,</mml:mo><mml:mtext>for</mml:mtext><mml:mi>x</mml:mi><mml:mo>∈</mml:mo><mml:mi>R</mml:mi></mml:mrow></mml:math></inline-formula>, a heuristic suggested in (<xref rid="btu749-B15" ref-type="bibr">Gretton <italic>et al</italic>., 2012</xref>). Here, <inline-formula><mml:math id="MM20"><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:math></inline-formula> refers to the median distance of all observations in region <italic>R</italic> across the datasets being compared. MMD distances computed using the above procedure would capture both differences in coverage profiles and differences in methylation profiles. A particular challenge of bisulfite sequencing data, and a central tenet of the RRBS procedure (<xref rid="btu749-B16" ref-type="bibr">Gu <italic>et al</italic>., 2011</xref>), is that the frequency with which a cytosine site is tested (the coverage) is unrelated to the methylation status. This poses a challenge in all bisulfite sequencing analysis, as the sampling distribution becomes a confounding factor in our attempt to understand methylation. We control for changes in the coverage profile by subtracting the analogous MMD of the coverage; the M<sup>3</sup>D metric is then given by:
<disp-formula id="btu749-M7"><label>(7)</label><graphic xlink:href="btu749m7.jpg" position="float"/></disp-formula>
where <italic>k</italic><sub>full</sub> and <inline-formula><inline-graphic xlink:href="btu749i1.jpg"/></inline-formula> are as described in <xref ref-type="disp-formula" rid="btu749-M4">Equations (4)</xref> and <xref ref-type="disp-formula" rid="btu749-M5">(5)</xref> and the MMD terms are as in <xref ref-type="disp-formula" rid="btu749-M3">Equation (3)</xref>. Henceforth, we refer to the first term, <inline-formula><inline-graphic xlink:href="btu749i2.jpg"/></inline-formula> as the ‘full MMD’ and the second term, <inline-formula><inline-graphic xlink:href="btu749i3.jpg"/></inline-formula>, as the ‘coverage MMD’ for convenience.</p>
      <p>The last term in <xref ref-type="disp-formula" rid="btu749-M7">Equation (7)</xref> represents the MMD of the data on a methylation-blind subspace. This implies that, in the large sample limit when the sample estimate of the MMD converges to the exact MMD of <xref ref-type="disp-formula" rid="btu749-M1">Equation (1)</xref>, the M<sup>3</sup>D statistic is non-negative.</p>
      <p>The M<sup>3</sup>D statistic will therefore be different from zero when there is a change in the methylation profile, independently of a change in the coverage profile. As a consequence, M<sup>3</sup>D between replicate RRBS experiments (which do not necessarily have identical coverage) should be close to zero or, equivalently, the full MMD should be equal to the coverage MMD. This is borne out in the data; the metrics strongly agree over replicates. Testing equality of metrics over 102 ENCODE RRBS datasets gives an <italic>R</italic><sup>2</sup> of 0.95. This can be seen in <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Figure 2</ext-link>; specific examples can also be seen in <xref ref-type="fig" rid="btu749-F2">Figures 2</xref>(a–c) and 4(a–c), where the dense region around the diagonal represents unchanged DMRs with M<sup>3</sup>D close to zero.
<fig id="btu749-F2" position="float"><label>Fig. 2.</label><caption><p>Simulation results. (<bold>a–c</bold>) We plot here the coverage MMD against the full MMD metric for all methods. The M<sup>3</sup>D test statistic is their difference, the distance in the x axis from the diagonal line. Each point is a CpG cluster, with black points being unchanged. DMRs are shaded according to whether they are called (M<sup>3</sup>D) or missed (BSmooth). (<bold>a</bold>) M<sup>3</sup>D identifies a clear relationship and calls almost all the clusters. (<bold>b</bold>) BSmooth calls some of the clusters but makes both types of error (<xref ref-type="table" rid="btu749-T1">Table 1</xref>). Classification bears little resemblance to the M<sup>3</sup>D method. (<bold>c</bold>) MAGI calls fewer regions, again with little semblance to the M<sup>3</sup>D method. (<bold>d</bold>) Histogram of test statistics for replicate values (blue) and with simulated changes (red), log scale</p></caption><graphic xlink:href="btu749f2p"/></fig>
</p>
    </sec>
    <sec>
      <title>2.3 P-value calculation</title>
      <p>We use the M<sup>3</sup>D as a test statistic by comparing the values observed across groups to those observed between replicates. We define our null distribution as the observed M<sup>3</sup>D values over all the testing regions between all replicate pairs. For a given region <italic>r</italic>, we compute the mean, <italic>μ<sub>r</sub></italic> of the M<sup>3</sup>D values over all sample pairs across testing groups for <italic>r</italic>. The <italic>P</italic> value for <italic>r</italic> is the probability of observing <italic>μ<sub>r</sub></italic> or higher among the null distribution. We use the Benjamini–Hochberg procedure to calculate false discovery rates (FDRs), rejecting clusters at a 1% significance level (<xref rid="btu749-B3" ref-type="bibr">Benjamini and Hochberg, 1995</xref>). Because each test corresponds to an entire region, this correction is less punitive than methods testing each cytosine location.</p>
      <p>In general, we calculate the <italic>P</italic> value empirically. In order for the method to scale, we also provide a model-based approximation by fitting an exponential distribution to the 95th percentile of the null distribution. <italic>P</italic> values are calculated in the same manner using the fitted exponential. An example is shown in <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Figure 3</ext-link>.</p>
      <p>At a given FDR cut-off, identifying DMRs amounts to identifying a threshold M<sup>3</sup>D value, <italic>t</italic><sub>fdr</sub> and calling all regions <italic>r</italic> with <inline-formula><mml:math id="MM25"><mml:mrow><mml:msub><mml:mi>μ</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:mo>&gt;</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow><mml:mtext>fdr</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula>. We find the empirical method to be marginally more accurate (<xref ref-type="fig" rid="btu749-F3">Fig. 3</xref>) and report results with empirically calculated <italic>P</italic> values for the rest of this paper.
<fig id="btu749-F3" position="float"><label>Fig. 3.</label><caption><p>ROC curve. Here, we plot the true positive rate against the FDR for each method, reflecting the proportion of regions called at each FDR. From highest to lowest, we see M<sup>3</sup>D with empirical <italic>P</italic>-values, M<sup>3</sup>D with modelled <italic>P</italic>-values and MAGI. AUCs for the methods are 0.99, 0.96 and 0.77, respectively</p></caption><graphic xlink:href="btu749f3p"/></fig>
</p>
    </sec>
  </sec>
  <sec>
    <title>3 Datasets</title>
    <p>We benchmarked the M<sup>3</sup>D method on a simulated dataset and two real datasets. We briefly describe here the two real datasets and the simulation procedure used. Summary statistics and figures of the testing regions are shown in Section 4 of the <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Data</ext-link>.</p>
    <sec>
      <title>3.1 Simulated data</title>
      <p>To benchmark the ability of our method to detect true changes without introducing false positives, we resort to a simulation study. To simulate methylation profile changes with realistic statistics, we constructed our simulation from a real RRBS dataset.</p>
      <p>We used an RRBS dataset of human embryonic stem cells, H1-hESC (described in the following section), consisting of two replicates. Dense CpG regions were identified using the procedure by <xref rid="btu749-B18" ref-type="bibr">Hebestreit <italic>et al</italic>., (2013)</xref>, and for simplicity, we focused on the first 1000 on chromosome 1. We then simulated two more replicates to act as our testing group, as described in Section 5 of the <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Data</ext-link>. The coverage statistics for the resulting dataset have a mean of 34.5 and a median coverage of 23 at each CpG site. We then selectively altered the methylation profile of randomly chosen regions in the simulated replicates to create known methylation changes and used the M<sup>3</sup>D method to test for DMRs.</p>
      <p>To simulate methylation changes, we randomly selected 250 of the CpG clusters out of a possible 1000. We selected a short region within each cluster, at least 100-bp long and with a total coverage of at least 100, in each replicate. If necessary, we increased the size of the region until it occupied at least <italic>n</italic> CpG sites, where <italic>n</italic> was uniformly sampled from [4,20]. The methylation level, <inline-formula><mml:math id="MM26"><mml:mrow><mml:msubsup><mml:mi>L</mml:mi><mml:mi>i</mml:mi><mml:mrow><mml:mtext>old</mml:mtext></mml:mrow></mml:msubsup></mml:mrow></mml:math></inline-formula>, was calculated at each cytosine site, <italic>C<sub>i</sub></italic> as the proportion of all the data points mapping to that site that were methylated. We measured the mean methylation of the sites and created a simulated methylation level, <inline-formula><mml:math id="MM27"><mml:mrow><mml:msubsup><mml:mi>L</mml:mi><mml:mi>i</mml:mi><mml:mrow><mml:mtext>new</mml:mtext></mml:mrow></mml:msubsup></mml:mrow></mml:math></inline-formula>, by hyper-methylating the region if it was &lt;50% methylated on average and hypo-methylating it otherwise. The degree of methylation change was controlled by a parameter <inline-formula><mml:math id="MM28"><mml:mrow><mml:mi>α</mml:mi><mml:mo>∈</mml:mo><mml:mo stretchy="false">[</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:math></inline-formula>, such that the new methylation level <inline-formula><mml:math id="MM29"><mml:mrow><mml:msubsup><mml:mi>L</mml:mi><mml:mi>i</mml:mi><mml:mrow><mml:mtext>new</mml:mtext></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mi>α</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msubsup><mml:mi>L</mml:mi><mml:mi>i</mml:mi><mml:mrow><mml:mtext>old</mml:mtext></mml:mrow></mml:msubsup><mml:mo>+</mml:mo><mml:mi>α</mml:mi></mml:mrow></mml:math></inline-formula> if the region was being hyper-methylated and <inline-formula><mml:math id="MM30"><mml:mrow><mml:msubsup><mml:mi>L</mml:mi><mml:mi>i</mml:mi><mml:mrow><mml:mtext>new</mml:mtext></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mi>α</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msubsup><mml:mi>L</mml:mi><mml:mi>i</mml:mi><mml:mrow><mml:mtext>old</mml:mtext></mml:mrow></mml:msubsup></mml:mrow></mml:math></inline-formula> if it was being hypo-methylated. To vary the strength of methylation change, we tested the methods different values of alpha.</p>
      <p>Simulated data were then created by sampling data points <inline-formula><mml:math id="MM31"><mml:mrow><mml:mrow><mml:mo stretchy="true">{</mml:mo><mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow><mml:mo stretchy="true">}</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> at site <italic>C<sub>i</sub></italic> with corresponding <inline-formula><mml:math id="MM32"><mml:mrow><mml:mrow><mml:mo stretchy="true">{</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mtext>Meth</mml:mtext></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mtext>Meth</mml:mtext></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow><mml:mo stretchy="true">}</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> sampled with probability <inline-formula><mml:math id="MM33"><mml:mrow><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mtext>Meth</mml:mtext></mml:mrow><mml:mi>j</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mtext>methylated</mml:mtext><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msubsup><mml:mi>L</mml:mi><mml:mi>i</mml:mi><mml:mrow><mml:mtext>new</mml:mtext></mml:mrow></mml:msubsup></mml:mrow></mml:math></inline-formula>, where <italic>n<sub>i</sub></italic> is the coverage at location <italic>C<sub>i</sub></italic>. Pseudocode for creating simulated data is shown in Section 5 of the <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Data</ext-link>.</p>
    </sec>
    <sec>
      <title>3.2 Human data</title>
      <p>To test the M<sup>3</sup>D method on real data, we compared two Tier 1 tracks from the ENCODE consortium, GEO series GSE27584 (<xref rid="btu749-B10" ref-type="bibr">ENCODE Project Consortium <italic>et al</italic>., 2012</xref>). RRBS data from human embryonic stem cells, H1-hESC, were compared against leukaemia cells, K562. Both datasets were produced by the Myers Lab at the HudsonAlpha Institute for Biotechnology. The data are available pre-processed and aligned to the hg19 genome, and we used the resulting BED files. H1-hESC cells came from a human male and K562 from a female, so sex chromosomes were removed from the analysis. Testing regions were defined by clustering CpG sites in the same manner as for the simulations, and regions with no coverage in at least one sample were excluded from the analysis; this resulted in 14,104 genomic regions for testing.</p>
      <p>To investigate the relationship between differential methylation and gene expression, we used the corresponding 200-bp paired end RNA-seq data for H1-ESC and K562 cells available in release 4 of the ENCODE consortium (<xref rid="btu749-B10" ref-type="bibr">ENCODE Project Consortium <italic>et al</italic>., 2012</xref>). Reads were aligned using TopHat and gene expression estimates in fragments per kilobase of transcript per million mapped reads (FPKM) were produced with Cufflinks (<xref rid="btu749-B25" ref-type="bibr">Trapnell <italic>et al</italic>., 2012</xref>). Gene expression estimates were averaged across the three replicates within each group and analysis was performed on the resulting changes across groups.</p>
    </sec>
    <sec>
      <title>3.3 Mouse data</title>
      <p>We compared a 4 replicate data RRBS data set from mouse strain B6C ESCs (GEO: GSE56572, <xref rid="btu749-B5" ref-type="bibr">Booth <italic>et al</italic>., 2014</xref>) to a 3 replicate data set consisting from sciatic nerve cells from postnatal day 10 (P10) mice (GEO: GSE45343, <xref rid="btu749-B27" ref-type="bibr">Varela-Rey <italic>et al</italic>., 2014</xref>). To define testing regions, we used the list of exons for Mus musculus provided by Ensembl in release 75 (<xref rid="btu749-B11" ref-type="bibr">Flicek <italic>et al</italic>., 2013</xref>). We excluded any exon regions with no coverage in one of the ESC cell samples or with &lt;5 CpG sites in total, leaving 2359 regions in total. Again, data from both strands were combined. The median coverage at the remaining CpG loci was 24 for the ESCs and 11 for the P10 sciatic nerve cells.</p>
    </sec>
  </sec>
  <sec>
    <title>4 Results</title>
    <sec>
      <title>4.1 Simulations</title>
      <p>We first benchmarked our method on a realistic simulated dataset generated as described in Section 3.1. Results were compared against BSmooth and MAGI. BiSeq and methylSig were also considered; however, because the dataset had lower replication than the minimum recommended by the authors, we decided not to use them. BSmooth was designed for whole-genome bisulfite sequencing (WGBS) data; to adapt the method to RRBS data, we followed the authors’ suggestion and altered the maximum allowable distance between neighbouring cytosines before smoothing (bioconductor mailing list: <ext-link ext-link-type="uri" xlink:href="https://stat.ethz.ch/pipermail/bioconductor/2013-February/051020.html">https://stat.ethz.ch/pipermail/bioconductor/2013-February/051020.html</ext-link>). Details for implementation of BSMooth and MAGI are provided in Section 6 of the <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Data</ext-link>.</p>
      <p><xref ref-type="fig" rid="btu749-F2">Figure 2</xref> summarizes the results obtained with the methylation strength parameter <italic>α</italic> (see Section 3.1) set to 1. Of the 250 differently methylated regions, the M<sup>3</sup>D method called 232, with no falsely called DMRs. <xref ref-type="fig" rid="btu749-F2">Figures 2</xref>(a–c) show scatterplots of coverage MMD on the <italic>y</italic> axis versus full MMD on the <italic>x</italic> axis for all 1000 regions, with colours denoting the results of the testing procedure using the different statistics. Individual regions are represented as circles, coloured according to whether the region was a true positive (green), a false positive (red), a false negative (blue) or a true negative (black). As discussed before, changes in methylation are likely to occur for regions that are mapped far from the diagonal. The figures show a clear cluster of regions about the diagonal (the unchanged regions) and a clearly identifiable group with much larger full MMD (the changed regions). <xref ref-type="fig" rid="btu749-F2">Figure 2</xref>a shows the results of the testing procedure using the M<sup>3</sup>D statistic. As we see, M<sup>3</sup>D correctly identifies most of the 250 simulated changes. Receiver-operating characteristic (ROC) curves are shown in <xref ref-type="fig" rid="btu749-F3">Figure 3</xref>. Note that BSmooth is omitted as the method does not test regions as a whole, rather identifies groups of DMCs within the region and hence does not output a relevant statistic for comparison.</p>
      <p>We present the results of BSmooth and MAGI in same framework in <xref ref-type="fig" rid="btu749-F2">Figure 2</xref>(b and c). BSmooth correctly called 67 of the regions with an additional 10 false positives, typically calling regions with similar coverage profile, which we expect is due to the effect of local likelihood smoothing. <xref ref-type="fig" rid="btu749-F2">Figure 2</xref>b shows the BSmooth results; as we see, even regions with very marked shape differences (as quantified by M<sup>3</sup>D) were missed, which is to be expected as BSmooth does not include spatial correlations in the testing procedure. MAGI called 211 of the regions correctly, with two false positives (the FDR was set to 1%). <xref ref-type="fig" rid="btu749-F2">Figure 2</xref>c shows that while many of the regions missed had a low M<sup>3</sup>D statistic, this was not always the case and there is not a simple relationship between the two methods indicating that the M<sup>3</sup>D method performs a genuinely different computation, as opposed to simply being more powerful. A histogram of the M<sup>3</sup>D test statistic is shown in <xref ref-type="fig" rid="btu749-F2">Figure 2</xref>d for the replicates and the cross-group comparisons. The empirical testing distribution is shown in blue and is seen to be consistent around zero and sharply peaked. The simulated DMRs are easily distinguished.</p>
      <p>We then investigated the sensitivity of our method by systematically altering the strength of the methylation changes using <inline-formula><mml:math id="MM34"><mml:mrow><mml:mi>α</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mn>0.8</mml:mn><mml:mo>,</mml:mo><mml:mn>0.6</mml:mn><mml:mtext> and </mml:mtext><mml:mn>0.4</mml:mn></mml:mrow></mml:math></inline-formula>. We compared the M<sup>3</sup>D method with BSmooth and MAGI and our results are listed in <xref ref-type="table" rid="btu749-T1">Table 1</xref>. The M<sup>3</sup>D method maintains a very creditable performance level for all the <italic>α</italic> values. This is due to the fact that neighbouring cytosines are being altered, and hence there are spatial correlations in the changes. Were the changes scattered randomly in the region M<sup>3</sup>D performance would weaken, whereas MAGI would remain robust. The sudden dip in performance of MAGI at <inline-formula><mml:math id="MM35"><mml:mrow><mml:mi>α</mml:mi><mml:mo>=</mml:mo><mml:mn>0.4</mml:mn></mml:mrow></mml:math></inline-formula> is due to fewer of the cytosines’ methylation levels crossing the threshold value. It is remarkable that at all levels of <italic>α</italic> the use of the M<sup>3</sup>D statistic does not lead to any type I errors, though we note that the other methods have consistent type 2 error levels across these tests.
<table-wrap id="btu749-T1" position="float"><label>Table 1.</label><caption><p>Simulation results: sensitivity to low methylation changes</p></caption><table frame="hsides" rules="groups"><thead align="left"><tr><th rowspan="1" colspan="1">Alpha</th><th colspan="3" rowspan="2" align="center">1 (0.96, 0.10)<hr/></th><th colspan="3" rowspan="2" align="center">0.8 (0.76, 0.15)<hr/></th><th colspan="3" rowspan="2" align="center">0.6 (0.57, 0.16)<hr/></th><th colspan="3" rowspan="2" align="center">0.4 (0.38, 0.15)<hr/></th></tr><tr><th rowspan="1" colspan="1">Meth change (mean, SD)</th></tr><tr><th rowspan="1" colspan="1"/><th rowspan="1" colspan="1">M<sup>3</sup>D</th><th rowspan="1" colspan="1">BS</th><th rowspan="1" colspan="1">MAGI</th><th rowspan="1" colspan="1">M<sup>3</sup>D</th><th rowspan="1" colspan="1">BS</th><th rowspan="1" colspan="1">MAGI</th><th rowspan="1" colspan="1">M<sup>3</sup>D</th><th rowspan="1" colspan="1">BS</th><th rowspan="1" colspan="1">MAGI</th><th rowspan="1" colspan="1">M<sup>3</sup>D</th><th rowspan="1" colspan="1">BS</th><th rowspan="1" colspan="1">MAGI</th></tr></thead><tbody align="left"><tr><td rowspan="1" colspan="1">Correct</td><td align="char" char="." rowspan="1" colspan="1">232</td><td align="char" char="." rowspan="1" colspan="1">67</td><td align="char" char="." rowspan="1" colspan="1">211</td><td align="char" char="." rowspan="1" colspan="1">231</td><td align="char" char="." rowspan="1" colspan="1">65</td><td align="char" char="." rowspan="1" colspan="1">205</td><td align="char" char="." rowspan="1" colspan="1">210</td><td align="char" char="." rowspan="1" colspan="1">66</td><td align="char" char="." rowspan="1" colspan="1">201</td><td align="char" char="." rowspan="1" colspan="1">197</td><td align="char" char="." rowspan="1" colspan="1">66</td><td align="char" char="." rowspan="1" colspan="1">157</td></tr><tr><td rowspan="1" colspan="1">Type 1</td><td align="char" char="." rowspan="1" colspan="1">0</td><td align="char" char="." rowspan="1" colspan="1">10</td><td align="char" char="." rowspan="1" colspan="1">2</td><td align="char" char="." rowspan="1" colspan="1">0</td><td align="char" char="." rowspan="1" colspan="1">7</td><td align="char" char="." rowspan="1" colspan="1">2</td><td align="char" char="." rowspan="1" colspan="1">0</td><td align="char" char="." rowspan="1" colspan="1">10</td><td align="char" char="." rowspan="1" colspan="1">2</td><td align="char" char="." rowspan="1" colspan="1">0</td><td align="char" char="." rowspan="1" colspan="1">10</td><td align="char" char="." rowspan="1" colspan="1">0</td></tr><tr><td rowspan="1" colspan="1">Type 2</td><td align="char" char="." rowspan="1" colspan="1">18</td><td align="char" char="." rowspan="1" colspan="1">183</td><td align="char" char="." rowspan="1" colspan="1">39</td><td align="char" char="." rowspan="1" colspan="1">19</td><td align="char" char="." rowspan="1" colspan="1">185</td><td align="char" char="." rowspan="1" colspan="1">45</td><td align="char" char="." rowspan="1" colspan="1">40</td><td align="char" char="." rowspan="1" colspan="1">184</td><td align="char" char="." rowspan="1" colspan="1">49</td><td align="char" char="." rowspan="1" colspan="1">53</td><td align="char" char="." rowspan="1" colspan="1">184</td><td align="char" char="." rowspan="1" colspan="1">93</td></tr></tbody></table><table-wrap-foot><fn id="btu749-TF1"><p>For various values of alpha, we show the corresponding mean and standard deviation of the methylation level (the total methylated reads divided by coverage at each CpG) change for the altered CpG sites and the results of testing the three methods. MMD outperforms BSmooth and MAGI.</p></fn></table-wrap-foot></table-wrap></p>
      <p>To assess the sensitivity of the various methods to spatial correlations, we ran a further simulation, this time adding a ‘Gaussian bump’ of to the methylation profiles of the regions, at randomly chosen locations, with varying widths and strengths. Details are described in Section 5 of the <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Data</ext-link>. Here, we found a more marked contrast in the performance of the methods, which we show in <xref ref-type="table" rid="btu749-T2">Table 2</xref>. ROC curves are shown in Section 7 of the <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Data</ext-link>.
<table-wrap id="btu749-T2" position="float"><label>Table 2.</label><caption><p>Sim: Gaussian bump</p></caption><table frame="hsides" rules="groups"><thead align="left"><tr><th rowspan="1" colspan="1"/><th rowspan="1" colspan="1">M<sup>3</sup>D</th><th rowspan="1" colspan="1">BS</th><th rowspan="1" colspan="1">MAGI</th></tr></thead><tbody align="left"><tr><td rowspan="1" colspan="1">Correct</td><td align="char" char="." rowspan="1" colspan="1">190</td><td align="char" char="." rowspan="1" colspan="1">58</td><td align="char" char="." rowspan="1" colspan="1">102</td></tr><tr><td rowspan="1" colspan="1">Type 1</td><td align="char" char="." rowspan="1" colspan="1">0</td><td align="char" char="." rowspan="1" colspan="1">11</td><td align="char" char="." rowspan="1" colspan="1">1</td></tr><tr><td rowspan="1" colspan="1">Type 2</td><td align="char" char="." rowspan="1" colspan="1">60</td><td align="char" char="." rowspan="1" colspan="1">192</td><td align="char" char="." rowspan="1" colspan="1">148</td></tr></tbody></table><table-wrap-foot><fn id="btu749-TF2"><p>Results for adding a Gaussian bump to the methylation levels. Despite the overall change being smaller, M<sup>3</sup>D retains good performance by considering spatial correlations in the data.</p></fn></table-wrap-foot></table-wrap></p>
    </sec>
    <sec>
      <title>4.2 Human data</title>
      <p>We now describe the results of comparing two human datasets generated by the ENCODE consortium (see Section 3.2). We focus on three aspects: a general comparison of results between M<sup>3</sup>D and BSmooth, an analysis of the robustness of the results with respect to the coverage and an analysis of the functional relevance of our results.</p>
    </sec>
    <sec>
      <title>4.3 DMR detection</title>
      <p>Out of the 14,104 CpG regions selected for testing (see Section 3.2), M<sup>3</sup>D identified 4137 DMRs, and BSmooth and MAGI identified 1649 and 3101 DMRs, agreeing on 1328 and 2353 of the regions, respectively. In <xref ref-type="fig" rid="btu749-F4">Figure 4</xref>, we present the results in the same form as <xref ref-type="fig" rid="btu749-F2">Figure 2</xref>, where we again see that the M<sup>3</sup>D method produces genuinely different results. <xref ref-type="fig" rid="btu749-F4">Figure 4</xref>a shows the method applied to the replicates only, where the methylation-blind and aware metrics agree. <xref ref-type="fig" rid="btu749-F4">Figure 4</xref>(b and c) show the results of between-group testing by M<sup>3</sup>D and BSmooth, respectively. The data have a striking similarity to <xref ref-type="fig" rid="btu749-F2">Figure 2</xref>a; this suggests that, on this real dataset, the M<sup>3</sup>D statistic provides an excellent measure of changes in methylation profiles. Similar to the simulated dataset, BSmooth does not behave in a consistent manner with respect to the M<sup>3</sup>D test statistic and many CpG clusters are missed (<xref ref-type="fig" rid="btu749-F4">Fig. 4</xref>c). A histogram of the M<sup>3</sup>D test statistics is shown in <xref ref-type="fig" rid="btu749-F4">Figure 4</xref>d, again confirming that the M<sup>3</sup>D statistics identifies a clear group of changed profiles between the two conditions. Comparisons to MAGI are shown in Section 8 of the <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Data</ext-link>.
<fig id="btu749-F4" position="float"><label>Fig. 4.</label><caption><p>H1-hESC versus K562 Cells. Black dots are uncalled clusters, red are called. (<bold>a</bold>) Just the inter-replicate metrics are shown, for comparison with <xref ref-type="fig" rid="btu749-F2">Figure 2</xref>. (<bold>b</bold>) Between-group clusters as called by M<sup>3</sup>D. (<bold>c</bold>) BSmooth identifies far fewer. Axes show the full and coverage MMD. Classification bears little resemblance to the M<sup>3</sup>D method. (<bold>d</bold>) The histogram of test statistics</p></caption><graphic xlink:href="btu749f4p"/></fig>
</p>
      <sec>
        <title>4.3.1 Robustness to low coverage</title>
        <p>To test the consistency of the M<sup>3</sup>D method to low coverage, we simulated a reduction in the coverage levels of the H1-hESC and K562 data. We discarded at random reads for the datasets to simulate a reduction in coverage by 75%, 50% and 25% in both datasets. The M<sup>3</sup>D method was used to find DMRs, and the results were compared across coverage levels; to alleviate the computational burden, we only considered CpG regions on chromosome 1.</p>
        <p>Of the 1345 CpG clusters on chromosome 1, the M<sup>3</sup>D method identified 403 DMRs. Reducing coverage to 75%, 50% and 25% of the original level, the method identified 395, 399 and 386 DMRs, respectively, with 0, 1 and 1 DMRs not in the original set. To see the consistency of the calls, we show a Venn diagram in <xref ref-type="fig" rid="btu749-F5">Figure 5</xref>. There is a strong overlap in the calls at all levels, indicating robustness in the method. Interestingly, although fewer regions are called at lower coverage levels, at each stage we do not see many new regions being called as might be expected. Although the empirical testing distribution is less accurate, the structure remains intact. Both BSmooth and MAGI showed similar consistency, although the number of regions called was lower in both cases. Results are shown in Section 9 of the <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Data</ext-link>.
<fig id="btu749-F5" position="float"><label>Fig. 5.</label><caption><p>Venn diagram of calls with reduced coverage. Three-hundred eighty-two calls are consistent at all coverage levels. The method misses clusters at lower coverage levels, yet it does not call many DMRs that were not identified at higher coverage levels</p></caption><graphic xlink:href="btu749f5p"/></fig>
</p>
      </sec>
      <sec>
        <title>4.3.2 Functional analysis of differential methylation regions</title>
        <p>To investigate the functional relevance of our results, we interpreted the called DMRs in terms of the functional annotation and expression level of nearby genes. We used three sets of genomic regions, gene bodies, first exons and promoters; gene and exon regions were downloaded from Ensembl release 75 (<xref rid="btu749-B11" ref-type="bibr">Flicek <italic>et al</italic>., 2013</xref>) and promoter regions were defined as being 2000 bp upstream from the transcription start site. Tests were run on gene, promoter and first exon regions separately. We excluded regions with fewer than 5 CpGs and tested the remaining regions for changes in the methylation profiles using the M<sup>3</sup>D method.</p>
        <p>As the M<sup>3</sup>D method provides a measure of the strength, but not direction of the methylation profile change, we measured the cross group expression change as the absolute value of the FPKM log-fold change and excluded all genes with &lt;100 FPKM in one sample to avoid noise at low expression levels.</p>
        <p>We identified 8747 gene body regions with sufficient expression and CpG content; among these, the M<sup>3</sup>D method called 404 as DMRs. We tested the absolute log-fold changes in expression between called and uncalled regions with a Wilcoxon rank-sum test and found the former was higher (<italic>P</italic> value: <inline-formula><mml:math id="MM36"><mml:mrow><mml:mn>2.2</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mrow><mml:mn>10</mml:mn></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>16</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math></inline-formula>). Similarly, 103 of 4916 promoter regions were called as DMRs and showed an associated higher absolute log-fold expression change (Wilcoxon rank-sum test, <italic>P</italic> value: <inline-formula><mml:math id="MM37"><mml:mrow><mml:mn>1.18</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mrow><mml:mn>10</mml:mn></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math></inline-formula>). Rather more first exon regions were tested, with 411 of 19 473 regions being called as DMRs. Again, there was an associated increase in the log-fold expression change (Wilcoxon rank-sum test, <italic>P</italic> value: <inline-formula><mml:math id="MM38"><mml:mrow><mml:mn>2.2</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mrow><mml:mn>10</mml:mn></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>16</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math></inline-formula>). None of the 411 first exon DMRs were in the gene bodies of the gene region testing group, hence this is not a duplicate result. The median log-fold expression change for genes associated with uncalled regions was 0.15 for gene, promoter and first exon regions. In genes associated with called promoter regions, this rose to 0.24, and in genes and first exon regions, the median was 0.37 and 0.34, respectively (<ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Figure 12</ext-link>). These results support earlier studies outlining a stronger link between methylation in the first exon, as opposed the promoter region and gene expression (<xref rid="btu749-B6" ref-type="bibr">Brenet <italic>et al</italic>., 2011</xref>).</p>
        <p>We performed an enrichment analysis for gene ontology (GO) terms using the Ontologizer software for the gene, promoter and first exon regions separately (<xref rid="btu749-B1" ref-type="bibr">Bauer <italic>et al</italic>., 2008</xref>). In each case, the population group was chosen to be the set of genes associated with the regions being tested, i.e. those with sufficient coverage and CpG counts, and the study group was the set of genes associated with the called regions. For this study, we examined the DMRs called by the M<sup>3</sup>D method against all the regions tested, independently of gene expression data. We used parent–child analysis and adjusted <italic>P</italic> values according with a Benjamini-Hochberg procedure at 10% FDR.</p>
        <p>For the gene regions, we tested 2,692 called genes against 15,321 tested genes resulting in 208 GO terms being called. Among these, GO terms for embryonic morphogenesis, organ formation, growth, developmental growth, regulation of cell differentiation, pattern specification process and cell fate commitment were discovered, as might be expected in a comparison between ESCs and fully mature K562 cells. This suggests a connection between gene body methylation and cell function.</p>
        <p>The first exon group was smaller, with 1,087 called gene associations in a population of 10,811. Thirty-one GO terms were statistically significantly enriched. Twenty-four of these terms were also enriched in the gene region analysis. Again, terms associated with cell differentiation, such as cell fate specification and cell fate commitment, were observed. This is striking, because these first exons were not in gene bodies of the gene testing regions.</p>
        <p>The promoter group had 506 gene associations called out of a population of 8,114. Interestingly, we found no statistically significantly enriched GO terms in the analysis. The top 10 enriched GO terms, by statistical significance, are shown in <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">Supplementary Tables 1</ext-link>, <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">2</ext-link> and <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu749/-/DC1">3</ext-link> in Section 11 for the three types of genomic regions tested.</p>
      </sec>
    </sec>
    <sec>
      <title>4.4 Mouse data</title>
      <p>To examine the robustness of the M<sup>3</sup>D statistic to changes in replication, we considered a comparison between two mouse datasets with larger replication, the ESCs dataset of (<xref rid="btu749-B5" ref-type="bibr">Booth <italic>et al</italic>., 2014</xref>) with four replicates and the neural dataset of <xref rid="btu749-B27" ref-type="bibr">Varela-Rey <italic>et al</italic>. (2014)</xref> with three replicates. Robustness to low replication is important; as remarked before, although many methods require at least three replicates in each dataset, many experimental protocols (including almost all the ENCODE RRBS data) provide only two replicates. We used the M<sup>3</sup>D method to identify DMRs with three and with two ESC replicates, and compared the set to those identified with the full four ESC replicate sets. DMRs were identified at a 1% FDR.</p>
      <p>Of the 2359 exon regions tested, the M<sup>3</sup>Ds method identified 689, 676 and 609 with methylation profiles that differed significantly with respect to inter-replicate variation with 4, 3 and 2 replicates in the ESC group, respectively. As is shown in <xref ref-type="fig" rid="btu749-F6">Figure 6</xref>, the overlap between the three sets of called regions accounts for almost 90% of the total. Importantly, although the testing lost power with lower replication (as can be expected), only one additional region was called, indicating that the method does not introduce many false positives with reduced replication levels.
<fig id="btu749-F6" position="float"><label>Fig. 6.</label><caption><p>Venn diagram of calls with fewer replicates, for the case of four, three and two replicates for ESC cell control group</p></caption><graphic xlink:href="btu749f6p"/></fig>
</p>
    </sec>
    <sec>
      <title>4.5 Computing times</title>
      <p>We report the running times for non-parallel implementations of all methods on the dataset used in Sections 3.2 and 4.3. This dataset represents a complete RRBS experiment consisting of 14,104 testing regions. On an ordinary desktop PC, MAGI took ∼30 s, BSmooth took almost 6 min (including smoothing) and M<sup>3</sup>D took ∼2 h. The M<sup>3</sup>D algorithm is linear in the number of testing regions and combinatorial in the number of replicates.</p>
    </sec>
  </sec>
  <sec>
    <title>5 Discussion</title>
    <p>We proposed the first kernel-based test for DMRs which exploits higher order spatial features of methylation profiles. Empirical comparisons on simulated and real data show a considerable increase in statistical power in comparison with the widely used BSmooth method (<xref rid="btu749-B17" ref-type="bibr">Hansen <italic>et al</italic>., 2012</xref>), as well as considerable robustness to low coverage and low replication. The M<sup>3</sup>D method also outperforms MAGI (<xref rid="btu749-B2" ref-type="bibr">Baumann and Doerge, 2014</xref>) in our simulations, as well as calling more DMRs in the real dataset, though this comes at a computational cost.</p>
    <p>The increased power of the M<sup>3</sup>D approach is due to a number of factors. Firstly, the method is sensitive to spatially correlated changes in methylation profiles. Methylation profiles are known to be highly spatially correlated in general, and the results of our experiments imply that spatial correlation is also a feature of differences in methylation profiles between conditions, at least in the datasets considered. Secondly, the method explicitly accounts for differences in the coverage profiles between conditions, a confounding factor for other methods, as demonstrated in <xref ref-type="fig" rid="btu749-F2">Figure 2</xref>. Thirdly, the method models inter-replicate variability on a regional basis along the whole genome. Each regional cross-group methylation change is compared with this distribution, and test statistics for each region represent how well the change in methylation profiles can be explained by inter-replicate variability. At present, other methods that consider inter-replicate variability do so on a CpG site-by-site basis, which lacks power with low replication and coverage and does not consider regional, spatial changes. When testing the method with different strengths of methylation change at CpG loci, we saw a sharp decrease in the number of regions being called as the methylation profile change over the regions became comparable to inter-replicate variability. Other methods experienced a less pronounced change in this regard.</p>
    <p>Other studies have suggested that changes in shape of methylation profiles are important in predicting gene expression (<xref rid="btu749-B26" ref-type="bibr">VanderKraats <italic>et al</italic>., 2013</xref>). To test whether our method is able to capture functionally important changes in methylation profiles, we performed gene expression analysis with human data and showed a link between methylation changes called by the M<sup>3</sup>D method and gene expression changes between conditions. Further, the results support the hypothesis that gene expression is more closely linked to methylation in the first exon of a gene than to methylation in promoter regions (<xref rid="btu749-B6" ref-type="bibr">Brenet <italic>et al</italic>., 2011</xref>). GO analysis of first exon and whole gene methylation changes both revealed links to cell function, despite none of the exons overlapping the gene regions, a result that was not apparent for promoter methylation changes. Although our findings confirm a potential role for methylation profile shape as a predictor of gene expression, they do not provide biological mechanisms for linking methylation shape to gene expression and regulation. Although sequence variants and protein binding have been shown to be predictive of epigenetic variability (<xref rid="btu749-B12" ref-type="bibr">Gertz <italic>et al</italic>., 2011</xref>; <xref rid="btu749-B4" ref-type="bibr">Benveniste <italic>et al</italic>., 2014</xref>), we believe that further investigation of the mechanistic underpinnings of changes in methylation shape could be a valuable direction for research.</p>
    <p>The M<sup>3</sup>D method provides a considerable increase in power over existing methods, yet it comes at the cost of computational intensity. In this study, we have restricted comparisons to datasets of low replication, as beta-binomial methods should prove effective with higher replication. We have also focused on sub-megabase scale changes for two reasons. Firstly, such an analysis is likely to be exploratory, in the sense that testing regions are not pre-defined, a key requirement for our method, and secondly, because BSmooth has proved adept at identifying large-scale changes in this setting and is computationally cheaper.</p>
    <p>The M<sup>3</sup>D framework was developed with RRBS data in mind, yet, given its robustness to lower coverage, we expect that it may also be well suited for WGBS data. In the future, it will be interesting to develop models that explain the predictive power of methylation profiles in terms of other epigenetic marks.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material id="PMC_1" content-type="local-data">
      <caption>
        <title>Supplementary Data</title>
      </caption>
      <media mimetype="text" mime-subtype="html" xlink:href="supp_31_6_809__index.html"/>
      <media xlink:role="associated-file" mimetype="application" mime-subtype="pdf" xlink:href="supp_btu749_Supplementary_data.pdf"/>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack>
    <title>Acknowledgement</title>
    <p>We thank Prof. Rebecca Doerge for kindly sharing the MAGI code with us.</p>
  </ack>
  <sec>
    <title>Funding</title>
    <p>This work was supported by the <funding-source>UK Engineering and Physical Sciences Research Council</funding-source>, <funding-source>Biological Sciences Research Council</funding-source>, and the <funding-source>UK Medical Research Council</funding-source> [grant numbers <award-id>EP/F500385/1</award-id> and <award-id>BB/F529254/1</award-id> to T.M.] the <funding-source>EU FP7 Marie Curie Actions</funding-source> [to G.Sch.]; and the <funding-source>European Research Council</funding-source> [grant number <award-id>MLCS306999</award-id> to G.S.].</p>
    <p><italic>Conflict of Interest</italic>: none declared.</p>
  </sec>
  <ref-list>
    <title>References</title>
    <ref id="btu749-B1">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bauer</surname><given-names>S.</given-names></name><etal/></person-group> (<year>2008</year>) 
<article-title>Ontologizer 2.0a multifunctional tool for go term enrichment analysis and data exploration</article-title>. <source>Bioinformatics</source><italic>,</italic>
<volume>24</volume>, <fpage>1650</fpage>–<lpage>1651</lpage>.<pub-id pub-id-type="pmid">18511468</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B2">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Baumann</surname><given-names>D.D.</given-names></name><name><surname>Doerge</surname><given-names>R.</given-names></name></person-group> (<year>2014</year>) 
<article-title>Magi: methylation analysis using genome information</article-title>. <source>Epigenetics</source><italic>,</italic>
<volume>9</volume>, <fpage>698</fpage>–<lpage>703</lpage>.<pub-id pub-id-type="pmid">24589664</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B3">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Benjamini</surname><given-names>Y.</given-names></name><name><surname>Hochberg</surname><given-names>Y.</given-names></name></person-group> (<year>1995</year>) 
<article-title>Controlling the false discovery rate: a practical and powerful approach to multiple testing</article-title>. <source>J. R. Stat. Soc. Ser. B</source><italic>,</italic>
<volume>57</volume>, <fpage>289</fpage>–<lpage>300</lpage>.</mixed-citation>
    </ref>
    <ref id="btu749-B4">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Benveniste</surname><given-names>D.</given-names></name><etal/></person-group> (<year>2014</year>) 
<article-title>Transcription factor binding predicts histone modifications in human cell lines</article-title>. <source>Proc. Natl. Acad. Sci. USA</source>
<volume>111</volume>, <fpage>13367</fpage>–<lpage>13372</lpage>.<pub-id pub-id-type="pmid">25187560</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B5">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Booth</surname><given-names>M.J.</given-names></name><etal/></person-group> (<year>2014</year>) 
<article-title>Quantitative sequencing of 5-formylcytosine in DNA at single-base resolution</article-title>. <source>Nat. Chem.</source>, <volume>6</volume>, <fpage>435</fpage>–<lpage>440</lpage>.<pub-id pub-id-type="pmid">24755596</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B6">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Brenet</surname><given-names>F.</given-names></name><etal/></person-group> (<year>2011</year>) 
<article-title>DNA methylation of the first exon is tightly linked to transcriptional silencing</article-title>. <source>PLoS One</source><italic>,</italic>
<volume>6</volume>, <fpage>e14524</fpage>.<pub-id pub-id-type="pmid">21267076</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B7">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Challen</surname><given-names>G.A.</given-names></name><etal/></person-group><italic>.</italic> (<year>2012</year>) 
<article-title>Dnmt3a is essential for hematopoietic stem cell differentiation</article-title>. <source>Nat. Genet.</source><italic>,</italic>
<volume>44</volume>, <fpage>23</fpage>–<lpage>31</lpage>.<pub-id pub-id-type="pmid">22138693</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B8">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Das</surname><given-names>P.M.</given-names></name><name><surname>Singal</surname><given-names>R.</given-names></name></person-group> (<year>2004</year>) 
<article-title>DNA methylation and cancer</article-title>. <source>J. Clin. Oncol.</source><italic>,</italic>
<volume>22</volume>, <fpage>4632</fpage>–<lpage>4642</lpage>.<pub-id pub-id-type="pmid">15542813</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B9">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Drewe</surname><given-names>P.</given-names></name><etal/></person-group> (<year>2013</year>) 
<article-title>Accurate detection of differential RNA processing</article-title>. <source>Nucleic Acids Res.</source><italic>,</italic>
<volume>41</volume>, <fpage>5189</fpage>–<lpage>5198</lpage>.<pub-id pub-id-type="pmid">23585274</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B10">
      <mixed-citation publication-type="journal"><collab>ENCODE Project Consortium, <italic>et al</italic></collab>. (<year>2012</year>) 
<article-title>An integrated encyclopedia of DNA elements in the human genome</article-title>. <source>Nature</source><italic>,</italic><volume>489</volume>, <fpage>57</fpage>–<lpage>74</lpage>.<pub-id pub-id-type="pmid">22955616</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B11">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Flicek</surname><given-names>P.</given-names></name><etal/></person-group> (<year>2013</year>) 
<article-title>Ensembl 2014</article-title>. <source>Nucleic Acids Res.</source>, <volume>42</volume>, <fpage>D749</fpage>–<lpage>D755</lpage>.<pub-id pub-id-type="pmid">24316576</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B12">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gertz</surname><given-names>J.</given-names></name><etal/></person-group> (<year>2011</year>) 
<article-title>Analysis of DNA methylation in a three-generation family reveals widespread genetic influence on epigenetic regulation</article-title>. <source>PLoS Genet.</source><italic>,</italic>
<volume>7</volume>, <fpage>e1002228</fpage>.<pub-id pub-id-type="pmid">21852959</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B13">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gopalakrishnan</surname><given-names>S.</given-names></name><etal/></person-group> (<year>2008</year>) 
<article-title>DNA methylation in development and human disease</article-title>. <source>Mutat. Res. Fundam. Mol. Mech. Mutagen.</source><italic>,</italic>
<volume>647</volume>, <fpage>30</fpage>–<lpage>38</lpage>.</mixed-citation>
    </ref>
    <ref id="btu749-B14">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gretton</surname><given-names>A.</given-names></name><etal/></person-group> (<year>2007</year>) 
<article-title>A kernel method for the two-sample-problem</article-title>. <source>Adv Neural Inf. Process. Syst.</source><italic>,</italic>
<volume>19</volume>, <fpage>513</fpage>.</mixed-citation>
    </ref>
    <ref id="btu749-B15">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gretton</surname><given-names>A.</given-names></name><etal/></person-group> (<year>2012</year>) 
<article-title>A kernel two-sample test</article-title>. <source>J. Machine Learn. Res.</source><italic>,</italic>
<volume>13</volume>, <fpage>723</fpage>–<lpage>773</lpage>.</mixed-citation>
    </ref>
    <ref id="btu749-B16">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gu</surname><given-names>H.</given-names></name><etal/></person-group> (<year>2011</year>) 
<article-title>Preparation of reduced representation bisulfite sequencing libraries for genome-scale DNA methylation profiling</article-title>. <source>Nat. Protoc.</source><italic>,</italic>
<volume>6</volume>, <fpage>468</fpage>–<lpage>481</lpage>.<pub-id pub-id-type="pmid">21412275</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B17">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hansen</surname><given-names>K.D.</given-names></name><etal/></person-group><italic>.</italic> (<year>2012</year>) 
<article-title>BSmooth: from whole genome bisulfite sequencing reads to differentially methylated regions</article-title>. <source>Genome Biol.</source><italic>,</italic>
<volume>13</volume>, <fpage>R83</fpage>.<pub-id pub-id-type="pmid">23034175</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B18">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hebestreit</surname><given-names>K.</given-names></name><etal/></person-group> (<year>2013</year>) 
<article-title>Detection of significantly differentially methylated regions in targeted bisulfite sequencing data</article-title>. <source>Bioinformatics</source><italic>,</italic>
<volume>29</volume>, <fpage>1647</fpage>–<lpage>1653</lpage>.<pub-id pub-id-type="pmid">23658421</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B19">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Krueger</surname><given-names>F.</given-names></name><etal/></person-group> (<year>2012</year>) 
<article-title>DNA methylome analysis using short bisulfite sequencing data</article-title>. <source>Nat. Methods</source><italic>,</italic>
<volume>9</volume>, <fpage>145</fpage>–<lpage>151</lpage>.<pub-id pub-id-type="pmid">22290186</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B20">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Laurent</surname><given-names>L.</given-names></name><etal/></person-group><italic>.</italic> (<year>2010</year>) 
<article-title>Dynamic changes in the human methylome during differentiation</article-title>. <source>Genome Res.</source><italic>,</italic>
<volume>20</volume>, <fpage>320</fpage>–<lpage>331</lpage>.<pub-id pub-id-type="pmid">20133333</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B21">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname><given-names>Y.</given-names></name><etal/></person-group><italic>.</italic> (<year>2010</year>) 
<article-title>The DNA methylome of human peripheral blood mononuclear cells</article-title>. <source>PLoS Biol.</source><italic>,</italic>
<volume>8</volume>, <fpage>e1000533</fpage>.<pub-id pub-id-type="pmid">21085693</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B22">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Park</surname><given-names>Y.</given-names></name><etal/></person-group> (<year>2014</year>) 
<article-title>methylSig: a whole genome DNA methylation analysis pipeline</article-title>. <source><italic>Bioinformatics</italic></source>, <volume>30</volume>, <fpage>2414</fpage>–<lpage>2422</lpage>.<pub-id pub-id-type="pmid">24836530</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B23">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Schweikert</surname><given-names>G.</given-names></name><etal/></person-group> (<year>2013</year>) 
<article-title>MMDiff: quantitative testing for shape changes in ChIP-Seq data sets</article-title>. <source>BMC Genomics</source><italic>,</italic>
<volume>14</volume>, <fpage>826</fpage>.<pub-id pub-id-type="pmid">24267901</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B24">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sharma</surname><given-names>S.</given-names></name><etal/></person-group> (<year>2010</year>) 
<article-title>Epigenetics in cancer</article-title>. <source>Carcinogenesis</source><italic>,</italic>
<volume>31</volume>, <fpage>27</fpage>–<lpage>36</lpage>.<pub-id pub-id-type="pmid">19752007</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B25">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Trapnell</surname><given-names>C.</given-names></name><etal/></person-group> (<year>2012</year>) 
<article-title>Differential gene and transcript expression analysis of RNA-seq experiments with tophat and cufflinks</article-title>. <source>Nat. Protoc.</source><italic>,</italic>
<volume>7</volume>, <fpage>562</fpage>–<lpage>578</lpage>.<pub-id pub-id-type="pmid">22383036</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B26">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>VanderKraats</surname><given-names>N.D.</given-names></name><etal/></person-group> (<year>2013</year>) 
<article-title>Discovering high-resolution patterns of differential DNA methylation that correlate with gene expression changes</article-title>. <source>Nucleic Acids Res.</source><italic>,</italic>
<volume>41</volume>, <fpage>6816</fpage>–<lpage>6827</lpage>.<pub-id pub-id-type="pmid">23748561</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B27">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Varela-Rey</surname><given-names>M.</given-names></name><etal/></person-group><italic>.</italic> (<year>2014</year>) 
<article-title>S-adenosylmethionine levels regulate the Schwann cell DNA methylome</article-title>. <source>Neuron</source><italic>,</italic>
<volume>81</volume>, <fpage>1024</fpage>–<lpage>1039</lpage>.<pub-id pub-id-type="pmid">24607226</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B28">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Varley</surname><given-names>K.E.</given-names></name><etal/></person-group><italic>.</italic> (<year>2013</year>) 
<article-title>Dynamic DNA methylation across diverse human cell lines and tissues</article-title>. <source>Genome Res.</source><italic>,</italic>
<volume>23</volume>, <fpage>555</fpage>–<lpage>567</lpage>.<pub-id pub-id-type="pmid">23325432</pub-id></mixed-citation>
    </ref>
    <ref id="btu749-B29">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yang</surname><given-names>X.</given-names></name><etal/></person-group> (<year>2010</year>) 
<article-title>Targeting DNA methylation for epigenetic therapy</article-title>. <source>Trends Pharmacol. Sci.</source><italic>,</italic>
<volume>31</volume>, <fpage>536</fpage>–<lpage>546</lpage>.<pub-id pub-id-type="pmid">20846732</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
