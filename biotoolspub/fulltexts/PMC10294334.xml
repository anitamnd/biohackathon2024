<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Genome Biol</journal-id>
    <journal-id journal-id-type="iso-abbrev">Genome Biol</journal-id>
    <journal-title-group>
      <journal-title>Genome Biology</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1474-7596</issn>
    <issn pub-type="epub">1474-760X</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10294334</article-id>
    <article-id pub-id-type="pmid">37365636</article-id>
    <article-id pub-id-type="publisher-id">2980</article-id>
    <article-id pub-id-type="doi">10.1186/s13059-023-02980-3</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Method</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>DCATS: differential composition analysis for flexible single-cell experimental designs</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Lin</surname>
          <given-names>Xinyi</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Chau</surname>
          <given-names>Chuen</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Ma</surname>
          <given-names>Kun</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <name>
          <surname>Huang</surname>
          <given-names>Yuanhua</given-names>
        </name>
        <address>
          <email>yuanhua@hku.hk</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-2331-7011</contrib-id>
        <name>
          <surname>Ho</surname>
          <given-names>Joshua W. K.</given-names>
        </name>
        <address>
          <email>jwkho@hku.hk</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.194645.b</institution-id><institution-id institution-id-type="ISNI">0000000121742757</institution-id><institution>School of Biomedical Sciences, Li Ka Shing Faculty of Medicine, </institution><institution>The University of Hong Kong, </institution></institution-wrap>Pokfulam, Hong Kong SAR China </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.518214.b</institution-id><institution-id institution-id-type="ISNI">0000 0005 0817 5873</institution-id><institution>Laboratory of Data Discovery for Health Limited (D24H), </institution></institution-wrap>Hong Kong Science Park, Hong Kong SAR China </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="GRID">grid.194645.b</institution-id><institution-id institution-id-type="ISNI">0000000121742757</institution-id><institution>Department of Statistics and Actuarial Science, Faculty of Science, </institution><institution>The University of Hong Kong, </institution></institution-wrap>Pokfulam, Hong Kong SAR China </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>26</day>
      <month>6</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>26</day>
      <month>6</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2023</year>
    </pub-date>
    <volume>24</volume>
    <elocation-id>151</elocation-id>
    <history>
      <date date-type="received">
        <day>21</day>
        <month>3</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>7</day>
        <month>6</month>
        <year>2023</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2023</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons licence, and indicate if changes were made. The images or other third party material in this article are included in the article's Creative Commons licence, unless indicated otherwise in a credit line to the material. If material is not included in the article's Creative Commons licence and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this licence, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>. The Creative Commons Public Domain Dedication waiver (<ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/publicdomain/zero/1.0/">http://creativecommons.org/publicdomain/zero/1.0/</ext-link>) applies to the data made available in this article, unless otherwise stated in a credit line to the data.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Differential composition analysis — the identification of cell types that have statistically significant changes in abundance between multiple experimental conditions — is one of the most common tasks in single cell omic data analysis. However, it remains challenging to perform differential composition analysis in the presence of flexible experimental designs and uncertainty in cell type assignment. Here, we introduce a statistical model and an open source R package, DCATS, for differential composition analysis based on a beta-binomial regression framework that addresses these challenges. Our empirical evaluation shows that DCATS consistently maintains high sensitivity and specificity compared to state-of-the-art methods.</p>
      <sec>
        <title>Supplementary information</title>
        <p>The online version contains supplementary material available at 10.1186/s13059-023-02980-3.</p>
      </sec>
    </abstract>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100007156</institution-id>
            <institution>Innovation and Technology Commission - Hong Kong</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© BioMed Central Ltd., part of Springer Nature 2023</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Background</title>
    <p id="Par2">Single-cell RNA sequencing (scRNA-seq) is a high-throughput sequencing technology that enables researchers to probe transcriptomes of a large number of individual cells, and allows them to characterize different cell types in a heterogeneous population. It plays a critical role in strengthening our understanding of various biological systems, including embryogenesis, the development of different diseases, and how cells react to environmental stimuli [<xref ref-type="bibr" rid="CR1">1</xref>, <xref ref-type="bibr" rid="CR2">2</xref>]. Recently, highly multiplexed strategies have been introduced to mix samples from different donors, conditions, or treatments with external molecular barcodes or intrinsic genetic makeups to achieve higher efficiency and lower batch effects [<xref ref-type="bibr" rid="CR3">3</xref>–<xref ref-type="bibr" rid="CR5">5</xref>]. In such multi-sample designs, analysis of the differential composition of cell types between two conditions is routinely applied.</p>
    <p id="Par3">From a scRNA-seq experiment, we can obtain the cell counts <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{N}=\{n_1, ..., n_K\}$$\end{document}</tex-math><mml:math id="M2"><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">N</mml:mi></mml:mrow><mml:mo>=</mml:mo><mml:mo stretchy="false">{</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>K</mml:mi></mml:msub><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq1.gif"/></alternatives></inline-formula> of <italic>K</italic> cell types by performing cell clustering, for example, with Louvain (a graph-based method) [<xref ref-type="bibr" rid="CR6">6</xref>] or K-means, usually on reduced dimensions through a principal component analysis. Then, the obtained cell count vector <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{N}$$\end{document}</tex-math><mml:math id="M4"><mml:mrow><mml:mi mathvariant="bold-italic">N</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq2.gif"/></alternatives></inline-formula> is conventionally used to estimate the cell type composition abundance <inline-formula id="IEq3"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }$$\end{document}</tex-math><mml:math id="M6"><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq3.gif"/></alternatives></inline-formula>, with the assumption that the clustering is unbiased and accurate. Thus, a few statistical methods can be directly applied to detect the cell types with differential composition abundance between conditions. Some statistical tools are also developed specialized for scRNA-seq data. scCODA [<xref ref-type="bibr" rid="CR7">7</xref>] assumes cell counts of different cell types follow a hierarchical Dirichlet-Multinomial distribution, which allows scCODA to model all cell types together. MiloR [<xref ref-type="bibr" rid="CR8">8</xref>] evaluates differential abundance on smaller clusters in KNN graph, which are called “neighborhoods.” It assumes that cell counts follow a negative binomial distribution and uses representative cells instead of all cells to improve program efficiency. DAseq [<xref ref-type="bibr" rid="CR9">9</xref>] also makes use of KNN graph and calculates multiscale differential abundance scores by counting the numbers of cells coming from different biological states while varying k. This multiscale differential abundance score is what DAseq uses to infer cell states that have differential abundance. propeller [<xref ref-type="bibr" rid="CR10">10</xref>] uses an empirical Bayes framework to enable information sharing between different samples and chooses different statistical methods (t-test or ANOVA) based on the number of conditions. Other tools are developed to handle different challenges for different data types. For instance, ANCOM-BC [<xref ref-type="bibr" rid="CR11">11</xref>] uses a linear model with sample-specific offset terms to handle the estimation of different sampling fractions when analyzing microbiome data. diffcyt [<xref ref-type="bibr" rid="CR12">12</xref>] uses functions from the R package edgeR [<xref ref-type="bibr" rid="CR13">13</xref>] to test differential abundance of cell types. It uses an overdispersed Poisson model with empirical Bayes methods for information sharing between different cell types. However, its implementation was specifically designed for flow cytometry data, not single cell RNA-seq data.</p>
    <p id="Par4">Nevertheless, performing differential abundance analysis on single cell RNA-seq data with replicates remains a statistical challenge for multiple reasons. First, multi-level variability exists due to technical and biological reasons, such as a low number of biological replicates or a low number of cells for minor cell types. Recently, scDC [<xref ref-type="bibr" rid="CR14">14</xref>], a Poisson regression-based method, has been introduced to account for the uncertainty not only between replicates but also clustering by leveraging bootstrap re-sampling, preferred with re-clustering. However, the Poisson noise model is not able to capture the over dispersion. Second, misclassification during the cell clustering step may introduce both systematic bias and uncertainty. For example, subtypes of T helper cells are often confused with each other. A similar challenge was also noticed in meta-genomics analysis, where species with similar sequences are often confusedly aligned and quantified, and bias correction by reversing this bias was found beneficial for the differential abundance analysis [<xref ref-type="bibr" rid="CR15">15</xref>, <xref ref-type="bibr" rid="CR16">16</xref>]. Regarding to challenges mentioned above, we introduced a statistical method, DCATS, to effectively detect the cell types with differential abundance between conditions or along with continuous covariates. This algorithm is implemented as an R package named DCATS which is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/holab-hku/DCATS">https://github.com/holab-hku/DCATS</ext-link>.</p>
  </sec>
  <sec id="Sec2">
    <title>Results</title>
    <sec id="Sec3">
      <title>High-level description of DCATS</title>
      <p id="Par5">Here, we introduce DCATS, a differential composition analysis framework to address the above challenges. DCATS has two key features. First, it accounts for the uncertainty in cell type assignment utilizing the biased similarity between cells types. The latent true cell type proportion is obtained by leveraging a similarity matrix between cell types via maximum likelihood estimation. Second, DCATS employs a beta-binomial regression model to analyze the differential cell type abundance, which models the raw cell counts rather than the normalized proportions and considers the dispersion between samples (Fig. <xref rid="Fig1" ref-type="fig">1</xref>A; “<xref rid="Sec10" ref-type="sec">Method</xref>”). Specifically, we assume the corrected cell counts <inline-formula id="IEq4"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{s,j}$$\end{document}</tex-math><mml:math id="M8"><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq4.gif"/></alternatives></inline-formula> for cell type <italic>j</italic> given sample <italic>s</italic> follow a beta-binomial distribution. We then describe <inline-formula id="IEq5"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{s,j}$$\end{document}</tex-math><mml:math id="M10"><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq5.gif"/></alternatives></inline-formula> with a beta-binomial generalized linear model(GLM) with a logit link function for each covariate <italic>i</italic>, as follows,<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} z_{s,j}\sim &amp; {} \texttt{Binom}(n_s, p_{s,j})\nonumber \\ p_{s,j}\sim &amp; {} \texttt{Beta}(\alpha _{s,j}, \beta _{s,j}) \end{aligned}$$\end{document}</tex-math><mml:math id="M12" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi mathvariant="monospace">Binom</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>s</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi mathvariant="monospace">Beta</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula>where we reparameterized with the mean <inline-formula id="IEq6"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\bar{p}_{s,j}$$\end{document}</tex-math><mml:math id="M14"><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq6.gif"/></alternatives></inline-formula> and over dispersion term <inline-formula id="IEq7"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi _j$$\end{document}</tex-math><mml:math id="M16"><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq7.gif"/></alternatives></inline-formula> as<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \alpha _{s,j}= &amp; {} \bar{p}_{s,j} (1/\phi _{j} - 1)\nonumber \\ \beta _{s,j}= &amp; {} (1-\bar{p}_{s,j}) (1/\phi _j - 1). \end{aligned}$$\end{document}</tex-math><mml:math id="M18" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par6">As described below, the mean parameter <inline-formula id="IEq8"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\bar{p}_{s,j}$$\end{document}</tex-math><mml:math id="M20"><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq8.gif"/></alternatives></inline-formula> is regressed to a set of covariates under different hypotheses and can be parameterized as<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \quad \texttt{logit}(\bar{p}_{s,j}) = w_0 + \varvec{w}^{\top } \varvec{c}_{s} \end{aligned}$$\end{document}</tex-math><mml:math id="M22" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mspace width="1em"/><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq9"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{c}_s$$\end{document}</tex-math><mml:math id="M24"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq9.gif"/></alternatives></inline-formula> is the covariate vector for sample <italic>s</italic>, and <inline-formula id="IEq10"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{w}$$\end{document}</tex-math><mml:math id="M26"><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq10.gif"/></alternatives></inline-formula> is the corresponding weight vector. The weights for covariates <inline-formula id="IEq11"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{w}$$\end{document}</tex-math><mml:math id="M28"><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq11.gif"/></alternatives></inline-formula> and the dispersion <inline-formula id="IEq12"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi _j$$\end{document}</tex-math><mml:math id="M30"><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq12.gif"/></alternatives></inline-formula> are optimized to achieve maximum likelihood, through the <italic>aod</italic> package [<xref ref-type="bibr" rid="CR17">17</xref>]. The <italic>p</italic>-value can be calculated with a likelihood ratio test by comparing the log likelihoods in both alternative and null hypotheses.<fig id="Fig1"><label>Fig. 1</label><caption><p>DCATS improves composition analysis through accounting for uncertainty in classification of cell types in differential abundance analysis. <bold>A</bold> Illustration of the DCATS workflow. Matrices with light blue are input matrices, matrices with light orange are output from DCATS. First step is bias correction using a similarity matrix. This step is optional. The design matrix with multiple covariates is also required. DCATS supports both categorical and continuous covariates. Then, DCATS detects differential abundance using a beta-binomial generalized linear model (GLM) model, which returns the estimated coefficients and <italic>p</italic>-values. <bold>B</bold> These box plots illustrate the effect of cell type misclassificaiton in a theoretical simulation with Dirichlet-Multinomial sampling. The similarity matrix is designed to introduce misclassification errors. The proportions of cell types <bold>B</bold> and <bold>C</bold> are changed between conditions 1 and 2. <bold>C</bold> Area under the precision-recall curve (AUC, same below) values when varying <italic>p</italic> value in detecting the cell type with differential abundance</p></caption><graphic xlink:href="13059_2023_2980_Fig1_HTML" id="MO4"/></fig></p>
      <p id="Par7">The effectiveness of the vanilla beta-binomial regression was demonstrated in [<xref ref-type="bibr" rid="CR18">18</xref>]. However, the estimation of the over dispersion term in this task is often challenging due to the extremely low numbers of replicates (sometimes even single replicate). Therefore, we introduce a strategy to estimate the dispersion term for all cell types jointly, through a pooled beta-binomial regression in a pre-step (<xref rid="Sec10" ref-type="sec">Method</xref>).</p>
      <p id="Par8">When analyzing scRNA-seq data, we started from the gene expression matrix of read or unique molecular identifier (UMI) counts. After basic pre-processing including filtering cells, normalization, and integration [<xref ref-type="bibr" rid="CR19">19</xref>, <xref ref-type="bibr" rid="CR20">20</xref>], several methods can be used to annotate each cells, including manual annotation, supervised methods and semi-supervised methods [<xref ref-type="bibr" rid="CR21">21</xref>, <xref ref-type="bibr" rid="CR22">22</xref>]. The input cell count matrix for DCATS can be calculated by counting the number of cells in each cell type.</p>
      <p id="Par9">In order to estimate the cell type similarity matrix <italic>M</italic> for the confusion during clustering, we introduced two heuristic methods here. One is based on the KNN graph between cells by calculating the averaged frequency of cell types in each cell’s neighbors (<xref rid="Sec10" ref-type="sec">Method</xref>), where the KNN graph may be pre-computed if using Seurat [<xref ref-type="bibr" rid="CR23">23</xref>] or Scanpy [<xref ref-type="bibr" rid="CR24">24</xref>] pipelines. By defining <inline-formula id="IEq13"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n_{x,j}$$\end{document}</tex-math><mml:math id="M32"><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq13.gif"/></alternatives></inline-formula> as the number of neighbors for cell <italic>x</italic> that are classified as cell type <italic>j</italic>, we can calculate the KNN-based similarity matrix, for example, its entry <inline-formula id="IEq14"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m_{i,j}$$\end{document}</tex-math><mml:math id="M34"><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq14.gif"/></alternatives></inline-formula> for similarity (misclassification) from cluster <italic>i</italic> to <italic>j</italic> as follows:<disp-formula id="Equ13"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} m_{i,j} = \frac{\sum _{x=1}^{x_i} n_{x,j}}{\sum _{j=1}^{K}\sum _{x=1}^{x_i} n_{x,j}} \end{aligned}$$\end{document}</tex-math><mml:math id="M36" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:msubsup><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:msubsup><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ13.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par10">The other method is to use a prediction confusion matrix produced using 5-fold cross validation by a classifier on top of principle components when the KNN graph is not available, e.g., support vector machine as default.</p>
    </sec>
    <sec id="Sec4">
      <title>Correcting misclustering through DCATS improves composition analysis</title>
      <p id="Par11">To evaluate the effects of misclustering on the composition analysis, we performed a theoretical simulation by generating cell counts from Dirichlet-Multinomial distributions, where the input cell type proportions were generated by adding bias to the genuine cell type proportions through a transformation with the misclustering matrix, aka similarity matrix (Fig. <xref rid="Fig1" ref-type="fig">1</xref>C, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1).</p>
      <p id="Par12">Here, the genuine proportions of the three cell types were [1/3, 1/3, 1/3] and [1/3, 1/2, 1/6] in conditions 1 and 2, respectively. However, due to the high similarity between cell types 2 and 3, the average cell type proportions were transformed to [0.33, 0.33, 0.33] and [0.33, 0.40, 0.27] respectively in the two conditions, which mimicked the bias introduced in the clustering. Due to the equal cell type proportion and symmetrical similarity matrix, all cell type proportions remained unchanged in condition 1 after the similarity-based transformation. However, the proportion of cell type 2 and cell type 3 in condition 2 changed due to misclassification. Notably, the difference in proportions between conditions was reduced for both cell types 2 and 3, which caused false negatives due to the shrunken effects. Indeed, both Fisher’s exact test and DCATS only returned moderate performance (area under ROC curve (AUC) = 0.721 and 0.745 on average, aggregating 50 runs). By contrast, we found that the performance in detecting differential abundance was dramatically increased for both DCATS (mean AUC: 0.745 to 0.976) and Fisher’s exact test (mean AUC: 0.721 to 0.961; Fig. <xref rid="Fig1" ref-type="fig">1</xref>C) by using the cell counts corrected from similarity matrix by DCATS through an Expectation-Maximization algorithm. This was largely thanks to the improved sensitivity in both methods (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S2).</p>
      <p id="Par13">We further asked whether the bias correction component in DCATS could correct the misclassification and provide more accurate proportion estimations. We tested this using a single cell RNA-seq data set [<xref ref-type="bibr" rid="CR25">25</xref>] consisting of progressive multiple sclerosis (MS) and relapsing-remitting disease course MS (RRMS). In this dataset, cells from 71 PBMC samples of 62 donors were collected for single-cell RNA sequencing and surface antibody staining. In total, it contains 497,705 single-cell transcriptomic (Tr) and 355,433 surface protein (SP) profiles. The original study used defined cell types based on both Tr and SP profiles [<xref ref-type="bibr" rid="CR25">25</xref>]. We treated this Tr+SP annotation as the “original” annotation with high reliability, as it is the most well-studied annotation [<xref ref-type="bibr" rid="CR25">25</xref>].</p>
      <p id="Par14">To test bias correction in our study, we focused on four T-cell subtypes based on the Tr+SP annotated dataset, namely T06, T07, T09, and T10. Then, we identified cell clusters based on transriptomic data only (Tr-only) and match each Tr-only cluster to its closest Tr+SP cluster. A confusion matrix can be generated between the four clusters defined by Tr+SP and their matching Tr-only clusters. The proportions of the four Tr-only clusters can be calculated. Using this “empirical” confusion matrix for bias correction, DCATS corrected the proportions of the four Tr-only clusters very close to the true proportions (root mean square error (RMSE) from 0.1810 to <inline-formula id="IEq15"><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$8.672\times 10^{-5}$$\end{document}</tex-math><mml:math id="M38"><mml:mrow><mml:mn>8.672</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>5</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq15.gif"/></alternatives></inline-formula>, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S3). In most cases, the true similarity matrix or confusion matrix is unknown. DCATS provides two simple methods to approximate this similarity matrix, which improves our estimation of proportion by 44% compared to without bias correction (RMSE from 0.1810 to 0.1023, using KNN similarity matrix; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S3)</p>
      <p id="Par15">Combined with previous simulation results, our findings support the effectiveness of DCATS’ bias correction step in differential composition analysis.</p>
    </sec>
    <sec id="Sec5">
      <title>Benchmarking DCATS with simulated data</title>
      <p id="Par16">We further benchmarked DCATS’s performance with six existing methods: Fisher’s exact test, scDC [<xref ref-type="bibr" rid="CR14">14</xref>], speckle [<xref ref-type="bibr" rid="CR10">10</xref>], diffcyt (a method primarily designed for mass cytometry data) [<xref ref-type="bibr" rid="CR12">12</xref>] , milo [<xref ref-type="bibr" rid="CR8">8</xref>] and ANCOM-BC [<xref ref-type="bibr" rid="CR11">11</xref>]. Here, we first generated a large pool of single-cell transcriptomic profiles with a simulator Splatter [<xref ref-type="bibr" rid="CR26">26</xref>] (Fig. <xref rid="Fig2" ref-type="fig">2</xref>A; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S4). This simulated pool was then used as the seed data and cells are randomly selected according to the simulated cell-type proportions (as ground truth; see more details in <xref rid="Sec10" ref-type="sec">Method</xref>). Clustering was further performed on the subsets of simulated cells with Seurat to mimic the potential confusion introduced in the clustering step (the empirical confusion matrix shown in Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S7). The seven methods were then performed on the cell counts obtained from the clustering annotation. Uniquely, we estimated the similarity matrix between cells using a KNN graph by calculating the fraction of neighbors for all cells in each cell type that belong to different cell types. It approximated the empirical confusion matrix well (Pearson’s <italic>R</italic> = 0.9987; Mean absolute error=<inline-formula id="IEq16"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2.977\times 10^{-18}$$\end{document}</tex-math><mml:math id="M40"><mml:mrow><mml:mn>2.977</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>18</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq16.gif"/></alternatives></inline-formula>; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S8).<fig id="Fig2"><label>Fig. 2</label><caption><p>Evaluation of DCATS with multiple simulation datasets. <bold>A</bold> The UMAP plots of simulation data with 8 cell types. <bold>B</bold> The true proportions of different cell types in default setting (3 replicates in each condition across 30 runs; the 4 cell types with differential composition abundance have names started with “P”). <bold>C</bold> The boxplot of MCC, F1, AUC, and PRAUC of different methods in bootstrap sampling results with the default setting. <bold>D</bold>-<bold>G</bold> Comparing multiple methods with Splatter-simulated data by varying the number of replicates (<bold>D</bold>, <bold>E</bold>) and number of cell types (<bold>F</bold>, <bold>G</bold>). “bcANCOM-BC” indicates using bias corrected proportions estimated by DCATS as the input of ANCOM-BC [<xref ref-type="bibr" rid="CR11">11</xref>]. The default number of cell types is 8, and the default number of replicates is 3. <bold>H</bold> The performance of each method in the special case. “DCATS” indicates the results of DCATS using total cell count as the normalization term. “dcats_autoRef” indicates using the reference group automatically detected by DCATS as the normalization term. “dcats_defRef” indicates using the know true reference group as the normalization term. <bold>I</bold> Detecting variable cell types with multiple covariates, for both categorical and continuous types. Data is simulated with Splatter. N.B., only DCATS and Milo support multiple covariates</p></caption><graphic xlink:href="13059_2023_2980_Fig2_HTML" id="MO6"/></fig></p>
      <p id="Par17">We generated three types of simulation data. Among all the simulation scenarios, we simulated multiple samples coming from two conditions. In the first type of simulation, we focused on the change of proportion. The proportion of some cell types increased, while the proportion of other cell types decreased. The proportion of samples coming from two conditions all summed up to 1. In the second type of simulation, we designed the simulation based on different cell counts of each cell type. With the count of one cell type increased from condition 1 to condition 2, the proportion of this cell type increased, while the proportions of the rest cell types decreased. In the third type of simulation, we included another two confounding covariates - age and gender, to test the ability of controlling covariates of different methods.</p>
      <p id="Par18">For the first type of simulation data, in a default setting with 3 replicates in each condition and 4 out of 8 cell types with differential composition abundance (Fig. <xref rid="Fig2" ref-type="fig">2</xref>B), we found that DCATS outperforms all other methods (area under ROC curve (AUC): 0.872 vs 0.86; matthews correlation coefficient (MCC) : 0.63 vs 0.517; F1: 0.779 vs 0.714, respectively for DCATS and the second-best method in each metric; Fig. <xref rid="Fig2" ref-type="fig">2</xref>C–G and Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1, 3, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S5–6). N.B., DCATS remains the best-performed method in all three metrics while the second-best method varies among the alternative methods. By ablating the correction of misclustering in DCATS and introducing the over-dispersion term in the beta-binomial regression, we observed that both bias correction and global estimation of over-dispersion contribute to the improvement of overall performance (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1-2, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S6). When varying the number of replicates to 2 or 4, or the number of cell types to 10 or 12, we found that DCATS consistently outperforms all other methods, mostly by a large margin (Fig. <xref rid="Fig2" ref-type="fig">2</xref>D–G, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1-4, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S6). Unsurprisingly, the increase of replicates improves the performance for almost all methods, especially for DCATS, suggesting its capability of estimating biological variability from replicates. It is worth mentioning that despite Milo’s unsatisfactory performance in cell type levels, as a tool designed for detecting perturbation of cell states in partially overlapping neighborhoods, it shows its strength in differential abundance analysis at neighborhood level compared to DCATS and speckle. (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S9–10)</p>
      <p id="Par19">By comparing the results of ANCOM-BC using the observed proportion (ancombc) and bias-corrected proportion estimated by DCATS (bcancombc), we found that the bias correction step always increased the sensitivity of ANCOM-BC (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1,3). However, the specificity sometimes decreased, and this led to the overall similar performance of ancombc and bcancombc. While in DCATS, using bias-corrected proportions led to a higher increase in sensitivity and almost no decrease in specificity (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1,3).</p>
      <p id="Par20">Next, we conduct the second type of simulation to assess the composition effects in the task. The first cell type has a 20 times count increase in condition 2, while counts of the rest cell types remain the same. Proportions of each cell type are calculated based on the defined cell counts, and the simulation is done based on these cell types’ proportions. With the same total count in 2 conditions, the observed cell count of the first cell type shows a huge increase in condition 2, while cell counts of the rest cell types decrease (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S11). We test the performance of different methods using this dataset. With the estimated dispersion term, this systematic decrease of proportion can be partially modeled by DCATS (DCATS (estPhi_emK): 0.762 vs wtoPhi_emK: 0.190 in MCC, Fig. <xref rid="Fig2" ref-type="fig">2</xref>H, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S6). Thus, DCATS achieves higher MCC and F1 compared to other methods.</p>
      <p id="Par21">To directly address the issue of cell type proportion, we investigated the performance of selecting certain cell types as the reference group for normalization, rather than utilizing all remaining cell types (as outlined in detail in the “<xref rid="Sec10" ref-type="sec">Method</xref>” section). Specifically, the reference cell types should exhibit no significant abundance differences with high confidence. In this simulation, employing three known unchanged cell types as the reference group enabled DCATS to differentiate between actual abundance changes and spurious effects caused by other cell types (0.762 to 0.948 in MCC, 0.775 to 0.954 in F1). The performance of DCATS improved mainly through the increase in specificity (0.917 to 0.986, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S6). Such improvement is also seen when using 3 reference cell types automatically recommended by DCATS (0.762 to 0.889 in MCC, 0.775 to 0.899 in F1).</p>
      <p id="Par22">Moreover, a third simulation was performed to evaluate DCATS’s ability to account for additional covariates or to jointly test multiple covariates in association with composition abundance for each cell type. Specifically, we simulated ten replicates for each condition with different ages and genders. There were a total of eight cell types, of which four displayed differential abundance between conditions. In addition, we selected four cell types to exhibit confounding effects from both age and gender. Two of these cell types exhibit differential abundance (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S5). Even though most of these seven methods are based on a linear model framework, DCATS, milo, and ANCOMBC are the only three methods designed with the utility to support additional covariates testing, while ANCOMBC only supports testing for discrete covariates. scDC, as a GLM based method, is in principle able to support covariates, but the interface is not implemented. propeller in the speckle package [<xref ref-type="bibr" rid="CR10">10</xref>] only takes the condition information as input but not additional covariates. diffcyt, which uses edgeR [<xref ref-type="bibr" rid="CR13">13</xref>] for differential abundance analysis on flow cytometry data also met challenges in incorporating different covariates due to its highly specific analysis pipeline designed for flow cytometry data. Therefore, we focus on Milo and ANCOMBC for incorporating covariates, while interestingly they fail to effectively control the influence of confounding covariates when performing the analysis (Fig. <xref rid="Fig2" ref-type="fig">2</xref>I, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S12–13). By contrast, DCATS achieves improved MCC partly thanks to its capability of jointly modeling additional covariates. Indeed, DCATS shows good performance in detecting cell types with additional covariates for both continuous (age) and discrete (gender) variables (Fig. <xref rid="Fig2" ref-type="fig">2</xref>I, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S12–13).</p>
    </sec>
    <sec id="Sec6">
      <title>Evaluating DCATS on experimental data sets</title>
      <p id="Par23">To further illustrate the performance of DCATS, we applied DCATS and five other methods (Fisher’s exact test, scDC [<xref ref-type="bibr" rid="CR14">14</xref>], speckle [<xref ref-type="bibr" rid="CR10">10</xref>], milo [<xref ref-type="bibr" rid="CR8">8</xref>], and ANCOM-BC [<xref ref-type="bibr" rid="CR11">11</xref>]) to three experimental datasets. As we do not have the KNN matrices required for annotating cell types in these datasets, similarity matrices are calculated by performing classification with SVM over the original cell type annotation.</p>
      <p id="Par24">We first assessed the sensitivity of DCATS using a dataset (Angelidis2019) containing single-cell transcriptomic and mass spectrometry-driven proteomic data of whole lungs from 3-month-old mice (<italic>n</italic> = 8) and 24-month-old mice (<italic>n </italic>= 7) [<xref ref-type="bibr" rid="CR27">27</xref>]. In this dataset, the authors discovered one cluster of cells with a high expression level of S and G2M cell-cycle marker genes. This cluster contains mainly proliferating cells, thus, should show higher abundance in young mice. As these proliferating cells belong to T cells, type-2 pneumocytes, and alveolar macrophages, these cell types should have higher proportions in young mice. Using single-cell transcriptome information, DCATS enabled the detection of type-2 pneumocytes, and alveolar macrophages, and a subtype of T cells, CD4+ T cells, as differentially abundant cell types (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S8). In addition, the authors found a relatively increased number of ciliated cells in old mice compared to club cells. By deconvoluting bulk RNA sequencing data, the authors found the upregulation of ciliated cell marker genes signature. The increased ratio of ciliated to club cells in aged mice is further validated by immunostainings of Foxj1 (ciliated cell marker) and CC10 (club cell marker) [<xref ref-type="bibr" rid="CR27">27</xref>]. Using club cells as the reference group, DCATS enabled the detection of this ratio change (<inline-formula id="IEq17"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p = 0.0053$$\end{document}</tex-math><mml:math id="M42"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>0.0053</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq17.gif"/></alternatives></inline-formula>, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S8).</p>
      <p id="Par25">We then assessed the performance of these six methods on controlling false positives by applying them to a negative control data set on PBMCs, where no cell type was reported to have significant proportion change between 8 lupus patients treated with interferon(IFN)-<inline-formula id="IEq18"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\beta$$\end{document}</tex-math><mml:math id="M44"><mml:mi>β</mml:mi></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq18.gif"/></alternatives></inline-formula> and 8 control samples [<xref ref-type="bibr" rid="CR4">4</xref>]. Here, we found that DCATS, speckle and ANCOM-BC both have good control of false positives, with no cell types having <inline-formula id="IEq19"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p&lt;0.1$$\end{document}</tex-math><mml:math id="M46"><mml:mrow><mml:mi>p</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0.1</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq19.gif"/></alternatives></inline-formula> (Fig. <xref rid="Fig3" ref-type="fig">3</xref>A). Similarly, Milo also has a good control on false positives when manually setting its threshold to 0.2 based on prior knowledge (this threshold is used throughout all data sets below; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S7). On the other hand, Fisher’s exact test severely suffers from type I errors (4 out of 8 cell types passing a significance level at <inline-formula id="IEq20"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p&lt;0.01$$\end{document}</tex-math><mml:math id="M48"><mml:mrow><mml:mi>p</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0.01</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq20.gif"/></alternatives></inline-formula>); scDC also returns three cell types with <inline-formula id="IEq21"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p&lt;0.1$$\end{document}</tex-math><mml:math id="M50"><mml:mrow><mml:mi>p</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0.1</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq21.gif"/></alternatives></inline-formula>, including B cells with <inline-formula id="IEq22"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p&lt;0.01$$\end{document}</tex-math><mml:math id="M52"><mml:mrow><mml:mi>p</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0.01</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq22.gif"/></alternatives></inline-formula>.<fig id="Fig3"><label>Fig. 3</label><caption><p>DCATS gives accurate conclusions for two experimental datasets. “dcats_autoRef” indicates using the reference group automatically detected by DCATS as the normalization term. <bold>A</bold> shown is the proportion of each cell types in the Kang dataset [<xref ref-type="bibr" rid="CR4">4</xref>]. cM, CD14+CD16- monocytes; ncM, CD14+CD16+ monocytes; DC, dendritic cells; Mkc, megakaryocytes; Th, CD4+ T cells; B, B cells; Tc, CD8+ T cells; NK, natural killer cells. <bold>B</bold>–<bold>D</bold> show the proportion of each cell types in the Haber dataset [<xref ref-type="bibr" rid="CR28">28</xref>]. E, Enterocyte; TA, transit amplifying; TAE, TA.Early; EP, Enterocyte.Progenitor; Gob, Goblet. “P” in the first line represents existing proportions’ difference according to the original papers, and “N” represents no significant proportions’ difference. “P” in the last line represents existing proportions’ difference based on results of milo, and “N” represents no significant proportions’ difference. In the rest four lines, “*” represents <italic>p</italic>-values from 0.05 to 0.1, “**” represents <italic>p</italic>-values from 0.01 to 0.05, “***” represents <italic>p</italic>-values less than 0.01. “n.s.” means not significant</p></caption><graphic xlink:href="13059_2023_2980_Fig3_HTML" id="MO7"/></fig></p>
      <p id="Par26">The third dataset consists of 53,193 epithelial cells from mice’s small intestine and organoids [<xref ref-type="bibr" rid="CR28">28</xref>]. It includes 4 control samples, 2 samples from two days after <italic>Salmonella</italic> infection, 2 samples from three days after <italic>H. polygyrus</italic> infection, and 2 samples from ten days after <italic>H. polygyrus</italic> infection. The original study defined eight cell types and compared between controls and each stimulation group to identify cell types with differential composition abundance through a Poisson regression and Wald test [<xref ref-type="bibr" rid="CR28">28</xref>]. Presumably, since the sample variability was not well considered in the Poisson regression, the authors used <inline-formula id="IEq23"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\texttt{FDR}&lt;1\times 10^{-5}$$\end{document}</tex-math><mml:math id="M54"><mml:mrow><mml:mi mathvariant="monospace">FDR</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>1</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>5</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq23.gif"/></alternatives></inline-formula> as the cutoff of differential abundant cell types between control and simulations.</p>
      <p id="Par27">We do not have the ground truth about which cell types are differentially abundant, but for the purpose of evaluating the accuracy of DCATS and other methods, we used the findings in the original study of this dataset as the “silver standard.” When re-analyzing this data set, we first noticed that Fisher’s exact test captured all the reported differential abundant cell types, but also reports lots of differential abundant cell types that are regarded as non-differential abundant cell types by other methods in each of the comparison pairs (with <inline-formula id="IEq24"><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p&lt;0.01$$\end{document}</tex-math><mml:math id="M56"><mml:mrow><mml:mi>p</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0.01</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq24.gif"/></alternatives></inline-formula>). Similarly, scDC and milo also returns “false positives” in each comparing condition pair but occasionally missed reported positives. Surprisingly, speckle shows limited power, missing almost all hits. In contrast, DCATS displayed a good balance between sensitivity and specificity; it does not return any “false positive” (using 0.05 as the significance level) and captures most of the reported differential abundant cell types when comparing the control group and <italic>H. polygyrus</italic> infection groups. When comparing the control groups and <italic>Salmonella</italic> infection group, we observed a significant increase in the proportion of enterocytes, which causes proportions decrease in the rest of the cell types. Using the reference group detected by DCATS as the normalization term was able to overcome the influence of enterocytes. The results show that enterocyte is the only cell type with differential abundance (Fig. <xref rid="Fig3" ref-type="fig">3</xref>B–D, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S9-10, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S14).</p>
      <p id="Par28">Furthermore, if we treat the results given in the paper as results of another method, we can use the major decisions as the highly possible conclusions. In this case, the performance of each method is evaluated by their similarity with other methods. We can find that DCATS provides a consistent conclusion with the majority decisions of each cell type in different comparisons, except for the significant proportion change of Goblet between control and Hpoly day 10 conditions.</p>
    </sec>
    <sec id="Sec7">
      <title>Application of DCATS in complex experiment designs</title>
      <p id="Par29">To demonstrate the utility of DCATS for complex designs, we selected a cohort study including 196 hospitalized COVID-19 patients with moderate or severe disease, corresponding control group, and patients in the recovering stage. Within this cohort study, we selected scRNA-seq data from fresh and frozen PBMC samples with known metadata. The samples were stratified into five groups: 20 samples from the control group, 48 samples from the mild or moderate convalescence group, 19 samples from the mild or moderate progression group, 36 samples from the severe or critical convalescence group, and 48 samples from the severe or critical progression group [<xref ref-type="bibr" rid="CR29">29</xref>]. In the original study, differential abundance analysis was performed between multiple severity groups.</p>
      <p id="Par30">Different from the original study, we leveraged DCATS’s capability to account for confounding factors, including age and gender through the GLM framework. We noticed both DCATS and the original study identified a few cell types with substantial proportion changes (denoted in by black asterisks in Fig. <xref rid="Fig4" ref-type="fig">4</xref>), such as, CD8+ T cells between severe progression and convalescence or healthy controls. On the other hand, DCATS also uniquely detects several cell types that show a significant proportion difference (highlighted in red).<fig id="Fig4"><label>Fig. 4</label><caption><p>DCATS is able to find new cell types with differential abundance in Ren dataset [<xref ref-type="bibr" rid="CR29">29</xref>]. Cell types’ proportion and conclusions on the Ren dataset given by DCATS. The significant bars in black color indicate that results are the same as the original paper, while the significant bars in red colors indicate newly discovered cell types with proportion differences</p></caption><graphic xlink:href="13059_2023_2980_Fig4_HTML" id="MO8"/></fig></p>
      <p id="Par31">Specifically, DCATS indicates a slightly different proportions of CD8+ T cells between the control group and the mild/moderate progression group (<inline-formula id="IEq25"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=0.067$$\end{document}</tex-math><mml:math id="M58"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>0.067</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq25.gif"/></alternatives></inline-formula>). This is consistent with what another study found when analyzing high-dimensional cytometry data from 125 COVID-19 patients, corresponding recovered group, and healthy control group [<xref ref-type="bibr" rid="CR30">30</xref>]. Even though the significance is moderate, the trend is strong. We also observed a significant difference in the proportion of monocytes between the mild/moderate progression group and corresponding recovery group (<inline-formula id="IEq26"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=0.013$$\end{document}</tex-math><mml:math id="M60"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>0.013</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq26.gif"/></alternatives></inline-formula>). This finding is consistent with a recent report from Qin and colleagues by using fluorescence-activated flow cytometry analysis to track the dynamic changes of monocytes in patients during the recovery stage from mild symptoms [<xref ref-type="bibr" rid="CR31">31</xref>]. DCATS also shows a significant difference in proportion between the control group and the mild/moderate progression group (<inline-formula id="IEq27"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=0.024$$\end{document}</tex-math><mml:math id="M62"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>0.024</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq27.gif"/></alternatives></inline-formula>) as well as the mild/moderate progression group and corresponding recovery group (<inline-formula id="IEq28"><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=0.021$$\end{document}</tex-math><mml:math id="M64"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>0.021</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq28.gif"/></alternatives></inline-formula>) regarding B cells. The same influence on B cells is also described in the original paper with a stronger signal given by DCATS between the control group and the severe/critical progression group (<inline-formula id="IEq29"><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=3.10\times 10^{-4}$$\end{document}</tex-math><mml:math id="M66"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>3.10</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>4</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq29.gif"/></alternatives></inline-formula>) as well as the severe/critical progression group and corresponding recovery group (<inline-formula id="IEq30"><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=2.48\times 10^{-6}$$\end{document}</tex-math><mml:math id="M68"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>2.48</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq30.gif"/></alternatives></inline-formula>). These new findings show that DCATS is a powerful tool in identifying cell types with significant proportion changes while keeping high specificity.</p>
    </sec>
  </sec>
  <sec id="Sec8">
    <title>Discussion</title>
    <p id="Par32">Comparing to simple statistical tests like Fisher’s exact test, DCATS preserves high sensitivity while having a good performance in specificity. Through multiple simulation and experimental datasets, we demonstrated that DCATS has an excellent overall performance and outperforms existing methods. Strikingly, DCATS has strong control of false positives but maintains a high level of power.</p>
    <p id="Par33">When benchmarking with other methods, Milo shows the unsatisfactory performance when we conducted the differential analysis at cell type level. This is partly because that Milo is designed at the neighborhood level, and there is no build-in metric to determine the differential abundance at cell type level, hence the proportion of neighborhoods with significant difference were used as a surrogate to indicate cell-type level significance. Despite the unsatisfactory performance for Milo, it shows its strength in detecting differential abundance neighborhoods when compared to other methods, and is a good choice when we have data with continuous cell state changes.</p>
    <p id="Par34">As DCATS corrects the misclassification bias based on the similarity matrix, the estimation of this matrix is an important step and can influence the performance of DCATS. Although, we found that KNN-based or empirical classification-based similarity matrices function well in general, the estimation of this matrix may be further improved in the future, in the light of more benchmarking datasets with accurate cell type annotations.</p>
    <p id="Par35">Lastly, the differential abundance of cell type naturally regards relative abundance. Hence, choosing the reference (i.e., non-differential cell types) can potentially affect the analysis results. Typically, we assume that the cell type abundance change is relatively small, hence using all remaining cell types is our default setting and demonstrate robust performance in broad scenarios. On the other hand, if the compositional change is substantial, all non-differential cell types will be affected and selecting certain cell types as a confident reference can reduce such impact, e.g., by DCATS’s automatic recommendation. Nonetheless, such a large compositional difference is not a typical scenario to apply DCATS and we suggest users perform the reference cell selection with caution.</p>
  </sec>
  <sec id="Sec9">
    <title>Conclusions</title>
    <p id="Par36">In this works, we introduced DCATS, in a form of beta-binomial regression, for detecting cell types with differential composition abundance. With the bias correction procedure based on a similarity matrix, DCATS provides a robust framework for differential composition analysis between conditions. As the input of DCATS is the count matrix which includes the number of cells in each cell type for each sample, it can deal with pre-defined cell type annotation, and can be easily adapted to any other single cell (multi-) omics data. This unique feature also allows DCATS to be implemented on data with self-adjusted annotation based on integration of multi-omics data or biological knowledge. We demonstrated the usability of DCATS in both simulated data set and real world data set.</p>
  </sec>
  <sec id="Sec10">
    <title>Method</title>
    <sec id="Sec11">
      <title>Composition correction with clustering similarity matrix</title>
      <p id="Par37">From a scRNA-seq experiment, we can obtain the cell counts <inline-formula id="IEq31"><alternatives><tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{x}=\{x_1, ..., x_K\}$$\end{document}</tex-math><mml:math id="M70"><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mo>=</mml:mo><mml:mo stretchy="false">{</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>K</mml:mi></mml:msub><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq31.gif"/></alternatives></inline-formula> of <italic>K</italic> cell types by performing cell clustering, e.g., Louvain method [<xref ref-type="bibr" rid="CR6">6</xref>] and K-means. If the clustering is unbiased and accurate, it is natural to take the cell type composition abundance <inline-formula id="IEq32"><alternatives><tex-math id="M71">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M72"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq32.gif"/></alternatives></inline-formula> proportional to the returned cell count vector <inline-formula id="IEq33"><alternatives><tex-math id="M73">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{n}$$\end{document}</tex-math><mml:math id="M74"><mml:mrow><mml:mi mathvariant="bold-italic">n</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq33.gif"/></alternatives></inline-formula>. However, due to the complex underlying structure, the clustering step is often inaccurate and may be systematically biased, hence it is crucial to correct the bias on composition abundance introduced by clustering method. In next subsection, we demonstrate that the clustering similarity matrix <italic>M</italic> (or similarity matrix) can be well approximated, e.g., by KNN graph. Specifically, the element <inline-formula id="IEq34"><alternatives><tex-math id="M75">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m_{i,j}$$\end{document}</tex-math><mml:math id="M76"><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq34.gif"/></alternatives></inline-formula> denotes the probability of a cell <italic>c</italic> in type <italic>i</italic> assigned to type <italic>j</italic> by the clustering method, namely, <inline-formula id="IEq35"><alternatives><tex-math id="M77">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(A_c=j | I_c = i) = m_{i,j}$$\end{document}</tex-math><mml:math id="M78"><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq35.gif"/></alternatives></inline-formula>, where <inline-formula id="IEq36"><alternatives><tex-math id="M79">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$A_c, I_c$$\end{document}</tex-math><mml:math id="M80"><mml:mrow><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq36.gif"/></alternatives></inline-formula> respectively denote the clustering assignment and genuine identity of cell <italic>c</italic>. This also means that <italic>M</italic> could be asymmetric and requires <inline-formula id="IEq37"><alternatives><tex-math id="M81">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sum _{k=1}^{K} m_{t, k} = 1$$\end{document}</tex-math><mml:math id="M82"><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq37.gif"/></alternatives></inline-formula> with <inline-formula id="IEq38"><alternatives><tex-math id="M83">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m_{t,k}\ge 0$$\end{document}</tex-math><mml:math id="M84"><mml:mrow><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>≥</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq38.gif"/></alternatives></inline-formula> for any cell type <italic>t</italic>.</p>
      <p id="Par38">Given the above definition and a pre-defined clustering similarity matrix <italic>M</italic>, we could have the likelihood of unknown cell type composition vector <inline-formula id="IEq39"><alternatives><tex-math id="M85">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M86"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq39.gif"/></alternatives></inline-formula> on observing the cell counts <inline-formula id="IEq40"><alternatives><tex-math id="M87">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{n}$$\end{document}</tex-math><mml:math id="M88"><mml:mrow><mml:mi mathvariant="bold-italic">n</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq40.gif"/></alternatives></inline-formula>, as follows,<disp-formula id="Equ4"><label>4</label><alternatives><tex-math id="M89">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \mathcal {L}(\varvec{z})= &amp; {} P(\varvec{n} | \varvec{z}, M) = \prod _{j=1}^{K} \prod _{c=1}^{n_j} \left[ \sum _{i=1}^{K} P(I_c=i|\varvec{z}) P(A_c=j|I_c=i) \right] \nonumber \\= &amp; {} \prod _{j=1}^{K} \prod _{c=1}^{n_j} \left[ \sum _{i=1}^{K} z_i m_{i,j} \right] = \prod _{j=1}^{K} \left[ \sum _{i=1}^{K} z_i m_{i,j} \right] ^{n_j} = \prod _{j=1}^{K} \nu _j^{n_j}, \end{aligned}$$\end{document}</tex-math><mml:math id="M90" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi mathvariant="script">L</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">n</mml:mi></mml:mrow><mml:mo stretchy="false">|</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo>,</mml:mo><mml:mi>M</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>c</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:munderover><mml:mfenced close="]" open="["><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfenced></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>c</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:munderover><mml:mfenced close="]" open="["><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mfenced><mml:mo>=</mml:mo><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msup><mml:mfenced close="]" open="["><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mfenced><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:msup><mml:mo>=</mml:mo><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msubsup><mml:mi>ν</mml:mi><mml:mi>j</mml:mi><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:msubsup><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ4.gif" position="anchor"/></alternatives></disp-formula>which is equivalent to a multinomial distribution parametrised by an adjusted composition abundance vector <inline-formula id="IEq41"><alternatives><tex-math id="M91">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\nu }=\varvec{z} \times M$$\end{document}</tex-math><mml:math id="M92"><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">ν</mml:mi></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo>×</mml:mo><mml:mi>M</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq41.gif"/></alternatives></inline-formula>.</p>
      <p id="Par39">Algebraically, we could take <inline-formula id="IEq42"><alternatives><tex-math id="M93">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}=M^{-1}\times \varvec{\nu }$$\end{document}</tex-math><mml:math id="M94"><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mi>M</mml:mi><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mo>×</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">ν</mml:mi></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq42.gif"/></alternatives></inline-formula> with inverting the similarity matrix <italic>M</italic>. However, this simplistic treatment does not guarantee that the solution satisfies with <inline-formula id="IEq43"><alternatives><tex-math id="M95">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_t \ge 0$$\end{document}</tex-math><mml:math id="M96"><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo>≥</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq43.gif"/></alternatives></inline-formula> and <inline-formula id="IEq44"><alternatives><tex-math id="M97">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_t \le 1$$\end{document}</tex-math><mml:math id="M98"><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo>≤</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq44.gif"/></alternatives></inline-formula> for any cell type <italic>t</italic>. In practice, constraints have been introduced to address this optimisation problem, e.g., [<xref ref-type="bibr" rid="CR15">15</xref>, <xref ref-type="bibr" rid="CR16">16</xref>], though it occasionally returns unstable solutions.</p>
      <p id="Par40">Here, we introduce an Expectation-Maximization (EM) algorithm to achieve a maximum likelihood estimate of the cell type composition <inline-formula id="IEq45"><alternatives><tex-math id="M99">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M100"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq45.gif"/></alternatives></inline-formula> by introducing <inline-formula id="IEq46"><alternatives><tex-math id="M101">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu _{j,i}$$\end{document}</tex-math><mml:math id="M102"><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq46.gif"/></alternatives></inline-formula> as the expected probability of clustered cell type <italic>j</italic> coming from the real cell type <italic>i</italic>. Though this auxiliary variable <inline-formula id="IEq47"><alternatives><tex-math id="M103">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu _{j,i}$$\end{document}</tex-math><mml:math id="M104"><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq47.gif"/></alternatives></inline-formula> functions like the inverse similarity matrix <inline-formula id="IEq48"><alternatives><tex-math id="M105">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$M^{-1}$$\end{document}</tex-math><mml:math id="M106"><mml:msup><mml:mi>M</mml:mi><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq48.gif"/></alternatives></inline-formula>, its interpretation and calculation are different. Here, we could interpret <inline-formula id="IEq49"><alternatives><tex-math id="M107">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu _{j,i}$$\end{document}</tex-math><mml:math id="M108"><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq49.gif"/></alternatives></inline-formula> as the posterior probability of clustered cell type <italic>j</italic> coming from the real cell type <italic>i</italic>, hence can be calculated in a forward way (i.e., the E step) if given an estimated the true composition vector <inline-formula id="IEq50"><alternatives><tex-math id="M109">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M110"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq50.gif"/></alternatives></inline-formula> in a previous step, as follows,<disp-formula id="Equ5"><label>5</label><alternatives><tex-math id="M111">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \mu _{j,i} = P(I_c=i|A_c=j) = \frac{P(A_c=j|I_c=i)P(I_c=i|\varvec{z})}{\sum _{t=1}^{K} P(A_c=j|I_c=t)P(I_c=t|\varvec{z})} = \frac{m_{i,j} z_i}{\sum _{t=1}^{K} m_{t,j}z_t} \end{aligned}$$\end{document}</tex-math><mml:math id="M112" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>z</mml:mi><mml:mi>t</mml:mi></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ5.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par41">Within the EM algorithm, once we have the auxiliary variable <inline-formula id="IEq51"><alternatives><tex-math id="M113">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }$$\end{document}</tex-math><mml:math id="M114"><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq51.gif"/></alternatives></inline-formula>, we can maximize the log likelihood in Eq. (<xref rid="Equ4" ref-type="disp-formula">4</xref>) by taking its derivative as zeros for each cell type, together with a Lagrange multiplier on the constraint <inline-formula id="IEq52"><alternatives><tex-math id="M115">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sum _{k=1}^{K} z_k = 1$$\end{document}</tex-math><mml:math id="M116"><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msub><mml:mi>z</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq52.gif"/></alternatives></inline-formula>. By solving these equations (i.e., M-step), we can obtain an updated <inline-formula id="IEq53"><alternatives><tex-math id="M117">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M118"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq53.gif"/></alternatives></inline-formula> with <inline-formula id="IEq54"><alternatives><tex-math id="M119">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }$$\end{document}</tex-math><mml:math id="M120"><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq54.gif"/></alternatives></inline-formula> calculated from a previous step.<disp-formula id="Equ6"><label>6</label><alternatives><tex-math id="M121">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} z_i = \frac{\sum _{j=1}^{K}\mu _{j,i} n_j}{\sum _{t=1}^{K}\sum _{j=1}^{K}\mu _{j,t} n_j}. \end{aligned}$$\end{document}</tex-math><mml:math id="M122" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ6.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par42">Therefore, by alternating the E step in Eq. (<xref rid="Equ5" ref-type="disp-formula">5</xref>) and M step in Eq. (<xref rid="Equ6" ref-type="disp-formula">6</xref>), we can achieve a maximum likelihood estimate of corrected cell type composition vector <inline-formula id="IEq55"><alternatives><tex-math id="M123">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M124"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq55.gif"/></alternatives></inline-formula> once the log likelihood stops increasing.</p>
    </sec>
    <sec id="Sec12">
      <title>Estimation of clustering similarity matrix</title>
      <p id="Par43">As mentioned above, the clustering of single-cell is often inaccurate with systematic bias. So we introduce a similarity matrix to describe this kind of misclassification bias. We assume that this kind of bias comes from the similarity between different cell types and variety within each cell type. Thus, the conditions of samples where our single-cell data comes from do not influence the direction of this bias. In other words, misclassification error introduced by the clustering process is consistent across all samples coming from different conditions.</p>
      <p id="Par44">Currently, DCATS supports three strategies for estimating the confusion matrix: Uniform, KNN and classification. Firstly, the uniform confusion matrix is defined as<disp-formula id="Equ7"><label>7</label><alternatives><tex-math id="M125">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \textbf{M}^{(u)} = (1 - \epsilon (K+1)/K) \textbf{I} + \epsilon / K \end{aligned}$$\end{document}</tex-math><mml:math id="M126" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msup><mml:mi mathvariant="bold">M</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:mi>ϵ</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>K</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo stretchy="false">/</mml:mo><mml:mi>K</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi mathvariant="bold">I</mml:mi><mml:mo>+</mml:mo><mml:mi>ϵ</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ7.gif" position="anchor"/></alternatives></disp-formula>where <italic>K</italic> is the number of cell types; <inline-formula id="IEq56"><alternatives><tex-math id="M127">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\textbf{I}$$\end{document}</tex-math><mml:math id="M128"><mml:mi mathvariant="bold">I</mml:mi></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq56.gif"/></alternatives></inline-formula> is an identify matrix and <inline-formula id="IEq57"><alternatives><tex-math id="M129">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\epsilon$$\end{document}</tex-math><mml:math id="M130"><mml:mi>ϵ</mml:mi></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq57.gif"/></alternatives></inline-formula> is the level of confusion, which are set to 0.05 by default. It describes an unbiased misclassification across all the cell types. It means that one cell from a cell type have equal chance to be assigned to rest other cell types.</p>
      <p id="Par45">Secondly, the KNN-based similarity matrix is estimated from the knn graph based on the transcriptome, e.g., provided by Seurat [<xref ref-type="bibr" rid="CR23">23</xref>]. It calculates the proportion of neighborhoods that are regarded as other cell types. In this case, DCATS corrects cell proportions mainly based on the information of similarity between different cell types and variety within each cell types. By defining <inline-formula id="IEq58"><alternatives><tex-math id="M131">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n_{x,j}$$\end{document}</tex-math><mml:math id="M132"><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq58.gif"/></alternatives></inline-formula> as the number of neighbors for cell <italic>x</italic> that are classified as cell type <italic>j</italic>, we can calculate KNN-based similarity matrix, e.g., its entry <inline-formula id="IEq59"><alternatives><tex-math id="M133">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m_{i,j}$$\end{document}</tex-math><mml:math id="M134"><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq59.gif"/></alternatives></inline-formula> for similarity (misclassification) from cluster <italic>i</italic> to <italic>j</italic> as follows:<disp-formula id="Equ14"><alternatives><tex-math id="M135">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} m_{i,j} = \frac{\sum _{x=1}^{x_i} n_{x,j}}{\sum _{j=1}^{K}\sum _{x=1}^{x_i} n_{x,j}} \end{aligned}$$\end{document}</tex-math><mml:math id="M136" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:msubsup><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:msubsup><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ14.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par46">We realize in some situations, the cell clustering process might not be performed using the Seurat pipeline. It is also a common situation where people perform the clustering process based on part of the markers which they are interested in. With the development of technology, more information can be used for single cell clustering including spatial information as well as biophysical feature. In above cases, knn matrix given by the Seurat pipeline cannot fully capture the bias introduced through the clustering process.</p>
      <p id="Par47">Based on the above reason, we introduce the third way to estimate a similarity matrix. The input for estimating the similarity matrix will be a data frame containing a set of variables that the user believe will influence the result of the clustering process as well as the cell type labels for each cell. We then use 5-fold cross validation and use support vector machine as the classifier to estimate the similarity matrix.</p>
    </sec>
    <sec id="Sec13">
      <title>Detecting differential composition abundance</title>
      <sec id="Sec14">
        <title>Generalized linear model</title>
        <p id="Par48"> We assume the corrected cell counts <inline-formula id="IEq60"><alternatives><tex-math id="M137">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{s,j}$$\end{document}</tex-math><mml:math id="M138"><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq60.gif"/></alternatives></inline-formula> for cell type <italic>j</italic> given sample <italic>s</italic> follow beta-binomial distribution. We then describe <inline-formula id="IEq61"><alternatives><tex-math id="M139">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{s,j}$$\end{document}</tex-math><mml:math id="M140"><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq61.gif"/></alternatives></inline-formula> with a beta-binomial generalized linear model(GLM) with a logit link function for each covariate <italic>i</italic>, as follows,<disp-formula id="Equ8"><label>8</label><alternatives><tex-math id="M141">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} z_{s,j}\sim &amp; {} \texttt{Binom}(n_s, p_{s,j})\nonumber \\ p_{s,j}\sim &amp; {} \texttt{Beta}(\alpha _{s,j}, \beta _{s,j}) \end{aligned}$$\end{document}</tex-math><mml:math id="M142" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi mathvariant="monospace">Binom</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>s</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi mathvariant="monospace">Beta</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ8.gif" position="anchor"/></alternatives></disp-formula>where we reparameterized with the mean <inline-formula id="IEq62"><alternatives><tex-math id="M143">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\bar{p}_{s,j}$$\end{document}</tex-math><mml:math id="M144"><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq62.gif"/></alternatives></inline-formula> and over dispersion <inline-formula id="IEq63"><alternatives><tex-math id="M145">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi _j$$\end{document}</tex-math><mml:math id="M146"><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq63.gif"/></alternatives></inline-formula> as <inline-formula id="IEq64"><alternatives><tex-math id="M147">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\alpha _{s,j} = \bar{p}_{s,j} (1/\phi _j - 1)$$\end{document}</tex-math><mml:math id="M148"><mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq64.gif"/></alternatives></inline-formula> and <inline-formula id="IEq65"><alternatives><tex-math id="M149">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\beta _{s,j} = (1-\bar{p}_{s,j}) (1/\phi _j - 1)$$\end{document}</tex-math><mml:math id="M150"><mml:mrow><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq65.gif"/></alternatives></inline-formula>. As described below, the mean parameter <inline-formula id="IEq66"><alternatives><tex-math id="M151">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\bar{p}_{s,j}$$\end{document}</tex-math><mml:math id="M152"><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq66.gif"/></alternatives></inline-formula> is regressed to a set of covariates under different hypothesis. The weights for covariates and <inline-formula id="IEq67"><alternatives><tex-math id="M153">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi _j$$\end{document}</tex-math><mml:math id="M154"><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq67.gif"/></alternatives></inline-formula> will be optimized to achieve maximum likelihood, through the <italic>aod</italic> package. The <italic>p</italic> value can be calculated with a likelihood ratio test by comparing the log likelihoods in both alternative and null hypotheses.</p>
        <p id="Par49"><italic>Full mode and Null mode</italic> In DCATS, we allow using both “full mode” and “null mode” to finish the differential abundance analysis. When using null mode, we compare these two models:<disp-formula id="Equ9"><label>9</label><alternatives><tex-math id="M155">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \mathbf {H_0:}{} &amp; {} \quad \texttt{logit}(\bar{p}_{s,j}) = w_0\nonumber \\ \mathbf {H_1:}{} &amp; {} \quad \texttt{logit}(\bar{p}_{s,j}) = w_0 + w_i \times c_{s,i} \end{aligned}$$\end{document}</tex-math><mml:math id="M156" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow><mml:msub><mml:mi mathvariant="bold">H</mml:mi><mml:mn mathvariant="bold">0</mml:mn></mml:msub><mml:mo>:</mml:mo></mml:mrow><mml:mrow/></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mspace width="1em"/><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mrow><mml:msub><mml:mi mathvariant="bold">H</mml:mi><mml:mn mathvariant="bold">1</mml:mn></mml:msub><mml:mo>:</mml:mo></mml:mrow><mml:mrow/></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mspace width="1em"/><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mi>c</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ9.gif" position="anchor"/></alternatives></disp-formula>In this case, we only consider the influence of the factor we are evaluating. When using full model, we compare these two models as follows,<disp-formula id="Equ10"><label>10</label><alternatives><tex-math id="M157">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \mathbf {H_0:}{} &amp; {} \quad \texttt{logit}(\bar{p}_{s,j}) = w_0 + \varvec{w}^{\top } \varvec{c}_s; w_i = 0\nonumber \\ \mathbf {H_1:}{} &amp; {} \quad \texttt{logit}(\bar{p}_{s,j}) = w_0 + \varvec{w}^{\top } \varvec{c}_s \end{aligned}$$\end{document}</tex-math><mml:math id="M158" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow><mml:msub><mml:mi mathvariant="bold">H</mml:mi><mml:mn mathvariant="bold">0</mml:mn></mml:msub><mml:mo>:</mml:mo></mml:mrow><mml:mrow/></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mspace width="1em"/><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub><mml:mo>;</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mrow><mml:msub><mml:mi mathvariant="bold">H</mml:mi><mml:mn mathvariant="bold">1</mml:mn></mml:msub><mml:mo>:</mml:mo></mml:mrow><mml:mrow/></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mspace width="1em"/><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ10.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq68"><alternatives><tex-math id="M159">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{c}_s$$\end{document}</tex-math><mml:math id="M160"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq68.gif"/></alternatives></inline-formula> and <inline-formula id="IEq69"><alternatives><tex-math id="M161">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{w}$$\end{document}</tex-math><mml:math id="M162"><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq69.gif"/></alternatives></inline-formula> are respecitvely for the weight and covariate vectors for sample <italic>s</italic>. Under the null hypothesis, the <inline-formula id="IEq70"><alternatives><tex-math id="M163">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$w_i$$\end{document}</tex-math><mml:math id="M164"><mml:msub><mml:mi>w</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq70.gif"/></alternatives></inline-formula> will assumed to be 0. In this case, we test the differential abundance of different condition controlling the influence of other confounding covariates.</p>
      </sec>
      <sec id="Sec15">
        <title>Fixed overdispersion term</title>
        <p id="Par50">We found out that when the numbers of biological replicates are low, the over-dispersion term <inline-formula id="IEq71"><alternatives><tex-math id="M165">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi$$\end{document}</tex-math><mml:math id="M166"><mml:mi>ϕ</mml:mi></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq71.gif"/></alternatives></inline-formula> can be over-estimated. Thus, DCATS allows estimating a global over-dispersion term across all cell types, where we assume that the over-dispersion <inline-formula id="IEq72"><alternatives><tex-math id="M167">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi _j$$\end{document}</tex-math><mml:math id="M168"><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq72.gif"/></alternatives></inline-formula> remains the same across for any cell type <italic>j</italic>. To estimate a global dispersion term, we fit all cell types in one joint beta-binomial GLM by taking the design matrix as the cell type indicators. Then, the dispersion term estimated here is treated as a global dispersion and will be taken as a prefixed value when performing the main round GLM for each cell type.</p>
        <p id="Par51">Except for the mode we used in main text (Using KNN matrix as the similarity matrix and fixing the overdispersion term), three other modes of DCATS are tested in the simulation data (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S2, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S4 , Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S7–11).<list list-type="bullet"><list-item><p id="Par52">“wtoPhi_wtoEM” indicates using basic beta-binomial distribution without bias correction or fixing over-dispersion term.</p></list-item><list-item><p id="Par53">“wtoPhi_emK” indicates without fixing the over dispersion term Phi but clustering bias corrected by KNN matrix.</p></list-item><list-item><p id="Par54">“wtoPhi_emU” indicates without fixing the over dispersion term Phi but clustering bias corrected by uniform matrix.</p></list-item><list-item><p id="Par55">“estPhi_wtoEM” indicates using fixing the over dispersion term Phi but no clustering bias correction.</p></list-item><list-item><p id="Par56">“estPhi_emK” indicates using fixing the over dispersion term Phi and clustering bias corrected by KNN matrix.</p></list-item><list-item><p id="Par57">“estPhi_emU” indicates using fixing the over dispersion term Phi and clustering bias corrected by uniform matrix.</p></list-item></list></p>
      </sec>
    </sec>
    <sec id="Sec16">
      <title>Use reference cell types for normalization</title>
      <p id="Par58">When one cell type has extreme proportion change, the proportions of the rest cell types will be largely influenced, which might lead to false positives of differential abundance testing. Using known unchanged cell types as reference groups for normalization will offset the influence of massive cell types change. When using the total cell number as the normalization term, we have<disp-formula id="Equ11"><label>11</label><alternatives><tex-math id="M169">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \texttt{logit}(E(\frac{z_{s,j}}{n_s})) = w_0 + \varvec{w}^{\top } \varvec{c}_s \end{aligned}$$\end{document}</tex-math><mml:math id="M170" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>E</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mfrac><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mfrac><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ11.gif" position="anchor"/></alternatives></disp-formula>where values in <inline-formula id="IEq73"><alternatives><tex-math id="M171">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{w}^{\top }$$\end{document}</tex-math><mml:math id="M172"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq73.gif"/></alternatives></inline-formula> could be zero based on different models. When using the reference group as the normalization term, we have<disp-formula id="Equ12"><label>12</label><alternatives><tex-math id="M173">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \texttt{logit}(E(\frac{z_{s,j}}{\sum _{r \in R} z_{s,r}})) = w_0 + \varvec{w}^{\top } \varvec{c}_s \end{aligned}$$\end{document}</tex-math><mml:math id="M174" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>E</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mfrac><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>r</mml:mi><mml:mo>∈</mml:mo><mml:mi>R</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ12.gif" position="anchor"/></alternatives></disp-formula>where <italic>R</italic> denotes the reference group.</p>
      <p id="Par59">We recommend using more than one cell type and more than 25% of total cells as the reference group to guarantee the stability of the normalization term.</p>
      <p id="Par60">DCATS also support the recommendation of the cell types used for reference. Namely, DCATS first calculates the <italic>p</italic>-values for each cell type. Then, it orders the cell types from high to low based on the <italic>p</italic>-values and provides the possible reference cell types based on this order. Additionally, DCATS calculates the proportion of cell counts for different numbers of reference cell types and suggests a recommended number.</p>
    </sec>
    <sec id="Sec17">
      <title>Theoretical simulation</title>
      <p id="Par61">The input of DCATS is combined with two parts. The cell count matrix <inline-formula id="IEq74"><alternatives><tex-math id="M175">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_i$$\end{document}</tex-math><mml:math id="M176"><mml:msub><mml:mi>C</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq74.gif"/></alternatives></inline-formula> denotes numbers of cells we observe for each cell type in each sample coming from same condition <italic>i</italic>. For each analysis, DCATS can only compare cell count matrices coming from two condition. Another part is the similarity matrix <italic>M</italic> we describe above.</p>
      <p id="Par62">We first simulated two count matrices <inline-formula id="IEq75"><alternatives><tex-math id="M177">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_1, C_2$$\end{document}</tex-math><mml:math id="M178"><mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq75.gif"/></alternatives></inline-formula> directly to demonstrate that introducing the similarity matrix to correct the unknown cell type composition vector <inline-formula id="IEq76"><alternatives><tex-math id="M179">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }$$\end{document}</tex-math><mml:math id="M180"><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq76.gif"/></alternatives></inline-formula> is important for the differential composition analysis. The numbers of replicates for condition 1 and condition 2 were 2 and 3 respectively. The total cell numbers were 2000 for each sample in both condition. We defined the genuine proportions of the three cells types were [1/3, 1/3, 1/3] and [1/3, 1/2, 1/6] in conditions 1 and 2, respectively. Using genuine proportions times 70 as concentration parameters, we generated the unknown cell type composition vector of condition 1 and condition 2 from Dirichlet distribution. For each sample, the total cell number 2000 and <inline-formula id="IEq77"><alternatives><tex-math id="M181">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }_{\varvec{i}}$$\end{document}</tex-math><mml:math id="M182"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">i</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq77.gif"/></alternatives></inline-formula> were used to generate a cell count vector from multinomial distribution. Based on the similarity matrix we designed (Fig. <xref rid="Fig1" ref-type="fig">1</xref>B), the misclassification errors were introduced by reassigning cells into different cell types.</p>
      <p id="Par63">Next, we tried to demonstrate the effectiveness of the bias correction step. We first used DCATS and Fisher’s exact test to perform the differential composition analysis. We then used the similarity matrix we designed to correct the miscalssification error we introduced. In this case, we used the true similarity matrix to do this bias correction process. For each simulation, we repeated the above process 50 times and calculate MCC, sensitivity and specificity. Overall, we got 50 Matthews correlation coefficient (MCC), sensitivity and specificity for 50 simulation.</p>
    </sec>
    <sec id="Sec18">
      <title>Simulation with single-cell RNA gene count matrices</title>
      <p id="Par64">When analyzing single cell RNA sequencing (scRNA-seq) data, we always start from gene expression matrix. Here, we designed a simulation process to mimic the process from getting gene expression matrix to analyzing differential compositions. We first used splatter [<xref ref-type="bibr" rid="CR26">26</xref>] to generate a large cell pool including different cell types. We then generated a proportion vector <inline-formula id="IEq78"><alternatives><tex-math id="M183">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{p}_{\varvec{s}}^{\varvec{(i)}}$$\end{document}</tex-math><mml:math id="M184"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">s</mml:mi></mml:mrow></mml:mrow><mml:mrow><mml:mo mathvariant="bold" stretchy="false">(</mml:mo><mml:mi mathvariant="bold-italic">i</mml:mi><mml:mo mathvariant="bold" stretchy="false">)</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq78.gif"/></alternatives></inline-formula> for each sample <italic>s</italic> from condition <italic>i</italic> following a Dirichlet distribution. Defined genuine proportions were used as concentration parameters. Given a total cell number, a cell count vector <inline-formula id="IEq79"><alternatives><tex-math id="M185">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }_{\varvec{s}}^{\varvec{(i)}}$$\end{document}</tex-math><mml:math id="M186"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">s</mml:mi></mml:mrow></mml:mrow><mml:mrow><mml:mo mathvariant="bold" stretchy="false">(</mml:mo><mml:mi mathvariant="bold-italic">i</mml:mi><mml:mo mathvariant="bold" stretchy="false">)</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq79.gif"/></alternatives></inline-formula> was generated from multinomial distribution.</p>
      <p id="Par65">In a default setting, each condition contained 3 replicates, and 4 out of 8 cells types with differential composition abundance. The genuine proportion was [0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.2, 0.2] in condition 1 and [0.05, 0.15, 0.1, 0.1, 0.1, 0.2, 0.2, 0.1] in condition 2. For each sample, the total cell number was 3000. We also changed the number of replicates to 2 and 4, and the number of cell types to 10 and 12. When the number of cell types equalled to 10, the genuine proportions were [0.05, 0.05, 0.1, 0.1, 0.1, 0.1, 0.1, 0.05, 0.2, 0.15] and [0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1] in condition 1 and condition 2, respectively. When the number of cell types was 12, the bass proportions were [0.1, 0.1, 0.1, 0.1, 0.05, 0.05, 0.05, 0.15, 0.05, 0.05, 0.1, 0.1] and [0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.05, 0.05, 0.05, 0.05].</p>
      <p id="Par66">Based on the cell count vector <inline-formula id="IEq80"><alternatives><tex-math id="M187">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }_{\varvec{s}}^{\varvec{(i)}}$$\end{document}</tex-math><mml:math id="M188"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">s</mml:mi></mml:mrow></mml:mrow><mml:mrow><mml:mo mathvariant="bold" stretchy="false">(</mml:mo><mml:mi mathvariant="bold-italic">i</mml:mi><mml:mo mathvariant="bold" stretchy="false">)</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq80.gif"/></alternatives></inline-formula>, we randomly selected cells as well as their gene expression profiles. We can therefore got a gene expression matrix for each sample. Then, we used Seurat [<xref ref-type="bibr" rid="CR23">23</xref>] pipeline to do the pre-processing as well as the clustering process. The cluster annotation of each cell was treated as input for the downstream analysis. We compared DCATS with other five tests designed for differential composition analysis which are Fisher’s exact test, scDC [<xref ref-type="bibr" rid="CR14">14</xref>], diffcyt [<xref ref-type="bibr" rid="CR12">12</xref>], milo [<xref ref-type="bibr" rid="CR8">8</xref>], and speckle [<xref ref-type="bibr" rid="CR10">10</xref>] (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1).</p>
      <p id="Par67">As milo aims to detect cell stage perturbations based on k-nearest neighbor graphs but not cell type levels, we also did the differential abundance testing on the neighborhoods level by assuming all the neighborhoods were influenced by condition if that cell types have differential proportions. In this case, we only considered neighborhoods having more than 80% of cells coming from one cell type and used neighborhoods detected by milo for testing using Fisher’s exact test, speckle [<xref ref-type="bibr" rid="CR10">10</xref>] and DCATS. For each scenario, we pooled the results coming from 30 times simulations together to calculate the F1 score, MCC, AUC and area under the precision-recall curve (PRAUC). The confidence interval of F1 score, MCC, AUC and PRAUC were calculated by bootstrapping the testing results 50 times.</p>
    </sec>
    <sec id="Sec19">
      <title>Adding other confounding covariates</title>
      <p id="Par68">To demonstrate that DCATS can control the influence of confounding covariates, we designed a simulation with eight cell types. First four of them had different proportions in different conditions, and rest four of them had same proportions in different conditions. We also added two confounding covariates, age and gender which influenced the proportions of four among eight cell types. Using 15 years old as the baseline, one year increase in age led to 0.05 decrease of concentration parameters in cell type 1 and cell type 5. It also led to 0.05 increase of concentration parameters in cell type 2 and cell type 6. Comparing to female, male had 2 increase of concentration parameters in cell type 2 and 6, 2 decrease in cell type 1 and cell type 5. (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S5) The gender for each sample was randomly selected from female or male. The age was randomly select from 15 to 45. The influence of condition, age and gender was additive and result in the final proportion of each cell types in each biological replicate. Overall, we had 10 biological replicates in each condition with different ages and genders. We simulated proportions based on the true designed proportions from a Dirichlet distribution and cell numbers based on the simulated proportions from the multinomial distribution. Based on the simulated cell counts, we simulated gene expression matrices and did the differential abundance analysis as described previously.</p>
    </sec>
    <sec id="Sec20">
      <title>Simulation starting from cell counts differences</title>
      <p id="Par69">To demonstrate that DCATS can handle spurious effects arising from compositionality characteristics — namely, when the proportion of one cell type increases, the proportions of the remaining cell types decrease — we conducted a simulation scenario where one cell type had differential abundance with increased counts, while the remaining cell types had the same counts. In this case, the remaining cell types had lower proportions than the original composition, but these proportion differences were merely side effects and should not be detected as differential abundance.</p>
      <p id="Par70">We simulated eight cell types with count units [1, 4, 4, 4, 4, 4, 4, 4] in condition 1 and [20, 4, 4, 4, 4, 4, 4, 4] in condition 2. The first cell type had a 20-fold count increase in condition 2, while the remaining cell types remained the same. We calculated the proportions of each cell type and used these proportions for the simulation. The proportion of each cell type in condition 1 was [0.034, 0.138, 0.138, 0.138, 0.138, 0.138, 0.138, 0.138], while the proportion of each cell type in condition 2 was [0.417, 0.083, 0.083, 0.083, 0.083, 0.083, 0.083, 0.083]. We simulated three replicates for each condition. When the total count remained at 3000 in both condition 1 and condition 2, the observed cell count of the first cell type showed a huge increase in condition 2, while the cell counts of the remaining cell types decreased (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S11). The cell selection and testing procedures were the same as in the above section of simulating cell counts matrices.</p>
    </sec>
    <sec id="Sec21">
      <title>Methods for benchmark</title>
      <sec id="Sec22">
        <title>Fisher’s exact test</title>
        <p id="Par71">As Fisher’s exact test does not support multiple replicates, we added the cell counts numbers of all replicates in each condition and tested based on the sum of cell counts.</p>
      </sec>
      <sec id="Sec23">
        <title>diffcyt</title>
        <p id="Par72">diffcyt [<xref ref-type="bibr" rid="CR12">12</xref>] is a package designed for differential discovery analyses in high-dimensional cytometry data. In order to adopt it to analyze scRNA-seq data. We first create data template using random generated flowset data, then replaced it with meta-data of data we simulate. We used default for the rest setting.</p>
      </sec>
      <sec id="Sec24">
        <title>ANCOMBC</title>
        <p id="Par73">ANCOMBC [<xref ref-type="bibr" rid="CR11">11</xref>] is designed for differential abundance analysis for microbiome data. We use the count matrix and design matrix to create TreeSummarizedExperiment objects [<xref ref-type="bibr" rid="CR32">32</xref>]. These objects are used as input for ANCOMBC. Rest parameters are set as default. The count matrices we used include the count matrix calculated from Seurat clustering results (ancombc), and the bias-corrected count matrices calculated from DCATS (bcancombc).</p>
      </sec>
      <sec id="Sec25">
        <title>milo</title>
        <p id="Par74">milo [<xref ref-type="bibr" rid="CR8">8</xref>] aims to detect cell state changes in neighborhoods level, while both our simulated data and real-world data only have ground truth in cell type level. Thus, we linked neighborhoods with cell type based on the majority cell in that neighborhoods as what milo’s authors did in the milo paper [<xref ref-type="bibr" rid="CR8">8</xref>]. We first used FDR&lt;0.1 as threshold to define whether one neighborhood has cell state changes, and calculated how many more neighborhoods one condition has dominant size comparing to the other condition as well as the proportion of this difference among all neighborhoods that belong to that cell type. This proportion is regarded as perturbation level. Inferring from the Kang dataset [<xref ref-type="bibr" rid="CR4">4</xref>] which works as the negative control, we defined that one cell type shows significant proportion changes when the perturbation level is larger than 20%. Due to the less variety of simulated data, this threshold is setted to be 0 in simulated data in order to get better performance of milo.</p>
      </sec>
      <sec id="Sec26">
        <title>speckle and scDC</title>
        <p id="Par75">For speckle [<xref ref-type="bibr" rid="CR10">10</xref>] and scDC [<xref ref-type="bibr" rid="CR14">14</xref>], we used default setting and standard pipeline as described in the github page/tutorials of these two tools.</p>
      </sec>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec27">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="13059_2023_2980_MOESM1_ESM.pdf">
            <caption>
              <p><bold>Additional file 1.</bold> Supplementary Table S1-S10 and Supplementary Figures S1-S14. Additional file 1 contains Supplementary Figures and Supplementary Tables.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="13059_2023_2980_MOESM2_ESM.pdf">
            <caption>
              <p><bold>Additional file 2.</bold> Review history.</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p>
        <bold>Publisher’s Note</bold>
      </p>
      <p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank members in Ho lab, Huang lab from the University of Hong Kong, and Xuegong Zhang lab from Tsinghua University, especially Aaron Kwok, Weizhong Zheng, Ken Yu, and Junyi Chen, for fruitful discussions.</p>
    <sec id="FPar1">
      <title>Review history</title>
      <p id="Par76">The review history is available as Additional file <xref rid="MOESM1" ref-type="media">2</xref>.</p>
    </sec>
    <sec id="FPar2">
      <title>Peer review information</title>
      <p id="Par77">Andrew Cosgrove and Anahita Bishop were the primary editors of this article and managed its editorial process and peer review in collaboration with the rest of the editorial team.</p>
    </sec>
  </ack>
  <notes notes-type="author-contribution">
    <title>Authors’ contributions</title>
    <p>YH and JWKH conceived the ideas and designed the study. XL developed the method, implemented the R package, and performed all the experiments. CC supported the initial development of the method, collected some data, and supported evaluation. KM performed some simulation experiments and analysis. XL, YH, and JWKH wrote the paper. All authors read and approved the final version of the manuscript.</p>
  </notes>
  <notes notes-type="funding-information">
    <title>Funding</title>
    <p>This work was supported by AIR@InnoHK administered by Innovation and Technology Commission.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Availability of data and materials</title>
    <p>All datasets used in the paper are previously published and can be found in NCBI GEO database: GSE96583 [<xref ref-type="bibr" rid="CR4">4</xref>], GSE92332 [<xref ref-type="bibr" rid="CR28">28</xref>], and GSE158055 [<xref ref-type="bibr" rid="CR29">29</xref>].</p>
    <p> This algorithm is implemented as an R package named DCATS which is available at Github [<xref ref-type="bibr" rid="CR33">33</xref>] under the MIT license. The codes for simulation and analysis are avalible in Github [<xref ref-type="bibr" rid="CR34">34</xref>]. The source code used in this paper is deposited in Zenodo with DOI: 10.5281/zenodo.7969592 [<xref ref-type="bibr" rid="CR35">35</xref>].</p>
  </notes>
  <notes>
    <title>Declarations</title>
    <notes id="FPar3">
      <title>Ethics approval and consent to participate</title>
      <p id="Par78">Not applicable.</p>
    </notes>
    <notes id="FPar4">
      <title>Consent for publication</title>
      <p id="Par79">All authors have approved the manuscript for submission.</p>
    </notes>
    <notes id="FPar5" notes-type="COI-statement">
      <title>Competing interests</title>
      <p id="Par80">The authors declare that they have no competing interests.</p>
    </notes>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Paik</surname>
            <given-names>DT</given-names>
          </name>
          <name>
            <surname>Cho</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Tian</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Chang</surname>
            <given-names>HY</given-names>
          </name>
          <name>
            <surname>Wu</surname>
            <given-names>JC</given-names>
          </name>
        </person-group>
        <article-title>Single-cell RNA sequencing in cardiovascular development, disease and medicine</article-title>
        <source>Nat Rev Cardiol.</source>
        <year>2020</year>
        <volume>17</volume>
        <issue>8</issue>
        <fpage>457</fpage>
        <lpage>473</lpage>
        <pub-id pub-id-type="doi">10.1038/s41569-020-0359-y</pub-id>
        <?supplied-pmid 32231331?>
        <pub-id pub-id-type="pmid">32231331</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Potter</surname>
            <given-names>SS</given-names>
          </name>
        </person-group>
        <article-title>Single-cell RNA sequencing for the study of development, physiology and disease</article-title>
        <source>Nat Rev Nephrol.</source>
        <year>2018</year>
        <volume>14</volume>
        <issue>8</issue>
        <fpage>479</fpage>
        <lpage>492</lpage>
        <pub-id pub-id-type="doi">10.1038/s41581-018-0021-7</pub-id>
        <?supplied-pmid 29789704?>
        <pub-id pub-id-type="pmid">29789704</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stoeckius</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Zheng</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Houck-Loomis</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Hao</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Yeung</surname>
            <given-names>BZ</given-names>
          </name>
          <name>
            <surname>Mauck</surname>
            <given-names>WM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cell Hashing with barcoded antibodies enables multiplexing and doublet detection for single cell genomics</article-title>
        <source>Genome Biol.</source>
        <year>2018</year>
        <volume>19</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>12</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-018-1603-1</pub-id>
        <pub-id pub-id-type="pmid">29301551</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <mixed-citation publication-type="other">Kang HM, Subramaniam M, Targ S, Nguyen M, Maliskova L, McCarthy E, et al. Multiplexed droplet single-cell RNA-sequencing using natural genetic variation. GSE96583. Gene Expression Omnibus. 2017. <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE96583">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE96583</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Huang</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>McCarthy</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Stegle</surname>
            <given-names>O</given-names>
          </name>
        </person-group>
        <article-title>Vireo: Bayesian demultiplexing of pooled single-cell RNA-seq data without genotype reference</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>12</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1865-2</pub-id>
        <pub-id pub-id-type="pmid">30606230</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Blondel</surname>
            <given-names>VD</given-names>
          </name>
          <name>
            <surname>Guillaume</surname>
            <given-names>JL</given-names>
          </name>
          <name>
            <surname>Lambiotte</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Lefebvre</surname>
            <given-names>E</given-names>
          </name>
        </person-group>
        <article-title>Fast unfolding of communities in large networks</article-title>
        <source>J Stat Mech Theory Exp.</source>
        <year>2008</year>
        <volume>2008</volume>
        <issue>10</issue>
        <fpage>P10008</fpage>
        <pub-id pub-id-type="doi">10.1088/1742-5468/2008/10/P10008</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Büttner</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Ostner</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Müller</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Schubert</surname>
            <given-names>B</given-names>
          </name>
        </person-group>
        <article-title>scCODA is a Bayesian model for compositional single-cell data analysis</article-title>
        <source>Nat Commun.</source>
        <year>2021</year>
        <volume>12</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>10</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-021-27150-6</pub-id>
        <pub-id pub-id-type="pmid">33397941</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <mixed-citation publication-type="other">Dann E, Henderson NC, Teichmann SA, Morgan MD, Marioni JC. Differential abundance testing on single-cell data using k-nearest neighbor graphs. Nat Biotechnol. 2021;40(2):1–9.</mixed-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <mixed-citation publication-type="other">Zhao J, Jaffe A, Li H, Lindenbaum O, Sefik E, Jackson R, et al. Detection of differentially abundant cell subpopulations in scRNA-seq data. Proc Natl Acad Sci. 2021;118(22):e2100293118.</mixed-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Phipson</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Sim</surname>
            <given-names>CB</given-names>
          </name>
          <name>
            <surname>Porrello</surname>
            <given-names>ER</given-names>
          </name>
          <name>
            <surname>Hewitt</surname>
            <given-names>AW</given-names>
          </name>
          <name>
            <surname>Powell</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Oshlack</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>propeller: testing for differences in cell type proportions in single cell data</article-title>
        <source>Bioinformatics.</source>
        <year>2022</year>
        <volume>38</volume>
        <issue>20</issue>
        <fpage>4720</fpage>
        <lpage>4726</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btac582</pub-id>
        <?supplied-pmid 36005887?>
        <pub-id pub-id-type="pmid">36005887</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lin</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Peddada</surname>
            <given-names>SD</given-names>
          </name>
        </person-group>
        <article-title>Analysis of compositions of microbiomes with bias correction</article-title>
        <source>Nat Commun.</source>
        <year>2020</year>
        <volume>11</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>11</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-020-17041-7</pub-id>
        <pub-id pub-id-type="pmid">31911652</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Weber</surname>
            <given-names>LM</given-names>
          </name>
          <name>
            <surname>Nowicka</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Soneson</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Robinson</surname>
            <given-names>MD</given-names>
          </name>
        </person-group>
        <article-title>diffcyt: Differential discovery in high-dimensional cytometry via high-resolution clustering</article-title>
        <source>Commun Biol.</source>
        <year>2019</year>
        <volume>2</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>11</lpage>
        <pub-id pub-id-type="doi">10.1038/s42003-019-0415-5</pub-id>
        <pub-id pub-id-type="pmid">30740537</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Robinson</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>McCarthy</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Smyth</surname>
            <given-names>GK</given-names>
          </name>
        </person-group>
        <article-title>edgeR: a Bioconductor package for differential expression analysis of digital gene expression data</article-title>
        <source>Bioinformatics.</source>
        <year>2010</year>
        <volume>26</volume>
        <issue>1</issue>
        <fpage>139</fpage>
        <lpage>140</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btp616</pub-id>
        <?supplied-pmid 19910308?>
        <pub-id pub-id-type="pmid">19910308</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cao</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Lin</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Ormerod</surname>
            <given-names>JT</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>JY</given-names>
          </name>
          <name>
            <surname>Lo</surname>
            <given-names>KK</given-names>
          </name>
        </person-group>
        <article-title>scDC: single cell differential composition analysis</article-title>
        <source>BMC Bioinformatics.</source>
        <year>2019</year>
        <volume>20</volume>
        <issue>19</issue>
        <fpage>1</fpage>
        <lpage>12</lpage>
        <pub-id pub-id-type="pmid">30606105</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Fischer</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Strauch</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Renard</surname>
            <given-names>BY</given-names>
          </name>
        </person-group>
        <article-title>Abundance estimation and differential testing on strain level in metagenomics data</article-title>
        <source>Bioinformatics.</source>
        <year>2017</year>
        <volume>33</volume>
        <issue>14</issue>
        <fpage>i124</fpage>
        <lpage>i132</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btx237</pub-id>
        <?supplied-pmid 28881972?>
        <pub-id pub-id-type="pmid">28881972</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lindner</surname>
            <given-names>MS</given-names>
          </name>
          <name>
            <surname>Renard</surname>
            <given-names>BY</given-names>
          </name>
        </person-group>
        <article-title>Metagenomic abundance estimation and diagnostic testing on species level</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2013</year>
        <volume>41</volume>
        <issue>1</issue>
        <fpage>e10</fpage>
        <lpage>e10</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gks803</pub-id>
        <?supplied-pmid 22941661?>
        <pub-id pub-id-type="pmid">22941661</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <mixed-citation publication-type="other">Lesnoff M, Lancelot R. aod: Analysis of Overdispersed Data. 2012. R package version 1.3.2. <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=aod">https://cran.r-project.org/package=aod</ext-link>. Accessed 16 Mar 2020.</mixed-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schafflick</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Xu</surname>
            <given-names>CA</given-names>
          </name>
          <name>
            <surname>Hartlehnert</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Cole</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Schulte-Mecklenbeck</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Lautwein</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Integrated single cell analysis of blood and cerebrospinal fluid leukocytes in multiple sclerosis</article-title>
        <source>Nat Commun.</source>
        <year>2020</year>
        <volume>11</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>14</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-019-14118-w</pub-id>
        <pub-id pub-id-type="pmid">31911652</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Luecken</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>Current best practices in single-cell RNA-seq analysis: a tutorial</article-title>
        <source>Mol Syst Biol.</source>
        <year>2019</year>
        <volume>15</volume>
        <issue>6</issue>
        <fpage>e8746</fpage>
        <pub-id pub-id-type="doi">10.15252/msb.20188746</pub-id>
        <?supplied-pmid 31217225?>
        <pub-id pub-id-type="pmid">31217225</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Andrews</surname>
            <given-names>TS</given-names>
          </name>
          <name>
            <surname>Kiselev</surname>
            <given-names>VY</given-names>
          </name>
          <name>
            <surname>McCarthy</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Hemberg</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Tutorial: guidelines for the computational analysis of single-cell RNA sequencing data</article-title>
        <source>Nat Protocol.</source>
        <year>2021</year>
        <volume>16</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>9</lpage>
        <pub-id pub-id-type="doi">10.1038/s41596-020-00409-w</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <mixed-citation publication-type="other">Pasquini G, Arias JER, Schäfer P, Busskamp V. Automated methods for cell type annotation on scRNA-seq data. Comput Struct Biotechnol J. 2021;19:961-9.</mixed-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Abdelaal</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Michielsen</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Cats</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Hoogduin</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Mei</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Reinders</surname>
            <given-names>MJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A comparison of automatic cell identification methods for single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>19</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1795-z</pub-id>
        <pub-id pub-id-type="pmid">30606230</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stuart</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Butler</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Hoffman</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Hafemeister</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Papalexi</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Mauck</surname>
            <given-names>WM</given-names>
            <suffix>III</suffix>
          </name>
          <etal/>
        </person-group>
        <article-title>Comprehensive integration of single-cell data</article-title>
        <source>Cell.</source>
        <year>2019</year>
        <volume>177</volume>
        <issue>7</issue>
        <fpage>1888</fpage>
        <lpage>1902</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2019.05.031</pub-id>
        <?supplied-pmid 31178118?>
        <pub-id pub-id-type="pmid">31178118</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Angerer</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title>
        <source>Genome Biol.</source>
        <year>2018</year>
        <volume>19</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>5</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-017-1382-0</pub-id>
        <pub-id pub-id-type="pmid">29301551</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kaufmann</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Evans</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Schaupp</surname>
            <given-names>AL</given-names>
          </name>
          <name>
            <surname>Engler</surname>
            <given-names>JB</given-names>
          </name>
          <name>
            <surname>Kaur</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Willing</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Identifying CNS-colonizing T cells as potential therapeutic targets to prevent progression of multiple sclerosis</article-title>
        <source>Med.</source>
        <year>2021</year>
        <volume>2</volume>
        <issue>3</issue>
        <fpage>296</fpage>
        <lpage>312</lpage>
        <pub-id pub-id-type="doi">10.1016/j.medj.2021.01.006</pub-id>
        <?supplied-pmid 33748804?>
        <pub-id pub-id-type="pmid">33748804</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zappia</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Phipson</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Oshlack</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Splatter: simulation of single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2017</year>
        <volume>18</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>15</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-017-1305-0</pub-id>
        <pub-id pub-id-type="pmid">28077169</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Angelidis</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Simon</surname>
            <given-names>LM</given-names>
          </name>
          <name>
            <surname>Fernandez</surname>
            <given-names>IE</given-names>
          </name>
          <name>
            <surname>Strunz</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Mayr</surname>
            <given-names>CH</given-names>
          </name>
          <name>
            <surname>Greiffo</surname>
            <given-names>FR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>An atlas of the aging lung mapped by single cell transcriptomics and deep tissue proteomics</article-title>
        <source>Nat Commun.</source>
        <year>2019</year>
        <volume>10</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>17</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-019-08831-9</pub-id>
        <pub-id pub-id-type="pmid">30602773</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <mixed-citation publication-type="other">Haber AL, Biton M, Rogel N, Herbst RH, Shekhar K, Smillie C, et al. A single-cell survey of the small intestinal epithelium. GSE92332. Gene Expression Omnibus. 2017. <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE92332">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE92332</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <mixed-citation publication-type="other">Ren X, Wen W, Fan X, Hou W, Su B, Cai P, et al. COVID-19 immune features revealed by a large-scale single-cell transcriptome atlas. GSE158055. Gene Expression Omnibus. 2021. <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE158055">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE158055</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <mixed-citation publication-type="other">Mann ER, Menon M, Knight SB, Konkel JE, Jagger C, Shaw TN, et al. Longitudinal immune profiling reveals key myeloid signatures associated with COVID-19. Sci Immunol. 2020;5(51).</mixed-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Qin</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Jiang</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Wei</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Liu</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Guan</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Dynamic changes in monocytes subsets in COVID-19 patients</article-title>
        <source>Hum Immunol.</source>
        <year>2021</year>
        <volume>82</volume>
        <issue>3</issue>
        <fpage>170</fpage>
        <lpage>176</lpage>
        <pub-id pub-id-type="doi">10.1016/j.humimm.2020.12.010</pub-id>
        <?supplied-pmid 33531264?>
        <pub-id pub-id-type="pmid">33531264</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <mixed-citation publication-type="other">Huang R, Soneson C, Ernst FG, Rue-Albrecht KC, Yu G, Hicks SC, et al. TreeSummarizedExperiment: a S4 class for data with hierarchical structure. F1000Research. 2020;9:1246.</mixed-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <mixed-citation publication-type="other">Lin X, Chau C, Ma K, Huang Y, W K Ho J. DCTAS: differential composition analysis for flexible single-cell experimental designs. 2023. <ext-link ext-link-type="uri" xlink:href="https://github.com/holab-hku/DCATS/tree/master">https://github.com/holab-hku/DCATS/tree/master</ext-link>. Accessed 21 Apr 2023.</mixed-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <mixed-citation publication-type="other">Lin X, Chau C, Ma K, Huang Y, W K Ho J. DCTAS analysis. 2023. <ext-link ext-link-type="uri" xlink:href="https://github.com/linxy29/DCATS_anlysis">https://github.com/linxy29/DCATS_anlysis</ext-link>. Accessed 6 Mar 2023.</mixed-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <mixed-citation publication-type="other">Lin X, Chau C, Kun M, Huang Y, Ho JWK. DCATS: differential composition analysis for flexible single-cell experimental designs. Zenodo. 2023. 10.5281/zenodo.7969592.</mixed-citation>
    </ref>
  </ref-list>
</back>
<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Genome Biol</journal-id>
    <journal-id journal-id-type="iso-abbrev">Genome Biol</journal-id>
    <journal-title-group>
      <journal-title>Genome Biology</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1474-7596</issn>
    <issn pub-type="epub">1474-760X</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10294334</article-id>
    <article-id pub-id-type="pmid">37365636</article-id>
    <article-id pub-id-type="publisher-id">2980</article-id>
    <article-id pub-id-type="doi">10.1186/s13059-023-02980-3</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Method</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>DCATS: differential composition analysis for flexible single-cell experimental designs</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Lin</surname>
          <given-names>Xinyi</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Chau</surname>
          <given-names>Chuen</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Ma</surname>
          <given-names>Kun</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <name>
          <surname>Huang</surname>
          <given-names>Yuanhua</given-names>
        </name>
        <address>
          <email>yuanhua@hku.hk</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-2331-7011</contrib-id>
        <name>
          <surname>Ho</surname>
          <given-names>Joshua W. K.</given-names>
        </name>
        <address>
          <email>jwkho@hku.hk</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.194645.b</institution-id><institution-id institution-id-type="ISNI">0000000121742757</institution-id><institution>School of Biomedical Sciences, Li Ka Shing Faculty of Medicine, </institution><institution>The University of Hong Kong, </institution></institution-wrap>Pokfulam, Hong Kong SAR China </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.518214.b</institution-id><institution-id institution-id-type="ISNI">0000 0005 0817 5873</institution-id><institution>Laboratory of Data Discovery for Health Limited (D24H), </institution></institution-wrap>Hong Kong Science Park, Hong Kong SAR China </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="GRID">grid.194645.b</institution-id><institution-id institution-id-type="ISNI">0000000121742757</institution-id><institution>Department of Statistics and Actuarial Science, Faculty of Science, </institution><institution>The University of Hong Kong, </institution></institution-wrap>Pokfulam, Hong Kong SAR China </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>26</day>
      <month>6</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>26</day>
      <month>6</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2023</year>
    </pub-date>
    <volume>24</volume>
    <elocation-id>151</elocation-id>
    <history>
      <date date-type="received">
        <day>21</day>
        <month>3</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>7</day>
        <month>6</month>
        <year>2023</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2023</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons licence, and indicate if changes were made. The images or other third party material in this article are included in the article's Creative Commons licence, unless indicated otherwise in a credit line to the material. If material is not included in the article's Creative Commons licence and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this licence, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>. The Creative Commons Public Domain Dedication waiver (<ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/publicdomain/zero/1.0/">http://creativecommons.org/publicdomain/zero/1.0/</ext-link>) applies to the data made available in this article, unless otherwise stated in a credit line to the data.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Differential composition analysis — the identification of cell types that have statistically significant changes in abundance between multiple experimental conditions — is one of the most common tasks in single cell omic data analysis. However, it remains challenging to perform differential composition analysis in the presence of flexible experimental designs and uncertainty in cell type assignment. Here, we introduce a statistical model and an open source R package, DCATS, for differential composition analysis based on a beta-binomial regression framework that addresses these challenges. Our empirical evaluation shows that DCATS consistently maintains high sensitivity and specificity compared to state-of-the-art methods.</p>
      <sec>
        <title>Supplementary information</title>
        <p>The online version contains supplementary material available at 10.1186/s13059-023-02980-3.</p>
      </sec>
    </abstract>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100007156</institution-id>
            <institution>Innovation and Technology Commission - Hong Kong</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© BioMed Central Ltd., part of Springer Nature 2023</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Background</title>
    <p id="Par2">Single-cell RNA sequencing (scRNA-seq) is a high-throughput sequencing technology that enables researchers to probe transcriptomes of a large number of individual cells, and allows them to characterize different cell types in a heterogeneous population. It plays a critical role in strengthening our understanding of various biological systems, including embryogenesis, the development of different diseases, and how cells react to environmental stimuli [<xref ref-type="bibr" rid="CR1">1</xref>, <xref ref-type="bibr" rid="CR2">2</xref>]. Recently, highly multiplexed strategies have been introduced to mix samples from different donors, conditions, or treatments with external molecular barcodes or intrinsic genetic makeups to achieve higher efficiency and lower batch effects [<xref ref-type="bibr" rid="CR3">3</xref>–<xref ref-type="bibr" rid="CR5">5</xref>]. In such multi-sample designs, analysis of the differential composition of cell types between two conditions is routinely applied.</p>
    <p id="Par3">From a scRNA-seq experiment, we can obtain the cell counts <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{N}=\{n_1, ..., n_K\}$$\end{document}</tex-math><mml:math id="M2"><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">N</mml:mi></mml:mrow><mml:mo>=</mml:mo><mml:mo stretchy="false">{</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>K</mml:mi></mml:msub><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq1.gif"/></alternatives></inline-formula> of <italic>K</italic> cell types by performing cell clustering, for example, with Louvain (a graph-based method) [<xref ref-type="bibr" rid="CR6">6</xref>] or K-means, usually on reduced dimensions through a principal component analysis. Then, the obtained cell count vector <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{N}$$\end{document}</tex-math><mml:math id="M4"><mml:mrow><mml:mi mathvariant="bold-italic">N</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq2.gif"/></alternatives></inline-formula> is conventionally used to estimate the cell type composition abundance <inline-formula id="IEq3"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }$$\end{document}</tex-math><mml:math id="M6"><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq3.gif"/></alternatives></inline-formula>, with the assumption that the clustering is unbiased and accurate. Thus, a few statistical methods can be directly applied to detect the cell types with differential composition abundance between conditions. Some statistical tools are also developed specialized for scRNA-seq data. scCODA [<xref ref-type="bibr" rid="CR7">7</xref>] assumes cell counts of different cell types follow a hierarchical Dirichlet-Multinomial distribution, which allows scCODA to model all cell types together. MiloR [<xref ref-type="bibr" rid="CR8">8</xref>] evaluates differential abundance on smaller clusters in KNN graph, which are called “neighborhoods.” It assumes that cell counts follow a negative binomial distribution and uses representative cells instead of all cells to improve program efficiency. DAseq [<xref ref-type="bibr" rid="CR9">9</xref>] also makes use of KNN graph and calculates multiscale differential abundance scores by counting the numbers of cells coming from different biological states while varying k. This multiscale differential abundance score is what DAseq uses to infer cell states that have differential abundance. propeller [<xref ref-type="bibr" rid="CR10">10</xref>] uses an empirical Bayes framework to enable information sharing between different samples and chooses different statistical methods (t-test or ANOVA) based on the number of conditions. Other tools are developed to handle different challenges for different data types. For instance, ANCOM-BC [<xref ref-type="bibr" rid="CR11">11</xref>] uses a linear model with sample-specific offset terms to handle the estimation of different sampling fractions when analyzing microbiome data. diffcyt [<xref ref-type="bibr" rid="CR12">12</xref>] uses functions from the R package edgeR [<xref ref-type="bibr" rid="CR13">13</xref>] to test differential abundance of cell types. It uses an overdispersed Poisson model with empirical Bayes methods for information sharing between different cell types. However, its implementation was specifically designed for flow cytometry data, not single cell RNA-seq data.</p>
    <p id="Par4">Nevertheless, performing differential abundance analysis on single cell RNA-seq data with replicates remains a statistical challenge for multiple reasons. First, multi-level variability exists due to technical and biological reasons, such as a low number of biological replicates or a low number of cells for minor cell types. Recently, scDC [<xref ref-type="bibr" rid="CR14">14</xref>], a Poisson regression-based method, has been introduced to account for the uncertainty not only between replicates but also clustering by leveraging bootstrap re-sampling, preferred with re-clustering. However, the Poisson noise model is not able to capture the over dispersion. Second, misclassification during the cell clustering step may introduce both systematic bias and uncertainty. For example, subtypes of T helper cells are often confused with each other. A similar challenge was also noticed in meta-genomics analysis, where species with similar sequences are often confusedly aligned and quantified, and bias correction by reversing this bias was found beneficial for the differential abundance analysis [<xref ref-type="bibr" rid="CR15">15</xref>, <xref ref-type="bibr" rid="CR16">16</xref>]. Regarding to challenges mentioned above, we introduced a statistical method, DCATS, to effectively detect the cell types with differential abundance between conditions or along with continuous covariates. This algorithm is implemented as an R package named DCATS which is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/holab-hku/DCATS">https://github.com/holab-hku/DCATS</ext-link>.</p>
  </sec>
  <sec id="Sec2">
    <title>Results</title>
    <sec id="Sec3">
      <title>High-level description of DCATS</title>
      <p id="Par5">Here, we introduce DCATS, a differential composition analysis framework to address the above challenges. DCATS has two key features. First, it accounts for the uncertainty in cell type assignment utilizing the biased similarity between cells types. The latent true cell type proportion is obtained by leveraging a similarity matrix between cell types via maximum likelihood estimation. Second, DCATS employs a beta-binomial regression model to analyze the differential cell type abundance, which models the raw cell counts rather than the normalized proportions and considers the dispersion between samples (Fig. <xref rid="Fig1" ref-type="fig">1</xref>A; “<xref rid="Sec10" ref-type="sec">Method</xref>”). Specifically, we assume the corrected cell counts <inline-formula id="IEq4"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{s,j}$$\end{document}</tex-math><mml:math id="M8"><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq4.gif"/></alternatives></inline-formula> for cell type <italic>j</italic> given sample <italic>s</italic> follow a beta-binomial distribution. We then describe <inline-formula id="IEq5"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{s,j}$$\end{document}</tex-math><mml:math id="M10"><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq5.gif"/></alternatives></inline-formula> with a beta-binomial generalized linear model(GLM) with a logit link function for each covariate <italic>i</italic>, as follows,<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} z_{s,j}\sim &amp; {} \texttt{Binom}(n_s, p_{s,j})\nonumber \\ p_{s,j}\sim &amp; {} \texttt{Beta}(\alpha _{s,j}, \beta _{s,j}) \end{aligned}$$\end{document}</tex-math><mml:math id="M12" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi mathvariant="monospace">Binom</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>s</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi mathvariant="monospace">Beta</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula>where we reparameterized with the mean <inline-formula id="IEq6"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\bar{p}_{s,j}$$\end{document}</tex-math><mml:math id="M14"><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq6.gif"/></alternatives></inline-formula> and over dispersion term <inline-formula id="IEq7"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi _j$$\end{document}</tex-math><mml:math id="M16"><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq7.gif"/></alternatives></inline-formula> as<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \alpha _{s,j}= &amp; {} \bar{p}_{s,j} (1/\phi _{j} - 1)\nonumber \\ \beta _{s,j}= &amp; {} (1-\bar{p}_{s,j}) (1/\phi _j - 1). \end{aligned}$$\end{document}</tex-math><mml:math id="M18" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par6">As described below, the mean parameter <inline-formula id="IEq8"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\bar{p}_{s,j}$$\end{document}</tex-math><mml:math id="M20"><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq8.gif"/></alternatives></inline-formula> is regressed to a set of covariates under different hypotheses and can be parameterized as<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \quad \texttt{logit}(\bar{p}_{s,j}) = w_0 + \varvec{w}^{\top } \varvec{c}_{s} \end{aligned}$$\end{document}</tex-math><mml:math id="M22" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mspace width="1em"/><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq9"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{c}_s$$\end{document}</tex-math><mml:math id="M24"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq9.gif"/></alternatives></inline-formula> is the covariate vector for sample <italic>s</italic>, and <inline-formula id="IEq10"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{w}$$\end{document}</tex-math><mml:math id="M26"><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq10.gif"/></alternatives></inline-formula> is the corresponding weight vector. The weights for covariates <inline-formula id="IEq11"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{w}$$\end{document}</tex-math><mml:math id="M28"><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq11.gif"/></alternatives></inline-formula> and the dispersion <inline-formula id="IEq12"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi _j$$\end{document}</tex-math><mml:math id="M30"><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq12.gif"/></alternatives></inline-formula> are optimized to achieve maximum likelihood, through the <italic>aod</italic> package [<xref ref-type="bibr" rid="CR17">17</xref>]. The <italic>p</italic>-value can be calculated with a likelihood ratio test by comparing the log likelihoods in both alternative and null hypotheses.<fig id="Fig1"><label>Fig. 1</label><caption><p>DCATS improves composition analysis through accounting for uncertainty in classification of cell types in differential abundance analysis. <bold>A</bold> Illustration of the DCATS workflow. Matrices with light blue are input matrices, matrices with light orange are output from DCATS. First step is bias correction using a similarity matrix. This step is optional. The design matrix with multiple covariates is also required. DCATS supports both categorical and continuous covariates. Then, DCATS detects differential abundance using a beta-binomial generalized linear model (GLM) model, which returns the estimated coefficients and <italic>p</italic>-values. <bold>B</bold> These box plots illustrate the effect of cell type misclassificaiton in a theoretical simulation with Dirichlet-Multinomial sampling. The similarity matrix is designed to introduce misclassification errors. The proportions of cell types <bold>B</bold> and <bold>C</bold> are changed between conditions 1 and 2. <bold>C</bold> Area under the precision-recall curve (AUC, same below) values when varying <italic>p</italic> value in detecting the cell type with differential abundance</p></caption><graphic xlink:href="13059_2023_2980_Fig1_HTML" id="MO4"/></fig></p>
      <p id="Par7">The effectiveness of the vanilla beta-binomial regression was demonstrated in [<xref ref-type="bibr" rid="CR18">18</xref>]. However, the estimation of the over dispersion term in this task is often challenging due to the extremely low numbers of replicates (sometimes even single replicate). Therefore, we introduce a strategy to estimate the dispersion term for all cell types jointly, through a pooled beta-binomial regression in a pre-step (<xref rid="Sec10" ref-type="sec">Method</xref>).</p>
      <p id="Par8">When analyzing scRNA-seq data, we started from the gene expression matrix of read or unique molecular identifier (UMI) counts. After basic pre-processing including filtering cells, normalization, and integration [<xref ref-type="bibr" rid="CR19">19</xref>, <xref ref-type="bibr" rid="CR20">20</xref>], several methods can be used to annotate each cells, including manual annotation, supervised methods and semi-supervised methods [<xref ref-type="bibr" rid="CR21">21</xref>, <xref ref-type="bibr" rid="CR22">22</xref>]. The input cell count matrix for DCATS can be calculated by counting the number of cells in each cell type.</p>
      <p id="Par9">In order to estimate the cell type similarity matrix <italic>M</italic> for the confusion during clustering, we introduced two heuristic methods here. One is based on the KNN graph between cells by calculating the averaged frequency of cell types in each cell’s neighbors (<xref rid="Sec10" ref-type="sec">Method</xref>), where the KNN graph may be pre-computed if using Seurat [<xref ref-type="bibr" rid="CR23">23</xref>] or Scanpy [<xref ref-type="bibr" rid="CR24">24</xref>] pipelines. By defining <inline-formula id="IEq13"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n_{x,j}$$\end{document}</tex-math><mml:math id="M32"><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq13.gif"/></alternatives></inline-formula> as the number of neighbors for cell <italic>x</italic> that are classified as cell type <italic>j</italic>, we can calculate the KNN-based similarity matrix, for example, its entry <inline-formula id="IEq14"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m_{i,j}$$\end{document}</tex-math><mml:math id="M34"><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq14.gif"/></alternatives></inline-formula> for similarity (misclassification) from cluster <italic>i</italic> to <italic>j</italic> as follows:<disp-formula id="Equ13"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} m_{i,j} = \frac{\sum _{x=1}^{x_i} n_{x,j}}{\sum _{j=1}^{K}\sum _{x=1}^{x_i} n_{x,j}} \end{aligned}$$\end{document}</tex-math><mml:math id="M36" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:msubsup><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:msubsup><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ13.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par10">The other method is to use a prediction confusion matrix produced using 5-fold cross validation by a classifier on top of principle components when the KNN graph is not available, e.g., support vector machine as default.</p>
    </sec>
    <sec id="Sec4">
      <title>Correcting misclustering through DCATS improves composition analysis</title>
      <p id="Par11">To evaluate the effects of misclustering on the composition analysis, we performed a theoretical simulation by generating cell counts from Dirichlet-Multinomial distributions, where the input cell type proportions were generated by adding bias to the genuine cell type proportions through a transformation with the misclustering matrix, aka similarity matrix (Fig. <xref rid="Fig1" ref-type="fig">1</xref>C, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1).</p>
      <p id="Par12">Here, the genuine proportions of the three cell types were [1/3, 1/3, 1/3] and [1/3, 1/2, 1/6] in conditions 1 and 2, respectively. However, due to the high similarity between cell types 2 and 3, the average cell type proportions were transformed to [0.33, 0.33, 0.33] and [0.33, 0.40, 0.27] respectively in the two conditions, which mimicked the bias introduced in the clustering. Due to the equal cell type proportion and symmetrical similarity matrix, all cell type proportions remained unchanged in condition 1 after the similarity-based transformation. However, the proportion of cell type 2 and cell type 3 in condition 2 changed due to misclassification. Notably, the difference in proportions between conditions was reduced for both cell types 2 and 3, which caused false negatives due to the shrunken effects. Indeed, both Fisher’s exact test and DCATS only returned moderate performance (area under ROC curve (AUC) = 0.721 and 0.745 on average, aggregating 50 runs). By contrast, we found that the performance in detecting differential abundance was dramatically increased for both DCATS (mean AUC: 0.745 to 0.976) and Fisher’s exact test (mean AUC: 0.721 to 0.961; Fig. <xref rid="Fig1" ref-type="fig">1</xref>C) by using the cell counts corrected from similarity matrix by DCATS through an Expectation-Maximization algorithm. This was largely thanks to the improved sensitivity in both methods (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S2).</p>
      <p id="Par13">We further asked whether the bias correction component in DCATS could correct the misclassification and provide more accurate proportion estimations. We tested this using a single cell RNA-seq data set [<xref ref-type="bibr" rid="CR25">25</xref>] consisting of progressive multiple sclerosis (MS) and relapsing-remitting disease course MS (RRMS). In this dataset, cells from 71 PBMC samples of 62 donors were collected for single-cell RNA sequencing and surface antibody staining. In total, it contains 497,705 single-cell transcriptomic (Tr) and 355,433 surface protein (SP) profiles. The original study used defined cell types based on both Tr and SP profiles [<xref ref-type="bibr" rid="CR25">25</xref>]. We treated this Tr+SP annotation as the “original” annotation with high reliability, as it is the most well-studied annotation [<xref ref-type="bibr" rid="CR25">25</xref>].</p>
      <p id="Par14">To test bias correction in our study, we focused on four T-cell subtypes based on the Tr+SP annotated dataset, namely T06, T07, T09, and T10. Then, we identified cell clusters based on transriptomic data only (Tr-only) and match each Tr-only cluster to its closest Tr+SP cluster. A confusion matrix can be generated between the four clusters defined by Tr+SP and their matching Tr-only clusters. The proportions of the four Tr-only clusters can be calculated. Using this “empirical” confusion matrix for bias correction, DCATS corrected the proportions of the four Tr-only clusters very close to the true proportions (root mean square error (RMSE) from 0.1810 to <inline-formula id="IEq15"><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$8.672\times 10^{-5}$$\end{document}</tex-math><mml:math id="M38"><mml:mrow><mml:mn>8.672</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>5</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq15.gif"/></alternatives></inline-formula>, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S3). In most cases, the true similarity matrix or confusion matrix is unknown. DCATS provides two simple methods to approximate this similarity matrix, which improves our estimation of proportion by 44% compared to without bias correction (RMSE from 0.1810 to 0.1023, using KNN similarity matrix; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S3)</p>
      <p id="Par15">Combined with previous simulation results, our findings support the effectiveness of DCATS’ bias correction step in differential composition analysis.</p>
    </sec>
    <sec id="Sec5">
      <title>Benchmarking DCATS with simulated data</title>
      <p id="Par16">We further benchmarked DCATS’s performance with six existing methods: Fisher’s exact test, scDC [<xref ref-type="bibr" rid="CR14">14</xref>], speckle [<xref ref-type="bibr" rid="CR10">10</xref>], diffcyt (a method primarily designed for mass cytometry data) [<xref ref-type="bibr" rid="CR12">12</xref>] , milo [<xref ref-type="bibr" rid="CR8">8</xref>] and ANCOM-BC [<xref ref-type="bibr" rid="CR11">11</xref>]. Here, we first generated a large pool of single-cell transcriptomic profiles with a simulator Splatter [<xref ref-type="bibr" rid="CR26">26</xref>] (Fig. <xref rid="Fig2" ref-type="fig">2</xref>A; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S4). This simulated pool was then used as the seed data and cells are randomly selected according to the simulated cell-type proportions (as ground truth; see more details in <xref rid="Sec10" ref-type="sec">Method</xref>). Clustering was further performed on the subsets of simulated cells with Seurat to mimic the potential confusion introduced in the clustering step (the empirical confusion matrix shown in Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S7). The seven methods were then performed on the cell counts obtained from the clustering annotation. Uniquely, we estimated the similarity matrix between cells using a KNN graph by calculating the fraction of neighbors for all cells in each cell type that belong to different cell types. It approximated the empirical confusion matrix well (Pearson’s <italic>R</italic> = 0.9987; Mean absolute error=<inline-formula id="IEq16"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2.977\times 10^{-18}$$\end{document}</tex-math><mml:math id="M40"><mml:mrow><mml:mn>2.977</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>18</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq16.gif"/></alternatives></inline-formula>; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S8).<fig id="Fig2"><label>Fig. 2</label><caption><p>Evaluation of DCATS with multiple simulation datasets. <bold>A</bold> The UMAP plots of simulation data with 8 cell types. <bold>B</bold> The true proportions of different cell types in default setting (3 replicates in each condition across 30 runs; the 4 cell types with differential composition abundance have names started with “P”). <bold>C</bold> The boxplot of MCC, F1, AUC, and PRAUC of different methods in bootstrap sampling results with the default setting. <bold>D</bold>-<bold>G</bold> Comparing multiple methods with Splatter-simulated data by varying the number of replicates (<bold>D</bold>, <bold>E</bold>) and number of cell types (<bold>F</bold>, <bold>G</bold>). “bcANCOM-BC” indicates using bias corrected proportions estimated by DCATS as the input of ANCOM-BC [<xref ref-type="bibr" rid="CR11">11</xref>]. The default number of cell types is 8, and the default number of replicates is 3. <bold>H</bold> The performance of each method in the special case. “DCATS” indicates the results of DCATS using total cell count as the normalization term. “dcats_autoRef” indicates using the reference group automatically detected by DCATS as the normalization term. “dcats_defRef” indicates using the know true reference group as the normalization term. <bold>I</bold> Detecting variable cell types with multiple covariates, for both categorical and continuous types. Data is simulated with Splatter. N.B., only DCATS and Milo support multiple covariates</p></caption><graphic xlink:href="13059_2023_2980_Fig2_HTML" id="MO6"/></fig></p>
      <p id="Par17">We generated three types of simulation data. Among all the simulation scenarios, we simulated multiple samples coming from two conditions. In the first type of simulation, we focused on the change of proportion. The proportion of some cell types increased, while the proportion of other cell types decreased. The proportion of samples coming from two conditions all summed up to 1. In the second type of simulation, we designed the simulation based on different cell counts of each cell type. With the count of one cell type increased from condition 1 to condition 2, the proportion of this cell type increased, while the proportions of the rest cell types decreased. In the third type of simulation, we included another two confounding covariates - age and gender, to test the ability of controlling covariates of different methods.</p>
      <p id="Par18">For the first type of simulation data, in a default setting with 3 replicates in each condition and 4 out of 8 cell types with differential composition abundance (Fig. <xref rid="Fig2" ref-type="fig">2</xref>B), we found that DCATS outperforms all other methods (area under ROC curve (AUC): 0.872 vs 0.86; matthews correlation coefficient (MCC) : 0.63 vs 0.517; F1: 0.779 vs 0.714, respectively for DCATS and the second-best method in each metric; Fig. <xref rid="Fig2" ref-type="fig">2</xref>C–G and Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1, 3, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S5–6). N.B., DCATS remains the best-performed method in all three metrics while the second-best method varies among the alternative methods. By ablating the correction of misclustering in DCATS and introducing the over-dispersion term in the beta-binomial regression, we observed that both bias correction and global estimation of over-dispersion contribute to the improvement of overall performance (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1-2, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S6). When varying the number of replicates to 2 or 4, or the number of cell types to 10 or 12, we found that DCATS consistently outperforms all other methods, mostly by a large margin (Fig. <xref rid="Fig2" ref-type="fig">2</xref>D–G, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1-4, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S6). Unsurprisingly, the increase of replicates improves the performance for almost all methods, especially for DCATS, suggesting its capability of estimating biological variability from replicates. It is worth mentioning that despite Milo’s unsatisfactory performance in cell type levels, as a tool designed for detecting perturbation of cell states in partially overlapping neighborhoods, it shows its strength in differential abundance analysis at neighborhood level compared to DCATS and speckle. (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S9–10)</p>
      <p id="Par19">By comparing the results of ANCOM-BC using the observed proportion (ancombc) and bias-corrected proportion estimated by DCATS (bcancombc), we found that the bias correction step always increased the sensitivity of ANCOM-BC (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1,3). However, the specificity sometimes decreased, and this led to the overall similar performance of ancombc and bcancombc. While in DCATS, using bias-corrected proportions led to a higher increase in sensitivity and almost no decrease in specificity (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1,3).</p>
      <p id="Par20">Next, we conduct the second type of simulation to assess the composition effects in the task. The first cell type has a 20 times count increase in condition 2, while counts of the rest cell types remain the same. Proportions of each cell type are calculated based on the defined cell counts, and the simulation is done based on these cell types’ proportions. With the same total count in 2 conditions, the observed cell count of the first cell type shows a huge increase in condition 2, while cell counts of the rest cell types decrease (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S11). We test the performance of different methods using this dataset. With the estimated dispersion term, this systematic decrease of proportion can be partially modeled by DCATS (DCATS (estPhi_emK): 0.762 vs wtoPhi_emK: 0.190 in MCC, Fig. <xref rid="Fig2" ref-type="fig">2</xref>H, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S6). Thus, DCATS achieves higher MCC and F1 compared to other methods.</p>
      <p id="Par21">To directly address the issue of cell type proportion, we investigated the performance of selecting certain cell types as the reference group for normalization, rather than utilizing all remaining cell types (as outlined in detail in the “<xref rid="Sec10" ref-type="sec">Method</xref>” section). Specifically, the reference cell types should exhibit no significant abundance differences with high confidence. In this simulation, employing three known unchanged cell types as the reference group enabled DCATS to differentiate between actual abundance changes and spurious effects caused by other cell types (0.762 to 0.948 in MCC, 0.775 to 0.954 in F1). The performance of DCATS improved mainly through the increase in specificity (0.917 to 0.986, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S6). Such improvement is also seen when using 3 reference cell types automatically recommended by DCATS (0.762 to 0.889 in MCC, 0.775 to 0.899 in F1).</p>
      <p id="Par22">Moreover, a third simulation was performed to evaluate DCATS’s ability to account for additional covariates or to jointly test multiple covariates in association with composition abundance for each cell type. Specifically, we simulated ten replicates for each condition with different ages and genders. There were a total of eight cell types, of which four displayed differential abundance between conditions. In addition, we selected four cell types to exhibit confounding effects from both age and gender. Two of these cell types exhibit differential abundance (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S5). Even though most of these seven methods are based on a linear model framework, DCATS, milo, and ANCOMBC are the only three methods designed with the utility to support additional covariates testing, while ANCOMBC only supports testing for discrete covariates. scDC, as a GLM based method, is in principle able to support covariates, but the interface is not implemented. propeller in the speckle package [<xref ref-type="bibr" rid="CR10">10</xref>] only takes the condition information as input but not additional covariates. diffcyt, which uses edgeR [<xref ref-type="bibr" rid="CR13">13</xref>] for differential abundance analysis on flow cytometry data also met challenges in incorporating different covariates due to its highly specific analysis pipeline designed for flow cytometry data. Therefore, we focus on Milo and ANCOMBC for incorporating covariates, while interestingly they fail to effectively control the influence of confounding covariates when performing the analysis (Fig. <xref rid="Fig2" ref-type="fig">2</xref>I, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S12–13). By contrast, DCATS achieves improved MCC partly thanks to its capability of jointly modeling additional covariates. Indeed, DCATS shows good performance in detecting cell types with additional covariates for both continuous (age) and discrete (gender) variables (Fig. <xref rid="Fig2" ref-type="fig">2</xref>I, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S12–13).</p>
    </sec>
    <sec id="Sec6">
      <title>Evaluating DCATS on experimental data sets</title>
      <p id="Par23">To further illustrate the performance of DCATS, we applied DCATS and five other methods (Fisher’s exact test, scDC [<xref ref-type="bibr" rid="CR14">14</xref>], speckle [<xref ref-type="bibr" rid="CR10">10</xref>], milo [<xref ref-type="bibr" rid="CR8">8</xref>], and ANCOM-BC [<xref ref-type="bibr" rid="CR11">11</xref>]) to three experimental datasets. As we do not have the KNN matrices required for annotating cell types in these datasets, similarity matrices are calculated by performing classification with SVM over the original cell type annotation.</p>
      <p id="Par24">We first assessed the sensitivity of DCATS using a dataset (Angelidis2019) containing single-cell transcriptomic and mass spectrometry-driven proteomic data of whole lungs from 3-month-old mice (<italic>n</italic> = 8) and 24-month-old mice (<italic>n </italic>= 7) [<xref ref-type="bibr" rid="CR27">27</xref>]. In this dataset, the authors discovered one cluster of cells with a high expression level of S and G2M cell-cycle marker genes. This cluster contains mainly proliferating cells, thus, should show higher abundance in young mice. As these proliferating cells belong to T cells, type-2 pneumocytes, and alveolar macrophages, these cell types should have higher proportions in young mice. Using single-cell transcriptome information, DCATS enabled the detection of type-2 pneumocytes, and alveolar macrophages, and a subtype of T cells, CD4+ T cells, as differentially abundant cell types (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S8). In addition, the authors found a relatively increased number of ciliated cells in old mice compared to club cells. By deconvoluting bulk RNA sequencing data, the authors found the upregulation of ciliated cell marker genes signature. The increased ratio of ciliated to club cells in aged mice is further validated by immunostainings of Foxj1 (ciliated cell marker) and CC10 (club cell marker) [<xref ref-type="bibr" rid="CR27">27</xref>]. Using club cells as the reference group, DCATS enabled the detection of this ratio change (<inline-formula id="IEq17"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p = 0.0053$$\end{document}</tex-math><mml:math id="M42"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>0.0053</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq17.gif"/></alternatives></inline-formula>, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S8).</p>
      <p id="Par25">We then assessed the performance of these six methods on controlling false positives by applying them to a negative control data set on PBMCs, where no cell type was reported to have significant proportion change between 8 lupus patients treated with interferon(IFN)-<inline-formula id="IEq18"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\beta$$\end{document}</tex-math><mml:math id="M44"><mml:mi>β</mml:mi></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq18.gif"/></alternatives></inline-formula> and 8 control samples [<xref ref-type="bibr" rid="CR4">4</xref>]. Here, we found that DCATS, speckle and ANCOM-BC both have good control of false positives, with no cell types having <inline-formula id="IEq19"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p&lt;0.1$$\end{document}</tex-math><mml:math id="M46"><mml:mrow><mml:mi>p</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0.1</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq19.gif"/></alternatives></inline-formula> (Fig. <xref rid="Fig3" ref-type="fig">3</xref>A). Similarly, Milo also has a good control on false positives when manually setting its threshold to 0.2 based on prior knowledge (this threshold is used throughout all data sets below; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S7). On the other hand, Fisher’s exact test severely suffers from type I errors (4 out of 8 cell types passing a significance level at <inline-formula id="IEq20"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p&lt;0.01$$\end{document}</tex-math><mml:math id="M48"><mml:mrow><mml:mi>p</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0.01</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq20.gif"/></alternatives></inline-formula>); scDC also returns three cell types with <inline-formula id="IEq21"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p&lt;0.1$$\end{document}</tex-math><mml:math id="M50"><mml:mrow><mml:mi>p</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0.1</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq21.gif"/></alternatives></inline-formula>, including B cells with <inline-formula id="IEq22"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p&lt;0.01$$\end{document}</tex-math><mml:math id="M52"><mml:mrow><mml:mi>p</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0.01</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq22.gif"/></alternatives></inline-formula>.<fig id="Fig3"><label>Fig. 3</label><caption><p>DCATS gives accurate conclusions for two experimental datasets. “dcats_autoRef” indicates using the reference group automatically detected by DCATS as the normalization term. <bold>A</bold> shown is the proportion of each cell types in the Kang dataset [<xref ref-type="bibr" rid="CR4">4</xref>]. cM, CD14+CD16- monocytes; ncM, CD14+CD16+ monocytes; DC, dendritic cells; Mkc, megakaryocytes; Th, CD4+ T cells; B, B cells; Tc, CD8+ T cells; NK, natural killer cells. <bold>B</bold>–<bold>D</bold> show the proportion of each cell types in the Haber dataset [<xref ref-type="bibr" rid="CR28">28</xref>]. E, Enterocyte; TA, transit amplifying; TAE, TA.Early; EP, Enterocyte.Progenitor; Gob, Goblet. “P” in the first line represents existing proportions’ difference according to the original papers, and “N” represents no significant proportions’ difference. “P” in the last line represents existing proportions’ difference based on results of milo, and “N” represents no significant proportions’ difference. In the rest four lines, “*” represents <italic>p</italic>-values from 0.05 to 0.1, “**” represents <italic>p</italic>-values from 0.01 to 0.05, “***” represents <italic>p</italic>-values less than 0.01. “n.s.” means not significant</p></caption><graphic xlink:href="13059_2023_2980_Fig3_HTML" id="MO7"/></fig></p>
      <p id="Par26">The third dataset consists of 53,193 epithelial cells from mice’s small intestine and organoids [<xref ref-type="bibr" rid="CR28">28</xref>]. It includes 4 control samples, 2 samples from two days after <italic>Salmonella</italic> infection, 2 samples from three days after <italic>H. polygyrus</italic> infection, and 2 samples from ten days after <italic>H. polygyrus</italic> infection. The original study defined eight cell types and compared between controls and each stimulation group to identify cell types with differential composition abundance through a Poisson regression and Wald test [<xref ref-type="bibr" rid="CR28">28</xref>]. Presumably, since the sample variability was not well considered in the Poisson regression, the authors used <inline-formula id="IEq23"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\texttt{FDR}&lt;1\times 10^{-5}$$\end{document}</tex-math><mml:math id="M54"><mml:mrow><mml:mi mathvariant="monospace">FDR</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>1</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>5</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq23.gif"/></alternatives></inline-formula> as the cutoff of differential abundant cell types between control and simulations.</p>
      <p id="Par27">We do not have the ground truth about which cell types are differentially abundant, but for the purpose of evaluating the accuracy of DCATS and other methods, we used the findings in the original study of this dataset as the “silver standard.” When re-analyzing this data set, we first noticed that Fisher’s exact test captured all the reported differential abundant cell types, but also reports lots of differential abundant cell types that are regarded as non-differential abundant cell types by other methods in each of the comparison pairs (with <inline-formula id="IEq24"><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p&lt;0.01$$\end{document}</tex-math><mml:math id="M56"><mml:mrow><mml:mi>p</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0.01</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq24.gif"/></alternatives></inline-formula>). Similarly, scDC and milo also returns “false positives” in each comparing condition pair but occasionally missed reported positives. Surprisingly, speckle shows limited power, missing almost all hits. In contrast, DCATS displayed a good balance between sensitivity and specificity; it does not return any “false positive” (using 0.05 as the significance level) and captures most of the reported differential abundant cell types when comparing the control group and <italic>H. polygyrus</italic> infection groups. When comparing the control groups and <italic>Salmonella</italic> infection group, we observed a significant increase in the proportion of enterocytes, which causes proportions decrease in the rest of the cell types. Using the reference group detected by DCATS as the normalization term was able to overcome the influence of enterocytes. The results show that enterocyte is the only cell type with differential abundance (Fig. <xref rid="Fig3" ref-type="fig">3</xref>B–D, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S9-10, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S14).</p>
      <p id="Par28">Furthermore, if we treat the results given in the paper as results of another method, we can use the major decisions as the highly possible conclusions. In this case, the performance of each method is evaluated by their similarity with other methods. We can find that DCATS provides a consistent conclusion with the majority decisions of each cell type in different comparisons, except for the significant proportion change of Goblet between control and Hpoly day 10 conditions.</p>
    </sec>
    <sec id="Sec7">
      <title>Application of DCATS in complex experiment designs</title>
      <p id="Par29">To demonstrate the utility of DCATS for complex designs, we selected a cohort study including 196 hospitalized COVID-19 patients with moderate or severe disease, corresponding control group, and patients in the recovering stage. Within this cohort study, we selected scRNA-seq data from fresh and frozen PBMC samples with known metadata. The samples were stratified into five groups: 20 samples from the control group, 48 samples from the mild or moderate convalescence group, 19 samples from the mild or moderate progression group, 36 samples from the severe or critical convalescence group, and 48 samples from the severe or critical progression group [<xref ref-type="bibr" rid="CR29">29</xref>]. In the original study, differential abundance analysis was performed between multiple severity groups.</p>
      <p id="Par30">Different from the original study, we leveraged DCATS’s capability to account for confounding factors, including age and gender through the GLM framework. We noticed both DCATS and the original study identified a few cell types with substantial proportion changes (denoted in by black asterisks in Fig. <xref rid="Fig4" ref-type="fig">4</xref>), such as, CD8+ T cells between severe progression and convalescence or healthy controls. On the other hand, DCATS also uniquely detects several cell types that show a significant proportion difference (highlighted in red).<fig id="Fig4"><label>Fig. 4</label><caption><p>DCATS is able to find new cell types with differential abundance in Ren dataset [<xref ref-type="bibr" rid="CR29">29</xref>]. Cell types’ proportion and conclusions on the Ren dataset given by DCATS. The significant bars in black color indicate that results are the same as the original paper, while the significant bars in red colors indicate newly discovered cell types with proportion differences</p></caption><graphic xlink:href="13059_2023_2980_Fig4_HTML" id="MO8"/></fig></p>
      <p id="Par31">Specifically, DCATS indicates a slightly different proportions of CD8+ T cells between the control group and the mild/moderate progression group (<inline-formula id="IEq25"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=0.067$$\end{document}</tex-math><mml:math id="M58"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>0.067</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq25.gif"/></alternatives></inline-formula>). This is consistent with what another study found when analyzing high-dimensional cytometry data from 125 COVID-19 patients, corresponding recovered group, and healthy control group [<xref ref-type="bibr" rid="CR30">30</xref>]. Even though the significance is moderate, the trend is strong. We also observed a significant difference in the proportion of monocytes between the mild/moderate progression group and corresponding recovery group (<inline-formula id="IEq26"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=0.013$$\end{document}</tex-math><mml:math id="M60"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>0.013</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq26.gif"/></alternatives></inline-formula>). This finding is consistent with a recent report from Qin and colleagues by using fluorescence-activated flow cytometry analysis to track the dynamic changes of monocytes in patients during the recovery stage from mild symptoms [<xref ref-type="bibr" rid="CR31">31</xref>]. DCATS also shows a significant difference in proportion between the control group and the mild/moderate progression group (<inline-formula id="IEq27"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=0.024$$\end{document}</tex-math><mml:math id="M62"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>0.024</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq27.gif"/></alternatives></inline-formula>) as well as the mild/moderate progression group and corresponding recovery group (<inline-formula id="IEq28"><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=0.021$$\end{document}</tex-math><mml:math id="M64"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>0.021</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq28.gif"/></alternatives></inline-formula>) regarding B cells. The same influence on B cells is also described in the original paper with a stronger signal given by DCATS between the control group and the severe/critical progression group (<inline-formula id="IEq29"><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=3.10\times 10^{-4}$$\end{document}</tex-math><mml:math id="M66"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>3.10</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>4</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq29.gif"/></alternatives></inline-formula>) as well as the severe/critical progression group and corresponding recovery group (<inline-formula id="IEq30"><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p=2.48\times 10^{-6}$$\end{document}</tex-math><mml:math id="M68"><mml:mrow><mml:mi>p</mml:mi><mml:mo>=</mml:mo><mml:mn>2.48</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>-</mml:mo><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq30.gif"/></alternatives></inline-formula>). These new findings show that DCATS is a powerful tool in identifying cell types with significant proportion changes while keeping high specificity.</p>
    </sec>
  </sec>
  <sec id="Sec8">
    <title>Discussion</title>
    <p id="Par32">Comparing to simple statistical tests like Fisher’s exact test, DCATS preserves high sensitivity while having a good performance in specificity. Through multiple simulation and experimental datasets, we demonstrated that DCATS has an excellent overall performance and outperforms existing methods. Strikingly, DCATS has strong control of false positives but maintains a high level of power.</p>
    <p id="Par33">When benchmarking with other methods, Milo shows the unsatisfactory performance when we conducted the differential analysis at cell type level. This is partly because that Milo is designed at the neighborhood level, and there is no build-in metric to determine the differential abundance at cell type level, hence the proportion of neighborhoods with significant difference were used as a surrogate to indicate cell-type level significance. Despite the unsatisfactory performance for Milo, it shows its strength in detecting differential abundance neighborhoods when compared to other methods, and is a good choice when we have data with continuous cell state changes.</p>
    <p id="Par34">As DCATS corrects the misclassification bias based on the similarity matrix, the estimation of this matrix is an important step and can influence the performance of DCATS. Although, we found that KNN-based or empirical classification-based similarity matrices function well in general, the estimation of this matrix may be further improved in the future, in the light of more benchmarking datasets with accurate cell type annotations.</p>
    <p id="Par35">Lastly, the differential abundance of cell type naturally regards relative abundance. Hence, choosing the reference (i.e., non-differential cell types) can potentially affect the analysis results. Typically, we assume that the cell type abundance change is relatively small, hence using all remaining cell types is our default setting and demonstrate robust performance in broad scenarios. On the other hand, if the compositional change is substantial, all non-differential cell types will be affected and selecting certain cell types as a confident reference can reduce such impact, e.g., by DCATS’s automatic recommendation. Nonetheless, such a large compositional difference is not a typical scenario to apply DCATS and we suggest users perform the reference cell selection with caution.</p>
  </sec>
  <sec id="Sec9">
    <title>Conclusions</title>
    <p id="Par36">In this works, we introduced DCATS, in a form of beta-binomial regression, for detecting cell types with differential composition abundance. With the bias correction procedure based on a similarity matrix, DCATS provides a robust framework for differential composition analysis between conditions. As the input of DCATS is the count matrix which includes the number of cells in each cell type for each sample, it can deal with pre-defined cell type annotation, and can be easily adapted to any other single cell (multi-) omics data. This unique feature also allows DCATS to be implemented on data with self-adjusted annotation based on integration of multi-omics data or biological knowledge. We demonstrated the usability of DCATS in both simulated data set and real world data set.</p>
  </sec>
  <sec id="Sec10">
    <title>Method</title>
    <sec id="Sec11">
      <title>Composition correction with clustering similarity matrix</title>
      <p id="Par37">From a scRNA-seq experiment, we can obtain the cell counts <inline-formula id="IEq31"><alternatives><tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{x}=\{x_1, ..., x_K\}$$\end{document}</tex-math><mml:math id="M70"><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mo>=</mml:mo><mml:mo stretchy="false">{</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>K</mml:mi></mml:msub><mml:mo stretchy="false">}</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq31.gif"/></alternatives></inline-formula> of <italic>K</italic> cell types by performing cell clustering, e.g., Louvain method [<xref ref-type="bibr" rid="CR6">6</xref>] and K-means. If the clustering is unbiased and accurate, it is natural to take the cell type composition abundance <inline-formula id="IEq32"><alternatives><tex-math id="M71">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M72"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq32.gif"/></alternatives></inline-formula> proportional to the returned cell count vector <inline-formula id="IEq33"><alternatives><tex-math id="M73">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{n}$$\end{document}</tex-math><mml:math id="M74"><mml:mrow><mml:mi mathvariant="bold-italic">n</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq33.gif"/></alternatives></inline-formula>. However, due to the complex underlying structure, the clustering step is often inaccurate and may be systematically biased, hence it is crucial to correct the bias on composition abundance introduced by clustering method. In next subsection, we demonstrate that the clustering similarity matrix <italic>M</italic> (or similarity matrix) can be well approximated, e.g., by KNN graph. Specifically, the element <inline-formula id="IEq34"><alternatives><tex-math id="M75">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m_{i,j}$$\end{document}</tex-math><mml:math id="M76"><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq34.gif"/></alternatives></inline-formula> denotes the probability of a cell <italic>c</italic> in type <italic>i</italic> assigned to type <italic>j</italic> by the clustering method, namely, <inline-formula id="IEq35"><alternatives><tex-math id="M77">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P(A_c=j | I_c = i) = m_{i,j}$$\end{document}</tex-math><mml:math id="M78"><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq35.gif"/></alternatives></inline-formula>, where <inline-formula id="IEq36"><alternatives><tex-math id="M79">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$A_c, I_c$$\end{document}</tex-math><mml:math id="M80"><mml:mrow><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq36.gif"/></alternatives></inline-formula> respectively denote the clustering assignment and genuine identity of cell <italic>c</italic>. This also means that <italic>M</italic> could be asymmetric and requires <inline-formula id="IEq37"><alternatives><tex-math id="M81">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sum _{k=1}^{K} m_{t, k} = 1$$\end{document}</tex-math><mml:math id="M82"><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq37.gif"/></alternatives></inline-formula> with <inline-formula id="IEq38"><alternatives><tex-math id="M83">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m_{t,k}\ge 0$$\end{document}</tex-math><mml:math id="M84"><mml:mrow><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>≥</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq38.gif"/></alternatives></inline-formula> for any cell type <italic>t</italic>.</p>
      <p id="Par38">Given the above definition and a pre-defined clustering similarity matrix <italic>M</italic>, we could have the likelihood of unknown cell type composition vector <inline-formula id="IEq39"><alternatives><tex-math id="M85">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M86"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq39.gif"/></alternatives></inline-formula> on observing the cell counts <inline-formula id="IEq40"><alternatives><tex-math id="M87">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{n}$$\end{document}</tex-math><mml:math id="M88"><mml:mrow><mml:mi mathvariant="bold-italic">n</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq40.gif"/></alternatives></inline-formula>, as follows,<disp-formula id="Equ4"><label>4</label><alternatives><tex-math id="M89">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \mathcal {L}(\varvec{z})= &amp; {} P(\varvec{n} | \varvec{z}, M) = \prod _{j=1}^{K} \prod _{c=1}^{n_j} \left[ \sum _{i=1}^{K} P(I_c=i|\varvec{z}) P(A_c=j|I_c=i) \right] \nonumber \\= &amp; {} \prod _{j=1}^{K} \prod _{c=1}^{n_j} \left[ \sum _{i=1}^{K} z_i m_{i,j} \right] = \prod _{j=1}^{K} \left[ \sum _{i=1}^{K} z_i m_{i,j} \right] ^{n_j} = \prod _{j=1}^{K} \nu _j^{n_j}, \end{aligned}$$\end{document}</tex-math><mml:math id="M90" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi mathvariant="script">L</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">n</mml:mi></mml:mrow><mml:mo stretchy="false">|</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo>,</mml:mo><mml:mi>M</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>c</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:munderover><mml:mfenced close="]" open="["><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfenced></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>c</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:munderover><mml:mfenced close="]" open="["><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mfenced><mml:mo>=</mml:mo><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msup><mml:mfenced close="]" open="["><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mfenced><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:msup><mml:mo>=</mml:mo><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:munderover><mml:msubsup><mml:mi>ν</mml:mi><mml:mi>j</mml:mi><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:msubsup><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ4.gif" position="anchor"/></alternatives></disp-formula>which is equivalent to a multinomial distribution parametrised by an adjusted composition abundance vector <inline-formula id="IEq41"><alternatives><tex-math id="M91">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\nu }=\varvec{z} \times M$$\end{document}</tex-math><mml:math id="M92"><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">ν</mml:mi></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo>×</mml:mo><mml:mi>M</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq41.gif"/></alternatives></inline-formula>.</p>
      <p id="Par39">Algebraically, we could take <inline-formula id="IEq42"><alternatives><tex-math id="M93">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}=M^{-1}\times \varvec{\nu }$$\end{document}</tex-math><mml:math id="M94"><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mi>M</mml:mi><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mo>×</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">ν</mml:mi></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq42.gif"/></alternatives></inline-formula> with inverting the similarity matrix <italic>M</italic>. However, this simplistic treatment does not guarantee that the solution satisfies with <inline-formula id="IEq43"><alternatives><tex-math id="M95">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_t \ge 0$$\end{document}</tex-math><mml:math id="M96"><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo>≥</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq43.gif"/></alternatives></inline-formula> and <inline-formula id="IEq44"><alternatives><tex-math id="M97">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_t \le 1$$\end{document}</tex-math><mml:math id="M98"><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo>≤</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq44.gif"/></alternatives></inline-formula> for any cell type <italic>t</italic>. In practice, constraints have been introduced to address this optimisation problem, e.g., [<xref ref-type="bibr" rid="CR15">15</xref>, <xref ref-type="bibr" rid="CR16">16</xref>], though it occasionally returns unstable solutions.</p>
      <p id="Par40">Here, we introduce an Expectation-Maximization (EM) algorithm to achieve a maximum likelihood estimate of the cell type composition <inline-formula id="IEq45"><alternatives><tex-math id="M99">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M100"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq45.gif"/></alternatives></inline-formula> by introducing <inline-formula id="IEq46"><alternatives><tex-math id="M101">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu _{j,i}$$\end{document}</tex-math><mml:math id="M102"><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq46.gif"/></alternatives></inline-formula> as the expected probability of clustered cell type <italic>j</italic> coming from the real cell type <italic>i</italic>. Though this auxiliary variable <inline-formula id="IEq47"><alternatives><tex-math id="M103">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu _{j,i}$$\end{document}</tex-math><mml:math id="M104"><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq47.gif"/></alternatives></inline-formula> functions like the inverse similarity matrix <inline-formula id="IEq48"><alternatives><tex-math id="M105">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$M^{-1}$$\end{document}</tex-math><mml:math id="M106"><mml:msup><mml:mi>M</mml:mi><mml:mrow><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq48.gif"/></alternatives></inline-formula>, its interpretation and calculation are different. Here, we could interpret <inline-formula id="IEq49"><alternatives><tex-math id="M107">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu _{j,i}$$\end{document}</tex-math><mml:math id="M108"><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq49.gif"/></alternatives></inline-formula> as the posterior probability of clustered cell type <italic>j</italic> coming from the real cell type <italic>i</italic>, hence can be calculated in a forward way (i.e., the E step) if given an estimated the true composition vector <inline-formula id="IEq50"><alternatives><tex-math id="M109">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M110"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq50.gif"/></alternatives></inline-formula> in a previous step, as follows,<disp-formula id="Equ5"><label>5</label><alternatives><tex-math id="M111">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \mu _{j,i} = P(I_c=i|A_c=j) = \frac{P(A_c=j|I_c=i)P(I_c=i|\varvec{z})}{\sum _{t=1}^{K} P(A_c=j|I_c=t)P(I_c=t|\varvec{z})} = \frac{m_{i,j} z_i}{\sum _{t=1}^{K} m_{t,j}z_t} \end{aligned}$$\end{document}</tex-math><mml:math id="M112" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>A</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>I</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>z</mml:mi><mml:mi>t</mml:mi></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ5.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par41">Within the EM algorithm, once we have the auxiliary variable <inline-formula id="IEq51"><alternatives><tex-math id="M113">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }$$\end{document}</tex-math><mml:math id="M114"><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq51.gif"/></alternatives></inline-formula>, we can maximize the log likelihood in Eq. (<xref rid="Equ4" ref-type="disp-formula">4</xref>) by taking its derivative as zeros for each cell type, together with a Lagrange multiplier on the constraint <inline-formula id="IEq52"><alternatives><tex-math id="M115">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sum _{k=1}^{K} z_k = 1$$\end{document}</tex-math><mml:math id="M116"><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msub><mml:mi>z</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq52.gif"/></alternatives></inline-formula>. By solving these equations (i.e., M-step), we can obtain an updated <inline-formula id="IEq53"><alternatives><tex-math id="M117">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M118"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq53.gif"/></alternatives></inline-formula> with <inline-formula id="IEq54"><alternatives><tex-math id="M119">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }$$\end{document}</tex-math><mml:math id="M120"><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq54.gif"/></alternatives></inline-formula> calculated from a previous step.<disp-formula id="Equ6"><label>6</label><alternatives><tex-math id="M121">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} z_i = \frac{\sum _{j=1}^{K}\mu _{j,i} n_j}{\sum _{t=1}^{K}\sum _{j=1}^{K}\mu _{j,t} n_j}. \end{aligned}$$\end{document}</tex-math><mml:math id="M122" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ6.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par42">Therefore, by alternating the E step in Eq. (<xref rid="Equ5" ref-type="disp-formula">5</xref>) and M step in Eq. (<xref rid="Equ6" ref-type="disp-formula">6</xref>), we can achieve a maximum likelihood estimate of corrected cell type composition vector <inline-formula id="IEq55"><alternatives><tex-math id="M123">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{z}$$\end{document}</tex-math><mml:math id="M124"><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq55.gif"/></alternatives></inline-formula> once the log likelihood stops increasing.</p>
    </sec>
    <sec id="Sec12">
      <title>Estimation of clustering similarity matrix</title>
      <p id="Par43">As mentioned above, the clustering of single-cell is often inaccurate with systematic bias. So we introduce a similarity matrix to describe this kind of misclassification bias. We assume that this kind of bias comes from the similarity between different cell types and variety within each cell type. Thus, the conditions of samples where our single-cell data comes from do not influence the direction of this bias. In other words, misclassification error introduced by the clustering process is consistent across all samples coming from different conditions.</p>
      <p id="Par44">Currently, DCATS supports three strategies for estimating the confusion matrix: Uniform, KNN and classification. Firstly, the uniform confusion matrix is defined as<disp-formula id="Equ7"><label>7</label><alternatives><tex-math id="M125">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \textbf{M}^{(u)} = (1 - \epsilon (K+1)/K) \textbf{I} + \epsilon / K \end{aligned}$$\end{document}</tex-math><mml:math id="M126" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msup><mml:mi mathvariant="bold">M</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:mi>ϵ</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>K</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo stretchy="false">/</mml:mo><mml:mi>K</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi mathvariant="bold">I</mml:mi><mml:mo>+</mml:mo><mml:mi>ϵ</mml:mi><mml:mo stretchy="false">/</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ7.gif" position="anchor"/></alternatives></disp-formula>where <italic>K</italic> is the number of cell types; <inline-formula id="IEq56"><alternatives><tex-math id="M127">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\textbf{I}$$\end{document}</tex-math><mml:math id="M128"><mml:mi mathvariant="bold">I</mml:mi></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq56.gif"/></alternatives></inline-formula> is an identify matrix and <inline-formula id="IEq57"><alternatives><tex-math id="M129">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\epsilon$$\end{document}</tex-math><mml:math id="M130"><mml:mi>ϵ</mml:mi></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq57.gif"/></alternatives></inline-formula> is the level of confusion, which are set to 0.05 by default. It describes an unbiased misclassification across all the cell types. It means that one cell from a cell type have equal chance to be assigned to rest other cell types.</p>
      <p id="Par45">Secondly, the KNN-based similarity matrix is estimated from the knn graph based on the transcriptome, e.g., provided by Seurat [<xref ref-type="bibr" rid="CR23">23</xref>]. It calculates the proportion of neighborhoods that are regarded as other cell types. In this case, DCATS corrects cell proportions mainly based on the information of similarity between different cell types and variety within each cell types. By defining <inline-formula id="IEq58"><alternatives><tex-math id="M131">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n_{x,j}$$\end{document}</tex-math><mml:math id="M132"><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq58.gif"/></alternatives></inline-formula> as the number of neighbors for cell <italic>x</italic> that are classified as cell type <italic>j</italic>, we can calculate KNN-based similarity matrix, e.g., its entry <inline-formula id="IEq59"><alternatives><tex-math id="M133">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m_{i,j}$$\end{document}</tex-math><mml:math id="M134"><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq59.gif"/></alternatives></inline-formula> for similarity (misclassification) from cluster <italic>i</italic> to <italic>j</italic> as follows:<disp-formula id="Equ14"><alternatives><tex-math id="M135">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} m_{i,j} = \frac{\sum _{x=1}^{x_i} n_{x,j}}{\sum _{j=1}^{K}\sum _{x=1}^{x_i} n_{x,j}} \end{aligned}$$\end{document}</tex-math><mml:math id="M136" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>m</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:msubsup><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:msubsup><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ14.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par46">We realize in some situations, the cell clustering process might not be performed using the Seurat pipeline. It is also a common situation where people perform the clustering process based on part of the markers which they are interested in. With the development of technology, more information can be used for single cell clustering including spatial information as well as biophysical feature. In above cases, knn matrix given by the Seurat pipeline cannot fully capture the bias introduced through the clustering process.</p>
      <p id="Par47">Based on the above reason, we introduce the third way to estimate a similarity matrix. The input for estimating the similarity matrix will be a data frame containing a set of variables that the user believe will influence the result of the clustering process as well as the cell type labels for each cell. We then use 5-fold cross validation and use support vector machine as the classifier to estimate the similarity matrix.</p>
    </sec>
    <sec id="Sec13">
      <title>Detecting differential composition abundance</title>
      <sec id="Sec14">
        <title>Generalized linear model</title>
        <p id="Par48"> We assume the corrected cell counts <inline-formula id="IEq60"><alternatives><tex-math id="M137">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{s,j}$$\end{document}</tex-math><mml:math id="M138"><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq60.gif"/></alternatives></inline-formula> for cell type <italic>j</italic> given sample <italic>s</italic> follow beta-binomial distribution. We then describe <inline-formula id="IEq61"><alternatives><tex-math id="M139">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z_{s,j}$$\end{document}</tex-math><mml:math id="M140"><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq61.gif"/></alternatives></inline-formula> with a beta-binomial generalized linear model(GLM) with a logit link function for each covariate <italic>i</italic>, as follows,<disp-formula id="Equ8"><label>8</label><alternatives><tex-math id="M141">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} z_{s,j}\sim &amp; {} \texttt{Binom}(n_s, p_{s,j})\nonumber \\ p_{s,j}\sim &amp; {} \texttt{Beta}(\alpha _{s,j}, \beta _{s,j}) \end{aligned}$$\end{document}</tex-math><mml:math id="M142" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi mathvariant="monospace">Binom</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>s</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mi mathvariant="monospace">Beta</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ8.gif" position="anchor"/></alternatives></disp-formula>where we reparameterized with the mean <inline-formula id="IEq62"><alternatives><tex-math id="M143">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\bar{p}_{s,j}$$\end{document}</tex-math><mml:math id="M144"><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq62.gif"/></alternatives></inline-formula> and over dispersion <inline-formula id="IEq63"><alternatives><tex-math id="M145">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi _j$$\end{document}</tex-math><mml:math id="M146"><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq63.gif"/></alternatives></inline-formula> as <inline-formula id="IEq64"><alternatives><tex-math id="M147">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\alpha _{s,j} = \bar{p}_{s,j} (1/\phi _j - 1)$$\end{document}</tex-math><mml:math id="M148"><mml:mrow><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq64.gif"/></alternatives></inline-formula> and <inline-formula id="IEq65"><alternatives><tex-math id="M149">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\beta _{s,j} = (1-\bar{p}_{s,j}) (1/\phi _j - 1)$$\end{document}</tex-math><mml:math id="M150"><mml:mrow><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq65.gif"/></alternatives></inline-formula>. As described below, the mean parameter <inline-formula id="IEq66"><alternatives><tex-math id="M151">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\bar{p}_{s,j}$$\end{document}</tex-math><mml:math id="M152"><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq66.gif"/></alternatives></inline-formula> is regressed to a set of covariates under different hypothesis. The weights for covariates and <inline-formula id="IEq67"><alternatives><tex-math id="M153">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi _j$$\end{document}</tex-math><mml:math id="M154"><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq67.gif"/></alternatives></inline-formula> will be optimized to achieve maximum likelihood, through the <italic>aod</italic> package. The <italic>p</italic> value can be calculated with a likelihood ratio test by comparing the log likelihoods in both alternative and null hypotheses.</p>
        <p id="Par49"><italic>Full mode and Null mode</italic> In DCATS, we allow using both “full mode” and “null mode” to finish the differential abundance analysis. When using null mode, we compare these two models:<disp-formula id="Equ9"><label>9</label><alternatives><tex-math id="M155">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \mathbf {H_0:}{} &amp; {} \quad \texttt{logit}(\bar{p}_{s,j}) = w_0\nonumber \\ \mathbf {H_1:}{} &amp; {} \quad \texttt{logit}(\bar{p}_{s,j}) = w_0 + w_i \times c_{s,i} \end{aligned}$$\end{document}</tex-math><mml:math id="M156" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow><mml:msub><mml:mi mathvariant="bold">H</mml:mi><mml:mn mathvariant="bold">0</mml:mn></mml:msub><mml:mo>:</mml:mo></mml:mrow><mml:mrow/></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mspace width="1em"/><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mrow><mml:msub><mml:mi mathvariant="bold">H</mml:mi><mml:mn mathvariant="bold">1</mml:mn></mml:msub><mml:mo>:</mml:mo></mml:mrow><mml:mrow/></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mspace width="1em"/><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mi>c</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ9.gif" position="anchor"/></alternatives></disp-formula>In this case, we only consider the influence of the factor we are evaluating. When using full model, we compare these two models as follows,<disp-formula id="Equ10"><label>10</label><alternatives><tex-math id="M157">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \mathbf {H_0:}{} &amp; {} \quad \texttt{logit}(\bar{p}_{s,j}) = w_0 + \varvec{w}^{\top } \varvec{c}_s; w_i = 0\nonumber \\ \mathbf {H_1:}{} &amp; {} \quad \texttt{logit}(\bar{p}_{s,j}) = w_0 + \varvec{w}^{\top } \varvec{c}_s \end{aligned}$$\end{document}</tex-math><mml:math id="M158" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow><mml:msub><mml:mi mathvariant="bold">H</mml:mi><mml:mn mathvariant="bold">0</mml:mn></mml:msub><mml:mo>:</mml:mo></mml:mrow><mml:mrow/></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mspace width="1em"/><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub><mml:mo>;</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mrow/><mml:mrow><mml:msub><mml:mi mathvariant="bold">H</mml:mi><mml:mn mathvariant="bold">1</mml:mn></mml:msub><mml:mo>:</mml:mo></mml:mrow><mml:mrow/></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mrow/><mml:mspace width="1em"/><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">¯</mml:mo></mml:mrow></mml:mover><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ10.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq68"><alternatives><tex-math id="M159">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{c}_s$$\end{document}</tex-math><mml:math id="M160"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq68.gif"/></alternatives></inline-formula> and <inline-formula id="IEq69"><alternatives><tex-math id="M161">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{w}$$\end{document}</tex-math><mml:math id="M162"><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq69.gif"/></alternatives></inline-formula> are respecitvely for the weight and covariate vectors for sample <italic>s</italic>. Under the null hypothesis, the <inline-formula id="IEq70"><alternatives><tex-math id="M163">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$w_i$$\end{document}</tex-math><mml:math id="M164"><mml:msub><mml:mi>w</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq70.gif"/></alternatives></inline-formula> will assumed to be 0. In this case, we test the differential abundance of different condition controlling the influence of other confounding covariates.</p>
      </sec>
      <sec id="Sec15">
        <title>Fixed overdispersion term</title>
        <p id="Par50">We found out that when the numbers of biological replicates are low, the over-dispersion term <inline-formula id="IEq71"><alternatives><tex-math id="M165">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi$$\end{document}</tex-math><mml:math id="M166"><mml:mi>ϕ</mml:mi></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq71.gif"/></alternatives></inline-formula> can be over-estimated. Thus, DCATS allows estimating a global over-dispersion term across all cell types, where we assume that the over-dispersion <inline-formula id="IEq72"><alternatives><tex-math id="M167">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\phi _j$$\end{document}</tex-math><mml:math id="M168"><mml:msub><mml:mi>ϕ</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq72.gif"/></alternatives></inline-formula> remains the same across for any cell type <italic>j</italic>. To estimate a global dispersion term, we fit all cell types in one joint beta-binomial GLM by taking the design matrix as the cell type indicators. Then, the dispersion term estimated here is treated as a global dispersion and will be taken as a prefixed value when performing the main round GLM for each cell type.</p>
        <p id="Par51">Except for the mode we used in main text (Using KNN matrix as the similarity matrix and fixing the overdispersion term), three other modes of DCATS are tested in the simulation data (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S2, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S4 , Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S7–11).<list list-type="bullet"><list-item><p id="Par52">“wtoPhi_wtoEM” indicates using basic beta-binomial distribution without bias correction or fixing over-dispersion term.</p></list-item><list-item><p id="Par53">“wtoPhi_emK” indicates without fixing the over dispersion term Phi but clustering bias corrected by KNN matrix.</p></list-item><list-item><p id="Par54">“wtoPhi_emU” indicates without fixing the over dispersion term Phi but clustering bias corrected by uniform matrix.</p></list-item><list-item><p id="Par55">“estPhi_wtoEM” indicates using fixing the over dispersion term Phi but no clustering bias correction.</p></list-item><list-item><p id="Par56">“estPhi_emK” indicates using fixing the over dispersion term Phi and clustering bias corrected by KNN matrix.</p></list-item><list-item><p id="Par57">“estPhi_emU” indicates using fixing the over dispersion term Phi and clustering bias corrected by uniform matrix.</p></list-item></list></p>
      </sec>
    </sec>
    <sec id="Sec16">
      <title>Use reference cell types for normalization</title>
      <p id="Par58">When one cell type has extreme proportion change, the proportions of the rest cell types will be largely influenced, which might lead to false positives of differential abundance testing. Using known unchanged cell types as reference groups for normalization will offset the influence of massive cell types change. When using the total cell number as the normalization term, we have<disp-formula id="Equ11"><label>11</label><alternatives><tex-math id="M169">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \texttt{logit}(E(\frac{z_{s,j}}{n_s})) = w_0 + \varvec{w}^{\top } \varvec{c}_s \end{aligned}$$\end{document}</tex-math><mml:math id="M170" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>E</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mfrac><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mi>s</mml:mi></mml:msub></mml:mfrac><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ11.gif" position="anchor"/></alternatives></disp-formula>where values in <inline-formula id="IEq73"><alternatives><tex-math id="M171">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{w}^{\top }$$\end{document}</tex-math><mml:math id="M172"><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq73.gif"/></alternatives></inline-formula> could be zero based on different models. When using the reference group as the normalization term, we have<disp-formula id="Equ12"><label>12</label><alternatives><tex-math id="M173">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{aligned} \texttt{logit}(E(\frac{z_{s,j}}{\sum _{r \in R} z_{s,r}})) = w_0 + \varvec{w}^{\top } \varvec{c}_s \end{aligned}$$\end{document}</tex-math><mml:math id="M174" display="block"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mrow><mml:mi mathvariant="monospace">logit</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>E</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mfrac><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>r</mml:mi><mml:mo>∈</mml:mo><mml:mi>R</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>w</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold-italic">w</mml:mi></mml:mrow><mml:mi>⊤</mml:mi></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msub></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math><graphic xlink:href="13059_2023_2980_Article_Equ12.gif" position="anchor"/></alternatives></disp-formula>where <italic>R</italic> denotes the reference group.</p>
      <p id="Par59">We recommend using more than one cell type and more than 25% of total cells as the reference group to guarantee the stability of the normalization term.</p>
      <p id="Par60">DCATS also support the recommendation of the cell types used for reference. Namely, DCATS first calculates the <italic>p</italic>-values for each cell type. Then, it orders the cell types from high to low based on the <italic>p</italic>-values and provides the possible reference cell types based on this order. Additionally, DCATS calculates the proportion of cell counts for different numbers of reference cell types and suggests a recommended number.</p>
    </sec>
    <sec id="Sec17">
      <title>Theoretical simulation</title>
      <p id="Par61">The input of DCATS is combined with two parts. The cell count matrix <inline-formula id="IEq74"><alternatives><tex-math id="M175">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_i$$\end{document}</tex-math><mml:math id="M176"><mml:msub><mml:mi>C</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq74.gif"/></alternatives></inline-formula> denotes numbers of cells we observe for each cell type in each sample coming from same condition <italic>i</italic>. For each analysis, DCATS can only compare cell count matrices coming from two condition. Another part is the similarity matrix <italic>M</italic> we describe above.</p>
      <p id="Par62">We first simulated two count matrices <inline-formula id="IEq75"><alternatives><tex-math id="M177">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$C_1, C_2$$\end{document}</tex-math><mml:math id="M178"><mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>C</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq75.gif"/></alternatives></inline-formula> directly to demonstrate that introducing the similarity matrix to correct the unknown cell type composition vector <inline-formula id="IEq76"><alternatives><tex-math id="M179">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }$$\end{document}</tex-math><mml:math id="M180"><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq76.gif"/></alternatives></inline-formula> is important for the differential composition analysis. The numbers of replicates for condition 1 and condition 2 were 2 and 3 respectively. The total cell numbers were 2000 for each sample in both condition. We defined the genuine proportions of the three cells types were [1/3, 1/3, 1/3] and [1/3, 1/2, 1/6] in conditions 1 and 2, respectively. Using genuine proportions times 70 as concentration parameters, we generated the unknown cell type composition vector of condition 1 and condition 2 from Dirichlet distribution. For each sample, the total cell number 2000 and <inline-formula id="IEq77"><alternatives><tex-math id="M181">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }_{\varvec{i}}$$\end{document}</tex-math><mml:math id="M182"><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">i</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq77.gif"/></alternatives></inline-formula> were used to generate a cell count vector from multinomial distribution. Based on the similarity matrix we designed (Fig. <xref rid="Fig1" ref-type="fig">1</xref>B), the misclassification errors were introduced by reassigning cells into different cell types.</p>
      <p id="Par63">Next, we tried to demonstrate the effectiveness of the bias correction step. We first used DCATS and Fisher’s exact test to perform the differential composition analysis. We then used the similarity matrix we designed to correct the miscalssification error we introduced. In this case, we used the true similarity matrix to do this bias correction process. For each simulation, we repeated the above process 50 times and calculate MCC, sensitivity and specificity. Overall, we got 50 Matthews correlation coefficient (MCC), sensitivity and specificity for 50 simulation.</p>
    </sec>
    <sec id="Sec18">
      <title>Simulation with single-cell RNA gene count matrices</title>
      <p id="Par64">When analyzing single cell RNA sequencing (scRNA-seq) data, we always start from gene expression matrix. Here, we designed a simulation process to mimic the process from getting gene expression matrix to analyzing differential compositions. We first used splatter [<xref ref-type="bibr" rid="CR26">26</xref>] to generate a large cell pool including different cell types. We then generated a proportion vector <inline-formula id="IEq78"><alternatives><tex-math id="M183">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{p}_{\varvec{s}}^{\varvec{(i)}}$$\end{document}</tex-math><mml:math id="M184"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold-italic">p</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">s</mml:mi></mml:mrow></mml:mrow><mml:mrow><mml:mo mathvariant="bold" stretchy="false">(</mml:mo><mml:mi mathvariant="bold-italic">i</mml:mi><mml:mo mathvariant="bold" stretchy="false">)</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq78.gif"/></alternatives></inline-formula> for each sample <italic>s</italic> from condition <italic>i</italic> following a Dirichlet distribution. Defined genuine proportions were used as concentration parameters. Given a total cell number, a cell count vector <inline-formula id="IEq79"><alternatives><tex-math id="M185">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }_{\varvec{s}}^{\varvec{(i)}}$$\end{document}</tex-math><mml:math id="M186"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">s</mml:mi></mml:mrow></mml:mrow><mml:mrow><mml:mo mathvariant="bold" stretchy="false">(</mml:mo><mml:mi mathvariant="bold-italic">i</mml:mi><mml:mo mathvariant="bold" stretchy="false">)</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq79.gif"/></alternatives></inline-formula> was generated from multinomial distribution.</p>
      <p id="Par65">In a default setting, each condition contained 3 replicates, and 4 out of 8 cells types with differential composition abundance. The genuine proportion was [0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.2, 0.2] in condition 1 and [0.05, 0.15, 0.1, 0.1, 0.1, 0.2, 0.2, 0.1] in condition 2. For each sample, the total cell number was 3000. We also changed the number of replicates to 2 and 4, and the number of cell types to 10 and 12. When the number of cell types equalled to 10, the genuine proportions were [0.05, 0.05, 0.1, 0.1, 0.1, 0.1, 0.1, 0.05, 0.2, 0.15] and [0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1] in condition 1 and condition 2, respectively. When the number of cell types was 12, the bass proportions were [0.1, 0.1, 0.1, 0.1, 0.05, 0.05, 0.05, 0.15, 0.05, 0.05, 0.1, 0.1] and [0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.05, 0.05, 0.05, 0.05].</p>
      <p id="Par66">Based on the cell count vector <inline-formula id="IEq80"><alternatives><tex-math id="M187">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\varvec{\mu }_{\varvec{s}}^{\varvec{(i)}}$$\end{document}</tex-math><mml:math id="M188"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">s</mml:mi></mml:mrow></mml:mrow><mml:mrow><mml:mo mathvariant="bold" stretchy="false">(</mml:mo><mml:mi mathvariant="bold-italic">i</mml:mi><mml:mo mathvariant="bold" stretchy="false">)</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2023_2980_Article_IEq80.gif"/></alternatives></inline-formula>, we randomly selected cells as well as their gene expression profiles. We can therefore got a gene expression matrix for each sample. Then, we used Seurat [<xref ref-type="bibr" rid="CR23">23</xref>] pipeline to do the pre-processing as well as the clustering process. The cluster annotation of each cell was treated as input for the downstream analysis. We compared DCATS with other five tests designed for differential composition analysis which are Fisher’s exact test, scDC [<xref ref-type="bibr" rid="CR14">14</xref>], diffcyt [<xref ref-type="bibr" rid="CR12">12</xref>], milo [<xref ref-type="bibr" rid="CR8">8</xref>], and speckle [<xref ref-type="bibr" rid="CR10">10</xref>] (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1).</p>
      <p id="Par67">As milo aims to detect cell stage perturbations based on k-nearest neighbor graphs but not cell type levels, we also did the differential abundance testing on the neighborhoods level by assuming all the neighborhoods were influenced by condition if that cell types have differential proportions. In this case, we only considered neighborhoods having more than 80% of cells coming from one cell type and used neighborhoods detected by milo for testing using Fisher’s exact test, speckle [<xref ref-type="bibr" rid="CR10">10</xref>] and DCATS. For each scenario, we pooled the results coming from 30 times simulations together to calculate the F1 score, MCC, AUC and area under the precision-recall curve (PRAUC). The confidence interval of F1 score, MCC, AUC and PRAUC were calculated by bootstrapping the testing results 50 times.</p>
    </sec>
    <sec id="Sec19">
      <title>Adding other confounding covariates</title>
      <p id="Par68">To demonstrate that DCATS can control the influence of confounding covariates, we designed a simulation with eight cell types. First four of them had different proportions in different conditions, and rest four of them had same proportions in different conditions. We also added two confounding covariates, age and gender which influenced the proportions of four among eight cell types. Using 15 years old as the baseline, one year increase in age led to 0.05 decrease of concentration parameters in cell type 1 and cell type 5. It also led to 0.05 increase of concentration parameters in cell type 2 and cell type 6. Comparing to female, male had 2 increase of concentration parameters in cell type 2 and 6, 2 decrease in cell type 1 and cell type 5. (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S5) The gender for each sample was randomly selected from female or male. The age was randomly select from 15 to 45. The influence of condition, age and gender was additive and result in the final proportion of each cell types in each biological replicate. Overall, we had 10 biological replicates in each condition with different ages and genders. We simulated proportions based on the true designed proportions from a Dirichlet distribution and cell numbers based on the simulated proportions from the multinomial distribution. Based on the simulated cell counts, we simulated gene expression matrices and did the differential abundance analysis as described previously.</p>
    </sec>
    <sec id="Sec20">
      <title>Simulation starting from cell counts differences</title>
      <p id="Par69">To demonstrate that DCATS can handle spurious effects arising from compositionality characteristics — namely, when the proportion of one cell type increases, the proportions of the remaining cell types decrease — we conducted a simulation scenario where one cell type had differential abundance with increased counts, while the remaining cell types had the same counts. In this case, the remaining cell types had lower proportions than the original composition, but these proportion differences were merely side effects and should not be detected as differential abundance.</p>
      <p id="Par70">We simulated eight cell types with count units [1, 4, 4, 4, 4, 4, 4, 4] in condition 1 and [20, 4, 4, 4, 4, 4, 4, 4] in condition 2. The first cell type had a 20-fold count increase in condition 2, while the remaining cell types remained the same. We calculated the proportions of each cell type and used these proportions for the simulation. The proportion of each cell type in condition 1 was [0.034, 0.138, 0.138, 0.138, 0.138, 0.138, 0.138, 0.138], while the proportion of each cell type in condition 2 was [0.417, 0.083, 0.083, 0.083, 0.083, 0.083, 0.083, 0.083]. We simulated three replicates for each condition. When the total count remained at 3000 in both condition 1 and condition 2, the observed cell count of the first cell type showed a huge increase in condition 2, while the cell counts of the remaining cell types decreased (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S11). The cell selection and testing procedures were the same as in the above section of simulating cell counts matrices.</p>
    </sec>
    <sec id="Sec21">
      <title>Methods for benchmark</title>
      <sec id="Sec22">
        <title>Fisher’s exact test</title>
        <p id="Par71">As Fisher’s exact test does not support multiple replicates, we added the cell counts numbers of all replicates in each condition and tested based on the sum of cell counts.</p>
      </sec>
      <sec id="Sec23">
        <title>diffcyt</title>
        <p id="Par72">diffcyt [<xref ref-type="bibr" rid="CR12">12</xref>] is a package designed for differential discovery analyses in high-dimensional cytometry data. In order to adopt it to analyze scRNA-seq data. We first create data template using random generated flowset data, then replaced it with meta-data of data we simulate. We used default for the rest setting.</p>
      </sec>
      <sec id="Sec24">
        <title>ANCOMBC</title>
        <p id="Par73">ANCOMBC [<xref ref-type="bibr" rid="CR11">11</xref>] is designed for differential abundance analysis for microbiome data. We use the count matrix and design matrix to create TreeSummarizedExperiment objects [<xref ref-type="bibr" rid="CR32">32</xref>]. These objects are used as input for ANCOMBC. Rest parameters are set as default. The count matrices we used include the count matrix calculated from Seurat clustering results (ancombc), and the bias-corrected count matrices calculated from DCATS (bcancombc).</p>
      </sec>
      <sec id="Sec25">
        <title>milo</title>
        <p id="Par74">milo [<xref ref-type="bibr" rid="CR8">8</xref>] aims to detect cell state changes in neighborhoods level, while both our simulated data and real-world data only have ground truth in cell type level. Thus, we linked neighborhoods with cell type based on the majority cell in that neighborhoods as what milo’s authors did in the milo paper [<xref ref-type="bibr" rid="CR8">8</xref>]. We first used FDR&lt;0.1 as threshold to define whether one neighborhood has cell state changes, and calculated how many more neighborhoods one condition has dominant size comparing to the other condition as well as the proportion of this difference among all neighborhoods that belong to that cell type. This proportion is regarded as perturbation level. Inferring from the Kang dataset [<xref ref-type="bibr" rid="CR4">4</xref>] which works as the negative control, we defined that one cell type shows significant proportion changes when the perturbation level is larger than 20%. Due to the less variety of simulated data, this threshold is setted to be 0 in simulated data in order to get better performance of milo.</p>
      </sec>
      <sec id="Sec26">
        <title>speckle and scDC</title>
        <p id="Par75">For speckle [<xref ref-type="bibr" rid="CR10">10</xref>] and scDC [<xref ref-type="bibr" rid="CR14">14</xref>], we used default setting and standard pipeline as described in the github page/tutorials of these two tools.</p>
      </sec>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec27">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="13059_2023_2980_MOESM1_ESM.pdf">
            <caption>
              <p><bold>Additional file 1.</bold> Supplementary Table S1-S10 and Supplementary Figures S1-S14. Additional file 1 contains Supplementary Figures and Supplementary Tables.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="13059_2023_2980_MOESM2_ESM.pdf">
            <caption>
              <p><bold>Additional file 2.</bold> Review history.</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p>
        <bold>Publisher’s Note</bold>
      </p>
      <p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank members in Ho lab, Huang lab from the University of Hong Kong, and Xuegong Zhang lab from Tsinghua University, especially Aaron Kwok, Weizhong Zheng, Ken Yu, and Junyi Chen, for fruitful discussions.</p>
    <sec id="FPar1">
      <title>Review history</title>
      <p id="Par76">The review history is available as Additional file <xref rid="MOESM1" ref-type="media">2</xref>.</p>
    </sec>
    <sec id="FPar2">
      <title>Peer review information</title>
      <p id="Par77">Andrew Cosgrove and Anahita Bishop were the primary editors of this article and managed its editorial process and peer review in collaboration with the rest of the editorial team.</p>
    </sec>
  </ack>
  <notes notes-type="author-contribution">
    <title>Authors’ contributions</title>
    <p>YH and JWKH conceived the ideas and designed the study. XL developed the method, implemented the R package, and performed all the experiments. CC supported the initial development of the method, collected some data, and supported evaluation. KM performed some simulation experiments and analysis. XL, YH, and JWKH wrote the paper. All authors read and approved the final version of the manuscript.</p>
  </notes>
  <notes notes-type="funding-information">
    <title>Funding</title>
    <p>This work was supported by AIR@InnoHK administered by Innovation and Technology Commission.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Availability of data and materials</title>
    <p>All datasets used in the paper are previously published and can be found in NCBI GEO database: GSE96583 [<xref ref-type="bibr" rid="CR4">4</xref>], GSE92332 [<xref ref-type="bibr" rid="CR28">28</xref>], and GSE158055 [<xref ref-type="bibr" rid="CR29">29</xref>].</p>
    <p> This algorithm is implemented as an R package named DCATS which is available at Github [<xref ref-type="bibr" rid="CR33">33</xref>] under the MIT license. The codes for simulation and analysis are avalible in Github [<xref ref-type="bibr" rid="CR34">34</xref>]. The source code used in this paper is deposited in Zenodo with DOI: 10.5281/zenodo.7969592 [<xref ref-type="bibr" rid="CR35">35</xref>].</p>
  </notes>
  <notes>
    <title>Declarations</title>
    <notes id="FPar3">
      <title>Ethics approval and consent to participate</title>
      <p id="Par78">Not applicable.</p>
    </notes>
    <notes id="FPar4">
      <title>Consent for publication</title>
      <p id="Par79">All authors have approved the manuscript for submission.</p>
    </notes>
    <notes id="FPar5" notes-type="COI-statement">
      <title>Competing interests</title>
      <p id="Par80">The authors declare that they have no competing interests.</p>
    </notes>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Paik</surname>
            <given-names>DT</given-names>
          </name>
          <name>
            <surname>Cho</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Tian</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Chang</surname>
            <given-names>HY</given-names>
          </name>
          <name>
            <surname>Wu</surname>
            <given-names>JC</given-names>
          </name>
        </person-group>
        <article-title>Single-cell RNA sequencing in cardiovascular development, disease and medicine</article-title>
        <source>Nat Rev Cardiol.</source>
        <year>2020</year>
        <volume>17</volume>
        <issue>8</issue>
        <fpage>457</fpage>
        <lpage>473</lpage>
        <pub-id pub-id-type="doi">10.1038/s41569-020-0359-y</pub-id>
        <?supplied-pmid 32231331?>
        <pub-id pub-id-type="pmid">32231331</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Potter</surname>
            <given-names>SS</given-names>
          </name>
        </person-group>
        <article-title>Single-cell RNA sequencing for the study of development, physiology and disease</article-title>
        <source>Nat Rev Nephrol.</source>
        <year>2018</year>
        <volume>14</volume>
        <issue>8</issue>
        <fpage>479</fpage>
        <lpage>492</lpage>
        <pub-id pub-id-type="doi">10.1038/s41581-018-0021-7</pub-id>
        <?supplied-pmid 29789704?>
        <pub-id pub-id-type="pmid">29789704</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stoeckius</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Zheng</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Houck-Loomis</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Hao</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Yeung</surname>
            <given-names>BZ</given-names>
          </name>
          <name>
            <surname>Mauck</surname>
            <given-names>WM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cell Hashing with barcoded antibodies enables multiplexing and doublet detection for single cell genomics</article-title>
        <source>Genome Biol.</source>
        <year>2018</year>
        <volume>19</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>12</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-018-1603-1</pub-id>
        <pub-id pub-id-type="pmid">29301551</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <mixed-citation publication-type="other">Kang HM, Subramaniam M, Targ S, Nguyen M, Maliskova L, McCarthy E, et al. Multiplexed droplet single-cell RNA-sequencing using natural genetic variation. GSE96583. Gene Expression Omnibus. 2017. <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE96583">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE96583</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Huang</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>McCarthy</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Stegle</surname>
            <given-names>O</given-names>
          </name>
        </person-group>
        <article-title>Vireo: Bayesian demultiplexing of pooled single-cell RNA-seq data without genotype reference</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>12</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1865-2</pub-id>
        <pub-id pub-id-type="pmid">30606230</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Blondel</surname>
            <given-names>VD</given-names>
          </name>
          <name>
            <surname>Guillaume</surname>
            <given-names>JL</given-names>
          </name>
          <name>
            <surname>Lambiotte</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Lefebvre</surname>
            <given-names>E</given-names>
          </name>
        </person-group>
        <article-title>Fast unfolding of communities in large networks</article-title>
        <source>J Stat Mech Theory Exp.</source>
        <year>2008</year>
        <volume>2008</volume>
        <issue>10</issue>
        <fpage>P10008</fpage>
        <pub-id pub-id-type="doi">10.1088/1742-5468/2008/10/P10008</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Büttner</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Ostner</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Müller</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Schubert</surname>
            <given-names>B</given-names>
          </name>
        </person-group>
        <article-title>scCODA is a Bayesian model for compositional single-cell data analysis</article-title>
        <source>Nat Commun.</source>
        <year>2021</year>
        <volume>12</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>10</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-021-27150-6</pub-id>
        <pub-id pub-id-type="pmid">33397941</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <mixed-citation publication-type="other">Dann E, Henderson NC, Teichmann SA, Morgan MD, Marioni JC. Differential abundance testing on single-cell data using k-nearest neighbor graphs. Nat Biotechnol. 2021;40(2):1–9.</mixed-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <mixed-citation publication-type="other">Zhao J, Jaffe A, Li H, Lindenbaum O, Sefik E, Jackson R, et al. Detection of differentially abundant cell subpopulations in scRNA-seq data. Proc Natl Acad Sci. 2021;118(22):e2100293118.</mixed-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Phipson</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Sim</surname>
            <given-names>CB</given-names>
          </name>
          <name>
            <surname>Porrello</surname>
            <given-names>ER</given-names>
          </name>
          <name>
            <surname>Hewitt</surname>
            <given-names>AW</given-names>
          </name>
          <name>
            <surname>Powell</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Oshlack</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>propeller: testing for differences in cell type proportions in single cell data</article-title>
        <source>Bioinformatics.</source>
        <year>2022</year>
        <volume>38</volume>
        <issue>20</issue>
        <fpage>4720</fpage>
        <lpage>4726</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btac582</pub-id>
        <?supplied-pmid 36005887?>
        <pub-id pub-id-type="pmid">36005887</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lin</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Peddada</surname>
            <given-names>SD</given-names>
          </name>
        </person-group>
        <article-title>Analysis of compositions of microbiomes with bias correction</article-title>
        <source>Nat Commun.</source>
        <year>2020</year>
        <volume>11</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>11</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-020-17041-7</pub-id>
        <pub-id pub-id-type="pmid">31911652</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Weber</surname>
            <given-names>LM</given-names>
          </name>
          <name>
            <surname>Nowicka</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Soneson</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Robinson</surname>
            <given-names>MD</given-names>
          </name>
        </person-group>
        <article-title>diffcyt: Differential discovery in high-dimensional cytometry via high-resolution clustering</article-title>
        <source>Commun Biol.</source>
        <year>2019</year>
        <volume>2</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>11</lpage>
        <pub-id pub-id-type="doi">10.1038/s42003-019-0415-5</pub-id>
        <pub-id pub-id-type="pmid">30740537</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Robinson</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>McCarthy</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Smyth</surname>
            <given-names>GK</given-names>
          </name>
        </person-group>
        <article-title>edgeR: a Bioconductor package for differential expression analysis of digital gene expression data</article-title>
        <source>Bioinformatics.</source>
        <year>2010</year>
        <volume>26</volume>
        <issue>1</issue>
        <fpage>139</fpage>
        <lpage>140</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btp616</pub-id>
        <?supplied-pmid 19910308?>
        <pub-id pub-id-type="pmid">19910308</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cao</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Lin</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Ormerod</surname>
            <given-names>JT</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>JY</given-names>
          </name>
          <name>
            <surname>Lo</surname>
            <given-names>KK</given-names>
          </name>
        </person-group>
        <article-title>scDC: single cell differential composition analysis</article-title>
        <source>BMC Bioinformatics.</source>
        <year>2019</year>
        <volume>20</volume>
        <issue>19</issue>
        <fpage>1</fpage>
        <lpage>12</lpage>
        <pub-id pub-id-type="pmid">30606105</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Fischer</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Strauch</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Renard</surname>
            <given-names>BY</given-names>
          </name>
        </person-group>
        <article-title>Abundance estimation and differential testing on strain level in metagenomics data</article-title>
        <source>Bioinformatics.</source>
        <year>2017</year>
        <volume>33</volume>
        <issue>14</issue>
        <fpage>i124</fpage>
        <lpage>i132</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btx237</pub-id>
        <?supplied-pmid 28881972?>
        <pub-id pub-id-type="pmid">28881972</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lindner</surname>
            <given-names>MS</given-names>
          </name>
          <name>
            <surname>Renard</surname>
            <given-names>BY</given-names>
          </name>
        </person-group>
        <article-title>Metagenomic abundance estimation and diagnostic testing on species level</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2013</year>
        <volume>41</volume>
        <issue>1</issue>
        <fpage>e10</fpage>
        <lpage>e10</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gks803</pub-id>
        <?supplied-pmid 22941661?>
        <pub-id pub-id-type="pmid">22941661</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <mixed-citation publication-type="other">Lesnoff M, Lancelot R. aod: Analysis of Overdispersed Data. 2012. R package version 1.3.2. <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=aod">https://cran.r-project.org/package=aod</ext-link>. Accessed 16 Mar 2020.</mixed-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schafflick</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Xu</surname>
            <given-names>CA</given-names>
          </name>
          <name>
            <surname>Hartlehnert</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Cole</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Schulte-Mecklenbeck</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Lautwein</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Integrated single cell analysis of blood and cerebrospinal fluid leukocytes in multiple sclerosis</article-title>
        <source>Nat Commun.</source>
        <year>2020</year>
        <volume>11</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>14</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-019-14118-w</pub-id>
        <pub-id pub-id-type="pmid">31911652</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Luecken</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>Current best practices in single-cell RNA-seq analysis: a tutorial</article-title>
        <source>Mol Syst Biol.</source>
        <year>2019</year>
        <volume>15</volume>
        <issue>6</issue>
        <fpage>e8746</fpage>
        <pub-id pub-id-type="doi">10.15252/msb.20188746</pub-id>
        <?supplied-pmid 31217225?>
        <pub-id pub-id-type="pmid">31217225</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Andrews</surname>
            <given-names>TS</given-names>
          </name>
          <name>
            <surname>Kiselev</surname>
            <given-names>VY</given-names>
          </name>
          <name>
            <surname>McCarthy</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Hemberg</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Tutorial: guidelines for the computational analysis of single-cell RNA sequencing data</article-title>
        <source>Nat Protocol.</source>
        <year>2021</year>
        <volume>16</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>9</lpage>
        <pub-id pub-id-type="doi">10.1038/s41596-020-00409-w</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <mixed-citation publication-type="other">Pasquini G, Arias JER, Schäfer P, Busskamp V. Automated methods for cell type annotation on scRNA-seq data. Comput Struct Biotechnol J. 2021;19:961-9.</mixed-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Abdelaal</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Michielsen</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Cats</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Hoogduin</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Mei</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Reinders</surname>
            <given-names>MJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A comparison of automatic cell identification methods for single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>19</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1795-z</pub-id>
        <pub-id pub-id-type="pmid">30606230</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stuart</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Butler</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Hoffman</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Hafemeister</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Papalexi</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Mauck</surname>
            <given-names>WM</given-names>
            <suffix>III</suffix>
          </name>
          <etal/>
        </person-group>
        <article-title>Comprehensive integration of single-cell data</article-title>
        <source>Cell.</source>
        <year>2019</year>
        <volume>177</volume>
        <issue>7</issue>
        <fpage>1888</fpage>
        <lpage>1902</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2019.05.031</pub-id>
        <?supplied-pmid 31178118?>
        <pub-id pub-id-type="pmid">31178118</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Angerer</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title>
        <source>Genome Biol.</source>
        <year>2018</year>
        <volume>19</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>5</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-017-1382-0</pub-id>
        <pub-id pub-id-type="pmid">29301551</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kaufmann</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Evans</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Schaupp</surname>
            <given-names>AL</given-names>
          </name>
          <name>
            <surname>Engler</surname>
            <given-names>JB</given-names>
          </name>
          <name>
            <surname>Kaur</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Willing</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Identifying CNS-colonizing T cells as potential therapeutic targets to prevent progression of multiple sclerosis</article-title>
        <source>Med.</source>
        <year>2021</year>
        <volume>2</volume>
        <issue>3</issue>
        <fpage>296</fpage>
        <lpage>312</lpage>
        <pub-id pub-id-type="doi">10.1016/j.medj.2021.01.006</pub-id>
        <?supplied-pmid 33748804?>
        <pub-id pub-id-type="pmid">33748804</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zappia</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Phipson</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Oshlack</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Splatter: simulation of single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2017</year>
        <volume>18</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>15</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-017-1305-0</pub-id>
        <pub-id pub-id-type="pmid">28077169</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Angelidis</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Simon</surname>
            <given-names>LM</given-names>
          </name>
          <name>
            <surname>Fernandez</surname>
            <given-names>IE</given-names>
          </name>
          <name>
            <surname>Strunz</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Mayr</surname>
            <given-names>CH</given-names>
          </name>
          <name>
            <surname>Greiffo</surname>
            <given-names>FR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>An atlas of the aging lung mapped by single cell transcriptomics and deep tissue proteomics</article-title>
        <source>Nat Commun.</source>
        <year>2019</year>
        <volume>10</volume>
        <issue>1</issue>
        <fpage>1</fpage>
        <lpage>17</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-019-08831-9</pub-id>
        <pub-id pub-id-type="pmid">30602773</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <mixed-citation publication-type="other">Haber AL, Biton M, Rogel N, Herbst RH, Shekhar K, Smillie C, et al. A single-cell survey of the small intestinal epithelium. GSE92332. Gene Expression Omnibus. 2017. <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE92332">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE92332</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <mixed-citation publication-type="other">Ren X, Wen W, Fan X, Hou W, Su B, Cai P, et al. COVID-19 immune features revealed by a large-scale single-cell transcriptome atlas. GSE158055. Gene Expression Omnibus. 2021. <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE158055">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE158055</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <mixed-citation publication-type="other">Mann ER, Menon M, Knight SB, Konkel JE, Jagger C, Shaw TN, et al. Longitudinal immune profiling reveals key myeloid signatures associated with COVID-19. Sci Immunol. 2020;5(51).</mixed-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Qin</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Jiang</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Wei</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Liu</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Guan</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Dynamic changes in monocytes subsets in COVID-19 patients</article-title>
        <source>Hum Immunol.</source>
        <year>2021</year>
        <volume>82</volume>
        <issue>3</issue>
        <fpage>170</fpage>
        <lpage>176</lpage>
        <pub-id pub-id-type="doi">10.1016/j.humimm.2020.12.010</pub-id>
        <?supplied-pmid 33531264?>
        <pub-id pub-id-type="pmid">33531264</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <mixed-citation publication-type="other">Huang R, Soneson C, Ernst FG, Rue-Albrecht KC, Yu G, Hicks SC, et al. TreeSummarizedExperiment: a S4 class for data with hierarchical structure. F1000Research. 2020;9:1246.</mixed-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <mixed-citation publication-type="other">Lin X, Chau C, Ma K, Huang Y, W K Ho J. DCTAS: differential composition analysis for flexible single-cell experimental designs. 2023. <ext-link ext-link-type="uri" xlink:href="https://github.com/holab-hku/DCATS/tree/master">https://github.com/holab-hku/DCATS/tree/master</ext-link>. Accessed 21 Apr 2023.</mixed-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <mixed-citation publication-type="other">Lin X, Chau C, Ma K, Huang Y, W K Ho J. DCTAS analysis. 2023. <ext-link ext-link-type="uri" xlink:href="https://github.com/linxy29/DCATS_anlysis">https://github.com/linxy29/DCATS_anlysis</ext-link>. Accessed 6 Mar 2023.</mixed-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <mixed-citation publication-type="other">Lin X, Chau C, Kun M, Huang Y, Ho JWK. DCATS: differential composition analysis for flexible single-cell experimental designs. Zenodo. 2023. 10.5281/zenodo.7969592.</mixed-citation>
    </ref>
  </ref-list>
</back>
