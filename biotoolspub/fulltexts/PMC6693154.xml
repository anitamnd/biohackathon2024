<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Genome Biol</journal-id>
    <journal-id journal-id-type="iso-abbrev">Genome Biol</journal-id>
    <journal-title-group>
      <journal-title>Genome Biology</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1474-7596</issn>
    <issn pub-type="epub">1474-760X</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6693154</article-id>
    <article-id pub-id-type="publisher-id">1766</article-id>
    <article-id pub-id-type="doi">10.1186/s13059-019-1766-4</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Method</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>scAlign: a tool for alignment, integration, and rare cell identification from scRNA-seq data</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" corresp="yes">
        <name>
          <surname>Johansen</surname>
          <given-names>Nelson</given-names>
        </name>
        <address>
          <email>njjohansen@ucdavis.edu</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-1716-0153</contrib-id>
        <name>
          <surname>Quon</surname>
          <given-names>Gerald</given-names>
        </name>
        <address>
          <email>gquon@ucdavis.edu</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 1936 9684</institution-id><institution-id institution-id-type="GRID">grid.27860.3b</institution-id><institution>Graduate Group in Computer Science, </institution><institution>University of California, Davis, </institution></institution-wrap>Davis, CA USA </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 1936 9684</institution-id><institution-id institution-id-type="GRID">grid.27860.3b</institution-id><institution>Genome Center, </institution><institution>University of California, Davis, </institution></institution-wrap>Davis, CA USA </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 1936 9684</institution-id><institution-id institution-id-type="GRID">grid.27860.3b</institution-id><institution>Department of Molecular and Cellular Biology, </institution><institution>University of California, Davis, </institution></institution-wrap>Davis, CA USA </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>14</day>
      <month>8</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>14</day>
      <month>8</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2019</year>
    </pub-date>
    <volume>20</volume>
    <elocation-id>166</elocation-id>
    <history>
      <date date-type="received">
        <day>8</day>
        <month>5</month>
        <year>2019</year>
      </date>
      <date date-type="accepted">
        <day>19</day>
        <month>7</month>
        <year>2019</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s). 2019</copyright-statement>
      <license license-type="OpenAccess">
        <license-p><bold>Open Access</bold>This article is distributed under the terms of the Creative Commons Attribution 4.0 International License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted use, distribution, and reproduction in any medium, provided you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The Creative Commons Public Domain Dedication waiver (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/publicdomain/zero/1.0/">http://creativecommons.org/publicdomain/zero/1.0/</ext-link>) applies to the data made available in this article, unless otherwise stated.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">scRNA-seq dataset integration occurs in different contexts, such as the identification of cell type-specific differences in gene expression across conditions or species, or batch effect correction. We present scAlign, an unsupervised deep learning method for data integration that can incorporate partial, overlapping, or a complete set of cell labels, and estimate per-cell differences in gene expression across datasets. scAlign performance is state-of-the-art and robust to cross-dataset variation in cell type-specific expression and cell type composition. We demonstrate that scAlign reveals gene expression programs for rare populations of malaria parasites. Our framework is widely applicable to integration challenges in other domains.</p>
      <sec>
        <title>Electronic supplementary material</title>
        <p>The online version of this article (10.1186/s13059-019-1766-4) contains supplementary material, which is available to authorized users.</p>
      </sec>
    </abstract>
    <kwd-group xml:lang="en">
      <title>Keywords</title>
      <kwd>scRNA-seq</kwd>
      <kwd>Data integration</kwd>
      <kwd>Data harmonization</kwd>
      <kwd>Alignment</kwd>
      <kwd>Deep learning</kwd>
      <kwd>Neural networks</kwd>
      <kwd>Response to stimulus</kwd>
      <kwd>Batch effects</kwd>
      <kwd>Domain adaptation</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Chan Zuckerberg Initiative</institution>
        </funding-source>
        <award-id>182633</award-id>
        <principal-award-recipient>
          <name>
            <surname>Quon</surname>
            <given-names>Gerald</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000076</institution-id>
            <institution>Directorate for Biological Sciences</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1846559</award-id>
        <principal-award-recipient>
          <name>
            <surname>Quon</surname>
            <given-names>Gerald</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2019</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Background</title>
    <p id="Par2">Single cell RNA sequencing (scRNA-seq) technologies enable the capture of high-resolution snapshots of gene expression activity in individual cells. As the generation of scRNA-seq data accelerates, integrative analysis of multiple scRNA-seq datasets [<xref ref-type="bibr" rid="CR1">1</xref>–<xref ref-type="bibr" rid="CR8">8</xref>] is becoming increasingly important. The goal of scRNA-seq data integration is to characterize and eliminate the effect of experimental factors driving expression variation between multiple scRNA-seq datasets, so that downstream analyses such as clustering [<xref ref-type="bibr" rid="CR9">9</xref>, <xref ref-type="bibr" rid="CR10">10</xref>] and trajectory inference [<xref ref-type="bibr" rid="CR10">10</xref>–<xref ref-type="bibr" rid="CR12">12</xref>] performed on all datasets jointly are not driven by these factors. Such experimental factors include both technical nuisance factors such as batch or sequencing protocol [<xref ref-type="bibr" rid="CR13">13</xref>–<xref ref-type="bibr" rid="CR18">18</xref>], as well as biological factors of interest such as in case-control studies [<xref ref-type="bibr" rid="CR19">19</xref>–<xref ref-type="bibr" rid="CR22">22</xref>] or speciation [<xref ref-type="bibr" rid="CR23">23</xref>].</p>
    <p id="Par3">Integrative analyses are challenging due to several factors. First, dataset integration can be viewed as mapping one dataset onto another. For example, in case-control studies for which a pair of scRNA-seq datasets are generated from biological replicate populations before and after stimulus, functionally matched cell types across datasets must be identified and aligned in order to estimate cell type-specific response to stimulus. The more differential the response of the individual cell types, the more complex a mapping is required. Therefore, integrative tools must be able to freely scale up or down the complexity of their mapping functions to successfully perform integration depending on the heterogeneity of cell type-specific response to stimulus. In the extreme case where some cell types are present in only a subset of conditions being integrated, this poses additional mapping challenges since there may not be a 1-1 correspondence between types across conditions. Second, current integrative tools can be separated into two exclusive sets: those that require all cells from all datasets to have known cell type labels (supervised) and those that do not make use of any cell type labels (unsupervised). Consequently, when only a subset of cells can be labeled with high accuracy, or if only one dataset is labeled (as is the case when reference annotated cell atlases are available [<xref ref-type="bibr" rid="CR23">23</xref>–<xref ref-type="bibr" rid="CR28">28</xref>]), this partial set of labels currently cannot be used in data integration. Third, measured transcriptomes even for homogeneous populations of cells occupy a continuum of cell states, for both technical [<xref ref-type="bibr" rid="CR29">29</xref>, <xref ref-type="bibr" rid="CR30">30</xref>] and biological [<xref ref-type="bibr" rid="CR31">31</xref>–<xref ref-type="bibr" rid="CR33">33</xref>] reasons. Thus, individual cells cannot be matched exactly across datasets. Therefore, downstream analysis of integrated datasets typically involves clustering cells across datasets to find matching cell types and estimating cell type-specific differences across datasets. The clustering step makes it difficult to find rare cell populations that differ between datasets.</p>
    <p id="Par4">Here, we present scAlign, a deep learning-based method for scRNA-seq alignment. scAlign performs single cell alignment of scRNA-seq data by learning a bidirectional mapping between cells sequenced within individual datasets, and a low-dimensional alignment space in which cells group by function and type, regardless of the dataset in which it was sequenced. This bidirectional map enables users to generate a representation of what the same cell looks like under each individual dataset and therefore simulate a matched experiment in which the exact same cell is sequenced simultaneously under different conditions. Compared to previous approaches, scAlign can scale in alignment power due to its neural network design, and it can optionally use partial, overlapping, or a complete set of cell type labels in one or more of the input datasets. We demonstrate that scAlign outperforms existing alignment methods including Seurat [<xref ref-type="bibr" rid="CR3">3</xref>, <xref ref-type="bibr" rid="CR34">34</xref>], scVI [<xref ref-type="bibr" rid="CR7">7</xref>], MNN [<xref ref-type="bibr" rid="CR2">2</xref>], scanorama [<xref ref-type="bibr" rid="CR8">8</xref>], scmap [<xref ref-type="bibr" rid="CR5">5</xref>], MINT [<xref ref-type="bibr" rid="CR1">1</xref>], and scMerge [<xref ref-type="bibr" rid="CR4">4</xref>], particularly when individual cell types exhibit strong dataset-specific signatures such as heterogeneous responses to stimulus. While misalignment of cell types unique to one dataset is an inherent challenge for any alignment technique, we show that scAlign produces minimal false positive matchings. Furthermore, we show that our bidirectional map enables identification of changes in rare cell types that cannot be identified from alignment and data analysis steps performed in isolation. We also demonstrate the utility of scAlign in identifying changes in expression associated with sexual commitment in malaria parasites and posit that scAlign may be used to perform alignment in domains other than single cell genomics as well.</p>
  </sec>
  <sec id="Sec2">
    <title>Results</title>
    <p id="Par5">The overall framework of scAlign is illustrated in Fig. <xref rid="Fig1" ref-type="fig">1</xref>. While this paper is written in the context of integrating multiple datasets representing cell populations exposed to different stimuli or control conditions, scAlign can be readily used for any data integration context discussed in the introduction. The premise of integration methods is that when similar cell populations are sequenced under different conditions, some (possibly large) separation can be observed between cells of the same functional type but sequenced in different conditions (Fig. <xref rid="Fig1" ref-type="fig">1</xref> (a)). The first component of scAlign is the construction of an alignment space using scRNA-seq data from all conditions, in which cells of the same functional type are indistinguishable, regardless of which condition they were sequenced in (Fig. <xref rid="Fig1" ref-type="fig">1</xref> (b)). This alignment space represents an unsupervised dimensionality reduction of scRNA-seq data from genome-wide expression measurements to a low-dimensional manifold, using a shared deep encoder neural network trained across all conditions. Unlike autoencoders, which share a similar architecture to scAlign but use a different objective function, our low-dimensional manifold is learned by training the neural network to simultaneously encourage overlap of cells in the state space from across conditions (thus performing alignment), yet also preserving the pairwise cell-cell similarity within each condition (and therefore minimizing distortion of gene expression). Optionally, scAlign can take as input a partial or full set of cell annotations in one or more conditions, which will encourage the alignment to cluster cells of the same type in alignment space.
<fig id="Fig1"><label>Fig. 1</label><caption><p>Schematic of unsupervised alignment and state variation mapping with scAlign. (a) The input to scAlign consists of cells sequenced across multiple scRNA-seq conditions. Expression can be represented as either gene-level expression or embedding coordinates from dimensionality reduction techniques such as PCA or CCA. (b) A deep encoding network learns a low-dimensional alignment space that simultaneously aligns cells from all conditions. (c) Paired decoders project cells from the alignment space back into the gene expression space of each condition and can be used to interpolate the expression profile of cells sequenced from any condition into any other condition. (d) For a single cell sequenced under any condition, we can calculate its interpolated expression profile in all conditions, then measure the predicted variance across all input conditions to calculate a state variation map for the same cell state under different conditions to identify cells whose expression profiles vary significantly across condition</p></caption><graphic xlink:href="13059_2019_1766_Fig1_HTML" id="MO1"/></fig></p>
    <p id="Par6">In the second component of scAlign (Fig. <xref rid="Fig1" ref-type="fig">1</xref> (c)), we train condition-specific deep decoder networks capable of projecting individual cells from the alignment space back to the gene expression space of each input condition, regardless of what condition the cell is originally sequenced in. We use these decoders to measure per-cell and per-gene variation of expression across conditions, which we term the cell state variation map. In the case of integrating two conditions, this cell state variation map estimates a paired difference in expression of the same cell across conditions (Fig. <xref rid="Fig1" ref-type="fig">1</xref> (d)). scAlign therefore seeks to re-create the ideal experiment in which the exact same cell is sequenced before and after a stimulus in a case-control study, for example.</p>
    <sec id="Sec3">
      <title>scAlign captures cell type-specific response to stimulus</title>
      <p id="Par7">We first benchmarked the alignment component of scAlign using data from four publicly available scRNA-seq studies for which the same cell populations were sequenced under different conditions and for which the cell type labels were obtained experimentally (Fig. <xref rid="Fig2" ref-type="fig">2</xref>, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S1). Our first benchmark is CellBench [<xref ref-type="bibr" rid="CR35">35</xref>], a dataset consisting of three human lung adenocarcinoma cell lines (HCC827, H1975, H2228) that were sequenced using three different protocols (CEL-Seq2, 10x Chromium, Drop-Seq Dolomite) as well as at varying relative concentrations of either RNA content or numbers of cells in a mixture. While the alignment of the homogeneous cell populations sequenced across protocols was trivial and did not require data integration methods (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S2), alignment of RNA mixtures across protocols was more challenging and more clearly illustrated the performance advantage of scAlign (Fig. <xref rid="Fig2" ref-type="fig">2</xref>a). We additionally benchmarked alignment methods using data generated by Kowalczyk et al. [<xref ref-type="bibr" rid="CR36">36</xref>] and Mann et al. [<xref ref-type="bibr" rid="CR37">37</xref>] on three hematopoietic cell types (LT-HSC, ST-HSC, MPP) collected from the C57BL/6 mouse strain at approximately 2 months (“young”) and 2 years (“old”) of age. Mann et al. additionally challenged the mice with an LPS or a control stimulus. Similar to our results with CellBench, scAlign outperforms other approaches on both of these benchmarks (Fig. <xref rid="Fig2" ref-type="fig">2</xref>b, c). The results of scAlign in these comparisons were robust to network depth, width, and input features (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S3 and Figure S4) along with choice of hyper parameters.
<fig id="Fig2"><label>Fig. 2</label><caption><p>scAlign outperforms existing alignment approaches on four benchmarks. <bold>a</bold> CellBench, a benchmark consisting of mixtures (mt) of RNA from three cancer cell lines sequenced using multiple protocols. Plots from left to right: (1) UMAP plot of embeddings after alignment with scAlign, where each point represents a cell, and cells are colored according to their mixture type (mt) as reported in Tian et al. (2) UMAP plot of embeddings after alignment with supervised scAlign (scAlign+). (3) Bar plot indicating the accuracy<sub>composite</sub> (see the “<xref rid="Sec10" ref-type="sec">Methods</xref>” section) of a classifier, measured as a weighted combination of cross-condition label prediction accuracy and alignment score. <bold>b</bold> Same as <bold>a</bold>, but with the Kowalczyk et al. benchmark consisting of hematopoietic cells sequenced from young and old mice. Cells are colored according to type (LT, ST, MPP, legend at bottom). <bold>c</bold> Same as <bold>a</bold>, but with the Mann et al. benchmark consisting of hematopoietic cells sequenced from young and old mice, challenged with LPS. <bold>d</bold> Same as <bold>a</bold>, but with the HeterogeneousBenchmark dataset consisting of hematopoietic cells responding to different stimuli</p></caption><graphic xlink:href="13059_2019_1766_Fig2_HTML" id="MO2"/></fig></p>
      <p id="Par8">To better understand why the relative performance of the other methods was inconsistent across benchmarks (Fig. <xref rid="Fig2" ref-type="fig">2</xref>a–c), we next characterized the difficulty of each benchmark for alignment. For each cell type in each benchmark, we identified cell type marker genes by computing the differentially expressed genes (DEGs) between cell types, individually for each condition. We observed considerable overlap in the cell type marker genes (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S5), suggesting these benchmarks may be less challenging to align and therefore more difficult to distinguish alignment methods from each other. We therefore constructed a novel benchmark termed HeterogeneousBenchmark by combining published scRNA-seq data on hematopoietic cells measured across different studies and stimuli. This benchmark yields smaller overlap in cell type marker genes (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S5), which makes it more challenging to align. On HeterogeneousBenchmark, we find that scAlign’s performance is robustly superior, while Seurat and Scanorama also outperform the remaining methods (Fig. <xref rid="Fig2" ref-type="fig">2</xref>d).</p>
      <p id="Par9">scAlign simultaneously aligns scRNA-seq from multiple conditions and performs a non-linear dimensionality reduction on the transcriptomes. This is advantageous because dimensionality reduction is a first step to a number of downstream tasks, such as clustering into putative cell types [<xref ref-type="bibr" rid="CR38">38</xref>] and trajectory inference [<xref ref-type="bibr" rid="CR39">39</xref>–<xref ref-type="bibr" rid="CR41">41</xref>]. Dimensionality reduction of cell types generally improves when more data is used to compute the embedding dimensions, and so we hypothesized that established cell types will cluster better in scAlign’s embedding space in part due to the fact we are defining a single embedding space using data from multiple conditions. We therefore compared the clustering of known cell types in the scAlign embedding space to an autoencoder neural network that uses the same architecture and number of parameters as scAlign, but is trained on each condition separately (see the “<xref rid="Sec10" ref-type="sec">Methods</xref>” section). In two of the three benchmarks we tested, we found that known cell types cluster more closely and are more distinct in scAlign embedding space compared to that of the corresponding autoencoder (Fig. <xref rid="Fig3" ref-type="fig">3</xref>, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S6), suggesting scAlign’s embedding space benefits from pooling cells from across all conditions. Furthermore, by pooling cells into a common embedding space, scAlign can identify new subpopulations within known cell type clusters (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S7).
<fig id="Fig3"><label>Fig. 3</label><caption><p>Joint analysis of cells from all conditions leads to more accurate clustering of cell types compared to independent analysis of individual conditions. <bold>a</bold> Scatterplot illustrating the quality of clustering of cell types within each condition from the Mann et al. benchmark. Each point represents one cell type in one condition, when the embedding is computed using either the original expression data (“expression”), the embedding dimensions of scAlign, or the embedding dimensions of an autoencoder with the same neural network architecture as scAlign. The <italic>y</italic>-axis represents classification accuracy, while the <italic>x</italic>-axis represents the silhouette coefficient. <bold>b</bold> Same as <bold>a</bold>, but for HeterogeneousBenchmark. <bold>c</bold> tSNE plots visualizing the embedding space of scAlign trained on both conditions and <bold>d</bold> an autoencoder trained on a single condition</p></caption><graphic xlink:href="13059_2019_1766_Fig3_HTML" id="MO3"/></fig></p>
      <p id="Par10">A unique feature of scAlign is that it can optionally use cell type labels for a subset of (or all) cells if available, but does not require any labels by default. In other words, scAlign can perform unsupervised, semi-supervised, or fully supervised alignment. One example of a use case would be when a labeled, highly-quality cell atlas is available, it can be used to label cells sequenced from a newer, smaller study. Figure <xref rid="Fig2" ref-type="fig">2</xref> a–d illustrate, for each of the four benchmarks, that scAlign performance improves when cell type labels are available at training time and exceeds the performance of other supervised methods such as MINT [<xref ref-type="bibr" rid="CR30">30</xref>], scMerge [<xref ref-type="bibr" rid="CR4">4</xref>], and scmap [<xref ref-type="bibr" rid="CR5">5</xref>]. Even when only a subset of cells from one condition have labels available for semi-supervised training, scAlign performance improves compared to a strictly unsupervised alignment, though still lower than a fully supervised scAlign+ (Fig. <xref rid="Fig4" ref-type="fig">4</xref>, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S8). When provided with labels, the cell-cell similarity matrix of the supervised scAlign method is qualitatively similar to the cell-cell similarity matrix of cells in the original gene expression space as well as the unsupervised scAlign alignment space, suggesting the inferred alignment space is robust to adding labels during alignment (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S9).
<fig id="Fig4"><label>Fig. 4</label><caption><p>Semi-supervised alignment mode of scAlign enables use of partial sets of cell type labels. UMAP visualization of the HeterogenousBenchmark after alignment with scAlign+ trained with <bold>a</bold> labels for all cells in both conditions, <bold>b</bold> after removal of labels for LT-HSC HSC in the stimulated condition, <bold>c</bold> after removal of labels for LT-HSCs and ST-HSCs in the stimulated condition, and <bold>d</bold> scAlign trained without cell labels</p></caption><graphic xlink:href="13059_2019_1766_Fig4_HTML" id="MO4"/></fig></p>
    </sec>
    <sec id="Sec4">
      <title>scAlign is robust to large differences in cell type representation across conditions</title>
      <p id="Par11">Besides cell type-specific responses to stimuli, we reasoned that the other factor that determines alignment difficulty is the difference in the representation (or proportion present) of each cell type across conditions. For example, cell types unique to one condition may pose challenges to alignment because there are no functionally matched cell types in the other conditions. We therefore explored the behavior of scAlign and other approaches when the relative proportion of cell types varies significantly between the conditions being aligned.</p>
      <p id="Par12">We performed a series of experiments on the Kowalczyk et al. benchmark where we measured alignment performance of all methods as we removed an increasing proportion of cells from each cell type from the old mouse condition (Fig. <xref rid="Fig5" ref-type="fig">5</xref>). While scAlign had superior performance across all experiments and was most robust to varying cell type proportions, surprisingly, we found that other methods were generally robust as well. Removing even 75% of the cells of a given type only led to a median drop of 11% in accuracy across the tested methods. When we repeated these experiments on the Mann et al. benchmark, we generally found a larger decrease in performance as we removed more cells from each type compared to the Kowalczyk et al. benchmark, though scAlign still outperformed all other methods (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S10).
<fig id="Fig5"><label>Fig. 5</label><caption><p>Alignment performance is robust to imbalance in cell type representation across conditions. <bold>a</bold> Accuracy of classifiers on the Kowalczyk et al. benchmark, when removing either LT-HSC, ST-HSC, or MPP cells from the old condition. scAlign outperforms all other methods and exhibits minimal degradation in performance as increasing numbers of cells are removed within each cell type. <bold>b</bold> Heatmap showing the pairwise similarity matrix for the young cells from Kowalczyk et al. when no cells have been removed. <bold>c</bold> Heatmap showing the pairwise similarity matrix for the young cells from Kowalczyk et al. after removing 25% of the old mouse cells from all cell types</p></caption><graphic xlink:href="13059_2019_1766_Fig5_HTML" id="MO5"/></fig></p>
      <p id="Par13">We next investigated the factors that underlie scAlign’s robustness to imbalanced cell type representation across conditions. scAlign optimizes an objective function that minimizes the difference between the pairwise cell-cell similarity matrix in gene expression space and the pairwise cell-cell similarity matrix implied in the alignment space when performing random walks of length two (Fig. <xref rid="Fig6" ref-type="fig">6</xref>a). The random walk starts with a cell sequenced in one condition, then moves to a cell sequenced in the other condition based on proximity in alignment space. The walk then returns to a different cell (excluding the starting cell) in the original condition, also based on proximity in alignment space. For every cell in each condition, we calculated the frequency that such random walks (initiated from the other condition) pass through it (Fig. <xref rid="Fig6" ref-type="fig">6</xref>b, c). We found that a select few representatives for each cell type are visited much more frequently than others and that even when those cells are removed from the condition, another cell is automatically selected as a replacement (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S11). This suggests that a given cell type in one condition only depends on a few cells of the same type in the other condition to align properly, and so scAlign alignment does not need every cell type to be represented in the same proportion across conditions.
<fig id="Fig6"><label>Fig. 6</label><caption><p>Random walks during scAlign training frequently visit a small number of hub cells. <bold>a</bold> Schematic of the cross condition round trip random walk prior to and after training of scAlign. <bold>b</bold> Visualization of the probability of a walk from each individual young cell (top) to each individual old cell (bottom) after training scAlign on the Kowalczyk et al. benchmark. Edge density represents the magnitude of the probability of a given walk. <bold>c</bold> Same as <bold>b</bold>, except the edges represent the probability of walking from individual old cells (top) to individual young cells (bottom) in the Kowalczyk et al. benchmark</p></caption><graphic xlink:href="13059_2019_1766_Fig6_HTML" id="MO6"/></fig></p>
      <p id="Par14">In the above experiments, we have aligned conditions in which the same set of cell types are present in all conditions. We next explored the behavior of scAlign and other approaches when there are cell types represented in only a subset of the conditions. We expect such scenarios to arise when only a subset of cell types respond to, or are targeted by, a stimulus or condition. For each of our benchmarks, we removed one cell type from one of the conditions (e.g., the LPS condition of the Mann benchmark or the old mouse condition of the Kowalczyk benchmark) and aligned the control and stimulated conditions to determine the extent to which the unique population maintained separation from other cell types after alignment. Figure <xref rid="Fig7" ref-type="fig">7</xref>a demonstrates that in eight out of nine cases, scAlign outperforms other alignment methods in terms of classification accuracy. Even in cases where the alignment accuracy was similar between methods, scAlign visually separates cell types in its alignment space more so than other approaches such as Scanorama and Seurat (Fig. <xref rid="Fig7" ref-type="fig">7</xref>b). For other approaches, the separation of different cell types within the same condition shrinks when one cell type is removed (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S12).
<fig id="Fig7"><label>Fig. 7</label><caption><p>scAlign is robust to distinct cell type sets between conditions. <bold>a</bold> Scatterplot matrix of performance of each method when both conditions have the same number of cell types (<italic>y</italic>-axis), compared to when one cell type has been removed (the LPS condition of the Mann benchmark, or the old mouse condition of the Kowalczyk benchmark) (<italic>x</italic>-axis). Each point is scaled in size by the silhouette coefficient for the clustering after alignment. <bold>b</bold> tSNE plots with cells colored by cell type and condition for the top performing methods</p></caption><graphic xlink:href="13059_2019_1766_Fig7_HTML" id="MO7"/></fig></p>
    </sec>
    <sec id="Sec5">
      <title>scAlign interpolates gene expression accurately</title>
      <p id="Par15">One of the more novel features of scAlign is the ability to map each cell from the alignment space back into the gene expression space of each of the original conditions, regardless of which condition the cell was originally sequenced in. This mapping is performed through interpolation: for each condition, we learn a mapping from the alignment space back to gene expression space using cells sequenced in that condition, then apply the map to all cells sequenced in all other conditions. This interpolation procedure enables measurement of variation in gene expression for the same cell state across multiple conditions and simulates the ideal experiment in which the exact same cell is sequenced before and after a stimulus is applied, and the variation in gene expression is subsequently measured.</p>
      <p id="Par16">To measure the accuracy of scAlign interpolation, for each of the three hematopoietic benchmarks, we trained decoder neural networks to map cells from the alignment space back into each of the case and control conditions. We then measured interpolation accuracy as the accuracy of a classifier trained on the original gene expression profiles of cells sequenced under one condition (e.g., stimulated), when used to classify cells that have been interpolated from the other condition (e.g., control). Comparing this interpolation accuracy to cross-validation accuracy of classifying cells in their original condition using the original measured gene expression profiles, we see that interpolation accuracy is similar to expression accuracy (Fig. <xref rid="Fig8" ref-type="fig">8</xref>a), suggesting that cells maintain their general type when mapped into another condition.
<fig id="Fig8"><label>Fig. 8</label><caption><p>Interpolation of gene expression patterns is accurate. <bold>a</bold> Scatterplot of classifiers trained on gene expression profiles of one condition, which are subsequently used to predict labels of either measured expression profiles from the same condition in a cross-validation framework (<italic>x</italic>-axis) or used to predict labels of cells sequenced from the other condition that were then interpolated into this condition (<italic>y</italic>-axis). Similarity in accuracy represented by points near the diagonal indicates that cell type identity encoded in the gene expression profile is maintained even after interpolation. <bold>b</bold> The pairwise cell-cell similarity matrix for all cells projected into the young condition, including both the old cells interpolated into the young condition (yellow) and the cells originally sequenced in the young condition (blue). Note that cells cluster largely by cell type regardless of the condition in which they were sequenced. <bold>c</bold> The pairwise cell-cell similarity matrix for all cells computed using the original expression measurements. <bold>d</bold> The pairwise cell-cell similarity matrix for all cells computed using the low-dimensional coordinates within the alignment space learned by scAlign. Similarity between <bold>c</bold> and <bold>d</bold> indicates the scAlign embedding maintains global similarity patterns between cells in the original gene expression space</p></caption><graphic xlink:href="13059_2019_1766_Fig8_HTML" id="MO8"/></fig></p>
      <p id="Par17">Figure <xref rid="Fig8" ref-type="fig">8</xref>b illustrates the cell-cell similarity matrix computed in gene expression space of hematopoietic cells collected in the Kowalczyk study, when including cells sequenced in the young mice, as well as cells that have been interpolated from the old mice into the young condition. We see that cells cluster largely by cell type (LT-HSC, ST-HSC, MPP) and not by their condition of origin. Furthermore, by computing a state variance map from the interpolation of all cells into both conditions, we identify differentially expressed genes that were not identified by traditional differential expression analysis (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S13). This demonstrates that the encoding and interpolation process maintains data fidelity, even though the encoder is trained to align data from multiple conditions and is not explicitly trained to minimize reconstruction error like typical autoencoders. Figure <xref rid="Fig8" ref-type="fig">8</xref>c and d further illustrate that the cell-cell similarity matrix in embedding space is faithful to the cell-cell similarity matrix in the original gene expression space.</p>
    </sec>
    <sec id="Sec6">
      <title>Interpolation identifies early gametocyte markers of the engineered ap2-g-dd strain of <italic>P. falciparum</italic></title>
      <p id="Par18">We next applied scAlign to identify genes associated with early steps of sexual differentiation in <italic>Plasmodium falciparum</italic>, the most widespread and virulent human malaria parasite. Briefly, the clinical symptoms of infection are the result of exponential growth of asexual parasites within red blood cells, while parasite transmission depends on the formation of the non-replicating male and female sexual stages necessary for infection of the parasite’s mosquito vector. During each round of asexual replication, a subpopulation of parasites will activate expression of the <italic>ap2-g</italic> gene, which encodes the transcriptional master regulator of sexual differentiation, to initiate sexual differentiation. While the gene <italic>ap2-g</italic> is a known master regulator of sexual commitment, and its expression is necessary for sexual commitment, the events which follow <italic>ap2-g</italic> activation and lead to full sexual commitment are unknown [<xref ref-type="bibr" rid="CR42">42</xref>]. Furthermore, <italic>ap2-g</italic> expression is restricted to a minor subset of parasites, making the identification of the precise stage of the life cycle when sexual commitment occurs a challenging task.</p>
      <p id="Par19">Figure <xref rid="Fig9" ref-type="fig">9</xref>a illustrates the alignment space of parasites which are either capable of <italic>ap2-g</italic> expression and will contain an <italic>ap2-g</italic>-expressing subpopulation in the initial stages of sexual differentiation (+Shld), or are <italic>ap2-g</italic> deficient and therefore all committed to continued asexual growth (−Shld). As was observed in the original paper [<xref ref-type="bibr" rid="CR42">42</xref>], the +/−Shld cells fall into clusters that can be ordered by time points in their life cycle (Fig. <xref rid="Fig9" ref-type="fig">9</xref>a). scAlign alignment maintains the gametocytes from the +Shld condition as a distinct population that is not aligned to any parasite population from the −Shld condition, whereas other tested methods are unable to isolate the gametocyte population (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S14).
<fig id="Fig9"><label>Fig. 9</label><caption><p>Alignment of <italic>P. falciparum</italic> cells sequenced from a conditional ap2-g knockdown line identifies cycle 2 gametocytes. <bold>a</bold> tSNE visualization of cells that cannot stably express <italic>ap2-g</italic> (−Shld) and <italic>ap2-g</italic> expression-capable cells (+Shld) after alignment by scAlign. Each cell is colored by its corresponding cluster identified in Poran et al., and clusters are numbered according to relative position in the parasite life cycle. <bold>b</bold> scAlign state variation map defined by projecting every cell from (a) into both the +/−Shld conditions, then taking the paired difference in interpolated expression profiles. Rows represent cells, ordered by cluster from early stage (top) to late stage and GC (bottom), and columns represent the 661 most varying genes. The state variation map reveals that cluster 13 is predicted to differ in expression the most between +/−Shld. The column annotations on top indicate which of the variable genes have been previously established as a target of <italic>ap2-g</italic> via ChIP-seq experiments [<xref ref-type="bibr" rid="CR43">43</xref>] which genes have been reported as playing a role in cell cycle 2 gametocyte maturation [<xref ref-type="bibr" rid="CR44">44</xref>] and which gene represents <italic>ap2-g</italic>. <bold>c</bold> The same state variation map of <bold>c</bold>, but zoomed in on Cluster 13 and the genes predicted to be most differentially expressed between +/−Shld. <bold>d</bold> Average per-cluster expression levels of PF3D7_0220000 reported in <bold>c</bold>, for both the +/−Shld conditions. PF3D7_0220000 is predicted to be upregulated in −Shld relative to +Shld, which is reflected in the per-cluster expression levels. <bold>e</bold> Same as <bold>d</bold>, but for PF3D7_1102500, a gene predicted to be upregulated in +Shld relative to −Shld</p></caption><graphic xlink:href="13059_2019_1766_Fig9_HTML" id="MO9"/></fig></p>
      <p id="Par20">To further investigate how scAlign is able to maintain the gametocytes as a distinct population after alignment, we looked at the random walks performed by the gametocyte cells to see which cells from the −Shld condition they walked to, and found that scAlign maps a very small number of cells from similar surrounding clusters into the peripheral region of alignment space near the gametocytes. These −Shld cells in the periphery of the gametocyte cluster allow the gametocytes to use those cells as “anchors” in their random walk and maintain their overall separation from the −Shld cells. To confirm this hypothesis, we removed the contaminating −Shld parasites used as anchors by the +Shld gametocytes and re-aligned the +Shld and reduced set of −Shld cells. After realignment, we found that scAlign “sacrificed” parasites from similar surrounding clusters to act as new anchors and preserve the distinct +Shld gametocytes as a distinct population (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S15).</p>
      <p id="Par21">Because the +Shld and −Shld cells form a set of clusters that we could order from early stage to late stage then gametocytes (+Shld), we hypothesized that the state variation map computed by scAlign could reveal where in the life cycle sexual-committing cells (a subset of +Shld cells) distinguished themselves in variation from asexual-committing cells (all −Shld cells). Using the interpolation component of scAlign, we projected each cell sequenced from each condition in the alignment space into the expression space of both of the +/−Shld conditions. By taking the difference in interpolated expression for each cell between the +Shld and −Shld transcriptomes, we computed a state variation map illustrating the predicted difference between the two conditions along the entire life cycle (Fig. <xref rid="Fig9" ref-type="fig">9</xref>b). From the state variation map, we observed few overall predicted differences in gene expression between the two conditions across most stages of the life cycle, except within a cluster of cells containing the gametocytes specific to the +Shld condition (Fig. <xref rid="Fig9" ref-type="fig">9</xref>b, cluster 13). In other words, gametocytes from cluster 13 exhibited the largest predicted differential gene expression between the +Shld gametocytes and neighboring −Shld non-gametocyte parasites. We verified that scAlign interpolation uses cells from neighboring clusters to predict −Shld expression within cluster 13 (Fig. <xref rid="Fig9" ref-type="fig">9</xref>d, e, see the “<xref rid="Sec10" ref-type="sec">Methods</xref>” section).</p>
      <p id="Par22">Over all 661 highly variable genes we analyzed, we found the predicted differentially expressed genes in cluster 13 are enriched in genes previously established to play a role in gametocyte maturation (Fig. <xref rid="Fig9" ref-type="fig">9</xref>b) (<italic>p</italic> = 1.2 × 10<sup>−6</sup>, Wilcox rank sum test), including <italic>pfg27</italic> (PF3D7_1302100) and <italic>etramp4</italic> (PF3D7_0423700) [<xref ref-type="bibr" rid="CR44">44</xref>]. Furthermore, for the genes we predict to be upregulated in cluster 13 of the +Shld condition, we observed an enrichment of <italic>ap2-g</italic> targets identified via ChIP-Seq [<xref ref-type="bibr" rid="CR43">43</xref>] (<italic>p</italic> = 6.8 × 10<sup>−7</sup>, Wilcox rank sum test). This upregulation of <italic>ap2-g</italic> targets is consistent with the fact that cells that have entered the gametocyte stage must have turned on <italic>ap2-g</italic> expression, but that −Shld cells cannot express <italic>ap2-g</italic>. Our state variation map identifies an additional eight genes not reported by Bancells and colleagues as playing a role in gametocyte maturation, but that are predicted to differ between +/−Shld (Fig. <xref rid="Fig9" ref-type="fig">9</xref>c). Taken in total, these results suggest the other genes we have predicted as differing between +/−Shld may also play a role in gametocyte conversion (Fig. <xref rid="Fig9" ref-type="fig">9</xref>b, c).</p>
    </sec>
    <sec id="Sec7">
      <title>scAlign identifies highly variable genes in pancreatic islet cells sequenced using multiple protocols</title>
      <p id="Par23">We next tested scAlign’s ability to infer an alignment space across more than two conditions by aligning pancreatic islet cells [<xref ref-type="bibr" rid="CR15">15</xref>] derived from 8 donors and captured using four different protocols (CEL-Seq, CEL-Seq2, Smart-Seq2, and C1). The un-aligned pancreatic islet cells separate by protocol and not cell type, indicating strong protocol-specific effects which are removed after scAlign alignment (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S16 and Figure S17a). scAlign outperforms Seurat and scVI in terms of composite alignment accuracy on this dataset (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S17b-c). Interestingly, scAlign preserves the stellate, ductal, and gamma cell types as separate clusters of cells, even though these three groups are represented in only a subset of the four protocols.</p>
      <p id="Par24">Having aligned the pancreatic islet cells into an alignment space, we next computed scAlign’s state variance map to identify cell types and genes exhibiting high expression variation across three protocols to provide insight into how the choice of protocol affects gene expression measurement (Fig. <xref rid="Fig10" ref-type="fig">10</xref>a–d). Here, we excluded C1 because of the overall high gene expression specific to this protocol. We identified multiple subpopulations of cells within the alpha and beta cell types that are remarkably variable across protocols (Fig. <xref rid="Fig10" ref-type="fig">10</xref>e). We further show that our state variance map identifies subpopulations of alpha cells that are not consistent with the subclustering of alpha cells based on the embeddings (alignment space), illustrating that the state variance map finds unique patterns of expression variation across conditions not found by classic clustering approaches (Fig. <xref rid="Fig10" ref-type="fig">10</xref>f). Notably, the most highly variable genes with respect to protocol were specific to the activated stellate cells, and we confirmed these genes to be enriched in gene functions related to stellate function (Additional file <xref rid="MOESM2" ref-type="media">2</xref>).
<fig id="Fig10"><label>Fig. 10</label><caption><p>Alignment of pancreatic islet cells captured using three different protocols identifies cell type-specific variation across protocols. <bold>a–d</bold> UMAP visualization of pancreatic islet cells sequenced on CEL-Seq, CEL-Seq2, and Smart-Seq2 after alignment by scAlign, colored by protocol, cell type, clustering on the alignment space, or scAlign’s state variance map. <bold>e</bold> Scatterplot indicating the overlap of clusters defined using the state variance map (<italic>y</italic>-axis) and based on the cell type labels as reported in Stuart et al. <bold>f</bold> Comparison of clusters identified using the embeddings, versus using the state variance map. Shown are two clusters defined in the embedding space, termed alpha-1 and alpha-2 because of their overlap with the alpha cell type. Gray points in the alpha-1 plot indicate cluster 2 cells, and gray points in the alpha-2 plot indicate cluster 1 cells. Colored points represent the three clusters identified in the state variance map. scAlign’s variance map clusters (1, 2, and 3) are each found in both alpha-1 and alpha-2, indicating poor agreement. <bold>g</bold> Heatmap of the state variance map computed across the three capture protocols (CeL-Seq, CEL-Seq2, and Smart-Seq2) where red indicates high variance of expression predicted for a given gene and cell across protocols</p></caption><graphic xlink:href="13059_2019_1766_Fig10_HTML" id="MO10"/></fig></p>
    </sec>
    <sec id="Sec8">
      <title>Robust cell type marker genes drive alignments</title>
      <p id="Par25">To gain insight into the general principles and genes used by scAlign to perform alignment, we performed a series of in silico expression perturbation experiments. scAlign uses the same feed-forward network to reduce the dimensionality of cells from all input conditions. We therefore hypothesized that scAlign is implicitly identifying cell type marker genes that are invariant (robust) across conditions and using these marker genes to perform dimensionality reduction as they will naturally cause similar cell types across conditions to map to the same regions of alignment space. We tested this hypothesis by first identifying a set of marker genes for each cell type that were robust across conditions within a given dataset (Additional file <xref rid="MOESM3" ref-type="media">3</xref>) (see the “<xref rid="Sec10" ref-type="sec">Methods</xref>” section). We then systematically perturbed the expression of all common marker genes across all cells and measured the downstream effect of the perturbation on the embeddings of the cells in alignment space. Intuitively, perturbing the expression levels of genes that more strongly contribute to the alignment will yield larger deviations in the embeddings of the cells. As a control, we performed the same perturbation experiments on random control sets of genes matched for size and expression level (see the “<xref rid="Sec10" ref-type="sec">Methods</xref>” section). Perturbing the common marker genes yielded significantly larger deviations in the cell embeddings than the control sets (<italic>P</italic> &lt; 10<sup>−4</sup>, permutation test), with the embeddings moving an average of 5.2-fold more than the control sets (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S18).</p>
      <p id="Par26">We next sought to evaluate the extent to which scAlign’s unique random walk-based objective function contributes to its alignment accuracy. Traditional neural networks that focus on unsupervised dimensionality reduction such as autoencoders use an objective function that explicitly learn embeddings that minimize the reconstruction loss of each cell. In contrast, the scAlign objective function simultaneously encourages embeddings to maintain cell-cell similarity within condition, as well as match cells in the alignment space across conditions. We therefore evaluated the utility of scAlign’s objective function by substituting scAlign’s loss function for a classic reconstruction loss-based autoencoder loss function. This autoencoder shares the same number of layers and nodes per layer as scAlign and furthermore uses a shared encoder across all conditions similar to scAlign, but unique decoders for each condition (see the “<xref rid="Sec10" ref-type="sec">Methods</xref>” section). Both the autoencoder and scAlign therefore have the same number of parameters and therefore equal model capacity, and only differ by their respective objective functions. When comparing this autoencoder to scAlign on each of our four benchmarks, we found that the autoencoder was able to achieve similar accuracy on benchmarks with minimal cell type-specific condition effects, such as Cellbench and Kowalczyk et al. (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S19a-b). However, on more challenging benchmarks such as Mann et al. and our HeterogeneousBenchmark, the autoencoder performed worse than scAlign (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S19c-d). Furthermore, the autoencoder did not maintain the cell-cell similarity matrix in embedding space as well as scAlign (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S19 and Figure S20), suggesting the low-dimensional embeddings learned by the autoencoder may not as faithfully recapitulate the gene expression inputs.</p>
    </sec>
  </sec>
  <sec id="Sec9">
    <title>Discussion</title>
    <p id="Par27">We have shown that scAlign outperforms other integration approaches, particularly when there are strong cell type-specific differences across conditions, or when there is an imbalance in cell type representation across conditions. Compared to other approaches, scAlign will be particularly useful in the context where only some cell type labels are available in one or more conditions. We envision two scenarios where this may occur. First, with the increasing number of cell atlases [<xref ref-type="bibr" rid="CR23">23</xref>–<xref ref-type="bibr" rid="CR28">28</xref>] that are accurately labeled by domain experts and are now publicly available, scAlign can take advantage of the accurate labeling of these atlases to annotate new datasets that lack labels. Second, marker genes may be available for only a subset of cell types such as specific hematopoietic cells, in which case only a subset of cells may be reliably labeled. Even when marker genes are available, markers may not be unique to individual cell types and technical factors such as dropout may prevent truly expressed markers from being detected in the RNA. Here, scAlign can be used in conjunction with only the most confident labeled cells, or can even be used when there is overlapping labels (due to marker uncertainty).</p>
    <p id="Par28">Another advantage of scAlign over other integration methods is the improved ability to detect rare differential expression events between conditions. For typical alignment methods, once the effect of condition is removed via alignment, cells must still be clustered into putative cell types in order to identify which cells match across condition, and then perform an unpaired differential expression test within each cluster to identify condition-specific differences. The need to cluster cells means the detection of rare cell types can be highly sensitive to the choice of clustering algorithm or parameters. In contrast, through interpolation, scAlign predicts how each individual cell within the alignment space differs in expression between any of the input conditions, effectively performing a paired (or matched) differential expression calculation per-cell without the need to cluster. The result is scAlign can detect the presence of rare cell populations that differ in expression across conditions (Fig. <xref rid="Fig9" ref-type="fig">9</xref>).</p>
    <p id="Par29">scAlign implements two approaches to aligning more than two conditions simultaneously. In the reference-based alignment, a single reference condition is established and all other conditions are being aligned against the reference (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S21). This is expected to work well when all cell types are represented in all conditions, and has the benefit of speed. Alternatively, the all-pairs alignment mode performs an all-pairwise set of alignments simultaneously, which will be more robust to the presence of cell types only represented in a subset of the conditions.</p>
    <p id="Par30">The general design of scAlign’s neural network architecture and loss function makes it agnostic to the input RNA-seq data representation. Thus, the input data can either be gene-level counts, transformations of those gene-level counts, or the result of a preliminary step of dimensionality reduction such as principal component scores or canonical correlation vectors. In our study, we first transformed data into a relatively large number of principal component scores before input into scAlign, as this yielded much faster run times with little to no performance degradation. The improvement in computation time due to PCA preprocessing of the input data allowed scAlign to both converge more quickly and become feasible on a CPU-based system, therefore making scAlign a broadly applicable deep learning method. More generally, the design of scAlign’s neural network architecture and loss functions are general and not specific to scRNA-seq data. We therefore expect that scAlign should be applicable to any problem in which the study design consists of comparing two or more groups of unmatched samples, and where we expect there to be subpopulations of individuals within each group.</p>
    <p id="Par31">Here, we have primarily compared scAlign against unsupervised alignment methods. In our supervised alignment results, scAlign compared favorably against the supervised methods MINT [<xref ref-type="bibr" rid="CR1">1</xref>] and scmap [<xref ref-type="bibr" rid="CR5">5</xref>] when assuming all cells are labeled. In the context of alignment, however, we reasoned that if a complete set of labels are available for all cells and conditions, then addressing the task of alignment is less useful, because cells of the same type across conditions can be directly compared via per-cell type differential expression analysis without alignment. Alternatively, in those contexts, each matching pair of cell types across conditions can be independently aligned using the unsupervised scAlign (or other unsupervised methods) to identify matching subpopulations of cells.</p>
    <p id="Par32">The tasks of transcriptional alignment and batch correction of scRNA-seq data are intimately related, as one can view the biological condition of a cell as a batch whose effect should be removed before integrated data analysis. Compared to batch correction methods, scAlign leverages the flexibility of neural networks to perform alignment where cell states might exhibit heterogeneous responses to stimuli, yet through interpolation provides the interpretability that canonical batch correction methods enjoy.</p>
    <p id="Par33">Like all other supervised and unsupervised alignment methods, scAlign makes an underlying assumption that the two or more conditions used as input make sense biologically to align. That is, alignment methods assume that there are at least some common cell types between conditions that share some functional origin or similarity, that should be matched across conditions, even if they differ in state (e.g., expression) due to condition or stimulus. To the best of our knowledge, there is no procedure or strategy for identifying datasets that should not be aligned due to lack of matching cell types. As a result, any alignment method when applied to datasets which contain unrelated or dissimilar cell types can potentially lead to false positive matchings. This limitation is not specific to alignment methods; scRNA-seq analysis tools designed for other purposes, such as trajectory inference, assume that a trajectory exists in the input data in the first place, and will return a trajectory regardless of whether it makes sense to do so. scRNA-seq tools in general are useful for generating hypotheses (in the case of alignment, hypotheses about which cell types match across conditions, and how they differ), but need to be used cautiously by downstream users.</p>
    <p id="Par34">A related concern is the performance of alignment methods when there exist condition-specific cell types that have no matching cell type in another condition. In our experiments, we show that scAlign outperforms other alignment methods in this scenario by choosing a small number of cells from a matching cell type and placing those small numbers of cells in the same region of alignment space as the condition-specific cell type; in other words, scAlign purposefully misaligns a small number of cells. scAlign tends to sacrifice a small number of cells because its objective function minimizes the distortion of the cell-cell pairwise similarity matrix within each input condition, and so sacrificing many cells would lead to a large distortion of the pairwise similarity matrix.</p>
    <p id="Par35">As a neural network-based method, scAlign usage requires specification of the network architecture before training, defined by the number of layers and number of nodes per layer. In our results, we have shown scAlign is largely robust to the size of the architecture, in part because in addition to the ridge penalty we apply to the weights of the network, our objective function minimizes the difference between the similarity matrix in the original expression and alignment spaces, which also acts as a form of data-driven regularization.</p>
  </sec>
  <sec id="Sec10">
    <title>Methods</title>
    <sec id="Sec11">
      <title>Methods overview</title>
      <p id="Par36">The scAlign method consists of two steps: (1) alignment, which learns a mapping from gene expression space of individual conditions into a common alignment space, and (2) interpolation, which learns a mapping from the common alignment space back to the gene expression space of the original conditions.</p>
    </sec>
    <sec id="Sec12">
      <title>Pairwise scRNA-seq alignment with scAlign</title>
      <p id="Par37">We define the alignment task as identifying a low-dimensional embedding space (termed the alignment space) in which functionally similar cells map to the same coordinates. Viewed from the lens of perturbation studies, if sequencing a cell immediately before and after stimulus were possible, alignment would bring cells post-stimulus into the same region of alignment space as the cell before stimulus, therefore removing the effect of the stimulus.</p>
      <p id="Par38">scAlign encodes the alignment space by extending the recent approach of learning by association for neural networks [<xref ref-type="bibr" rid="CR45">45</xref>, <xref ref-type="bibr" rid="CR46">46</xref>] into a unified framework for both unsupervised and supervised applications. For notational simplicity, we will assume we are aligning scRNA-seq data from a pair of conditions, though the framework extends to multiple conditions (see below). Let <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{x}}_i^s $$\end{document}</tex-math><mml:math id="M2" display="inline"><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>s</mml:mi></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq1.gif"/></alternatives></inline-formula> and <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{x}}_j^t $$\end{document}</tex-math><mml:math id="M4" display="inline"><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>j</mml:mi><mml:mi>t</mml:mi></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq2.gif"/></alternatives></inline-formula> be vectors of length <italic>G</italic> that represent the gene expression profiles of cells <italic>i</italic> and <italic>j</italic> in conditions <italic>s</italic> and <italic>t</italic>, respectively. Similarly, let <inline-formula id="IEq3"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_i^s $$\end{document}</tex-math><mml:math id="M6" display="inline"><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>s</mml:mi></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq3.gif"/></alternatives></inline-formula> and <inline-formula id="IEq4"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_j^t $$\end{document}</tex-math><mml:math id="M8" display="inline"><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>j</mml:mi><mml:mi>t</mml:mi></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq4.gif"/></alternatives></inline-formula> be vectors of length <italic>K</italic> that represent that alignment space embedding of cells <italic>i</italic> and <italic>j</italic> in conditions <italic>s</italic> and <italic>t</italic>, respectively, where the embeddings represent the linear activations of the final output layer of an encoder neural network.</p>
      <p id="Par39">scAlign trains an encoder neural network (parameterized by weights <bold><italic>W</italic></bold>) that defines the alignment space by optimizing the network weights used to calculate <inline-formula id="IEq5"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_i^s $$\end{document}</tex-math><mml:math id="M10" display="inline"><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>s</mml:mi></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq5.gif"/></alternatives></inline-formula> and <inline-formula id="IEq6"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_j^t $$\end{document}</tex-math><mml:math id="M12" display="inline"><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>j</mml:mi><mml:mi>t</mml:mi></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq6.gif"/></alternatives></inline-formula> to minimize the following objective function:</p>
      <p id="Par40">
        <disp-formula id="Equa">
          <alternatives>
            <tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ f=\left[\frac{1}{\mid S\mid}\sum \limits_i\mathrm{cross}-\mathrm{entropy}\left({\overrightarrow{P}}_{i,\bullet}^s,{\overrightarrow{Q}}_{i,\bullet}^s\right)\right]+\left[\frac{1}{\mid T\mid}\sum \limits_j\mathrm{cross}-\mathrm{entropy}\left({\overrightarrow{P}}_{j,\bullet}^t,{\overrightarrow{Q}}_{j,\bullet}^t\right)\right]+\lambda {\left\Vert \boldsymbol{W}\right\Vert}_F^2 $$\end{document}</tex-math>
            <mml:math id="M14" display="block">
              <mml:mi>f</mml:mi>
              <mml:mo>=</mml:mo>
              <mml:mfenced close="]" open="[">
                <mml:mrow>
                  <mml:mfrac>
                    <mml:mn>1</mml:mn>
                    <mml:mrow>
                      <mml:mo>∣</mml:mo>
                      <mml:mi>S</mml:mi>
                      <mml:mo>∣</mml:mo>
                    </mml:mrow>
                  </mml:mfrac>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:mi>i</mml:mi>
                  </mml:munder>
                  <mml:mtext>cross</mml:mtext>
                  <mml:mo>−</mml:mo>
                  <mml:mtext>entropy</mml:mtext>
                  <mml:mfenced close=")" open="(" separators=",">
                    <mml:msubsup>
                      <mml:mover accent="true">
                        <mml:mi>P</mml:mi>
                        <mml:mo stretchy="true">→</mml:mo>
                      </mml:mover>
                      <mml:mrow>
                        <mml:mi>i</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mo>∙</mml:mo>
                      </mml:mrow>
                      <mml:mi>s</mml:mi>
                    </mml:msubsup>
                    <mml:msubsup>
                      <mml:mover accent="true">
                        <mml:mi>Q</mml:mi>
                        <mml:mo stretchy="true">→</mml:mo>
                      </mml:mover>
                      <mml:mrow>
                        <mml:mi>i</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mo>∙</mml:mo>
                      </mml:mrow>
                      <mml:mi>s</mml:mi>
                    </mml:msubsup>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfenced>
              <mml:mo>+</mml:mo>
              <mml:mfenced close="]" open="[">
                <mml:mrow>
                  <mml:mfrac>
                    <mml:mn>1</mml:mn>
                    <mml:mrow>
                      <mml:mo>∣</mml:mo>
                      <mml:mi>T</mml:mi>
                      <mml:mo>∣</mml:mo>
                    </mml:mrow>
                  </mml:mfrac>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:mi>j</mml:mi>
                  </mml:munder>
                  <mml:mtext>cross</mml:mtext>
                  <mml:mo>−</mml:mo>
                  <mml:mtext>entropy</mml:mtext>
                  <mml:mfenced close=")" open="(" separators=",">
                    <mml:msubsup>
                      <mml:mover accent="true">
                        <mml:mi>P</mml:mi>
                        <mml:mo stretchy="true">→</mml:mo>
                      </mml:mover>
                      <mml:mrow>
                        <mml:mi>j</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mo>∙</mml:mo>
                      </mml:mrow>
                      <mml:mi>t</mml:mi>
                    </mml:msubsup>
                    <mml:msubsup>
                      <mml:mover accent="true">
                        <mml:mi>Q</mml:mi>
                        <mml:mo stretchy="true">→</mml:mo>
                      </mml:mover>
                      <mml:mrow>
                        <mml:mi>j</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mo>∙</mml:mo>
                      </mml:mrow>
                      <mml:mi>t</mml:mi>
                    </mml:msubsup>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfenced>
              <mml:mo>+</mml:mo>
              <mml:mi>λ</mml:mi>
              <mml:msubsup>
                <mml:mfenced close="‖" open="‖">
                  <mml:mi mathvariant="bold-italic">W</mml:mi>
                </mml:mfenced>
                <mml:mi>F</mml:mi>
                <mml:mn>2</mml:mn>
              </mml:msubsup>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equa.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
      </p>
      <p id="Par41">where
<disp-formula id="Equb"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\boldsymbol{P}}^s={\boldsymbol{P}}^{s\to t}{\boldsymbol{P}}^{t\to s} $$\end{document}</tex-math><mml:math id="M16" display="block"><mml:msup><mml:mi mathvariant="bold-italic">P</mml:mi><mml:mi>s</mml:mi></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mi mathvariant="bold-italic">P</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>→</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msup><mml:msup><mml:mi mathvariant="bold-italic">P</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>→</mml:mo><mml:mi>s</mml:mi></mml:mrow></mml:msup></mml:math><graphic xlink:href="13059_2019_1766_Article_Equb.gif" position="anchor"/></alternatives></disp-formula>
<disp-formula id="Equc"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\boldsymbol{P}}^t={\boldsymbol{P}}^{t\to s}{\boldsymbol{P}}^{s\to t} $$\end{document}</tex-math><mml:math id="M18" display="block"><mml:msup><mml:mi mathvariant="bold-italic">P</mml:mi><mml:mi>t</mml:mi></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mi mathvariant="bold-italic">P</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>→</mml:mo><mml:mi>s</mml:mi></mml:mrow></mml:msup><mml:msup><mml:mi mathvariant="bold-italic">P</mml:mi><mml:mrow><mml:mi>s</mml:mi><mml:mo>→</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msup></mml:math><graphic xlink:href="13059_2019_1766_Article_Equc.gif" position="anchor"/></alternatives></disp-formula>
<disp-formula id="Equd"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {Q}_{i,k}^s=\frac{\exp \left(-0.5{\left\Vert {\overrightarrow{x}}_i^s-{\overrightarrow{x}}_k^s\right\Vert}^2/{\sigma}_i^2\right)}{\sum \limits_{k^{\prime}\ne i}\exp \left(-0.5{\left\Vert {\overrightarrow{x}}_i^s-{\overrightarrow{x}}_{k\prime}^s\right\Vert}^2/{\sigma}_i^2\right)} $$\end{document}</tex-math><mml:math id="M20" display="block"><mml:msubsup><mml:mi>Q</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msubsup><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo>exp</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mo>−</mml:mo><mml:mn>0.5</mml:mn><mml:msup><mml:mfenced close="‖" open="‖"><mml:mrow><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>s</mml:mi></mml:msubsup><mml:mo>−</mml:mo><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>k</mml:mi><mml:mi>s</mml:mi></mml:msubsup></mml:mrow></mml:mfenced><mml:mn>2</mml:mn></mml:msup><mml:mo>/</mml:mo><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>′</mml:mo><mml:mo>≠</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:munder><mml:mo>exp</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mo>−</mml:mo><mml:mn>0.5</mml:mn><mml:msup><mml:mfenced close="‖" open="‖"><mml:mrow><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>s</mml:mi></mml:msubsup><mml:mo>−</mml:mo><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mrow><mml:mi>k</mml:mi><mml:mo>′</mml:mo></mml:mrow><mml:mi>s</mml:mi></mml:msubsup></mml:mrow></mml:mfenced><mml:mn>2</mml:mn></mml:msup><mml:mo>/</mml:mo><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="13059_2019_1766_Article_Equd.gif" position="anchor"/></alternatives></disp-formula>
<disp-formula id="Eque"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {Q}_{j,k}^t=\frac{\exp \left(-0.5{\left\Vert {\overrightarrow{x}}_j^t-{\overrightarrow{x}}_k^t\right\Vert}^2/{\sigma}_j^2\right)}{\sum \limits_{k^{\prime}\ne j}\exp \left(-0.5{\left\Vert {\overrightarrow{x}}_j^t-{\overrightarrow{x}}_{k\prime}^t\right\Vert}^2/{\sigma}_j^2\right)} $$\end{document}</tex-math><mml:math id="M22" display="block"><mml:msubsup><mml:mi>Q</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mi>t</mml:mi></mml:msubsup><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo>exp</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mo>−</mml:mo><mml:mn>0.5</mml:mn><mml:msup><mml:mfenced close="‖" open="‖"><mml:mrow><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>j</mml:mi><mml:mi>t</mml:mi></mml:msubsup><mml:mo>−</mml:mo><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>k</mml:mi><mml:mi>t</mml:mi></mml:msubsup></mml:mrow></mml:mfenced><mml:mn>2</mml:mn></mml:msup><mml:mo>/</mml:mo><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>j</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>′</mml:mo><mml:mo>≠</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:munder><mml:mo>exp</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mo>−</mml:mo><mml:mn>0.5</mml:mn><mml:msup><mml:mfenced close="‖" open="‖"><mml:mrow><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>j</mml:mi><mml:mi>t</mml:mi></mml:msubsup><mml:mo>−</mml:mo><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mrow><mml:mi>k</mml:mi><mml:mo>′</mml:mo></mml:mrow><mml:mi>t</mml:mi></mml:msubsup></mml:mrow></mml:mfenced><mml:mn>2</mml:mn></mml:msup><mml:mo>/</mml:mo><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>j</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="13059_2019_1766_Article_Eque.gif" position="anchor"/></alternatives></disp-formula>
<disp-formula id="Equf"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {P}_{i,j}^{s\to t}=\frac{\exp \left({{\overrightarrow{e}}_i^s}^T{\overrightarrow{e}}_j^t\right)}{\sum \limits_{j^{\prime }}\exp \left({{\overrightarrow{e}}_i^s}^T{\overrightarrow{e}}_{j\prime}^t\right)} $$\end{document}</tex-math><mml:math id="M24" display="block"><mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mo>→</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo>exp</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>s</mml:mi></mml:msubsup><mml:mi>T</mml:mi></mml:msup><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>j</mml:mi><mml:mi>t</mml:mi></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>′</mml:mo></mml:mrow></mml:munder><mml:mo>exp</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>s</mml:mi></mml:msubsup><mml:mi>T</mml:mi></mml:msup><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mrow><mml:mi>j</mml:mi><mml:mo>′</mml:mo></mml:mrow><mml:mi>t</mml:mi></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="13059_2019_1766_Article_Equf.gif" position="anchor"/></alternatives></disp-formula>
<disp-formula id="Equg"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {P}_{j,i}^{t\to s}=\frac{\exp \left({{\overrightarrow{e}}_i^t}^T{\overrightarrow{e}}_j^s\right)}{\sum \limits_{i^{\prime }}\exp \left({{\overrightarrow{e}}_{i^{\prime}}^t}^T{\overrightarrow{e}}_j^s\right)} $$\end{document}</tex-math><mml:math id="M26" display="block"><mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mi>j</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi><mml:mo>→</mml:mo><mml:mi>s</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo>exp</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>t</mml:mi></mml:msubsup><mml:mi>T</mml:mi></mml:msup><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>j</mml:mi><mml:mi>s</mml:mi></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:msup><mml:mi>i</mml:mi><mml:mo>′</mml:mo></mml:msup></mml:munder><mml:mo>exp</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:msup><mml:mi>i</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mi>t</mml:mi></mml:msubsup><mml:mi>T</mml:mi></mml:msup><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>j</mml:mi><mml:mi>s</mml:mi></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="13059_2019_1766_Article_Equg.gif" position="anchor"/></alternatives></disp-formula>
<disp-formula id="Equh"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_i^s=\mathrm{encoder}\left({\overrightarrow{x}}_i^s,\boldsymbol{W}\right) $$\end{document}</tex-math><mml:math id="M28" display="block"><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>s</mml:mi></mml:msubsup><mml:mo>=</mml:mo><mml:mtext>encoder</mml:mtext><mml:mfenced close=")" open="(" separators=","><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>s</mml:mi></mml:msubsup><mml:mi mathvariant="bold-italic">W</mml:mi></mml:mfenced></mml:math><graphic xlink:href="13059_2019_1766_Article_Equh.gif" position="anchor"/></alternatives></disp-formula>
<disp-formula id="Equi"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_j^t=\mathrm{encoder}\left({\overrightarrow{x}}_j^t,\boldsymbol{W}\right) $$\end{document}</tex-math><mml:math id="M30" display="block"><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>j</mml:mi><mml:mi>t</mml:mi></mml:msubsup><mml:mo>=</mml:mo><mml:mtext>encoder</mml:mtext><mml:mfenced close=")" open="(" separators=","><mml:msubsup><mml:mover accent="true"><mml:mi>x</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>j</mml:mi><mml:mi>t</mml:mi></mml:msubsup><mml:mi mathvariant="bold-italic">W</mml:mi></mml:mfenced></mml:math><graphic xlink:href="13059_2019_1766_Article_Equi.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par42">The central idea of the alignment procedure of scAlign is that it optimizes the embeddings of cells (<inline-formula id="IEq7"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_i^s $$\end{document}</tex-math><mml:math id="M32" display="inline"><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>s</mml:mi></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq7.gif"/></alternatives></inline-formula> and <inline-formula id="IEq8"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_j^t $$\end{document}</tex-math><mml:math id="M34" display="inline"><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>j</mml:mi><mml:mi>t</mml:mi></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq8.gif"/></alternatives></inline-formula>) such that the scaled, pairwise cell-cell similarity matrix (or formally, a transition matrix) computed between cells within each condition in gene expression space (<bold><italic>Q</italic></bold><sup><bold><italic>s</italic></bold></sup> and <bold><italic>Q</italic></bold><sup><bold><italic>t</italic></bold></sup>) should be maintained within the alignment space (<bold><italic>P</italic></bold><sup><italic>s</italic></sup> and <bold><italic>P</italic></bold><sup><italic>t</italic></sup>), respectively. The novel aspect of scAlign compared to other dimensionality reduction methods is in how <bold><italic>P</italic></bold><sup><italic>s</italic></sup> and <bold><italic>P</italic></bold><sup><italic>t</italic></sup> are calculated. While <bold><italic>P</italic></bold><sup><italic>s</italic></sup> would canonically be calculated by transforming the dot product of the embeddings <inline-formula id="IEq9"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_i^s $$\end{document}</tex-math><mml:math id="M36" display="inline"><mml:msubsup><mml:mover accent="true"><mml:mi>e</mml:mi><mml:mo stretchy="true">→</mml:mo></mml:mover><mml:mi>i</mml:mi><mml:mi>s</mml:mi></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq9.gif"/></alternatives></inline-formula> as is done in the tSNE method [<xref ref-type="bibr" rid="CR47">47</xref>] for example, scAlign computes roundtrip random walks of length two that traverse the two conditions. <inline-formula id="IEq10"><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\boldsymbol{P}}_{\boldsymbol{i},\boldsymbol{k}}^{\boldsymbol{s}} $$\end{document}</tex-math><mml:math id="M38" display="inline"><mml:msubsup><mml:mi mathvariant="bold-italic">P</mml:mi><mml:mrow><mml:mi mathvariant="bold-italic">i</mml:mi><mml:mo mathvariant="bold-italic">,</mml:mo><mml:mi mathvariant="bold-italic">k</mml:mi></mml:mrow><mml:mi mathvariant="bold-italic">s</mml:mi></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq10.gif"/></alternatives></inline-formula>, the transition probability of moving from cell <italic>i</italic> to cell <italic>k</italic> within condition <italic>s</italic>, is calculated as the probability of randomly walking from cell <italic>i</italic> to cell <italic>k</italic> in two steps: first from cell <italic>i</italic> to any cell <italic>j</italic> in the other condition <italic>t</italic> in the first step, then from that cell <italic>j</italic> to cell <italic>k</italic> (in condition <italic>s</italic>) in the second step. By forcing the random walk to first visit a cell in the other condition, scAlign encourages the encoder to bring cells from across the two conditions into similar regions of alignment space.</p>
      <p id="Par43">The network weights <bold><italic>W</italic></bold> are initialized by Xavier [<xref ref-type="bibr" rid="CR48">48</xref>] and optimized via the Adam algorithm [<xref ref-type="bibr" rid="CR49">49</xref>] with an initial learning rate of 10<sup>− 4</sup> and a maximum of 15,000 iterations. The neural network activation functions of each hidden layer are ReLU, and the embedding layer has a linear activation function. Regularization is enforced through an L2 penalty on the weights along with per-layer batch normalization and dropout at a rate of 30%. The scAlign framework has three tunable parameters: the per-cell variance parameter <inline-formula id="IEq11"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\sigma}_i^2 $$\end{document}</tex-math><mml:math id="M40" display="inline"><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq11.gif"/></alternatives></inline-formula> that controls the effective size of each cell’s neighborhood when defining the similarity matrix in gene expression space, the magnitude of the penalization term <italic>λ</italic> over <bold><italic>W</italic></bold> that is fixed at 10<sup>− 4</sup>, and the size of the encoder network architecture.</p>
      <p id="Par44">For the tuning parameter <inline-formula id="IEq12"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\sigma}_i^2 $$\end{document}</tex-math><mml:math id="M42" display="inline"><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq12.gif"/></alternatives></inline-formula>, small values yield more local alignment, whereas larger values yield more global alignment. In our experiments, we train each model with a range of values for <inline-formula id="IEq13"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\sigma}_i^2 $$\end{document}</tex-math><mml:math id="M44" display="inline"><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq13.gif"/></alternatives></inline-formula>. Typically, [<xref ref-type="bibr" rid="CR5">5</xref>, <xref ref-type="bibr" rid="CR10">10</xref>, <xref ref-type="bibr" rid="CR29">29</xref>] provide robust results when training on mini-batches of less than 300 samples. While the per-cell variance parameter <inline-formula id="IEq14"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\sigma}_i^2 $$\end{document}</tex-math><mml:math id="M46" display="inline"><mml:mspace width="0.25em"/><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq14.gif"/></alternatives></inline-formula> operates on the training mini-batch, we found training is robust to the choice of <inline-formula id="IEq15"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\sigma}_i^2 $$\end{document}</tex-math><mml:math id="M48" display="inline"><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq15.gif"/></alternatives></inline-formula>.</p>
      <p id="Par45">In our experiments, we set the size of the encoder architecture by either automatically constructing a network based on the dimensionality of the input data in conjunction with a complexity parameter, or from a catalog of network architectures which are at most three layers deep. As with other neural networks, the size of the architecture defines the complexity and power of the network. Model complexity is important for alignment because the network must be powerful enough to align cells from conditions that yield heterogeneous responses to stimulus, but not so powerful that any cell in one condition can be mapped to any other cell in another condition, regardless of whether they are functionally related. We have found in our experiments (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S3) that the combination of cross-entropy loss and shrinkage applied to the network weights yields robustness to generously large network architectures. Namely, by encouraging small weights and minimizing the differences in cell-cell similarity matrices between the expression and embedding spaces, we avoid training the neural network to perform unnecessary complex transformations on the data.</p>
    </sec>
    <sec id="Sec13">
      <title>Overview of multi-way alignment with scAlign</title>
      <p id="Par46">Alignment of three or more conditions simultaneously is implemented in two ways in the scAlign framework. In approach one (“all-pairs alignment”), round trip walks are computed between all pairs of conditions and is expected to be the most accurate form of multi-way alignment. In approach two (“reference-based alignment”), one condition is defined as a reference, against which all other conditions are aligned.</p>
    </sec>
    <sec id="Sec14">
      <title>All-pairs alignment with scAlign</title>
      <p id="Par47">In this strategy, we extend the pairwise alignment approach by performing round trip walks between all pairs of conditions simultaneously, while still sharing a single encoder’s neural network parameters across all conditions. Compared to the reference-based alignment approach below, the all-pairs approach will be more robust when there are cell types that are only represented in a subset of the input conditions. The objective function of the pairwise alignment approach is modified to include round trip walks between each condition <italic>k</italic> and the remaining conditions <italic>l</italic> ≠ <italic>k</italic>:</p>
      <p id="Par48">
        <disp-formula id="Equj">
          <alternatives>
            <tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ f=\sum \limits_k\ \sum \limits_{l\ne k}\ \left[\frac{1}{\mid N\mid}\sum \limits_n\mathrm{cross}-\mathrm{entropy}\left({\overrightarrow{P}}_{n,\bullet}^{k,l},{\overrightarrow{Q}}_{n,\bullet}^{k,l}\right)\right]+\lambda {\left\Vert \boldsymbol{W}\right\Vert}_F^2 $$\end{document}</tex-math>
            <mml:math id="M50" display="block">
              <mml:mi>f</mml:mi>
              <mml:mo>=</mml:mo>
              <mml:munder>
                <mml:mo>∑</mml:mo>
                <mml:mi>k</mml:mi>
              </mml:munder>
              <mml:mspace width="0.25em"/>
              <mml:munder>
                <mml:mo>∑</mml:mo>
                <mml:mrow>
                  <mml:mi>l</mml:mi>
                  <mml:mo>≠</mml:mo>
                  <mml:mi>k</mml:mi>
                </mml:mrow>
              </mml:munder>
              <mml:mspace width="0.25em"/>
              <mml:mfenced close="]" open="[">
                <mml:mrow>
                  <mml:mfrac>
                    <mml:mn>1</mml:mn>
                    <mml:mrow>
                      <mml:mo>∣</mml:mo>
                      <mml:mi>N</mml:mi>
                      <mml:mo>∣</mml:mo>
                    </mml:mrow>
                  </mml:mfrac>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:mi>n</mml:mi>
                  </mml:munder>
                  <mml:mtext>cross</mml:mtext>
                  <mml:mo>−</mml:mo>
                  <mml:mtext>entropy</mml:mtext>
                  <mml:mfenced close=")" open="(" separators=",">
                    <mml:msubsup>
                      <mml:mover accent="true">
                        <mml:mi>P</mml:mi>
                        <mml:mo stretchy="true">→</mml:mo>
                      </mml:mover>
                      <mml:mrow>
                        <mml:mi>n</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mo>∙</mml:mo>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mi>k</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mi>l</mml:mi>
                      </mml:mrow>
                    </mml:msubsup>
                    <mml:msubsup>
                      <mml:mover accent="true">
                        <mml:mi>Q</mml:mi>
                        <mml:mo stretchy="true">→</mml:mo>
                      </mml:mover>
                      <mml:mrow>
                        <mml:mi>n</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mo>∙</mml:mo>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mi>k</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mi>l</mml:mi>
                      </mml:mrow>
                    </mml:msubsup>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfenced>
              <mml:mo>+</mml:mo>
              <mml:mi>λ</mml:mi>
              <mml:msubsup>
                <mml:mfenced close="‖" open="‖">
                  <mml:mi mathvariant="bold-italic">W</mml:mi>
                </mml:mfenced>
                <mml:mi>F</mml:mi>
                <mml:mn>2</mml:mn>
              </mml:msubsup>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equj.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
      </p>
      <p id="Par49">
        <disp-formula id="Equk">
          <alternatives>
            <tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\boldsymbol{P}}^{k,l}={\boldsymbol{P}}^{k\to l}{\boldsymbol{P}}^{l\to k} $$\end{document}</tex-math>
            <mml:math id="M52" display="block">
              <mml:msup>
                <mml:mi mathvariant="bold-italic">P</mml:mi>
                <mml:mrow>
                  <mml:mi>k</mml:mi>
                  <mml:mo>,</mml:mo>
                  <mml:mi>l</mml:mi>
                </mml:mrow>
              </mml:msup>
              <mml:mo>=</mml:mo>
              <mml:msup>
                <mml:mi mathvariant="bold-italic">P</mml:mi>
                <mml:mrow>
                  <mml:mi>k</mml:mi>
                  <mml:mo>→</mml:mo>
                  <mml:mi>l</mml:mi>
                </mml:mrow>
              </mml:msup>
              <mml:msup>
                <mml:mi mathvariant="bold-italic">P</mml:mi>
                <mml:mrow>
                  <mml:mi>l</mml:mi>
                  <mml:mo>→</mml:mo>
                  <mml:mi>k</mml:mi>
                </mml:mrow>
              </mml:msup>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equk.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
        <disp-formula id="Equl">
          <alternatives>
            <tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {Q}_{i,j}^{k,l}=\frac{\exp \left(-0.5{\left\Vert {\overrightarrow{x}}_i^k-{\overrightarrow{x}}_j^k\right\Vert}^2/{\sigma}_i^2\right)}{\sum \limits_{j^{\prime}\ne i}\exp \left(-0.5{\left\Vert {\overrightarrow{x}}_i^k-{\overrightarrow{x}}_{j\prime}^k\right\Vert}^2/{\sigma}_i^2\right)} $$\end{document}</tex-math>
            <mml:math id="M54" display="block">
              <mml:msubsup>
                <mml:mi>Q</mml:mi>
                <mml:mrow>
                  <mml:mi>i</mml:mi>
                  <mml:mo>,</mml:mo>
                  <mml:mi>j</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:mi>k</mml:mi>
                  <mml:mo>,</mml:mo>
                  <mml:mi>l</mml:mi>
                </mml:mrow>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:mn>0.5</mml:mn>
                      <mml:msup>
                        <mml:mfenced close="‖" open="‖">
                          <mml:mrow>
                            <mml:msubsup>
                              <mml:mover accent="true">
                                <mml:mi>x</mml:mi>
                                <mml:mo stretchy="true">→</mml:mo>
                              </mml:mover>
                              <mml:mi>i</mml:mi>
                              <mml:mi>k</mml:mi>
                            </mml:msubsup>
                            <mml:mo>−</mml:mo>
                            <mml:msubsup>
                              <mml:mover accent="true">
                                <mml:mi>x</mml:mi>
                                <mml:mo stretchy="true">→</mml:mo>
                              </mml:mover>
                              <mml:mi>j</mml:mi>
                              <mml:mi>k</mml:mi>
                            </mml:msubsup>
                          </mml:mrow>
                        </mml:mfenced>
                        <mml:mn>2</mml:mn>
                      </mml:msup>
                      <mml:mo>/</mml:mo>
                      <mml:msubsup>
                        <mml:mi>σ</mml:mi>
                        <mml:mi>i</mml:mi>
                        <mml:mn>2</mml:mn>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
                <mml:mrow>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:mrow>
                      <mml:mi>j</mml:mi>
                      <mml:mo>′</mml:mo>
                      <mml:mo>≠</mml:mo>
                      <mml:mi>i</mml:mi>
                    </mml:mrow>
                  </mml:munder>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:mn>0.5</mml:mn>
                      <mml:msup>
                        <mml:mfenced close="‖" open="‖">
                          <mml:mrow>
                            <mml:msubsup>
                              <mml:mover accent="true">
                                <mml:mi>x</mml:mi>
                                <mml:mo stretchy="true">→</mml:mo>
                              </mml:mover>
                              <mml:mi>i</mml:mi>
                              <mml:mi>k</mml:mi>
                            </mml:msubsup>
                            <mml:mo>−</mml:mo>
                            <mml:msubsup>
                              <mml:mover accent="true">
                                <mml:mi>x</mml:mi>
                                <mml:mo stretchy="true">→</mml:mo>
                              </mml:mover>
                              <mml:mrow>
                                <mml:mi>j</mml:mi>
                                <mml:mo>′</mml:mo>
                              </mml:mrow>
                              <mml:mi>k</mml:mi>
                            </mml:msubsup>
                          </mml:mrow>
                        </mml:mfenced>
                        <mml:mn>2</mml:mn>
                      </mml:msup>
                      <mml:mo>/</mml:mo>
                      <mml:msubsup>
                        <mml:mi>σ</mml:mi>
                        <mml:mi>i</mml:mi>
                        <mml:mn>2</mml:mn>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfrac>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equl.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
        <disp-formula id="Equm">
          <alternatives>
            <tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {P}_{i,j}^{k\to l}=\frac{\exp \left({{\overrightarrow{e}}_i^k}^T{\overrightarrow{e}}_j^l\right)}{\sum \limits_{j^{\prime }}\exp \left({{\overrightarrow{e}}_i^k}^T{\overrightarrow{e}}_{j\prime}^l\right)} $$\end{document}</tex-math>
            <mml:math id="M56" display="block">
              <mml:msubsup>
                <mml:mi>P</mml:mi>
                <mml:mrow>
                  <mml:mi>i</mml:mi>
                  <mml:mo>,</mml:mo>
                  <mml:mi>j</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:mi>k</mml:mi>
                  <mml:mo>→</mml:mo>
                  <mml:mi>l</mml:mi>
                </mml:mrow>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:msup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>e</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mi>i</mml:mi>
                          <mml:mi>k</mml:mi>
                        </mml:msubsup>
                        <mml:mi>T</mml:mi>
                      </mml:msup>
                      <mml:msubsup>
                        <mml:mover accent="true">
                          <mml:mi>e</mml:mi>
                          <mml:mo stretchy="true">→</mml:mo>
                        </mml:mover>
                        <mml:mi>j</mml:mi>
                        <mml:mi>l</mml:mi>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
                <mml:mrow>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:mrow>
                      <mml:mi>j</mml:mi>
                      <mml:mo>′</mml:mo>
                    </mml:mrow>
                  </mml:munder>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:msup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>e</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mi>i</mml:mi>
                          <mml:mi>k</mml:mi>
                        </mml:msubsup>
                        <mml:mi>T</mml:mi>
                      </mml:msup>
                      <mml:msubsup>
                        <mml:mover accent="true">
                          <mml:mi>e</mml:mi>
                          <mml:mo stretchy="true">→</mml:mo>
                        </mml:mover>
                        <mml:mrow>
                          <mml:mi>j</mml:mi>
                          <mml:mo>′</mml:mo>
                        </mml:mrow>
                        <mml:mi>l</mml:mi>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfrac>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equm.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
        <disp-formula id="Equn">
          <alternatives>
            <tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {P}_{j,i}^{l\to k}=\frac{\exp \left({{\overrightarrow{e}}_j^l}^T{\overrightarrow{e}}_i^k\right)}{\sum \limits_{i^{\prime }}\exp \left({{\overrightarrow{e}}_j^l}^T{\overrightarrow{e}}_{i^{\prime}}^k\right)} $$\end{document}</tex-math>
            <mml:math id="M58" display="block">
              <mml:msubsup>
                <mml:mi>P</mml:mi>
                <mml:mrow>
                  <mml:mi>j</mml:mi>
                  <mml:mo>,</mml:mo>
                  <mml:mi>i</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:mi>l</mml:mi>
                  <mml:mo>→</mml:mo>
                  <mml:mi>k</mml:mi>
                </mml:mrow>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:msup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>e</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mi>j</mml:mi>
                          <mml:mi>l</mml:mi>
                        </mml:msubsup>
                        <mml:mi>T</mml:mi>
                      </mml:msup>
                      <mml:msubsup>
                        <mml:mover accent="true">
                          <mml:mi>e</mml:mi>
                          <mml:mo stretchy="true">→</mml:mo>
                        </mml:mover>
                        <mml:mi>i</mml:mi>
                        <mml:mi>k</mml:mi>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
                <mml:mrow>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:msup>
                      <mml:mi>i</mml:mi>
                      <mml:mo>′</mml:mo>
                    </mml:msup>
                  </mml:munder>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:msup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>e</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mi>j</mml:mi>
                          <mml:mi>l</mml:mi>
                        </mml:msubsup>
                        <mml:mi>T</mml:mi>
                      </mml:msup>
                      <mml:msubsup>
                        <mml:mover accent="true">
                          <mml:mi>e</mml:mi>
                          <mml:mo stretchy="true">→</mml:mo>
                        </mml:mover>
                        <mml:msup>
                          <mml:mi>i</mml:mi>
                          <mml:mo>′</mml:mo>
                        </mml:msup>
                        <mml:mi>k</mml:mi>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfrac>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equn.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
      </p>
      <p id="Par50">
        <disp-formula id="Equo">
          <alternatives>
            <tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_i^k=\mathrm{encoder}\left({\overrightarrow{x}}_i^k,\boldsymbol{W}\right) $$\end{document}</tex-math>
            <mml:math id="M60" display="block">
              <mml:msubsup>
                <mml:mover accent="true">
                  <mml:mi>e</mml:mi>
                  <mml:mo stretchy="true">→</mml:mo>
                </mml:mover>
                <mml:mi>i</mml:mi>
                <mml:mi>k</mml:mi>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mtext>encoder</mml:mtext>
              <mml:mfenced close=")" open="(" separators=",">
                <mml:msubsup>
                  <mml:mover accent="true">
                    <mml:mi>x</mml:mi>
                    <mml:mo stretchy="true">→</mml:mo>
                  </mml:mover>
                  <mml:mi>i</mml:mi>
                  <mml:mi>k</mml:mi>
                </mml:msubsup>
                <mml:mi mathvariant="bold-italic">W</mml:mi>
              </mml:mfenced>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equo.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
        <disp-formula id="Equp">
          <alternatives>
            <tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_j^l=\mathrm{encoder}\left({\overrightarrow{x}}_j^l,\boldsymbol{W}\right) $$\end{document}</tex-math>
            <mml:math id="M62" display="block">
              <mml:msubsup>
                <mml:mover accent="true">
                  <mml:mi>e</mml:mi>
                  <mml:mo stretchy="true">→</mml:mo>
                </mml:mover>
                <mml:mi>j</mml:mi>
                <mml:mi>l</mml:mi>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mtext>encoder</mml:mtext>
              <mml:mfenced close=")" open="(" separators=",">
                <mml:msubsup>
                  <mml:mover accent="true">
                    <mml:mi>x</mml:mi>
                    <mml:mo stretchy="true">→</mml:mo>
                  </mml:mover>
                  <mml:mi>j</mml:mi>
                  <mml:mi>l</mml:mi>
                </mml:msubsup>
                <mml:mi mathvariant="bold-italic">W</mml:mi>
              </mml:mfenced>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equp.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
      </p>
    </sec>
    <sec id="Sec15">
      <title>Reference-based multi-way alignment with scAlign</title>
      <p id="Par51">In this strategy, multiple conditions are aligned simultaneously by selecting one condition to be a reference (<italic>k</italic><sub>ref</sub>), against which all other conditions (<italic>l</italic> ≠ <italic>k</italic><sub>ref</sub>) are aligned. Compared to the all-pairs approach, reference-based alignment is faster and therefore more scalable, though is expected to perform worse when there are cell types shared amongst non-reference conditions, that are not represented in the reference condition. The objective function for reference-based alignment is as follows:</p>
      <p id="Par52">
        <disp-formula id="Equq">
          <alternatives>
            <tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ f=\sum \limits_{l\ne {k}_{\mathrm{ref}}}\ \left[\frac{1}{\mid N\mid}\sum \limits_n\mathrm{cross}-\mathrm{entropy}\left({\overrightarrow{P}}_{n,\bullet}^{k_{\mathrm{ref}}},{\overrightarrow{Q}}_{n,\bullet}^{k_{\mathrm{ref}}}\right)\right]+\lambda {\left\Vert \boldsymbol{W}\right\Vert}_F^2 $$\end{document}</tex-math>
            <mml:math id="M64" display="block">
              <mml:mi>f</mml:mi>
              <mml:mo>=</mml:mo>
              <mml:munder>
                <mml:mo>∑</mml:mo>
                <mml:mrow>
                  <mml:mi>l</mml:mi>
                  <mml:mo>≠</mml:mo>
                  <mml:msub>
                    <mml:mi>k</mml:mi>
                    <mml:mi>ref</mml:mi>
                  </mml:msub>
                </mml:mrow>
              </mml:munder>
              <mml:mspace width="0.25em"/>
              <mml:mfenced close="]" open="[">
                <mml:mrow>
                  <mml:mfrac>
                    <mml:mn>1</mml:mn>
                    <mml:mrow>
                      <mml:mo>∣</mml:mo>
                      <mml:mi>N</mml:mi>
                      <mml:mo>∣</mml:mo>
                    </mml:mrow>
                  </mml:mfrac>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:mi>n</mml:mi>
                  </mml:munder>
                  <mml:mtext>cross</mml:mtext>
                  <mml:mo>−</mml:mo>
                  <mml:mtext>entropy</mml:mtext>
                  <mml:mfenced close=")" open="(" separators=",">
                    <mml:msubsup>
                      <mml:mover accent="true">
                        <mml:mi>P</mml:mi>
                        <mml:mo stretchy="true">→</mml:mo>
                      </mml:mover>
                      <mml:mrow>
                        <mml:mi>n</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mo>∙</mml:mo>
                      </mml:mrow>
                      <mml:msub>
                        <mml:mi>k</mml:mi>
                        <mml:mi>ref</mml:mi>
                      </mml:msub>
                    </mml:msubsup>
                    <mml:msubsup>
                      <mml:mover accent="true">
                        <mml:mi>Q</mml:mi>
                        <mml:mo stretchy="true">→</mml:mo>
                      </mml:mover>
                      <mml:mrow>
                        <mml:mi>n</mml:mi>
                        <mml:mo>,</mml:mo>
                        <mml:mo>∙</mml:mo>
                      </mml:mrow>
                      <mml:msub>
                        <mml:mi>k</mml:mi>
                        <mml:mi>ref</mml:mi>
                      </mml:msub>
                    </mml:msubsup>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfenced>
              <mml:mo>+</mml:mo>
              <mml:mi>λ</mml:mi>
              <mml:msubsup>
                <mml:mfenced close="‖" open="‖">
                  <mml:mi mathvariant="bold-italic">W</mml:mi>
                </mml:mfenced>
                <mml:mi>F</mml:mi>
                <mml:mn>2</mml:mn>
              </mml:msubsup>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equq.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
      </p>
      <p id="Par53">
        <disp-formula id="Equr">
          <alternatives>
            <tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\boldsymbol{P}}^{k_{\mathrm{ref}}}={\boldsymbol{P}}^{k_{\mathrm{ref}}\to l}{\boldsymbol{P}}^{l\to {k}_{\mathrm{ref}}} $$\end{document}</tex-math>
            <mml:math id="M66" display="block">
              <mml:msup>
                <mml:mi mathvariant="bold-italic">P</mml:mi>
                <mml:msub>
                  <mml:mi>k</mml:mi>
                  <mml:mi>ref</mml:mi>
                </mml:msub>
              </mml:msup>
              <mml:mo>=</mml:mo>
              <mml:msup>
                <mml:mi mathvariant="bold-italic">P</mml:mi>
                <mml:mrow>
                  <mml:msub>
                    <mml:mi>k</mml:mi>
                    <mml:mi>ref</mml:mi>
                  </mml:msub>
                  <mml:mo>→</mml:mo>
                  <mml:mi>l</mml:mi>
                </mml:mrow>
              </mml:msup>
              <mml:msup>
                <mml:mi mathvariant="bold-italic">P</mml:mi>
                <mml:mrow>
                  <mml:mi>l</mml:mi>
                  <mml:mo>→</mml:mo>
                  <mml:msub>
                    <mml:mi>k</mml:mi>
                    <mml:mi>ref</mml:mi>
                  </mml:msub>
                </mml:mrow>
              </mml:msup>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equr.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
        <disp-formula id="Equs">
          <alternatives>
            <tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {Q}_{i,j}^{k_{\mathrm{ref}}}=\frac{\exp \left(-0.5{\left\Vert {\overrightarrow{x}}_i^{k_{\mathrm{ref}}}-{\overrightarrow{x}}_j^{k_{\mathrm{ref}}}\right\Vert}^2/{\sigma}_i^2\right)}{\sum \limits_{j^{\prime}\ne i}\exp \left(-0.5{\left\Vert {\overrightarrow{x}}_i^{k_{\mathrm{ref}}}-{\overrightarrow{x}}_{j\prime}^{k_{\mathrm{ref}}}\right\Vert}^2/{\sigma}_i^2\right)} $$\end{document}</tex-math>
            <mml:math id="M68" display="block">
              <mml:msubsup>
                <mml:mi>Q</mml:mi>
                <mml:mrow>
                  <mml:mi>i</mml:mi>
                  <mml:mo>,</mml:mo>
                  <mml:mi>j</mml:mi>
                </mml:mrow>
                <mml:msub>
                  <mml:mi>k</mml:mi>
                  <mml:mi>ref</mml:mi>
                </mml:msub>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:mn>0.5</mml:mn>
                      <mml:msup>
                        <mml:mfenced close="‖" open="‖">
                          <mml:mrow>
                            <mml:msubsup>
                              <mml:mover accent="true">
                                <mml:mi>x</mml:mi>
                                <mml:mo stretchy="true">→</mml:mo>
                              </mml:mover>
                              <mml:mi>i</mml:mi>
                              <mml:msub>
                                <mml:mi>k</mml:mi>
                                <mml:mi>ref</mml:mi>
                              </mml:msub>
                            </mml:msubsup>
                            <mml:mo>−</mml:mo>
                            <mml:msubsup>
                              <mml:mover accent="true">
                                <mml:mi>x</mml:mi>
                                <mml:mo stretchy="true">→</mml:mo>
                              </mml:mover>
                              <mml:mi>j</mml:mi>
                              <mml:msub>
                                <mml:mi>k</mml:mi>
                                <mml:mi>ref</mml:mi>
                              </mml:msub>
                            </mml:msubsup>
                          </mml:mrow>
                        </mml:mfenced>
                        <mml:mn>2</mml:mn>
                      </mml:msup>
                      <mml:mo>/</mml:mo>
                      <mml:msubsup>
                        <mml:mi>σ</mml:mi>
                        <mml:mi>i</mml:mi>
                        <mml:mn>2</mml:mn>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
                <mml:mrow>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:mrow>
                      <mml:mi>j</mml:mi>
                      <mml:mo>′</mml:mo>
                      <mml:mo>≠</mml:mo>
                      <mml:mi>i</mml:mi>
                    </mml:mrow>
                  </mml:munder>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:mn>0.5</mml:mn>
                      <mml:msup>
                        <mml:mfenced close="‖" open="‖">
                          <mml:mrow>
                            <mml:msubsup>
                              <mml:mover accent="true">
                                <mml:mi>x</mml:mi>
                                <mml:mo stretchy="true">→</mml:mo>
                              </mml:mover>
                              <mml:mi>i</mml:mi>
                              <mml:msub>
                                <mml:mi>k</mml:mi>
                                <mml:mi>ref</mml:mi>
                              </mml:msub>
                            </mml:msubsup>
                            <mml:mo>−</mml:mo>
                            <mml:msubsup>
                              <mml:mover accent="true">
                                <mml:mi>x</mml:mi>
                                <mml:mo stretchy="true">→</mml:mo>
                              </mml:mover>
                              <mml:mrow>
                                <mml:mi>j</mml:mi>
                                <mml:mo>′</mml:mo>
                              </mml:mrow>
                              <mml:msub>
                                <mml:mi>k</mml:mi>
                                <mml:mi>ref</mml:mi>
                              </mml:msub>
                            </mml:msubsup>
                          </mml:mrow>
                        </mml:mfenced>
                        <mml:mn>2</mml:mn>
                      </mml:msup>
                      <mml:mo>/</mml:mo>
                      <mml:msubsup>
                        <mml:mi>σ</mml:mi>
                        <mml:mi>i</mml:mi>
                        <mml:mn>2</mml:mn>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfrac>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equs.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
        <disp-formula id="Equt">
          <alternatives>
            <tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {P}_{i,j}^{k_{\mathrm{ref}}\to l}=\frac{\exp \left({{\overrightarrow{e}}_i^{k_{\mathrm{ref}}}}^T{\overrightarrow{e}}_j^l\right)}{\sum \limits_{j^{\prime }}\exp \left({{\overrightarrow{e}}_i^{k_{\mathrm{ref}}}}^T{\overrightarrow{e}}_{j\prime}^l\right)} $$\end{document}</tex-math>
            <mml:math id="M70" display="block">
              <mml:msubsup>
                <mml:mi>P</mml:mi>
                <mml:mrow>
                  <mml:mi>i</mml:mi>
                  <mml:mo>,</mml:mo>
                  <mml:mi>j</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:msub>
                    <mml:mi>k</mml:mi>
                    <mml:mi>ref</mml:mi>
                  </mml:msub>
                  <mml:mo>→</mml:mo>
                  <mml:mi>l</mml:mi>
                </mml:mrow>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:msup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>e</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mi>i</mml:mi>
                          <mml:msub>
                            <mml:mi>k</mml:mi>
                            <mml:mi>ref</mml:mi>
                          </mml:msub>
                        </mml:msubsup>
                        <mml:mi>T</mml:mi>
                      </mml:msup>
                      <mml:msubsup>
                        <mml:mover accent="true">
                          <mml:mi>e</mml:mi>
                          <mml:mo stretchy="true">→</mml:mo>
                        </mml:mover>
                        <mml:mi>j</mml:mi>
                        <mml:mi>l</mml:mi>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
                <mml:mrow>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:mrow>
                      <mml:mi>j</mml:mi>
                      <mml:mo>′</mml:mo>
                    </mml:mrow>
                  </mml:munder>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:msup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>e</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mi>i</mml:mi>
                          <mml:msub>
                            <mml:mi>k</mml:mi>
                            <mml:mi>ref</mml:mi>
                          </mml:msub>
                        </mml:msubsup>
                        <mml:mi>T</mml:mi>
                      </mml:msup>
                      <mml:msubsup>
                        <mml:mover accent="true">
                          <mml:mi>e</mml:mi>
                          <mml:mo stretchy="true">→</mml:mo>
                        </mml:mover>
                        <mml:mrow>
                          <mml:mi>j</mml:mi>
                          <mml:mo>′</mml:mo>
                        </mml:mrow>
                        <mml:mi>l</mml:mi>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfrac>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equt.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
        <disp-formula id="Equu">
          <alternatives>
            <tex-math id="M71">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {P}_{j,i}^{l\to {k}_{\mathrm{ref}}}=\frac{\exp \left({{\overrightarrow{e}}_j^l}^T{\overrightarrow{e}}_i^{k_{\mathrm{ref}}}\right)}{\sum \limits_{i^{\prime }}\exp \left({{\overrightarrow{e}}_j^l}^T{\overrightarrow{e}}_{i^{\prime}}^{k_{\mathrm{ref}}}\right)} $$\end{document}</tex-math>
            <mml:math id="M72" display="block">
              <mml:msubsup>
                <mml:mi>P</mml:mi>
                <mml:mrow>
                  <mml:mi>j</mml:mi>
                  <mml:mo>,</mml:mo>
                  <mml:mi>i</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:mi>l</mml:mi>
                  <mml:mo>→</mml:mo>
                  <mml:msub>
                    <mml:mi>k</mml:mi>
                    <mml:mi>ref</mml:mi>
                  </mml:msub>
                </mml:mrow>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:msup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>e</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mi>j</mml:mi>
                          <mml:mi>l</mml:mi>
                        </mml:msubsup>
                        <mml:mi>T</mml:mi>
                      </mml:msup>
                      <mml:msubsup>
                        <mml:mover accent="true">
                          <mml:mi>e</mml:mi>
                          <mml:mo stretchy="true">→</mml:mo>
                        </mml:mover>
                        <mml:mi>i</mml:mi>
                        <mml:msub>
                          <mml:mi>k</mml:mi>
                          <mml:mi>ref</mml:mi>
                        </mml:msub>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
                <mml:mrow>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:msup>
                      <mml:mi>i</mml:mi>
                      <mml:mo>′</mml:mo>
                    </mml:msup>
                  </mml:munder>
                  <mml:mo>exp</mml:mo>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:msup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>e</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mi>j</mml:mi>
                          <mml:mi>l</mml:mi>
                        </mml:msubsup>
                        <mml:mi>T</mml:mi>
                      </mml:msup>
                      <mml:msubsup>
                        <mml:mover accent="true">
                          <mml:mi>e</mml:mi>
                          <mml:mo stretchy="true">→</mml:mo>
                        </mml:mover>
                        <mml:msup>
                          <mml:mi>i</mml:mi>
                          <mml:mo>′</mml:mo>
                        </mml:msup>
                        <mml:msub>
                          <mml:mi>k</mml:mi>
                          <mml:mi>ref</mml:mi>
                        </mml:msub>
                      </mml:msubsup>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfrac>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equu.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
      </p>
      <p id="Par54">
        <disp-formula id="Equv">
          <alternatives>
            <tex-math id="M73">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_i^{k_{ref}}=\mathrm{encoder}\left({\overrightarrow{x}}_i^{k_{ref}},\boldsymbol{W}\right) $$\end{document}</tex-math>
            <mml:math id="M74" display="block">
              <mml:msubsup>
                <mml:mover accent="true">
                  <mml:mi>e</mml:mi>
                  <mml:mo stretchy="true">→</mml:mo>
                </mml:mover>
                <mml:mi>i</mml:mi>
                <mml:msub>
                  <mml:mi>k</mml:mi>
                  <mml:mi mathvariant="italic">ref</mml:mi>
                </mml:msub>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mtext>encoder</mml:mtext>
              <mml:mfenced close=")" open="(" separators=",">
                <mml:msubsup>
                  <mml:mover accent="true">
                    <mml:mi>x</mml:mi>
                    <mml:mo stretchy="true">→</mml:mo>
                  </mml:mover>
                  <mml:mi>i</mml:mi>
                  <mml:msub>
                    <mml:mi>k</mml:mi>
                    <mml:mi mathvariant="italic">ref</mml:mi>
                  </mml:msub>
                </mml:msubsup>
                <mml:mi mathvariant="bold-italic">W</mml:mi>
              </mml:mfenced>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equv.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
        <disp-formula id="Equw">
          <alternatives>
            <tex-math id="M75">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\overrightarrow{e}}_j^l=\mathrm{encoder}\left({\overrightarrow{x}}_j^l,\boldsymbol{W}\right) $$\end{document}</tex-math>
            <mml:math id="M76" display="block">
              <mml:msubsup>
                <mml:mover accent="true">
                  <mml:mi>e</mml:mi>
                  <mml:mo stretchy="true">→</mml:mo>
                </mml:mover>
                <mml:mi>j</mml:mi>
                <mml:mi>l</mml:mi>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mtext>encoder</mml:mtext>
              <mml:mfenced close=")" open="(" separators=",">
                <mml:msubsup>
                  <mml:mover accent="true">
                    <mml:mi>x</mml:mi>
                    <mml:mo stretchy="true">→</mml:mo>
                  </mml:mover>
                  <mml:mi>j</mml:mi>
                  <mml:mi>l</mml:mi>
                </mml:msubsup>
                <mml:mi mathvariant="bold-italic">W</mml:mi>
              </mml:mfenced>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equw.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
      </p>
      <p id="Par55">The remaining details for optimizing scAlign’s objective function in the multi-way case are identical to the paired alignment task described previously. We note that in our experiments the number of embedding dimensions had to be increased for three or more conditions in order to accommodate the increased information in the embeddings of the encoder shared across all <italic>k</italic> condtions.</p>
    </sec>
    <sec id="Sec16">
      <title>scRNA-seq interpolation with scAlign</title>
      <p id="Par56">The interpolation component of scAlign trains a condition-specific decoder to map cells from the alignment space back into each of the individual condition-specific gene expression spaces. The decoder network architecture is chosen to be symmetric with the encoder network trained during the alignment process, with weights randomly initialized and optimized again via the Adam optimizer [<xref ref-type="bibr" rid="CR49">49</xref>] with learning rate set at 10<sup>−4</sup> and trained for at most 30,000 iterations.</p>
    </sec>
    <sec id="Sec17">
      <title>Calculation of the state variance map</title>
      <p id="Par57">After interpolating every cell (sequenced in any condition) from the alignment space back to every input condition, for each cell, we obtain multiple condition-specific representations for each cell. Then, per cell, we compute the variance of the interpolated expression patterns for that cell across the input conditions. The result is a matrix, termed the state variance map, which illustrates the variance in each gene-specific expression level for each cell predicted across conditions. In the special case where two conditions are being aligned, this state variance map can be viewed as a (predicted) paired differential expression map, where differences are calculated per cell.</p>
    </sec>
    <sec id="Sec18">
      <title>Shared autoencoder optimization</title>
      <p id="Par58">The training procedure for training a shared autoencoder followed that of scAlign in that the autoencoder was trained on data from all conditions simultaneously. The shared alignment space of the autoencoder was learned by optimizing with respect to the traditional mean squared error of reconstructing the original expression profiles for each condition by simultaneously training condition-specific decoder networks.</p>
    </sec>
    <sec id="Sec19">
      <title>Principal component analysis and canonical correlation analysis preprocessing transformations of scRNA-seq data</title>
      <p id="Par59">The objective function that scAlign optimizes does not incorporate terms specific to scRNA-seq data such as a negative binomial observation model. We found that computing the principal component and canonical correlates of the normalized scRNA-seq data and using the resulting scores in place of gene expression measurements maintained alignment and interpolation accuracy but sped up training significantly (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S4). Note that even when the encoder network is given PC or CC dimensions as input instead of gene expression measurements, the decoder is still trained to transform alignment space coordinates into the original gene expression space.</p>
    </sec>
    <sec id="Sec20">
      <title>Using partial or complete cell type labels with scAlign</title>
      <p id="Par60">The objective function optimized by scAlign can naturally incorporate partial, overlapping, or complete cell type labels for the cells, in one or more conditions. Suppose there are <italic>C</italic> cell type labels available, in a pairwise alignment scenario. Then define matrix <bold><italic>A</italic></bold><sup><italic>s</italic></sup> such that <inline-formula id="IEq16"><alternatives><tex-math id="M77">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {A}_{i,c}^s=1 $$\end{document}</tex-math><mml:math id="M78" display="inline"><mml:msubsup><mml:mi>A</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msubsup><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq16.gif"/></alternatives></inline-formula> if cell <italic>i</italic> in condition <italic>s</italic> has cell type label <italic>c</italic>, else <inline-formula id="IEq17"><alternatives><tex-math id="M79">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {A}_{i,c}^s=0 $$\end{document}</tex-math><mml:math id="M80" display="inline"><mml:msubsup><mml:mi>A</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>c</mml:mi></mml:mrow><mml:mi>s</mml:mi></mml:msubsup><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq17.gif"/></alternatives></inline-formula>. Similarly, define matrix <inline-formula id="IEq18"><alternatives><tex-math id="M81">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\hat{A}}^s $$\end{document}</tex-math><mml:math id="M82" display="inline"><mml:msup><mml:mover accent="true"><mml:mi>A</mml:mi><mml:mo stretchy="true">^</mml:mo></mml:mover><mml:mi>s</mml:mi></mml:msup></mml:math><inline-graphic xlink:href="13059_2019_1766_Article_IEq18.gif"/></alternatives></inline-formula> containing the predicted class labels for all cells in condition <italic>s</italic>. The scAlign objective function then becomes:</p>
      <p id="Par61">
        <disp-formula id="Equx">
          <alternatives>
            <tex-math id="M83">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ f=\left[\frac{1}{\left|S\right|}\sum \limits_i\left(\upalpha\ \mathrm{cross}-\mathrm{entropy}\left({\overrightarrow{P}}_{i,\bullet}^s,{\overrightarrow{Q}}_{i,\bullet}^s\right)+\beta \sum \limits_c{A}_{i,c}^s\ \mathrm{cross}-\mathrm{entropy}\left({\overrightarrow{A}}_{i,\bullet}^s,{\overrightarrow{\hat{A}}}_{i,\bullet}^s\right)\right)\right]+\left[\frac{1}{\left|T\right|}\sum \limits_j\left(\upalpha\ \mathrm{cross}-\mathrm{entropy}\left({\overrightarrow{P}}_{j,\bullet}^t,{\overrightarrow{Q}}_{\mathrm{j},\bullet}^t\right)+\beta \sum \limits_c{A}_{j,c}^t\mathrm{cross}-\mathrm{entropy}\left({\overrightarrow{A}}_{j,\bullet}^t,{\overrightarrow{\hat{A}}}_{j,\bullet}^t\right)\right)\right]+\lambda {\left\Vert \boldsymbol{W}\right\Vert}_F^2 $$\end{document}</tex-math>
            <mml:math id="M84" display="block">
              <mml:mi>f</mml:mi>
              <mml:mo>=</mml:mo>
              <mml:mfenced close="]" open="[">
                <mml:mrow>
                  <mml:mfrac>
                    <mml:mn>1</mml:mn>
                    <mml:mfenced close="|" open="|">
                      <mml:mi>S</mml:mi>
                    </mml:mfenced>
                  </mml:mfrac>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:mi>i</mml:mi>
                  </mml:munder>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:mi mathvariant="normal">α</mml:mi>
                      <mml:mspace width="0.25em"/>
                      <mml:mtext>cross</mml:mtext>
                      <mml:mo>−</mml:mo>
                      <mml:mtext>entropy</mml:mtext>
                      <mml:mfenced close=")" open="(" separators=",">
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>P</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mrow>
                            <mml:mi>i</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mo>∙</mml:mo>
                          </mml:mrow>
                          <mml:mi>s</mml:mi>
                        </mml:msubsup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>Q</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mrow>
                            <mml:mi>i</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mo>∙</mml:mo>
                          </mml:mrow>
                          <mml:mi>s</mml:mi>
                        </mml:msubsup>
                      </mml:mfenced>
                      <mml:mo>+</mml:mo>
                      <mml:mi>β</mml:mi>
                      <mml:munder>
                        <mml:mo>∑</mml:mo>
                        <mml:mi>c</mml:mi>
                      </mml:munder>
                      <mml:msubsup>
                        <mml:mi>A</mml:mi>
                        <mml:mrow>
                          <mml:mi>i</mml:mi>
                          <mml:mo>,</mml:mo>
                          <mml:mi>c</mml:mi>
                        </mml:mrow>
                        <mml:mi>s</mml:mi>
                      </mml:msubsup>
                      <mml:mspace width="0.25em"/>
                      <mml:mtext>cross</mml:mtext>
                      <mml:mo>−</mml:mo>
                      <mml:mtext>entropy</mml:mtext>
                      <mml:mfenced close=")" open="(" separators=",">
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>A</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mrow>
                            <mml:mi>i</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mo>∙</mml:mo>
                          </mml:mrow>
                          <mml:mi>s</mml:mi>
                        </mml:msubsup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mover accent="true">
                              <mml:mi>A</mml:mi>
                              <mml:mo stretchy="true">^</mml:mo>
                            </mml:mover>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mrow>
                            <mml:mi>i</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mo>∙</mml:mo>
                          </mml:mrow>
                          <mml:mi>s</mml:mi>
                        </mml:msubsup>
                      </mml:mfenced>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfenced>
              <mml:mo>+</mml:mo>
              <mml:mfenced close="]" open="[">
                <mml:mrow>
                  <mml:mfrac>
                    <mml:mn>1</mml:mn>
                    <mml:mfenced close="|" open="|">
                      <mml:mi>T</mml:mi>
                    </mml:mfenced>
                  </mml:mfrac>
                  <mml:munder>
                    <mml:mo>∑</mml:mo>
                    <mml:mi>j</mml:mi>
                  </mml:munder>
                  <mml:mfenced close=")" open="(">
                    <mml:mrow>
                      <mml:mi mathvariant="normal">α</mml:mi>
                      <mml:mspace width="0.25em"/>
                      <mml:mtext>cross</mml:mtext>
                      <mml:mo>−</mml:mo>
                      <mml:mtext>entropy</mml:mtext>
                      <mml:mfenced close=")" open="(" separators=",">
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>P</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mrow>
                            <mml:mi>j</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mo>∙</mml:mo>
                          </mml:mrow>
                          <mml:mi>t</mml:mi>
                        </mml:msubsup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>Q</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mrow>
                            <mml:mi mathvariant="normal">j</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mo>∙</mml:mo>
                          </mml:mrow>
                          <mml:mi>t</mml:mi>
                        </mml:msubsup>
                      </mml:mfenced>
                      <mml:mo>+</mml:mo>
                      <mml:mi>β</mml:mi>
                      <mml:munder>
                        <mml:mo>∑</mml:mo>
                        <mml:mi>c</mml:mi>
                      </mml:munder>
                      <mml:msubsup>
                        <mml:mi>A</mml:mi>
                        <mml:mrow>
                          <mml:mi>j</mml:mi>
                          <mml:mo>,</mml:mo>
                          <mml:mi>c</mml:mi>
                        </mml:mrow>
                        <mml:mi>t</mml:mi>
                      </mml:msubsup>
                      <mml:mtext>cross</mml:mtext>
                      <mml:mo>−</mml:mo>
                      <mml:mtext>entropy</mml:mtext>
                      <mml:mfenced close=")" open="(" separators=",">
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mi>A</mml:mi>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mrow>
                            <mml:mi>j</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mo>∙</mml:mo>
                          </mml:mrow>
                          <mml:mi>t</mml:mi>
                        </mml:msubsup>
                        <mml:msubsup>
                          <mml:mover accent="true">
                            <mml:mover accent="true">
                              <mml:mi>A</mml:mi>
                              <mml:mo stretchy="true">^</mml:mo>
                            </mml:mover>
                            <mml:mo stretchy="true">→</mml:mo>
                          </mml:mover>
                          <mml:mrow>
                            <mml:mi>j</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mo>∙</mml:mo>
                          </mml:mrow>
                          <mml:mi>t</mml:mi>
                        </mml:msubsup>
                      </mml:mfenced>
                    </mml:mrow>
                  </mml:mfenced>
                </mml:mrow>
              </mml:mfenced>
              <mml:mo>+</mml:mo>
              <mml:mi>λ</mml:mi>
              <mml:msubsup>
                <mml:mfenced close="‖" open="‖">
                  <mml:mi mathvariant="bold-italic">W</mml:mi>
                </mml:mfenced>
                <mml:mi>F</mml:mi>
                <mml:mn>2</mml:mn>
              </mml:msubsup>
            </mml:math>
            <graphic xlink:href="13059_2019_1766_Article_Equx.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
      </p>
      <p id="Par62">We incorporate partial, overlapping, or complete label information by introducing an extra set of terms corresponding to classification loss and weighted by the factor <italic>β</italic>. The classifier loss terms minimize the mean cross-entropy of the predicted and actual cell labels as defined by the second term within each summation of <italic>f</italic>. The adaptation and classifier components <italic>f</italic> are balanced by hyperparameter weights <italic>α</italic> and <italic>β</italic> respectively. Adjusting <italic>α</italic> and <italic>β</italic> allows emphasis to be placed individually on the pairwise cell similarity or known labels; in this work, both weights were fixed to 1.0 when label information is provided.</p>
    </sec>
    <sec id="Sec21">
      <title>Acquisition and preprocessing of Mann et al. benchmark</title>
      <p id="Par63">We obtained the gene count matrix for HSC data generated from Mann et al. [<xref ref-type="bibr" rid="CR37">37</xref>] from GSE100426. The provided data matrix was already filtered based on quality control metrics. We normalized the count matrix to TP10K and then removed plate-specific batch effects by fitting a linear model on the scaled and centered data using Seurat’s NormalizeData and ScaleData functions. We retained the union of the top 3000 variable genes between control and condition cells.</p>
    </sec>
    <sec id="Sec22">
      <title>Acquisition and preprocessing of Kowalczyk et al. benchmark</title>
      <p id="Par64">We obtained the gene count matrix for both C57BL6 and DBA mouse HSC data generated from Kowalczyk et al. [<xref ref-type="bibr" rid="CR36">36</xref>] from GSE59114. Only single cell data from mouse C57BL6 was used during alignment to avoid cross mouse batch effects. We normalized the count matrix to TP10K then scaled and centered using Seurat’s NormalizeData and ScaleData functions. We retained the union of the top 3000 variable genes between young and old cells and genes associated with GO terms reported in Kowalczyk et al.</p>
    </sec>
    <sec id="Sec23">
      <title>Acquisition and preprocessing of CellBench benchmark</title>
      <p id="Par65">We obtained the gene count matrix for the RNA mixture experiments in CellBench generated by Tian et al. [<xref ref-type="bibr" rid="CR35">35</xref>] from the R data file mRNAmix_qc.RData available on GitHub. We normalized the count matrix to TP10K then scaled and centered using Seurat’s NormalizeData and ScaleData functions. We retained the union of the top 3000 variable genes between mixtures profiled on CEL-Seq2 and SORT-Seq.</p>
    </sec>
    <sec id="Sec24">
      <title>Execution of scAlign for benchmark data</title>
      <p id="Par66">We provided scAlign with normalized and scaled gene expression following standard Seurat preprocessing protocols. The most variable genes were identified using FindVariableGenes function implemented in Seurat which was used to subset the data matrices. scAlign was then trained with default parameter settings including 15,000 steps, mini-batch size of 150, perplexity of 30, a 3-layer neural network with 32 dimensions in the final embedding layer.</p>
    </sec>
    <sec id="Sec25">
      <title>Execution of scAlign for <italic>P. falciparum</italic> (malaria parasite) data</title>
      <p id="Par67">We provided scAlign with the top 26 PCs as reported by Poran et al. and available on the Kafsack lab Github. scAlign was then trained for 15,000 steps, mini-batch size of 1000, perplexity of 100, a 3-layer neural network with 32 dimensions in the final embedding layer.</p>
    </sec>
    <sec id="Sec26">
      <title>Execution of scAlign for pancreatic islet data</title>
      <p id="Par68">We provided scAlign with the top 30 canonical correlation vectors as computed by Seurat following the standard preprocessing pipeline. scAlign was then trained with default parameter settings primarily defined by 15,000 steps, mini-batch size of 1000, perplexity of 100, a 3-layer neural network with 64 dimensions in the final embedding layer.</p>
    </sec>
    <sec id="Sec27">
      <title>Execution of other scRNA-seq alignment methods</title>
      <p id="Par69">We compared scAlign against MNN [<xref ref-type="bibr" rid="CR2">2</xref>], Seurat [<xref ref-type="bibr" rid="CR3">3</xref>], scMerge [<xref ref-type="bibr" rid="CR50">50</xref>], Scanorama [<xref ref-type="bibr" rid="CR2">2</xref>], scVI [<xref ref-type="bibr" rid="CR7">7</xref>], MINT [<xref ref-type="bibr" rid="CR1">1</xref>], and scmap [<xref ref-type="bibr" rid="CR5">5</xref>]. Each method was run based on method-specific guidelines provided by the original authors and following the workflow defined by CellBench publicly available on GitHub. Prior to running each method, the FindVariableGenes function implemented in Seurat was used to identify the most variable genes for a consistent subsetting of the following data matrices. MNN was provided log-count data subset to the most variable genes with all parameters set to default. Seurat v2 and v3 were provided the count-level data which was normalized, then scaled and centered using the NormalizeData and ScaleData functions. Initially, 30 canonical correlates were used for dimensionality reduction, then the MetageneBicorPlot function was used to select the optimal number of dimensions as defined by Seurat’s integrated PBMC tutorial. The remaining canonical correlates were aligned using the Seurat v2 AlignSubspace function or Seurat v3 FindIntegrationAnchors and IntegrateData functions. scMerge was provided both count and log-count data along with a set of least variable genes identified by sorting the results of the var. function in R on the normalized count matrix. The parameter kmeansK that specifies the number of clusters was set based on cell type information. Supervised scMerge (scMerge+) was additionally provided cell labels, and the “cell_type_match” parameter was set to true. Scanorama was provided with log-count data subset to the most variable genes previously identified by decompseVar, and return_dense was set to TRUE. scVI was provided with the full count data and trained until convergence based on log likelihood for the best model parameterization identified by grid search (see below). MINT was provided with the log-count data and the cell type labels. scmap was provided the count and log-count data, and both indexCluster and indexCell functions were used to compute cross condition labels.</p>
    </sec>
    <sec id="Sec28">
      <title>Execution of scVI and parameter search</title>
      <p id="Par70">The provided tutorials for scVI varied the input parameters to scVI and did not provide further guidance on how to select parameters. We therefore performed a grid search over scVI parameters and chose the parameter combination that minimized the reported loss. The grid search was performed with respect to number of layers (1, 2, or 3), number of epochs (1000, 2500, or 5000), and learning rate (0.01, 0.001, or 0.0001) (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S22).</p>
    </sec>
    <sec id="Sec29">
      <title>Construction of HeterogeneousBenchmark</title>
      <p id="Par71">We constructed the HeterogeneousBenchmark benchmark by merging multiple count matrices from the Mann et al. and Kowalczyk et al. studies. The control condition was defined completely by young C57BL/6 mouse cells. To construct the stimulated condition, we merged LT-HSCs perturbed by LPS from Mann et al., ST-HSCs from old C57BL/6 mouse cells, and MPPs from both young and old DBA mouse cells collected by Kowalczyk et al.</p>
    </sec>
    <sec id="Sec30">
      <title>Acquisition and preprocessing of <italic>P. falciparum</italic> (malaria parasite) data</title>
      <p id="Par72">We obtained the gene count matrix for the <italic>P. falciparum</italic> data generated by Poran et al. [<xref ref-type="bibr" rid="CR42">42</xref>] from the KafsackLab GitHub repository. The data was preprocessed using the provided scripts and subset into the +/− Shld conditions using the metadata.</p>
    </sec>
    <sec id="Sec31">
      <title>Acquisition and preprocessing of pancreatic islet data</title>
      <p id="Par73">We obtained the gene count matrix for the human pancreatic islet datasets from the following accessions: GSE81076 (CEL-Seq), GSE85241 (CEL-Seq2), GSE86469 (Fluidigm C1), and E-MTAB-5061 (Smart-Seq2). Following preprocessing previously defined by Stuart et al. [<xref ref-type="bibr" rid="CR34">34</xref>], we filtered out cells for which fewer than 1750 unique genes/cell (CEL-Seq) or 2500 genes/cell (CEL-Seq2/Fluidigm C1/Smart-Seq2) were detected.</p>
    </sec>
    <sec id="Sec32">
      <title>Identification of differentially expressed genes</title>
      <p id="Par74">Differentially expressed (DE) genes were computed using the bimod, DESeq2, and MAST methods implemented in the Seurat findMarkers function. The intersection of DE genes with <italic>P</italic> value less than 0.01 from these three methods was used to define a final set of DE genes for each cell type. The analysis was performed on the normalized, scaled, and centered data matrices computed by Seurat’s preprocessing pipeline.</p>
    </sec>
    <sec id="Sec33">
      <title>Identification of robust marker genes</title>
      <p id="Par75">Differentially expressed (DE) genes were computed using bimod [<xref ref-type="bibr" rid="CR51">51</xref>], DESeq2 [<xref ref-type="bibr" rid="CR52">52</xref>], and MAST [<xref ref-type="bibr" rid="CR53">53</xref>] methods implemented in Seurat findMarkers function for each cell type individually for each condition. The union of cell type marker genes with corrected <italic>P</italic> value less than 0.05 was used to define a final set of marker genes for each condition. Additionally, genes which were highly correlated (&gt; 0.9) with the condition-specific marker genes were also included. Finally, we took the intersection of these marker gene sets to define the robust common marker genes across conditions. The analysis was performed on the normalized, scaled, and centered data matrices computed by Seurat’s preprocessing pipeline.</p>
    </sec>
    <sec id="Sec34">
      <title>Construction of matched gene sets</title>
      <p id="Par76">We first computed the mean expression level of all genes and created five approximately equally sized bins representing groups of genes with lowest to highest expression. For the robust common marker gene set, we identified the number of common marker genes that came from each bin. We then created control gene sets by drawing random sets of genes of the same size as the robust common marker set, and with the same distribution of genes over the five bins. We repeated the sampling procedure 10,000 times to obtain a representative collection of matched gene sets.</p>
    </sec>
    <sec id="Sec35">
      <title>Measuring the deviation in cell embeddings by in silico gene set perturbation</title>
      <p id="Par77">To determine the importance of a single gene set to scAlign’s calculation of the embedded representation of each cell, we zeroed out the expression measurements of all genes in the gene set across all cells. We then measure the median and maximum change (using Euclidean distance) in cell embeddings before and after zeroing out the expression measurements. To compute a <italic>P</italic> value, we generated random gene sets of the same size and matched for expression levels of the genes and calculated the number of random gene sets that yielded a deviation at least as large as what we observed for a gene set of interest.</p>
    </sec>
    <sec id="Sec36">
      <title>Measuring the accuracy of pairwise alignments</title>
      <p id="Par78">Alignment performance for each method was measured as a weighted combination of cross-condition label prediction accuracy and alignment score [<xref ref-type="bibr" rid="CR3">3</xref>]. The cross-condition label prediction was performed by training a classifier to label one condition (stimulated condition by default) using only labels from the corresponding control condition. Specifically, a K-nearest neighbors classifier from the R library “class” was initialized with control cell embeddings after alignment, along with their corresponding cell type labels. The classifier was then used to predict labels for the stimulated cells. The predicted labels were compared against heldout labels to measure accuracy. The final score accuracy<sub>composite</sub> is defined by the product of the classifier accuracy and alignment score.</p>
    </sec>
    <sec id="Sec37">
      <title>Measuring the accuracy of multi-way (three or more) alignments</title>
      <p id="Par79">Similarly, to measure alignment performance on the alignment of three or more conditions, we measured the weighted combination of a representative-based label prediction accuracy and alignment score. The representative-based label prediction was performed by iteratively treating each condition as the representative, and training a classifier to label cells from all non-representative conditions using only labels and cells from the single representative condition. The mean accuracy was computed for all condition-specific label predictions as the final accuracy. As a classifier, we chose a K-nearest neighbors classifier from the R library “class” and initialized it with the representative condition cell embeddings after alignment, along with their corresponding cell type labels. The classifier was then used to predict labels for all the non-representative cells. The predicted labels were compared against heldout labels to measure accuracy. The final score accuracy<sub>composite</sub> is defined by the product of the mean accuracy and alignment score.</p>
    </sec>
    <sec id="Sec38">
      <title>Measuring the accuracy of transcriptional interpolation</title>
      <p id="Par80">To measure interpolation accuracy, we measured the ability of a classifier trained on the gene expression data of the cells measured under one condition to correctly label interpolated gene expression profiles of cells sequenced under the other condition (but interpolated into the current condition). A K-nearest neighbors classifier from the R library “class” was initialized with 90% of expression data and tested on the remaining heldout set of 10% to define gene expression-specific accuracy. The classifier was then used to predict the labels for cells represented by interpolated gene expression values to compute an interpolation-specific accuracy. Tenfold cross validation was performed using this procedure, and the average accuracy was reported.</p>
    </sec>
    <sec id="Sec39">
      <title>2D tSNE visualizations of embeddings for alignment methods</title>
      <p id="Par81">By default, we use the Rtsne implementation of tSNE, which first projects input data into 50 principal components before inputting into the tSNE algorithm. All methods other than Seurat and scAlign produce corrected expression matrices, and for these, we use the default 50 PCs for Rtsne. Seurat automatically selects the number of dimensions to project into for each individual condition. scAlign was used to align scRNA-seq data into a 32-dimensional embedding space for all runs. For both Seurat and scAlign, the PCA step of Rtsne was skipped.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Additional files</title>
    <sec id="Sec40">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="13059_2019_1766_MOESM1_ESM.docx">
            <label>Additional file 1:</label>
            <caption>
              <p>Contains supplementary figures, Figures S1–S22 (DOCX 12039 kb)</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="13059_2019_1766_MOESM2_ESM.xls">
            <label>Additional file 2:</label>
            <caption>
              <p>Contains supplementary gene ontology information. (XLS 49 kb)</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="13059_2019_1766_MOESM3_ESM.xls">
            <label>Additional file 3:</label>
            <caption>
              <p>Contains supplementary marker gene information. (XLS 117 kb)</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM4">
          <media xlink:href="13059_2019_1766_MOESM4_ESM.docx">
            <label>Additional file 4:</label>
            <caption>
              <p>Review history. (DOCX 44 kb)</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p>
        <bold>Publisher’s Note</bold>
      </p>
      <p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank Bjorn Kafsack for assisting with the interpretation of the <italic>P. falciparum</italic> data and Manuel Llinás for pointing us to additional <italic>P. falciparum</italic> resources.</p>
    <sec id="FPar1">
      <title>Review history</title>
      <p id="Par82">The review history is available as Additional file <xref rid="MOESM4" ref-type="media">4</xref>.</p>
    </sec>
  </ack>
  <notes notes-type="author-contribution">
    <title>Authors’ contributions</title>
    <p>NJJ and GQ conceived of the study, analyzed and interpreted the data, and wrote the manuscript. NJJ wrote the code for scAlign. Both authors read and approved the final manuscript.</p>
  </notes>
  <notes notes-type="funding-information">
    <title>Funding</title>
    <p>This project has been made possible in part by grant number 2018-182633 from the Chan Zuckerberg Initiative DAF, an advised fund of Silicon Valley Community Foundation. Funding was also provided by NSF CAREER award 1846559 to GQ. The Titan V used for this research was donated by the NVIDIA Corporation.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Availability of data and materials</title>
    <p>The code implementing scAlign, as well as the datasets generated and/or analyzed in this study, is available in the GitHub repository, at <ext-link ext-link-type="uri" xlink:href="https://github.com/quon-titative-biology">https://github.com/quon-titative-biology</ext-link> [<xref ref-type="bibr" rid="CR54">54</xref>] for all systems and on Bioconductor at <ext-link ext-link-type="uri" xlink:href="https://bioconductor.org/packages/release/bioc/html/scAlign.html">https://bioconductor.org/packages/release/bioc/html/scAlign.html</ext-link> for Linux and Mac (starting November 2019). scAlign is released under Apache License 2.0.</p>
  </notes>
  <notes>
    <title>Ethics approval and consent to participate</title>
    <p id="Par83">Not applicable.</p>
  </notes>
  <notes>
    <title>Consent for publication</title>
    <p id="Par84">Not applicable.</p>
  </notes>
  <notes notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par85">The authors declare that they have no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rohart</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Eslami</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Matigian</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Bougeard</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Lê Cao</surname>
            <given-names>K-A</given-names>
          </name>
        </person-group>
        <article-title>MINT: a multivariate integrative method to identify reproducible molecular signatures across independent experiments and platforms</article-title>
        <source>BMC Bioinformatics</source>
        <year>2017</year>
        <volume>18</volume>
        <fpage>128</fpage>
        <pub-id pub-id-type="doi">10.1186/s12859-017-1553-8</pub-id>
        <pub-id pub-id-type="pmid">28241739</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Haghverdi</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Lun</surname>
            <given-names>ATL</given-names>
          </name>
          <name>
            <surname>Morgan</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>Marioni</surname>
            <given-names>JC</given-names>
          </name>
        </person-group>
        <article-title>Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors</article-title>
        <source>Nat Biotechnol</source>
        <year>2018</year>
        <volume>36</volume>
        <fpage>421</fpage>
        <lpage>427</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.4091</pub-id>
        <pub-id pub-id-type="pmid">29608177</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Butler</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Hoffman</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Smibert</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Papalexi</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Integrating single-cell transcriptomic data across different conditions, technologies, and species</article-title>
        <source>Nat Biotechnol</source>
        <year>2018</year>
        <volume>36</volume>
        <fpage>411</fpage>
        <lpage>420</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.4096</pub-id>
        <pub-id pub-id-type="pmid">29608179</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <mixed-citation publication-type="other">Lin Y, et al. scMerge leverages factor analysis, stable expression, and pseudoreplication to merge multiple single-cell RNA-seq datasets. Proc. Natl. Acad. Sci. 2019. 10.1073/pnas.1820006116.</mixed-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kiselev</surname>
            <given-names>VY</given-names>
          </name>
          <name>
            <surname>Yiu</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Hemberg</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>scmap: projection of single-cell RNA-seq data across data sets</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>359</fpage>
        <lpage>362</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4644</pub-id>
        <pub-id pub-id-type="pmid">29608555</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <mixed-citation publication-type="other">Argelaguet R, et al. Multi-Omics factor analysis - a framework for unsupervised integration of multi-omic data sets. bioRxiv. 2018. 10.1101/217554.</mixed-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lopez</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Regier</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Cole</surname>
            <given-names>MB</given-names>
          </name>
          <name>
            <surname>Jordan</surname>
            <given-names>MI</given-names>
          </name>
          <name>
            <surname>Yosef</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Deep generative modeling for single-cell transcriptomics</article-title>
        <source>Nat Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>1053</fpage>
        <lpage>1058</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-018-0229-2</pub-id>
        <pub-id pub-id-type="pmid">30504886</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <mixed-citation publication-type="other">Hie BL, Bryson B, Berger B. Panoramic stitching of heterogeneous single-cell transcriptomic data. bioRxiv. 2018. 10.1101/371179.</mixed-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kiselev</surname>
            <given-names>VY</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>SC3: consensus clustering of single-cell RNA-seq data</article-title>
        <source>Nat Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>483</fpage>
        <lpage>486</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4236</pub-id>
        <pub-id pub-id-type="pmid">28346451</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ji</surname>
            <given-names>Zhicheng</given-names>
          </name>
          <name>
            <surname>Ji</surname>
            <given-names>Hongkai</given-names>
          </name>
        </person-group>
        <article-title>TSCAN: Pseudo-time reconstruction and evaluation in single-cell RNA-seq analysis</article-title>
        <source>Nucleic Acids Research</source>
        <year>2016</year>
        <volume>44</volume>
        <issue>13</issue>
        <fpage>e117</fpage>
        <lpage>e117</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkw430</pub-id>
        <pub-id pub-id-type="pmid">27179027</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Trapnell</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The dynamics and regulators of cell fate decisions are revealed by pseudotemporal ordering of single cells</article-title>
        <source>Nat Biotechnol</source>
        <year>2014</year>
        <volume>32</volume>
        <fpage>381</fpage>
        <lpage>386</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.2859</pub-id>
        <pub-id pub-id-type="pmid">24658644</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Qiu</surname>
            <given-names>X</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Reversed graph embedding resolves complex single-cell trajectories</article-title>
        <source>Nat Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>979</fpage>
        <lpage>982</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4402</pub-id>
        <pub-id pub-id-type="pmid">28825705</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Risso</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Ngai</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Speed</surname>
            <given-names>TP</given-names>
          </name>
          <name>
            <surname>Dudoit</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Normalization of RNA-seq data using factor analysis of control genes or samples</article-title>
        <source>Nat Biotechnol</source>
        <year>2014</year>
        <volume>32</volume>
        <fpage>896</fpage>
        <lpage>902</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.2931</pub-id>
        <pub-id pub-id-type="pmid">25150836</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lawlor</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell transcriptomes identify human islet cell signatures and reveal cell-type-specific expression changes in type 2 diabetes</article-title>
        <source>Genome Res</source>
        <year>2017</year>
        <volume>27</volume>
        <fpage>208</fpage>
        <lpage>222</lpage>
        <pub-id pub-id-type="doi">10.1101/gr.212720.116</pub-id>
        <pub-id pub-id-type="pmid">27864352</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Muraro</surname>
            <given-names>MJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A single-cell transcriptome atlas of the human pancreas</article-title>
        <source>Cell Syst</source>
        <year>2016</year>
        <volume>3</volume>
        <fpage>385</fpage>
        <lpage>394</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2016.09.002</pub-id>
        <pub-id pub-id-type="pmid">27693023</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Segerstolpe</surname>
            <given-names>Å</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell transcriptome profiling of human pancreatic islets in health and type 2 diabetes</article-title>
        <source>Cell Metab</source>
        <year>2016</year>
        <volume>24</volume>
        <fpage>593</fpage>
        <lpage>607</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cmet.2016.08.020</pub-id>
        <pub-id pub-id-type="pmid">27667667</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Büttner</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Miao</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Teichmann</surname>
            <given-names>SA</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>A test metric for assessing single-cell RNA-seq batch correction</article-title>
        <source>Nat Methods</source>
        <year>2019</year>
        <volume>16</volume>
        <fpage>43</fpage>
        <pub-id pub-id-type="doi">10.1038/s41592-018-0254-1</pub-id>
        <pub-id pub-id-type="pmid">30573817</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stuart</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Integrative single-cell analysis</article-title>
        <source>Nat Rev Genet</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>257</fpage>
        <pub-id pub-id-type="doi">10.1038/s41576-019-0093-7</pub-id>
        <pub-id pub-id-type="pmid">30696980</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Subramanian</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A next generation connectivity map: L1000 platform and the first 1,000,000 profiles</article-title>
        <source>Cell</source>
        <year>2017</year>
        <volume>171</volume>
        <fpage>1437</fpage>
        <lpage>1452</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2017.10.049</pub-id>
        <pub-id pub-id-type="pmid">29195078</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Datlinger</surname>
            <given-names>P</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Pooled CRISPR screening with single-cell transcriptome readout</article-title>
        <source>Nat Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>297</fpage>
        <lpage>301</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4177</pub-id>
        <pub-id pub-id-type="pmid">28099430</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dixit</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Perturb-Seq: dissecting molecular circuits with scalable single-cell RNA profiling of pooled genetic screens</article-title>
        <source>Cell</source>
        <year>2016</year>
        <volume>167</volume>
        <fpage>1853</fpage>
        <lpage>1866</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2016.11.038</pub-id>
        <pub-id pub-id-type="pmid">27984732</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Jaitin</surname>
            <given-names>DA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Dissecting immune circuits by linking CRISPR-pooled screens with single-cell RNA-Seq</article-title>
        <source>Cell</source>
        <year>2016</year>
        <volume>167</volume>
        <fpage>1883</fpage>
        <lpage>1896</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2016.11.039</pub-id>
        <pub-id pub-id-type="pmid">27984734</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <mixed-citation publication-type="other">Hodge RD, et al. Conserved cell types with divergent features between human and mouse cortex. bioRxiv. 2018. 10.1101/384826.</mixed-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hon</surname>
            <given-names>C-C</given-names>
          </name>
          <name>
            <surname>Shin</surname>
            <given-names>JW</given-names>
          </name>
          <name>
            <surname>Carninci</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Stubbington</surname>
            <given-names>MJT</given-names>
          </name>
        </person-group>
        <article-title>The human cell atlas: technical approaches and challenges</article-title>
        <source>Brief Funct Genomics</source>
        <year>2018</year>
        <volume>17</volume>
        <fpage>283</fpage>
        <lpage>294</lpage>
        <pub-id pub-id-type="doi">10.1093/bfgp/elx029</pub-id>
        <pub-id pub-id-type="pmid">29092000</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <collab>Tabula Muris Consortium</collab>
          <etal/>
        </person-group>
        <article-title>Single-cell transcriptomics of 20 mouse organs creates a Tabula Muris</article-title>
        <source>Nature</source>
        <year>2018</year>
        <volume>562</volume>
        <fpage>367</fpage>
        <lpage>372</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-018-0590-4</pub-id>
        <pub-id pub-id-type="pmid">30283141</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Vento-Tormo</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell reconstruction of the early maternal-fetal interface in humans</article-title>
        <source>Nature</source>
        <year>2018</year>
        <volume>563</volume>
        <fpage>347</fpage>
        <lpage>353</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-018-0698-6</pub-id>
        <pub-id pub-id-type="pmid">30429548</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Moffitt</surname>
            <given-names>Jeffrey R.</given-names>
          </name>
          <name>
            <surname>Bambah-Mukku</surname>
            <given-names>Dhananjay</given-names>
          </name>
          <name>
            <surname>Eichhorn</surname>
            <given-names>Stephen W.</given-names>
          </name>
          <name>
            <surname>Vaughn</surname>
            <given-names>Eric</given-names>
          </name>
          <name>
            <surname>Shekhar</surname>
            <given-names>Karthik</given-names>
          </name>
          <name>
            <surname>Perez</surname>
            <given-names>Julio D.</given-names>
          </name>
          <name>
            <surname>Rubinstein</surname>
            <given-names>Nimrod D.</given-names>
          </name>
          <name>
            <surname>Hao</surname>
            <given-names>Junjie</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>Aviv</given-names>
          </name>
          <name>
            <surname>Dulac</surname>
            <given-names>Catherine</given-names>
          </name>
          <name>
            <surname>Zhuang</surname>
            <given-names>Xiaowei</given-names>
          </name>
        </person-group>
        <article-title>Molecular, spatial, and functional single-cell profiling of the hypothalamic preoptic region</article-title>
        <source>Science</source>
        <year>2018</year>
        <volume>362</volume>
        <issue>6416</issue>
        <fpage>eaau5324</fpage>
        <pub-id pub-id-type="doi">10.1126/science.aau5324</pub-id>
        <pub-id pub-id-type="pmid">30385464</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Plasschaert</surname>
            <given-names>LW</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A single-cell atlas of the airway epithelium reveals the CFTR-rich pulmonary ionocyte</article-title>
        <source>Nature</source>
        <year>2018</year>
        <volume>560</volume>
        <fpage>377</fpage>
        <lpage>381</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-018-0394-6</pub-id>
        <pub-id pub-id-type="pmid">30069046</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hicks</surname>
            <given-names>SC</given-names>
          </name>
          <name>
            <surname>Townes</surname>
            <given-names>FW</given-names>
          </name>
          <name>
            <surname>Teng</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Irizarry</surname>
            <given-names>RA</given-names>
          </name>
        </person-group>
        <article-title>Missing data and technical variability in single-cell RNA-sequencing experiments</article-title>
        <source>Biostat Oxf Engl</source>
        <year>2018</year>
        <volume>19</volume>
        <fpage>562</fpage>
        <lpage>578</lpage>
        <pub-id pub-id-type="doi">10.1093/biostatistics/kxx053</pub-id>
      </element-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Buettner</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Computational analysis of cell-to-cell heterogeneity in single-cell RNA-sequencing data reveals hidden subpopulations of cells</article-title>
        <source>Nat Biotechnol</source>
        <year>2015</year>
        <volume>33</volume>
        <fpage>155</fpage>
        <lpage>160</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.3102</pub-id>
        <pub-id pub-id-type="pmid">25599176</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Shalek</surname>
            <given-names>AK</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell RNA-seq reveals dynamic paracrine control of cellular variation</article-title>
        <source>Nature</source>
        <year>2014</year>
        <volume>510</volume>
        <fpage>363</fpage>
        <lpage>369</lpage>
        <pub-id pub-id-type="doi">10.1038/nature13437</pub-id>
        <pub-id pub-id-type="pmid">24919153</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Eldar</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Elowitz</surname>
            <given-names>MB</given-names>
          </name>
        </person-group>
        <article-title>Functional roles for noise in genetic circuits</article-title>
        <source>Nature</source>
        <year>2010</year>
        <volume>467</volume>
        <fpage>167</fpage>
        <lpage>173</lpage>
        <pub-id pub-id-type="doi">10.1038/nature09326</pub-id>
        <pub-id pub-id-type="pmid">20829787</pub-id>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Maamar</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Raj</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Dubnau</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>Noise in gene expression determines cell fate in Bacillus subtilis</article-title>
        <source>Science</source>
        <year>2007</year>
        <volume>317</volume>
        <fpage>526</fpage>
        <lpage>529</lpage>
        <pub-id pub-id-type="doi">10.1126/science.1140818</pub-id>
        <pub-id pub-id-type="pmid">17569828</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <mixed-citation publication-type="other">Stuart T, et al. Comprehensive integration of single cell data. bioRxiv. 2018. 10.1101/460147.</mixed-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <mixed-citation publication-type="other">Tian L, et al. scRNA-seq mixology: towards better benchmarking of single cell RNA-seq protocols and analysis methods. bioRxiv. 2018. 10.1101/433102.</mixed-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kowalczyk</surname>
            <given-names>MS</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell RNA-seq reveals changes in cell cycle and differentiation programs upon aging of hematopoietic stem cells</article-title>
        <source>Genome Res</source>
        <year>2015</year>
        <volume>25</volume>
        <fpage>1860</fpage>
        <lpage>1872</lpage>
        <pub-id pub-id-type="doi">10.1101/gr.192237.115</pub-id>
        <pub-id pub-id-type="pmid">26430063</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <mixed-citation publication-type="other">Mann M, et al. Heterogeneous responses of hematopoietic stem cells to inflammatory stimuli are altered with age. bioRxiv. 2017. 10.1101/163402.</mixed-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Trapnell</surname>
            <given-names>C</given-names>
          </name>
        </person-group>
        <article-title>Defining cell types and states with single-cell genomics</article-title>
        <source>Genome Res</source>
        <year>2015</year>
        <volume>25</volume>
        <fpage>1491</fpage>
        <lpage>1498</lpage>
        <pub-id pub-id-type="doi">10.1101/gr.190595.115</pub-id>
        <pub-id pub-id-type="pmid">26430159</pub-id>
      </element-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ji</surname>
            <given-names>Zhicheng</given-names>
          </name>
          <name>
            <surname>Ji</surname>
            <given-names>Hongkai</given-names>
          </name>
        </person-group>
        <article-title>TSCAN: Pseudo-time reconstruction and evaluation in single-cell RNA-seq analysis</article-title>
        <source>Nucleic Acids Research</source>
        <year>2016</year>
        <volume>44</volume>
        <issue>13</issue>
        <fpage>e117</fpage>
        <lpage>e117</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkw430</pub-id>
        <pub-id pub-id-type="pmid">27179027</pub-id>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Setty</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Wishbone identifies bifurcating developmental trajectories from single-cell data</article-title>
        <source>Nat Biotechnol</source>
        <year>2016</year>
        <volume>34</volume>
        <fpage>637</fpage>
        <lpage>645</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.3569</pub-id>
        <pub-id pub-id-type="pmid">27136076</pub-id>
      </element-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Welch</surname>
            <given-names>JD</given-names>
          </name>
          <name>
            <surname>Hartemink</surname>
            <given-names>AJ</given-names>
          </name>
          <name>
            <surname>Prins</surname>
            <given-names>JF</given-names>
          </name>
        </person-group>
        <article-title>SLICER: inferring branched, nonlinear cellular trajectories from single cell RNA-seq data</article-title>
        <source>Genome Biol</source>
        <year>2016</year>
        <volume>17</volume>
        <fpage>106</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-016-0975-3</pub-id>
        <pub-id pub-id-type="pmid">27215581</pub-id>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Poran</surname>
            <given-names>Asaf</given-names>
          </name>
          <name>
            <surname>Nötzel</surname>
            <given-names>Christopher</given-names>
          </name>
          <name>
            <surname>Aly</surname>
            <given-names>Omar</given-names>
          </name>
          <name>
            <surname>Mencia-Trinchant</surname>
            <given-names>Nuria</given-names>
          </name>
          <name>
            <surname>Harris</surname>
            <given-names>Chantal T.</given-names>
          </name>
          <name>
            <surname>Guzman</surname>
            <given-names>Monica L.</given-names>
          </name>
          <name>
            <surname>Hassane</surname>
            <given-names>Duane C.</given-names>
          </name>
          <name>
            <surname>Elemento</surname>
            <given-names>Olivier</given-names>
          </name>
          <name>
            <surname>Kafsack</surname>
            <given-names>Björn F. C.</given-names>
          </name>
        </person-group>
        <article-title>Single-cell RNA sequencing reveals a signature of sexual commitment in malaria parasites</article-title>
        <source>Nature</source>
        <year>2017</year>
        <volume>551</volume>
        <issue>7678</issue>
        <fpage>95</fpage>
        <lpage>99</lpage>
        <pub-id pub-id-type="doi">10.1038/nature24280</pub-id>
        <pub-id pub-id-type="pmid">29094698</pub-id>
      </element-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <mixed-citation publication-type="other">Josling, G. A. et al. Regulation of sexual differentiation is linked to invasion in malaria parasites. Microbiology 2019. doi:10.1101/533877</mixed-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bancells</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Revisiting the initial steps of sexual development in the malaria parasite Plasmodium falciparum</article-title>
        <source>Nat Microbiol</source>
        <year>2019</year>
        <volume>4</volume>
        <fpage>144</fpage>
        <lpage>154</lpage>
        <pub-id pub-id-type="doi">10.1038/s41564-018-0291-7</pub-id>
        <pub-id pub-id-type="pmid">30478286</pub-id>
      </element-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Haeusser</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Mordvintsev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Cremers</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>Learning by association - a versatile semi-supervised training method for neural networks</article-title>
        <source>IEEE Conference on Computer Vision and Pattern Recognition (CVPR)</source>
        <year>2017</year>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Haeusser</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Frerix</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Mordvintsev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Cremers</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>Associative domain adaptation</article-title>
        <source>IEEE International Conference on Computer Vision (ICCV)</source>
        <year>2017</year>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>van der Maaten</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Hinton</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Visualizing Data using t-SNE</article-title>
        <source>J Mach Learn Res</source>
        <year>2008</year>
        <volume>9</volume>
        <fpage>2579</fpage>
        <lpage>2605</lpage>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Glorot</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Bengio</surname>
            <given-names>Y</given-names>
          </name>
        </person-group>
        <person-group person-group-type="editor">
          <name>
            <surname>Teh</surname>
            <given-names>YW</given-names>
          </name>
          <name>
            <surname>Titterington</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Understanding the difficulty of training deep feedforward neural networks</article-title>
        <source>Proceedings of the Thirteenth International Conference on Artificial Intelligence and Statistics</source>
        <year>2010</year>
        <fpage>249</fpage>
        <lpage>256</lpage>
      </element-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <mixed-citation publication-type="other">Kingma DP, Ba J. Adam: A method for stochastic optimization. 2014. arXiv preprint arXiv:1412.6980.</mixed-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <mixed-citation publication-type="other">Lin Y, et al. scMerge: integration of multiple single-cell transcriptomics datasets leveraging stable expression and pseudo-replication. bioRxiv. 2018. 10.1101/393280.</mixed-citation>
    </ref>
    <ref id="CR51">
      <label>51.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>McDavid</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Data exploration, quality control and testing in single-cell qPCR-based gene expression experiments</article-title>
        <source>Bioinforma Oxf Engl</source>
        <year>2013</year>
        <volume>29</volume>
        <fpage>461</fpage>
        <lpage>467</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/bts714</pub-id>
      </element-citation>
    </ref>
    <ref id="CR52">
      <label>52.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Love</surname>
            <given-names>MI</given-names>
          </name>
          <name>
            <surname>Huber</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Anders</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Moderated estimation of fold change and dispersion for RNA-seq data with DESeq2</article-title>
        <source>Genome Biol</source>
        <year>2014</year>
        <volume>15</volume>
        <fpage>550</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-014-0550-8</pub-id>
        <pub-id pub-id-type="pmid">25516281</pub-id>
      </element-citation>
    </ref>
    <ref id="CR53">
      <label>53.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Finak</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>MAST: a flexible statistical framework for assessing transcriptional changes and characterizing heterogeneity in single-cell RNA sequencing data</article-title>
        <source>Genome Biol</source>
        <year>2015</year>
        <volume>16</volume>
        <fpage>278</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-015-0844-5</pub-id>
        <pub-id pub-id-type="pmid">26653891</pub-id>
      </element-citation>
    </ref>
    <ref id="CR54">
      <label>54.</label>
      <mixed-citation publication-type="other">Johansen NJ, Quon G. scAlign R code. Zenodo. 10.5281/zenodo.3339657.</mixed-citation>
    </ref>
  </ref-list>
</back>
