<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Genome Biol</journal-id>
    <journal-id journal-id-type="iso-abbrev">Genome Biol</journal-id>
    <journal-title-group>
      <journal-title>Genome Biology</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1474-7596</issn>
    <issn pub-type="epub">1474-760X</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6790056</article-id>
    <article-id pub-id-type="publisher-id">1812</article-id>
    <article-id pub-id-type="doi">10.1186/s13059-019-1812-2</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Method</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>MetaCell: analysis of single-cell RNA-seq data using <italic>K</italic>-nn graph partitions</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Baran</surname>
          <given-names>Yael</given-names>
        </name>
        <address>
          <email>yael.baran@weizmann.ac.il</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Bercovich</surname>
          <given-names>Akhiad</given-names>
        </name>
        <address>
          <email>akhiad.bercovich@weizmann.ac.il</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Sebe-Pedros</surname>
          <given-names>Arnau</given-names>
        </name>
        <address>
          <email>arnau.sebe@crg.eu</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Lubling</surname>
          <given-names>Yaniv</given-names>
        </name>
        <address>
          <email>yaniv.lubling@weizmann.ac.il</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Giladi</surname>
          <given-names>Amir</given-names>
        </name>
        <address>
          <email>amir.goldberg@weizmann.ac.il</email>
        </address>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Chomsky</surname>
          <given-names>Elad</given-names>
        </name>
        <address>
          <email>elad@chomsky.me</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Meir</surname>
          <given-names>Zohar</given-names>
        </name>
        <address>
          <email>zohar.meir@weizmann.ac.il</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Hoichman</surname>
          <given-names>Michael</given-names>
        </name>
        <address>
          <email>misha@hoichman.com</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Lifshitz</surname>
          <given-names>Aviezer</given-names>
        </name>
        <address>
          <email>aviezer.lifshitz@weizmann.ac.il</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <name>
          <surname>Tanay</surname>
          <given-names>Amos</given-names>
        </name>
        <address>
          <email>amos.tanay@weizmann.ac.il</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 0604 7563</institution-id><institution-id institution-id-type="GRID">grid.13992.30</institution-id><institution>Department of Computer Science and Applied Mathematics, </institution><institution>Weizmann Institute of Science, </institution></institution-wrap>Rehovot, Israel </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 0604 7563</institution-id><institution-id institution-id-type="GRID">grid.13992.30</institution-id><institution>Department of Immunology, </institution><institution>Weizmann Institute of Science, </institution></institution-wrap>Rehovot, Israel </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>11</day>
      <month>10</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>11</day>
      <month>10</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2019</year>
    </pub-date>
    <volume>20</volume>
    <elocation-id>206</elocation-id>
    <history>
      <date date-type="received">
        <day>18</day>
        <month>4</month>
        <year>2019</year>
      </date>
      <date date-type="accepted">
        <day>3</day>
        <month>9</month>
        <year>2019</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s). 2019</copyright-statement>
      <license license-type="OpenAccess">
        <license-p><bold>Open Access</bold>This article is distributed under the terms of the Creative Commons Attribution 4.0 International License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted use, distribution, and reproduction in any medium, provided you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The Creative Commons Public Domain Dedication waiver (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/publicdomain/zero/1.0/">http://creativecommons.org/publicdomain/zero/1.0/</ext-link>) applies to the data made available in this article, unless otherwise stated.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">scRNA-seq profiles each represent a highly partial sample of mRNA molecules from a unique cell that can never be resampled, and robust analysis must separate the sampling effect from biological variance. We describe a methodology for partitioning scRNA-seq datasets into <italic>metacells</italic>: disjoint and homogenous groups of profiles that could have been resampled from the same cell. Unlike clustering analysis, our algorithm specializes at obtaining granular as opposed to maximal groups. We show how to use metacells as building blocks for complex quantitative transcriptional maps while avoiding data smoothing. Our algorithms are implemented in the <italic>MetaCell</italic> R/C++ software package.</p>
    </abstract>
    <kwd-group xml:lang="en">
      <title>Keywords</title>
      <kwd>RNA-seq</kwd>
      <kwd>scRNA-seq</kwd>
      <kwd>Graph partition</kwd>
      <kwd>Multinomial distribution</kwd>
      <kwd>Sampling variance</kwd>
      <kwd>Clustering</kwd>
      <kwd>Smoothing</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100010663</institution-id>
            <institution>H2020 European Research Council</institution>
          </institution-wrap>
        </funding-source>
        <award-id>724824</award-id>
        <principal-award-recipient>
          <name>
            <surname>Tanay</surname>
            <given-names>Amos</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Chan Zuckerberg Association</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001320</institution-id>
            <institution>Wolfson Foundation</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>FAMRI</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2019</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Background</title>
    <p id="Par2">Single-cell RNA-seq (scRNA-seq) is used extensively for discovery and identification of cell types, for characterizing transcriptional states within them, and for inference of continuous gene expression gradients linking these states. These phenomenological observations are used for creating cell type atlases and as a starting point for analysis of different cellular processes, including differentiation, cell cycle, and response to stimuli [<xref ref-type="bibr" rid="CR1">1</xref>–<xref ref-type="bibr" rid="CR9">9</xref>] (reviewed in [<xref ref-type="bibr" rid="CR10">10</xref>]). The advent of scRNA-seq increased the resolution of models for transcriptional regulation by orders of magnitude compared to prior bulk methods, allowing precise and unbiased analysis of small cell populations as well as opening the way to quantitative modeling of subtle within-population effects.</p>
    <p id="Par3">As technology matures, the analytical basis for interpreting scRNA-seq experiments must become more principled. In a way similar to other experimental strategies aiming at improved resolution, scRNA-seq relies on the ability to integrate a large number of highly noisy measurements for inferring a high-resolution model of some target sample. In analogy, when performing optimal reconstruction of a microscopic sample, a typical microscopic sensor can reduce noise by resampling the same pixel or voxel, trading instrument time with precision and resolution. In scRNA-seq, the major source of technical noise (not to be confused with various systematic biases) is introduced through partial sampling of some 1000–10,000 RNA-molecules from the pool of RNA within a cell, generating a highly discrete and noisy estimation for the concentration of any RNA species in this cell except very few super-high abundance genes. In contrast to the microscopy analogy, the same cell cannot be revisited and resampled to decrease sampling noise, since scRNA-seq technology involves lysing the cell. Instead, integration of data from different cells must be used to simultaneously capture the true biological variance among cells and the purely technical sampling variance of the experiment.</p>
    <p id="Par4">When scRNA analysis is tuned toward cell type detection [<xref ref-type="bibr" rid="CR6">6</xref>, <xref ref-type="bibr" rid="CR11">11</xref>], the implicit model assumption is that single cells derived from the same transcriptional cluster are approximately identical. In this case, sampling noise can be overcome by pooling the molecules from a sufficiently large number of cells, such that the expected number of sampled transcripts (or unique molecular identifiers (UMIs)) from each significantly expressed gene allows precise inference of the concentration of this RNA species in the idealized cell state that the cluster represents. When aiming at modeling more subtle molecular states, in particular those involving dynamics of cellular differentiation or response to stimuli, the clustering state homogeneity assumption can no longer hold. In these scenarios, current techniques combine handling of sparse data with modeling (implicitly or explicitly) of cellular dynamics [<xref ref-type="bibr" rid="CR3">3</xref>, <xref ref-type="bibr" rid="CR12">12</xref>–<xref ref-type="bibr" rid="CR24">24</xref>]. Inference of robust cell-to-cell similarity metrics from sparse data is commonly used for construction of <italic>K</italic>-nn graphs over which dynamics are inferred. Smoothing sparse data [<xref ref-type="bibr" rid="CR25">25</xref>–<xref ref-type="bibr" rid="CR27">27</xref>] or imputation of transcriptional states [<xref ref-type="bibr" rid="CR25">25</xref>, <xref ref-type="bibr" rid="CR28">28</xref>–<xref ref-type="bibr" rid="CR30">30</xref>] was proposed as a possible pre-process for modeling similarity in the data. Model-based inference of transcriptional states from sparse data is on the other hand still difficult to derive, since parametric models for single-cell RNA-seq data are lacking. Even though a basic parametric model for the sampling noise in scRNA-seq profiles can be easily assumed, it is not routinely explicitly integrated within a broader context of model inference from scRNA-seq data.</p>
    <p id="Par5">In this paper, we introduce the notion of <italic>metacells</italic> and develop a methodology for inferring and using them. A metacell (abbreviated MC) is in theory a group of scRNA-seq cell profiles that are statistically equivalent to samples derived from the same RNA pool. Such profiles should therefore be distributed multinomially with predictable variance per gene (approximately proportional to the mean) and near zero gene-gene covariance. Moreover, given a set of scRNA-seq profiles that are derived from the same multinomial distribution, it is trivial to infer the model parameters and establish their statistical confidence. If an entire scRNA-seq dataset could be decomposed into disjoint metacells with sufficient coverage per metacell, many difficulties that follow from the sparsity of the data would be circumvented. In practice, one cannot assume a perfect metacell cover of the scRNA-seq dataset a priori, and we found that directly searching for metacells using a parametric approach is highly sensitive to the many intricacies and biases of the data. Instead, we propose to use non-parametric cell-to-cell similarities and partition the resulting <italic>K</italic>-nn similarity graphs into densely connected subgraphs, which are filtered to derive approximately multinomial metacells. Metacells can then serve as building blocks for describing complex gene expression distributions with minimal parametric assumptions, scaling well with the number of cells and providing a more accurate approximation when increasing the number of sampled cells.</p>
    <p id="Par6">We implemented tools for deriving metacells and analyzing scRNA-seq data using them in the new R/C++ package MetaCell. The utility of the approach was recently demonstrated in scenarios involving analysis of mammalian hematopoiesis differentiation [<xref ref-type="bibr" rid="CR31">31</xref>], immunotherapy [<xref ref-type="bibr" rid="CR32">32</xref>], blood cancer [<xref ref-type="bibr" rid="CR33">33</xref>], and inference of cell type decompositions in comparative whole organism scRNA-seq [<xref ref-type="bibr" rid="CR34">34</xref>, <xref ref-type="bibr" rid="CR35">35</xref>]. Here we perform in-depth analysis of the model and its performance through re-analysis of datasets including 8000 and 160,000 peripheral blood mononuclear cells (PBMC), and by dissecting two whole-organism single-cell RNA-seq maps from two worm species. The data show that metacells approximate the expression distribution in a surprisingly accurate fashion, dissecting the dataset into truly homogenous local neighborhoods and providing quantitative building blocks for exploring the global expression manifold. We suggest that MetaCell provides, especially as the size of single-cell atlases increases, an attractive universal first layer of analysis on top of which quantitative and dynamic analysis can be developed further.</p>
  </sec>
  <sec id="Sec2">
    <title>Results</title>
    <sec id="Sec3">
      <title>Overview of the MetaCell method</title>
      <p id="Par7">The MetaCell construction pipeline partitions an scRNA-seq dataset into disjoint cell groups using a non-parametric graph algorithm (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a). This partition provides initial metacells that can later be pruned and filtered for homogeneity. First, feature genes are selected and used to compute a raw cell-to-cell similarity matrix <italic>S</italic>. Second, a balanced <italic>K</italic>-nn similarity graph <italic>G</italic> is constructed, connecting pairs of cells that represent reciprocally high-ranking neighbors. In contrast to a <italic>K</italic>-nn graph built directly from <italic>S</italic>, which can be highly non-symmetric, the graph <italic>G</italic> has more balanced ingoing and outgoing degrees. Third, <italic>G</italic> is subsampled multiple times, and each time the graph is partitioned into dense subgraphs using an efficient algorithm. The number of times each pair of cells co-occurred in the same subgraph is used to define the resampled graph <italic>G</italic><sup><italic>boot</italic></sup>. After these three layers of cell-to-cell similarity matrix normalization, the metacell solution is derived using a graph partitioning algorithm applied to <italic>G</italic><sup><italic>boot</italic></sup>.
<fig id="Fig1"><label>Fig. 1</label><caption><p>Metacell analysis of the PBMC 8K dataset. <bold>a</bold> Schematics of the MC algorithmic pipeline. <bold>b</bold> Outlier/rare cells matrix showing color-coded number of UMIs per cells (columns) for which at least one gene (rows) was shown to be expressed significantly beyond its MC expected number of UMIs. Outlier/rare cells are ordered according to the annotation of the MC containing them (bottom color-coded bars). <bold>c</bold> Shown are log-fold-enrichment (lfp, methods) values for metacells, color-coded according to initial cell type annotation, comparing the T cell marker (CD3D) to a B cell (CD79A) and myeloid (LYZ) markers. <bold>d</bold> Heat map shows enrichment values for metacells (columns) and their maximally enriched gene markers. <bold>e</bold> Shown is the MC adjacency graph (numbered nodes connected by edges), color-coded according to their cell type and transcriptional state annotation. Cells are shown as small color-coded points localized according to the coordinates of MCs adjacent to them. Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S3 shows the adjacency matrix that was used to generate the projection</p></caption><graphic xlink:href="13059_2019_1812_Fig1_HTML" id="MO1"/></fig></p>
      <p id="Par8">After the initial construction of a graph partition, we perform pruning and filtering of metacells to increase their homogeneity. We do not enforce a strict multinomial model as empirical data only approximately supports it (see in-depth analysis below), and instead ensure that clear violations of homogeneity are filtered. First, outliers are detected and filtered using a simple parametric test for gene overexpression compared to their metacell. Second, the metacells’ homogeneity is verified, and metacells showing strong sub-cluster structure are split. In practice, splitting is rarely necessary, but outlier detection may require parameter tuning (see Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1). Third, metacells representing doublets (composed of groups of profiles that share a similar doublet mixture) are searched for and filtered in a supervised manner. Most of the doublets, however, are identified as such during the outlier filtering stage.</p>
      <p id="Par9">Figure <xref rid="Fig1" ref-type="fig">1</xref>a illustrates different types of metacells that are obtained in different experimental scenarios. When a limited number of single cells are sampled from a highly distinct transcriptional behavior, a metacell may define a completely isolated cluster (type I MCs). When a larger number of cells are sampled from a cell state, several metacells may cover it, defining variation in secondary biological behaviors (e.g., cell cycle) or even equivalent transcriptional distributions (type II MCs). More informatively, when sampling a dynamic process that induces a transcriptional gradient across single cells, metacells may create a piecewise approximation of the process (type III MCs). We note that in the latter cases, the MC cover need not be uniquely defined.</p>
      <p id="Par10">Based on a filtered set of metacells, we can robustly explore the scRNA-seq transcription manifold, performing marker-based annotation of the metacells, grouping of metacells into higher-order clusters, and visualizing the data by projecting metacells onto a 2D space. In essence, the analysis downstream the identification of metacells is similar to common scRNA-seq strategies, but replacing sparse single cells, or smoothed single cells, with fewer but more robust metacell profiles.</p>
      <p id="Par11">MetaCell is readily applicable as an R/C++ package and is scalable to large datasets. The full method and implementation details are given in the “<xref rid="Sec14" ref-type="sec">Methods</xref>” section. Information on feature selection is provided in Additional file <xref rid="MOESM3" ref-type="media">3</xref>.</p>
    </sec>
    <sec id="Sec4">
      <title>Metacells eliminate outliers and reconstruct cell type structure in PBMC data</title>
      <p id="Par12">We first illustrate the use of the MetaCell algorithm and pipeline through re-analysis of a small (<italic>n</italic> = 8276) dataset of PBMC scRNA-seq profiles sampled from a healthy donor and downloaded from the 10x website. In a pre-processing step (see Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S1), we removed cells with less than 800 UMIs (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S1A) and several non-coding RNAs linked with stress or apoptotic signatures (“blacklisted genes”) (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S1B). We then applied the metacell construction pipeline as outlined above, using 816 high variance genes as features (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S1C, excluding ribosomal proteins) and deriving an initial set of 82 MCs following 1000 resampling iterations using <italic>K</italic> = 100. The MC outlier/rare cell detection screen then identified 182 cells with at least one outlier gene (8-fold or more enrichment over the respective MC model) (Fig. <xref rid="Fig1" ref-type="fig">1</xref>b, Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S2). Most outlier cells showed potential doublet profiles, co-expressing genes associated with two different cell types. For example, this effect was notable in the association of a coherent megakaryocytic gene module (including PF4, PPBP and more genes) with signatures linked to other cell types. In fact, pure megakaryocyte expression profiles are very rare in the data, and the MC outlier analysis highlights their identification (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S2). In addition to potential doublets, outlier cells also included representatives of rare cell types, including cells expressing progenitor markers (SOX4 [<xref ref-type="bibr" rid="CR36">36</xref>]) or eosinophilic markers (MS4A2, MS4A3 [<xref ref-type="bibr" rid="CR37">37</xref>]).</p>
      <p id="Par13">Doublet outlier cells are observed when two cell types are mixed rarely in the data, thereby contaminating a metacell associated with one cell type with a few mixed signatures. More frequent doublet scenarios can give rise to homogeneous doublet MCs, as we observed for two cases combining expression of T cell marker genes (e.g., CD3D) with either B cell (CD79A) or monocyte (LYZ) markers (Fig. <xref rid="Fig1" ref-type="fig">1</xref>c). Following the removal of these two doublet MCs, we ended up with a model organizing 7901 cells in 80 MCs (45–176 cells per MC, median size 95 cells) and marking 375 cells as outliers or doublets. This model was annotated using enriched gene markers (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S3) and visualized using a marker heat map (Fig. <xref rid="Fig1" ref-type="fig">1</xref>d) and a 2D layout computed from the MC adjacency matrix (Fig. <xref rid="Fig1" ref-type="fig">1</xref>e). This visualization organizes transcriptional states in the blood into clear cell type groups representing T, NK, and B cells; monocytes/macrophages; and DC populations. Within these cell types, the maps show additional structure. For example, T cells were organized into CD8+ effector states (marked by GZMH and additional genes), CD8+ pre-effector states (marked by GZMK+), CCR7+ CD8+ cells with variable degree of cathepsin-W (CTSW) expression, naïve CD8+ cells (IL7R+), and CD4+ cells showing some activation of Treg genes (FOXP3+). Overall, when sampling at a depth of 8000 cells, the metacell analysis allowed for robust identification of cell types and initial modeling of gene expression distribution within them. Additional coverage can lead to refined modeling of transcriptional distributions within cell types as we shall demonstrate below, but first, we will use this basic model to evaluate the similarity structure and homogeneity of metacells.</p>
    </sec>
    <sec id="Sec5">
      <title>MetaCell graphs define a symmetrized and modular adjacency structure between MCs</title>
      <p id="Par14">The impact of the procedures transforming raw cell-to-cell similarities to the MetaCell graph are illustrated for the PBMC data in Fig. <xref rid="Fig2" ref-type="fig">2</xref>a. The initial distribution of in-degree in the <italic>K</italic>-nn graph (<italic>Y</italic> axis, left panel) shows significant variation, which is corrected by a graph balancing procedure (middle panel). The resampled co-occurrence graph maintains the linkage between in and out degrees, but decreases the connectivity of the graph for specific cell types that are under-sampled (right panel). This actual effect of these transformations on cell type modularity is analyzed through the MC adjacency matrices that summarize connectivity between cells within each pair of MCs. Comparing raw <italic>K</italic>-nn, balanced, and resampled MC similarities (Fig. <xref rid="Fig2" ref-type="fig">2</xref>b and compare Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S4) shows for example initial spurious connectivity from NK cells (MC #56) toward T cells and from pDCs (MC #70) toward multiple cell types in the raw matrix, which are eliminated in the balanced and resampled matrices. This comparison also highlights cases of myeloid MCs connecting a large group of monocyte MCs and cDCs (#15) or monocytes and macrophages (#17), that provide better separation with the more differentiated MCs in the balanced and resampled matrices. The resampled matrix in particular provides improved modularity within the large group of T cell MCs, for example, grouping of CCR7+ T cell MCs into distinctive clusters. In summary, in a typical scRNA-seq dataset, the combination of abundant and rare states leads to an asymmetric <italic>K</italic>-nn structure linking rare cells with hubs within large clusters, and the MetaCell graph balancing procedure alleviates such effects. The approach is somewhat similar to methods using mutual <italic>K</italic>-nn analysis to normalize batch effects [<xref ref-type="bibr" rid="CR38">38</xref>, <xref ref-type="bibr" rid="CR39">39</xref>], or more generally to approaches using symmetrization of the <italic>K</italic>-nn graph to facilitate dimensionality reduction [<xref ref-type="bibr" rid="CR40">40</xref>].
<fig id="Fig2"><label>Fig. 2</label><caption><p>Evaluation of within-MC transcriptional homogeneity. <bold>a</bold> Shown are the number of incoming and outgoing neighbors (or degree) per cell, averaged over metacells that are color-coded by cell type annotation as in Fig. <xref rid="Fig1" ref-type="fig">1</xref>. The data represent the raw <italic>K</italic>-nn similarity graph (left), balanced MC graph (center), and resampled co-occurrence graph (right). <bold>b</bold> Heat map summarizing the number of edges in the balanced MC graph that link two cells associated with different MCs. Similar matrices generated based on the raw and co-occurrence graphs are shown in Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S4. <bold>c</bold> Bar graph shows the closure per MC (fraction of intra-MC edges out of all edges linking cells in the MC). <bold>d</bold> Observed (blue) vs predicted (red, based on binomial model) distributions of down-sampled UMI count per gene within MCs. For each of the 5 MCs depicted, the plots show binomial fit for the top 8 enriched genes. Intervals give 10th and 90th percentiles over multiple down-samples of the cells within each metacell to uniform total counts. <bold>e</bold> Over-dispersion of genes relative to a binomial model across genes and MCs. Colors encode ratio of observed to expected variance across genes (rows) and MCs (columns). Only genes and MCs manifesting high over-dispersion are shown. <bold>f</bold> Residual within-MC correlation patterns compared with global correlation patterns. Within-MC correlation matrix (left) was computed by averaging gene-gene correlation matrices across MCs, where each matrix was computed using log-transformed UMIs over down-sampled cells. Global correlation matrix (right) was computed in the same manner, but following permutation of the MC assignment labels. For both matrices, only genes manifesting strong correlations are shown. <bold>g</bold> Examples of residual intra-MC correlated genes, showing observed correlations (Pearson on log-transformed down-sampled UMIs) compared to correlations expected by sampling from a multinomial. MC #66 show weak residual correlations reflecting mostly stress genes. MC #70 shows stronger residual correlations, reflecting residual intra-MC variation</p></caption><graphic xlink:href="13059_2019_1812_Fig2_HTML" id="MO2"/></fig></p>
    </sec>
    <sec id="Sec6">
      <title>Comparing metacells’ graph closure with their transcriptional homogeneity</title>
      <p id="Par15">To quantify the accuracy of the MC approximation to the similarity graph, we computed the fraction of <italic>K</italic>-nn similarities captured within each MC, which we refer to here as the MC’s <italic>closure</italic>. As shown in Fig. <xref rid="Fig2" ref-type="fig">2</xref>c, the level of closure varies considerably between cell types. Distinct and low abundance cell types (type I MCs) can show very high closure (up to 100%), while multiple MCs that cover abundant cell types (type II or III MCs) show overall low closure (as low as 10% within-MC adjacencies, 20–30% within the three most linked MCs). Imperfect closure may suggest that the MC partition is suboptimal or, alternatively, that the <italic>K</italic>-nn local similarity structure in large and diffused cell types is covered by multiple, non-maximal but still homogeneous MCs (Type II MCs in Fig. <xref rid="Fig1" ref-type="fig">1</xref>a). To test this, we compared the intra-MC UMI distribution to the distribution predicted by a simple multinomial model for specific genes and MCs (Fig. <xref rid="Fig2" ref-type="fig">2</xref>d). We found that low closure MCs show high degree of consistency with the multinomial model, confirming their homogeneity. Interestingly, MCs with very high closure may show a reciprocal behavior, where additional high variance is present within <italic>K</italic>-nn consistent clusters (e.g., MC #70; note the bimodal distributions observed for most genes). This analysis highlights a key property of the MC partition: MCs are not maximal, and multiple highly similar MCs which are only weakly separated in the similarity graph can together approximate a larger cluster.</p>
    </sec>
    <sec id="Sec7">
      <title>Multinomial sampling explains most of the intra-MC UMI variance</title>
      <p id="Par16">Systematic screening for genes showing intra-MC over-dispersion (Fig. <xref rid="Fig2" ref-type="fig">2</xref>e) provides a global view on the consistency of the PBMC MC cover with simple multinomial sampling. In this screening, MCs containing residual, non-homogeneous structure will be associated with many over-dispersed genes. For example, this analysis associates the dendritic cells MC #70 with over-dispersion of multiple megakaryocyte-associated and other genes. This suggests that these poorly sampled cell types show additional hidden structure and potential remaining outlier cells. The screening also reveals specific genes that are consistently over-dispersed across many MCs, such as the early-immediate response gene module (including the transcription factors JUN, JUNB, FOS). This over-dispersion is consistent with variable levels of activity of this pathway in multiple cell types, perhaps representing technical experimental stress. Other genes are over-dispersed in a cell-type specific fashion, for example cytotoxic (GNLY, CCL5) genes in NK and T subtypes, and MHC-II and LYZ in myeloid cell types. These highly expressed genes may be incompatible with a simple multinomial sampling model, and their analysis may necessitate assuming prior biological variance to allow for over-dispersion. Beyond these specific examples, however, intra-MC distributions for the entire gene set (including genes that were not used as features for defining similarities) are generally well approximated by Poisson sampling with no zero inflation (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S5). Together, the data shows that the degree of residual, intra-MC over-dispersion is relatively low in the PBMC MC cover, so that the variance of most genes is accounted for by a model assuming partition of cells into MCs from which UMIs are multinomially sampled.</p>
      <p id="Par17">Analysis of intra- and inter-MC gene-gene covariance (Fig. <xref rid="Fig2" ref-type="fig">2</xref>f) provided an additional avenue for diagnosing structure within and between MCs. We observed persistent intra-MC correlations between a limited set of genes, including the over-dispersed modules of early-immediate genes, MHC class II genes, and S100 genes as well as a correlated gene set including actin-related genes (ACTB, ACTG1, COTL1, PFN1). We did not observe strong intra-MC correlations of cytotoxic and many other functional genes. The scarcity of strong intra-MC gene-gene correlations (see for example Fig. <xref rid="Fig2" ref-type="fig">2</xref>g, MC #66) suggests that little residual structure remains within the MCs, and that the dataset is well summarized by the MC profiles. In the few cases where intra-MC correlations are observed (Fig. <xref rid="Fig2" ref-type="fig">2</xref>g, MC #70), they indicate the need for a more flexible intra-MC modeling, or alternatively call for deepening the dataset with more cells defining the transcriptional states underlying the MC.</p>
    </sec>
    <sec id="Sec8">
      <title>Metacells are accurate local approximations of the expression manifold</title>
      <p id="Par18">All approaches for analysis of scRNA attempt to describe aspects of the expression manifold, each relying on different assumptions. MetaCell generates a high-resolution partition of the data, thereby focusing on approximating it locally. We tested the quality of this approximation using a cross-validation scheme, in which we predict the expression of each gene using a MetaCell model trained on data from which the gene was left out. Figure <xref rid="Fig3" ref-type="fig">3</xref>a illustrates the outcome of such prediction, showing accurate prediction for highly expressed genes and lower accuracy for low-UMI counts, for which sampling variance is high. We wanted to compare these predictions to those obtained using the models that underlie commonly used approaches for scRNA-seq analysis. To this end, we computed the cell-to-cell similarity matrices inferred by Seurat’s [<xref ref-type="bibr" rid="CR12">12</xref>] PCA-based approach and by a diffusion strategy as implemented in MAGIC [<xref ref-type="bibr" rid="CR25">25</xref>]. We also included in the comparison the similarity matrix <italic>S</italic> initiating the MetaCell balancing process. For all similarities, we employed the same cross-validation scheme that was applied to the MetaCell model, and computed local predictions by averaging 50 nearest neighbors for Seurat and <italic>S</italic>, and weighting all cells by their similarities for MAGIC (see the “<xref rid="Sec14" ref-type="sec">Methods</xref>” section for a complete description).
<fig id="Fig3"><label>Fig. 3</label><caption><p>MCs robustly approximate the expression manifold. <bold>a</bold> Boxplots show the distribution of predicted (using MC pool frequencies) UMI fraction per cell stratified according to observed number of UMIs in down-sampled single cells. <bold>b</bold> Shown are per-gene Pearson correlations between predicted and observed gene frequencies for genes, color coded according to the gene’s frequency across all cells. In all cases, predictions are generated using a 100-fold cross-validation scheme (see the “<xref rid="Sec14" ref-type="sec">Methods</xref>” section for exact description of the procedure and the strategies compared). Predictions using <italic>K</italic>-nns over raw MC similarities (a different neighborhood per cell consisting of its <italic>k</italic> most similar neighbors) are used as reference. It is compared to strategies defining cell neighborhoods using MCs (fixed disjoint grouping of cells), <italic>K</italic>-nn over Seurat distances, and MAGIC distances (weighted neighborhood according to diffusion distances). <bold>c</bold> Similar to panels in <bold>b</bold> but comparing accuracy with and without applying cross validation. Points with high value along the <italic>y</italic> axis represent potential over-fitting. <bold>d</bold>, <bold>e</bold> Per-MC (left most column) or smoothed per-cell (all other columns) expression values for pairs of genes, portraying putative transcriptional gradients</p></caption><graphic xlink:href="13059_2019_1812_Fig3_HTML" id="MO3"/></fig></p>
      <p id="Par19">Differences in prediction accuracy should reflect the different similarity measures employed by each method as well as the effect of disjoint partitioning applied in MetaCell. In theory, the partitioning strategy should provide less modeling flexibility compared to approaches that compute cell-specific neighborhoods. The latter effect should be particularly noticeable when several MCs discretize a continuum, such as differentiation trajectory (type III MCs, Fig. <xref rid="Fig1" ref-type="fig">1</xref>a). In practice, we observed relatively mild differences between the different approximations (Fig. <xref rid="Fig3" ref-type="fig">3</xref>b), with very few genes losing accuracy when MCs are used. Moreover, analysis of the gain in accuracy when including all genes in the models (Fig. <xref rid="Fig3" ref-type="fig">3</xref>c) suggested that MetaCell is significantly less exposed to over-fitting than the <italic>K</italic>-nn approaches. The diffusion-based smoothing approach showed minimal overfitting, but also loss of accuracy (Fig. <xref rid="Fig3" ref-type="fig">3</xref>c). Overall, the nearly multinomial intra-MC UMI distribution observed above and the minimal loss of predictive power entailed by the MetaCell disjoint partition, together suggest that MCs succeed in capturing most of the biological variation in the data, while eliminating most of the sampling noise.</p>
    </sec>
    <sec id="Sec9">
      <title>Metacells avoid artefactual gradient effects</title>
      <p id="Par20">We showed that the cell partitioning induced by MetaCell does not decrease local approximation accuracy and that, in fact, it even reduces the model’s tendency to over-fit the data. We speculated that another advantage of partitioning would be robustness to over-smoothing. The discussion about over-smoothing recently arose in the context of evaluating scRNA-seq imputation methods, i.e., methods that use the covariance patterns measured across multiple cells and genes to refine per-gene, per-cell measurements (reviewed here [<xref ref-type="bibr" rid="CR41">41</xref>]). Most imputation methods are local in the sense that they impute gene expression for a cell using its inferred neighborhood. It has been observed [<xref ref-type="bibr" rid="CR27">27</xref>, <xref ref-type="bibr" rid="CR28">28</xref>] that in some cases imputation tends to enforce spurious proximities between cells, which in turn manifest as artefactual gradients, i.e., discrete states pertaining to be a series of cells gradually modulating expression of certain genes along a temporal process or a spatial axis. While over-smoothing is detected directly when evaluating imputation methods, it is in fact a potential concern with any model regardless of its downstream application, and stems from the manner in which cell-cell similarities are defined.</p>
      <p id="Par21">We evaluated the susceptibility of the MetaCell model to over-smoothing using the expression predictions obtained in the previous section (the version without cross-validation), comparing the different similarity structures included in that experiment. Our results support the robustness of MetaCell to artefactual gradients (Fig. <xref rid="Fig3" ref-type="fig">3</xref>d). For example, NK cells are known to be characterized by high levels of KLRF1, but do not express the T cell classical marker CD3 (Fig. <xref rid="Fig3" ref-type="fig">3</xref>d, top). Smoothing based on <italic>K</italic>-nn similarity structures (MetaCell’s <italic>K</italic>-nn or Seurat’s) or on diffusion similarities (MAGIC’s) gives rise to phantom gradients that can be interpreted erroneously, for example, as supporting differentiation of NK to T cells or vice versa. The MC statistics generate a much less detailed, but likely more realistic map of joint CD3D/KLRF1 expression. Similar phantom gradients are observed when analyzing CCR7+ CD8+ and CCR7+ CD8− cells (Fig. <xref rid="Fig3" ref-type="fig">3</xref>d, bottom). On the other hand, the MC model does reveal expression gradients in cases where sampling adequately supports them, such as in the trade-off expression of GZMK+ and GZMH+ in T cells (Fig. <xref rid="Fig3" ref-type="fig">3</xref>e). These quantitative gradients are refined in the denser dataset we analyze below. Robust modeling of transcriptional gradients by MCs is also demonstrated on simulated data (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S6).</p>
    </sec>
    <sec id="Sec10">
      <title>Dissecting complex cell type hierarchies with MetaCell</title>
      <p id="Par22">We tested the scaling of MetaCell to datasets consisting of a large number of cell types and high variability in the total number of UMIs per single cell. To this end, we revisited two whole-organism scRNA-seq studies dissecting <italic>C. elegans</italic> (<italic>Caenorhabditis elegans</italic>) [<xref ref-type="bibr" rid="CR42">42</xref>] and Planaria (<italic>Schmidtea mediterranea</italic>) [<xref ref-type="bibr" rid="CR43">43</xref>]. For <italic>C. elegans</italic>, we compared the derived MC partition (349 MCs) (Fig. <xref rid="Fig4" ref-type="fig">4</xref>a, Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S7) to the published model grouping cells into 27 major cell types (Fig. <xref rid="Fig4" ref-type="fig">4</xref>b). We observed a high degree of consistency between the two models in classifying the major cell types, with higher resolution in dissecting cell types into subtypes using MCs (e.g., for body wall muscles, seam cells and more). Importantly, we observed a large number of cells labeled originally as “unclassified” or “unclassified neurons/glia” that were organized within coherent MCs. Some of these MCs were dominated completely or almost completely by unclassified cells. Moreover, we observed a negative correlation between the median number of UMIs per cell in a metacell and the fraction of unclassified cells within it (Fig. <xref rid="Fig4" ref-type="fig">4</xref>c). Comparing the number of UMIs per cell within MCs showed consistently lower UMI counts for unclassified cells (Fig. <xref rid="Fig4" ref-type="fig">4</xref>d). The transcriptional specificity of MCs containing large fractions of unclassified cells was uniformly high, as confirmed by observation of co-expression of specific transcription factors and genes within such MCs (Fig. <xref rid="Fig4" ref-type="fig">4</xref>e). Similarly, MetaCell analysis of the rich whole-organism cell type map of Planaria showed extensive consistency between the MC partition (564 MCs) and the iterative and highly supervised clustering analysis (512 clusters) used to annotate the original map (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S8). In summary, while MetaCell is not designed to perform clustering in its classical sense, a metacell partition facilitates robust and sensitive cell type mapping of scRNA-seq data, in particular when gene expression and cell type sizes are extremely heterogeneous.
<fig id="Fig4"><label>Fig. 4</label><caption><p>MC analysis of a whole-organism single-cell dataset. <bold>a</bold> 2D projection of <italic>C. elegans</italic> metacells and single cells, color-coded according to the most frequent cell type based on the classification from Cao et al. <bold>b</bold> Top—normalized expression of 1380 highly variable genes across 38,159 <italic>C. elegans</italic> single cells (columns), sorted by metacell. Bottom—bar plot showing for each metacell the single-cell composition of the different originally classified cell types. <bold>c</bold> Relationship between the metacell median cell size (UMIs/cell) and the fraction of cells originally labeled as “unclassified” in Cao et al. <bold>d</bold> Comparison of the median sizes (UMIs/cell) of originally unclassified cells versus classified cells in each metacell. <bold>e</bold> Expression (molecules/10,000 UMIs) of selected marker transcription factors (top row) and effector genes (bottom row) across all metacells, supporting high transcriptional specificity for four examples of metacells containing a high fraction (&gt; 80%) of originally unclassified cells</p></caption><graphic xlink:href="13059_2019_1812_Fig4_HTML" id="MO4"/></fig></p>
    </sec>
    <sec id="Sec11">
      <title>High-resolution analysis of inter- and intra-cell type states in the blood</title>
      <p id="Par23">We next tested the scaling of the MetaCell algorithmic pipeline when applied to datasets sampling deeply a relatively small number of cell types by analyzing RNA from 160K single blood cells, including 68K unsorted PMBCs and 94K cells from ten different bead-enriched populations [<xref ref-type="bibr" rid="CR44">44</xref>]. We hypothesized that, with increased number of cells, we could derive MCs with enhanced quantitative resolution and increased homogeneity, thereby allowing a more accurate identification of regulatory states and differentiation gradients in the blood. We derived a model organizing 157,701 cells in 1906 metacells, identifying 4475 cells as outliers. Figure <xref rid="Fig5" ref-type="fig">5</xref>a summarizes the similarity structure over the inferred MCs, indicating partitioning of the dataset into T cells, NK cells, B cells, myeloid cells, megakaryocytes, and progenitor cells. In-depth analysis of the emerging cluster and sub-cluster structure in this matrix allowed us to identify groups of related MCs for further analysis, in many cases providing us with the ability to zoom into transcriptional programs (cell groups numbered 1–13 on Fig. <xref rid="Fig5" ref-type="fig">5</xref>a) within large-scale clusters that were identified in the global metacell 2D projection graph (Fig. <xref rid="Fig5" ref-type="fig">5</xref>b). Visualization of genes that were specifically enriched in such programs demonstrates both bimodal markers and putative quantitative gradients organizing MCs within and between types (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S9). For example, we observed the correlated (and bifurcated) intensity of CD8A and CD8B expression in cytotoxic and memory T cells, the variable MHC-I expression (HLA-A,HLA-C) in different cell sub-types (group [<xref ref-type="bibr" rid="CR6">6</xref>]), variable levels of granzyme K and granzyme H expression along a putative cytotoxic gradient of CD8+ cells (groups [<xref ref-type="bibr" rid="CR1">1</xref>], [<xref ref-type="bibr" rid="CR3">3</xref>]), and a group of MCs expressing cathepsin W and CCR7+ but without the cytotoxic gene module (group [<xref ref-type="bibr" rid="CR5">5</xref>]). The analysis of specific gene families (see Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S10) illustrates how multiple effector genes are activated in different cell types in a convergent fashion (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S10A). Analysis of transcription factor expression across the different subtypes (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S10B) provided an initial blueprint for the regulatory mechanisms defining the observed transcriptional states. Importantly, the integration of different sorting batches allowed for enhanced resolution in several hematopoietic lineages, in particular CD34+ progenitor cells (Fig. <xref rid="Fig5" ref-type="fig">5</xref>a, group [<xref ref-type="bibr" rid="CR11">11</xref>]). Nevertheless, all MCs within the non-progenitor cell types represented a balanced mixture of sorted and non-sorted batches (Fig. <xref rid="Fig5" ref-type="fig">5</xref>c). We note that the metacells produced by MetaCell’s specialized partition algorithm cannot be reproduced by conventional clustering, at least when used naively. We demonstrate this by clustering the PBMCs with Seurat using parameters that force fine clustering, generating 817 clusters (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S11). As shown in Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S11A, the MC partition is consistent with these fine clusters at the level of the coarse-grained cell types, but not at higher resolutions. The fine clustering solution generates clusters that are likely to be overfitting specific genes (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S11B). In summary, for the densely covered, multi-batch 160,000 PBMC datasets, MetaCell provides analysts with a platform for distinguishing cell types and their internal hierarchies, and a robust scheme for characterizing quantitative expression gradients with guarantees against spurious smoothing effects.
<fig id="Fig5"><label>Fig. 5</label><caption><p>MC analysis of a 160K PBMC multi-batch dataset. <bold>a</bold>, <bold>b</bold> Matrix (<bold>a</bold>) and graph (<bold>b</bold>) visualization for the similarity structure associating MCs in a model characterizing 162,000 PBMCs. Clusters in the MC matrix are used for linking specific groups of MCs with specific annotation and for color coding. <bold>c</bold> Shown are the fraction of cells from different sorting batches per MC, color coded white to red to black and visualized using the MC 2D projection as shown in Fig. <xref rid="Fig4" ref-type="fig">4B</xref>. <bold>d</bold> Shown are lfp values for MCs in the PBMC 160K model, comparing intensity of Perforin expression (<italic>X</italic> axis) to several genes correlated with the CD8+ effector program. <bold>e</bold> Similar to <bold>d</bold> for genes showing transient activation during the effector program build-up. <bold>f</bold> Similar to <bold>d</bold> for CD8 genes, LAG3 (a T cell exhaustion marker) and a representative ribosomal protein gene</p></caption><graphic xlink:href="13059_2019_1812_Fig5_HTML" id="MO5"/></fig></p>
    </sec>
    <sec id="Sec12">
      <title>Using MCs to define gradients of CD8+ effector T cell activation</title>
      <p id="Par24">Finally, we demonstrate the potential of applying MetaCell for in-depth analysis of differentiation gradients through analysis of the transcriptional signatures in effector CD8+ T cells. Activation of the T cell effector program ultimately depends on expression of units of the cytotoxic granule (granzymes, cathepsins, granulysin) and of the machinery required for perforating target cells (e.g., perforin) [<xref ref-type="bibr" rid="CR45">45</xref>]. Elevated expression of Perforin 1 (PRF1) is indeed observed in a subset of the CD8+ MCs, spanning a spectrum of intensity from background level to 10-fold enrichment over it. We observed PRF1 enrichment to correlate strongly with multiple additional effector genes, for example granzyme H and B, FCGR3A, and KLRD1 (Fig. <xref rid="Fig5" ref-type="fig">5</xref>d), consistent with the idea of a spectrum of transcriptional states with variable effector gene toolkit expression in the blood. Remarkably, we identified a second set of genes showing elevated expression in MCs with low-to-intermediate effector program expression (Fig. <xref rid="Fig5" ref-type="fig">5</xref>e), including most notably granzyme K (GZMK) and the phosphatase DUSP2, but possibly also the chemokine receptor CXCR4 and the adhesion/motility molecule AMICA1/JAML. The effector program expression gradient was also associated with decrease in relative housekeeping gene expression (e.g., ribosomal proteins, Fig. <xref rid="Fig5" ref-type="fig">5</xref>f). We note that the association between the transcriptional gradient of effector genes and temporal or differentiation processes cannot be assumed immediately. It is nevertheless tempting to suggest that effector program activation involves transient expression of the GZMK-linked genes observed here, suggesting several experimental directions for follow-up toward a better understanding of T cell commitment and regulation in the blood and other organs, and in particular within tumors [<xref ref-type="bibr" rid="CR29">29</xref>, <xref ref-type="bibr" rid="CR46">46</xref>].</p>
    </sec>
  </sec>
  <sec id="Sec13">
    <title>Discussion and conclusions</title>
    <p id="Par25">We introduce here the use of metacells for analyzing scRNA-seq data. Metacells are defined as groups of single-cell profiles that ideally represent re-sampling from the same cellular state. In practice, we compute MCs as a graph partition using adequately processed similarities between single-cell profiles. We demonstrate that in real data, we can construct partitions such that the intra-MC UMI distribution can be approximated as sparse multinomial sample, representing sampling from a highly specific transcriptional state with no significant additional variance. We show how to screen for MCs with over-dispersion or residual pairwise gene correlations, reflecting deviation from this model and residual intra-MC biological variation. We then demonstrate how the MCs can be used for in-depth exploration of large data sets involving either a rich set of cell types (whole organism) or a limited and over-sampled set (PBMCs). The analysis methodology we advocate involves direct inspection of the MC adjacency matrix, which provides analysts with complete information about cell type hierarchy and supports clustering at appropriate resolution. Combined with visual examination of correlation patterns between MC-enriched genes, the result is a detailed and unbiased characterization of cell types and expression gradients that we have already used in several challenging analysis scenarios [<xref ref-type="bibr" rid="CR31">31</xref>–<xref ref-type="bibr" rid="CR35">35</xref>].</p>
    <p id="Par26">The main property that makes metacells a powerful analysis tool is their ability to increase the signal-to-noise ratio in the data without introducing biases stemming from mistaken modeling assumptions or over-smoothing of the data. The only manipulation performed by MetaCell on the data is the pooling of highly similar cells, thereby forming a partition of the data. The analyses we present show that, despite enforcing this partitioning, a metacell cover provides accurate local approximations of the expression manifold. At the same time, partitioning entails multiple advantages. Statistically, it greatly reduces the effective number of parameters of the model, making it less prone to over-fitting and to over-smoothing compared with naïve smoothing approaches. For the analyst, it allows for the characterization of well-defined, discrete and highly granular states in a conservative and easy-to-interpret framework.</p>
    <p id="Par27">In cases where residual intra-MC structure is detected in the cover, additional cells can be sampled to refine the MC cover and tighten the approximation. Fundamentally however, in any realistic data set, there will always remain some under-sampled behaviors regardless of sampling depth, and our current model will not provide a constructive approach for understanding such behaviors beyond signaling them out as non-homogeneous. Fitting more flexible intra-MC models, capable of accounting for not only sampling noise but also convergent processes such as cell cycle or stress [<xref ref-type="bibr" rid="CR47">47</xref>, <xref ref-type="bibr" rid="CR48">48</xref>], or embedding the metacells in hierarchical or multi-resolution structures [<xref ref-type="bibr" rid="CR49">49</xref>, <xref ref-type="bibr" rid="CR50">50</xref>] should allow for more efficient extraction of the signals of interest. We view the integration of such models as an important future extension of this work.</p>
  </sec>
  <sec id="Sec14">
    <title>Methods</title>
    <sec id="Sec15">
      <title>Notation and definitions</title>
      <p id="Par28">We assume raw scRNA-seq reads are mapped to genome sequences and assigned to cell barcodes and unique molecular identifiers (UMI) using pipelines that eliminate most of the UMI duplications induced by PCR and sequencing errors. We summarize all UMIs in the molecule count matrix <italic>U</italic> = [<italic>u</italic><sub><italic>gi</italic></sub>] on genes <italic>g</italic> ∈ <italic>G</italic> and cells <italic>i</italic> ∈ <italic>I</italic>. We define <italic>u</italic><sub><italic>g</italic></sub> as the total molecule count for gene g on the raw count matrix, and <italic>u</italic><sub><italic>i</italic></sub> as the total number of molecules for a cell (sometime referred to as the cell’s <italic>depth</italic>). The procedures below are designed to robustly define a metacell partition over the cells, which is denoted by a set of cell subsets <italic>M</italic><sub><italic>k</italic></sub> and a set of outliers <italic>O</italic> such that <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \left(\bigcup \limits_k{M}_k\right)\cup O=I $$\end{document}</tex-math><mml:math id="M2" display="inline"><mml:mfenced close=")" open="("><mml:mrow><mml:munder><mml:mo>⋃</mml:mo><mml:mi>k</mml:mi></mml:munder><mml:msub><mml:mi>M</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:mfenced><mml:mo>∪</mml:mo><mml:mi>O</mml:mi><mml:mo>=</mml:mo><mml:mi>I</mml:mi></mml:math><inline-graphic xlink:href="13059_2019_1812_Article_IEq1.gif"/></alternatives></inline-formula>.</p>
      <p id="Par29">We assume a set of gene features F ⊆ G is specified and focus our analysis on a similarity graph between cells derived using data from these features (see below). We discuss several strategies for selecting genes in Additional file <xref rid="MOESM3" ref-type="media">3</xref>. We note that our features represent individual genes rather than principle components or other forms of reduced dimensions. This enables some direct approaches to testing and correcting the gene expression distributions within metacells. It also forces the modeling of similarities and derivation of metacells to work over high-dimensional spaces and to account for noise and sparse data directly. Applying the metacell algorithmic pipeline to similarity structures derived using popular dimensionality reduction techniques is easily applicable as well, as we demonstrate in the results section.</p>
    </sec>
    <sec id="Sec16">
      <title>The metacell balanced <italic>K</italic>-nn cell similarity graph</title>
      <p id="Par30">A well-founded parametric generative model for scRNA-seq data is currently missing, mainly due to the limited understanding of the biological variation in transcriptional states within different cell populations, and the remarkable diversity of coupled (e.g., developmental) and uncoupled (e.g., cell cycle, stress) biological processes that are captured in typical single-cell RNA-seq maps. We therefore use a simple non-parametric approach for modeling raw pairwise local similarities, which is then refined by additional analysis of the derived cell <italic>K</italic>-nn similarity structure. We transform the raw UMI count <italic>U</italic> on the gene features <italic>F</italic> as <italic>U</italic> ′  = [<italic>u</italic>′<sub><italic>gi</italic></sub>] = [<italic>log</italic><sub>2</sub>(<italic>ϵ</italic> + <italic>u</italic><sub><italic>gi</italic></sub>)]<sub><italic>g</italic> ∈ <italic>F</italic></sub> and compute the raw similarity matrix using the Pearson correlations on the transformed features <italic>R</italic> = [<italic>r</italic>(<italic>u</italic>′<sub><italic>gi</italic></sub>, <italic>u</italic>′<sub><italic>gj</italic></sub>)]<sub><italic>ij</italic></sub>. A simple variation on this procedure may include prior normalization of the <italic>U</italic> matrix by down-sampling (sampling min(<italic>u</italic><sub><italic>i</italic></sub>) UMIs from each cell without replacement) so as to avoid biases associated with improved accuracy (and thereby higher similarity) between deeper UMI profiles. We however avoid down-sampling when the distribution of the number of UMIs per cell is highly variable and correct for the sampling bias when manipulating the similarity graph as described below.</p>
      <p id="Par31">Next, we use the raw similarity matrix <italic>R</italic> to generate a weighted adjacency matrix for a directed cell graph, in which a heavy edge from cell <italic>i</italic> to cell <italic>j</italic> indicates strong attraction of the former to the latter. We first perform a non-parametric transformation by computing <italic>S</italic> = [<italic>s</italic><sub><italic>ij</italic></sub>] = [<italic>rank</italic><sub><italic>j</italic></sub>(<italic>r</italic><sub><italic>ij</italic></sub>)]. Here <italic>rank</italic> is the ranking function, and each row represents the order of similarity between all cells <italic>j</italic> and a specific cell <italic>i</italic>. The <italic>S</italic> matrix is highly non-symmetric, for example when the similarities going from an outlier cell are linking it to members of a large, homogeneous, and highly connected cell group. To better control for such effects, we perform the following <italic>balancing</italic> operation. We first symmetrize <italic>S</italic> by multiplying ranks <italic>s</italic><sub><italic>ij</italic></sub> ∗ <italic>s</italic><sub><italic>ji</italic></sub>, followed by initial regularization of edges using a threshold <italic>αK</italic><sup>2</sup> (setting <italic>α</italic> = 10 by default) on the rank product:
<disp-formula id="Equa"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \left[{s}_{ij}^1\right]=\left[\mathit{\max}\left(\alpha {K}^2-{s}_{ij}\ast {s}_{ji},0\right)\right] $$\end{document}</tex-math><mml:math id="M4" display="block"><mml:mfenced close="]" open="["><mml:msubsup><mml:mi>s</mml:mi><mml:mi mathvariant="italic">ij</mml:mi><mml:mn>1</mml:mn></mml:msubsup></mml:mfenced><mml:mo>=</mml:mo><mml:mfenced close="]" open="["><mml:mrow><mml:mo mathvariant="italic">max</mml:mo><mml:mfenced close=")" open="(" separators=","><mml:mrow><mml:mi>α</mml:mi><mml:msup><mml:mi>K</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mo>−</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi mathvariant="italic">ij</mml:mi></mml:msub><mml:mo>∗</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi mathvariant="italic">ji</mml:mi></mml:msub></mml:mrow><mml:mn>0</mml:mn></mml:mfenced></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="13059_2019_1812_Article_Equa.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par32">We then perform two rounds of additional regularization, first keeping maximum scoring <italic>βK</italic> incoming edges for each node (<italic>β</italic> = 3 by default):
<disp-formula id="Equb"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \left[{s}_{ij}^2\right]=\left[\mathit{\max}\left(\beta K-\mathit{\operatorname{ran}}{k}_i\left({s}_{ij}^1\right),0\right)\right] $$\end{document}</tex-math><mml:math id="M6" display="block"><mml:mfenced close="]" open="["><mml:msubsup><mml:mi>s</mml:mi><mml:mi mathvariant="italic">ij</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mfenced><mml:mo>=</mml:mo><mml:mfenced close="]" open="["><mml:mrow><mml:mo mathvariant="italic">max</mml:mo><mml:mfenced close=")" open="(" separators=","><mml:mrow><mml:mi mathvariant="italic">βK</mml:mi><mml:mo>−</mml:mo><mml:mo mathvariant="italic">ran</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mfenced close=")" open="("><mml:msubsup><mml:mi>s</mml:mi><mml:mi mathvariant="italic">ij</mml:mi><mml:mn>1</mml:mn></mml:msubsup></mml:mfenced></mml:mrow><mml:mn>0</mml:mn></mml:mfenced></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="13059_2019_1812_Article_Equb.gif" position="anchor"/></alternatives></disp-formula>and then further filtering to keep maximum K outgoing edges for each node:
<disp-formula id="Equc"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \left[{a}_{ij}\right]=\left[\mathit{\max}\left(K-\mathit{\operatorname{ran}}{k}_j\left({s}_{ij}^2\right),0\right)\right] $$\end{document}</tex-math><mml:math id="M8" display="block"><mml:mfenced close="]" open="["><mml:msub><mml:mi>a</mml:mi><mml:mi mathvariant="italic">ij</mml:mi></mml:msub></mml:mfenced><mml:mo>=</mml:mo><mml:mfenced close="]" open="["><mml:mrow><mml:mo mathvariant="italic">max</mml:mo><mml:mfenced close=")" open="(" separators=","><mml:mrow><mml:mi>K</mml:mi><mml:mo>−</mml:mo><mml:mo mathvariant="italic">ran</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mfenced close=")" open="("><mml:msubsup><mml:mi>s</mml:mi><mml:mi mathvariant="italic">ij</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mfenced></mml:mrow><mml:mn>0</mml:mn></mml:mfenced></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="13059_2019_1812_Article_Equc.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par33">A weighted directed graph G is then constructed using [<italic>a</italic><sub><italic>ij</italic></sub>] as the weighted adjacency matrix. Note that nodes with degrees lower than <italic>K</italic> are possible following this procedure, since outlier cells may become disconnected or poorly connected during the balancing operations.</p>
    </sec>
    <sec id="Sec17">
      <title>Seeding and optimizing graph partitions</title>
      <p id="Par34">We partition the balanced similarity graph G into dense subgraphs using an adaptation of <italic>k</italic>-means to graphs. Let the parameter <italic>K</italic> define the typical desired size of subgraphs in the partition (which is also the maximum outdegree of the graph <italic>G</italic> as constructed). Denote by <italic>N</italic><sup>out</sup>(<italic>i</italic>) the set of graphic outgoing neighbors of <italic>i</italic>. We initialize an empty assignment of cells to subgraphs <italic>mc</italic>(<italic>i</italic>) =  − 1, define the set of covered nodes as <italic>C</italic> = {<italic>i</italic> | <italic>mc</italic>(<italic>i</italic>) &gt;  − 1} and the <italic>cover-free</italic> score for each node as <italic>f</italic>(<italic>i</italic>) = |<italic>N</italic><sup>out</sup>(<italic>i</italic>) – <italic>C</italic>|. We then sample subgraph seeds using an iterative procedure:
<list list-type="bullet"><list-item><p id="Par35">Initialize <italic>k =</italic> 0</p></list-item><list-item><p id="Par36">While <inline-formula id="IEq2"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \underset{i}{\max }\ f(i)&gt; size\_\mathit{\min} $$\end{document}</tex-math><mml:math id="M10" display="inline"><mml:munder><mml:mo>max</mml:mo><mml:mi>i</mml:mi></mml:munder><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mi>i</mml:mi></mml:mfenced><mml:mo>&gt;</mml:mo><mml:mtext mathvariant="italic">size</mml:mtext><mml:mo>_</mml:mo><mml:mo mathvariant="italic">min</mml:mo></mml:math><inline-graphic xlink:href="13059_2019_1812_Article_IEq2.gif"/></alternatives></inline-formula> do:
<list list-type="bullet"><list-item><p id="Par37">sample a new seed cell <italic>j</italic> by drawing a sample from cells in <italic>I</italic> − <italic>C</italic> with weights proportional to <italic>f</italic>(<italic>i</italic>)<sup>3</sup></p></list-item><list-item><p id="Par38">update <italic>mc</italic>(<italic>u</italic>) = <italic>k for u</italic> = <italic>j</italic>, <italic>u</italic> ∈ <italic>N</italic><sup><italic>out</italic></sup>(<italic>j</italic>) − <italic>C</italic></p></list-item><list-item><p id="Par39">Increment <italic>k</italic> and update <italic>C</italic>, <italic>f</italic>.</p></list-item></list></p></list-item></list></p>
      <p id="Par40">We terminate seeding using a minimum subgraph size parameter <italic>size</italic> _  <italic>min</italic>  &lt; <italic>K</italic>. When we meet the stop criterion, cells that are not associated with a seed (i.e., cells for which <italic>mc</italic>(<italic>i</italic>) =  − 1) have at most <italic>size</italic> _ <italic>min</italic> uncovered neighbors and in particular will almost always have at least one covered neighbor (since the degree in the balanced graph is typically <italic>K</italic>).</p>
      <p id="Par41">The seeding step produces an initial set of subgraphs <italic>M</italic><sub><italic>k</italic></sub> = {<italic>i</italic> | <italic>mc</italic>(<italic>i</italic>) = <italic>k</italic>} that forms a basis for further optimization. Define the outgoing association of each cell to a subgraph as <inline-formula id="IEq3"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ w{o}_{ik}={\sum}_{\left\{j\in {N}^{out}(i)\cap {M}_k\right\}}{a}_{ij} $$\end{document}</tex-math><mml:math id="M12" display="inline"><mml:mi>w</mml:mi><mml:msub><mml:mi>o</mml:mi><mml:mi mathvariant="italic">ik</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mo>∑</mml:mo><mml:mfenced close="}" open="{"><mml:mrow><mml:mi>j</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mi>N</mml:mi><mml:mtext mathvariant="italic">out</mml:mtext></mml:msup><mml:mfenced close=")" open="("><mml:mi>i</mml:mi></mml:mfenced><mml:mo>∩</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:msub><mml:msub><mml:mi>a</mml:mi><mml:mi mathvariant="italic">ij</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2019_1812_Article_IEq3.gif"/></alternatives></inline-formula> (recall <italic>a</italic> are the graph weights), and analogously the incoming subgraph association for each cell as <inline-formula id="IEq4"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ w{i}_{ik}={\sum}_{\left\{j\in {N}^{in}(i)\cap {M}_k\right\}}{a}_{ji} $$\end{document}</tex-math><mml:math id="M14" display="inline"><mml:mi>w</mml:mi><mml:msub><mml:mi>i</mml:mi><mml:mi mathvariant="italic">ik</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mo>∑</mml:mo><mml:mfenced close="}" open="{"><mml:mrow><mml:mi>j</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mi>N</mml:mi><mml:mtext mathvariant="italic">in</mml:mtext></mml:msup><mml:mfenced close=")" open="("><mml:mi>i</mml:mi></mml:mfenced><mml:mo>∩</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:msub><mml:msub><mml:mi>a</mml:mi><mml:mi mathvariant="italic">ji</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2019_1812_Article_IEq4.gif"/></alternatives></inline-formula>. The combined cell-to-subgraph association is computed by multiplying the outgoing and incoming weights and normalizing by the respective subgraph size: <italic>w</italic><sub><italic>ik</italic></sub> = <italic>wi</italic><sub><italic>ik</italic></sub> <italic>wo</italic><sub><italic>ik</italic></sub>/|<italic>M</italic><sub><italic>k</italic></sub>|<sup>2</sup>. We use this scoring scheme to iteratively optimize the initial graph cover, and ensure that it includes all cells:
<list list-type="bullet"><list-item><p id="Par42">Until convergence:
<list list-type="bullet"><list-item><p id="Par43">Select a cell <italic>i</italic></p></list-item><list-item><p id="Par44">Reassign <italic>mc</italic>(<italic>i</italic>) = <italic>argmax</italic><sub><italic>k</italic></sub> <italic>w</italic><sub><italic>ik</italic></sub></p></list-item><list-item><p id="Par45">Update weights</p></list-item></list></p></list-item></list></p>
      <p id="Par46">Convergence is defined by deriving a partition in which all cells are associated with their highest scoring subgraph. To enforce convergence (which is not guaranteed to occur in general), we slowly increase the score association between cells and their current subgraph after each reassignment. This is especially useful when a large subset of cells (i.e., larger than <italic>K</italic>) are very homogeneous, which may result in unstable exchange of nodes between several modules covering this subset.</p>
      <p id="Par47">After convergence, there are no formal guarantees on size distribution of the subgraphs produced by the algorithm. Empirically, however, the connectivity of the graph (maximum <italic>K</italic> outgoing edges) and the seeding process promote a relatively uniform cover partition and prevent convergence toward solutions with very large subgraphs. Rare cases of cells that reside in connected components whose size is smaller than <italic>size</italic> _ <italic>min</italic> and were left uncovered during seeding are defined as outliers.</p>
      <p id="Par48">Importantly, the complexity of the entire procedure (seeding and optimization) is linear in the number of cells and the maximum degree <italic>K</italic> (or alternatively, linear in the number of edges in the graph). An efficient implementation of the algorithm therefore scales well to large datasets, as does its integration within an extensive resampling strategy, as we discuss next.</p>
    </sec>
    <sec id="Sec18">
      <title>Resampling graph partitions and computing metacells</title>
      <p id="Par49">We improve the robustness of the above randomized graph partition algorithm using a resampling approach. Given the balanced graph <italic>G</italic>, we generate a series of subgraphs <italic>b</italic> = 1. . <italic>N</italic><sub><italic>B</italic></sub> (typically <italic>N</italic><sub><italic>B</italic></sub> = 500) by sampling cells independently without replacement with probability <italic>ρ</italic> (typically <italic>ρ</italic> = 0.75) and adding all edges connecting them, forming <italic>G</italic><sup><italic>b</italic></sup> = (<italic>V</italic><sup><italic>b</italic></sup>, <italic>E</italic><sup><italic>b</italic></sup>), <italic>V</italic><sup><italic>b</italic></sup> ⊂ <italic>V</italic>, <italic>E</italic><sup><italic>b</italic></sup> ⊂ <italic>E</italic>. For each resampled <italic>G</italic><sup><italic>b</italic></sup>, we apply the partition algorithm, thereby generating a set of partial graph partitions <italic>mc</italic><sup><italic>b</italic></sup>(<italic>i</italic>) <italic>for each i</italic> ∈ <italic>V</italic><sup><italic>b</italic></sup>. We summarize all partitions using the matrices <italic>O</italic> = [<italic>o</italic><sub><italic>ij</italic></sub>] and <italic>C</italic> = [<italic>c</italic><sub><italic>ij</italic></sub>], specifying how many times the pair of cells <italic>i</italic>, <italic>j</italic> were resampled together, and how many times they were both assigned to the same subgraph in the resampled partition, respectively. We then define the resampled co-occurrence matrix as <inline-formula id="IEq5"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {S}^{boot}=\left[{s}_{ij}^{boot}\right]=\left[{c}_{ij}/{o}_{ij}\right] $$\end{document}</tex-math><mml:math id="M16" display="inline"><mml:msup><mml:mi>S</mml:mi><mml:mtext mathvariant="italic">boot</mml:mtext></mml:msup><mml:mo>=</mml:mo><mml:mfenced close="]" open="["><mml:msubsup><mml:mi>s</mml:mi><mml:mi mathvariant="italic">ij</mml:mi><mml:mtext mathvariant="italic">boot</mml:mtext></mml:msubsup></mml:mfenced><mml:mo>=</mml:mo><mml:mfenced close="]" open="["><mml:mrow><mml:msub><mml:mi>c</mml:mi><mml:mi mathvariant="italic">ij</mml:mi></mml:msub><mml:mo>/</mml:mo><mml:msub><mml:mi>o</mml:mi><mml:mi mathvariant="italic">ij</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:math><inline-graphic xlink:href="13059_2019_1812_Article_IEq5.gif"/></alternatives></inline-formula>.</p>
      <p id="Par50">The values in <italic>S</italic><sup><italic>boot</italic></sup> are now used to compute a weighted, non-directed graph, discarding the original correlation distances. We compute for each cell <italic>i</italic> the value of the <italic>K</italic><sup><italic>core</italic></sup> (typically 30) highest frequency neighbors (denoted <italic>T</italic><sub><italic>i</italic></sub>) and then define a co-occurrence threshold for each pair of cells using the maximal of the two critical values multiplied by a factor <italic>T</italic><sub><italic>ij</italic></sub> =  <italic>max</italic> (<italic>T</italic><sub><italic>i</italic></sub>, <italic>T</italic><sub><italic>j</italic></sub>) ∗ 0.5. Pairs with <inline-formula id="IEq6"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {S}_{ij}^{boot}&gt;{T}_{ij} $$\end{document}</tex-math><mml:math id="M18" display="inline"><mml:msubsup><mml:mi>S</mml:mi><mml:mi mathvariant="italic">ij</mml:mi><mml:mtext mathvariant="italic">boot</mml:mtext></mml:msubsup><mml:mo>&gt;</mml:mo><mml:msub><mml:mi>T</mml:mi><mml:mi mathvariant="italic">ij</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="13059_2019_1812_Article_IEq6.gif"/></alternatives></inline-formula> are used as the edges in a new graph denoted as <italic>G</italic><sup><italic>boot</italic></sup> on all cells. Note that <italic>G</italic><sup><italic>boot</italic></sup> is still of non homogeneous degrees, as setting fixed thresholds on edges implies that nodes in large and diffused clusters will have a lower <italic>T</italic><sub><italic>i</italic></sub> values and thereby higher degree than nodes in tight and robust clusters that always cluster in the same subgraphs. The parameter <italic>K</italic><sup><italic>core</italic></sup> provides users of the algorithm with flexible control over the degrees in the derived graph. The final partition solution is obtained by re-applying the same partition algorithm on the graph <italic>G</italic><sup><italic>boot</italic></sup>, resulting in a new set of subgraphs <italic>M</italic><sub><italic>i</italic></sub> and a potential list of outliers. This solution is subject to further filtering and verification, as described next.</p>
    </sec>
    <sec id="Sec19">
      <title>Filtering clear parametric outliers from a metacell cover</title>
      <p id="Par51">As commented above, even though we lack a proper parametric model for single-cell RNA-seq, our idealized metacell cover is expected to group together single-cell profiles that are approximately consistent with multinomial sampling. Testing a given metacell cover for gross inconsistencies with this assumption can help detecting outlier cells emerging from experimental errors (such as doublets), as well as diagnose rare states that are not sufficiently abundant to define a separate metacell. We currently approach this detection problem heuristically, by summarizing the metacell’s pool frequencies:
<disp-formula id="Equd"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {u}_k=\sum \limits_{i\in {M}_k}{u}_i $$\end{document}</tex-math><mml:math id="M20" display="block"><mml:msub><mml:mi>u</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:munder><mml:msub><mml:mi>u</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><graphic xlink:href="13059_2019_1812_Article_Equd.gif" position="anchor"/></alternatives></disp-formula>
<disp-formula id="Eque"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {p}_{gk}=\frac{1}{u_k}{\sum}_{\left\{i\in {M}_k\right\}}{u}_{gi} $$\end{document}</tex-math><mml:math id="M22" display="block"><mml:msub><mml:mi>p</mml:mi><mml:mi mathvariant="italic">gk</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:msub><mml:mi>u</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mfrac><mml:msub><mml:mo>∑</mml:mo><mml:mfenced close="}" open="{"><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:msub><mml:msub><mml:mi>u</mml:mi><mml:mi mathvariant="italic">gi</mml:mi></mml:msub></mml:math><graphic xlink:href="13059_2019_1812_Article_Eque.gif" position="anchor"/></alternatives></disp-formula>and computing an approximate, regularized observed/expected value for each gene and cell:
<disp-formula id="Equf"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {f}_{gi}={\log}_2\left(\frac{1+{u}_{gi}}{1+{u}_i{p}_{gk}}\right),i\in {M}_k $$\end{document}</tex-math><mml:math id="M24" display="block"><mml:msub><mml:mi>f</mml:mi><mml:mi mathvariant="italic">gi</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mo>log</mml:mo><mml:mn>2</mml:mn></mml:msub><mml:mfenced close=")" open="("><mml:mfrac><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msub><mml:mi>u</mml:mi><mml:mi mathvariant="italic">gi</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msub><mml:mi>u</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>p</mml:mi><mml:mi mathvariant="italic">gk</mml:mi></mml:msub></mml:mrow></mml:mfrac></mml:mfenced><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:math><graphic xlink:href="13059_2019_1812_Article_Equf.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par52">Note that the regularization (adding 1 to observed and expected count) implies that high fold change values (e.g., &gt; 2) cannot be attained for genes with very low overall UMI counts. However, this regularization is sufficient to ensure robust detection of clear outliers. Cells with one or more genes showing high <italic>f</italic><sub><italic>gi</italic></sub> values are labeled as potential outliers and removed from their metacell cover prior to in-depth quantitative analysis of the model.</p>
    </sec>
    <sec id="Sec20">
      <title>Verifying metacells homogeneity</title>
      <p id="Par53">Outlier filtering does not guarantee metacell homogeneity in cases where two distinct and significantly separated transcriptional states are grouped together. To screen for such scenarios, we attempt to cluster cells within each metacell <italic>M</italic><sub><italic>k</italic></sub> de novo. Clustering is performed by applying the DBSCAN density-based clustering algorithm to the intra-metacell similarity matrix, computed as the correlation distances described above but restricted to genes exhibiting mildly high intra-metacell variance (normalized variance/mean &gt; 1.2). If more than one cluster is detected, we split the metacell accordingly. In practice, metacells almost never include hidden sub-clusters and testing for splits is used mostly for validation purposes.</p>
    </sec>
    <sec id="Sec21">
      <title>Defining the metacell gene expression profile</title>
      <p id="Par54">We approximate the gene expression intensity within each metacell by a regularized geometric mean:
<disp-formula id="Equg"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {p}_{gk}=\mathit{\exp}\left[\left(\frac{1}{\left|{M}_k\right|}{\sum}_{\left\{i\in {M}_k\right\}}\log \left(1+{u}_{gi}\right)\right)-1\right]/\left(\frac{1}{\left|{M}_k\right|}{\sum}_{\left\{i\in {M}_k\right\}}{u}_i\right) $$\end{document}</tex-math><mml:math id="M26" display="block"><mml:msub><mml:mi>p</mml:mi><mml:mi mathvariant="italic">gk</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mo mathvariant="italic">exp</mml:mo><mml:mfenced close="]" open="["><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mfenced close="|" open="|"><mml:msub><mml:mi>M</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mfenced></mml:mfrac><mml:msub><mml:mo>∑</mml:mo><mml:mfenced close="}" open="{"><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:msub><mml:mo>log</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msub><mml:mi>u</mml:mi><mml:mi mathvariant="italic">gi</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfenced><mml:mo>/</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mfenced close="|" open="|"><mml:msub><mml:mi>M</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mfenced></mml:mfrac><mml:msub><mml:mo>∑</mml:mo><mml:mfenced close="}" open="{"><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mi>k</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:msub><mml:msub><mml:mi>u</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="13059_2019_1812_Article_Equg.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par55">We then quantify relative expression as the log fold enrichment over the median metacell value:</p>
      <p id="Par56">
        <disp-formula id="Equh">
          <alternatives>
            <tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\mathrm{lfp}}_{gk}=\mathrm{lo}{\mathrm{g}}_2\left(\left({p}_{gk}+\epsilon \right)/\mathrm{media}{\mathrm{n}}_{k\prime}\left({p}_{gk\prime }+\epsilon \right)\right) $$\end{document}</tex-math>
            <mml:math id="M28" display="block">
              <mml:msub>
                <mml:mrow>
                  <mml:mi mathvariant="normal">l</mml:mi>
                  <mml:mi mathvariant="normal">f</mml:mi>
                  <mml:mi mathvariant="normal">p</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:mi>g</mml:mi>
                  <mml:mi>k</mml:mi>
                </mml:mrow>
              </mml:msub>
              <mml:mo>=</mml:mo>
              <mml:mrow>
                <mml:mi mathvariant="normal">l</mml:mi>
                <mml:mi mathvariant="normal">o</mml:mi>
              </mml:mrow>
              <mml:msub>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mi mathvariant="normal">g</mml:mi>
                  </mml:mrow>
                </mml:mrow>
                <mml:mn>2</mml:mn>
              </mml:msub>
              <mml:mrow>
                <mml:mo>(</mml:mo>
                <mml:mrow>
                  <mml:mo>(</mml:mo>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mi>p</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mi>g</mml:mi>
                      <mml:mi>k</mml:mi>
                    </mml:mrow>
                  </mml:msub>
                  <mml:mo>+</mml:mo>
                  <mml:mi>ϵ</mml:mi>
                  <mml:mo>)</mml:mo>
                </mml:mrow>
                <mml:mrow>
                  <mml:mo>/</mml:mo>
                </mml:mrow>
                <mml:mrow>
                  <mml:mi mathvariant="normal">m</mml:mi>
                  <mml:mi mathvariant="normal">e</mml:mi>
                  <mml:mi mathvariant="normal">d</mml:mi>
                  <mml:mi mathvariant="normal">i</mml:mi>
                  <mml:mi mathvariant="normal">a</mml:mi>
                </mml:mrow>
                <mml:msub>
                  <mml:mrow>
                    <mml:mrow>
                      <mml:mi mathvariant="normal">n</mml:mi>
                    </mml:mrow>
                  </mml:mrow>
                  <mml:mrow>
                    <mml:mi>k</mml:mi>
                    <mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi>
                  </mml:mrow>
                </mml:msub>
                <mml:mrow>
                  <mml:mo>(</mml:mo>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mi>p</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mi>g</mml:mi>
                      <mml:mi>k</mml:mi>
                      <mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi>
                    </mml:mrow>
                  </mml:msub>
                  <mml:mo>+</mml:mo>
                  <mml:mi>ϵ</mml:mi>
                  <mml:mo>)</mml:mo>
                </mml:mrow>
                <mml:mo>)</mml:mo>
              </mml:mrow>
            </mml:math>
            <graphic xlink:href="13059_2019_1812_Article_Equh.gif" position="anchor"/>
          </alternatives>
        </disp-formula>
      </p>
      <p id="Par57">Note that the lfp values are affected by the composition of metacells in the dataset up to a constant and that <italic>ϵ</italic> (typically set to 10<sup>−4</sup>) should be adapted to the typical total molecule count within a metacell.</p>
    </sec>
    <sec id="Sec22">
      <title>Metacell regularized force directed 2D projection</title>
      <p id="Par58">We use the MetaCell cover to regularize the similarity graph among single cells and therefore simplify their 2D projection as follows. We start by projecting edges in the graph G over metacells:
<disp-formula id="Equi"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ B=\left[{b}_{ml}\right]=\frac{K^2}{\left|{M}_m|\ast |{M}_l\right|}\sum \limits_{\left\{i\in {M}_m,j\in {M}_l\right\}}\left\lceil {a}_{ij}/C\right\rceil $$\end{document}</tex-math><mml:math id="M30" display="block"><mml:mi>B</mml:mi><mml:mo>=</mml:mo><mml:mfenced close="]" open="["><mml:msub><mml:mi>b</mml:mi><mml:mi mathvariant="italic">ml</mml:mi></mml:msub></mml:mfenced><mml:mo>=</mml:mo><mml:mfrac><mml:msup><mml:mi>K</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mfenced close="|" open="|" separators="||"><mml:msub><mml:mi>M</mml:mi><mml:mi>m</mml:mi></mml:msub><mml:mo>∗</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mi>l</mml:mi></mml:msub></mml:mfenced></mml:mfrac><mml:munder><mml:mo>∑</mml:mo><mml:mfenced close="}" open="{" separators=","><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mi>m</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mi>l</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:munder><mml:mfenced close="⌉" open="⌈"><mml:mrow><mml:msub><mml:mi>a</mml:mi><mml:mi mathvariant="italic">ij</mml:mi></mml:msub><mml:mo>/</mml:mo><mml:mi>C</mml:mi></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="13059_2019_1812_Article_Equi.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par59">(here <italic>C</italic> = median<sub><italic>k</italic></sub>(| <italic>M</italic><sub><italic>k</italic></sub>| ) is a scaling constant). We symmetrize B by replacing it with B′, the sum of its row and column-normalized forms, and retain as candidate edges only pairs for which <italic>b</italic>′<sub><italic>ml</italic></sub> &gt; <italic>T</italic><sub><italic>edge</italic></sub>. We then construct a graph over the metacells <italic>G</italic><sup><italic>M</italic></sup> = (<italic>M</italic>, <italic>E</italic><sup><italic>M</italic></sup>), by adding the <italic>D</italic> highest scoring candidate edges (if they exist) for each metacell. This results in a graph with maximum degree <italic>D</italic> and any number of connected components. We compute coordinates (<italic>xm</italic><sub><italic>k</italic></sub>, <italic>ym</italic><sub><italic>k</italic></sub>) for each metacell by applying a standard force-directed layout algorithm to the graph <italic>G</italic><sup><italic>M</italic></sup>. We then position cells by averaging the metacell coordinates of their neighbor cells in the original balanced graph <italic>G</italic>, but filter neighbors that define a metacell pair that is not connected in the graph <italic>G</italic><sup><italic>M</italic></sup>. Averaging allows for layout flexibility along one or few edges in the metacell graph when positioning large cell clusters that are dissected by several metacells.</p>
    </sec>
    <sec id="Sec23">
      <title>Implementation</title>
      <p id="Par60">We implemented MetaCell using a combination of C++ and R code. We used parallelization over multi-core machines. On a strong Xeon-E5-2660 dual-CPU machine, the entire analysis pipeline for a small 8200 cells dataset, including bootstrap iterations and computing 2D visualizations, required 2 min and 20 cores, and a maximum of 4.8 GB of RAM. The entire analysis pipeline for a 160K cells’ dataset required 112 min and a maximum of 79-GB RAM on the same machine.</p>
    </sec>
    <sec id="Sec24">
      <title>Evaluating within-MC homogeneity</title>
      <p id="Par61">Following the computation of the MetaCell partition, our pipeline produces diagnostic statistics and plots to evaluate the level of adherence of the metacells to a multinomial sampling model. To visualize large-scale adherence across all genes, we produce per MC plots comparing the coefficient of variation and the fraction of zero counts to the expected under a Poisson model (see examples in Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S5). In addition, we visualize adherence to binomial sampling of the top enriched genes per MC by plotting the observed distribution of UMI count and the same distribution sampled from a binomial model (see examples in Fig. <xref rid="Fig2" ref-type="fig">2</xref>d). For both observed and expected, counting is done after down-sampling all cells within a metacell to uniform total counts. Finally, global diagnostic matrices over all MCs and marker genes (see example in Fig. <xref rid="Fig2" ref-type="fig">2</xref>e) are computed as follows: We down-sample the UMIs to uniform total counts per MC and compute the binomial likelihood of the observed counts, as well as their over-dispersion (observed divided by expected variance). We average these statistics over multiple down-samples and repeat the whole procedure over 999 fake count matrices drawn from the per-MC multinomial model. Per gene and per MC, we compute the empirical <italic>p</italic> value of its likelihood with respect to the binomial null. We output the <italic>p</italic> values and the over-dispersion values and visualize a summarizing heatmap of the latter. Note that when computing binomial statistics, we down-sample with respect to feature and enriched genes only, and that the expected distributions are derived from the pool frequencies constrained to these genes.</p>
    </sec>
    <sec id="Sec25">
      <title>Comparing local approximation accuracy using expression prediction</title>
      <p id="Par62">We designed a cross-validation experiment to quantify how well the MetaCell partition captures local cell-to-cell similarities. We divided the gene set into 100 folds, and leaving out each fold at a time computed cell-to-cell similarities on the remaining genes using four different strategies. We next used these similarities to predict, per cell, the expression level of the left-out genes. Finally, we compared the quality of predictions across all genes. A model that captures accurately local similarities in the expression manifold is expected to produce accurate predictions.</p>
      <p id="Par63">The compared approaches are as follows: (1) predicting using the per-metacell pool frequencies, (2) predicting using the pool frequencies among the top 50 neighbors according to the raw MC similarity matrix <italic>R</italic>, (3) predicting using the pool frequencies of the top 50 neighbors according to Euclidean distances in Seurat’s PCA space, and (4) predicting using the weighted pool frequencies of all cells, where the weights are set as MAGIC’s diffusion similarities (more specifically, MAGIC’s powered Markov affinity matrix). Pool frequencies were computed as regularized geometric means, denoting by <italic>w</italic><sub><italic>i</italic></sub> the weight of cell <italic>i</italic> in the pool (for strategies 1–3 all weights are 1):
<disp-formula id="Equj"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {p}_{g, pool}=\mathrm{e} xp\left[\left(\frac{1}{\Sigma_i{w}_i}{\sum}_{\left\{i\in Pool\right\}}{\mathrm{w}}_{\mathrm{i}}\ \log 2\left(1+7{u}_{gi}\right)\right)-1\right]/\left(\frac{1}{\Sigma_i{w}_i}{\sum}_{\left\{i\in Pool\right\}}{w}_i{u}_i\right) $$\end{document}</tex-math><mml:math id="M32" display="block"><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>g</mml:mi><mml:mo>,</mml:mo><mml:mtext mathvariant="italic">pool</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="italic">xp</mml:mi><mml:mfenced close="]" open="["><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msub><mml:mi mathvariant="normal">Σ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>w</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:msub><mml:mo>∑</mml:mo><mml:mfenced close="}" open="{"><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mtext mathvariant="italic">Pool</mml:mtext></mml:mrow></mml:mfenced></mml:msub><mml:msub><mml:mi mathvariant="normal">w</mml:mi><mml:mi mathvariant="normal">i</mml:mi></mml:msub><mml:mspace width="0.25em"/><mml:mo>log</mml:mo><mml:mn>2</mml:mn><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mn>7</mml:mn><mml:msub><mml:mi>u</mml:mi><mml:mi mathvariant="italic">gi</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfenced><mml:mo>/</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msub><mml:mi mathvariant="normal">Σ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>w</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:msub><mml:mo>∑</mml:mo><mml:mfenced close="}" open="{"><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mtext mathvariant="italic">Pool</mml:mtext></mml:mrow></mml:mfenced></mml:msub><mml:msub><mml:mi>w</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>u</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="13059_2019_1812_Article_Equj.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par64">The extent of over-fitting was tested by avoiding the cross-validation design and computing a single similarity matrix using all genes per modeling approach. Regardless of whether cross-validation was used, a cell was never a part of its own prediction pool when comparing prediction accuracy (Fig. <xref rid="Fig3" ref-type="fig">3</xref>b, c). In contrast, for plotting the gradients (Fig. <xref rid="Fig3" ref-type="fig">3</xref>d, e), the predicted values were generated using all genes and all cells, as in a typical analysis.</p>
      <p id="Par65">Combining Seurat and MetaCell’s filtering criteria, only cells with at least 800 UMIs, number of expressed genes between 800 and 4000, and mitochondrial gene fraction below 0.1 are included. We omitted from the modeling and the evaluation mitochondrial genes and immunoglobulin genes. For MetaCell, we used MC size parameter <italic>K</italic> = 100 and 500 down-samples of 0.75 of the data during the graph resampling stage. For Seurat (package downloaded on 18/3/26), we used gene selection parameters <italic>x</italic>.low.cutoff = 0, <italic>y</italic>.cutoff = 0.8, negative binomial scaling over mitochondrial fraction and number of UMIs, and 40 PCs. For MAGIC (code downloaded on 18/3/19), we used 30 PCs, <italic>k</italic> = 5, ka = 4, epsilon = 1, and <italic>t</italic> = 6.</p>
    </sec>
    <sec id="Sec26">
      <title>Whole organism scRNA-seq analysis</title>
      <p id="Par66">For the <italic>Caenorhabditis elegans</italic> map, we analyzed the whole-organism single-cell dataset published by Cao et al. [<xref ref-type="bibr" rid="CR42">42</xref>] and generated using methanol-fixed larval L2 stage cells and a split&amp;pool scRNA-seq strategy. We started from a UMI matrix containing 41,449 single cells. We filtered out cells with less than 100 and more than 8000 total UMIs. We used MetaCell to select marker genes with the following criteria: (1) a normalized size correlation below − 0.1 and/or a niche score over 0.1, (2) a minimum of 300 total UMIs observed, and (3) a minimum of 3 UMIs observed in at least three single cells. For MetaCell, we used MC size parameter <italic>K</italic> = 150 and 1000 down-samples of 0.75 of the data during the graph resampling stage. We computed the final partition from the co-occurrence matrix using a size parameter <italic>K</italic> = 30, a minimum MC size parameter of 30 and alpha = 2. We filtered outlier cells using a filtering parameter T_lfc = 4, resulting in a final filtered set of 38,149 cells.</p>
      <p id="Par67">For <italic>Schmidtea mediterranea</italic>, we analyzed the whole-adult single-cell dataset published by Fincher et al. [<xref ref-type="bibr" rid="CR43">43</xref>] and generated using fresh cells from whole-adult and head area planarian samples and the Drop-seq scRNA-seq technology. We started from a UMI matrix containing 58,328 single cells. We filtered out cells with less than 500 and more than 18,000 total UMIs. We used MetaCell to select marker genes with the following criteria: (1) a normalized size correlation below − 0.1 and/or a niche score over 0.05, (2) a minimum of 300 total UMIs observed, and (3) a minimum of 3 UMIs observed in at least three single cells. In the graph partitioning stage, we used the same parameters as in the <italic>C. elegans</italic> analysis. We filtered outlier cells using a filtering parameter T_lfc = 4.5, resulting in a final filtered set of 56,627 cells.</p>
    </sec>
    <sec id="Sec27">
      <title>Fine clustering using Seurat</title>
      <p id="Par68">Seurat’s clustering algorithm was used for producing a high-resolution clustering of the 160K PBMCs dataset by applying the following procedure: Data was log-normalized and scaled to 10,000 UMIs per cell, 1000 genes with top variance/mean ratio were used as highly variable genes, these genes were rescaled by regressing on per-cell number of UMIs, and PCA reduction to 45 dimensions was applied to the rescaled variable genes. In order to generate a fine clustering solution, we set Seurat’s resolution parameter to 100, using the approximation parameters nn.eps = 0.5 and n.start = 10, which yielded 817 clusters. We note that Seurat is typically executed with much lower resolution values (0.6–3).</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec28">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="13059_2019_1812_MOESM1_ESM.docx">
            <caption>
              <p><bold>Additional file 1:</bold><bold>Table S1.</bold> Describing key parameters in the MetaCell pipeline and how to tune them. (DOCX 15 kb)</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="13059_2019_1812_MOESM2_ESM.docx">
            <caption>
              <p><bold>Additional file 2:</bold> Supplementary figures (Figures S1-S11). (DOCX 9191 kb)</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="13059_2019_1812_MOESM3_ESM.docx">
            <caption>
              <p><bold>Additional file 3.</bold> Two strategies for selection of feature genes used in the MetaCell package. (DOCX 14 kb)</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p>
        <bold>Publisher’s Note</bold>
      </p>
      <p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <sec>
    <title>Supplementary information</title>
    <p><bold>Supplementary information</bold> accompanies this paper at 10.1186/s13059-019-1812-2.</p>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We are grateful to all members of the Tanay group for discussion.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Authors’ contributions</title>
    <p>YB and AT designed the study. YB, ASP, YL, and AT developed the MC algorithm with input from AG, EC, and ZM. YB performed the computational experiments with help from AB and YL. AT, YB, YL, AL, EC and MH implemented the algorithms. YB and AT wrote the manuscript with input from all authors. AT supervised the study. All authors read and approved the final manuscript.</p>
  </notes>
  <notes notes-type="funding-information">
    <title>Funding</title>
    <p>Work in AT group was supported in part by an ERC grant 724824, the Chan Zuckerberg Association, the Wolfson foundation, and FAMRI.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Availability of data and materials</title>
    <p>MetaCell’s open-source code is maintained and documented on GitHub [<xref ref-type="bibr" rid="CR51">51</xref>] and is publicly available under the MIT license from the following Zenodo repository (DOI: 10.5281/zenodo.3334525) [<xref ref-type="bibr" rid="CR52">52</xref>].</p>
    <p>The PBMC data sets were downloaded from the 10x Genomics website [<xref ref-type="bibr" rid="CR53">53</xref>].</p>
    <p><italic>C. elegans</italic> L2 larva stage dataset was obtained from the Cell Atlas of Worm website [<xref ref-type="bibr" rid="CR54">54</xref>].</p>
    <p>Planaria whole-organism dataset was obtained from NCBI’s GEO [<xref ref-type="bibr" rid="CR55">55</xref>].</p>
  </notes>
  <notes>
    <title>Ethics approval and consent to participate</title>
    <p id="Par69">Not applicable</p>
  </notes>
  <notes>
    <title>Consent for publication</title>
    <p id="Par70">Not applicable</p>
  </notes>
  <notes notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par71">The authors declare that they have no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kumar</surname>
            <given-names>RM</given-names>
          </name>
          <name>
            <surname>Cahan</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Shalek</surname>
            <given-names>AK</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>DaleyKeyser</surname>
            <given-names>AJ</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>H</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Deconstructing transcriptional heterogeneity in pluripotent stem cells</article-title>
        <source>Nature.</source>
        <year>2014</year>
        <volume>516</volume>
        <issue>7529</issue>
        <fpage>56</fpage>
        <pub-id pub-id-type="doi">10.1038/nature13920</pub-id>
        <pub-id pub-id-type="pmid">25471879</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Macosko</surname>
            <given-names>EZ</given-names>
          </name>
          <name>
            <surname>Basu</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Nemesh</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Shekhar</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Goldman</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Highly parallel genome-wide expression profiling of individual cells using nanoliter droplets</article-title>
        <source>Cell.</source>
        <year>2015</year>
        <volume>161</volume>
        <issue>5</issue>
        <fpage>1202</fpage>
        <lpage>1214</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2015.05.002</pub-id>
        <pub-id pub-id-type="pmid">26000488</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Jaitin</surname>
            <given-names>DA</given-names>
          </name>
          <name>
            <surname>Kenigsberg</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Keren-Shaul</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Elefant</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Paul</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Zaretsky</surname>
            <given-names>I</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Massively parallel single-cell RNA-seq for marker-free decomposition of tissues into cell types</article-title>
        <source>Science.</source>
        <year>2014</year>
        <volume>343</volume>
        <issue>6172</issue>
        <fpage>776</fpage>
        <lpage>779</lpage>
        <pub-id pub-id-type="doi">10.1126/science.1247651</pub-id>
        <pub-id pub-id-type="pmid">24531970</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zeisel</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Muñoz-Manchado</surname>
            <given-names>AB</given-names>
          </name>
          <name>
            <surname>Codeluppi</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Lönnerberg</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>La Manno</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Juréus</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cell types in the mouse cortex and hippocampus revealed by single-cell RNA-seq</article-title>
        <source>Science.</source>
        <year>2015</year>
        <volume>347</volume>
        <issue>6226</issue>
        <fpage>1138</fpage>
        <lpage>1142</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aaa1934</pub-id>
        <pub-id pub-id-type="pmid">25700174</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Reinius</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Mold</surname>
            <given-names>JE</given-names>
          </name>
          <name>
            <surname>Ramsköld</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Deng</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Johnsson</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Michaëlsson</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Analysis of allelic expression patterns in clonal somatic cells by single-cell RNA–seq</article-title>
        <source>Nat Genet</source>
        <year>2016</year>
        <volume>48</volume>
        <issue>11</issue>
        <fpage>1430</fpage>
        <pub-id pub-id-type="doi">10.1038/ng.3678</pub-id>
        <pub-id pub-id-type="pmid">27668657</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Grün</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Lyubimova</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Kester</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Wiebrands</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Basak</surname>
            <given-names>O</given-names>
          </name>
          <name>
            <surname>Sasaki</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell messenger RNA sequencing reveals rare intestinal cell types</article-title>
        <source>Nature.</source>
        <year>2015</year>
        <volume>525</volume>
        <issue>7568</issue>
        <fpage>251</fpage>
        <pub-id pub-id-type="doi">10.1038/nature14966</pub-id>
        <pub-id pub-id-type="pmid">26287467</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Levin</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Anavy</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Cole</surname>
            <given-names>AG</given-names>
          </name>
          <name>
            <surname>Winter</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Mostov</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Khair</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The mid-developmental transition and the evolution of animal body plans</article-title>
        <source>Nature.</source>
        <year>2016</year>
        <volume>531</volume>
        <issue>7596</issue>
        <fpage>637</fpage>
        <pub-id pub-id-type="doi">10.1038/nature16994</pub-id>
        <pub-id pub-id-type="pmid">26886793</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Buettner</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Natarajan</surname>
            <given-names>KN</given-names>
          </name>
          <name>
            <surname>Casale</surname>
            <given-names>FP</given-names>
          </name>
          <name>
            <surname>Proserpio</surname>
            <given-names>V</given-names>
          </name>
          <name>
            <surname>Scialdone</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Computational analysis of cell-to-cell heterogeneity in single-cell RNA-sequencing data reveals hidden subpopulations of cells</article-title>
        <source>Nat Biotechnol</source>
        <year>2015</year>
        <volume>33</volume>
        <issue>2</issue>
        <fpage>155</fpage>
        <pub-id pub-id-type="doi">10.1038/nbt.3102</pub-id>
        <pub-id pub-id-type="pmid">25599176</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Plass</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Solana</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Ayoub</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Misios</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Glažar</surname>
            <given-names>P</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cell type atlas and lineage tree of a whole complex animal by single-cell transcriptomics</article-title>
        <source>Science</source>
        <year>2018</year>
        <volume>360</volume>
        <issue>6391</issue>
        <fpage>eaaq1723</fpage>
        <pub-id pub-id-type="doi">10.1126/science.aaq1723</pub-id>
        <pub-id pub-id-type="pmid">29674432</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tanay</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Scaling single-cell genomics from phenomenology to mechanism</article-title>
        <source>Nature.</source>
        <year>2017</year>
        <volume>541</volume>
        <issue>7637</issue>
        <fpage>331</fpage>
        <pub-id pub-id-type="doi">10.1038/nature21350</pub-id>
        <pub-id pub-id-type="pmid">28102262</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Grün</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Muraro</surname>
            <given-names>MJ</given-names>
          </name>
          <name>
            <surname>Boisset</surname>
            <given-names>J-C</given-names>
          </name>
          <name>
            <surname>Wiebrands</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Lyubimova</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Dharmadhikari</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>De novo prediction of stem cell identity using single-cell transcriptome data</article-title>
        <source>Cell Stem Cell</source>
        <year>2016</year>
        <volume>19</volume>
        <issue>2</issue>
        <fpage>266</fpage>
        <lpage>277</lpage>
        <pub-id pub-id-type="doi">10.1016/j.stem.2016.05.010</pub-id>
        <pub-id pub-id-type="pmid">27345837</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Farrell</surname>
            <given-names>JA</given-names>
          </name>
          <name>
            <surname>Gennert</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Schier</surname>
            <given-names>AF</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Spatial reconstruction of single-cell gene expression data</article-title>
        <source>Nat Biotechnol</source>
        <year>2015</year>
        <volume>33</volume>
        <issue>5</issue>
        <fpage>495</fpage>
        <pub-id pub-id-type="doi">10.1038/nbt.3192</pub-id>
        <pub-id pub-id-type="pmid">25867923</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kiselev</surname>
            <given-names>VY</given-names>
          </name>
          <name>
            <surname>Kirschner</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Schaub</surname>
            <given-names>MT</given-names>
          </name>
          <name>
            <surname>Andrews</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Yiu</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Chandra</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>SC3: consensus clustering of single-cell RNA-seq data</article-title>
        <source>Nat Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <issue>5</issue>
        <fpage>483</fpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4236</pub-id>
        <pub-id pub-id-type="pmid">28346451</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Courtois</surname>
            <given-names>ET</given-names>
          </name>
          <name>
            <surname>Sengupta</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Tan</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>KH</given-names>
          </name>
          <name>
            <surname>Goh</surname>
            <given-names>JJL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Reference component analysis of single-cell transcriptomes elucidates cellular heterogeneity in human colorectal tumors</article-title>
        <source>Nat Genet</source>
        <year>2017</year>
        <volume>49</volume>
        <issue>5</issue>
        <fpage>708</fpage>
        <pub-id pub-id-type="doi">10.1038/ng.3818</pub-id>
        <pub-id pub-id-type="pmid">28319088</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lin</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Troup</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Ho</surname>
            <given-names>JW</given-names>
          </name>
        </person-group>
        <article-title>CIDR: ultrafast and accurate clustering through imputation for single-cell RNA-seq data</article-title>
        <source>Genome Biol</source>
        <year>2017</year>
        <volume>18</volume>
        <issue>1</issue>
        <fpage>59</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-017-1188-0</pub-id>
        <pub-id pub-id-type="pmid">28351406</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bendall</surname>
            <given-names>SC</given-names>
          </name>
          <name>
            <surname>Davis</surname>
            <given-names>KL</given-names>
          </name>
          <name>
            <surname>Amir</surname>
            <given-names>ED</given-names>
          </name>
          <name>
            <surname>Tadmor</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>Simonds</surname>
            <given-names>EF</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>TJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell trajectory detection uncovers progression and regulatory coordination in human B cell development</article-title>
        <source>Cell.</source>
        <year>2014</year>
        <volume>157</volume>
        <issue>3</issue>
        <fpage>714</fpage>
        <lpage>725</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2014.04.005</pub-id>
        <pub-id pub-id-type="pmid">24766814</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Trapnell</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Cacchiarelli</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Grimsby</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Pokharel</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Morse</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The dynamics and regulators of cell fate decisions are revealed by pseudotemporal ordering of single cells</article-title>
        <source>Nat Biotechnol</source>
        <year>2014</year>
        <volume>32</volume>
        <issue>4</issue>
        <fpage>381</fpage>
        <pub-id pub-id-type="doi">10.1038/nbt.2859</pub-id>
        <pub-id pub-id-type="pmid">24658644</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Haghverdi</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Buettner</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>Diffusion maps for high-dimensional single-cell analysis of differentiation data</article-title>
        <source>Bioinformatics.</source>
        <year>2015</year>
        <volume>31</volume>
        <issue>18</issue>
        <fpage>2989</fpage>
        <lpage>2998</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btv325</pub-id>
        <pub-id pub-id-type="pmid">26002886</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ocone</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Haghverdi</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Mueller</surname>
            <given-names>NS</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>Reconstructing gene regulatory dynamics from high-dimensional single-cell snapshot data</article-title>
        <source>Bioinformatics.</source>
        <year>2015</year>
        <volume>31</volume>
        <issue>12</issue>
        <fpage>i89</fpage>
        <lpage>i96</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btv257</pub-id>
        <pub-id pub-id-type="pmid">26072513</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Shin</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Berg</surname>
            <given-names>DA</given-names>
          </name>
          <name>
            <surname>Zhu</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Shin</surname>
            <given-names>JY</given-names>
          </name>
          <name>
            <surname>Song</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Bonaguidi</surname>
            <given-names>MA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell RNA-seq with waterfall reveals molecular cascades underlying adult neurogenesis</article-title>
        <source>Cell Stem Cell</source>
        <year>2015</year>
        <volume>17</volume>
        <issue>3</issue>
        <fpage>360</fpage>
        <lpage>372</lpage>
        <pub-id pub-id-type="doi">10.1016/j.stem.2015.07.013</pub-id>
        <pub-id pub-id-type="pmid">26299571</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ji</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Ji</surname>
            <given-names>H</given-names>
          </name>
        </person-group>
        <article-title>TSCAN: pseudo-time reconstruction and evaluation in single-cell RNA-seq analysis</article-title>
        <source>Nucleic Acids Res</source>
        <year>2016</year>
        <volume>44</volume>
        <issue>13</issue>
        <fpage>e117</fpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkw430</pub-id>
        <pub-id pub-id-type="pmid">27179027</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Welch</surname>
            <given-names>JD</given-names>
          </name>
          <name>
            <surname>Hartemink</surname>
            <given-names>AJ</given-names>
          </name>
          <name>
            <surname>Prins</surname>
            <given-names>JF</given-names>
          </name>
        </person-group>
        <article-title>SLICER: inferring branched, nonlinear cellular trajectories from single cell RNA-seq data</article-title>
        <source>Genome Biol</source>
        <year>2016</year>
        <volume>17</volume>
        <issue>1</issue>
        <fpage>106</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-016-0975-3</pub-id>
        <pub-id pub-id-type="pmid">27215581</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Street</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Risso</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Fletcher</surname>
            <given-names>RB</given-names>
          </name>
          <name>
            <surname>Das</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Ngai</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Yosef</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Slingshot: cell lineage and pseudotime inference for single-cell transcriptomics</article-title>
        <source>BMC Genomics</source>
        <year>2018</year>
        <volume>19</volume>
        <issue>1</issue>
        <fpage>477</fpage>
        <pub-id pub-id-type="doi">10.1186/s12864-018-4772-0</pub-id>
        <pub-id pub-id-type="pmid">29914354</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zheng</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Papalexi</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Butler</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Stephenson</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Molecular transitions in early progenitors during human cord blood hematopoiesis</article-title>
        <source>Mol Syst Biol</source>
        <year>2018</year>
        <volume>14</volume>
        <issue>3</issue>
        <fpage>e8041</fpage>
        <pub-id pub-id-type="doi">10.15252/msb.20178041</pub-id>
        <pub-id pub-id-type="pmid">29545397</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Van Dijk</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Sharma</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Nainys</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Yim</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Kathail</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Carr</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Recovering gene interactions from single-cell data using data diffusion</article-title>
        <source>Cell.</source>
        <year>2018</year>
        <volume>174</volume>
        <issue>3</issue>
        <fpage>716</fpage>
        <lpage>729</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2018.05.061</pub-id>
        <pub-id pub-id-type="pmid">29961576</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <mixed-citation publication-type="other">Ronen J, Akalin A. netSmooth: Network-smoothing based imputation for single cell RNA-seq [version 3; peer review: 2 approved]. F1000Research. 2018;7:8.</mixed-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <mixed-citation publication-type="other">Wagner F, Yan Y, Yanai I. K-nearest neighbor smoothing for high-throughput single-cell RNA-Seq data. bioRxiv. 2018; Available from: <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/early/2018/04/09/217737">https://www.biorxiv.org/content/early/2018/04/09/217737</ext-link></mixed-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <mixed-citation publication-type="other">Huang M, Wang J, Torre E, Dueck H, Shaffer S, Bonasio R, et al. SAVER: gene expression recovery for single-cell RNA sequencing . Nat Methods. 2018;15(7):539-42.</mixed-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <mixed-citation publication-type="other">Azizi E, Carr AJ, Plitas G, Cornish AE, Konopacki C, Prabhakaran S, et al. Single-cell map of diverse immune phenotypes in the breast tumor microenvironment . Cell. 2018;174(5):1293-308.</mixed-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <mixed-citation publication-type="other">Li WV, Li JJ. An accurate and robust imputation method scImpute for single-cell RNA-seq data. Nat Commun. 2018;9(1):997.</mixed-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <mixed-citation publication-type="other">Giladi A, Paul F, Herzog Y, Lubling Y, Weiner A, Yofe I, et al. Single-cell characterization of haematopoietic procgenitors and their trajectories in homeostasis and perturbed haematopoiesis. Nat Cell Biol. 2018;20(7):836-46.</mixed-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>van der Leun</surname>
            <given-names>AM</given-names>
          </name>
          <name>
            <surname>Yofe</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Lubling</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Gelbard-Solodkin</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>van Akkooi</surname>
            <given-names>AC</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Dysfunctional CD8 T cells form a proliferative, dynamically regulated compartment within human melanoma</article-title>
        <source>Cell.</source>
        <year>2019</year>
        <volume>176</volume>
        <issue>4</issue>
        <fpage>775</fpage>
        <lpage>789</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2018.11.043</pub-id>
        <pub-id pub-id-type="pmid">30595452</pub-id>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ledergor</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Weiner</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Zada</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>S-Y</given-names>
          </name>
          <name>
            <surname>Cohen</surname>
            <given-names>YC</given-names>
          </name>
          <name>
            <surname>Gatt</surname>
            <given-names>ME</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single cell dissection of plasma cell heterogeneity in symptomatic and asymptomatic myeloma</article-title>
        <source>Nat Med</source>
        <year>2018</year>
        <volume>24</volume>
        <issue>12</issue>
        <fpage>1867</fpage>
        <pub-id pub-id-type="doi">10.1038/s41591-018-0269-2</pub-id>
        <pub-id pub-id-type="pmid">30523328</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sebé-Pedrós</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Saudemont</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Chomsky</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Plessier</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Mailhé</surname>
            <given-names>M-P</given-names>
          </name>
          <name>
            <surname>Renno</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cnidarian cell type diversity and regulation revealed by whole-organism single-cell RNA-Seq</article-title>
        <source>Cell.</source>
        <year>2018</year>
        <volume>173</volume>
        <issue>6</issue>
        <fpage>1520</fpage>
        <lpage>1534</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2018.05.019</pub-id>
        <pub-id pub-id-type="pmid">29856957</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sebé-Pedrós</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Chomsky</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Pang</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Lara-Astiaso</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Gaiti</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Mukamel</surname>
            <given-names>Z</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Early metazoan cell type diversity and the evolution of multicellular gene regulation</article-title>
        <source>Nat Ecol Evol</source>
        <year>2018</year>
        <volume>2</volume>
        <issue>7</issue>
        <fpage>1176</fpage>
        <pub-id pub-id-type="doi">10.1038/s41559-018-0575-6</pub-id>
        <pub-id pub-id-type="pmid">29942020</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Laurenti</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Doulatov</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Zandi</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Plumb</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>April</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The transcriptional architecture of early human hematopoiesis identifies multilevel control of lymphoid commitment</article-title>
        <source>Nat Immunol</source>
        <year>2013</year>
        <volume>14</volume>
        <issue>7</issue>
        <fpage>756</fpage>
        <pub-id pub-id-type="doi">10.1038/ni.2615</pub-id>
        <pub-id pub-id-type="pmid">23708252</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Donnadieu</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Jouvin</surname>
            <given-names>M-H</given-names>
          </name>
          <name>
            <surname>Rana</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Moffatt</surname>
            <given-names>MF</given-names>
          </name>
          <name>
            <surname>Mockford</surname>
            <given-names>EH</given-names>
          </name>
          <name>
            <surname>Cookson</surname>
            <given-names>WO</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Competing functions encoded in the allergy-associated FcϵRIβ gene</article-title>
        <source>Immunity.</source>
        <year>2003</year>
        <volume>18</volume>
        <issue>5</issue>
        <fpage>665</fpage>
        <lpage>674</lpage>
        <pub-id pub-id-type="doi">10.1016/S1074-7613(03)00115-8</pub-id>
        <pub-id pub-id-type="pmid">12753743</pub-id>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Haghverdi</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Lun</surname>
            <given-names>AT</given-names>
          </name>
          <name>
            <surname>Morgan</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>Marioni</surname>
            <given-names>JC</given-names>
          </name>
        </person-group>
        <article-title>Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors</article-title>
        <source>Nat Biotechnol</source>
        <year>2018</year>
        <volume>36</volume>
        <issue>5</issue>
        <fpage>421</fpage>
        <pub-id pub-id-type="doi">10.1038/nbt.4091</pub-id>
        <pub-id pub-id-type="pmid">29608177</pub-id>
      </element-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Butler</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Hoffman</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Smibert</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Papalexi</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Integrating single-cell transcriptomic data across different conditions, technologies, and species</article-title>
        <source>Nat Biotechnol</source>
        <year>2018</year>
        <volume>36</volume>
        <issue>5</issue>
        <fpage>411</fpage>
        <pub-id pub-id-type="doi">10.1038/nbt.4096</pub-id>
        <pub-id pub-id-type="pmid">29608179</pub-id>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <mixed-citation publication-type="other">McInnes L, Healy J, Melville J. Umap: Uniform manifold approximation and projection for dimension reduction. rXiv:1802.03426v2. 2018.</mixed-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <mixed-citation publication-type="other">Zhang L, Zhang S. Comparison of computational methods for imputing single-cell RNA-sequencing data. IEEE/ACM Trans Comput Biol Bioinform. 2018;1. 10.1109/TCBB.2018.2848633.</mixed-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cao</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Packer</surname>
            <given-names>JS</given-names>
          </name>
          <name>
            <surname>Ramani</surname>
            <given-names>V</given-names>
          </name>
          <name>
            <surname>Cusanovich</surname>
            <given-names>DA</given-names>
          </name>
          <name>
            <surname>Huynh</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Daza</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Comprehensive single-cell transcriptional profiling of a multicellular organism</article-title>
        <source>Science.</source>
        <year>2017</year>
        <volume>357</volume>
        <issue>6352</issue>
        <fpage>661</fpage>
        <lpage>667</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aam8940</pub-id>
        <pub-id pub-id-type="pmid">28818938</pub-id>
      </element-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Fincher</surname>
            <given-names>CT</given-names>
          </name>
          <name>
            <surname>Wurtzel</surname>
            <given-names>O</given-names>
          </name>
          <name>
            <surname>de Hoog</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Kravarik</surname>
            <given-names>KM</given-names>
          </name>
          <name>
            <surname>Reddien</surname>
            <given-names>PW</given-names>
          </name>
        </person-group>
        <article-title>Cell type transcriptome atlas for the planarian Schmidtea mediterranea</article-title>
        <source>Science</source>
        <year>2018</year>
        <volume>360</volume>
        <issue>6391</issue>
        <fpage>eaaq1736</fpage>
        <pub-id pub-id-type="doi">10.1126/science.aaq1736</pub-id>
        <pub-id pub-id-type="pmid">29674431</pub-id>
      </element-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zheng</surname>
            <given-names>GX</given-names>
          </name>
          <name>
            <surname>Terry</surname>
            <given-names>JM</given-names>
          </name>
          <name>
            <surname>Belgrader</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Ryvkin</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Bent</surname>
            <given-names>ZW</given-names>
          </name>
          <name>
            <surname>Wilson</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Massively parallel digital transcriptional profiling of single cells</article-title>
        <source>Nat Commun</source>
        <year>2017</year>
        <volume>8</volume>
        <fpage>14049</fpage>
        <pub-id pub-id-type="doi">10.1038/ncomms14049</pub-id>
        <pub-id pub-id-type="pmid">28091601</pub-id>
      </element-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Voskoboinik</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Whisstock</surname>
            <given-names>JC</given-names>
          </name>
          <name>
            <surname>Trapani</surname>
            <given-names>JA</given-names>
          </name>
        </person-group>
        <article-title>Perforin and granzymes: function, dysfunction and human pathology</article-title>
        <source>Nat Rev Immunol</source>
        <year>2015</year>
        <volume>15</volume>
        <issue>6</issue>
        <fpage>388</fpage>
        <pub-id pub-id-type="doi">10.1038/nri3839</pub-id>
        <pub-id pub-id-type="pmid">25998963</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schelker</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Feau</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Du</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Ranu</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Klipp</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>MacBeath</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Estimation of immune cell content in tumour tissue using single-cell RNA-seq data</article-title>
        <source>Nat Commun</source>
        <year>2017</year>
        <volume>8</volume>
        <issue>1</issue>
        <fpage>2032</fpage>
        <pub-id pub-id-type="doi">10.1038/s41467-017-02289-3</pub-id>
        <pub-id pub-id-type="pmid">29230012</pub-id>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Fan</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Salathia</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Liu</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Kaeser</surname>
            <given-names>GE</given-names>
          </name>
          <name>
            <surname>Yung</surname>
            <given-names>YC</given-names>
          </name>
          <name>
            <surname>Herman</surname>
            <given-names>JL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Characterizing transcriptional heterogeneity through pathway and gene set overdispersion analysis</article-title>
        <source>Nat Methods</source>
        <year>2016</year>
        <volume>13</volume>
        <issue>3</issue>
        <fpage>241</fpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.3734</pub-id>
        <pub-id pub-id-type="pmid">26780092</pub-id>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Buettner</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Pratanwanich</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>McCarthy</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Marioni</surname>
            <given-names>JC</given-names>
          </name>
          <name>
            <surname>Stegle</surname>
            <given-names>O</given-names>
          </name>
        </person-group>
        <article-title>f-scLVM: scalable and versatile factor analysis for single-cell RNA-seq</article-title>
        <source>Genome Biol</source>
        <year>2017</year>
        <volume>18</volume>
        <issue>1</issue>
        <fpage>212</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-017-1334-8</pub-id>
        <pub-id pub-id-type="pmid">29115968</pub-id>
      </element-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Peixoto</surname>
            <given-names>TP</given-names>
          </name>
        </person-group>
        <article-title>Hierarchical block structures and high-resolution model selection in large networks</article-title>
        <source>Phys Rev X</source>
        <year>2014</year>
        <volume>4</volume>
        <issue>1</issue>
        <fpage>011047</fpage>
      </element-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <mixed-citation publication-type="other">Wolf FA, Hamey F, Plass M, Solana J, Dahlin JS, Gottgens B, et al. Graph abstraction reconciles clustering with trajectory inference through a topology preserving map of single cells. bioRxiv [Internet]. 2017; Available from: <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/early/2017/10/25/208819">https://www.biorxiv.org/content/early/2017/10/25/208819</ext-link></mixed-citation>
    </ref>
    <ref id="CR51">
      <label>51.</label>
      <mixed-citation publication-type="other">MetaCell: analysis of single cell RNA-seq data using k-NN graph partitions [Internet]. [cited 2019 Sep 1]. Available from: <ext-link ext-link-type="uri" xlink:href="https://tanaylab.github.io/metacell/">https://tanaylab.github.io/metacell/</ext-link></mixed-citation>
    </ref>
    <ref id="CR52">
      <label>52.</label>
      <mixed-citation publication-type="other">Yael Baran, Akhiad Bercovich, Arnau Sebe-Pedros, Yaniv Lubling, Amir Giladi, Elad Chomsky, et al. MetaCell: analysis of single cell RNA-seq data using k-NN graph partitions [Internet]. Zenodo; 2019 [cited 2019 Jul 14]. Available from: 10.5281/zenodo.3334525.</mixed-citation>
    </ref>
    <ref id="CR53">
      <label>53.</label>
      <mixed-citation publication-type="other">Datasets - Single Cell Gene Expression - Official 10x Genomics Support [Internet]. [cited 2019 Jul 13]. Available from: <ext-link ext-link-type="uri" xlink:href="https://support.10xgenomics.com/single-cell-gene-expression/datasets">https://support.10xgenomics.com/single-cell-gene-expression/datasets</ext-link></mixed-citation>
    </ref>
    <ref id="CR54">
      <label>54.</label>
      <mixed-citation publication-type="other">Cell Atlas of Worm [Internet]. [cited 2017 Jun 27]. Available from: <ext-link ext-link-type="uri" xlink:href="http://atlas.gs.washington.edu/worm-rna/data/">http://atlas.gs.washington.edu/worm-rna/data/</ext-link></mixed-citation>
    </ref>
    <ref id="CR55">
      <label>55.</label>
      <mixed-citation publication-type="other">Cell type transcriptome atlas for the planarian Schmidtea mediterranea [Internet]. [cited 2018 Apr 17]. Available from: <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE111764">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE111764</ext-link></mixed-citation>
    </ref>
  </ref-list>
</back>
