<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Commun</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Commun</journal-id>
    <journal-title-group>
      <journal-title>Nature Communications</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2041-1723</issn>
    <publisher>
      <publisher-name>Nature Publishing Group UK</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">7455704</article-id>
    <article-id pub-id-type="publisher-id">17900</article-id>
    <article-id pub-id-type="doi">10.1038/s41467-020-17900-3</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>A clustering-independent method for finding differentially expressed genes in single-cell transcriptome data</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-2180-5732</contrib-id>
        <name>
          <surname>Vandenbon</surname>
          <given-names>Alexis</given-names>
        </name>
        <address>
          <email>alexisvdb@infront.kyoto-u.ac.jp</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-2325-4893</contrib-id>
        <name>
          <surname>Diez</surname>
          <given-names>Diego</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.258799.8</institution-id><institution-id institution-id-type="ISNI">0000 0004 0372 2033</institution-id><institution>Institute for Frontier Life and Medical Sciences, </institution><institution>Kyoto University, </institution></institution-wrap>53 Shougoin Kawara-cho, Sakyo-ku, Kyoto, 606-8507 Japan </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.258799.8</institution-id><institution-id institution-id-type="ISNI">0000 0004 0372 2033</institution-id><institution>Institute for Liberal Arts and Sciences, </institution><institution>Kyoto University, </institution></institution-wrap>Yoshidanihonmatsu-cho, Sakyo-ku, Kyoto, 606-8501 Japan </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="GRID">grid.136593.b</institution-id><institution-id institution-id-type="ISNI">0000 0004 0373 3971</institution-id><institution>Immunology Frontier Research Center, </institution><institution>Osaka University, </institution></institution-wrap>3-1 Yamada-oka, Suita, Osaka, 565-0871 Japan </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>28</day>
      <month>8</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>28</day>
      <month>8</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2020</year>
    </pub-date>
    <volume>11</volume>
    <elocation-id>4318</elocation-id>
    <history>
      <date date-type="received">
        <day>7</day>
        <month>11</month>
        <year>2019</year>
      </date>
      <date date-type="accepted">
        <day>21</day>
        <month>7</month>
        <year>2020</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2020</copyright-statement>
      <license license-type="OpenAccess">
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">A common analysis of single-cell sequencing data includes clustering of cells and identifying differentially expressed genes (DEGs). How cell clusters are defined has important consequences for downstream analyses and the interpretation of results, but is often not straightforward. To address this difficulty, we present singleCellHaystack, a method that enables the prediction of DEGs without relying on explicit clustering of cells. Our method uses Kullback–Leibler divergence to find genes that are expressed in subsets of cells that are non-randomly positioned in a multidimensional space. Comparisons with existing DEG prediction approaches on artificial datasets show that singleCellHaystack has higher accuracy. We illustrate the usage of singleCellHaystack through applications on 136 real transcriptome datasets and a spatial transcriptomics dataset. We demonstrate that our method is a fast and accurate approach for DEG prediction in single-cell data. singleCellHaystack is implemented as an R package and is available from CRAN and GitHub.</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">How cell clusters are defined in single-cell sequencing data has important consequences for downstream analyses and the interpretation of results, but is often not straightforward. Here, the authors present a new approach that enables the prediction of differentially expressed genes without relying on explicit clustering of cells.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Computational biology and bioinformatics</kwd>
      <kwd>Data mining</kwd>
      <kwd>Gene regulatory networks</kwd>
      <kwd>Software</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>This work was supported by an Office of Directors’ Research Grant provided by the Institute for Frontier Life and Medical Sciences (Kyoto University), and by the Future Development Funding Program of the Kyoto University Research Coordination Alliance.</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2020</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1" sec-type="introduction">
    <title>Introduction</title>
    <p id="Par3">Recent advances in single-cell technologies enable us to assess the state of cells by measuring different modalities like RNA and protein expression with single-cell resolution<sup><xref ref-type="bibr" rid="CR1">1</xref>–<xref ref-type="bibr" rid="CR5">5</xref></sup>. Hundreds of bioinformatics tools have been developed to process, analyze, and interpret the results from single-cell genomics data<sup><xref ref-type="bibr" rid="CR6">6</xref></sup>, such as monocle 2 and Seurat<sup><xref ref-type="bibr" rid="CR7">7</xref>,<xref ref-type="bibr" rid="CR8">8</xref></sup>.</p>
    <p id="Par4">A standard protocol for analyzing single-cell data includes dimensionality reduction methods, such as principal component analysis (PCA), t-distributed stochastic neighbor embedding (t-SNE), and uniform manifold approximation and projection (UMAP) to visualize the data in fewer (typically 2) dimensions<sup><xref ref-type="bibr" rid="CR9">9</xref>,<xref ref-type="bibr" rid="CR10">10</xref></sup>. In addition, cells are often clustered, and differentially expressed genes (DEGs) are identified between the different clusters. This approach for finding DEGs by comparing between clusters is widely used in existing methods<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR11">11</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup>, and enables finding cluster-specific marker genes that facilitate labeling different cell populations. However, recent comparisons found that DEG prediction approaches for bulk RNA-seq do not generally perform worse than methods designed specifically for single-cell RNA-seq (scRNA-seq), and that agreement between existing methods is low<sup><xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR14">14</xref></sup>. Defining more flexible statistical frameworks for predicting complex patterns of differential expression is one of the grand challenges in single-cell data analysis<sup><xref ref-type="bibr" rid="CR15">15</xref></sup>.</p>
    <p id="Par5">A major problem with clustering-based approaches for DEG prediction is that the definition of cell clusters is often not straightforward. The number of biologically relevant clusters in a dataset is often not obvious. The high dimensionality of the data makes it hard to evaluate if the number of clusters and their borders make biological sense or if they are arbitrary. Furthermore, some cell sub-populations may not cluster independently and their defining signature may end up being obscured within a larger cluster. This can be critically important for low abundance populations in experiments using unsorted cells from tissue, where only a few representative cells may be present. Thus, the clustering of cells has important consequences in the interpretation of results and downstream analyses.</p>
    <p id="Par6">To address this problem we present singleCellHaystack, a methodology that uses Kullback–Leibler Divergence (<italic>D</italic><sub>KL</sub>; also called relative entropy) to find genes that are expressed in subsets of cells that are non-randomly positioned in a multidimensional (≥2D) space<sup><xref ref-type="bibr" rid="CR16">16</xref></sup>. In our approach, the distribution in the input space of cells expressing or not expressing each gene is compared to a reference distribution of all cells. From this, the <italic>D</italic><sub>KL</sub> of each gene is calculated and compared with randomized data to evaluate its significance. Thus, singleCellHaystack does not rely on clustering of cells, and can identify differentially expressed genes in an unbiased way. singleCellHaystack is implemented as an R package and is available from CRAN and GitHub.</p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>DEG prediction based on the expression distribution of genes</title>
      <p id="Par7">We focus on the Tabula Muris bone marrow dataset to illustrate the principle of DEG prediction using the expression distribution of a gene (i.e., the distribution in the input space of cells that express a gene). Figure <xref rid="Fig1" ref-type="fig">1</xref> shows t-SNE plots based on the 50 first principal components (PCs) of this dataset. Panels on the left show the detection of four genes (<italic>Fcrla</italic>—marker for B cells progenitors, <italic>Fcnb</italic>—marker for granulocytopoietic cells, <italic>Lyz1</italic>—marker for monocytes and granulocytes, <italic>Ccl5</italic>—marker for natural killer cells) in each cell. Each gene is expressed in a subset of cells occupying a subspace of the 50-dimensional input space. Genes with a non-uniform expression distribution are DEGs.<fig id="Fig1"><label>Fig. 1</label><caption><title>Illustration of the expression distribution approach for DEG prediction.</title><p><bold>a</bold>–<bold>d</bold> For four example genes in the Tabula Muris bone marrow tissue dataset, t-SNE plots are shown, with the detection of the gene (left) and the expression distribution of the gene (right). In the expression distribution plots, colored circles represent the 100 grid points decided by singleCellHaystack, their color reflecting <italic>P</italic>(<italic>G</italic> = <italic>T</italic>)/<italic>Q</italic>. t-SNE coordinates of grid points are approximate: grid points were projected to the t-SNE coordinates of their most proximal cell in the 50 PC space.</p></caption><graphic xlink:href="41467_2020_17900_Fig1_HTML" id="d30e377"/></fig></p>
      <p id="Par8">While estimating the distribution of cells in high-dimensional spaces is not straightforward, singleCellHaystack uses the local density of cells around several grid points as an approximation. Panels on the right in Fig. <xref rid="Fig1" ref-type="fig">1</xref> show the grid points used by singleCellHaystack (100 by default; here coordinates of grid points in the 50 PC space were mapped to their approximate location in the t-SNE space), colored by the relative density of cells expressing each gene (<italic>P</italic>(<italic>G</italic> = <italic>T</italic>)/<italic>Q</italic>; see “Methods”). singleCellHaystack converts these distributions to <italic>D</italic><sub>KL</sub> values and <italic>p</italic>-values reflecting the differential expression of each gene. As can be seen in Fig. <xref rid="Fig1" ref-type="fig">1</xref>, the four marker genes are DEGs (they are expressed only in subsets of cells) and they have a non-uniform expression distribution.</p>
      <p id="Par9">Our method contains two main functions: haystack_highD and haystack_2D, for multidimensional (≥2D) and two-dimensional (2D) input spaces, respectively. Input spaces could consist of principal components (PCs), t-SNE or UMAP coordinates, or the coordinates of cells in 2D or three-dimensional space for spatial transcriptomics data. The concept behind these two functions is the same (for an overview of the singleCellHaytack methodology we refer to the “Methods” section and Supplementary Fig. <xref rid="MOESM2" ref-type="media">1</xref>). Unless stated otherwise, results presented here were obtained using the haystack_highD function.</p>
    </sec>
    <sec id="Sec4">
      <title>Comparison with other methods using artificial datasets</title>
      <p id="Par10">To evaluate the accuracy of our approach, we applied singleCellHaystack on 200 artificial datasets of varying size and complexity made using Splatter in which true DEGs are known (see “Methods”)<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>. We also applied existing methods (DEsingle, EMDomics, scDD, edgeR, monocle 2 and approaches available through the FindAllMarkers function of the Seurat toolkit; see Supplementary Table <xref rid="MOESM2" ref-type="media">1</xref>) on the same datasets and compared their accuracy and runtimes<sup><xref ref-type="bibr" rid="CR7">7</xref>,<xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR18">18</xref>–<xref ref-type="bibr" rid="CR21">21</xref></sup>. The accuracy of each method was estimated using the area under the receiver operating characteristic (ROC) curve (AUC). To make a fair comparison, we applied Seurat’s FindAllMarkers function both with and without its default filter, which is typically only passed by a small subset of genes.</p>
      <p id="Par11">Figure <xref rid="Fig2" ref-type="fig">2</xref> shows the results for a selection of methods (see Supplementary Fig. <xref rid="MOESM2" ref-type="media">2</xref> and Supplementary Tables <xref rid="MOESM2" ref-type="media">2</xref> and <xref rid="MOESM2" ref-type="media">3</xref> for all evaluated methods). Except for the smallest dataset size (1000 cells), singleCellHaystack shows comparatively high performance (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>). In general, the accuracy of methods decreases with the complexity of the dataset, but the reduction was stronger for most of the cluster-based approaches (especially EMDomics, scDD, monocle 2, and the Wilcoxon rank-sum test without filter). One cause of the decreasing accuracy is the inaccurate clustering of cells in the larger datasets. Of note, scDD consistently failed to run successfully and returned errors on 2 and 9 of the datasets of 9000 cells and 10,000 cells, respectively.<fig id="Fig2"><label>Fig. 2</label><caption><title>Comparison of DEG prediction methods applied on artificial datasets.</title><p>For a selection of DEG prediction methods the median AUC values (<bold>a</bold>) and median runtimes (<bold>b</bold>) are shown in function of dataset size. Medians are based on 20 datasets, except for scDD on datasets of size 9,000 (18 datasets) and 10,000 (11 datasets). In <bold>a</bold> the red dotted line shows the expected AUC for a random classifier. In <bold>b</bold> the gray dotted lines indicate 1 min, 1 h, 1, 2 and 4 days, and 1 week to improve the readability of the plot. Supplementary Fig. <xref rid="MOESM1" ref-type="media">2</xref> shows similar plots for all evaluated methods.</p></caption><graphic xlink:href="41467_2020_17900_Fig2_HTML" id="d30e498"/></fig></p>
      <p id="Par12">Among the cluster-based methods, DEsingle and scDD have relatively high accuracy, but also have by far the longest runtimes (Fig. <xref rid="Fig2" ref-type="fig">2b</xref> and Supplementary Table <xref rid="MOESM2" ref-type="media">3</xref>). For example, median runtimes on 8000 cells for DEsingle and scDD were 123 and 81 h (!) respectively. In contrast, singleCellHaystack and the Wilcoxon rank-sum test implemented in Seurat (with default filter) are the fastest methods, taking about 5 min even on datasets of 10,000 cells. Removing the default filter of Seurat’s Wilcoxon rank-sum test leads to higher accuracy (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>) but longer runtimes (Fig. <xref rid="Fig2" ref-type="fig">2b</xref>).</p>
      <p id="Par13">These results show that singleCellHaystack has relatively high accuracy on artificial datasets and short runtimes, making it an attractive method for exploring single-cell datasets. Moreover, we stress that the artificial datasets made by Splatter are expected to give an advantage to cluster-based methods, since the underlying model of Splatter is based on generating clusters of cells. In addition, Splatter is based on a negative binomial model, giving an advantage to DEG prediction approaches that are based on a similar model. Indeed, DEsingle is based on a negative binomial model and performed comparatively well in our comparison. Nevertheless, singleCellHaystack had the highest performance, despite not being based on clusters nor on a negative binomial model.</p>
    </sec>
    <sec id="Sec5">
      <title>Application to 136 real single-cell datasets</title>
      <p id="Par14">Next, we applied singleCellHaystack on 136 real scRNA-seq datasets of varying sizes (149 to 19,693 cells). Median runtimes of haystack_highD using 50 PCs as input were 102 and 115 s using the simple and advanced mode (see “Methods” section), respectively. Runtimes followed an approximately linear function of the number of cells in each dataset (Supplementary Fig. <xref rid="MOESM2" ref-type="media">3A, B</xref>). Median runtimes for haystack_2D on 2D t-SNE coordinates were 75 and 84 s using the simple and advanced mode, respectively (Supplementary Fig. <xref rid="MOESM2" ref-type="media">3C, D</xref>).</p>
      <p id="Par15">In all datasets, large numbers of statistically significant DEGs were found. This observation is not surprising, since samples typically include a variety of different cell types. Rather than interpreting singleCellHaystack <italic>p</italic>-values in the conventional definition, the ranking of genes is more relevant.</p>
      <p id="Par16">As an illustration of the usage of singleCellHaystack, we here present results of three example datasets based on different sequencing technologies. In all three cases, the coordinates of cells in the first 50 PCs were used as input, along with the detection levels of all genes in all cells.</p>
      <p id="Par17">Figure <xref rid="Fig3" ref-type="fig">3</xref> summarizes the result of the Tabula Muris bone marrow tissue dataset (FACS-sorted cells). Five-thousand two-hundred fifty cells and 13,756 genes were used as input, and singleCellHaystack took 225 s in the default mode. The t-SNE plot shows a typical mixture of clearly separated as well as loosely connected groups of cells, with considerable variety in the total number of detected genes (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>). The most significant DEG was <italic>Ramp1</italic>, which is detected only in a subset of cells (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>). To illustrate the variety in expression patterns, we grouped DEGs into five clusters based on hierarchical clustering of their expression in the 50 PC input space (Supplementary Fig. <xref rid="MOESM2" ref-type="media">4</xref>). Figure <xref rid="Fig3" ref-type="fig">3c–f</xref> show the most significant DEGs of the other 4 groups. Results for two other example datasets are shown in Supplementary Figs. <xref rid="MOESM2" ref-type="media">5</xref> (trachea) and <xref rid="MOESM2" ref-type="media">6</xref> (testis).<fig id="Fig3"><label>Fig. 3</label><caption><title>Application of singleCellHaystack on bone marrow tissue dataset.</title><p><bold>a</bold> t-SNE plot of the 5250 cells. The color scale shows the number of genes detected in each cell. <bold>b</bold>–<bold>f</bold> Expression patterns of five high-scoring DEGs, representative of the five groups in which the genes were clustered.</p></caption><graphic xlink:href="41467_2020_17900_Fig3_HTML" id="d30e584"/></fig></p>
      <p id="Par18">To evaluate the dependency of singleCellHaystack on input coordinates and hyperparameter settings (see also discussion in <xref rid="MOESM1" ref-type="media">Supplementary Notes</xref>), we applied our method using (1) different input spaces (Supplementary Fig. <xref rid="MOESM2" ref-type="media">7A</xref>), (2) different bandwidths (Supplementary Fig. <xref rid="MOESM2" ref-type="media">7B</xref>), (3) different numbers of grid points (Supplementary Fig. <xref rid="MOESM2" ref-type="media">7C</xref>), and different coordinates of grid points (Supplementary Fig. <xref rid="MOESM2" ref-type="media">7D</xref>). We focused here on the three datasets shown in Fig. <xref rid="Fig3" ref-type="fig">3</xref> (bone marrow tissue), Supplementary Fig. <xref rid="MOESM2" ref-type="media">5</xref> (trachea) and Supplementary Fig. <xref rid="MOESM2" ref-type="media">6</xref> (testis). As a reference, we also checked the dependency of a clustering-based method on the number of clusters predicted in a dataset (Supplementary Fig. <xref rid="MOESM2" ref-type="media">7E</xref>). Compared with the dependency of cluster-based approaches on the number of predicted clusters, singleCellHaystack is relatively stable w.r.t. bandwidth and the number and coordinates of grid points. In general, similar input spaces (e.g., t-SNE vs. UMAP, or 5 PCs vs. 10 PCs) resulted in similar top-scoring DEGs. However, different input spaces (e.g., 5 PCs vs. 50 PCs) did lead to larger discrepancies in some datasets. For example, the first 50 PCs of the Testis 1 dataset returned different top-scoring DEGs compared to other input spaces (Supplementary Fig. <xref rid="MOESM2" ref-type="media">7A</xref>; bottom). For more complex datasets a lower-dimensional input space might not be able to sufficiently capture the variance of the dataset, and a higher dimensional input space might be preferable.</p>
    </sec>
    <sec id="Sec6">
      <title>Comparison with Seurat’s FindAllMarkers function</title>
      <p id="Par19">Here, we compare our method with the default test used in Seurat’s FindAllMarkers function (i.e., the Wilcoxon rank-sum test), arguably the most widely used approach. As a representative case, we show the comparison between singleCellHaystack and FindAllMarkers on the Tabula Muris bone marrow dataset (Fig. <xref rid="Fig4" ref-type="fig">4</xref>). In general, the agreement between both methods was low (Fig. <xref rid="Fig4" ref-type="fig">4a, b</xref> and Supplementary Fig. <xref rid="MOESM2" ref-type="media">8</xref>). The top 100 high-scoring genes of both approaches have only 3 genes in common (Supplementary Fig. <xref rid="MOESM2" ref-type="media">8</xref>). To gain understanding into the difference between a clustering-based approach (FindAllMarkers) and the clustering-independent singleCellHaystack, we focus on seven example genes. For the gene <italic>Ctla2a</italic> (Fig. <xref rid="Fig4" ref-type="fig">4c</xref>) both methods are in agreement; <italic>Ctla2a</italic> has very high expression in a subset of cells and is not detected in most other subsets.<fig id="Fig4"><label>Fig. 4</label><caption><title>Comparison between singleCellHaystack and Seurat.</title><p>A comparison between singleCellHaystack and Seurat’s FindAllMarkers function applied on the Tabula Muris bone marrow tissue dataset. <bold>a</bold> Scatterplot of the <italic>p</italic>-values estimated by FindAllMarkers (<italic>x</italic>-axis) and singleCellHaystack (<italic>y</italic>-axis) for all 13,756 genes in the dataset. One-hundred seventy-six genes were given a <italic>p</italic>-value of 0 by FindAllMarkers, and are shown as <italic>p</italic>-value 1e-320. Genes highlighted in <bold>c</bold>–<bold>i</bold> are indicated. <bold>b</bold> Summary of selected genes indicated in <bold>a</bold> are shown. <bold>c</bold>–<bold>i</bold> Expression patterns of indicated genes.</p></caption><graphic xlink:href="41467_2020_17900_Fig4_HTML" id="d30e714"/></fig></p>
      <p id="Par20">Some genes are judged to have significant differential expression by FindAllMarkers but less so by singleCellHaystack. One such gene is <italic>Il2rb</italic> (Fig. <xref rid="Fig4" ref-type="fig">4d</xref>). The expression of this gene closely fits one of the clusters that were used by FindAllMarkers to predict DEGs (Supplementary Fig. <xref rid="MOESM2" ref-type="media">9</xref>). This trend continues with <italic>Grm8</italic> and <italic>Tnni1</italic>, which have high expression in a handful of cells within a single cluster (Fig. <xref rid="Fig4" ref-type="fig">4e, f</xref> and Supplementary Fig. <xref rid="MOESM2" ref-type="media">9</xref>).</p>
      <p id="Par21">On the other hand, other genes are picked up by singleCellHaystack, but are not among the top-ranking genes according to FindAllMarkers (Fig. <xref rid="Fig4" ref-type="fig">4g–i</xref>). The most significant DEG according to singleCellHaystack is <italic>Ramp1</italic> (Fig. <xref rid="Fig4" ref-type="fig">4g</xref>, also shown in Fig. <xref rid="Fig3" ref-type="fig">3b</xref>). This gene is expressed across roughly half of the clusters as decided by FindClusters (Supplementary Fig. <xref rid="MOESM2" ref-type="media">9</xref>), lowering its significance: <italic>Ramp1</italic> is ranked 570<sup>th</sup> while <italic>Tnni1</italic> is ranked 358th according to FindAllMarkers. A similar trend continues with <italic>Fbl</italic> and <italic>Nrgn</italic>, which have clear differential expression patterns but are not among the top-scoring genes of FindAllMarkers.</p>
      <p id="Par22">These representative examples show that clustering-based approaches are likely to overestimate the significance of DEGs whose expression pattern fits very closely with a single cluster (ex: <italic>Tnni</italic>). These approaches are likely to miss DEGs whose expression is spread out over several clusters. On the other hand, singleCellHaystack can detect any pattern of differential expression, independently of the clustering of cells. However, DEGs that are expressed in only a small number of cells (ex: <italic>Grm8</italic>) might be missed.</p>
    </sec>
    <sec id="Sec7">
      <title>Top-scoring DEGs are often known cell type marker genes</title>
      <p id="Par23">Focusing on results of haystack_highD applied on the first 50 PCs of each real dataset, we investigated whether top-scoring DEGs are often known cell type marker genes. For each dataset, we ranked genes by their <italic>p</italic>-value, and counted how often the genes at each rank were high-confidence markers, low-confidence markers, or non-marker genes (see “Methods”). High-confidence marker genes (such as <italic>Cd45</italic> and <italic>Kit</italic>) were strongly enriched among top-scoring DEGs: although they comprise only 2.2% of all genes, on average 32.4% of the top 50 ranked genes were high-confidence cell type markers (Fig. <xref rid="Fig5" ref-type="fig">5</xref>).<fig id="Fig5"><label>Fig. 5</label><caption><title>Frequencies of cell type marker genes among DEGs.</title><p>The frequencies of high-confidence (blue), low-confidence (orange), and non-marker genes (gray) among predicted DEGs in the 136 single-cell datasets are shown. The <italic>x</italic>-axis shows genes ranked by increasing <italic>p</italic>-value in bins of 50 (ranks 1 to 50, ranks 51 to 100, …, up to rank 2000).</p></caption><graphic xlink:href="41467_2020_17900_Fig5_HTML" id="d30e836"/></fig></p>
    </sec>
    <sec id="Sec8">
      <title>The advanced mode considers general gene detection levels</title>
      <p id="Par24">In scRNA-seq data there can be considerable variation in the number of detected genes between cells. In some datasets this results in clusters of cells with higher or lower general detection levels. The advanced mode of singleCellHaystack can be used to find genes that have expression distributions that are contrary to the general pattern of detected genes (see Methods section). Figure <xref rid="Fig6" ref-type="fig">6</xref> shows three examples, comparing the advanced mode with the default mode. The top-scoring DEGs in the advanced mode are often expressed in cells that have in general fewer detected genes.<fig id="Fig6"><label>Fig. 6</label><caption><title>Example results of default versus advanced mode of singleCellHaystack.</title><p>A t-SNE plot (left), the expression of top-scoring DEGs in the default mode (center) and advanced mode (right) are shown for <bold>a</bold> the Tabula Muris pancreas (FACS-sorted data), <bold>b</bold> the Tabula Muris lung (P8 12; Microfluidic droplet), and <bold>c</bold> the Mouse Cell Atlas small intestine 2 dataset. The color scale for gene expression (center and right panels) is as in Fig. <xref rid="Fig3" ref-type="fig">3</xref>.</p></caption><graphic xlink:href="41467_2020_17900_Fig6_HTML" id="d30e867"/></fig></p>
    </sec>
    <sec id="Sec9">
      <title>Application on spatial transcriptomics data</title>
      <p id="Par25">To show that singleCellHaystack can identify DEGs in spatial transcriptomics data we used publicly available data from the 10x Visium platform. We used the mouse brain anterior1 slice dataset, which contains gene expression information for 2696 spots (each corresponding to several cells) together with their 2D spatial coordinates within the tissue. We ran haystack_2D using the gene expression and spatial coordinates data. Figure <xref rid="Fig7" ref-type="fig">7</xref> shows the expression of the 6 top-scoring genes returned by haystack_2D. The expression distribution of these genes is correlated with brain structures: <italic>Gpr88</italic>, <italic>Pde10a</italic>, and <italic>Rgs9</italic> are expressed in the caudate putamen; <italic>Slc17a7</italic> and <italic>Nptxr</italic> are mainly restricted to the cerebral cortex; <italic>Pcp4l1</italic> is expressed in the olfactory bulb and to a lesser extent in the caudate putamen. This shows that singleCellHaystack can be used on spatial transcriptomics data to identify spatially regulated genes.<fig id="Fig7"><label>Fig. 7</label><caption><title>Application of singleCellHaystack on spatial transcriptomics data.</title><p><bold>a</bold>–<bold>f</bold> Expression levels (normalized counts) per bead in the anterior1 slice of the mouse brain are shown for the top 6 high-scoring genes returned by haystack_2D. Each figure shows circles representing the 2696 beads superimposed on a slice of the anterior mouse brain. The locations of the circles correspond to the 2D coordinates of the beads and their colors reflect the expression of each gene.</p></caption><graphic xlink:href="41467_2020_17900_Fig7_HTML" id="d30e919"/></fig></p>
    </sec>
  </sec>
  <sec id="Sec10" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par26">singleCellHaystack is a generally applicable method for finding genes with non-uniform expression distributions in multidimensional spaces. Here, we have focused on single-cell transcriptome data analysis, but our approach is also applicable on large numbers of bulk assay samples. We also demonstrated an application on spatial transcriptomics data using the spatial coordinates of cells as input space. singleCellHaystack does not rely on clustering, thus, avoiding biases caused by the arbitrary clustering of cells. It can detect any non-random pattern of expression and can be a useful tool for finding new marker genes. The singleCellHaystack R package includes additional functions for clustering and visualization of genes.</p>
    <p id="Par27">As noted in the Results section, singleCellHaystack found large numbers of statistically significant DEGs in all datasets. The same was true for many of the clustering-based DEG prediction methods. DEG prediction methods often return inflated <italic>p</italic>-values because of the double use of gene expression data (for defining clusters and for DEG prediction)<sup><xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR14">14</xref></sup>. singleCellHaystack suffers from the same issue, because the input coordinates (PCs, t-SNE, or UMAP coordinates) are dimensions containing a large proportion of the variability in the original data. In future updates we hope to address this issue.</p>
    <p id="Par28">The current implementation of our method requires binary detection data as input (i.e., a gene is either detected or not in each cell). The definition of detection is left to the user and could be modified according to the characteristics of each dataset. When counts &gt;0 is used to define detection, it should be taken into consideration that many zero counts in single-cell data reflect dropout events due to lack of sensitivity in single-cell techniques. This issue could be partly addressed by applying imputation approaches. However, we are aware that the use of a hard threshold for detection is a weak point of our method. For example, two genes might be detected in the same subset of cells, but one might have ten-fold higher read counts than the other. Since the current implementation of our method is using a hard threshold for detection, it would give both genes the same <italic>D</italic><sub>KL</sub> and <italic>p</italic>-value. In future updates, we will explore ways for using continuous measures of gene expression (such as normalized read counts) as a basis for estimating expression distributions, instead of using binary detection data.</p>
  </sec>
  <sec id="Sec11">
    <title>Methods</title>
    <sec id="Sec12">
      <title>singleCellHaystack methodology</title>
      <p id="Par29">singleCellHaystack uses the distribution of cells in an input space to predict DEGs. First, it infers a reference distribution of cells in the space (distribution <italic>Q</italic>). It does so by estimating the local density of cells around a set of fixed grid points in the space using a Gaussian kernel. For 2D spaces (such as t-SNE or UMAP plots, and 2D spatial transcriptomics data), haystack_2D divides the 2D space into a grid along both axes, and the intersection points serve as grid points. For multidimensional spaces (such as the first several PCs), haystack_highD defines a set of grid points covering the subspace in which the cells are located (see Supplementary Methods).</p>
      <p id="Par30">Next, singleCellHaystack estimates the distribution of cells in which a gene <italic>G</italic> is detected (distribution <italic>P</italic>(<italic>G</italic> = <italic>T</italic>)) and not detected (distribution <italic>P</italic>(<italic>G</italic> = <italic>F</italic>)). It does this using the same grid points and Gaussian kernel as used for estimating <italic>Q</italic>. Each distribution is normalized to sum to 1. The definition of detection could depend on the characteristics of the dataset. For the results presented in this paper we used the median read count of each gene as the threshold for defining detection, except for the analysis of the spatial transcriptomics. Alternatively, genes with read counts &gt;0 or exceeding an otherwise defined threshold could be regarded as detected. As an example, we used a fixed threshold of 1 read for the spatial transcriptomics data analysis.</p>
      <p id="Par31">The divergence of gene <italic>G</italic>, <italic>D</italic><sub>KL</sub>(<italic>G</italic>), is calculated as follows:<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$D_{{\mathrm{KL}}}(G) = \mathop {\sum}\limits_{s \in \{ T,F\} } \,{\mathop {\sum}\limits_{x \in {\mathrm{grid}}\,{\mathrm{points}}} {P\left( {G = s,x} \right){\mathrm{log}}\left( {\frac{{P(G = s,x)}}{{Q(x)}}} \right)} }$$\end{document}</tex-math><mml:math id="M2"><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">KL</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>G</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mi>T</mml:mi><mml:mo>,</mml:mo><mml:mi>F</mml:mi></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow></mml:munder><mml:mspace width="0.25em"/><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>x</mml:mi><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">grid</mml:mi><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">points</mml:mi></mml:mrow></mml:munder><mml:mi>P</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>G</mml:mi><mml:mo>=</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:mfenced><mml:mi mathvariant="normal">log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mfrac><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>G</mml:mi><mml:mo>=</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>Q</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="41467_2020_17900_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula>where <italic>P</italic>(<italic>G</italic> = <italic>s</italic>,<italic>x</italic>) and <italic>Q</italic>(<italic>x</italic>) are the values of <italic>P</italic>(<italic>G</italic> = <italic>s</italic>) and <italic>Q</italic> at grid point <italic>x</italic>, respectively.</p>
      <p id="Par33">Finally, the significance of <italic>D</italic><sub>KL</sub>(<italic>G</italic>) is evaluated using randomizations, in which the expression levels of <italic>G</italic> are randomly shuffled over all cells. The mean and standard deviation of <italic>D</italic><sub>KL</sub>(<italic>G</italic>) in randomized datasets follow a clear pattern in function of the number of cells in which a gene was detected (see Supplementary Fig. <xref rid="MOESM2" ref-type="media">10</xref> for examples), which is modeled using B-splines<sup><xref ref-type="bibr" rid="CR22">22</xref></sup>. <italic>p</italic>-values are calculated by comparing the observed <italic>D</italic><sub>KL</sub>(<italic>G</italic>) to the predicted mean and standard deviation (log values).</p>
    </sec>
    <sec id="Sec13">
      <title>singleCellHaystack advanced options</title>
      <p id="Par34">The distribution <italic>Q</italic> and the randomizations described above ignore the fact that some cells have in total more detected genes than others. singleCellHaystack can be run in an advanced mode, in which both the calculation of <italic>Q</italic> and the randomizations are done by weighting cells by their number of detected genes (see Supplementary Methods for more details).</p>
      <p id="Par35">In addition, singleCellHaystack includes functions for visualization and for clustering genes by their expression distribution in the multidimensional space.</p>
    </sec>
    <sec id="Sec14">
      <title>Application of DEG prediction methods on artificial datasets</title>
      <p id="Par36">We used Splatter to generate artificial datasets in a range of sizes and complexities, as follows<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>. First, we made datasets containing 1000 cells in 2 clusters; 2000 cells in 3 clusters; 3000 cells in 4 clusters; 4000 cells in 5 clusters; 5000 cells in 6 clusters; 6000 cells in 8 clusters; 7000 cells in 10 clusters; 8000 cells in 15 clusters; 9000 cells in 20 clusters; or 10,000 cells in 25 clusters. For each of these ten settings we generated ten datasets. Secondly, for the same settings of clusters and cell counts we also generated ten datasets each containing randomly determined paths between the clusters (parameter path.from in Splatter’s splatSimulate function). This gave us a total of 200 datasets (100 with clusters and 100 with paths).</p>
      <p id="Par37">The output of Splatter contains differential expression factors (DEFac[Group]), showing whether a gene has differential expression (factor different from 1) or not (factor = 1) in each group (=cluster). We defined a differential expression score for each gene as the sum of the absolute values of these log<sub>2</sub>-transformed factors. We regarded the 100 genes with the highest score as true DEGs.</p>
      <p id="Par38">On these artificial datasets we applied DEsingle, EMDomics, scDD, edgeR, monocle 2, MAST, and the FindAllMarkers function of Seurat (see Supplementary Table <xref rid="MOESM2" ref-type="media">1</xref>)<sup><xref ref-type="bibr" rid="CR7">7</xref>,<xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR18">18</xref>–<xref ref-type="bibr" rid="CR21">21</xref></sup>. For a brief description of these methods we refer to Wang et al.<sup><xref ref-type="bibr" rid="CR14">14</xref></sup>. We also tried to apply SCDE and DESeq2 but these had excessively long runtimes even on the smallest datasets, and were, therefore, excluded from this comparison<sup><xref ref-type="bibr" rid="CR11">11</xref>,<xref ref-type="bibr" rid="CR23">23</xref></sup>. The cell clusters given as input to the DEG prediction methods were detected by running the FindNeighbors function of Seurat using the first 15 PCs of each dataset as input followed by the FindClusters function using the default resolution and the Smart Local Moving (SLM) algorithm. The same cell clusters were used for all methods. For methods that are implemented in Seurat we used the FindAllMarkers function to predict DEGs by comparing each cluster versus all other clusters. For other methods, we implemented this comprehensive comparison (each cluster versus all others). Furthermore, for methods that are implemented in Seurat, we ran FindAllMarkers with default options, except for options only.pos = FALSE and return.thresh = 1, and with and without the default filtering (default options logfc.threshold = 0.25 and min.pct = 0.1).</p>
      <p id="Par39">All evaluated methods assign <italic>p</italic>-values and/or scores to genes reflecting their degree of differential expression. We turned these <italic>p</italic>-values and scores into a ranking of genes, from more significant DEGs to less significant DEGs. The ranking was based on <italic>p</italic>-values where possible, using scores to break ties. The ROC method in Seurat does not return <italic>p</italic>-values, so we based its ranking of genes on the predictive power score returned by this method.</p>
      <p id="Par40">Finally, for each DEG prediction method, we calculated the AUC under the ROC curve for every artificial dataset using the ROCR package (version 1.0-7) in R<sup><xref ref-type="bibr" rid="CR24">24</xref></sup>.</p>
    </sec>
    <sec id="Sec15">
      <title>scRNA-seq datasets and processing</title>
      <p id="Par41">For a detailed description we refer to Supplementary Methods. In brief, we downloaded processed data (read counts or unique molecular identifiers) of the Tabula Muris project (FACS-sorted cells: 20 sets; Microfluidic droplets: 28 sets), the Mouse Cell Atlas (Microwell-seq: 87 sets) and a dataset of several hematopoietic progenitor cell types<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR25">25</xref>,<xref ref-type="bibr" rid="CR26">26</xref></sup>. PCA was conducted using the 1000 most variable genes. Subsequently, the first 50 PCs were used as input for t-SNE and UMAP analysis, following the recommendations by Kobak and Berens<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. Finally, singleCellHaystack was run on both 2D (2D t-SNE and UMAP coordinates) and multidimensional (50 PCs) representations of each dataset to predict DEGs. For analyzing runtimes and dependency on input parameters we ran additional runs using 5, 10, 15, and 25 PCs.</p>
    </sec>
    <sec id="Sec16">
      <title>Known cell type marker genes</title>
      <p id="Par42">We downloaded marker gene data from the CellMarker database<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>. A total of 7852 unique mouse genes are reported as markers in CellMarker, which we split into 630 high-confidence markers (reported in ≥5 publications), and 7222 low-confidence markers (reported in one to four publications). Other genes we regarded as non-marker genes.</p>
    </sec>
    <sec id="Sec17">
      <title>Analysis of dependency on parameters</title>
      <p id="Par43">We ran singleCellHaystack using different parameter settings as follows:<list list-type="order"><list-item><p id="Par44">with default parameter settings on different input spaces: t-SNE, UMAP, and the first 5, 10, or 50 PCs.</p></list-item><list-item><p id="Par45">with the default number of grid points on the 50 PC input space using different bandwidths: bandwidth <italic>h</italic> (default), 2 × <italic>h</italic>, 1.5 × <italic>h</italic>, <italic>h</italic>/1.5, and <italic>h</italic>/2.</p></list-item><list-item><p id="Par46">with the default bandwidth on the 50 PC input space using different number of grid points: 25, 50, 100 (default), 150, and 200.</p></list-item><list-item><p id="Par47">with the default bandwidth on the 50 PC input space with 100 grid points but using 5 different seed values for R’s random number generator. This results in different coordinates for the grid points.</p></list-item></list></p>
      <p id="Par48">The Spearman correlation of <italic>p</italic>-values was used to evaluate the consistency of results of different runs. We also ran Seurat’s FindAllMarkers function with the default DEG prediction method (Wilcoxon rank-sum test), changing the number of clusters detected in each dataset. First, we ran Seurat’s FindClusters function with the default resolution parameter setting to obtain the default clusters. Then, we changed the resolution parameter to obtain more (default+1 and +2) and fewer (default-1 and -2) clusters. Finally, we applied the FindAllMarkers function on these five different clustering results.</p>
    </sec>
    <sec id="Sec18">
      <title>Analysis of spatial transcriptomics data</title>
      <p id="Par49">We used mouse brain data from the 10x Genomics Visium spatial transcriptomics platform (<ext-link ext-link-type="uri" xlink:href="https://support.10xgenomics.com/spatial-gene-expression/datasets">https://support.10xgenomics.com/spatial-gene-expression/datasets</ext-link>). We obtained the anterior1 slice with the SeuratData R package for this analysis<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>. The anterior1 slice consists of 31,053 genes and 2696 beads distributed in a 2D lattice. We used Seurat to normalize, obtain the 2D coordinates, and plot the spatial images. Genes with &lt;10 beads with raw counts &gt;1 were removed, resulting in 12,382 genes passing filtering. Raw counts were normalized with the NormalizeData function. Normalized counts and spatial coordinates were passed to the function haystack_2D to predict spatially differentially expressed genes, using a detection cutoff of 1.</p>
    </sec>
    <sec id="Sec19">
      <title>Reporting summary</title>
      <p id="Par50">Further information on research design is available in the <xref rid="MOESM3" ref-type="media">Nature Research Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec20">
      <supplementary-material content-type="local-data" id="MOESM1">
        <media xlink:href="41467_2020_17900_MOESM1_ESM.pdf">
          <caption>
            <p>Peer Review File</p>
          </caption>
        </media>
      </supplementary-material>
      <supplementary-material content-type="local-data" id="MOESM2">
        <media xlink:href="41467_2020_17900_MOESM2_ESM.pdf">
          <caption>
            <p>Supplementary Information</p>
          </caption>
        </media>
      </supplementary-material>
      <supplementary-material content-type="local-data" id="MOESM3">
        <media xlink:href="41467_2020_17900_MOESM3_ESM.pdf">
          <caption>
            <p>Reporting Summary</p>
          </caption>
        </media>
      </supplementary-material>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p><bold>Peer review information</bold><italic>Nature Communications</italic> thanks Sheida Nabavi and the other, anonymous, reviewer(s) for their contribution to the peer review of this work. Peer reviewer reports are available.</p>
    </fn>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <sec>
    <title>Supplementary information</title>
    <p><bold>Supplementary information</bold> is available for this paper at 10.1038/s41467-020-17900-3.</p>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank Prof. Yoshio Koyanagi and the members of the Lab. of Systems Virology (Kyoto University), the Lab. of Functional Analysis in silico (Tokyo University), Dr. Yutaro Kumagai (National Institute of Advanced Industrial Science and Technology) and Prof. Wataru Fujibuchi (Kyoto University) for helpful discussions and advice, Tianyu Wang (University of Connecticut) for assistance with DEG prediction scripts in R, and Prof. Daron Standley (Osaka University) and John Rozewicki (Osaka University) for access to the Sysimm computer cluster. This work was supported by an Office of Directors’ Research Grant provided by the Institute for Frontier Life and Medical Sciences (Kyoto University), and by the Future Development Funding Program of the Kyoto University Research Coordination Alliance.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>A.V. conceived of the project and methodology. A.V. and D.D. implemented the methods, ran the analyses and wrote the manuscript.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>The artificial single-cell datasets generated using Splatter for the comparison of singleCellHaystack with other DEG prediction methods are available in figshare with the identifiers 10.6084/m9.figshare.12319787 and 10.6084/m9.figshare.12319247. Other single-cell RNA-seq datasets analyzed in this study are available from <ext-link ext-link-type="uri" xlink:href="https://tabula-muris.ds.czbiohub.org/">https://tabula-muris.ds.czbiohub.org/</ext-link> (Tabula Muris), <ext-link ext-link-type="uri" xlink:href="https://figshare.com/articles/MCA_DGE_Data/5435866">https://figshare.com/articles/MCA_DGE_Data/5435866</ext-link> (Mouse Cell Atlas), GEO accession number GSE81682, and <ext-link ext-link-type="uri" xlink:href="https://support.10xgenomics.com/spatial-gene-expression/datasets">https://support.10xgenomics.com/spatial-gene-expression/datasets</ext-link> (10x Genomics spatial gene expression). The cell type marker data was obtained from the CellMarker database and is available from <ext-link ext-link-type="uri" xlink:href="http://biocc.hrbmu.edu.cn/CellMarker/">http://biocc.hrbmu.edu.cn/CellMarker/</ext-link>.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>singleCellHaystack is implemented as an R package, available from CRAN (<ext-link ext-link-type="uri" xlink:href="https://CRAN.R-project.org/package=singleCellHaystack">https://CRAN.R-project.org/package=singleCellHaystack</ext-link>) and GitHub (<ext-link ext-link-type="uri" xlink:href="https://github.com/alexisvdb/singleCellHaystack">https://github.com/alexisvdb/singleCellHaystack</ext-link>). The repository includes additional instructions for installation in R and example applications.</p>
  </notes>
  <notes id="FPar1" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par51">The authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tang</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>mRNA-Seq whole-transcriptome analysis of a single cell</article-title>
        <source>Nat. Methods</source>
        <year>2009</year>
        <volume>6</volume>
        <fpage>377</fpage>
        <lpage>382</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.1315</pub-id>
        <pub-id pub-id-type="pmid">19349980</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hashimshony</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Wagner</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Sher</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Yanai</surname>
            <given-names>I</given-names>
          </name>
        </person-group>
        <article-title>CEL-seq: single-cell RNA-Seq by multiplexed linear amplification</article-title>
        <source>Cell Rep.</source>
        <year>2012</year>
        <volume>2</volume>
        <fpage>666</fpage>
        <lpage>673</lpage>
        <pub-id pub-id-type="doi">10.1016/j.celrep.2012.08.003</pub-id>
        <pub-id pub-id-type="pmid">22939981</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Picelli</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Smart-seq2 for sensitive full-length transcriptome profiling in single cells</article-title>
        <source>Nat. Methods</source>
        <year>2013</year>
        <volume>10</volume>
        <fpage>1096</fpage>
        <lpage>1100</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.2639</pub-id>
        <pub-id pub-id-type="pmid">24056875</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Macosko</surname>
            <given-names>EZ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Highly parallel genome-wide expression profiling of individual cells using nanoliter droplets</article-title>
        <source>Cell</source>
        <year>2015</year>
        <volume>161</volume>
        <fpage>1202</fpage>
        <lpage>1214</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2015.05.002</pub-id>
        <pub-id pub-id-type="pmid">26000488</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Han</surname>
            <given-names>X</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Mapping the mouse cell atlas by microwell-seq</article-title>
        <source>Cell</source>
        <year>2018</year>
        <volume>172</volume>
        <fpage>1091</fpage>
        <lpage>1097</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2018.02.001</pub-id>
        <pub-id pub-id-type="pmid">29474909</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <mixed-citation publication-type="other">Zappia, L., Phipson, B. &amp; Oshlack, A. Exploring the single-cell RNA-seq analysis landscape with the scRNA-tools database. <italic>PLoS Comput. Biol</italic>. <bold>14</bold>, 1006245 (2018).</mixed-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Qiu</surname>
            <given-names>X</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell mRNA quantification and differential analysis with Census</article-title>
        <source>Nat. Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>309</fpage>
        <lpage>315</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4150</pub-id>
        <pub-id pub-id-type="pmid">28114287</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Butler</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Hoffman</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Smibert</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Papalexi</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Integrating single-cell transcriptomic data across different conditions, technologies, and species</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2018</year>
        <volume>36</volume>
        <fpage>411</fpage>
        <lpage>420</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.4096</pub-id>
        <pub-id pub-id-type="pmid">29608179</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>van der Maaten</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Hinton</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Visualizing data using t-SNE</article-title>
        <source>J. Mach. Learn. Res.</source>
        <year>2008</year>
        <volume>9</volume>
        <fpage>2579</fpage>
        <lpage>2605</lpage>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <mixed-citation publication-type="other">McInnes, L., Healy, J. &amp; Melville, J. UMAP: Uniform manifold approximation and projection for dimension reduction. <italic>arxiv</italic> 1–51 (2018).</mixed-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kharchenko</surname>
            <given-names>PV</given-names>
          </name>
          <name>
            <surname>Silberstein</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Scadden</surname>
            <given-names>DT</given-names>
          </name>
        </person-group>
        <article-title>Bayesian approach to single-cell differential expression analysis</article-title>
        <source>Nat. Methods</source>
        <year>2014</year>
        <volume>11</volume>
        <fpage>18</fpage>
        <lpage>22</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.2967</pub-id>
        <pub-id pub-id-type="pmid">24524131</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <mixed-citation publication-type="other">Finak, G. et al. MAST: a flexible statistical framework for assessing transcriptional changes and characterizing heterogeneity in single-cell RNA sequencing data. <italic>Genome Biol</italic>. <bold>16</bold>, 278 (2015).</mixed-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Soneson</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Robinson</surname>
            <given-names>MD</given-names>
          </name>
        </person-group>
        <article-title>Bias, robustness and scalability in single-cell differential expression analysis</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>255</fpage>
        <lpage>261</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4612</pub-id>
        <pub-id pub-id-type="pmid">29481549</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <mixed-citation publication-type="other">Wang, T., Li, B., Nelson, C. E. &amp; Nabavi, S. Comparative analysis of differential gene expression analysis tools for single-cell RNA sequencing data. <italic>BMC Bioinformatics</italic><bold>20</bold>, 40 (2019).</mixed-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lähnemann</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Eleven grand challenges in single-cell data science</article-title>
        <source>Genome Biol.</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>1</fpage>
        <lpage>35</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-020-1926-6</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kullback</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Leibler</surname>
            <given-names>RA</given-names>
          </name>
        </person-group>
        <article-title>On information and sufficiency</article-title>
        <source>Ann. Math. Stat.</source>
        <year>1951</year>
        <volume>22</volume>
        <fpage>79</fpage>
        <lpage>86</lpage>
        <pub-id pub-id-type="doi">10.1214/aoms/1177729694</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zappia</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Phipson</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Oshlack</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Splatter: simulation of single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2017</year>
        <volume>18</volume>
        <fpage>1</fpage>
        <lpage>15</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-017-1305-0</pub-id>
        <pub-id pub-id-type="pmid">28077169</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Miao</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Deng</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>DEsingle for detecting three types of differential expression in single-cell RNA-seq data</article-title>
        <source>Bioinformatics</source>
        <year>2018</year>
        <volume>34</volume>
        <fpage>3223</fpage>
        <lpage>3224</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/bty332</pub-id>
        <pub-id pub-id-type="pmid">29688277</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Nabavi</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Schmolze</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Maitituoheti</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Malladi</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Beck</surname>
            <given-names>AH</given-names>
          </name>
        </person-group>
        <article-title>EMDomics: a robust and powerful method for the identification of genes differentially expressed between heterogeneous classes</article-title>
        <source>Bioinformatics</source>
        <year>2016</year>
        <volume>32</volume>
        <fpage>533</fpage>
        <lpage>541</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btv634</pub-id>
        <pub-id pub-id-type="pmid">26515818</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Korthauer</surname>
            <given-names>KD</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A statistical approach for identifying differential distributions in single-cell RNA-seq experiments</article-title>
        <source>Genome Biol.</source>
        <year>2016</year>
        <volume>17</volume>
        <fpage>1</fpage>
        <lpage>15</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-016-1077-y</pub-id>
        <pub-id pub-id-type="pmid">26753840</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>McCarthy</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Smyth</surname>
            <given-names>GK</given-names>
          </name>
        </person-group>
        <article-title>Differential expression analysis of multifactor RNA-Seq experiments with respect to biological variation</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2012</year>
        <volume>40</volume>
        <fpage>4288</fpage>
        <lpage>4297</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gks042</pub-id>
        <pub-id pub-id-type="pmid">22287627</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schoenberg</surname>
            <given-names>IJ</given-names>
          </name>
        </person-group>
        <article-title>Contributions to the problem of approximation of equidistant data by analytic functions</article-title>
        <source>Q. Appl. Math.</source>
        <year>1946</year>
        <volume>4</volume>
        <fpage>45</fpage>
        <lpage>99</lpage>
        <pub-id pub-id-type="doi">10.1090/qam/15914</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Love</surname>
            <given-names>MI</given-names>
          </name>
          <name>
            <surname>Huber</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Anders</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Moderated estimation of fold change and dispersion for RNA-seq data with DESeq2</article-title>
        <source>Genome Biol.</source>
        <year>2014</year>
        <volume>15</volume>
        <fpage>1</fpage>
        <lpage>21</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-014-0550-8</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sing</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Sander</surname>
            <given-names>O</given-names>
          </name>
          <name>
            <surname>Beerenwinkel</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Lengauer</surname>
            <given-names>T</given-names>
          </name>
        </person-group>
        <article-title>ROCR: visualizing classifier performance in R</article-title>
        <source>Bioinformatics</source>
        <year>2005</year>
        <volume>21</volume>
        <fpage>3940</fpage>
        <lpage>3941</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/bti623</pub-id>
        <pub-id pub-id-type="pmid">16096348</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schaum</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell transcriptomics of 20 mouse organs creates a Tabula Muris</article-title>
        <source>Nature</source>
        <year>2018</year>
        <volume>562</volume>
        <fpage>367</fpage>
        <lpage>372</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-018-0590-4</pub-id>
        <pub-id pub-id-type="pmid">30283141</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Nestorowa</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A single-cell resolution map of mouse hematopoietic stem and progenitor cell differentiation</article-title>
        <source>Blood</source>
        <year>2016</year>
        <volume>128</volume>
        <fpage>e20</fpage>
        <lpage>e31</lpage>
        <pub-id pub-id-type="doi">10.1182/blood-2016-05-716480</pub-id>
        <pub-id pub-id-type="pmid">27365425</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kobak</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Berens</surname>
            <given-names>P</given-names>
          </name>
        </person-group>
        <article-title>The art of using t-SNE for single-cell transcriptomics</article-title>
        <source>Nat. Commun.</source>
        <year>2019</year>
        <volume>10</volume>
        <fpage>5416</fpage>
        <pub-id pub-id-type="doi">10.1038/s41467-019-13056-x</pub-id>
        <pub-id pub-id-type="pmid">31780648</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhang</surname>
            <given-names>X</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>CellMarker: a manually curated resource of cell markers in human and mouse</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2019</year>
        <volume>47</volume>
        <fpage>D721</fpage>
        <lpage>D728</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gky900</pub-id>
        <pub-id pub-id-type="pmid">30289549</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <mixed-citation publication-type="other">Satija, R., Hoffman, P. &amp; Butler A. SeuratData: Install and Manage Seurat Datasets. <ext-link ext-link-type="uri" xlink:href="https://www.satijalab.org/seurat">https://www.satijalab.org/seurat</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://github.com/satijalab/seurat-data">https://github.com/satijalab/seurat-data</ext-link> (2019).</mixed-citation>
    </ref>
  </ref-list>
</back>
