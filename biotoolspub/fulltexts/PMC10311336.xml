<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.2 20190208//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.2?>
<?ConverterInfo.XSLTName jats2jats3.xsl?>
<?ConverterInfo.Version 1?>
<?properties open_access?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">Bioinformatics</journal-id>
    <journal-id journal-id-type="publisher-id">bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1367-4803</issn>
    <issn pub-type="epub">1367-4811</issn>
    <publisher>
      <publisher-name>Oxford University Press</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10311336</article-id>
    <article-id pub-id-type="pmid">37387151</article-id>
    <article-id pub-id-type="doi">10.1093/bioinformatics/btad221</article-id>
    <article-id pub-id-type="publisher-id">btad221</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Evolutionary, Comparative and Population Genomics</subject>
      </subj-group>
      <subj-group subj-group-type="category-taxonomy-collection">
        <subject>AcademicSubjects/SCI01060</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Phylogenomic branch length estimation using quartets</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Tabatabaee</surname>
          <given-names>Yasamin</given-names>
        </name>
        <aff><institution>Department of Computer Science, University of Illinois at Urbana-Champaign</institution>, Urbana, IL 61801, <country country="US">United States</country></aff>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Zhang</surname>
          <given-names>Chao</given-names>
        </name>
        <aff><institution>Department of Integrative Biology, University of California at Berkeley</institution>, Berkeley, CA 94720, <country country="US">United States</country></aff>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Warnow</surname>
          <given-names>Tandy</given-names>
        </name>
        <aff><institution>Department of Computer Science, University of Illinois at Urbana-Champaign</institution>, Urbana, IL 61801, <country country="US">United States</country></aff>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid" authenticated="false">https://orcid.org/0000-0001-5410-1518</contrib-id>
        <name>
          <surname>Mirarab</surname>
          <given-names>Siavash</given-names>
        </name>
        <aff><institution>Department of Electrical and Computer Engineering, University of California, San Diego</institution>, La Jolla, CA 92093, <country country="US">United States</country></aff>
        <!--smirarab@ucsd.edu-->
        <xref rid="btad221-cor1" ref-type="corresp"/>
      </contrib>
    </contrib-group>
    <author-notes>
      <corresp id="btad221-cor1">Corresponding author. Department of Electrical and Computer Engineering, University of California, San Diego, 9500 Gilman Drive, La Jolla, CA 92093, United States. E-mail: <email>smirarab@ucsd.edu</email></corresp>
    </author-notes>
    <pub-date pub-type="collection">
      <month>6</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="epub" iso-8601-date="2023-06-30">
      <day>30</day>
      <month>6</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>30</day>
      <month>6</month>
      <year>2023</year>
    </pub-date>
    <volume>39</volume>
    <issue>Suppl 1</issue>
    <issue-title>ISMB/ECCB 2023 Proceedings</issue-title>
    <fpage>i185</fpage>
    <lpage>i193</lpage>
    <permissions>
      <copyright-statement>© The Author(s) 2023. Published by Oxford University Press.</copyright-statement>
      <copyright-year>2023</copyright-year>
      <license>
        <ali:license_ref xmlns:ali="http://www.niso.org/schemas/ali/1.0/" specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted reuse, distribution, and reproduction in any medium, provided the original work is properly cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="btad221.pdf"/>
    <abstract>
      <title>Abstract</title>
      <sec id="s1">
        <title>Motivation</title>
        <p>Branch lengths and topology of a species tree are essential in most downstream analyses, including estimation of diversification dates, characterization of selection, understanding adaptation, and comparative genomics. Modern phylogenomic analyses often use methods that account for the heterogeneity of evolutionary histories across the genome due to processes such as incomplete lineage sorting. However, these methods typically do not generate branch lengths in units that are usable by downstream applications, forcing phylogenomic analyses to resort to alternative shortcuts such as estimating branch lengths by concatenating gene alignments into a supermatrix. Yet, concatenation and other available approaches for estimating branch lengths fail to address heterogeneity across the genome.</p>
      </sec>
      <sec id="s2">
        <title>Results</title>
        <p>In this article, we derive expected values of gene tree branch lengths in substitution units under an extension of the multispecies coalescent (MSC) model that allows substitutions with varying rates across the species tree. We present CASTLES, a new technique for estimating branch lengths on the species tree from estimated gene trees that uses these expected values, and our study shows that CASTLES improves on the most accurate prior methods with respect to both speed and accuracy.</p>
      </sec>
      <sec id="s3">
        <title>Availability and implementation</title>
        <p>CASTLES is available at <ext-link xlink:href="https://github.com/ytabatabaee/CASTLES" ext-link-type="uri">https://github.com/ytabatabaee/CASTLES</ext-link>.</p>
      </sec>
    </abstract>
    <funding-group>
      <award-group award-type="grant">
        <funding-source>
          <institution-wrap>
            <institution>National Science Foundation</institution>
            <institution-id institution-id-type="DOI">10.13039/100000001</institution-id>
          </institution-wrap>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <institution-wrap>
            <institution>NSF</institution>
            <institution-id institution-id-type="DOI">10.13039/100000001</institution-id>
          </institution-wrap>
        </funding-source>
        <award-id>1845967</award-id>
        <award-id>1636933</award-id>
        <award-id>1920920</award-id>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <institution-wrap>
            <institution>National Institute of Health</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1R35GM142725</award-id>
      </award-group>
    </funding-group>
    <counts>
      <page-count count="9"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec>
    <title>1 Introduction</title>
    <p>Species trees, both their topologies and their branch lengths, are necessary for downstream biological research. For example, branch lengths are required for comparative genomics (<xref rid="btad221-B5" ref-type="bibr">Hahn et al. 2005</xref>) and comparative trait analysis (<xref rid="btad221-B4" ref-type="bibr">Felsenstein 1985</xref>; <xref rid="btad221-B22" ref-type="bibr">O’Meara 2012</xref>), phylodynamics of disease transmission (<xref rid="btad221-B35" ref-type="bibr">Volz et al. 2013</xref>), species delimitation (<xref rid="btad221-B25" ref-type="bibr">Rannala 2015</xref>), measuring phylogenetic diversity (<xref rid="btad221-B3" ref-type="bibr">Faith 2002</xref>; <xref rid="btad221-B13" ref-type="bibr">Lozupone and Knight 2005</xref>), and detecting and characterizing selection (<xref rid="btad221-B6" ref-type="bibr">Kosakovsky Pond and Frost 2005</xref>). Many of these analyses amount to studying changes in the rate of evolution across the tree (<xref rid="btad221-B9" ref-type="bibr">Lanfear et al. 2010</xref>). Most statistical methods designed for these applications rely on branch lengths measured in the unit of the expected number of substitutions per site (SU), readily available from tree inference based on sequence data, or unit of time, or both.</p>
    <p>The traditional approach to the estimation of species trees and branch lengths has been concatenating gene alignments followed by a tree-building method, such as maximum likelihood (<xref rid="btad221-B28" ref-type="bibr">Rokas et al. 2003</xref>). It is now understood (<xref rid="btad221-B27" ref-type="bibr">Roch and Steel 2015</xref>) that this concatenation approach can be positively misleading (i.e. converge to the wrong tree as the number of genes increases) in the face of sufficient gene tree heterogeneity across the genome due to incomplete lineage sorting (ILS), as modeled by the multispecies coalescent (MSC) model (<xref rid="btad221-B23" ref-type="bibr">Pamilo and Nei 1988</xref>). Alternative approaches for estimating species trees have been developed that are statistically consistent under the MSC (see <xref rid="btad221-B7" ref-type="bibr">Kubatko and Knowles 2023</xref>). In particular, methods that combine a set of gene trees to infer a species tree (referred to as “summary methods”) are widely used because of their scalability and accuracy (and notably better accuracy than concatenation when ILS is high). Well-known examples of such methods are ASTRAL (<xref rid="btad221-B17" ref-type="bibr">Mirarab et al. 2014</xref>) and MP-EST (<xref rid="btad221-B12" ref-type="bibr">Liu et al. 2010</xref>), which are used often to analyze phylogenomic datasets. However, the branch lengths produced by summary methods are in coalescent units (CUs), and these do not directly lead to branch lengths in substitution units. Moreover, branch lengths in coalescent units are inferable only for the internal branches, which further limits their utility.</p>
    <p>At the current time, therefore, most coalescent-based analyses estimate species trees and their branch lengths in substitution units (SU) following a two-stage approach, where the first stage computes the tree topology (e.g. using a summary method, such as ASTRAL or MP-EST) and then estimates branch lengths on the tree using a constrained concatenation analysis, such as using a maximum likelihood method to infer branch lengths on a fixed tree topology (e.g. <xref rid="btad221-B30" ref-type="bibr">Song et al. 2012</xref>). However, one major problem with this approach is that the branch length calculation step ignores gene tree heterogeneity across the genome, leading to criticisms of this approach in the scientific literature. For example, <xref rid="btad221-B18" ref-type="bibr">Moody et al. (2022)</xref> criticized the findings by <xref rid="btad221-B39" ref-type="bibr">Zhu et al. (2019)</xref> who postulated a shorter length than previously reported separating archaea and bacteria, arguing that the use of concatenation for branch length estimation can lead to substantial under-estimation in the face of high levels of horizontal gene transfer, where gene trees have widely discordant topologies.</p>
    <p>Another approach for SU branch length estimation on species trees is ERaBLE (<xref rid="btad221-B1" ref-type="bibr">Binet et al. 2016</xref>), which uses the SU branch lengths estimated in a set of gene trees and then solves a weighted least-squared optimization problem to assign SU branch lengths to the species tree. However, as with the standard concatenation approach, ERaBLE does not take heterogeneity in gene tree <italic toggle="yes">topologies</italic> due to ILS into account. When a strict molecular clock holds, then branch length estimation in the species tree becomes feasible. However, it is well understood that strict clock-based methods have poor accuracy for many datasets where mutation rates change across the tree (<xref rid="btad221-B2" ref-type="bibr">Bromham and Penny 2003</xref>; <xref rid="btad221-B8" ref-type="bibr">Kumar 2005</xref>). Hence, clock-based approaches do not offer a viable solution.</p>
    <p>To summarize, existing methods to compute SU branch lengths that take discordance between gene trees due to ILS into account, without a strict molecular clock, have not yet been developed. And in particular, we currently lack a theoretical basis for inferring SU lengths for species trees that addresses heterogeneity in gene tree topologies due to ILS, as modeled by the MSC. This is a glaring gap that needs to be filled.</p>
    <p>The unsatisfactory state-of-the-art leads us to ask: How can we estimate branch lengths on species trees that are accurate, even in the face of high levels of ILS and that does not depend on a strong molecular clock? We specifically seek a method that has a strong theoretical foundation based on the MSC. We also seek to develop a method that is sufficiently fast that it is scalable to large genome-wide datasets with hundreds to thousands of genes and species. Because we seek to develop scalable methods, Bayesian co-estimation of gene trees and species trees (topologies and branch lengths) is infeasible as even the best of these methods are computationally intensive on smaller datasets with about 50 species and 200 genes (<xref rid="btad221-B40" ref-type="bibr">Zimmermann et al. 2014</xref>; <xref rid="btad221-B21" ref-type="bibr">Ogilvie et al. 2017</xref>).</p>
    <p>Here, we propose the Coalescent-Aware Species Tree Length Estimation in Substitution-unit (CASTLES) method. The input to CASTLES is a rooted species tree <italic toggle="yes">topology</italic> and a set of inferred gene trees with SU branch lengths, which can have missing data, polytomies, and multiple individuals per species. The output is the species tree furnished with SU lengths on all branches; at the root, only the sum of the lengths of the two root-incident branches is inferred. CASTLES addresses gene tree heterogeneity under the MSC and naturally occurring variation in mutation rates; thus, it does not assume strict molecular clock. Similar to methods like ASTRAL for species tree topology inference, we use a quartet-based approach. We first derive the expected branch length of gene trees that do or do not match a quartet species tree under our model as a function of their CU length and mutation rates. These derivations suggest an algorithm for estimating SU branch lengths, but the approach is cumbersome to implement. Through approximations and simplifications, we derive a much simpler estimator that still retains non-ultrametricity. Going beyond trees with four species in a naive way, iterating over all <inline-formula id="IE1"><mml:math id="IM1" display="inline" overflow="scroll"><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mtable><mml:mtr><mml:mtd><mml:mi>n</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mn>4</mml:mn></mml:mtd></mml:mtr></mml:mtable><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> quartets, would lead to the loss of scalability. Instead, we design a sophisticated dynamic programming algorithm to compute quantities needed by our algorithm in quadratic time. We compare CASTLES to leading alternatives using a simulation study and demonstrate its superior accuracy and speed. Finally, we apply it to a biological dataset.</p>
  </sec>
  <sec>
    <title>2 Materials and methods</title>
    <p>We first describe a model that generates gene trees with SU branch lengths. We then derive the expected gene tree branch lengths under this model for a single quartet. The resulting set of non-linear equations can be (approximately) solved using numerical methods, and will yield values for the model parameters given quantities that can be measured from the gene trees. However, solving these equations is computationally intensive, involves numerical instabilities, may not produce optimal solutions and is cumbersome; therefore, here we present simplifications that give analytical formulas for every branch of a quartet tree. Using equations for the simplified model, we then develop an algorithm that can handle a tree with arbitrary size <italic toggle="yes">n</italic>, including a scalable (quadratic) dynamic programming algorithm to compute averages of quartet branch lengths across gene trees for <inline-formula id="IE2"><mml:math id="IM2" display="inline" overflow="scroll"><mml:mrow><mml:mo>Θ</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mn>4</mml:mn></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> quartets. We relegate most proofs to the <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>.</p>
    <sec>
      <title>2.1 MSC + Substitution model</title>
      <p>Our model parameters include a species tree <inline-formula id="IE3"><mml:math id="IM3" display="inline" overflow="scroll"><mml:mi mathvariant="script">T</mml:mi></mml:math></inline-formula> and several per-branch attributes (<xref rid="btad221-F1" ref-type="fig">Fig. 1a</xref>). Each branch <italic toggle="yes">i</italic> is furnished with a branch length <inline-formula id="IE4"><mml:math id="IM4" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>τ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> in the unit of the number of generations, a haploid effective population size <inline-formula id="IE5"><mml:math id="IM5" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, and a substitutions-per-generation rate <inline-formula id="IE6"><mml:math id="IM6" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>. The CU length of the branch is simply <inline-formula id="IE7"><mml:math id="IM7" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>τ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>/</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>. Let <inline-formula id="IE8"><mml:math id="IM8" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> denote the CU substitution rate. The SU length of the branch is <inline-formula id="IE9"><mml:math id="IM9" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>τ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>; thus, setting unequal <inline-formula id="IE10"><mml:math id="IM10" display="inline" overflow="scroll"><mml:mo>ν</mml:mo></mml:math></inline-formula> values across the tree branches leads to a non-ultrametric species tree. Gene trees are first drawn under the MSC model (ignoring <inline-formula id="IE11"><mml:math id="IM11" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>), thus producing trees with lengths in the unit of generations. Gene trees with SU length are generated by multiplying the length of every infinitesimally small part of each of their branches passing through a species tree branch <italic toggle="yes">i</italic> by the species tree rate <inline-formula id="IE12"><mml:math id="IM12" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>. For example, the length of the terminal branch <italic toggle="yes">A</italic> in <xref rid="btad221-F1" ref-type="fig">Fig. 1</xref> is <inline-formula id="IE13"><mml:math id="IM13" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:mi>x</mml:mi><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. Note that under this model, species tree CU lengths connect indirectly to SU and time units; inferring SU from CU requires <inline-formula id="IE14"><mml:math id="IM14" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, inferring the number of generations needs the population size, and inferring time additionally needs the generation time.</p>
      <fig position="float" id="btad221-F1">
        <label>Figure 1.</label>
        <caption>
          <p>(a) MSC + Substitution model. Each branch of the species tree is furnished with parameters described in the legend. As a gene tree evolves inside the species tree, its branches inherit the substitution rates of all the species tree branches that they pass through. When mutation rates change across species tree branches, the resulting gene tree is non-ultrametric. We match the theoretical expected values of the five branches of a gene tree that matches or does not match the species tree (namely, <inline-formula id="IE15"><mml:math id="IM15" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>B</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>C</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>D</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, and <inline-formula id="IE16"><mml:math id="IM16" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>I</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> for a matching gene tree shown here) to their empirical means, computed from gene trees. (b) Handling a tree with more than four taxa. Each focal internal branch (arrow) divides the tree into four groups, here denoted as <italic toggle="yes">A</italic>, <italic toggle="yes">B</italic>, <italic toggle="yes">C</italic>, and <italic toggle="yes">D</italic>. To use quartet-based equations, we average branch lengths over all quartets with one leaf selected from each of <italic toggle="yes">A</italic>, <italic toggle="yes">B</italic>, <italic toggle="yes">C</italic>, and <italic toggle="yes">D</italic> (e.g. <inline-formula id="IE17"><mml:math id="IM17" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>b</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>). Note that in one gene tree, some quartets around a species tree branch may contribute to matching while others contribute to non-matching average lengths (examples shown). We compute these averages efficiently without listing all <inline-formula id="IE18"><mml:math id="IM18" display="inline" overflow="scroll"><mml:mrow><mml:mi>O</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mn>4</mml:mn></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> quartets using dynamic programming.</p>
        </caption>
        <graphic xlink:href="btad221f1" position="float"/>
      </fig>
    </sec>
    <sec>
      <title>2.2 Expected quartet branch lengths under the MSC</title>
      <p>Focusing on a quartet, we now derive the expected length of all branches as a function of the model parameters. Consider unbalanced and balanced species trees shown in <xref rid="btad221-F1" ref-type="fig">Fig. 1</xref>. In the <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>, we present <xref rid="sup1" ref-type="supplementary-material">Supplementary Lemmas S1–S6</xref>, which derive the expected length of each terminal and internal branch in the gene trees that do or do not match the unbalanced or balanced species trees. Note that these expectations can be estimated in a statistically consistent manner given true gene trees with SU branch lengths. Combined, we derive 10 equations across the five branches, relating the measurable expected values to the unknown parameters. Since <inline-formula id="IE19"><mml:math id="IM19" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE20"><mml:math id="IM20" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> only appear as <inline-formula id="IE21"><mml:math id="IM21" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> for all terminal branches (<inline-formula id="IE22"><mml:math id="IM22" display="inline" overflow="scroll"><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mo>{</mml:mo><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>B</mml:mi><mml:mo>,</mml:mo><mml:mi>C</mml:mi><mml:mo>,</mml:mo><mml:mi>D</mml:mi><mml:mo>}</mml:mo></mml:mrow></mml:math></inline-formula>), we have four unknown parameters for terminal branches. With three unknown rates (<inline-formula id="IE23"><mml:math id="IM23" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>3</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>) and two unknown CU internal lengths (<inline-formula id="IE24"><mml:math id="IM24" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE25"><mml:math id="IM25" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>), we have 9 unknowns in total.</p>
      <p>This non-linear system of 10 equations and 9 unknowns can be (approximately) solved using numerical methods to jointly estimate all the parameters. Such an optimization approach, however, is subject to numerical instability, may be slow, and may not give optimal solutions for this (possibly) non-convex optimization problem. Instead of exploring that path, we observe that by making some simplifying assumptions, we can compute all the branch lengths analytically.</p>
      <p>Theorem 1 and the similar <xref rid="sup1" ref-type="supplementary-material">Supplementary Theorem S1</xref> (<xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>) for balanced trees follow from the lemmas mentioned earlier.<statement id="mthst1"><label>Theorem 1</label><p>(Unbalanced). <italic toggle="yes">For the unbalanced species tree of <xref rid="btad221-F1" ref-type="fig">Fig. 1a</xref>, let</italic><inline-formula id="IE26"><mml:math id="IM26" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>I</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula><italic toggle="yes">be the difference in the expected internal branch length in substitution units of gene trees with an unrooted topology matching the species tree and those not matching the species tree. Then</italic>,
</p><p><italic toggle="yes">Similarly, let</italic> <inline-formula id="IE27"><mml:math id="IM27" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>C</mml:mi></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math></inline-formula><italic toggle="yes">and</italic> <inline-formula id="IE28"><mml:math id="IM28" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>D</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula><italic toggle="yes">be the difference in the expected length of matching and non-matching gene trees for the terminal branch leading to a cherry, the middle terminal branch, and the root-adjacent terminal branch, respectively.</italic></p></statement></p>
      <disp-formula id="E1">
        <label>(1)</label>
        <mml:math id="M1" display="block" overflow="scroll">
          <mml:mrow>
            <mml:mtable>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mo>Δ</mml:mo>
                      </mml:mrow>
                      <mml:mi>I</mml:mi>
                    </mml:msub>
                    <mml:mo>=</mml:mo>
                  </mml:mrow>
                  <mml:mrow>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:mn>3</mml:mn>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>−</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:mn>3</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>1</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>3</mml:mn>
                        </mml:msub>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo>+</mml:mo>
                        <mml:mn>6</mml:mn>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>1</mml:mn>
                        </mml:msub>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>−</mml:mo>
                        <mml:mn>1</mml:mn>
                        <mml:mo>+</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mi>T</mml:mi>
                          </mml:mrow>
                          <mml:mn>1</mml:mn>
                        </mml:msub>
                        <mml:mo stretchy="false">)</mml:mo>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
            </mml:mtable>
          </mml:mrow>
          <mml:mo>.</mml:mo>
        </mml:math>
      </disp-formula>
      <disp-formula id="E2">
        <label>(2)</label>
        <mml:math id="M2" display="block" overflow="scroll">
          <mml:mrow>
            <mml:mtable>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mo>Δ</mml:mo>
                      </mml:mrow>
                      <mml:mi>A</mml:mi>
                    </mml:msub>
                    <mml:mo>=</mml:mo>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:mn>4</mml:mn>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:mn>6</mml:mn>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>1</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>+</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:mn>3</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>+</mml:mo>
                        <mml:mfrac>
                          <mml:mrow>
                            <mml:mn>9</mml:mn>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:mrow>
                        </mml:mfrac>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>3</mml:mn>
                        </mml:msub>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:mo>+</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:mo>+</mml:mo>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mrow>
                          <mml:mo>(</mml:mo>
                          <mml:mrow>
                            <mml:mfrac>
                              <mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mn>2</mml:mn>
                              </mml:mrow>
                            </mml:mfrac>
                            <mml:mo stretchy="true">(</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                            <mml:mo>+</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>3</mml:mn>
                            </mml:msub>
                            <mml:mo stretchy="true">)</mml:mo>
                            <mml:msup>
                              <mml:mrow>
                                <mml:mi>e</mml:mi>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mo>−</mml:mo>
                                <mml:mn>3</mml:mn>
                                <mml:msub>
                                  <mml:mrow>
                                    <mml:mi>T</mml:mi>
                                  </mml:mrow>
                                  <mml:mn>2</mml:mn>
                                </mml:msub>
                              </mml:mrow>
                            </mml:msup>
                            <mml:mo>+</mml:mo>
                            <mml:mn>6</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                            <mml:mo stretchy="true">(</mml:mo>
                            <mml:mn>1</mml:mn>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                            <mml:mo stretchy="true">)</mml:mo>
                            <mml:mo>−</mml:mo>
                            <mml:mn>5</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                          <mml:mo>)</mml:mo>
                        </mml:mrow>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:mo>+</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
            </mml:mtable>
          </mml:mrow>
          <mml:mo>.</mml:mo>
        </mml:math>
      </disp-formula>
      <disp-formula id="E3">
        <label>(3)</label>
        <mml:math id="M3" display="block" overflow="scroll">
          <mml:mrow>
            <mml:mtable>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mo>Δ</mml:mo>
                      </mml:mrow>
                      <mml:mi>C</mml:mi>
                    </mml:msub>
                    <mml:mo>=</mml:mo>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                        <mml:mrow>
                          <mml:mo>(</mml:mo>
                          <mml:mrow>
                            <mml:mrow>
                              <mml:mo>(</mml:mo>
                              <mml:mrow>
                                <mml:msup>
                                  <mml:mrow>
                                    <mml:mi>e</mml:mi>
                                  </mml:mrow>
                                  <mml:mrow>
                                    <mml:mo>−</mml:mo>
                                    <mml:mn>3</mml:mn>
                                    <mml:msub>
                                      <mml:mrow>
                                        <mml:mi>T</mml:mi>
                                      </mml:mrow>
                                      <mml:mn>2</mml:mn>
                                    </mml:msub>
                                  </mml:mrow>
                                </mml:msup>
                                <mml:mo>+</mml:mo>
                                <mml:mn>2</mml:mn>
                              </mml:mrow>
                              <mml:mo>)</mml:mo>
                            </mml:mrow>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                            <mml:mo>−</mml:mo>
                            <mml:mn>3</mml:mn>
                            <mml:msup>
                              <mml:mrow>
                                <mml:mi>e</mml:mi>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mo>−</mml:mo>
                                <mml:msub>
                                  <mml:mrow>
                                    <mml:mi>T</mml:mi>
                                  </mml:mrow>
                                  <mml:mn>2</mml:mn>
                                </mml:msub>
                              </mml:mrow>
                            </mml:msup>
                            <mml:mo stretchy="true">(</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>3</mml:mn>
                            </mml:msub>
                            <mml:mo stretchy="true">)</mml:mo>
                          </mml:mrow>
                          <mml:mo>)</mml:mo>
                        </mml:mrow>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:mo>+</mml:mo>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>3</mml:mn>
                        </mml:msub>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:mn>3</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>−</mml:mo>
                        <mml:mn>4</mml:mn>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
            </mml:mtable>
          </mml:mrow>
          <mml:mo>.</mml:mo>
        </mml:math>
      </disp-formula>
      <disp-formula id="E4">
        <label>(4)</label>
        <mml:math id="M4" display="block" overflow="scroll">
          <mml:mrow>
            <mml:mtable>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mo>Δ</mml:mo>
                      </mml:mrow>
                      <mml:mi>D</mml:mi>
                    </mml:msub>
                    <mml:mo>=</mml:mo>
                  </mml:mrow>
                </mml:mtd>
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>1</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>−</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:mn>3</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>3</mml:mn>
                        </mml:msub>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo stretchy="false">)</mml:mo>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
            </mml:mtable>
          </mml:mrow>
          <mml:mo>.</mml:mo>
        </mml:math>
      </disp-formula>
      <p>We simplify the equations of Theorem 1 by computing their limit as <inline-formula id="IE29"><mml:math id="IM29" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:math></inline-formula> or <inline-formula id="IE30"><mml:math id="IM30" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>3</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. Note that neither assumption completely breaks non-ultrametricity assumptions because we ignore the rate for only one branch (<inline-formula id="IE31"><mml:math id="IM31" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>) and not the others.</p>
    </sec>
    <sec>
      <title>2.3 Simplifications</title>
      <sec>
        <title>2.3.1 Internal branch calculation</title>
        <p>To compute <inline-formula id="IE32"><mml:math id="IM32" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>, we simplify <xref rid="E1" ref-type="disp-formula">Equation (1)</xref> so that it only depends on <inline-formula id="IE33"><mml:math id="IM33" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE34"><mml:math id="IM34" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>, by computing its limits:
</p>
        <disp-formula id="E5">
          <label>(5)</label>
          <mml:math id="M5" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mtable>
                <mml:mtr columnalign="left">
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:mo>∞</mml:mo>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>Δ</mml:mo>
                        </mml:mrow>
                        <mml:mi>I</mml:mi>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:mn>0</mml:mn>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>Δ</mml:mo>
                        </mml:mrow>
                        <mml:mi>I</mml:mi>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>3</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>Δ</mml:mo>
                        </mml:mrow>
                        <mml:mi>I</mml:mi>
                      </mml:msub>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>=</mml:mo>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo stretchy="false">(</mml:mo>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                          <mml:mo>−</mml:mo>
                          <mml:mn>1</mml:mn>
                          <mml:mo>+</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo stretchy="false">)</mml:mo>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                          <mml:mo>−</mml:mo>
                          <mml:mn>2</mml:mn>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                        </mml:mrow>
                      </mml:mfrac>
                    </mml:mrow>
                  </mml:mtd>
                </mml:mtr>
              </mml:mtable>
            </mml:mrow>
            <mml:mo>.</mml:mo>
          </mml:math>
        </disp-formula>
        <p>Replacing <inline-formula id="IE35"><mml:math id="IM35" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>I</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> with the observed difference between mean internal branches among matching and non-matching gene trees (<inline-formula id="IE36"><mml:math id="IM36" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>Δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>I</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>), we get an equation with two unknowns, <inline-formula id="IE37"><mml:math id="IM37" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE38"><mml:math id="IM38" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. One way to move forward is to estimate <inline-formula id="IE39"><mml:math id="IM39" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> using quartet discordance, as shown by <xref rid="btad221-B29" ref-type="bibr">Sayyari and Mirarab (2016)</xref>. Then, we can estimate <inline-formula id="IE40"><mml:math id="IM40" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> and thus <inline-formula id="IE41"><mml:math id="IM41" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. However, the accuracy of the CU estimate of <inline-formula id="IE42"><mml:math id="IM42" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> is known to degrade for inaccurate gene trees (<xref rid="btad221-B29" ref-type="bibr">Sayyari and Mirarab 2016</xref>). Instead, we use a local clock approximation to estimate <inline-formula id="IE43"><mml:math id="IM43" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> and then solve for <inline-formula id="IE44"><mml:math id="IM44" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. If mutation rates of the two branches above the focal branch are assumed the same (e.g. <inline-formula id="IE45"><mml:math id="IM45" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>3</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>), then, the expected length of gene trees not matching the species tree is simply <inline-formula id="IE46"><mml:math id="IM46" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> by <xref rid="sup1" ref-type="supplementary-material">Supplementary Lemma S1</xref> (<xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>). Further assuming <inline-formula id="IE47"><mml:math id="IM47" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> allows us to estimate <inline-formula id="IE48"><mml:math id="IM48" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> as the mean length of the internal quartet branch among gene trees not matching the species tree (<inline-formula id="IE49"><mml:math id="IM49" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>I</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>), obtaining:
</p>
        <disp-formula id="E6">
          <label>(6)</label>
          <mml:math id="M6" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mtable>
                <mml:mtr columnalign="left">
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mrow>
                                <mml:mover accent="true">
                                  <mml:mi>Δ</mml:mi>
                                  <mml:mo>¯</mml:mo>
                                </mml:mover>
                              </mml:mrow>
                            </mml:mrow>
                            <mml:mi>I</mml:mi>
                          </mml:msub>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msubsup>
                            <mml:mrow>
                              <mml:mrow>
                                <mml:mover accent="true">
                                  <mml:mi>L</mml:mi>
                                  <mml:mo>¯</mml:mo>
                                </mml:mover>
                              </mml:mrow>
                            </mml:mrow>
                            <mml:mi>I</mml:mi>
                            <mml:mo>′</mml:mo>
                          </mml:msubsup>
                        </mml:mrow>
                      </mml:mfrac>
                    </mml:mrow>
                  </mml:mtd>
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:mo>=</mml:mo>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                          <mml:mo stretchy="false">(</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo>+</mml:mo>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                          <mml:mo>−</mml:mo>
                          <mml:mn>1</mml:mn>
                          <mml:mo stretchy="false">)</mml:mo>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                          <mml:mo>−</mml:mo>
                          <mml:mn>2</mml:mn>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                        </mml:mrow>
                      </mml:mfrac>
                    </mml:mrow>
                  </mml:mtd>
                </mml:mtr>
              </mml:mtable>
            </mml:mrow>
            <mml:mo>.</mml:mo>
          </mml:math>
        </disp-formula>
        <p>The solution to this equation is:
where <inline-formula id="IE50"><mml:math id="IM50" display="inline" overflow="scroll"><mml:mrow><mml:mi>W</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mo>.</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> is the Lambert W function and <inline-formula id="IE51"><mml:math id="IM51" display="inline" overflow="scroll"><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>Δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>I</mml:mi></mml:msub><mml:mo>/</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>I</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>. Since Lambert’s function does not have a closed-form solution (and can be imaginary), we resort to the Taylor expansion <inline-formula id="IE52"><mml:math id="IM52" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mi>e</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>, which is a good approximation for small <inline-formula id="IE53"><mml:math id="IM53" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. Using this approximation, the solution to <xref rid="E6" ref-type="disp-formula">Equation (6)</xref> becomes:
</p>
        <disp-formula id="E7">
          <mml:math id="M7" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mi>δ</mml:mi>
                  <mml:mo>¯</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>+</mml:mo>
              <mml:mi>W</mml:mi>
              <mml:mrow>
                <mml:mo>(</mml:mo>
                <mml:mrow>
                  <mml:mo>−</mml:mo>
                  <mml:mfrac>
                    <mml:mrow>
                      <mml:mn>1</mml:mn>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mn>3</mml:mn>
                    </mml:mrow>
                  </mml:mfrac>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:mrow>
                        <mml:mover accent="true">
                          <mml:mi>δ</mml:mi>
                          <mml:mo>¯</mml:mo>
                        </mml:mover>
                      </mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:mn>1</mml:mn>
                    </mml:mrow>
                  </mml:msup>
                  <mml:mo stretchy="false">(</mml:mo>
                  <mml:mn>2</mml:mn>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>δ</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                  <mml:mo>+</mml:mo>
                  <mml:mn>3</mml:mn>
                  <mml:mo stretchy="false">)</mml:mo>
                </mml:mrow>
                <mml:mo>)</mml:mo>
              </mml:mrow>
              <mml:mo>+</mml:mo>
              <mml:mn>1</mml:mn>
            </mml:mrow>
            <mml:mo>,</mml:mo>
          </mml:math>
        </disp-formula>
        <disp-formula id="E8">
          <label>(7)</label>
          <mml:math id="M8" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mi>T</mml:mi>
                      </mml:mrow>
                      <mml:mn>1</mml:mn>
                    </mml:msub>
                  </mml:mrow>
                  <mml:mo stretchy="true">^</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>2</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mi>δ</mml:mi>
                  <mml:mo>¯</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>+</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>6</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:msqrt>
                <mml:mrow>
                  <mml:mn>3</mml:mn>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>δ</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                  <mml:mo stretchy="false">(</mml:mo>
                  <mml:mn>3</mml:mn>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>δ</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                  <mml:mo>+</mml:mo>
                  <mml:mn>4</mml:mn>
                  <mml:mo stretchy="false">)</mml:mo>
                </mml:mrow>
              </mml:msqrt>
            </mml:mrow>
            <mml:mo>.</mml:mo>
          </mml:math>
        </disp-formula>
        <p>In our current implementation of CASTLES, we use this approximation to avoid numerical issues. When <inline-formula id="IE54"><mml:math id="IM54" display="inline" overflow="scroll"><mml:mrow><mml:mo>δ</mml:mo><mml:mo>&lt;</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula>, we set the branch length to a small value (<inline-formula id="IE55"><mml:math id="IM55" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mn>10</mml:mn></mml:mrow></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math></inline-formula> by default).</p>
      </sec>
      <sec>
        <title>2.3.2 Terminal branch calculation</title>
        <p>To simplify <xref rid="E2" ref-type="disp-formula">Equation (2)</xref>, we compute its limit as <inline-formula id="IE56"><mml:math id="IM56" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:math></inline-formula></p>
        <disp-formula id="E9">
          <label>(8)</label>
          <mml:math id="M9" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mtable>
                <mml:mtr columnalign="left">
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:mo>∞</mml:mo>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>Δ</mml:mo>
                        </mml:mrow>
                        <mml:mi>A</mml:mi>
                      </mml:msub>
                    </mml:mrow>
                  </mml:mtd>
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:mo>=</mml:mo>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:mo>−</mml:mo>
                          <mml:mn>6</mml:mn>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo stretchy="false">(</mml:mo>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                          <mml:mo>−</mml:mo>
                          <mml:mn>1</mml:mn>
                          <mml:mo>+</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo stretchy="false">)</mml:mo>
                          <mml:mo>−</mml:mo>
                          <mml:mo stretchy="false">(</mml:mo>
                          <mml:mn>5</mml:mn>
                          <mml:mo>−</mml:mo>
                          <mml:mn>4</mml:mn>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                          <mml:mo stretchy="false">)</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mn>6</mml:mn>
                          <mml:mo>−</mml:mo>
                          <mml:mn>4</mml:mn>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                        </mml:mrow>
                      </mml:mfrac>
                      <mml:mo> </mml:mo>
                      <mml:mo>.</mml:mo>
                    </mml:mrow>
                  </mml:mtd>
                </mml:mtr>
              </mml:mtable>
            </mml:mrow>
          </mml:math>
        </disp-formula>
        <p>The expected length of the terminal branch of <italic toggle="yes">A</italic> in non-matching gene trees in the limit is
based on <xref rid="sup1" ref-type="supplementary-material">Supplementary Equation (S19)</xref> (<xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>). To compute <inline-formula id="IE57"><mml:math id="IM57" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> we replace the expected value <inline-formula id="IE58"><mml:math id="IM58" display="inline" overflow="scroll"><mml:mrow><mml:munder><mml:mrow><mml:mi>lim</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>A</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> in <xref rid="E9" ref-type="disp-formula">Equation (8)</xref> with the observed mean difference <inline-formula id="IE59"><mml:math id="IM59" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>Δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>A</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and replace the expected value <inline-formula id="IE60"><mml:math id="IM60" display="inline" overflow="scroll"><mml:mrow><mml:munder><mml:mrow><mml:mi>lim</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:munder><mml:msubsup><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>A</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula> in <xref rid="E10" ref-type="disp-formula">Equation (9)</xref> with the observed mean terminal branch of <italic toggle="yes">A</italic> among non-matching gene trees (<inline-formula id="IE61"><mml:math id="IM61" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>A</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>). Solving for <inline-formula id="IE62"><mml:math id="IM62" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>A</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> gives us an estimator of <inline-formula id="IE63"><mml:math id="IM63" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>:
</p>
        <disp-formula id="E10">
          <label>(9)</label>
          <mml:math id="M10" display="block" overflow="scroll">
            <mml:mrow>
              <mml:munder>
                <mml:mrow>
                  <mml:mi>lim</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mi>T</mml:mi>
                    </mml:mrow>
                    <mml:mn>2</mml:mn>
                  </mml:msub>
                  <mml:mo>→</mml:mo>
                  <mml:mo>∞</mml:mo>
                </mml:mrow>
              </mml:munder>
              <mml:msubsup>
                <mml:mrow>
                  <mml:mi>L</mml:mi>
                </mml:mrow>
                <mml:mi>A</mml:mi>
                <mml:mo>′</mml:mo>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mi>T</mml:mi>
                </mml:mrow>
                <mml:mn>1</mml:mn>
              </mml:msub>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mn>1</mml:mn>
              </mml:msub>
              <mml:mo>+</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mi>T</mml:mi>
                </mml:mrow>
                <mml:mi>A</mml:mi>
              </mml:msub>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mi>A</mml:mi>
              </mml:msub>
              <mml:mo>+</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>5</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>6</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mn>2</mml:mn>
              </mml:msub>
            </mml:mrow>
          </mml:math>
        </disp-formula>
        <disp-formula id="E11">
          <label>(10)</label>
          <mml:math id="M11" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mi>t</mml:mi>
                      </mml:mrow>
                      <mml:mi>A</mml:mi>
                    </mml:msub>
                  </mml:mrow>
                  <mml:mo stretchy="true">^</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>=</mml:mo>
              <mml:msubsup>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>L</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>A</mml:mi>
                <mml:mo>′</mml:mo>
              </mml:msubsup>
              <mml:mo>+</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mo>μ</mml:mo>
                    </mml:mrow>
                    <mml:mn>1</mml:mn>
                  </mml:msub>
                  <mml:mo stretchy="false">(</mml:mo>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>1</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:msup>
                  <mml:mo>−</mml:mo>
                  <mml:mn>1</mml:mn>
                  <mml:mo>+</mml:mo>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mi>T</mml:mi>
                    </mml:mrow>
                    <mml:mn>1</mml:mn>
                  </mml:msub>
                  <mml:mo stretchy="false">)</mml:mo>
                  <mml:mo>+</mml:mo>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mrow>
                        <mml:mover accent="true">
                          <mml:mi>Δ</mml:mi>
                          <mml:mo>¯</mml:mo>
                        </mml:mover>
                      </mml:mrow>
                    </mml:mrow>
                    <mml:mi>A</mml:mi>
                  </mml:msub>
                  <mml:mo stretchy="false">(</mml:mo>
                  <mml:mn>1</mml:mn>
                  <mml:mo>−</mml:mo>
                  <mml:mn>2</mml:mn>
                  <mml:mo>/</mml:mo>
                  <mml:mn>3</mml:mn>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>1</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:msup>
                  <mml:mo stretchy="false">)</mml:mo>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                  <mml:mo>−</mml:mo>
                  <mml:mn>4</mml:mn>
                  <mml:mo>/</mml:mo>
                  <mml:mn>5</mml:mn>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>1</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:msup>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo>−</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mi>T</mml:mi>
                </mml:mrow>
                <mml:mn>1</mml:mn>
              </mml:msub>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mn>1</mml:mn>
              </mml:msub>
              <mml:mo> </mml:mo>
              <mml:mo>.</mml:mo>
            </mml:mrow>
          </mml:math>
        </disp-formula>
        <p>Similarly, for branch <italic toggle="yes">C</italic>,
where the expected length of <italic toggle="yes">C</italic> in non-matching gene trees (<inline-formula id="IE64"><mml:math id="IM64" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>C</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>) is given in <xref rid="sup1" ref-type="supplementary-material">Supplementary Equation (S6)</xref> in the <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>. Replacing <inline-formula id="IE65"><mml:math id="IM65" display="inline" overflow="scroll"><mml:mrow><mml:munder><mml:mrow><mml:mi>lim</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:munder><mml:msubsup><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>C</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula> with the observed length of <italic toggle="yes">C</italic> in non-matching gene trees <inline-formula id="IE66"><mml:math id="IM66" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>C</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula> and replacing <inline-formula id="IE67"><mml:math id="IM67" display="inline" overflow="scroll"><mml:mrow><mml:munder><mml:mrow><mml:mi>lim</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> with the observed <inline-formula id="IE68"><mml:math id="IM68" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>Δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> in <xref rid="E12" ref-type="disp-formula">Equation (11)</xref> gives us the estimate for <inline-formula id="IE69"><mml:math id="IM69" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>C</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>C</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>:
</p>
        <disp-formula id="E12">
          <label>(11)</label>
          <mml:math id="M12" display="block" overflow="scroll">
            <mml:mrow>
              <mml:munder>
                <mml:mrow>
                  <mml:mi>lim</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mi>T</mml:mi>
                    </mml:mrow>
                    <mml:mn>2</mml:mn>
                  </mml:msub>
                  <mml:mo>→</mml:mo>
                  <mml:mo>∞</mml:mo>
                </mml:mrow>
              </mml:munder>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>Δ</mml:mo>
                </mml:mrow>
                <mml:mi>C</mml:mi>
              </mml:msub>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mo>μ</mml:mo>
                    </mml:mrow>
                    <mml:mn>2</mml:mn>
                  </mml:msub>
                  <mml:mrow>
                    <mml:mo>(</mml:mo>
                    <mml:mrow>
                      <mml:mn>2</mml:mn>
                      <mml:mo>−</mml:mo>
                      <mml:msup>
                        <mml:mrow>
                          <mml:mi>e</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mo>−</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                      </mml:msup>
                    </mml:mrow>
                    <mml:mo>)</mml:mo>
                  </mml:mrow>
                </mml:mrow>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mo>(</mml:mo>
                    <mml:mrow>
                      <mml:mn>3</mml:mn>
                      <mml:mo>−</mml:mo>
                      <mml:mn>2</mml:mn>
                      <mml:msup>
                        <mml:mrow>
                          <mml:mi>e</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mo>−</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                      </mml:msup>
                    </mml:mrow>
                    <mml:mo>)</mml:mo>
                  </mml:mrow>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo> </mml:mo>
              <mml:mtext>and</mml:mtext>
              <mml:mo> </mml:mo>
              <mml:munder>
                <mml:mrow>
                  <mml:mi>lim</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mi>T</mml:mi>
                    </mml:mrow>
                    <mml:mn>2</mml:mn>
                  </mml:msub>
                  <mml:mo>→</mml:mo>
                  <mml:mo>∞</mml:mo>
                </mml:mrow>
              </mml:munder>
              <mml:msubsup>
                <mml:mrow>
                  <mml:mi>L</mml:mi>
                </mml:mrow>
                <mml:mi>C</mml:mi>
                <mml:mo>′</mml:mo>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>3</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mn>2</mml:mn>
              </mml:msub>
              <mml:mo>+</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mi>T</mml:mi>
                </mml:mrow>
                <mml:mi>C</mml:mi>
              </mml:msub>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mi>C</mml:mi>
              </mml:msub>
            </mml:mrow>
            <mml:mo>,</mml:mo>
          </mml:math>
        </disp-formula>
        <disp-formula id="E13">
          <label>(12)</label>
          <mml:math id="M13" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mi>t</mml:mi>
                      </mml:mrow>
                      <mml:mi>C</mml:mi>
                    </mml:msub>
                  </mml:mrow>
                  <mml:mo stretchy="true">^</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>=</mml:mo>
              <mml:msubsup>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>L</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>C</mml:mi>
                <mml:mo>′</mml:mo>
              </mml:msubsup>
              <mml:mo>−</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>3</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo stretchy="true">(</mml:mo>
              <mml:mn>2</mml:mn>
              <mml:mo>−</mml:mo>
              <mml:mfrac>
                <mml:mn>1</mml:mn>
                <mml:mrow>
                  <mml:mn>2</mml:mn>
                  <mml:mo>−</mml:mo>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>1</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:msup>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo stretchy="true">)</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>Δ</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>C</mml:mi>
              </mml:msub>
              <mml:mo> </mml:mo>
              <mml:mo>.</mml:mo>
            </mml:mrow>
          </mml:math>
        </disp-formula>
        <p>For <italic toggle="yes">D</italic>, we use a different limit:
where the expected length of <italic toggle="yes">D</italic> in non-matching gene trees (<inline-formula id="IE70"><mml:math id="IM70" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>D</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>) is given in <xref rid="sup1" ref-type="supplementary-material">Supplementary Equation (S17)</xref> in the <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>. The pendant branch of <italic toggle="yes">D</italic> in SU in the <italic toggle="yes">unrooted</italic> species tree is <inline-formula id="IE71"><mml:math id="IM71" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>D</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>D</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, representing both branches below the root. Substituting expected values <inline-formula id="IE72"><mml:math id="IM72" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>D</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE73"><mml:math id="IM73" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>D</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula> with observed values <inline-formula id="IE74"><mml:math id="IM74" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>Δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>D</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE75"><mml:math id="IM75" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>D</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>, we get our estimate:
</p>
        <disp-formula id="E14">
          <mml:math id="M14" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mtable>
                <mml:mtr columnalign="left">
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>3</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>Δ</mml:mo>
                        </mml:mrow>
                        <mml:mi>D</mml:mi>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mrow>
                            <mml:mo>(</mml:mo>
                            <mml:mrow>
                              <mml:mn>1</mml:mn>
                              <mml:mo>−</mml:mo>
                              <mml:msup>
                                <mml:mrow>
                                  <mml:mi>e</mml:mi>
                                </mml:mrow>
                                <mml:mrow>
                                  <mml:mo>−</mml:mo>
                                  <mml:msub>
                                    <mml:mrow>
                                      <mml:mi>T</mml:mi>
                                    </mml:mrow>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                </mml:mrow>
                              </mml:msup>
                            </mml:mrow>
                            <mml:mo>)</mml:mo>
                          </mml:mrow>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                          <mml:mo>−</mml:mo>
                          <mml:mn>2</mml:mn>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                        </mml:mrow>
                      </mml:mfrac>
                    </mml:mrow>
                  </mml:mtd>
                </mml:mtr>
                <mml:mtr columnalign="left">
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>3</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msubsup>
                        <mml:mrow>
                          <mml:mi>L</mml:mi>
                        </mml:mrow>
                        <mml:mi>D</mml:mi>
                        <mml:mo>′</mml:mo>
                      </mml:msubsup>
                      <mml:mo>=</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>μ</mml:mo>
                        </mml:mrow>
                        <mml:mn>2</mml:mn>
                      </mml:msub>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>2</mml:mn>
                      </mml:msub>
                      <mml:mo>+</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>μ</mml:mo>
                        </mml:mrow>
                        <mml:mi>D</mml:mi>
                      </mml:msub>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mi>D</mml:mi>
                      </mml:msub>
                      <mml:mo>+</mml:mo>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                        </mml:mrow>
                      </mml:mfrac>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>μ</mml:mo>
                        </mml:mrow>
                        <mml:mn>2</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:mtd>
                </mml:mtr>
              </mml:mtable>
            </mml:mrow>
            <mml:mo>,</mml:mo>
          </mml:math>
        </disp-formula>
        <disp-formula id="E15">
          <label>(13)</label>
          <mml:math id="M15" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mi>t</mml:mi>
                      </mml:mrow>
                      <mml:mn>2</mml:mn>
                    </mml:msub>
                  </mml:mrow>
                  <mml:mo stretchy="true">^</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>+</mml:mo>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mi>t</mml:mi>
                      </mml:mrow>
                      <mml:mi>D</mml:mi>
                    </mml:msub>
                  </mml:mrow>
                  <mml:mo stretchy="true">^</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>=</mml:mo>
              <mml:msubsup>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>L</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>D</mml:mi>
                <mml:mo>′</mml:mo>
              </mml:msubsup>
              <mml:mo>−</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>2</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>3</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo stretchy="true">(</mml:mo>
              <mml:mn>2</mml:mn>
              <mml:mo>+</mml:mo>
              <mml:mfrac>
                <mml:mn>1</mml:mn>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                  <mml:mo>−</mml:mo>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>1</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:msup>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo stretchy="true">)</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>Δ</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>D</mml:mi>
              </mml:msub>
              <mml:mo> </mml:mo>
              <mml:mo>.</mml:mo>
            </mml:mrow>
          </mml:math>
        </disp-formula>
        <p>To summarize, we use <xref rid="E11" ref-type="disp-formula">Equations (10)</xref>, <xref rid="E13" ref-type="disp-formula">(12)</xref>, and <xref rid="E15" ref-type="disp-formula">(13)</xref> to compute terminal branch lengths, setting the length to a small value (<inline-formula id="IE76"><mml:math id="IM76" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mn>10</mml:mn></mml:mrow></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math></inline-formula> by default) when results are negative.</p>
      </sec>
    </sec>
    <sec>
      <title>2.4 Extending to larger trees</title>
      <p>To extend the algorithm to more than four species, we apply the same calculations to each branch of the species tree, one at a time. Each internal branch of the species tree creates a quadripartition of species (e.g. <inline-formula id="IE77"><mml:math id="IM77" display="inline" overflow="scroll"><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>B</mml:mi><mml:mo>|</mml:mo><mml:mi>C</mml:mi><mml:mo>,</mml:mo><mml:mi>D</mml:mi></mml:mrow></mml:math></inline-formula> in <xref rid="btad221-F1" ref-type="fig">Fig. 1b</xref>). Any quartet of species (e.g. <inline-formula id="IE78"><mml:math id="IM78" display="inline" overflow="scroll"><mml:mrow><mml:mi>a</mml:mi><mml:mi>b</mml:mi><mml:mo>|</mml:mo><mml:mi>c</mml:mi><mml:mi>d</mml:mi></mml:mrow></mml:math></inline-formula>) with a selection of one taxon from each part of the quadripartition (<inline-formula id="IE79"><mml:math id="IM79" display="inline" overflow="scroll"><mml:mrow><mml:mi>a</mml:mi><mml:mo>∈</mml:mo><mml:mi>A</mml:mi></mml:mrow></mml:math></inline-formula>, <inline-formula id="IE80"><mml:math id="IM80" display="inline" overflow="scroll"><mml:mrow><mml:mi>b</mml:mi><mml:mo>∈</mml:mo><mml:mi>B</mml:mi></mml:mrow></mml:math></inline-formula>, <inline-formula id="IE81"><mml:math id="IM81" display="inline" overflow="scroll"><mml:mrow><mml:mi>c</mml:mi><mml:mo>∈</mml:mo><mml:mi>C</mml:mi></mml:mrow></mml:math></inline-formula>, and <inline-formula id="IE82"><mml:math id="IM82" display="inline" overflow="scroll"><mml:mrow><mml:mi>d</mml:mi><mml:mo>∈</mml:mo><mml:mi>D</mml:mi></mml:mrow></mml:math></inline-formula>) gives us a quartet species tree where all of our previous theoretical results hold, and they all lead to identical expected values for their corresponding gene tree quartets. Thus, it is valid to compute the length of this species tree branch using the quartet-based approach by simply taking the average lengths across all quartets.</p>
      <p>Assuming the averages are already calculated, we can use <xref rid="btad221-BOX1" ref-type="boxed-text">Algorithm 1</xref> to assign a length to each branch. The algorithm visits the internal nodes of the tree in a post-order traversal. For each internal node, it assigns the length of the edge above, in addition to (some of the) adjacent terminal branches. If a node <italic toggle="yes">u</italic> is the parent of a cherry, it assigns the length to both children; otherwise, it ignores the children. If <italic toggle="yes">u</italic> is sister to a leaf, it also assigns the length to the sister, using <xref rid="E13" ref-type="disp-formula">Equation (12)</xref>. When the tree has more than four taxa, almost all branch lengths are assigned using unbalanced quartet equations. The only exception is the root branch, which may need to be set based on the balanced quartet equations (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S5</xref>).</p>
      <p>The most challenging part of this algorithm, then, is computing mean length across <inline-formula id="IE83"><mml:math id="IM83" display="inline" overflow="scroll"><mml:mrow><mml:mi>O</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mn>4</mml:mn></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> quartets in a scalable fashion. These quantities can be computed using a sophisticated dynamic programming algorithm, which borrows many ideas from weighted ASTRAL (<xref rid="btad221-B37" ref-type="bibr">Zhang and Mirarab 2022</xref>). The running time of the algorithm is <inline-formula id="IE84"><mml:math id="IM84" display="inline" overflow="scroll"><mml:mrow><mml:mi>O</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mi>k</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> for <italic toggle="yes">n</italic> leaves and <italic toggle="yes">k</italic> genes. Due to space limitations, we present the full details for this algorithm in the <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix, Section S2</xref>.</p>
      <p>
        <boxed-text id="btad221-BOX1" position="float">
          <caption>
            <p>Algorithm 1. CASTLES algorithm. The input is a rooted species tree <italic toggle="yes">s</italic> with <inline-formula id="IE85"><mml:math id="IM85" display="inline" overflow="scroll"><mml:mrow><mml:mi>n</mml:mi><mml:mo>&gt;</mml:mo><mml:mn>4</mml:mn></mml:mrow></mml:math></inline-formula> taxa and a set of gene trees <inline-formula id="IE86"><mml:math id="IM86" display="inline" overflow="scroll"><mml:mi mathvariant="script">G</mml:mi></mml:math></inline-formula> with SU branch lengths, and the output is <italic toggle="yes">s</italic> annotated with SU branch lengths. <inline-formula id="IE87"><mml:math id="IM87" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>e</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> denotes the length of branch <italic toggle="yes">e</italic> in SU.</p>
          </caption>
          <p>1: <bold>procedure</bold> CASTLES(<italic toggle="yes">s</italic>, <inline-formula id="IE88"><mml:math id="IM88" display="inline" overflow="scroll"><mml:mi mathvariant="script">G</mml:mi></mml:math></inline-formula>)</p>
          <p>2:  <inline-formula id="IE89"><mml:math id="IM89" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>a</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>b</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>v</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>p</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>a</mml:mi><mml:mo>′</mml:mo></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>b</mml:mi><mml:mo>′</mml:mo></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>v</mml:mi><mml:mo>′</mml:mo></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>p</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula> for each branch <inline-formula id="IE90"><mml:math id="IM90" display="inline" overflow="scroll"><mml:mo>←</mml:mo></mml:math></inline-formula><xref rid="sup1" ref-type="supplementary-material">Supplementary Algorithm S1</xref></p>
          <p>3:  <bold>for</bold><inline-formula id="IE91"><mml:math id="IM91" display="inline" overflow="scroll"><mml:mrow><mml:mi>u</mml:mi><mml:mo>∈</mml:mo></mml:mrow></mml:math></inline-formula> post order traverse of internal nodes of <italic toggle="yes">s</italic> <bold>do</bold></p>
          <p>4:   <bold>if</bold> <italic toggle="yes">u</italic> is root <bold>then</bold></p>
          <p>5:    break</p>
          <p>6:   <bold>end if</bold></p>
          <p>7:   <inline-formula id="IE92"><mml:math id="IM92" display="inline" overflow="scroll"><mml:mrow><mml:mi>p</mml:mi><mml:mo>←</mml:mo><mml:mi mathvariant="italic">parent</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>;</mml:mo><mml:mi>v</mml:mi><mml:mo>←</mml:mo><mml:mi mathvariant="italic">sibling</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula>; <inline-formula id="IE93"><mml:math id="IM93" display="inline" overflow="scroll"><mml:mrow><mml:mi>a</mml:mi><mml:mo>,</mml:mo><mml:mi>b</mml:mi><mml:mo>←</mml:mo><mml:mi mathvariant="italic">children</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>8:   <bold>if</bold> <italic toggle="yes">p</italic> is root <bold>then</bold></p>
          <p>9:    <bold>if</bold> <italic toggle="yes">v</italic> is leaf <bold>then</bold></p>
          <p>10:     <inline-formula id="IE94"><mml:math id="IM94" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>u</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>v</mml:mi></mml:mrow></mml:msub><mml:mo>←</mml:mo><mml:mtext>Equation</mml:mtext><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mn>13</mml:mn><mml:mo>)</mml:mo><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mtext>terminal</mml:mtext><mml:mo> </mml:mo><mml:mi mathvariant="normal">D</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>11:    <bold>else</bold></p>
          <p>12:     <inline-formula id="IE95"><mml:math id="IM95" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>u</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>v</mml:mi></mml:mrow></mml:msub><mml:mo>←</mml:mo><mml:mtext>Equation</mml:mtext><mml:mo> </mml:mo><mml:mo> </mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">S</mml:mi><mml:mn>39</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mo> </mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mtext>internal bal</mml:mtext><mml:mo>.</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>13:    <bold>end if</bold></p>
          <p>14:   <bold>else</bold></p>
          <p>15:    <inline-formula id="IE96"><mml:math id="IM96" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>u</mml:mi></mml:mrow></mml:msub><mml:mo>←</mml:mo><mml:mtext>Equation</mml:mtext><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mn>7</mml:mn><mml:mo>)</mml:mo><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mtext>internal unbal</mml:mtext><mml:mo>.</mml:mo><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>16:    <bold>if</bold> <italic toggle="yes">v</italic> is leaf <bold>then</bold></p>
          <p>17:     <inline-formula id="IE97"><mml:math id="IM97" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>v</mml:mi></mml:mrow></mml:msub><mml:mo>←</mml:mo><mml:mtext>Equation</mml:mtext><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mn>12</mml:mn><mml:mo>)</mml:mo><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mtext>terminal</mml:mtext><mml:mo> </mml:mo><mml:mi mathvariant="normal">C</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>18:    <bold>end if</bold></p>
          <p>19:    <bold>for</bold><inline-formula id="IE98"><mml:math id="IM98" display="inline" overflow="scroll"><mml:mrow><mml:mi>w</mml:mi><mml:mo>∈</mml:mo><mml:mi mathvariant="italic">children</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula><bold>do</bold></p>
          <p>20:     <bold>if</bold> <italic toggle="yes">w</italic> is leaf <bold>and</bold><inline-formula id="IE99"><mml:math id="IM99" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>u</mml:mi><mml:mo>→</mml:mo><mml:mi>w</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> is <bold>null then</bold></p>
          <p>21:      <inline-formula id="IE100"><mml:math id="IM100" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>u</mml:mi><mml:mo>→</mml:mo><mml:mi>w</mml:mi></mml:mrow></mml:msub><mml:mo>←</mml:mo><mml:mtext>Equation</mml:mtext><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mn>10</mml:mn><mml:mo>)</mml:mo><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mtext>terminal</mml:mtext><mml:mo> </mml:mo><mml:mi mathvariant="normal">A</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>22:     <bold>end if</bold></p>
          <p>23:    <bold>end for</bold></p>
          <p>24:   <bold>end if</bold></p>
          <p>25:  <bold>end for</bold></p>
          <p>26: <bold>end procedure</bold></p>
        </boxed-text>
      </p>
    </sec>
    <sec>
      <title>2.5 Experimental setup</title>
      <sec>
        <title>2.5.1 Overview</title>
        <p>We performed a simulation study comparing CASTLES to four other methods by estimating branch lengths on the fixed <italic toggle="yes">true</italic> species tree topology. We report error measured as the absolute error averaged over all branches of each tree. Since absolute error hides the contribution of bias versus variance, we also report the mean error (without absolute), which is a valid measure of the bias of a method. Since the mean absolute error emphasizes long branches more than short branches, we also report two metrics that emphasize shorter branches successively more: root mean squared error (RMSE) and mean absolute log error. For all the methods, negative and zero branch lengths are replaced with <inline-formula id="IE101"><mml:math id="IM101" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mn>10</mml:mn></mml:mrow></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math></inline-formula> (the pseudo-count used by RAxML for identical sequences). Since negative lengths are not usable in downstream analyses, this step emulates practice.</p>
        <p>We performed two experiments: The first, using a new simulated quartet dataset, is not meant to be realistic but to examine accuracy under idealized conditions and to show the impact of successively more challenging models of rate variation and the level of ILS. The second experiment uses two previously published simulated datasets with larger (30-taxon and 101-taxon) trees and more realistic settings, and examines the effect of gene tree estimation error (GTEE), the level of ILS, rate heterogeneity and deviation from the molecular clock, and the inclusion of an outgroup. Additional information about the simulation are provided in <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix, Section S3</xref>.</p>
      </sec>
      <sec>
        <title>2.5.2 Datasets</title>
        <p>To measure the accuracy, we need a species tree with SU branch lengths. The leading simulation method (SimPhy, <xref rid="btad221-B16" ref-type="bibr">Mallo et al. 2016</xref>) produces species trees in the unit of the number of generations (<inline-formula id="IE102"><mml:math id="IM102" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>τ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>). However, SimPhy does select a global substitution rate <inline-formula id="IE103"><mml:math id="IM103" display="inline" overflow="scroll"><mml:mo>ν</mml:mo></mml:math></inline-formula> and assigns a mutation rate multiplier (<inline-formula id="IE104"><mml:math id="IM104" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>) to each species tree branch (<monospace>-hs</monospace> option); setting <inline-formula id="IE105"><mml:math id="IM105" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:mo>ν</mml:mo></mml:mrow></mml:math></inline-formula> matches with the assumed model. Thus, the SU lengths on the species tree can be easily defined as <inline-formula id="IE106"><mml:math id="IM106" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>τ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>. Unfortunately, SimPhy does not output the <inline-formula id="IE107"><mml:math id="IM107" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> rates; we modified its code to output these and the species tree with SU lengths. We used this modified version of SimPhy to regenerate species trees used in our datasets mentioned below and confirmed that the same trees are generated. This procedure gives us the ground truth SU lengths. We use SimPhy to evolve gene trees within each model species tree under the MSC, which allows us to explore the impact of ILS on branch length estimation. We quantify the level of ILS using the “Average Distance” (AD) between true species trees and true gene trees, in terms of the normalized Robinson–Foulds (RF) (<xref rid="btad221-B26" ref-type="bibr">Robinson and Foulds 1981</xref>) distance, producing values that can range from <inline-formula id="IE108"><mml:math id="IM108" display="inline" overflow="scroll"><mml:mrow><mml:mn>0</mml:mn><mml:mo>%</mml:mo></mml:mrow></mml:math></inline-formula> (no discordance) to 100% (no shared branches).</p>
        <p><bold>Quartet dataset.</bold> We generated a new quartet dataset using the modified version of SimPhy. We created six different model conditions by changing the level of ILS (by varying population size) and varying rate heterogeneity multipliers. Our model conditions start from a strict molecular clock with no rate variation (i.e. <italic toggle="yes">Homogeneous</italic>) and becomes successively more complex. Next, we add rate variations across species tree branches only (<monospace>-hs</monospace> option), creating a model (<italic toggle="yes">Sp</italic>) akin to MSC + Substitution mentioned earlier. We then create models that have rate variation only across genes but not species (<italic toggle="yes">Loc</italic> using <monospace>-hl</monospace>) and both across species and across genes (<italic toggle="yes">Sp, Loc</italic> using <monospace>-hs -hl</monospace>). Finally, we add rate variations specific to each branch of each gene tree (<italic toggle="yes">Sp, Loc, Sp/Loc</italic>: <monospace>-hs -hl -hg</monospace>), which creates heterotachy; this most complex model is how Simphy is usually used (e.g. in the next datasets) and goes beyond our theoretical model. The first five conditions have an AD = 0.29, indicating a moderate level of ILS. The final condition increases the ILS level to 0.51 AD. Each model condition has 200 replicates, each with 10,000 true gene trees. We intentionally used a large number of true gene trees to verify our formulas and compare methods in an ideal situation. Further details and parameters are provided in <xref rid="sup1" ref-type="supplementary-material">Supplementary Tables S5 and S6</xref>.</p>
        <p><bold>S100 dataset.</bold> We used a 101-taxon simulated dataset from <xref rid="btad221-B38" ref-type="bibr">Zhang et al. (2018)</xref> (100 ingroup and one outgroup), that had model conditions characterized by different levels of GTEE, ranging from 0 (for true gene trees) to 0.55, measured in terms of the RF distance between true and estimated gene trees. The ILS level changes dramatically across replicates (average: 0.46 AD). The estimated gene trees were created using FastTree2 (<xref rid="btad221-B24" ref-type="bibr">Price et al. 2010</xref>). These datasets had 50 replicates, each with 1000 gene trees.</p>
        <p><bold>MVRoot dataset.</bold> We used a 30-taxon dataset from <xref rid="btad221-B15" ref-type="bibr">Mai et al. (2017)</xref> that had model conditions that varied in terms of deviation from the molecular clock and inclusion of an outgroup. Deviation from the clock was specified with the parameter <inline-formula id="IE109"><mml:math id="IM109" display="inline" overflow="scroll"><mml:mo>α</mml:mo></mml:math></inline-formula> of the gamma distribution, choosing 0.15 (<italic toggle="yes">High</italic> variation), 1.5 (<italic toggle="yes">Med</italic>), or 5 (<italic toggle="yes">Low</italic>). This dataset had 100 replicates with 500 gene trees (estimated using FastTree2) in each replicate. The replicates were highly heterogeneous in terms of ILS and GTEE level (average 0.46 AD and 0.38 GTEE across all model conditions).</p>
      </sec>
      <sec>
        <title>2.5.3 Methods compared</title>
        <p>We compare CASTLES to four other methods: concatenation using maximum likelihood, FastME (<xref rid="btad221-B10" ref-type="bibr">Lefort et al. 2015</xref>) on two different distance matrices, and ERaBLE (<xref rid="btad221-B1" ref-type="bibr">Binet et al. 2016</xref>):</p>
        <list list-type="bullet">
          <list-item>
            <p>Concatenation with maximum likelihood using RAxML (<xref rid="btad221-B31" ref-type="bibr">Stamatakis 2014</xref>) is perhaps the dominant method used in the literature, and estimates branch lengths on the given species trees assuming all the sites in the concatenated alignment evolve down a single model tree.</p>
          </list-item>
          <list-item>
            <p>FastME (<xref rid="btad221-B10" ref-type="bibr">Lefort et al. 2015</xref>) can estimate branch lengths using the balanced minimum evolution criterion given a distance matrix. We use it with two distance matrices. First, we compute the patristic (path-length) distance between pairs of taxa for each gene tree using Dendropy (<xref rid="btad221-B32" ref-type="bibr">Sukumaran and Holder 2010</xref>). Genes with no signal (all branch lengths zero) are excluded. We then take either the average or the minimum for each pair across genes. In the absence of rate heterogeneity, the minimum is appropriate and has been used in GLASS and its variants (<xref rid="btad221-B20" ref-type="bibr">Mossel and Roch 2010</xref>).</p>
          </list-item>
          <list-item>
            <p>ERaBLE (<xref rid="btad221-B1" ref-type="bibr">Binet et al. 2016</xref>) is specifically designed for branch-length estimation from a set of gene trees and is similar to FastME but uses weighted means.</p>
          </list-item>
        </list>
      </sec>
    </sec>
  </sec>
  <sec>
    <title>3 Results</title>
    <sec>
      <title>3.1 Quartet simulations</title>
      <p>When considering all conditions, CASTLES has the best accuracy overall (<xref rid="btad221-F2" ref-type="fig">Fig. 2a</xref>). Patristic(MIN) + FastME has the lowest error in conditions with no rate heterogeneity across loci. As soon as rate heterogeneity across loci is added (i.e. <italic toggle="yes">Loc</italic>), it goes from being the best method to being the worst. As expected, the error for all methods tends to increase as the models become more challenging (i.e. more rate variation or higher ILS). In the penultimate condition with default ILS and all sources of rate variation, CASTLES has substantially lower error than alternatives. When ILS is increased, we observe a huge increase in error for ERaBLE and Patristic(AVG) + FastME, but not for Patristic(MIN) + FastME. Since the mean absolute error emphasizes long branches more than short branches, we also examine RMSE and log error (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S11</xref>). The trends with these metrics are very similar to mean absolute error, except that with the log error (emphasizing short branches and long branches alike), Patristic(MIN) + FastME is far worse than the other methods in conditions with rate variation across loci.</p>
      <fig position="float" id="btad221-F2">
        <label>Figure 2.</label>
        <caption>
          <p>Quartet datasets: mean absolute error (a) and bias (b) of branch lengths estimated using different methods. From left to right, the conditions include more rate variation or higher ILS, creating more challenges for branch length estimation. (a) Mean and standard error across replicates in addition to boxplots. The <italic toggle="yes">y</italic>-axis is cut at 0.25, eliminating 16 outlier cases with unusually high errors (none from CASTLES). (b) Mean and standard deviation.</p>
        </caption>
        <graphic xlink:href="btad221f2" position="float"/>
      </fig>
      <p>Switching from accuracy to bias, we observe little or no bias for CASTLES for terminal branches in all conditions except at the highest ILS level (<xref rid="btad221-F2" ref-type="fig">Fig. 2b</xref> and <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S12</xref>). In contrast, ERaBLE and Patristic(AVG) + FastME, have a clear over-estimation bias for terminal branches, and Patristic(MIN) + FastME has a clear underestimation bias (for all branches), except in the absence of rate variation across genes (signified by <italic toggle="yes">Loc</italic>). Terminal branches seem particularly biased in the condition with the highest rate variation and the highest level of ILS. In this condition, while CASTLES does seem to have some bias for terminal branches, it is far less biased than alternative methods. Comparing the last two conditions, we observe that higher ILS has a larger impact on bias than rate variation. In contrast to terminal branches, for internal branches, ERaBLE and Patristic(AVG) + FastME also have low bias (slightly lower than CASTLES).</p>
    </sec>
    <sec>
      <title>3.2 101-taxon ILS simulations</title>
      <p>On this dataset, CASTLES has the best accuracy across all model conditions, followed by Patristic(AVG) + FastME and ERaBLE, which are very similar to each other (<xref rid="btad221-F3" ref-type="fig">Fig. 3b</xref>). Concat + RAxML has substantially higher errors than these three methods that use gene trees as input. However, Patristic(MIN) + FastME has the highest error in all conditions. These patterns remain largely similar, according to the RMSE and log error (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S14</xref>).</p>
      <fig position="float" id="btad221-F3">
        <label>Figure 3.</label>
        <caption>
          <p>101-taxon datasets: mean and standard error of mean absolute error (a) and mean and standard deviation of bias (b) of branch lengths estimated using different methods. The average GTEE level varies between 0% (for true gene trees) to 23% (for 1600 bp) and then to 55% (for the 200 bp sequences). The number of genes is 1000 and the results are shown across 50 replicates. The <italic toggle="yes">y</italic>-axis is cut at 0.045, eliminating ten outlier cases (none from CASTLES). (c) Running time (log scale), including distance matrix calculation and species tree annotation (by mean branch lengths) but not gene tree estimation; concatenation includes branch length estimation for fixed topology.</p>
        </caption>
        <graphic xlink:href="btad221f3" position="float"/>
      </fig>
      <p>CASTLES shows no substantial bias for terminal branches regardless of the level of gene tree error and a small bias for internal branches (<xref rid="btad221-F3" ref-type="fig">Fig. 3</xref> and <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S13</xref>). This bias is toward under-estimation for true gene trees and gradually moves toward over-estimation as gene tree error increases. In contrast to CASTLES, ERaBLE, Patristic(AVG) + FastME, and Concat + RAxML have a large over-estimation bias for terminal branches. ERaBLE and Patristic(AVG) + FastME have a negligible bias for internal branches. Concat + RAxML has the highest over-estimation bias and is the only method with a substantial over-estimation bias for internal branches. Patristic(MIN) + FastME has a large under-estimation bias. Similar to quartet simulations, all methods are less biased for internal branches than terminal ones. Comparing conditions, we observe that the level of gene tree error has a relatively small impact on under/overestimation for all the methods tested.</p>
      <p>On this relatively large dataset, we also examine running times and observe that CASTLES is substantially faster than alternatives (<xref rid="btad221-F3" ref-type="fig">Fig. 3c</xref>). Note that gene tree estimation running time is not included for methods based on gene trees because those are often inferred <italic toggle="yes">regardless</italic> of branch length estimation. Concat + RaxML becomes successively slower and uses more memory (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S15</xref>) as the genes become longer. In the most extreme case, CASTLES can be more than an order of magnitude faster than Concat + RAxML.</p>
    </sec>
    <sec>
      <title>3.3 30-taxon MVRoot simulations</title>
      <p>On the 30-taxon MVRoot datasets, we further evaluate the impact of outgroups, deviation from the clock, and ILS level (<xref rid="btad221-F4" ref-type="fig">Fig. 4</xref>). Whether an outgroup is included and independent of deviation from the clock, CASTLES has the lowest error (<xref rid="btad221-F4" ref-type="fig">Fig. 4a</xref>). On these datasets, CASTLES has no discernible bias, ERaBLE, Patristic(AVG) + FastME and Concat + RAxML have a bias toward over-estimation (see an example replicate in <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S19a</xref>), and Patristic(MIN) + FastME has a more severe bias toward under-estimation; outgroup inclusion and deviation from the clock impact the bias of methods only marginally (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S16</xref>). For all methods, including an outgroup leads to an increase in the mean absolute error (<xref rid="btad221-F4" ref-type="fig">Fig. 4a</xref>). Increasing deviation from the clock does not substantially impact the accuracy of CASTLES or other methods (<xref rid="btad221-F4" ref-type="fig">Fig. 4</xref> and <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S16</xref>).</p>
      <fig position="float" id="btad221-F4">
        <label>Figure 4.</label>
        <caption>
          <p>30-taxon MVRoot dataset. (a) Mean absolute error of estimated branch lengths on the 30-taxon MVRoot dataset, with or without an outgroup and with different levels of deviation from a strict clock. The number of genes is 500 and the results are shown across 100 replicates; the <italic toggle="yes">y</italic>-axis is cut at 0.11, leaving 16 outliers out of the graph (one from CASTLES). (b) Focusing on cases without outgroups, we divide replicates based on their level of true gene tree discordance due to ILS into four groups. We show mean log error to control for the correlation between ILS and branch length. Patristic(MIN) + FastME has mean log error above 2 (see <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S18</xref>) and is excluded.</p>
        </caption>
        <graphic xlink:href="btad221f4" position="float"/>
      </fig>
      <p>To compare across levels of ILS, we resort to the logarithmic error because true branch lengths correlate with ILS (i.e. are shorter for higher ILS), and hence, the absolute error confuses the interpretation of the impact of ILS. Across all ILS levels (<xref rid="btad221-F4" ref-type="fig">Fig. 4b</xref>), Patristic(MIN) + FastME has very poor performance in terms of log error and is not further discussed below. With the lowest ILS, CASTLES and Concat + RAxML have very similar performance. As ILS increases, all methods become less accurate, but CASTLES degrades in accuracy <italic toggle="yes">slower</italic> than the rest of the methods and hence dominates the other methods for accuracy, with ERaBLE in second place. Concat + RAxML matches CASTLES for the lowest ILS but gradually moves to be the second least accurate of all methods (only better than Patristic(MIN) + FastME) at the highest ILS level. In fact, Concat + RAxML is substantially more sensitive to ILS (<inline-formula id="IE110"><mml:math id="IM110" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>=</mml:mo><mml:mn>0.57</mml:mn></mml:mrow></mml:math></inline-formula> Pearson correlation with AD; <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S17</xref>) than CASTLES (<inline-formula id="IE111"><mml:math id="IM111" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>=</mml:mo><mml:mn>0.23</mml:mn></mml:mrow></mml:math></inline-formula>). Comparing the relative accuracy of methods as ILS changes using the mean absolute error shows similar trends (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S18</xref>) with one notable difference: Concat + RAxML is <italic toggle="yes">better</italic> than CASTLES at the lowest ILS level but is worse in other conditions (just as with the log error).</p>
    </sec>
    <sec>
      <title>3.4 Mammalian biological dataset</title>
      <p>We apply CASTLES and Concat + RAxML on the 37-taxon mammalian dataset of <xref rid="btad221-B30" ref-type="bibr">Song et al. (2012)</xref> (perhaps the first paper that used concatenation to estimate branch lengths on a species tree estimated using a summary method) after removing 23 mislabeled gene trees, retaining 424 genes (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S19b</xref>). We observe patterns similar to the simulated dataset. Branch lengths tend to be longer using Concat + RAxML than using CASTLES (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S20</xref>). For example, primates are roughly twice as distant from the root of placental mammals in the Concat + RAxML tree as they are in the CASTLES tree. While the two trees are similar in their longest branches and have similar diameters (i.e. from rat to platypus), many of the other internal branches are substantially shorter in CASTLES. While the truth is not known on real data, we note that a similar pattern is observed in simulations, and in simulations, Concat + RAxML is biased toward over-estimation; in contrast, CASTLES is far less biased (e.g. <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S19a</xref>).</p>
    </sec>
  </sec>
  <sec>
    <title>4 Discussion</title>
    <p>Although CASTLES was almost universally more accurate than the competing methods, comparisons across the experiments revealed some interesting trends. Concatenation performed well on low ILS cases and much worse with high ILS, as expected. Increasing ILS did increase error for all methods but also note that more ILS in our simulation is often (though not always) accompanied by shorter branch lengths, which are in general harder to estimate (<xref rid="sup1" ref-type="supplementary-material">Supplementary Figs S12 and S13</xref>). However, the fact that concatenation degraded in accuracy faster than other methods as ILS increased confirmed that it is less able to deal with gene tree discordance. Thus, the current standard method (concatenation) does suffer from a predictable shortcoming. CASTLES is meant to address that shortcoming.</p>
    <p>We observed that estimating terminal branches was harder than internal branches across all datasets for all methods other than CASTLES. As we expected, methods that ignore coalescent (e.g. concatenation and FastME based on <italic toggle="yes">average</italic> patristic distance) had a consistent overestimation bias. What was surprising was that this overestimation showed its effects more on terminal branches than internal branches. The reasons for this clear trend are not clear to us.</p>
    <p>Another consistent pattern was that including an outgroup reduced accuracy for all methods and especially for CASTLES. Outgroups are often connected via long branches and have been found problematic for phylogenetic inference and downstream analyses (<xref rid="btad221-B11" ref-type="bibr">Li et al. 2012</xref>). Our results suggest that they can also confound SU branch length estimation. While not surprising, this pattern suggests that unless the outgroup is needed for a downstream analysis, the outgroups should be removed after rooting the species tree and before estimating branch length.</p>
    <p>We surprisingly saw little impact caused by GTEE and deviation from a clock. The robustness to deviation from the strict clock can perhaps be explained by the fact that none of the methods used here other than Patristic(MIN) + FastME assume a clock. Note that in CASTLES, even with our simplifying assumptions, each branch is at the end assigned a different mutation rate (the calculation of which assumes surrounding branches have the same rate). The lack of sensitivity to per-gene signal (controlled here by sequence length) is more surprising, especially for the coalescent-based CASTLES. One possibility is that while short sequences can affect the estimated gene tree topologies, they have a more subdued effect on distances within gene trees (<xref rid="btad221-B19" ref-type="bibr">Moshiri and Mirarab 2018</xref>); thus, even given short sequences, estimated branch lengths (which change in a continuous space) are broadly consistent with true values, especially when averaged over genes. In contrast, CU branch lengths are sensitive to gene tree error, but these are not used in CASTLES.</p>
    <p>Our theory did not explicitly discuss rate heterogeneity across genes. However, across-gene rate changes do not impact our calculations under reasonable models of rate variation. Assume that each gene tree is scaled up or down by a constant factor drawn i.i.d. from some rate multiplier distribution with expected value one and independently from the MSC process. Under any such model, all the derived expected values remain intact and hence the method remains valid. It is easy to see the same is not true for GLASS-like distances that involve taking the minimum across genes: they only work if all the genes have equal rates. When rates of evolution of genes are allowed to vary, as the number of genes goes to infinity, all estimated branch lengths go to zero; a pattern that would imply under-estimation bias, as we observed in our data. More broadly, if rate changes are not i.i.d and correlate with other factors such as missing data, accounting for them becomes far more difficult.</p>
    <p>Finally, we note that the estimation of terminal branches in CASTLES is sensitive to rooting of the species tree; hence, care must be applied in rooting the species tree before running CASTLES. When an outgroup is not available, the species tree root is identifiable under the MSC and can be inferred using QR-STAR (<xref rid="btad221-B33" ref-type="bibr">Tabatabaee et al. 2022a</xref>,<xref rid="btad221-B34" ref-type="bibr">b</xref>) in a statistically consistent manner. Alternative methods such as tripVote (<xref rid="btad221-B14" ref-type="bibr">Mai and Mirarab 2022</xref>) or methods that assume a strict molecular clock (e.g. midpoint rooting) are also available, though they do not enjoy the same theoretical guarantees.</p>
  </sec>
  <sec>
    <title>5 Conclusion</title>
    <p>We proposed CASTLES, a method for estimating branch lengths of a given species tree using gene tree branch lengths. CASTLES uses derivations made under the MSC model to design a set of coalescent-based equations that correct for the fact that under the MSC, gene trees can be substantially longer than the species tree. Our study provided evidence that CASTLES produces highly accurate branch lengths in substitution units (SUs), improving on prior methods under a wide range of model conditions.</p>
    <p>There are several directions for future work. For example, the derivation of CASTLES assumed that the input gene trees differed from the species tree due to ILS alone. This work could be extended to the case where genes evolve within the species tree due to gene duplication and loss as well as ILS. Developing methods for branch length estimation in that context could be potentially enabled through the DISCO (<xref rid="btad221-B36" ref-type="bibr">Willson et al. 2022</xref>) technique, which replaces every gene family tree by a set of single-copy gene trees, which could then be passed to CASTLES for branch length estimation on the given species tree. A related question left for future work is whether CASTLES is robust to the presence of horizontal transfer or gene flow. Finally, the behavior of the method should be tested when inputs have low taxon occupancy across genes.</p>
    <p>Another question of interest is whether CASTLES is a statistically consistent estimator of SU branch lengths. Given that CASTLES is coalescent-based and that we use expected values under the model, we consider this likely, but two technical challenges need to be addressed. First, for the method to be consistent, we need the model to be identifiable, and we did not establish identifiability in this article. Thus, we ask: Is it possible to design different sets of mutation rates and CU lengths that lead to the same patterns of gene tree distribution? If not, are the expected values enough to uniquely identify branch lengths or are higher moments necessary? Moreover, while we had a system of equations that could be optimized directly, we opted for a more stable approach that had several simplifications. It is possible (and perhaps likely) that those simplifications could result in inconsistent branch length estimation. These questions will need to be addressed in future work, and may require that we explore a more complex estimation scheme that does not rely on simplifications.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material id="sup1" position="float" content-type="local-data">
      <label>btad221_Supplementary_Data</label>
      <media xlink:href="btad221_supplementary_data.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
</body>
<back>
  <sec>
    <title>Supplementary data</title>
    <p><xref rid="sup1" ref-type="supplementary-material">Supplementary data</xref> are available at <italic toggle="yes">Bioinformatics</italic> online.</p>
  </sec>
  <sec sec-type="COI-statement">
    <title>Conflict of interest</title>
    <p>None declared.</p>
  </sec>
  <sec>
    <title>Funding</title>
    <p>This work was supported in part by funds from the National Science Foundation (NSF: 1845967, 1636933, and 1920920) and by the National Institute of Health (1R35GM142725).</p>
  </sec>
  <sec sec-type="data-availability">
    <title>Data availability</title>
    <p>The code, datasets, and scripts used in this study are available at <ext-link xlink:href="https://github.com/ytabatabaee/CASTLES" ext-link-type="uri">https://github.com/ytabatabaee/CASTLES</ext-link>.</p>
  </sec>
  <ref-list id="ref1">
    <title>References</title>
    <ref id="btad221-B1">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Binet</surname><given-names>M</given-names></string-name>, <string-name><surname>Gascuel</surname><given-names>O</given-names></string-name>, <string-name><surname>Scornavacca</surname><given-names>C</given-names></string-name></person-group><etal>et al</etal><article-title>Fast and accurate branch lengths estimation for phylogenomic trees</article-title>. <source>BMC Bioinformatics</source><year>2016</year>;<volume>17</volume>:<fpage>23</fpage>.<pub-id pub-id-type="pmid">26744021</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B2">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Bromham</surname><given-names>L</given-names></string-name>, <string-name><surname>Penny</surname><given-names>D.</given-names></string-name></person-group><article-title>The modern molecular clock</article-title>. <source>Nat Rev Genet</source><year>2003</year>;<volume>4</volume>:<fpage>216</fpage>–<lpage>24</lpage>.<pub-id pub-id-type="pmid">12610526</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B3">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Faith</surname><given-names>DP.</given-names></string-name></person-group><article-title>Quantifying biodiversity: a phylogenetic perspective</article-title>. <source>Conserv Biol</source><year>2002</year>;<volume>16</volume>:<fpage>248</fpage>–<lpage>52</lpage>.<pub-id pub-id-type="pmid">35701968</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B4">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Felsenstein</surname><given-names>J.</given-names></string-name></person-group><article-title>Phylogenies and the comparative method</article-title>. <source>Am Nat</source><year>1985</year>;<volume>125</volume>:<fpage>1</fpage>–<lpage>147</lpage>.</mixed-citation>
    </ref>
    <ref id="btad221-B5">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Hahn</surname><given-names>MW</given-names></string-name>, <string-name><surname>De Bie</surname><given-names>T</given-names></string-name>, <string-name><surname>Stajich</surname><given-names>JE</given-names></string-name></person-group><etal>et al</etal><article-title>Estimating the tempo and mode of gene family evolution from comparative genomic data</article-title>. <source>Genome Res</source><year>2005</year>;<volume>15</volume>:<fpage>1153</fpage>–<lpage>60</lpage>.<pub-id pub-id-type="pmid">16077014</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B6">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Kosakovsky Pond</surname><given-names>SL</given-names></string-name>, <string-name><surname>Frost</surname><given-names>SDW.</given-names></string-name></person-group><article-title>Not so different after all: a comparison of methods for detecting amino acid sites under selection</article-title>. <source>Mol Biol Evol</source><year>2005</year>;<volume>22</volume>:<fpage>1208</fpage>–<lpage>22</lpage>.<pub-id pub-id-type="pmid">15703242</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B7">
      <mixed-citation publication-type="book"><person-group person-group-type="editor"><string-name><surname>Kubatko</surname><given-names>L</given-names></string-name>, <string-name><surname>Knowles</surname><given-names>LL</given-names></string-name></person-group> (eds). <source>Species Tree Inference: A Guide to Methods and Applications</source>. Princeton NJ: <publisher-name>Princeton University Press</publisher-name>, <year>2023</year>.</mixed-citation>
    </ref>
    <ref id="btad221-B8">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Kumar</surname><given-names>S.</given-names></string-name></person-group><article-title>Molecular clocks: four decades of evolution</article-title>. <source>Nat Rev Genet</source><year>2005</year>;<volume>6</volume>:<fpage>654</fpage>–<lpage>62</lpage>.<pub-id pub-id-type="pmid">16136655</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B9">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Lanfear</surname><given-names>R</given-names></string-name>, <string-name><surname>Welch</surname><given-names>JJ</given-names></string-name>, <string-name><surname>Bromham</surname><given-names>L.</given-names></string-name></person-group><article-title>Watching the clock: studying variation in rates of molecular evolution between species</article-title>. <source>Trends Ecol Evol</source><year>2010</year>;<volume>25</volume>:<fpage>495</fpage>–<lpage>503</lpage>.<pub-id pub-id-type="pmid">20655615</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B10">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Lefort</surname><given-names>V</given-names></string-name>, <string-name><surname>Desper</surname><given-names>R</given-names></string-name>, <string-name><surname>Gascuel</surname><given-names>O.</given-names></string-name></person-group><article-title>FastME 2.0: a comprehensive, accurate, and fast distance-based phylogeny inference program</article-title>. <source>Mol Biol Evol</source><year>2015</year>;<volume>32</volume>:<fpage>2798</fpage>–<lpage>800</lpage>.<pub-id pub-id-type="pmid">26130081</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B11">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Li</surname><given-names>C</given-names></string-name>, <string-name><surname>Matthes-Rosana</surname><given-names>KA</given-names></string-name>, <string-name><surname>Garcia</surname><given-names>M</given-names></string-name></person-group><etal>et al</etal><article-title>Phylogenetics of chondrichthyes and the problem of rooting phylogenies with distant outgroups</article-title>. <source>Mol Phylogenet Evol</source><year>2012</year>;<volume>63</volume>:<fpage>365</fpage>–<lpage>73</lpage>.<pub-id pub-id-type="pmid">22300842</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B12">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Liu</surname><given-names>L</given-names></string-name>, <string-name><surname>Yu</surname><given-names>L</given-names></string-name>, <string-name><surname>Edwards</surname><given-names>SV.</given-names></string-name></person-group><article-title>A maximum pseudo-likelihood approach for estimating species trees under the coalescent model</article-title>. <source>BMC Evol Biol</source><year>2010</year>;<volume>10</volume>:<fpage>302</fpage>.<pub-id pub-id-type="pmid">20937096</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B13">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Lozupone</surname><given-names>C</given-names></string-name>, <string-name><surname>Knight</surname><given-names>R.</given-names></string-name></person-group><article-title>UniFrac : a new phylogenetic method for comparing microbial communities</article-title>. <source>Appl Environ Microbiol</source><year>2005</year>;<volume>71</volume>:<fpage>8228</fpage>–<lpage>35</lpage>.<pub-id pub-id-type="pmid">16332807</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B14">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Mai</surname><given-names>U</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S.</given-names></string-name></person-group><article-title>Completing gene trees without species trees in sub-quadratic time</article-title>. <source>Bioinformatics</source><year>2022</year>;<volume>38</volume>:<fpage>1532</fpage>–<lpage>41</lpage>.<pub-id pub-id-type="pmid">34978565</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B15">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Mai</surname><given-names>U</given-names></string-name>, <string-name><surname>Sayyari</surname><given-names>E</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S.</given-names></string-name></person-group><article-title>Minimum variance rooting of phylogenetic trees and implications for species tree reconstruction</article-title>. <source>PLoS One</source><year>2017</year>;<volume>12</volume>:<fpage>e0182238</fpage>.<pub-id pub-id-type="pmid">28800608</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B16">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Mallo</surname><given-names>D</given-names></string-name>, <string-name><surname>De Oliveira Martins</surname><given-names>L</given-names></string-name>, <string-name><surname>Posada</surname><given-names>D.</given-names></string-name></person-group><article-title>SimPhy : phylogenomic simulation of gene, locus, and species trees</article-title>. <source>Syst Biol</source><year>2016</year>;<volume>65</volume>:<fpage>334</fpage>–<lpage>44</lpage>.<pub-id pub-id-type="pmid">26526427</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B17">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Mirarab</surname><given-names>S</given-names></string-name>, <string-name><surname>Reaz</surname><given-names>R</given-names></string-name>, <string-name><surname>Bayzid</surname><given-names>MS</given-names></string-name></person-group><etal>et al</etal><article-title>ASTRAL: genome-scale coalescent-based species tree estimation</article-title>. <source>Bioinformatics</source><year>2014</year>;<volume>30</volume>:<fpage>i541</fpage>–<lpage>8</lpage>.<pub-id pub-id-type="pmid">25161245</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B18">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Moody</surname><given-names>ER</given-names></string-name>, <string-name><surname>Mahendrarajah</surname><given-names>TA</given-names></string-name>, <string-name><surname>Dombrowski</surname><given-names>N</given-names></string-name></person-group><etal>et al</etal><article-title>An estimate of the deepest branches of the tree of life from ancient vertically evolving genes</article-title>. <source>eLife</source><year>2022</year>;<volume>11</volume>:<fpage>e66695</fpage>.<pub-id pub-id-type="pmid">35190025</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B19">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Moshiri</surname><given-names>N</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S.</given-names></string-name></person-group><article-title>A two-state model of tree evolution and its applications to Alu retrotransposition</article-title>. <source>Syst Biol</source><year>2018</year>;<volume>67</volume>:<fpage>475</fpage>–<lpage>89</lpage>.<pub-id pub-id-type="pmid">29165679</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B20">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Mossel</surname><given-names>E</given-names></string-name>, <string-name><surname>Roch</surname><given-names>S.</given-names></string-name></person-group><article-title>Incomplete lineage sorting: consistent phylogeny estimation from multiple loci</article-title>. <source>IEEE/ACM Trans Comput Biol Bioinform</source><year>2010</year>;<volume>7</volume>:<fpage>166</fpage>–<lpage>71</lpage>.<pub-id pub-id-type="pmid">20150678</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B21">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Ogilvie</surname><given-names>HA</given-names></string-name>, <string-name><surname>Bouckaert</surname><given-names>RR</given-names></string-name>, <string-name><surname>Drummond</surname><given-names>AJ.</given-names></string-name></person-group><article-title>StarBEAST2 brings faster species tree inference and accurate estimates of substitution rates</article-title>. <source>Mol Biol Evol</source><year>2017</year>;<volume>34</volume>:<fpage>2101</fpage>–<lpage>14</lpage>.<pub-id pub-id-type="pmid">28431121</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B22">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>O’Meara</surname><given-names>BC.</given-names></string-name></person-group><article-title>Evolutionary inferences from phylogenies: a review of methods</article-title>. <source>Ann Rev Ecol Evol Syst</source><year>2012</year>;<volume>43</volume>:<fpage>267</fpage>–<lpage>85</lpage>.</mixed-citation>
    </ref>
    <ref id="btad221-B23">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Pamilo</surname><given-names>P</given-names></string-name>, <string-name><surname>Nei</surname><given-names>M.</given-names></string-name></person-group><article-title>Relationships between gene trees and species trees</article-title>. <source>Mol Biol Evol</source><year>1988</year>;<volume>5</volume>:<fpage>568</fpage>–<lpage>83</lpage>.<pub-id pub-id-type="pmid">3193878</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B24">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Price</surname><given-names>MN</given-names></string-name>, <string-name><surname>Dehal</surname><given-names>PS</given-names></string-name>, <string-name><surname>Arkin</surname><given-names>AP.</given-names></string-name></person-group><article-title>FastTree-2—approximately maximum-likelihood trees for large alignments</article-title>. <source>PLoS One</source><year>2010</year>;<volume>5</volume>:<fpage>e9490</fpage>.<pub-id pub-id-type="pmid">20224823</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B25">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Rannala</surname><given-names>B.</given-names></string-name></person-group><article-title>The art and science of species delimitation</article-title>. <source>Curr Zool</source><year>2015</year>;<volume>61</volume>:<fpage>846</fpage>–<lpage>53</lpage>.</mixed-citation>
    </ref>
    <ref id="btad221-B26">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Robinson</surname><given-names>D</given-names></string-name>, <string-name><surname>Foulds</surname><given-names>L.</given-names></string-name></person-group><article-title>Comparison of phylogenetic trees</article-title>. <source>Math Biosci</source><year>1981</year>;<volume>53</volume>:<fpage>131</fpage>–<lpage>47</lpage>.</mixed-citation>
    </ref>
    <ref id="btad221-B27">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Roch</surname><given-names>S</given-names></string-name>, <string-name><surname>Steel</surname><given-names>M.</given-names></string-name></person-group><article-title>Likelihood-based tree reconstruction on a concatenation of aligned sequence data sets can be statistically inconsistent</article-title>. <source>Theor Popul Biol</source><year>2015</year>;<volume>100</volume>:<fpage>56</fpage>–<lpage>62</lpage>.</mixed-citation>
    </ref>
    <ref id="btad221-B28">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Rokas</surname><given-names>A</given-names></string-name>, <string-name><surname>Williams</surname><given-names>BL</given-names></string-name>, <string-name><surname>King</surname><given-names>N</given-names></string-name></person-group><etal>et al</etal><article-title>Genome-scale approaches to resolving incongruence in molecular phylogenies</article-title>. <source>Nature</source><year>2003</year>;<volume>425</volume>:<fpage>798</fpage>–<lpage>804</lpage>.<pub-id pub-id-type="pmid">14574403</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B29">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Sayyari</surname><given-names>E</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S.</given-names></string-name></person-group><article-title>Fast coalescent-based computation of local branch support from quartet frequencies</article-title>. <source>Mol Biol Evol</source><year>2016</year>;<volume>33</volume>:<fpage>1654</fpage>–<lpage>68</lpage>.<pub-id pub-id-type="pmid">27189547</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B30">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Song</surname><given-names>S</given-names></string-name>, <string-name><surname>Liu</surname><given-names>L</given-names></string-name>, <string-name><surname>Edwards</surname><given-names>SV</given-names></string-name></person-group><etal>et al</etal><article-title>Resolving conflict in eutherian mammal phylogeny using phylogenomics and the multispecies coalescent model</article-title>. <source>Proc Natl Acad Sci USA</source><year>2012</year>;<volume>109</volume>:<fpage>14942</fpage>–<lpage>7</lpage>.<pub-id pub-id-type="pmid">22930817</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B31">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Stamatakis</surname><given-names>A.</given-names></string-name></person-group><article-title>RAxML version 8: a tool for phylogenetic analysis and post-analysis of large phylogenies</article-title>. <source>Bioinformatics</source><year>2014</year>;<volume>30</volume>:<fpage>1312</fpage>–<lpage>3</lpage>.<pub-id pub-id-type="pmid">24451623</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B32">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Sukumaran</surname><given-names>J</given-names></string-name>, <string-name><surname>Holder</surname><given-names>MT.</given-names></string-name></person-group><article-title>DendroPy: a Python library for phylogenetic computing</article-title>. <source>Bioinformatics</source><year>2010</year>;<volume>26</volume>:<fpage>1569</fpage>–<lpage>71</lpage>.<pub-id pub-id-type="pmid">20421198</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B33">
      <mixed-citation publication-type="other"><person-group person-group-type="author"><string-name><surname>Tabatabaee</surname><given-names>Y</given-names></string-name>, <string-name><surname>Roch</surname><given-names>S</given-names></string-name>, <string-name><surname>Warnow</surname><given-names>T.</given-names></string-name></person-group> Statistically consistent rooting of species trees under the multispecies coalescent model. In: Tang, H. (eds) <italic toggle="yes">Research in Computational Molecular Biology. RECOMB 2023. Lecture Notes in Computer Science()</italic>, Vol. 13976. Cham: Springer. <pub-id pub-id-type="doi">10.1007/978-3-031-29119-7_3</pub-id>.</mixed-citation>
    </ref>
    <ref id="btad221-B34">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Tabatabaee</surname><given-names>Y</given-names></string-name>, <string-name><surname>Sarker</surname><given-names>K</given-names></string-name>, <string-name><surname>Warnow</surname><given-names>T.</given-names></string-name></person-group><article-title>Quintet rooting: rooting species trees under the multi-species coalescent model</article-title>. <source>Bioinformatics</source><year>2022b</year>;<volume>38</volume>:<fpage>i109</fpage>–<lpage>17</lpage>.<pub-id pub-id-type="pmid">35758805</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B35">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Volz</surname><given-names>EM</given-names></string-name>, <string-name><surname>Koelle</surname><given-names>K</given-names></string-name>, <string-name><surname>Bedford</surname><given-names>T.</given-names></string-name></person-group><article-title>Viral phylodynamics</article-title>. <source>PLoS Comput Biol</source><year>2013</year>;<volume>9</volume>:<fpage>e1002947</fpage>.<pub-id pub-id-type="pmid">23555203</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B36">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Willson</surname><given-names>J</given-names></string-name>, <string-name><surname>Roddur</surname><given-names>MS</given-names></string-name>, <string-name><surname>Liu</surname><given-names>B</given-names></string-name></person-group><etal>et al</etal><article-title>DISCO: species tree inference using multicopy gene family tree decomposition</article-title>. <source>Syst Biol</source><year>2022</year>;<volume>71</volume>:<fpage>610</fpage>–<lpage>29</lpage>.<pub-id pub-id-type="pmid">34450658</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B37">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Zhang</surname><given-names>C</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S.</given-names></string-name></person-group><article-title>Weighting by gene tree uncertainty improves accuracy of quartet-based species trees</article-title>. <source>Mol Biol Evol</source><year>2022</year>;<volume>39</volume>:<fpage>msac215</fpage>.<pub-id pub-id-type="pmid">36201617</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B38">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Zhang</surname><given-names>C</given-names></string-name>, <string-name><surname>Rabiee</surname><given-names>M</given-names></string-name>, <string-name><surname>Sayyari</surname><given-names>E</given-names></string-name></person-group><etal>et al</etal><article-title>ASTRAL-III: polynomial time species tree reconstruction from partially resolved gene trees</article-title>. <source>BMC Bioinformatics</source><year>2018</year>;<volume>19</volume>:<fpage>153</fpage>.<pub-id pub-id-type="pmid">29745866</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B39">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Zhu</surname><given-names>Q</given-names></string-name>, <string-name><surname>Mai</surname><given-names>U</given-names></string-name>, <string-name><surname>Pfeiffer</surname><given-names>W</given-names></string-name></person-group><etal>et al</etal><article-title>Phylogenomics of 10,575 genomes reveals evolutionary proximity between domains bacteria and archaea</article-title>. <source>Nat Commun</source><year>2019</year>;<volume>10</volume>:<fpage>5477</fpage>.<pub-id pub-id-type="pmid">31792218</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B40">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Zimmermann</surname><given-names>T</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S</given-names></string-name>, <string-name><surname>Warnow</surname><given-names>T.</given-names></string-name></person-group><article-title>BBCA: improving the scalability of *BEAST using random binning</article-title>. <source>BMC Genomics</source><year>2014</year>;<volume>15</volume>:<fpage>1</fpage>–<lpage>9</lpage>.<pub-id pub-id-type="pmid">24382143</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.2 20190208//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.2?>
<?ConverterInfo.XSLTName jats2jats3.xsl?>
<?ConverterInfo.Version 1?>
<?properties open_access?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">Bioinformatics</journal-id>
    <journal-id journal-id-type="publisher-id">bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1367-4803</issn>
    <issn pub-type="epub">1367-4811</issn>
    <publisher>
      <publisher-name>Oxford University Press</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10311336</article-id>
    <article-id pub-id-type="pmid">37387151</article-id>
    <article-id pub-id-type="doi">10.1093/bioinformatics/btad221</article-id>
    <article-id pub-id-type="publisher-id">btad221</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Evolutionary, Comparative and Population Genomics</subject>
      </subj-group>
      <subj-group subj-group-type="category-taxonomy-collection">
        <subject>AcademicSubjects/SCI01060</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Phylogenomic branch length estimation using quartets</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Tabatabaee</surname>
          <given-names>Yasamin</given-names>
        </name>
        <aff><institution>Department of Computer Science, University of Illinois at Urbana-Champaign</institution>, Urbana, IL 61801, <country country="US">United States</country></aff>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Zhang</surname>
          <given-names>Chao</given-names>
        </name>
        <aff><institution>Department of Integrative Biology, University of California at Berkeley</institution>, Berkeley, CA 94720, <country country="US">United States</country></aff>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Warnow</surname>
          <given-names>Tandy</given-names>
        </name>
        <aff><institution>Department of Computer Science, University of Illinois at Urbana-Champaign</institution>, Urbana, IL 61801, <country country="US">United States</country></aff>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid" authenticated="false">https://orcid.org/0000-0001-5410-1518</contrib-id>
        <name>
          <surname>Mirarab</surname>
          <given-names>Siavash</given-names>
        </name>
        <aff><institution>Department of Electrical and Computer Engineering, University of California, San Diego</institution>, La Jolla, CA 92093, <country country="US">United States</country></aff>
        <!--smirarab@ucsd.edu-->
        <xref rid="btad221-cor1" ref-type="corresp"/>
      </contrib>
    </contrib-group>
    <author-notes>
      <corresp id="btad221-cor1">Corresponding author. Department of Electrical and Computer Engineering, University of California, San Diego, 9500 Gilman Drive, La Jolla, CA 92093, United States. E-mail: <email>smirarab@ucsd.edu</email></corresp>
    </author-notes>
    <pub-date pub-type="collection">
      <month>6</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="epub" iso-8601-date="2023-06-30">
      <day>30</day>
      <month>6</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>30</day>
      <month>6</month>
      <year>2023</year>
    </pub-date>
    <volume>39</volume>
    <issue>Suppl 1</issue>
    <issue-title>ISMB/ECCB 2023 Proceedings</issue-title>
    <fpage>i185</fpage>
    <lpage>i193</lpage>
    <permissions>
      <copyright-statement>© The Author(s) 2023. Published by Oxford University Press.</copyright-statement>
      <copyright-year>2023</copyright-year>
      <license>
        <ali:license_ref xmlns:ali="http://www.niso.org/schemas/ali/1.0/" specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted reuse, distribution, and reproduction in any medium, provided the original work is properly cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="btad221.pdf"/>
    <abstract>
      <title>Abstract</title>
      <sec id="s1">
        <title>Motivation</title>
        <p>Branch lengths and topology of a species tree are essential in most downstream analyses, including estimation of diversification dates, characterization of selection, understanding adaptation, and comparative genomics. Modern phylogenomic analyses often use methods that account for the heterogeneity of evolutionary histories across the genome due to processes such as incomplete lineage sorting. However, these methods typically do not generate branch lengths in units that are usable by downstream applications, forcing phylogenomic analyses to resort to alternative shortcuts such as estimating branch lengths by concatenating gene alignments into a supermatrix. Yet, concatenation and other available approaches for estimating branch lengths fail to address heterogeneity across the genome.</p>
      </sec>
      <sec id="s2">
        <title>Results</title>
        <p>In this article, we derive expected values of gene tree branch lengths in substitution units under an extension of the multispecies coalescent (MSC) model that allows substitutions with varying rates across the species tree. We present CASTLES, a new technique for estimating branch lengths on the species tree from estimated gene trees that uses these expected values, and our study shows that CASTLES improves on the most accurate prior methods with respect to both speed and accuracy.</p>
      </sec>
      <sec id="s3">
        <title>Availability and implementation</title>
        <p>CASTLES is available at <ext-link xlink:href="https://github.com/ytabatabaee/CASTLES" ext-link-type="uri">https://github.com/ytabatabaee/CASTLES</ext-link>.</p>
      </sec>
    </abstract>
    <funding-group>
      <award-group award-type="grant">
        <funding-source>
          <institution-wrap>
            <institution>National Science Foundation</institution>
            <institution-id institution-id-type="DOI">10.13039/100000001</institution-id>
          </institution-wrap>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <institution-wrap>
            <institution>NSF</institution>
            <institution-id institution-id-type="DOI">10.13039/100000001</institution-id>
          </institution-wrap>
        </funding-source>
        <award-id>1845967</award-id>
        <award-id>1636933</award-id>
        <award-id>1920920</award-id>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <institution-wrap>
            <institution>National Institute of Health</institution>
          </institution-wrap>
        </funding-source>
        <award-id>1R35GM142725</award-id>
      </award-group>
    </funding-group>
    <counts>
      <page-count count="9"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec>
    <title>1 Introduction</title>
    <p>Species trees, both their topologies and their branch lengths, are necessary for downstream biological research. For example, branch lengths are required for comparative genomics (<xref rid="btad221-B5" ref-type="bibr">Hahn et al. 2005</xref>) and comparative trait analysis (<xref rid="btad221-B4" ref-type="bibr">Felsenstein 1985</xref>; <xref rid="btad221-B22" ref-type="bibr">O’Meara 2012</xref>), phylodynamics of disease transmission (<xref rid="btad221-B35" ref-type="bibr">Volz et al. 2013</xref>), species delimitation (<xref rid="btad221-B25" ref-type="bibr">Rannala 2015</xref>), measuring phylogenetic diversity (<xref rid="btad221-B3" ref-type="bibr">Faith 2002</xref>; <xref rid="btad221-B13" ref-type="bibr">Lozupone and Knight 2005</xref>), and detecting and characterizing selection (<xref rid="btad221-B6" ref-type="bibr">Kosakovsky Pond and Frost 2005</xref>). Many of these analyses amount to studying changes in the rate of evolution across the tree (<xref rid="btad221-B9" ref-type="bibr">Lanfear et al. 2010</xref>). Most statistical methods designed for these applications rely on branch lengths measured in the unit of the expected number of substitutions per site (SU), readily available from tree inference based on sequence data, or unit of time, or both.</p>
    <p>The traditional approach to the estimation of species trees and branch lengths has been concatenating gene alignments followed by a tree-building method, such as maximum likelihood (<xref rid="btad221-B28" ref-type="bibr">Rokas et al. 2003</xref>). It is now understood (<xref rid="btad221-B27" ref-type="bibr">Roch and Steel 2015</xref>) that this concatenation approach can be positively misleading (i.e. converge to the wrong tree as the number of genes increases) in the face of sufficient gene tree heterogeneity across the genome due to incomplete lineage sorting (ILS), as modeled by the multispecies coalescent (MSC) model (<xref rid="btad221-B23" ref-type="bibr">Pamilo and Nei 1988</xref>). Alternative approaches for estimating species trees have been developed that are statistically consistent under the MSC (see <xref rid="btad221-B7" ref-type="bibr">Kubatko and Knowles 2023</xref>). In particular, methods that combine a set of gene trees to infer a species tree (referred to as “summary methods”) are widely used because of their scalability and accuracy (and notably better accuracy than concatenation when ILS is high). Well-known examples of such methods are ASTRAL (<xref rid="btad221-B17" ref-type="bibr">Mirarab et al. 2014</xref>) and MP-EST (<xref rid="btad221-B12" ref-type="bibr">Liu et al. 2010</xref>), which are used often to analyze phylogenomic datasets. However, the branch lengths produced by summary methods are in coalescent units (CUs), and these do not directly lead to branch lengths in substitution units. Moreover, branch lengths in coalescent units are inferable only for the internal branches, which further limits their utility.</p>
    <p>At the current time, therefore, most coalescent-based analyses estimate species trees and their branch lengths in substitution units (SU) following a two-stage approach, where the first stage computes the tree topology (e.g. using a summary method, such as ASTRAL or MP-EST) and then estimates branch lengths on the tree using a constrained concatenation analysis, such as using a maximum likelihood method to infer branch lengths on a fixed tree topology (e.g. <xref rid="btad221-B30" ref-type="bibr">Song et al. 2012</xref>). However, one major problem with this approach is that the branch length calculation step ignores gene tree heterogeneity across the genome, leading to criticisms of this approach in the scientific literature. For example, <xref rid="btad221-B18" ref-type="bibr">Moody et al. (2022)</xref> criticized the findings by <xref rid="btad221-B39" ref-type="bibr">Zhu et al. (2019)</xref> who postulated a shorter length than previously reported separating archaea and bacteria, arguing that the use of concatenation for branch length estimation can lead to substantial under-estimation in the face of high levels of horizontal gene transfer, where gene trees have widely discordant topologies.</p>
    <p>Another approach for SU branch length estimation on species trees is ERaBLE (<xref rid="btad221-B1" ref-type="bibr">Binet et al. 2016</xref>), which uses the SU branch lengths estimated in a set of gene trees and then solves a weighted least-squared optimization problem to assign SU branch lengths to the species tree. However, as with the standard concatenation approach, ERaBLE does not take heterogeneity in gene tree <italic toggle="yes">topologies</italic> due to ILS into account. When a strict molecular clock holds, then branch length estimation in the species tree becomes feasible. However, it is well understood that strict clock-based methods have poor accuracy for many datasets where mutation rates change across the tree (<xref rid="btad221-B2" ref-type="bibr">Bromham and Penny 2003</xref>; <xref rid="btad221-B8" ref-type="bibr">Kumar 2005</xref>). Hence, clock-based approaches do not offer a viable solution.</p>
    <p>To summarize, existing methods to compute SU branch lengths that take discordance between gene trees due to ILS into account, without a strict molecular clock, have not yet been developed. And in particular, we currently lack a theoretical basis for inferring SU lengths for species trees that addresses heterogeneity in gene tree topologies due to ILS, as modeled by the MSC. This is a glaring gap that needs to be filled.</p>
    <p>The unsatisfactory state-of-the-art leads us to ask: How can we estimate branch lengths on species trees that are accurate, even in the face of high levels of ILS and that does not depend on a strong molecular clock? We specifically seek a method that has a strong theoretical foundation based on the MSC. We also seek to develop a method that is sufficiently fast that it is scalable to large genome-wide datasets with hundreds to thousands of genes and species. Because we seek to develop scalable methods, Bayesian co-estimation of gene trees and species trees (topologies and branch lengths) is infeasible as even the best of these methods are computationally intensive on smaller datasets with about 50 species and 200 genes (<xref rid="btad221-B40" ref-type="bibr">Zimmermann et al. 2014</xref>; <xref rid="btad221-B21" ref-type="bibr">Ogilvie et al. 2017</xref>).</p>
    <p>Here, we propose the Coalescent-Aware Species Tree Length Estimation in Substitution-unit (CASTLES) method. The input to CASTLES is a rooted species tree <italic toggle="yes">topology</italic> and a set of inferred gene trees with SU branch lengths, which can have missing data, polytomies, and multiple individuals per species. The output is the species tree furnished with SU lengths on all branches; at the root, only the sum of the lengths of the two root-incident branches is inferred. CASTLES addresses gene tree heterogeneity under the MSC and naturally occurring variation in mutation rates; thus, it does not assume strict molecular clock. Similar to methods like ASTRAL for species tree topology inference, we use a quartet-based approach. We first derive the expected branch length of gene trees that do or do not match a quartet species tree under our model as a function of their CU length and mutation rates. These derivations suggest an algorithm for estimating SU branch lengths, but the approach is cumbersome to implement. Through approximations and simplifications, we derive a much simpler estimator that still retains non-ultrametricity. Going beyond trees with four species in a naive way, iterating over all <inline-formula id="IE1"><mml:math id="IM1" display="inline" overflow="scroll"><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mtable><mml:mtr><mml:mtd><mml:mi>n</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mn>4</mml:mn></mml:mtd></mml:mtr></mml:mtable><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> quartets, would lead to the loss of scalability. Instead, we design a sophisticated dynamic programming algorithm to compute quantities needed by our algorithm in quadratic time. We compare CASTLES to leading alternatives using a simulation study and demonstrate its superior accuracy and speed. Finally, we apply it to a biological dataset.</p>
  </sec>
  <sec>
    <title>2 Materials and methods</title>
    <p>We first describe a model that generates gene trees with SU branch lengths. We then derive the expected gene tree branch lengths under this model for a single quartet. The resulting set of non-linear equations can be (approximately) solved using numerical methods, and will yield values for the model parameters given quantities that can be measured from the gene trees. However, solving these equations is computationally intensive, involves numerical instabilities, may not produce optimal solutions and is cumbersome; therefore, here we present simplifications that give analytical formulas for every branch of a quartet tree. Using equations for the simplified model, we then develop an algorithm that can handle a tree with arbitrary size <italic toggle="yes">n</italic>, including a scalable (quadratic) dynamic programming algorithm to compute averages of quartet branch lengths across gene trees for <inline-formula id="IE2"><mml:math id="IM2" display="inline" overflow="scroll"><mml:mrow><mml:mo>Θ</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mn>4</mml:mn></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> quartets. We relegate most proofs to the <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>.</p>
    <sec>
      <title>2.1 MSC + Substitution model</title>
      <p>Our model parameters include a species tree <inline-formula id="IE3"><mml:math id="IM3" display="inline" overflow="scroll"><mml:mi mathvariant="script">T</mml:mi></mml:math></inline-formula> and several per-branch attributes (<xref rid="btad221-F1" ref-type="fig">Fig. 1a</xref>). Each branch <italic toggle="yes">i</italic> is furnished with a branch length <inline-formula id="IE4"><mml:math id="IM4" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>τ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> in the unit of the number of generations, a haploid effective population size <inline-formula id="IE5"><mml:math id="IM5" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, and a substitutions-per-generation rate <inline-formula id="IE6"><mml:math id="IM6" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>. The CU length of the branch is simply <inline-formula id="IE7"><mml:math id="IM7" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>τ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>/</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>. Let <inline-formula id="IE8"><mml:math id="IM8" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> denote the CU substitution rate. The SU length of the branch is <inline-formula id="IE9"><mml:math id="IM9" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>τ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>; thus, setting unequal <inline-formula id="IE10"><mml:math id="IM10" display="inline" overflow="scroll"><mml:mo>ν</mml:mo></mml:math></inline-formula> values across the tree branches leads to a non-ultrametric species tree. Gene trees are first drawn under the MSC model (ignoring <inline-formula id="IE11"><mml:math id="IM11" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>), thus producing trees with lengths in the unit of generations. Gene trees with SU length are generated by multiplying the length of every infinitesimally small part of each of their branches passing through a species tree branch <italic toggle="yes">i</italic> by the species tree rate <inline-formula id="IE12"><mml:math id="IM12" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>. For example, the length of the terminal branch <italic toggle="yes">A</italic> in <xref rid="btad221-F1" ref-type="fig">Fig. 1</xref> is <inline-formula id="IE13"><mml:math id="IM13" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:mi>x</mml:mi><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. Note that under this model, species tree CU lengths connect indirectly to SU and time units; inferring SU from CU requires <inline-formula id="IE14"><mml:math id="IM14" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, inferring the number of generations needs the population size, and inferring time additionally needs the generation time.</p>
      <fig position="float" id="btad221-F1">
        <label>Figure 1.</label>
        <caption>
          <p>(a) MSC + Substitution model. Each branch of the species tree is furnished with parameters described in the legend. As a gene tree evolves inside the species tree, its branches inherit the substitution rates of all the species tree branches that they pass through. When mutation rates change across species tree branches, the resulting gene tree is non-ultrametric. We match the theoretical expected values of the five branches of a gene tree that matches or does not match the species tree (namely, <inline-formula id="IE15"><mml:math id="IM15" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>B</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>C</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>D</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, and <inline-formula id="IE16"><mml:math id="IM16" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>I</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> for a matching gene tree shown here) to their empirical means, computed from gene trees. (b) Handling a tree with more than four taxa. Each focal internal branch (arrow) divides the tree into four groups, here denoted as <italic toggle="yes">A</italic>, <italic toggle="yes">B</italic>, <italic toggle="yes">C</italic>, and <italic toggle="yes">D</italic>. To use quartet-based equations, we average branch lengths over all quartets with one leaf selected from each of <italic toggle="yes">A</italic>, <italic toggle="yes">B</italic>, <italic toggle="yes">C</italic>, and <italic toggle="yes">D</italic> (e.g. <inline-formula id="IE17"><mml:math id="IM17" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>b</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>). Note that in one gene tree, some quartets around a species tree branch may contribute to matching while others contribute to non-matching average lengths (examples shown). We compute these averages efficiently without listing all <inline-formula id="IE18"><mml:math id="IM18" display="inline" overflow="scroll"><mml:mrow><mml:mi>O</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mn>4</mml:mn></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> quartets using dynamic programming.</p>
        </caption>
        <graphic xlink:href="btad221f1" position="float"/>
      </fig>
    </sec>
    <sec>
      <title>2.2 Expected quartet branch lengths under the MSC</title>
      <p>Focusing on a quartet, we now derive the expected length of all branches as a function of the model parameters. Consider unbalanced and balanced species trees shown in <xref rid="btad221-F1" ref-type="fig">Fig. 1</xref>. In the <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>, we present <xref rid="sup1" ref-type="supplementary-material">Supplementary Lemmas S1–S6</xref>, which derive the expected length of each terminal and internal branch in the gene trees that do or do not match the unbalanced or balanced species trees. Note that these expectations can be estimated in a statistically consistent manner given true gene trees with SU branch lengths. Combined, we derive 10 equations across the five branches, relating the measurable expected values to the unknown parameters. Since <inline-formula id="IE19"><mml:math id="IM19" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE20"><mml:math id="IM20" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> only appear as <inline-formula id="IE21"><mml:math id="IM21" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> for all terminal branches (<inline-formula id="IE22"><mml:math id="IM22" display="inline" overflow="scroll"><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mo>{</mml:mo><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>B</mml:mi><mml:mo>,</mml:mo><mml:mi>C</mml:mi><mml:mo>,</mml:mo><mml:mi>D</mml:mi><mml:mo>}</mml:mo></mml:mrow></mml:math></inline-formula>), we have four unknown parameters for terminal branches. With three unknown rates (<inline-formula id="IE23"><mml:math id="IM23" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>3</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>) and two unknown CU internal lengths (<inline-formula id="IE24"><mml:math id="IM24" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE25"><mml:math id="IM25" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>), we have 9 unknowns in total.</p>
      <p>This non-linear system of 10 equations and 9 unknowns can be (approximately) solved using numerical methods to jointly estimate all the parameters. Such an optimization approach, however, is subject to numerical instability, may be slow, and may not give optimal solutions for this (possibly) non-convex optimization problem. Instead of exploring that path, we observe that by making some simplifying assumptions, we can compute all the branch lengths analytically.</p>
      <p>Theorem 1 and the similar <xref rid="sup1" ref-type="supplementary-material">Supplementary Theorem S1</xref> (<xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>) for balanced trees follow from the lemmas mentioned earlier.<statement id="mthst1"><label>Theorem 1</label><p>(Unbalanced). <italic toggle="yes">For the unbalanced species tree of <xref rid="btad221-F1" ref-type="fig">Fig. 1a</xref>, let</italic><inline-formula id="IE26"><mml:math id="IM26" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>I</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula><italic toggle="yes">be the difference in the expected internal branch length in substitution units of gene trees with an unrooted topology matching the species tree and those not matching the species tree. Then</italic>,
</p><p><italic toggle="yes">Similarly, let</italic> <inline-formula id="IE27"><mml:math id="IM27" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>C</mml:mi></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math></inline-formula><italic toggle="yes">and</italic> <inline-formula id="IE28"><mml:math id="IM28" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>D</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula><italic toggle="yes">be the difference in the expected length of matching and non-matching gene trees for the terminal branch leading to a cherry, the middle terminal branch, and the root-adjacent terminal branch, respectively.</italic></p></statement></p>
      <disp-formula id="E1">
        <label>(1)</label>
        <mml:math id="M1" display="block" overflow="scroll">
          <mml:mrow>
            <mml:mtable>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mo>Δ</mml:mo>
                      </mml:mrow>
                      <mml:mi>I</mml:mi>
                    </mml:msub>
                    <mml:mo>=</mml:mo>
                  </mml:mrow>
                  <mml:mrow>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:mn>3</mml:mn>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>−</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:mn>3</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>1</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>3</mml:mn>
                        </mml:msub>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo>+</mml:mo>
                        <mml:mn>6</mml:mn>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>1</mml:mn>
                        </mml:msub>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>−</mml:mo>
                        <mml:mn>1</mml:mn>
                        <mml:mo>+</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mi>T</mml:mi>
                          </mml:mrow>
                          <mml:mn>1</mml:mn>
                        </mml:msub>
                        <mml:mo stretchy="false">)</mml:mo>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
            </mml:mtable>
          </mml:mrow>
          <mml:mo>.</mml:mo>
        </mml:math>
      </disp-formula>
      <disp-formula id="E2">
        <label>(2)</label>
        <mml:math id="M2" display="block" overflow="scroll">
          <mml:mrow>
            <mml:mtable>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mo>Δ</mml:mo>
                      </mml:mrow>
                      <mml:mi>A</mml:mi>
                    </mml:msub>
                    <mml:mo>=</mml:mo>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:mn>4</mml:mn>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:mn>6</mml:mn>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>1</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>+</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:mn>3</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>+</mml:mo>
                        <mml:mfrac>
                          <mml:mrow>
                            <mml:mn>9</mml:mn>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:mrow>
                        </mml:mfrac>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>3</mml:mn>
                        </mml:msub>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:mo>+</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:mo>+</mml:mo>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mrow>
                          <mml:mo>(</mml:mo>
                          <mml:mrow>
                            <mml:mfrac>
                              <mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mn>2</mml:mn>
                              </mml:mrow>
                            </mml:mfrac>
                            <mml:mo stretchy="true">(</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                            <mml:mo>+</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>3</mml:mn>
                            </mml:msub>
                            <mml:mo stretchy="true">)</mml:mo>
                            <mml:msup>
                              <mml:mrow>
                                <mml:mi>e</mml:mi>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mo>−</mml:mo>
                                <mml:mn>3</mml:mn>
                                <mml:msub>
                                  <mml:mrow>
                                    <mml:mi>T</mml:mi>
                                  </mml:mrow>
                                  <mml:mn>2</mml:mn>
                                </mml:msub>
                              </mml:mrow>
                            </mml:msup>
                            <mml:mo>+</mml:mo>
                            <mml:mn>6</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                            <mml:mo stretchy="true">(</mml:mo>
                            <mml:mn>1</mml:mn>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                            <mml:mo stretchy="true">)</mml:mo>
                            <mml:mo>−</mml:mo>
                            <mml:mn>5</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                          <mml:mo>)</mml:mo>
                        </mml:mrow>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:mo>+</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
            </mml:mtable>
          </mml:mrow>
          <mml:mo>.</mml:mo>
        </mml:math>
      </disp-formula>
      <disp-formula id="E3">
        <label>(3)</label>
        <mml:math id="M3" display="block" overflow="scroll">
          <mml:mrow>
            <mml:mtable>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mo>Δ</mml:mo>
                      </mml:mrow>
                      <mml:mi>C</mml:mi>
                    </mml:msub>
                    <mml:mo>=</mml:mo>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                        <mml:mrow>
                          <mml:mo>(</mml:mo>
                          <mml:mrow>
                            <mml:mrow>
                              <mml:mo>(</mml:mo>
                              <mml:mrow>
                                <mml:msup>
                                  <mml:mrow>
                                    <mml:mi>e</mml:mi>
                                  </mml:mrow>
                                  <mml:mrow>
                                    <mml:mo>−</mml:mo>
                                    <mml:mn>3</mml:mn>
                                    <mml:msub>
                                      <mml:mrow>
                                        <mml:mi>T</mml:mi>
                                      </mml:mrow>
                                      <mml:mn>2</mml:mn>
                                    </mml:msub>
                                  </mml:mrow>
                                </mml:msup>
                                <mml:mo>+</mml:mo>
                                <mml:mn>2</mml:mn>
                              </mml:mrow>
                              <mml:mo>)</mml:mo>
                            </mml:mrow>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                            <mml:mo>−</mml:mo>
                            <mml:mn>3</mml:mn>
                            <mml:msup>
                              <mml:mrow>
                                <mml:mi>e</mml:mi>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mo>−</mml:mo>
                                <mml:msub>
                                  <mml:mrow>
                                    <mml:mi>T</mml:mi>
                                  </mml:mrow>
                                  <mml:mn>2</mml:mn>
                                </mml:msub>
                              </mml:mrow>
                            </mml:msup>
                            <mml:mo stretchy="true">(</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mo>μ</mml:mo>
                              </mml:mrow>
                              <mml:mn>3</mml:mn>
                            </mml:msub>
                            <mml:mo stretchy="true">)</mml:mo>
                          </mml:mrow>
                          <mml:mo>)</mml:mo>
                        </mml:mrow>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:mo>+</mml:mo>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>3</mml:mn>
                        </mml:msub>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:mn>3</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>−</mml:mo>
                        <mml:mn>4</mml:mn>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="true">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="true">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
            </mml:mtable>
          </mml:mrow>
          <mml:mo>.</mml:mo>
        </mml:math>
      </disp-formula>
      <disp-formula id="E4">
        <label>(4)</label>
        <mml:math id="M4" display="block" overflow="scroll">
          <mml:mrow>
            <mml:mtable>
              <mml:mtr columnalign="left">
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mo>Δ</mml:mo>
                      </mml:mrow>
                      <mml:mi>D</mml:mi>
                    </mml:msub>
                    <mml:mo>=</mml:mo>
                  </mml:mrow>
                </mml:mtd>
                <mml:mtd columnalign="left">
                  <mml:mrow>
                    <mml:mfrac>
                      <mml:mrow>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>1</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo>−</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:mn>3</mml:mn>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>2</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:msub>
                        <mml:mo>−</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mo>μ</mml:mo>
                          </mml:mrow>
                          <mml:mn>3</mml:mn>
                        </mml:msub>
                        <mml:mo stretchy="false">)</mml:mo>
                        <mml:mo stretchy="false">)</mml:mo>
                      </mml:mrow>
                      <mml:mrow>
                        <mml:mn>2</mml:mn>
                        <mml:mo stretchy="false">(</mml:mo>
                        <mml:mn>3</mml:mn>
                        <mml:mo>−</mml:mo>
                        <mml:mn>2</mml:mn>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi>e</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>−</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi>T</mml:mi>
                              </mml:mrow>
                              <mml:mn>1</mml:mn>
                            </mml:msub>
                          </mml:mrow>
                        </mml:msup>
                        <mml:mo stretchy="false">)</mml:mo>
                      </mml:mrow>
                    </mml:mfrac>
                  </mml:mrow>
                </mml:mtd>
              </mml:mtr>
            </mml:mtable>
          </mml:mrow>
          <mml:mo>.</mml:mo>
        </mml:math>
      </disp-formula>
      <p>We simplify the equations of Theorem 1 by computing their limit as <inline-formula id="IE29"><mml:math id="IM29" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:math></inline-formula> or <inline-formula id="IE30"><mml:math id="IM30" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>3</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. Note that neither assumption completely breaks non-ultrametricity assumptions because we ignore the rate for only one branch (<inline-formula id="IE31"><mml:math id="IM31" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>) and not the others.</p>
    </sec>
    <sec>
      <title>2.3 Simplifications</title>
      <sec>
        <title>2.3.1 Internal branch calculation</title>
        <p>To compute <inline-formula id="IE32"><mml:math id="IM32" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>, we simplify <xref rid="E1" ref-type="disp-formula">Equation (1)</xref> so that it only depends on <inline-formula id="IE33"><mml:math id="IM33" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE34"><mml:math id="IM34" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>, by computing its limits:
</p>
        <disp-formula id="E5">
          <label>(5)</label>
          <mml:math id="M5" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mtable>
                <mml:mtr columnalign="left">
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:mo>∞</mml:mo>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>Δ</mml:mo>
                        </mml:mrow>
                        <mml:mi>I</mml:mi>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:mn>0</mml:mn>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>Δ</mml:mo>
                        </mml:mrow>
                        <mml:mi>I</mml:mi>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>3</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>Δ</mml:mo>
                        </mml:mrow>
                        <mml:mi>I</mml:mi>
                      </mml:msub>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>=</mml:mo>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo stretchy="false">(</mml:mo>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                          <mml:mo>−</mml:mo>
                          <mml:mn>1</mml:mn>
                          <mml:mo>+</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo stretchy="false">)</mml:mo>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                          <mml:mo>−</mml:mo>
                          <mml:mn>2</mml:mn>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                        </mml:mrow>
                      </mml:mfrac>
                    </mml:mrow>
                  </mml:mtd>
                </mml:mtr>
              </mml:mtable>
            </mml:mrow>
            <mml:mo>.</mml:mo>
          </mml:math>
        </disp-formula>
        <p>Replacing <inline-formula id="IE35"><mml:math id="IM35" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>I</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> with the observed difference between mean internal branches among matching and non-matching gene trees (<inline-formula id="IE36"><mml:math id="IM36" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>Δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>I</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>), we get an equation with two unknowns, <inline-formula id="IE37"><mml:math id="IM37" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE38"><mml:math id="IM38" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. One way to move forward is to estimate <inline-formula id="IE39"><mml:math id="IM39" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> using quartet discordance, as shown by <xref rid="btad221-B29" ref-type="bibr">Sayyari and Mirarab (2016)</xref>. Then, we can estimate <inline-formula id="IE40"><mml:math id="IM40" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> and thus <inline-formula id="IE41"><mml:math id="IM41" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. However, the accuracy of the CU estimate of <inline-formula id="IE42"><mml:math id="IM42" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> is known to degrade for inaccurate gene trees (<xref rid="btad221-B29" ref-type="bibr">Sayyari and Mirarab 2016</xref>). Instead, we use a local clock approximation to estimate <inline-formula id="IE43"><mml:math id="IM43" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> and then solve for <inline-formula id="IE44"><mml:math id="IM44" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. If mutation rates of the two branches above the focal branch are assumed the same (e.g. <inline-formula id="IE45"><mml:math id="IM45" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>3</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>), then, the expected length of gene trees not matching the species tree is simply <inline-formula id="IE46"><mml:math id="IM46" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> by <xref rid="sup1" ref-type="supplementary-material">Supplementary Lemma S1</xref> (<xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>). Further assuming <inline-formula id="IE47"><mml:math id="IM47" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> allows us to estimate <inline-formula id="IE48"><mml:math id="IM48" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> as the mean length of the internal quartet branch among gene trees not matching the species tree (<inline-formula id="IE49"><mml:math id="IM49" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>I</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>), obtaining:
</p>
        <disp-formula id="E6">
          <label>(6)</label>
          <mml:math id="M6" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mtable>
                <mml:mtr columnalign="left">
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mrow>
                                <mml:mover accent="true">
                                  <mml:mi>Δ</mml:mi>
                                  <mml:mo>¯</mml:mo>
                                </mml:mover>
                              </mml:mrow>
                            </mml:mrow>
                            <mml:mi>I</mml:mi>
                          </mml:msub>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msubsup>
                            <mml:mrow>
                              <mml:mrow>
                                <mml:mover accent="true">
                                  <mml:mi>L</mml:mi>
                                  <mml:mo>¯</mml:mo>
                                </mml:mover>
                              </mml:mrow>
                            </mml:mrow>
                            <mml:mi>I</mml:mi>
                            <mml:mo>′</mml:mo>
                          </mml:msubsup>
                        </mml:mrow>
                      </mml:mfrac>
                    </mml:mrow>
                  </mml:mtd>
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:mo>=</mml:mo>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                          <mml:mo stretchy="false">(</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo>+</mml:mo>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                          <mml:mo>−</mml:mo>
                          <mml:mn>1</mml:mn>
                          <mml:mo stretchy="false">)</mml:mo>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                          <mml:mo>−</mml:mo>
                          <mml:mn>2</mml:mn>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                        </mml:mrow>
                      </mml:mfrac>
                    </mml:mrow>
                  </mml:mtd>
                </mml:mtr>
              </mml:mtable>
            </mml:mrow>
            <mml:mo>.</mml:mo>
          </mml:math>
        </disp-formula>
        <p>The solution to this equation is:
where <inline-formula id="IE50"><mml:math id="IM50" display="inline" overflow="scroll"><mml:mrow><mml:mi>W</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mo>.</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> is the Lambert W function and <inline-formula id="IE51"><mml:math id="IM51" display="inline" overflow="scroll"><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>Δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>I</mml:mi></mml:msub><mml:mo>/</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>I</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>. Since Lambert’s function does not have a closed-form solution (and can be imaginary), we resort to the Taylor expansion <inline-formula id="IE52"><mml:math id="IM52" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mi>e</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>, which is a good approximation for small <inline-formula id="IE53"><mml:math id="IM53" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula>. Using this approximation, the solution to <xref rid="E6" ref-type="disp-formula">Equation (6)</xref> becomes:
</p>
        <disp-formula id="E7">
          <mml:math id="M7" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mi>δ</mml:mi>
                  <mml:mo>¯</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>+</mml:mo>
              <mml:mi>W</mml:mi>
              <mml:mrow>
                <mml:mo>(</mml:mo>
                <mml:mrow>
                  <mml:mo>−</mml:mo>
                  <mml:mfrac>
                    <mml:mrow>
                      <mml:mn>1</mml:mn>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mn>3</mml:mn>
                    </mml:mrow>
                  </mml:mfrac>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:mrow>
                        <mml:mover accent="true">
                          <mml:mi>δ</mml:mi>
                          <mml:mo>¯</mml:mo>
                        </mml:mover>
                      </mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:mn>1</mml:mn>
                    </mml:mrow>
                  </mml:msup>
                  <mml:mo stretchy="false">(</mml:mo>
                  <mml:mn>2</mml:mn>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>δ</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                  <mml:mo>+</mml:mo>
                  <mml:mn>3</mml:mn>
                  <mml:mo stretchy="false">)</mml:mo>
                </mml:mrow>
                <mml:mo>)</mml:mo>
              </mml:mrow>
              <mml:mo>+</mml:mo>
              <mml:mn>1</mml:mn>
            </mml:mrow>
            <mml:mo>,</mml:mo>
          </mml:math>
        </disp-formula>
        <disp-formula id="E8">
          <label>(7)</label>
          <mml:math id="M8" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mi>T</mml:mi>
                      </mml:mrow>
                      <mml:mn>1</mml:mn>
                    </mml:msub>
                  </mml:mrow>
                  <mml:mo stretchy="true">^</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>2</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mi>δ</mml:mi>
                  <mml:mo>¯</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>+</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>6</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:msqrt>
                <mml:mrow>
                  <mml:mn>3</mml:mn>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>δ</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                  <mml:mo stretchy="false">(</mml:mo>
                  <mml:mn>3</mml:mn>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>δ</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                  <mml:mo>+</mml:mo>
                  <mml:mn>4</mml:mn>
                  <mml:mo stretchy="false">)</mml:mo>
                </mml:mrow>
              </mml:msqrt>
            </mml:mrow>
            <mml:mo>.</mml:mo>
          </mml:math>
        </disp-formula>
        <p>In our current implementation of CASTLES, we use this approximation to avoid numerical issues. When <inline-formula id="IE54"><mml:math id="IM54" display="inline" overflow="scroll"><mml:mrow><mml:mo>δ</mml:mo><mml:mo>&lt;</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula>, we set the branch length to a small value (<inline-formula id="IE55"><mml:math id="IM55" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mn>10</mml:mn></mml:mrow></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math></inline-formula> by default).</p>
      </sec>
      <sec>
        <title>2.3.2 Terminal branch calculation</title>
        <p>To simplify <xref rid="E2" ref-type="disp-formula">Equation (2)</xref>, we compute its limit as <inline-formula id="IE56"><mml:math id="IM56" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:math></inline-formula></p>
        <disp-formula id="E9">
          <label>(8)</label>
          <mml:math id="M9" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mtable>
                <mml:mtr columnalign="left">
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:mo>∞</mml:mo>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>Δ</mml:mo>
                        </mml:mrow>
                        <mml:mi>A</mml:mi>
                      </mml:msub>
                    </mml:mrow>
                  </mml:mtd>
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:mo>=</mml:mo>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:mo>−</mml:mo>
                          <mml:mn>6</mml:mn>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo stretchy="false">(</mml:mo>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                          <mml:mo>−</mml:mo>
                          <mml:mn>1</mml:mn>
                          <mml:mo>+</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                          <mml:mo stretchy="false">)</mml:mo>
                          <mml:mo>−</mml:mo>
                          <mml:mo stretchy="false">(</mml:mo>
                          <mml:mn>5</mml:mn>
                          <mml:mo>−</mml:mo>
                          <mml:mn>4</mml:mn>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                          <mml:mo stretchy="false">)</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mn>6</mml:mn>
                          <mml:mo>−</mml:mo>
                          <mml:mn>4</mml:mn>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                        </mml:mrow>
                      </mml:mfrac>
                      <mml:mo> </mml:mo>
                      <mml:mo>.</mml:mo>
                    </mml:mrow>
                  </mml:mtd>
                </mml:mtr>
              </mml:mtable>
            </mml:mrow>
          </mml:math>
        </disp-formula>
        <p>The expected length of the terminal branch of <italic toggle="yes">A</italic> in non-matching gene trees in the limit is
based on <xref rid="sup1" ref-type="supplementary-material">Supplementary Equation (S19)</xref> (<xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>). To compute <inline-formula id="IE57"><mml:math id="IM57" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> we replace the expected value <inline-formula id="IE58"><mml:math id="IM58" display="inline" overflow="scroll"><mml:mrow><mml:munder><mml:mrow><mml:mi>lim</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>A</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> in <xref rid="E9" ref-type="disp-formula">Equation (8)</xref> with the observed mean difference <inline-formula id="IE59"><mml:math id="IM59" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>Δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>A</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and replace the expected value <inline-formula id="IE60"><mml:math id="IM60" display="inline" overflow="scroll"><mml:mrow><mml:munder><mml:mrow><mml:mi>lim</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:munder><mml:msubsup><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>A</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula> in <xref rid="E10" ref-type="disp-formula">Equation (9)</xref> with the observed mean terminal branch of <italic toggle="yes">A</italic> among non-matching gene trees (<inline-formula id="IE61"><mml:math id="IM61" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>A</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>). Solving for <inline-formula id="IE62"><mml:math id="IM62" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>A</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> gives us an estimator of <inline-formula id="IE63"><mml:math id="IM63" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>A</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>:
</p>
        <disp-formula id="E10">
          <label>(9)</label>
          <mml:math id="M10" display="block" overflow="scroll">
            <mml:mrow>
              <mml:munder>
                <mml:mrow>
                  <mml:mi>lim</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mi>T</mml:mi>
                    </mml:mrow>
                    <mml:mn>2</mml:mn>
                  </mml:msub>
                  <mml:mo>→</mml:mo>
                  <mml:mo>∞</mml:mo>
                </mml:mrow>
              </mml:munder>
              <mml:msubsup>
                <mml:mrow>
                  <mml:mi>L</mml:mi>
                </mml:mrow>
                <mml:mi>A</mml:mi>
                <mml:mo>′</mml:mo>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mi>T</mml:mi>
                </mml:mrow>
                <mml:mn>1</mml:mn>
              </mml:msub>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mn>1</mml:mn>
              </mml:msub>
              <mml:mo>+</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mi>T</mml:mi>
                </mml:mrow>
                <mml:mi>A</mml:mi>
              </mml:msub>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mi>A</mml:mi>
              </mml:msub>
              <mml:mo>+</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>5</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>6</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mn>2</mml:mn>
              </mml:msub>
            </mml:mrow>
          </mml:math>
        </disp-formula>
        <disp-formula id="E11">
          <label>(10)</label>
          <mml:math id="M11" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mi>t</mml:mi>
                      </mml:mrow>
                      <mml:mi>A</mml:mi>
                    </mml:msub>
                  </mml:mrow>
                  <mml:mo stretchy="true">^</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>=</mml:mo>
              <mml:msubsup>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>L</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>A</mml:mi>
                <mml:mo>′</mml:mo>
              </mml:msubsup>
              <mml:mo>+</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mo>μ</mml:mo>
                    </mml:mrow>
                    <mml:mn>1</mml:mn>
                  </mml:msub>
                  <mml:mo stretchy="false">(</mml:mo>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>1</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:msup>
                  <mml:mo>−</mml:mo>
                  <mml:mn>1</mml:mn>
                  <mml:mo>+</mml:mo>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mi>T</mml:mi>
                    </mml:mrow>
                    <mml:mn>1</mml:mn>
                  </mml:msub>
                  <mml:mo stretchy="false">)</mml:mo>
                  <mml:mo>+</mml:mo>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mrow>
                        <mml:mover accent="true">
                          <mml:mi>Δ</mml:mi>
                          <mml:mo>¯</mml:mo>
                        </mml:mover>
                      </mml:mrow>
                    </mml:mrow>
                    <mml:mi>A</mml:mi>
                  </mml:msub>
                  <mml:mo stretchy="false">(</mml:mo>
                  <mml:mn>1</mml:mn>
                  <mml:mo>−</mml:mo>
                  <mml:mn>2</mml:mn>
                  <mml:mo>/</mml:mo>
                  <mml:mn>3</mml:mn>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>1</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:msup>
                  <mml:mo stretchy="false">)</mml:mo>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                  <mml:mo>−</mml:mo>
                  <mml:mn>4</mml:mn>
                  <mml:mo>/</mml:mo>
                  <mml:mn>5</mml:mn>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>1</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:msup>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo>−</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mi>T</mml:mi>
                </mml:mrow>
                <mml:mn>1</mml:mn>
              </mml:msub>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mn>1</mml:mn>
              </mml:msub>
              <mml:mo> </mml:mo>
              <mml:mo>.</mml:mo>
            </mml:mrow>
          </mml:math>
        </disp-formula>
        <p>Similarly, for branch <italic toggle="yes">C</italic>,
where the expected length of <italic toggle="yes">C</italic> in non-matching gene trees (<inline-formula id="IE64"><mml:math id="IM64" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>C</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>) is given in <xref rid="sup1" ref-type="supplementary-material">Supplementary Equation (S6)</xref> in the <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>. Replacing <inline-formula id="IE65"><mml:math id="IM65" display="inline" overflow="scroll"><mml:mrow><mml:munder><mml:mrow><mml:mi>lim</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:munder><mml:msubsup><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>C</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula> with the observed length of <italic toggle="yes">C</italic> in non-matching gene trees <inline-formula id="IE66"><mml:math id="IM66" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>C</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula> and replacing <inline-formula id="IE67"><mml:math id="IM67" display="inline" overflow="scroll"><mml:mrow><mml:munder><mml:mrow><mml:mi>lim</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>→</mml:mo><mml:mo>∞</mml:mo></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> with the observed <inline-formula id="IE68"><mml:math id="IM68" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>Δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> in <xref rid="E12" ref-type="disp-formula">Equation (11)</xref> gives us the estimate for <inline-formula id="IE69"><mml:math id="IM69" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>C</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>C</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>:
</p>
        <disp-formula id="E12">
          <label>(11)</label>
          <mml:math id="M12" display="block" overflow="scroll">
            <mml:mrow>
              <mml:munder>
                <mml:mrow>
                  <mml:mi>lim</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mi>T</mml:mi>
                    </mml:mrow>
                    <mml:mn>2</mml:mn>
                  </mml:msub>
                  <mml:mo>→</mml:mo>
                  <mml:mo>∞</mml:mo>
                </mml:mrow>
              </mml:munder>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>Δ</mml:mo>
                </mml:mrow>
                <mml:mi>C</mml:mi>
              </mml:msub>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mo>μ</mml:mo>
                    </mml:mrow>
                    <mml:mn>2</mml:mn>
                  </mml:msub>
                  <mml:mrow>
                    <mml:mo>(</mml:mo>
                    <mml:mrow>
                      <mml:mn>2</mml:mn>
                      <mml:mo>−</mml:mo>
                      <mml:msup>
                        <mml:mrow>
                          <mml:mi>e</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mo>−</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                      </mml:msup>
                    </mml:mrow>
                    <mml:mo>)</mml:mo>
                  </mml:mrow>
                </mml:mrow>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mo>(</mml:mo>
                    <mml:mrow>
                      <mml:mn>3</mml:mn>
                      <mml:mo>−</mml:mo>
                      <mml:mn>2</mml:mn>
                      <mml:msup>
                        <mml:mrow>
                          <mml:mi>e</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mo>−</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mi>T</mml:mi>
                            </mml:mrow>
                            <mml:mn>1</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                      </mml:msup>
                    </mml:mrow>
                    <mml:mo>)</mml:mo>
                  </mml:mrow>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo> </mml:mo>
              <mml:mtext>and</mml:mtext>
              <mml:mo> </mml:mo>
              <mml:munder>
                <mml:mrow>
                  <mml:mi>lim</mml:mi>
                </mml:mrow>
                <mml:mrow>
                  <mml:msub>
                    <mml:mrow>
                      <mml:mi>T</mml:mi>
                    </mml:mrow>
                    <mml:mn>2</mml:mn>
                  </mml:msub>
                  <mml:mo>→</mml:mo>
                  <mml:mo>∞</mml:mo>
                </mml:mrow>
              </mml:munder>
              <mml:msubsup>
                <mml:mrow>
                  <mml:mi>L</mml:mi>
                </mml:mrow>
                <mml:mi>C</mml:mi>
                <mml:mo>′</mml:mo>
              </mml:msubsup>
              <mml:mo>=</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>3</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mn>2</mml:mn>
              </mml:msub>
              <mml:mo>+</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mi>T</mml:mi>
                </mml:mrow>
                <mml:mi>C</mml:mi>
              </mml:msub>
              <mml:msub>
                <mml:mrow>
                  <mml:mo>μ</mml:mo>
                </mml:mrow>
                <mml:mi>C</mml:mi>
              </mml:msub>
            </mml:mrow>
            <mml:mo>,</mml:mo>
          </mml:math>
        </disp-formula>
        <disp-formula id="E13">
          <label>(12)</label>
          <mml:math id="M13" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mi>t</mml:mi>
                      </mml:mrow>
                      <mml:mi>C</mml:mi>
                    </mml:msub>
                  </mml:mrow>
                  <mml:mo stretchy="true">^</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>=</mml:mo>
              <mml:msubsup>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>L</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>C</mml:mi>
                <mml:mo>′</mml:mo>
              </mml:msubsup>
              <mml:mo>−</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>3</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo stretchy="true">(</mml:mo>
              <mml:mn>2</mml:mn>
              <mml:mo>−</mml:mo>
              <mml:mfrac>
                <mml:mn>1</mml:mn>
                <mml:mrow>
                  <mml:mn>2</mml:mn>
                  <mml:mo>−</mml:mo>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>1</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:msup>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo stretchy="true">)</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>Δ</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>C</mml:mi>
              </mml:msub>
              <mml:mo> </mml:mo>
              <mml:mo>.</mml:mo>
            </mml:mrow>
          </mml:math>
        </disp-formula>
        <p>For <italic toggle="yes">D</italic>, we use a different limit:
where the expected length of <italic toggle="yes">D</italic> in non-matching gene trees (<inline-formula id="IE70"><mml:math id="IM70" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>D</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>) is given in <xref rid="sup1" ref-type="supplementary-material">Supplementary Equation (S17)</xref> in the <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix</xref>. The pendant branch of <italic toggle="yes">D</italic> in SU in the <italic toggle="yes">unrooted</italic> species tree is <inline-formula id="IE71"><mml:math id="IM71" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi>D</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mi>D</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, representing both branches below the root. Substituting expected values <inline-formula id="IE72"><mml:math id="IM72" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mi>D</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE73"><mml:math id="IM73" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mi>D</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula> with observed values <inline-formula id="IE74"><mml:math id="IM74" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>Δ</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>D</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE75"><mml:math id="IM75" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>D</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>, we get our estimate:
</p>
        <disp-formula id="E14">
          <mml:math id="M14" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mtable>
                <mml:mtr columnalign="left">
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>3</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>Δ</mml:mo>
                        </mml:mrow>
                        <mml:mi>D</mml:mi>
                      </mml:msub>
                      <mml:mo>=</mml:mo>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mrow>
                            <mml:mo>(</mml:mo>
                            <mml:mrow>
                              <mml:mn>1</mml:mn>
                              <mml:mo>−</mml:mo>
                              <mml:msup>
                                <mml:mrow>
                                  <mml:mi>e</mml:mi>
                                </mml:mrow>
                                <mml:mrow>
                                  <mml:mo>−</mml:mo>
                                  <mml:msub>
                                    <mml:mrow>
                                      <mml:mi>T</mml:mi>
                                    </mml:mrow>
                                    <mml:mn>1</mml:mn>
                                  </mml:msub>
                                </mml:mrow>
                              </mml:msup>
                            </mml:mrow>
                            <mml:mo>)</mml:mo>
                          </mml:mrow>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                          <mml:mo>−</mml:mo>
                          <mml:mn>2</mml:mn>
                          <mml:msup>
                            <mml:mrow>
                              <mml:mi>e</mml:mi>
                            </mml:mrow>
                            <mml:mrow>
                              <mml:mo>−</mml:mo>
                              <mml:msub>
                                <mml:mrow>
                                  <mml:mi>T</mml:mi>
                                </mml:mrow>
                                <mml:mn>1</mml:mn>
                              </mml:msub>
                            </mml:mrow>
                          </mml:msup>
                        </mml:mrow>
                      </mml:mfrac>
                    </mml:mrow>
                  </mml:mtd>
                </mml:mtr>
                <mml:mtr columnalign="left">
                  <mml:mtd columnalign="left">
                    <mml:mrow>
                      <mml:munder>
                        <mml:mrow>
                          <mml:mi>lim</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>2</mml:mn>
                          </mml:msub>
                          <mml:mo>→</mml:mo>
                          <mml:msub>
                            <mml:mrow>
                              <mml:mo>μ</mml:mo>
                            </mml:mrow>
                            <mml:mn>3</mml:mn>
                          </mml:msub>
                        </mml:mrow>
                      </mml:munder>
                      <mml:msubsup>
                        <mml:mrow>
                          <mml:mi>L</mml:mi>
                        </mml:mrow>
                        <mml:mi>D</mml:mi>
                        <mml:mo>′</mml:mo>
                      </mml:msubsup>
                      <mml:mo>=</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>μ</mml:mo>
                        </mml:mrow>
                        <mml:mn>2</mml:mn>
                      </mml:msub>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>2</mml:mn>
                      </mml:msub>
                      <mml:mo>+</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>μ</mml:mo>
                        </mml:mrow>
                        <mml:mi>D</mml:mi>
                      </mml:msub>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mi>D</mml:mi>
                      </mml:msub>
                      <mml:mo>+</mml:mo>
                      <mml:mfrac>
                        <mml:mrow>
                          <mml:mn>2</mml:mn>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mn>3</mml:mn>
                        </mml:mrow>
                      </mml:mfrac>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mo>μ</mml:mo>
                        </mml:mrow>
                        <mml:mn>2</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:mtd>
                </mml:mtr>
              </mml:mtable>
            </mml:mrow>
            <mml:mo>,</mml:mo>
          </mml:math>
        </disp-formula>
        <disp-formula id="E15">
          <label>(13)</label>
          <mml:math id="M15" display="block" overflow="scroll">
            <mml:mrow>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mi>t</mml:mi>
                      </mml:mrow>
                      <mml:mn>2</mml:mn>
                    </mml:msub>
                  </mml:mrow>
                  <mml:mo stretchy="true">^</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>+</mml:mo>
              <mml:mrow>
                <mml:mover accent="true">
                  <mml:mrow>
                    <mml:msub>
                      <mml:mrow>
                        <mml:mi>t</mml:mi>
                      </mml:mrow>
                      <mml:mi>D</mml:mi>
                    </mml:msub>
                  </mml:mrow>
                  <mml:mo stretchy="true">^</mml:mo>
                </mml:mover>
              </mml:mrow>
              <mml:mo>=</mml:mo>
              <mml:msubsup>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>L</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>D</mml:mi>
                <mml:mo>′</mml:mo>
              </mml:msubsup>
              <mml:mo>−</mml:mo>
              <mml:mfrac>
                <mml:mrow>
                  <mml:mn>2</mml:mn>
                </mml:mrow>
                <mml:mrow>
                  <mml:mn>3</mml:mn>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo stretchy="true">(</mml:mo>
              <mml:mn>2</mml:mn>
              <mml:mo>+</mml:mo>
              <mml:mfrac>
                <mml:mn>1</mml:mn>
                <mml:mrow>
                  <mml:mn>1</mml:mn>
                  <mml:mo>−</mml:mo>
                  <mml:msup>
                    <mml:mrow>
                      <mml:mi>e</mml:mi>
                    </mml:mrow>
                    <mml:mrow>
                      <mml:mo>−</mml:mo>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>T</mml:mi>
                        </mml:mrow>
                        <mml:mn>1</mml:mn>
                      </mml:msub>
                    </mml:mrow>
                  </mml:msup>
                </mml:mrow>
              </mml:mfrac>
              <mml:mo stretchy="true">)</mml:mo>
              <mml:msub>
                <mml:mrow>
                  <mml:mrow>
                    <mml:mover accent="true">
                      <mml:mi>Δ</mml:mi>
                      <mml:mo>¯</mml:mo>
                    </mml:mover>
                  </mml:mrow>
                </mml:mrow>
                <mml:mi>D</mml:mi>
              </mml:msub>
              <mml:mo> </mml:mo>
              <mml:mo>.</mml:mo>
            </mml:mrow>
          </mml:math>
        </disp-formula>
        <p>To summarize, we use <xref rid="E11" ref-type="disp-formula">Equations (10)</xref>, <xref rid="E13" ref-type="disp-formula">(12)</xref>, and <xref rid="E15" ref-type="disp-formula">(13)</xref> to compute terminal branch lengths, setting the length to a small value (<inline-formula id="IE76"><mml:math id="IM76" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mn>10</mml:mn></mml:mrow></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math></inline-formula> by default) when results are negative.</p>
      </sec>
    </sec>
    <sec>
      <title>2.4 Extending to larger trees</title>
      <p>To extend the algorithm to more than four species, we apply the same calculations to each branch of the species tree, one at a time. Each internal branch of the species tree creates a quadripartition of species (e.g. <inline-formula id="IE77"><mml:math id="IM77" display="inline" overflow="scroll"><mml:mrow><mml:mi>A</mml:mi><mml:mo>,</mml:mo><mml:mi>B</mml:mi><mml:mo>|</mml:mo><mml:mi>C</mml:mi><mml:mo>,</mml:mo><mml:mi>D</mml:mi></mml:mrow></mml:math></inline-formula> in <xref rid="btad221-F1" ref-type="fig">Fig. 1b</xref>). Any quartet of species (e.g. <inline-formula id="IE78"><mml:math id="IM78" display="inline" overflow="scroll"><mml:mrow><mml:mi>a</mml:mi><mml:mi>b</mml:mi><mml:mo>|</mml:mo><mml:mi>c</mml:mi><mml:mi>d</mml:mi></mml:mrow></mml:math></inline-formula>) with a selection of one taxon from each part of the quadripartition (<inline-formula id="IE79"><mml:math id="IM79" display="inline" overflow="scroll"><mml:mrow><mml:mi>a</mml:mi><mml:mo>∈</mml:mo><mml:mi>A</mml:mi></mml:mrow></mml:math></inline-formula>, <inline-formula id="IE80"><mml:math id="IM80" display="inline" overflow="scroll"><mml:mrow><mml:mi>b</mml:mi><mml:mo>∈</mml:mo><mml:mi>B</mml:mi></mml:mrow></mml:math></inline-formula>, <inline-formula id="IE81"><mml:math id="IM81" display="inline" overflow="scroll"><mml:mrow><mml:mi>c</mml:mi><mml:mo>∈</mml:mo><mml:mi>C</mml:mi></mml:mrow></mml:math></inline-formula>, and <inline-formula id="IE82"><mml:math id="IM82" display="inline" overflow="scroll"><mml:mrow><mml:mi>d</mml:mi><mml:mo>∈</mml:mo><mml:mi>D</mml:mi></mml:mrow></mml:math></inline-formula>) gives us a quartet species tree where all of our previous theoretical results hold, and they all lead to identical expected values for their corresponding gene tree quartets. Thus, it is valid to compute the length of this species tree branch using the quartet-based approach by simply taking the average lengths across all quartets.</p>
      <p>Assuming the averages are already calculated, we can use <xref rid="btad221-BOX1" ref-type="boxed-text">Algorithm 1</xref> to assign a length to each branch. The algorithm visits the internal nodes of the tree in a post-order traversal. For each internal node, it assigns the length of the edge above, in addition to (some of the) adjacent terminal branches. If a node <italic toggle="yes">u</italic> is the parent of a cherry, it assigns the length to both children; otherwise, it ignores the children. If <italic toggle="yes">u</italic> is sister to a leaf, it also assigns the length to the sister, using <xref rid="E13" ref-type="disp-formula">Equation (12)</xref>. When the tree has more than four taxa, almost all branch lengths are assigned using unbalanced quartet equations. The only exception is the root branch, which may need to be set based on the balanced quartet equations (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S5</xref>).</p>
      <p>The most challenging part of this algorithm, then, is computing mean length across <inline-formula id="IE83"><mml:math id="IM83" display="inline" overflow="scroll"><mml:mrow><mml:mi>O</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mn>4</mml:mn></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> quartets in a scalable fashion. These quantities can be computed using a sophisticated dynamic programming algorithm, which borrows many ideas from weighted ASTRAL (<xref rid="btad221-B37" ref-type="bibr">Zhang and Mirarab 2022</xref>). The running time of the algorithm is <inline-formula id="IE84"><mml:math id="IM84" display="inline" overflow="scroll"><mml:mrow><mml:mi>O</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mi>k</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> for <italic toggle="yes">n</italic> leaves and <italic toggle="yes">k</italic> genes. Due to space limitations, we present the full details for this algorithm in the <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix, Section S2</xref>.</p>
      <p>
        <boxed-text id="btad221-BOX1" position="float">
          <caption>
            <p>Algorithm 1. CASTLES algorithm. The input is a rooted species tree <italic toggle="yes">s</italic> with <inline-formula id="IE85"><mml:math id="IM85" display="inline" overflow="scroll"><mml:mrow><mml:mi>n</mml:mi><mml:mo>&gt;</mml:mo><mml:mn>4</mml:mn></mml:mrow></mml:math></inline-formula> taxa and a set of gene trees <inline-formula id="IE86"><mml:math id="IM86" display="inline" overflow="scroll"><mml:mi mathvariant="script">G</mml:mi></mml:math></inline-formula> with SU branch lengths, and the output is <italic toggle="yes">s</italic> annotated with SU branch lengths. <inline-formula id="IE87"><mml:math id="IM87" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>e</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> denotes the length of branch <italic toggle="yes">e</italic> in SU.</p>
          </caption>
          <p>1: <bold>procedure</bold> CASTLES(<italic toggle="yes">s</italic>, <inline-formula id="IE88"><mml:math id="IM88" display="inline" overflow="scroll"><mml:mi mathvariant="script">G</mml:mi></mml:math></inline-formula>)</p>
          <p>2:  <inline-formula id="IE89"><mml:math id="IM89" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>a</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>b</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>v</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>p</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>a</mml:mi><mml:mo>′</mml:mo></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>b</mml:mi><mml:mo>′</mml:mo></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>v</mml:mi><mml:mo>′</mml:mo></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mover accent="true"><mml:mi>L</mml:mi><mml:mo>¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mi>p</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula> for each branch <inline-formula id="IE90"><mml:math id="IM90" display="inline" overflow="scroll"><mml:mo>←</mml:mo></mml:math></inline-formula><xref rid="sup1" ref-type="supplementary-material">Supplementary Algorithm S1</xref></p>
          <p>3:  <bold>for</bold><inline-formula id="IE91"><mml:math id="IM91" display="inline" overflow="scroll"><mml:mrow><mml:mi>u</mml:mi><mml:mo>∈</mml:mo></mml:mrow></mml:math></inline-formula> post order traverse of internal nodes of <italic toggle="yes">s</italic> <bold>do</bold></p>
          <p>4:   <bold>if</bold> <italic toggle="yes">u</italic> is root <bold>then</bold></p>
          <p>5:    break</p>
          <p>6:   <bold>end if</bold></p>
          <p>7:   <inline-formula id="IE92"><mml:math id="IM92" display="inline" overflow="scroll"><mml:mrow><mml:mi>p</mml:mi><mml:mo>←</mml:mo><mml:mi mathvariant="italic">parent</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>;</mml:mo><mml:mi>v</mml:mi><mml:mo>←</mml:mo><mml:mi mathvariant="italic">sibling</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula>; <inline-formula id="IE93"><mml:math id="IM93" display="inline" overflow="scroll"><mml:mrow><mml:mi>a</mml:mi><mml:mo>,</mml:mo><mml:mi>b</mml:mi><mml:mo>←</mml:mo><mml:mi mathvariant="italic">children</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>8:   <bold>if</bold> <italic toggle="yes">p</italic> is root <bold>then</bold></p>
          <p>9:    <bold>if</bold> <italic toggle="yes">v</italic> is leaf <bold>then</bold></p>
          <p>10:     <inline-formula id="IE94"><mml:math id="IM94" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>u</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>v</mml:mi></mml:mrow></mml:msub><mml:mo>←</mml:mo><mml:mtext>Equation</mml:mtext><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mn>13</mml:mn><mml:mo>)</mml:mo><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mtext>terminal</mml:mtext><mml:mo> </mml:mo><mml:mi mathvariant="normal">D</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>11:    <bold>else</bold></p>
          <p>12:     <inline-formula id="IE95"><mml:math id="IM95" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>u</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>v</mml:mi></mml:mrow></mml:msub><mml:mo>←</mml:mo><mml:mtext>Equation</mml:mtext><mml:mo> </mml:mo><mml:mo> </mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">S</mml:mi><mml:mn>39</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mo> </mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mtext>internal bal</mml:mtext><mml:mo>.</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>13:    <bold>end if</bold></p>
          <p>14:   <bold>else</bold></p>
          <p>15:    <inline-formula id="IE96"><mml:math id="IM96" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>u</mml:mi></mml:mrow></mml:msub><mml:mo>←</mml:mo><mml:mtext>Equation</mml:mtext><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mn>7</mml:mn><mml:mo>)</mml:mo><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mtext>internal unbal</mml:mtext><mml:mo>.</mml:mo><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>16:    <bold>if</bold> <italic toggle="yes">v</italic> is leaf <bold>then</bold></p>
          <p>17:     <inline-formula id="IE97"><mml:math id="IM97" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo>→</mml:mo><mml:mi>v</mml:mi></mml:mrow></mml:msub><mml:mo>←</mml:mo><mml:mtext>Equation</mml:mtext><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mn>12</mml:mn><mml:mo>)</mml:mo><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mtext>terminal</mml:mtext><mml:mo> </mml:mo><mml:mi mathvariant="normal">C</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>18:    <bold>end if</bold></p>
          <p>19:    <bold>for</bold><inline-formula id="IE98"><mml:math id="IM98" display="inline" overflow="scroll"><mml:mrow><mml:mi>w</mml:mi><mml:mo>∈</mml:mo><mml:mi mathvariant="italic">children</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>u</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula><bold>do</bold></p>
          <p>20:     <bold>if</bold> <italic toggle="yes">w</italic> is leaf <bold>and</bold><inline-formula id="IE99"><mml:math id="IM99" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>u</mml:mi><mml:mo>→</mml:mo><mml:mi>w</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> is <bold>null then</bold></p>
          <p>21:      <inline-formula id="IE100"><mml:math id="IM100" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mrow><mml:mi>u</mml:mi><mml:mo>→</mml:mo><mml:mi>w</mml:mi></mml:mrow></mml:msub><mml:mo>←</mml:mo><mml:mtext>Equation</mml:mtext><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mn>10</mml:mn><mml:mo>)</mml:mo><mml:mo> </mml:mo><mml:mo>(</mml:mo><mml:mtext>terminal</mml:mtext><mml:mo> </mml:mo><mml:mi mathvariant="normal">A</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:math></inline-formula></p>
          <p>22:     <bold>end if</bold></p>
          <p>23:    <bold>end for</bold></p>
          <p>24:   <bold>end if</bold></p>
          <p>25:  <bold>end for</bold></p>
          <p>26: <bold>end procedure</bold></p>
        </boxed-text>
      </p>
    </sec>
    <sec>
      <title>2.5 Experimental setup</title>
      <sec>
        <title>2.5.1 Overview</title>
        <p>We performed a simulation study comparing CASTLES to four other methods by estimating branch lengths on the fixed <italic toggle="yes">true</italic> species tree topology. We report error measured as the absolute error averaged over all branches of each tree. Since absolute error hides the contribution of bias versus variance, we also report the mean error (without absolute), which is a valid measure of the bias of a method. Since the mean absolute error emphasizes long branches more than short branches, we also report two metrics that emphasize shorter branches successively more: root mean squared error (RMSE) and mean absolute log error. For all the methods, negative and zero branch lengths are replaced with <inline-formula id="IE101"><mml:math id="IM101" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mn>10</mml:mn></mml:mrow></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math></inline-formula> (the pseudo-count used by RAxML for identical sequences). Since negative lengths are not usable in downstream analyses, this step emulates practice.</p>
        <p>We performed two experiments: The first, using a new simulated quartet dataset, is not meant to be realistic but to examine accuracy under idealized conditions and to show the impact of successively more challenging models of rate variation and the level of ILS. The second experiment uses two previously published simulated datasets with larger (30-taxon and 101-taxon) trees and more realistic settings, and examines the effect of gene tree estimation error (GTEE), the level of ILS, rate heterogeneity and deviation from the molecular clock, and the inclusion of an outgroup. Additional information about the simulation are provided in <xref rid="sup1" ref-type="supplementary-material">Supplementary Appendix, Section S3</xref>.</p>
      </sec>
      <sec>
        <title>2.5.2 Datasets</title>
        <p>To measure the accuracy, we need a species tree with SU branch lengths. The leading simulation method (SimPhy, <xref rid="btad221-B16" ref-type="bibr">Mallo et al. 2016</xref>) produces species trees in the unit of the number of generations (<inline-formula id="IE102"><mml:math id="IM102" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>τ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>). However, SimPhy does select a global substitution rate <inline-formula id="IE103"><mml:math id="IM103" display="inline" overflow="scroll"><mml:mo>ν</mml:mo></mml:math></inline-formula> and assigns a mutation rate multiplier (<inline-formula id="IE104"><mml:math id="IM104" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>) to each species tree branch (<monospace>-hs</monospace> option); setting <inline-formula id="IE105"><mml:math id="IM105" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:mo>ν</mml:mo></mml:mrow></mml:math></inline-formula> matches with the assumed model. Thus, the SU lengths on the species tree can be easily defined as <inline-formula id="IE106"><mml:math id="IM106" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>t</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>τ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mo>ν</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>. Unfortunately, SimPhy does not output the <inline-formula id="IE107"><mml:math id="IM107" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> rates; we modified its code to output these and the species tree with SU lengths. We used this modified version of SimPhy to regenerate species trees used in our datasets mentioned below and confirmed that the same trees are generated. This procedure gives us the ground truth SU lengths. We use SimPhy to evolve gene trees within each model species tree under the MSC, which allows us to explore the impact of ILS on branch length estimation. We quantify the level of ILS using the “Average Distance” (AD) between true species trees and true gene trees, in terms of the normalized Robinson–Foulds (RF) (<xref rid="btad221-B26" ref-type="bibr">Robinson and Foulds 1981</xref>) distance, producing values that can range from <inline-formula id="IE108"><mml:math id="IM108" display="inline" overflow="scroll"><mml:mrow><mml:mn>0</mml:mn><mml:mo>%</mml:mo></mml:mrow></mml:math></inline-formula> (no discordance) to 100% (no shared branches).</p>
        <p><bold>Quartet dataset.</bold> We generated a new quartet dataset using the modified version of SimPhy. We created six different model conditions by changing the level of ILS (by varying population size) and varying rate heterogeneity multipliers. Our model conditions start from a strict molecular clock with no rate variation (i.e. <italic toggle="yes">Homogeneous</italic>) and becomes successively more complex. Next, we add rate variations across species tree branches only (<monospace>-hs</monospace> option), creating a model (<italic toggle="yes">Sp</italic>) akin to MSC + Substitution mentioned earlier. We then create models that have rate variation only across genes but not species (<italic toggle="yes">Loc</italic> using <monospace>-hl</monospace>) and both across species and across genes (<italic toggle="yes">Sp, Loc</italic> using <monospace>-hs -hl</monospace>). Finally, we add rate variations specific to each branch of each gene tree (<italic toggle="yes">Sp, Loc, Sp/Loc</italic>: <monospace>-hs -hl -hg</monospace>), which creates heterotachy; this most complex model is how Simphy is usually used (e.g. in the next datasets) and goes beyond our theoretical model. The first five conditions have an AD = 0.29, indicating a moderate level of ILS. The final condition increases the ILS level to 0.51 AD. Each model condition has 200 replicates, each with 10,000 true gene trees. We intentionally used a large number of true gene trees to verify our formulas and compare methods in an ideal situation. Further details and parameters are provided in <xref rid="sup1" ref-type="supplementary-material">Supplementary Tables S5 and S6</xref>.</p>
        <p><bold>S100 dataset.</bold> We used a 101-taxon simulated dataset from <xref rid="btad221-B38" ref-type="bibr">Zhang et al. (2018)</xref> (100 ingroup and one outgroup), that had model conditions characterized by different levels of GTEE, ranging from 0 (for true gene trees) to 0.55, measured in terms of the RF distance between true and estimated gene trees. The ILS level changes dramatically across replicates (average: 0.46 AD). The estimated gene trees were created using FastTree2 (<xref rid="btad221-B24" ref-type="bibr">Price et al. 2010</xref>). These datasets had 50 replicates, each with 1000 gene trees.</p>
        <p><bold>MVRoot dataset.</bold> We used a 30-taxon dataset from <xref rid="btad221-B15" ref-type="bibr">Mai et al. (2017)</xref> that had model conditions that varied in terms of deviation from the molecular clock and inclusion of an outgroup. Deviation from the clock was specified with the parameter <inline-formula id="IE109"><mml:math id="IM109" display="inline" overflow="scroll"><mml:mo>α</mml:mo></mml:math></inline-formula> of the gamma distribution, choosing 0.15 (<italic toggle="yes">High</italic> variation), 1.5 (<italic toggle="yes">Med</italic>), or 5 (<italic toggle="yes">Low</italic>). This dataset had 100 replicates with 500 gene trees (estimated using FastTree2) in each replicate. The replicates were highly heterogeneous in terms of ILS and GTEE level (average 0.46 AD and 0.38 GTEE across all model conditions).</p>
      </sec>
      <sec>
        <title>2.5.3 Methods compared</title>
        <p>We compare CASTLES to four other methods: concatenation using maximum likelihood, FastME (<xref rid="btad221-B10" ref-type="bibr">Lefort et al. 2015</xref>) on two different distance matrices, and ERaBLE (<xref rid="btad221-B1" ref-type="bibr">Binet et al. 2016</xref>):</p>
        <list list-type="bullet">
          <list-item>
            <p>Concatenation with maximum likelihood using RAxML (<xref rid="btad221-B31" ref-type="bibr">Stamatakis 2014</xref>) is perhaps the dominant method used in the literature, and estimates branch lengths on the given species trees assuming all the sites in the concatenated alignment evolve down a single model tree.</p>
          </list-item>
          <list-item>
            <p>FastME (<xref rid="btad221-B10" ref-type="bibr">Lefort et al. 2015</xref>) can estimate branch lengths using the balanced minimum evolution criterion given a distance matrix. We use it with two distance matrices. First, we compute the patristic (path-length) distance between pairs of taxa for each gene tree using Dendropy (<xref rid="btad221-B32" ref-type="bibr">Sukumaran and Holder 2010</xref>). Genes with no signal (all branch lengths zero) are excluded. We then take either the average or the minimum for each pair across genes. In the absence of rate heterogeneity, the minimum is appropriate and has been used in GLASS and its variants (<xref rid="btad221-B20" ref-type="bibr">Mossel and Roch 2010</xref>).</p>
          </list-item>
          <list-item>
            <p>ERaBLE (<xref rid="btad221-B1" ref-type="bibr">Binet et al. 2016</xref>) is specifically designed for branch-length estimation from a set of gene trees and is similar to FastME but uses weighted means.</p>
          </list-item>
        </list>
      </sec>
    </sec>
  </sec>
  <sec>
    <title>3 Results</title>
    <sec>
      <title>3.1 Quartet simulations</title>
      <p>When considering all conditions, CASTLES has the best accuracy overall (<xref rid="btad221-F2" ref-type="fig">Fig. 2a</xref>). Patristic(MIN) + FastME has the lowest error in conditions with no rate heterogeneity across loci. As soon as rate heterogeneity across loci is added (i.e. <italic toggle="yes">Loc</italic>), it goes from being the best method to being the worst. As expected, the error for all methods tends to increase as the models become more challenging (i.e. more rate variation or higher ILS). In the penultimate condition with default ILS and all sources of rate variation, CASTLES has substantially lower error than alternatives. When ILS is increased, we observe a huge increase in error for ERaBLE and Patristic(AVG) + FastME, but not for Patristic(MIN) + FastME. Since the mean absolute error emphasizes long branches more than short branches, we also examine RMSE and log error (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S11</xref>). The trends with these metrics are very similar to mean absolute error, except that with the log error (emphasizing short branches and long branches alike), Patristic(MIN) + FastME is far worse than the other methods in conditions with rate variation across loci.</p>
      <fig position="float" id="btad221-F2">
        <label>Figure 2.</label>
        <caption>
          <p>Quartet datasets: mean absolute error (a) and bias (b) of branch lengths estimated using different methods. From left to right, the conditions include more rate variation or higher ILS, creating more challenges for branch length estimation. (a) Mean and standard error across replicates in addition to boxplots. The <italic toggle="yes">y</italic>-axis is cut at 0.25, eliminating 16 outlier cases with unusually high errors (none from CASTLES). (b) Mean and standard deviation.</p>
        </caption>
        <graphic xlink:href="btad221f2" position="float"/>
      </fig>
      <p>Switching from accuracy to bias, we observe little or no bias for CASTLES for terminal branches in all conditions except at the highest ILS level (<xref rid="btad221-F2" ref-type="fig">Fig. 2b</xref> and <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S12</xref>). In contrast, ERaBLE and Patristic(AVG) + FastME, have a clear over-estimation bias for terminal branches, and Patristic(MIN) + FastME has a clear underestimation bias (for all branches), except in the absence of rate variation across genes (signified by <italic toggle="yes">Loc</italic>). Terminal branches seem particularly biased in the condition with the highest rate variation and the highest level of ILS. In this condition, while CASTLES does seem to have some bias for terminal branches, it is far less biased than alternative methods. Comparing the last two conditions, we observe that higher ILS has a larger impact on bias than rate variation. In contrast to terminal branches, for internal branches, ERaBLE and Patristic(AVG) + FastME also have low bias (slightly lower than CASTLES).</p>
    </sec>
    <sec>
      <title>3.2 101-taxon ILS simulations</title>
      <p>On this dataset, CASTLES has the best accuracy across all model conditions, followed by Patristic(AVG) + FastME and ERaBLE, which are very similar to each other (<xref rid="btad221-F3" ref-type="fig">Fig. 3b</xref>). Concat + RAxML has substantially higher errors than these three methods that use gene trees as input. However, Patristic(MIN) + FastME has the highest error in all conditions. These patterns remain largely similar, according to the RMSE and log error (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S14</xref>).</p>
      <fig position="float" id="btad221-F3">
        <label>Figure 3.</label>
        <caption>
          <p>101-taxon datasets: mean and standard error of mean absolute error (a) and mean and standard deviation of bias (b) of branch lengths estimated using different methods. The average GTEE level varies between 0% (for true gene trees) to 23% (for 1600 bp) and then to 55% (for the 200 bp sequences). The number of genes is 1000 and the results are shown across 50 replicates. The <italic toggle="yes">y</italic>-axis is cut at 0.045, eliminating ten outlier cases (none from CASTLES). (c) Running time (log scale), including distance matrix calculation and species tree annotation (by mean branch lengths) but not gene tree estimation; concatenation includes branch length estimation for fixed topology.</p>
        </caption>
        <graphic xlink:href="btad221f3" position="float"/>
      </fig>
      <p>CASTLES shows no substantial bias for terminal branches regardless of the level of gene tree error and a small bias for internal branches (<xref rid="btad221-F3" ref-type="fig">Fig. 3</xref> and <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S13</xref>). This bias is toward under-estimation for true gene trees and gradually moves toward over-estimation as gene tree error increases. In contrast to CASTLES, ERaBLE, Patristic(AVG) + FastME, and Concat + RAxML have a large over-estimation bias for terminal branches. ERaBLE and Patristic(AVG) + FastME have a negligible bias for internal branches. Concat + RAxML has the highest over-estimation bias and is the only method with a substantial over-estimation bias for internal branches. Patristic(MIN) + FastME has a large under-estimation bias. Similar to quartet simulations, all methods are less biased for internal branches than terminal ones. Comparing conditions, we observe that the level of gene tree error has a relatively small impact on under/overestimation for all the methods tested.</p>
      <p>On this relatively large dataset, we also examine running times and observe that CASTLES is substantially faster than alternatives (<xref rid="btad221-F3" ref-type="fig">Fig. 3c</xref>). Note that gene tree estimation running time is not included for methods based on gene trees because those are often inferred <italic toggle="yes">regardless</italic> of branch length estimation. Concat + RaxML becomes successively slower and uses more memory (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S15</xref>) as the genes become longer. In the most extreme case, CASTLES can be more than an order of magnitude faster than Concat + RAxML.</p>
    </sec>
    <sec>
      <title>3.3 30-taxon MVRoot simulations</title>
      <p>On the 30-taxon MVRoot datasets, we further evaluate the impact of outgroups, deviation from the clock, and ILS level (<xref rid="btad221-F4" ref-type="fig">Fig. 4</xref>). Whether an outgroup is included and independent of deviation from the clock, CASTLES has the lowest error (<xref rid="btad221-F4" ref-type="fig">Fig. 4a</xref>). On these datasets, CASTLES has no discernible bias, ERaBLE, Patristic(AVG) + FastME and Concat + RAxML have a bias toward over-estimation (see an example replicate in <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S19a</xref>), and Patristic(MIN) + FastME has a more severe bias toward under-estimation; outgroup inclusion and deviation from the clock impact the bias of methods only marginally (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S16</xref>). For all methods, including an outgroup leads to an increase in the mean absolute error (<xref rid="btad221-F4" ref-type="fig">Fig. 4a</xref>). Increasing deviation from the clock does not substantially impact the accuracy of CASTLES or other methods (<xref rid="btad221-F4" ref-type="fig">Fig. 4</xref> and <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S16</xref>).</p>
      <fig position="float" id="btad221-F4">
        <label>Figure 4.</label>
        <caption>
          <p>30-taxon MVRoot dataset. (a) Mean absolute error of estimated branch lengths on the 30-taxon MVRoot dataset, with or without an outgroup and with different levels of deviation from a strict clock. The number of genes is 500 and the results are shown across 100 replicates; the <italic toggle="yes">y</italic>-axis is cut at 0.11, leaving 16 outliers out of the graph (one from CASTLES). (b) Focusing on cases without outgroups, we divide replicates based on their level of true gene tree discordance due to ILS into four groups. We show mean log error to control for the correlation between ILS and branch length. Patristic(MIN) + FastME has mean log error above 2 (see <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S18</xref>) and is excluded.</p>
        </caption>
        <graphic xlink:href="btad221f4" position="float"/>
      </fig>
      <p>To compare across levels of ILS, we resort to the logarithmic error because true branch lengths correlate with ILS (i.e. are shorter for higher ILS), and hence, the absolute error confuses the interpretation of the impact of ILS. Across all ILS levels (<xref rid="btad221-F4" ref-type="fig">Fig. 4b</xref>), Patristic(MIN) + FastME has very poor performance in terms of log error and is not further discussed below. With the lowest ILS, CASTLES and Concat + RAxML have very similar performance. As ILS increases, all methods become less accurate, but CASTLES degrades in accuracy <italic toggle="yes">slower</italic> than the rest of the methods and hence dominates the other methods for accuracy, with ERaBLE in second place. Concat + RAxML matches CASTLES for the lowest ILS but gradually moves to be the second least accurate of all methods (only better than Patristic(MIN) + FastME) at the highest ILS level. In fact, Concat + RAxML is substantially more sensitive to ILS (<inline-formula id="IE110"><mml:math id="IM110" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>=</mml:mo><mml:mn>0.57</mml:mn></mml:mrow></mml:math></inline-formula> Pearson correlation with AD; <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S17</xref>) than CASTLES (<inline-formula id="IE111"><mml:math id="IM111" display="inline" overflow="scroll"><mml:mrow><mml:msup><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>=</mml:mo><mml:mn>0.23</mml:mn></mml:mrow></mml:math></inline-formula>). Comparing the relative accuracy of methods as ILS changes using the mean absolute error shows similar trends (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S18</xref>) with one notable difference: Concat + RAxML is <italic toggle="yes">better</italic> than CASTLES at the lowest ILS level but is worse in other conditions (just as with the log error).</p>
    </sec>
    <sec>
      <title>3.4 Mammalian biological dataset</title>
      <p>We apply CASTLES and Concat + RAxML on the 37-taxon mammalian dataset of <xref rid="btad221-B30" ref-type="bibr">Song et al. (2012)</xref> (perhaps the first paper that used concatenation to estimate branch lengths on a species tree estimated using a summary method) after removing 23 mislabeled gene trees, retaining 424 genes (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S19b</xref>). We observe patterns similar to the simulated dataset. Branch lengths tend to be longer using Concat + RAxML than using CASTLES (<xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S20</xref>). For example, primates are roughly twice as distant from the root of placental mammals in the Concat + RAxML tree as they are in the CASTLES tree. While the two trees are similar in their longest branches and have similar diameters (i.e. from rat to platypus), many of the other internal branches are substantially shorter in CASTLES. While the truth is not known on real data, we note that a similar pattern is observed in simulations, and in simulations, Concat + RAxML is biased toward over-estimation; in contrast, CASTLES is far less biased (e.g. <xref rid="sup1" ref-type="supplementary-material">Supplementary Fig. S19a</xref>).</p>
    </sec>
  </sec>
  <sec>
    <title>4 Discussion</title>
    <p>Although CASTLES was almost universally more accurate than the competing methods, comparisons across the experiments revealed some interesting trends. Concatenation performed well on low ILS cases and much worse with high ILS, as expected. Increasing ILS did increase error for all methods but also note that more ILS in our simulation is often (though not always) accompanied by shorter branch lengths, which are in general harder to estimate (<xref rid="sup1" ref-type="supplementary-material">Supplementary Figs S12 and S13</xref>). However, the fact that concatenation degraded in accuracy faster than other methods as ILS increased confirmed that it is less able to deal with gene tree discordance. Thus, the current standard method (concatenation) does suffer from a predictable shortcoming. CASTLES is meant to address that shortcoming.</p>
    <p>We observed that estimating terminal branches was harder than internal branches across all datasets for all methods other than CASTLES. As we expected, methods that ignore coalescent (e.g. concatenation and FastME based on <italic toggle="yes">average</italic> patristic distance) had a consistent overestimation bias. What was surprising was that this overestimation showed its effects more on terminal branches than internal branches. The reasons for this clear trend are not clear to us.</p>
    <p>Another consistent pattern was that including an outgroup reduced accuracy for all methods and especially for CASTLES. Outgroups are often connected via long branches and have been found problematic for phylogenetic inference and downstream analyses (<xref rid="btad221-B11" ref-type="bibr">Li et al. 2012</xref>). Our results suggest that they can also confound SU branch length estimation. While not surprising, this pattern suggests that unless the outgroup is needed for a downstream analysis, the outgroups should be removed after rooting the species tree and before estimating branch length.</p>
    <p>We surprisingly saw little impact caused by GTEE and deviation from a clock. The robustness to deviation from the strict clock can perhaps be explained by the fact that none of the methods used here other than Patristic(MIN) + FastME assume a clock. Note that in CASTLES, even with our simplifying assumptions, each branch is at the end assigned a different mutation rate (the calculation of which assumes surrounding branches have the same rate). The lack of sensitivity to per-gene signal (controlled here by sequence length) is more surprising, especially for the coalescent-based CASTLES. One possibility is that while short sequences can affect the estimated gene tree topologies, they have a more subdued effect on distances within gene trees (<xref rid="btad221-B19" ref-type="bibr">Moshiri and Mirarab 2018</xref>); thus, even given short sequences, estimated branch lengths (which change in a continuous space) are broadly consistent with true values, especially when averaged over genes. In contrast, CU branch lengths are sensitive to gene tree error, but these are not used in CASTLES.</p>
    <p>Our theory did not explicitly discuss rate heterogeneity across genes. However, across-gene rate changes do not impact our calculations under reasonable models of rate variation. Assume that each gene tree is scaled up or down by a constant factor drawn i.i.d. from some rate multiplier distribution with expected value one and independently from the MSC process. Under any such model, all the derived expected values remain intact and hence the method remains valid. It is easy to see the same is not true for GLASS-like distances that involve taking the minimum across genes: they only work if all the genes have equal rates. When rates of evolution of genes are allowed to vary, as the number of genes goes to infinity, all estimated branch lengths go to zero; a pattern that would imply under-estimation bias, as we observed in our data. More broadly, if rate changes are not i.i.d and correlate with other factors such as missing data, accounting for them becomes far more difficult.</p>
    <p>Finally, we note that the estimation of terminal branches in CASTLES is sensitive to rooting of the species tree; hence, care must be applied in rooting the species tree before running CASTLES. When an outgroup is not available, the species tree root is identifiable under the MSC and can be inferred using QR-STAR (<xref rid="btad221-B33" ref-type="bibr">Tabatabaee et al. 2022a</xref>,<xref rid="btad221-B34" ref-type="bibr">b</xref>) in a statistically consistent manner. Alternative methods such as tripVote (<xref rid="btad221-B14" ref-type="bibr">Mai and Mirarab 2022</xref>) or methods that assume a strict molecular clock (e.g. midpoint rooting) are also available, though they do not enjoy the same theoretical guarantees.</p>
  </sec>
  <sec>
    <title>5 Conclusion</title>
    <p>We proposed CASTLES, a method for estimating branch lengths of a given species tree using gene tree branch lengths. CASTLES uses derivations made under the MSC model to design a set of coalescent-based equations that correct for the fact that under the MSC, gene trees can be substantially longer than the species tree. Our study provided evidence that CASTLES produces highly accurate branch lengths in substitution units (SUs), improving on prior methods under a wide range of model conditions.</p>
    <p>There are several directions for future work. For example, the derivation of CASTLES assumed that the input gene trees differed from the species tree due to ILS alone. This work could be extended to the case where genes evolve within the species tree due to gene duplication and loss as well as ILS. Developing methods for branch length estimation in that context could be potentially enabled through the DISCO (<xref rid="btad221-B36" ref-type="bibr">Willson et al. 2022</xref>) technique, which replaces every gene family tree by a set of single-copy gene trees, which could then be passed to CASTLES for branch length estimation on the given species tree. A related question left for future work is whether CASTLES is robust to the presence of horizontal transfer or gene flow. Finally, the behavior of the method should be tested when inputs have low taxon occupancy across genes.</p>
    <p>Another question of interest is whether CASTLES is a statistically consistent estimator of SU branch lengths. Given that CASTLES is coalescent-based and that we use expected values under the model, we consider this likely, but two technical challenges need to be addressed. First, for the method to be consistent, we need the model to be identifiable, and we did not establish identifiability in this article. Thus, we ask: Is it possible to design different sets of mutation rates and CU lengths that lead to the same patterns of gene tree distribution? If not, are the expected values enough to uniquely identify branch lengths or are higher moments necessary? Moreover, while we had a system of equations that could be optimized directly, we opted for a more stable approach that had several simplifications. It is possible (and perhaps likely) that those simplifications could result in inconsistent branch length estimation. These questions will need to be addressed in future work, and may require that we explore a more complex estimation scheme that does not rely on simplifications.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material id="sup1" position="float" content-type="local-data">
      <label>btad221_Supplementary_Data</label>
      <media xlink:href="btad221_supplementary_data.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
</body>
<back>
  <sec>
    <title>Supplementary data</title>
    <p><xref rid="sup1" ref-type="supplementary-material">Supplementary data</xref> are available at <italic toggle="yes">Bioinformatics</italic> online.</p>
  </sec>
  <sec sec-type="COI-statement">
    <title>Conflict of interest</title>
    <p>None declared.</p>
  </sec>
  <sec>
    <title>Funding</title>
    <p>This work was supported in part by funds from the National Science Foundation (NSF: 1845967, 1636933, and 1920920) and by the National Institute of Health (1R35GM142725).</p>
  </sec>
  <sec sec-type="data-availability">
    <title>Data availability</title>
    <p>The code, datasets, and scripts used in this study are available at <ext-link xlink:href="https://github.com/ytabatabaee/CASTLES" ext-link-type="uri">https://github.com/ytabatabaee/CASTLES</ext-link>.</p>
  </sec>
  <ref-list id="ref1">
    <title>References</title>
    <ref id="btad221-B1">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Binet</surname><given-names>M</given-names></string-name>, <string-name><surname>Gascuel</surname><given-names>O</given-names></string-name>, <string-name><surname>Scornavacca</surname><given-names>C</given-names></string-name></person-group><etal>et al</etal><article-title>Fast and accurate branch lengths estimation for phylogenomic trees</article-title>. <source>BMC Bioinformatics</source><year>2016</year>;<volume>17</volume>:<fpage>23</fpage>.<pub-id pub-id-type="pmid">26744021</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B2">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Bromham</surname><given-names>L</given-names></string-name>, <string-name><surname>Penny</surname><given-names>D.</given-names></string-name></person-group><article-title>The modern molecular clock</article-title>. <source>Nat Rev Genet</source><year>2003</year>;<volume>4</volume>:<fpage>216</fpage>–<lpage>24</lpage>.<pub-id pub-id-type="pmid">12610526</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B3">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Faith</surname><given-names>DP.</given-names></string-name></person-group><article-title>Quantifying biodiversity: a phylogenetic perspective</article-title>. <source>Conserv Biol</source><year>2002</year>;<volume>16</volume>:<fpage>248</fpage>–<lpage>52</lpage>.<pub-id pub-id-type="pmid">35701968</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B4">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Felsenstein</surname><given-names>J.</given-names></string-name></person-group><article-title>Phylogenies and the comparative method</article-title>. <source>Am Nat</source><year>1985</year>;<volume>125</volume>:<fpage>1</fpage>–<lpage>147</lpage>.</mixed-citation>
    </ref>
    <ref id="btad221-B5">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Hahn</surname><given-names>MW</given-names></string-name>, <string-name><surname>De Bie</surname><given-names>T</given-names></string-name>, <string-name><surname>Stajich</surname><given-names>JE</given-names></string-name></person-group><etal>et al</etal><article-title>Estimating the tempo and mode of gene family evolution from comparative genomic data</article-title>. <source>Genome Res</source><year>2005</year>;<volume>15</volume>:<fpage>1153</fpage>–<lpage>60</lpage>.<pub-id pub-id-type="pmid">16077014</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B6">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Kosakovsky Pond</surname><given-names>SL</given-names></string-name>, <string-name><surname>Frost</surname><given-names>SDW.</given-names></string-name></person-group><article-title>Not so different after all: a comparison of methods for detecting amino acid sites under selection</article-title>. <source>Mol Biol Evol</source><year>2005</year>;<volume>22</volume>:<fpage>1208</fpage>–<lpage>22</lpage>.<pub-id pub-id-type="pmid">15703242</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B7">
      <mixed-citation publication-type="book"><person-group person-group-type="editor"><string-name><surname>Kubatko</surname><given-names>L</given-names></string-name>, <string-name><surname>Knowles</surname><given-names>LL</given-names></string-name></person-group> (eds). <source>Species Tree Inference: A Guide to Methods and Applications</source>. Princeton NJ: <publisher-name>Princeton University Press</publisher-name>, <year>2023</year>.</mixed-citation>
    </ref>
    <ref id="btad221-B8">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Kumar</surname><given-names>S.</given-names></string-name></person-group><article-title>Molecular clocks: four decades of evolution</article-title>. <source>Nat Rev Genet</source><year>2005</year>;<volume>6</volume>:<fpage>654</fpage>–<lpage>62</lpage>.<pub-id pub-id-type="pmid">16136655</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B9">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Lanfear</surname><given-names>R</given-names></string-name>, <string-name><surname>Welch</surname><given-names>JJ</given-names></string-name>, <string-name><surname>Bromham</surname><given-names>L.</given-names></string-name></person-group><article-title>Watching the clock: studying variation in rates of molecular evolution between species</article-title>. <source>Trends Ecol Evol</source><year>2010</year>;<volume>25</volume>:<fpage>495</fpage>–<lpage>503</lpage>.<pub-id pub-id-type="pmid">20655615</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B10">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Lefort</surname><given-names>V</given-names></string-name>, <string-name><surname>Desper</surname><given-names>R</given-names></string-name>, <string-name><surname>Gascuel</surname><given-names>O.</given-names></string-name></person-group><article-title>FastME 2.0: a comprehensive, accurate, and fast distance-based phylogeny inference program</article-title>. <source>Mol Biol Evol</source><year>2015</year>;<volume>32</volume>:<fpage>2798</fpage>–<lpage>800</lpage>.<pub-id pub-id-type="pmid">26130081</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B11">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Li</surname><given-names>C</given-names></string-name>, <string-name><surname>Matthes-Rosana</surname><given-names>KA</given-names></string-name>, <string-name><surname>Garcia</surname><given-names>M</given-names></string-name></person-group><etal>et al</etal><article-title>Phylogenetics of chondrichthyes and the problem of rooting phylogenies with distant outgroups</article-title>. <source>Mol Phylogenet Evol</source><year>2012</year>;<volume>63</volume>:<fpage>365</fpage>–<lpage>73</lpage>.<pub-id pub-id-type="pmid">22300842</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B12">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Liu</surname><given-names>L</given-names></string-name>, <string-name><surname>Yu</surname><given-names>L</given-names></string-name>, <string-name><surname>Edwards</surname><given-names>SV.</given-names></string-name></person-group><article-title>A maximum pseudo-likelihood approach for estimating species trees under the coalescent model</article-title>. <source>BMC Evol Biol</source><year>2010</year>;<volume>10</volume>:<fpage>302</fpage>.<pub-id pub-id-type="pmid">20937096</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B13">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Lozupone</surname><given-names>C</given-names></string-name>, <string-name><surname>Knight</surname><given-names>R.</given-names></string-name></person-group><article-title>UniFrac : a new phylogenetic method for comparing microbial communities</article-title>. <source>Appl Environ Microbiol</source><year>2005</year>;<volume>71</volume>:<fpage>8228</fpage>–<lpage>35</lpage>.<pub-id pub-id-type="pmid">16332807</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B14">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Mai</surname><given-names>U</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S.</given-names></string-name></person-group><article-title>Completing gene trees without species trees in sub-quadratic time</article-title>. <source>Bioinformatics</source><year>2022</year>;<volume>38</volume>:<fpage>1532</fpage>–<lpage>41</lpage>.<pub-id pub-id-type="pmid">34978565</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B15">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Mai</surname><given-names>U</given-names></string-name>, <string-name><surname>Sayyari</surname><given-names>E</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S.</given-names></string-name></person-group><article-title>Minimum variance rooting of phylogenetic trees and implications for species tree reconstruction</article-title>. <source>PLoS One</source><year>2017</year>;<volume>12</volume>:<fpage>e0182238</fpage>.<pub-id pub-id-type="pmid">28800608</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B16">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Mallo</surname><given-names>D</given-names></string-name>, <string-name><surname>De Oliveira Martins</surname><given-names>L</given-names></string-name>, <string-name><surname>Posada</surname><given-names>D.</given-names></string-name></person-group><article-title>SimPhy : phylogenomic simulation of gene, locus, and species trees</article-title>. <source>Syst Biol</source><year>2016</year>;<volume>65</volume>:<fpage>334</fpage>–<lpage>44</lpage>.<pub-id pub-id-type="pmid">26526427</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B17">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Mirarab</surname><given-names>S</given-names></string-name>, <string-name><surname>Reaz</surname><given-names>R</given-names></string-name>, <string-name><surname>Bayzid</surname><given-names>MS</given-names></string-name></person-group><etal>et al</etal><article-title>ASTRAL: genome-scale coalescent-based species tree estimation</article-title>. <source>Bioinformatics</source><year>2014</year>;<volume>30</volume>:<fpage>i541</fpage>–<lpage>8</lpage>.<pub-id pub-id-type="pmid">25161245</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B18">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Moody</surname><given-names>ER</given-names></string-name>, <string-name><surname>Mahendrarajah</surname><given-names>TA</given-names></string-name>, <string-name><surname>Dombrowski</surname><given-names>N</given-names></string-name></person-group><etal>et al</etal><article-title>An estimate of the deepest branches of the tree of life from ancient vertically evolving genes</article-title>. <source>eLife</source><year>2022</year>;<volume>11</volume>:<fpage>e66695</fpage>.<pub-id pub-id-type="pmid">35190025</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B19">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Moshiri</surname><given-names>N</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S.</given-names></string-name></person-group><article-title>A two-state model of tree evolution and its applications to Alu retrotransposition</article-title>. <source>Syst Biol</source><year>2018</year>;<volume>67</volume>:<fpage>475</fpage>–<lpage>89</lpage>.<pub-id pub-id-type="pmid">29165679</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B20">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Mossel</surname><given-names>E</given-names></string-name>, <string-name><surname>Roch</surname><given-names>S.</given-names></string-name></person-group><article-title>Incomplete lineage sorting: consistent phylogeny estimation from multiple loci</article-title>. <source>IEEE/ACM Trans Comput Biol Bioinform</source><year>2010</year>;<volume>7</volume>:<fpage>166</fpage>–<lpage>71</lpage>.<pub-id pub-id-type="pmid">20150678</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B21">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Ogilvie</surname><given-names>HA</given-names></string-name>, <string-name><surname>Bouckaert</surname><given-names>RR</given-names></string-name>, <string-name><surname>Drummond</surname><given-names>AJ.</given-names></string-name></person-group><article-title>StarBEAST2 brings faster species tree inference and accurate estimates of substitution rates</article-title>. <source>Mol Biol Evol</source><year>2017</year>;<volume>34</volume>:<fpage>2101</fpage>–<lpage>14</lpage>.<pub-id pub-id-type="pmid">28431121</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B22">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>O’Meara</surname><given-names>BC.</given-names></string-name></person-group><article-title>Evolutionary inferences from phylogenies: a review of methods</article-title>. <source>Ann Rev Ecol Evol Syst</source><year>2012</year>;<volume>43</volume>:<fpage>267</fpage>–<lpage>85</lpage>.</mixed-citation>
    </ref>
    <ref id="btad221-B23">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Pamilo</surname><given-names>P</given-names></string-name>, <string-name><surname>Nei</surname><given-names>M.</given-names></string-name></person-group><article-title>Relationships between gene trees and species trees</article-title>. <source>Mol Biol Evol</source><year>1988</year>;<volume>5</volume>:<fpage>568</fpage>–<lpage>83</lpage>.<pub-id pub-id-type="pmid">3193878</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B24">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Price</surname><given-names>MN</given-names></string-name>, <string-name><surname>Dehal</surname><given-names>PS</given-names></string-name>, <string-name><surname>Arkin</surname><given-names>AP.</given-names></string-name></person-group><article-title>FastTree-2—approximately maximum-likelihood trees for large alignments</article-title>. <source>PLoS One</source><year>2010</year>;<volume>5</volume>:<fpage>e9490</fpage>.<pub-id pub-id-type="pmid">20224823</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B25">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Rannala</surname><given-names>B.</given-names></string-name></person-group><article-title>The art and science of species delimitation</article-title>. <source>Curr Zool</source><year>2015</year>;<volume>61</volume>:<fpage>846</fpage>–<lpage>53</lpage>.</mixed-citation>
    </ref>
    <ref id="btad221-B26">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Robinson</surname><given-names>D</given-names></string-name>, <string-name><surname>Foulds</surname><given-names>L.</given-names></string-name></person-group><article-title>Comparison of phylogenetic trees</article-title>. <source>Math Biosci</source><year>1981</year>;<volume>53</volume>:<fpage>131</fpage>–<lpage>47</lpage>.</mixed-citation>
    </ref>
    <ref id="btad221-B27">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Roch</surname><given-names>S</given-names></string-name>, <string-name><surname>Steel</surname><given-names>M.</given-names></string-name></person-group><article-title>Likelihood-based tree reconstruction on a concatenation of aligned sequence data sets can be statistically inconsistent</article-title>. <source>Theor Popul Biol</source><year>2015</year>;<volume>100</volume>:<fpage>56</fpage>–<lpage>62</lpage>.</mixed-citation>
    </ref>
    <ref id="btad221-B28">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Rokas</surname><given-names>A</given-names></string-name>, <string-name><surname>Williams</surname><given-names>BL</given-names></string-name>, <string-name><surname>King</surname><given-names>N</given-names></string-name></person-group><etal>et al</etal><article-title>Genome-scale approaches to resolving incongruence in molecular phylogenies</article-title>. <source>Nature</source><year>2003</year>;<volume>425</volume>:<fpage>798</fpage>–<lpage>804</lpage>.<pub-id pub-id-type="pmid">14574403</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B29">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Sayyari</surname><given-names>E</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S.</given-names></string-name></person-group><article-title>Fast coalescent-based computation of local branch support from quartet frequencies</article-title>. <source>Mol Biol Evol</source><year>2016</year>;<volume>33</volume>:<fpage>1654</fpage>–<lpage>68</lpage>.<pub-id pub-id-type="pmid">27189547</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B30">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Song</surname><given-names>S</given-names></string-name>, <string-name><surname>Liu</surname><given-names>L</given-names></string-name>, <string-name><surname>Edwards</surname><given-names>SV</given-names></string-name></person-group><etal>et al</etal><article-title>Resolving conflict in eutherian mammal phylogeny using phylogenomics and the multispecies coalescent model</article-title>. <source>Proc Natl Acad Sci USA</source><year>2012</year>;<volume>109</volume>:<fpage>14942</fpage>–<lpage>7</lpage>.<pub-id pub-id-type="pmid">22930817</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B31">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Stamatakis</surname><given-names>A.</given-names></string-name></person-group><article-title>RAxML version 8: a tool for phylogenetic analysis and post-analysis of large phylogenies</article-title>. <source>Bioinformatics</source><year>2014</year>;<volume>30</volume>:<fpage>1312</fpage>–<lpage>3</lpage>.<pub-id pub-id-type="pmid">24451623</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B32">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Sukumaran</surname><given-names>J</given-names></string-name>, <string-name><surname>Holder</surname><given-names>MT.</given-names></string-name></person-group><article-title>DendroPy: a Python library for phylogenetic computing</article-title>. <source>Bioinformatics</source><year>2010</year>;<volume>26</volume>:<fpage>1569</fpage>–<lpage>71</lpage>.<pub-id pub-id-type="pmid">20421198</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B33">
      <mixed-citation publication-type="other"><person-group person-group-type="author"><string-name><surname>Tabatabaee</surname><given-names>Y</given-names></string-name>, <string-name><surname>Roch</surname><given-names>S</given-names></string-name>, <string-name><surname>Warnow</surname><given-names>T.</given-names></string-name></person-group> Statistically consistent rooting of species trees under the multispecies coalescent model. In: Tang, H. (eds) <italic toggle="yes">Research in Computational Molecular Biology. RECOMB 2023. Lecture Notes in Computer Science()</italic>, Vol. 13976. Cham: Springer. <pub-id pub-id-type="doi">10.1007/978-3-031-29119-7_3</pub-id>.</mixed-citation>
    </ref>
    <ref id="btad221-B34">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Tabatabaee</surname><given-names>Y</given-names></string-name>, <string-name><surname>Sarker</surname><given-names>K</given-names></string-name>, <string-name><surname>Warnow</surname><given-names>T.</given-names></string-name></person-group><article-title>Quintet rooting: rooting species trees under the multi-species coalescent model</article-title>. <source>Bioinformatics</source><year>2022b</year>;<volume>38</volume>:<fpage>i109</fpage>–<lpage>17</lpage>.<pub-id pub-id-type="pmid">35758805</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B35">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Volz</surname><given-names>EM</given-names></string-name>, <string-name><surname>Koelle</surname><given-names>K</given-names></string-name>, <string-name><surname>Bedford</surname><given-names>T.</given-names></string-name></person-group><article-title>Viral phylodynamics</article-title>. <source>PLoS Comput Biol</source><year>2013</year>;<volume>9</volume>:<fpage>e1002947</fpage>.<pub-id pub-id-type="pmid">23555203</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B36">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Willson</surname><given-names>J</given-names></string-name>, <string-name><surname>Roddur</surname><given-names>MS</given-names></string-name>, <string-name><surname>Liu</surname><given-names>B</given-names></string-name></person-group><etal>et al</etal><article-title>DISCO: species tree inference using multicopy gene family tree decomposition</article-title>. <source>Syst Biol</source><year>2022</year>;<volume>71</volume>:<fpage>610</fpage>–<lpage>29</lpage>.<pub-id pub-id-type="pmid">34450658</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B37">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Zhang</surname><given-names>C</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S.</given-names></string-name></person-group><article-title>Weighting by gene tree uncertainty improves accuracy of quartet-based species trees</article-title>. <source>Mol Biol Evol</source><year>2022</year>;<volume>39</volume>:<fpage>msac215</fpage>.<pub-id pub-id-type="pmid">36201617</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B38">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Zhang</surname><given-names>C</given-names></string-name>, <string-name><surname>Rabiee</surname><given-names>M</given-names></string-name>, <string-name><surname>Sayyari</surname><given-names>E</given-names></string-name></person-group><etal>et al</etal><article-title>ASTRAL-III: polynomial time species tree reconstruction from partially resolved gene trees</article-title>. <source>BMC Bioinformatics</source><year>2018</year>;<volume>19</volume>:<fpage>153</fpage>.<pub-id pub-id-type="pmid">29745866</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B39">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Zhu</surname><given-names>Q</given-names></string-name>, <string-name><surname>Mai</surname><given-names>U</given-names></string-name>, <string-name><surname>Pfeiffer</surname><given-names>W</given-names></string-name></person-group><etal>et al</etal><article-title>Phylogenomics of 10,575 genomes reveals evolutionary proximity between domains bacteria and archaea</article-title>. <source>Nat Commun</source><year>2019</year>;<volume>10</volume>:<fpage>5477</fpage>.<pub-id pub-id-type="pmid">31792218</pub-id></mixed-citation>
    </ref>
    <ref id="btad221-B40">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Zimmermann</surname><given-names>T</given-names></string-name>, <string-name><surname>Mirarab</surname><given-names>S</given-names></string-name>, <string-name><surname>Warnow</surname><given-names>T.</given-names></string-name></person-group><article-title>BBCA: improving the scalability of *BEAST using random binning</article-title>. <source>BMC Genomics</source><year>2014</year>;<volume>15</volume>:<fpage>1</fpage>–<lpage>9</lpage>.<pub-id pub-id-type="pmid">24382143</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
