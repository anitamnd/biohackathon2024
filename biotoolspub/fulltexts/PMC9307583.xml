<?DTDIdentifier.IdentifierValue -//ES//DTD journal article DTD version 5.6.0//EN//XML?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName art560.dtd?>
<?SourceDTD.Version 5.6.0?>
<?ConverterInfo.XSLTName elsevier2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<?origin publisher?>
<?FILEmeta_XPRO101578 xml ?>
<?FILEmain xml ?>
<?FILEmain pdf ?>
<?FILEgr1 jpg ?>
<?FILEgr2 jpg ?>
<?FILEgr3 jpg ?>
<?FILEgr4 jpg ?>
<?FILEgr5 jpg ?>
<?FILEgr6 jpg ?>
<?FILEgr7 jpg ?>
<?FILEgr8 jpg ?>
<?FILEfx1 jpg ?>
<?FILEfx2 jpg ?>
<?FILEfx3 jpg ?>
<?properties open_access?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">STAR Protoc</journal-id>
    <journal-id journal-id-type="iso-abbrev">STAR Protoc</journal-id>
    <journal-title-group>
      <journal-title>STAR Protocols</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2666-1667</issn>
    <publisher>
      <publisher-name>Elsevier</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">9307583</article-id>
    <article-id pub-id-type="pii">S2666-1667(22)00458-0</article-id>
    <article-id pub-id-type="doi">10.1016/j.xpro.2022.101578</article-id>
    <article-id pub-id-type="publisher-id">101578</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Protocol</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>scQUEST: Quantifying tumor ecosystem heterogeneity from mass or flow cytometry data</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" id="au1">
        <name>
          <surname>Martinelli</surname>
          <given-names>Adriano Luca</given-names>
        </name>
        <email>art@zurich.ibm.com</email>
        <xref rid="aff1" ref-type="aff">1</xref>
        <xref rid="fn1" ref-type="fn">5</xref>
        <xref rid="cor1" ref-type="corresp">∗</xref>
      </contrib>
      <contrib contrib-type="author" id="au2">
        <name>
          <surname>Wagner</surname>
          <given-names>Johanna</given-names>
        </name>
        <xref rid="aff2" ref-type="aff">2</xref>
      </contrib>
      <contrib contrib-type="author" id="au3">
        <name>
          <surname>Bodenmiller</surname>
          <given-names>Bernd</given-names>
        </name>
        <xref rid="aff3" ref-type="aff">3</xref>
        <xref rid="aff4" ref-type="aff">4</xref>
      </contrib>
      <contrib contrib-type="author" id="au4">
        <name>
          <surname>Rapsomaniki</surname>
          <given-names>Maria Anna</given-names>
        </name>
        <email>aap@zurich.ibm.com</email>
        <xref rid="aff1" ref-type="aff">1</xref>
        <xref rid="fn2" ref-type="fn">6</xref>
        <xref rid="cor2" ref-type="corresp">∗∗</xref>
      </contrib>
      <aff id="aff1"><label>1</label>IBM Research Europe, Saeumerstrasse 4, CH-8803 Rueschlikon, Switzerland</aff>
      <aff id="aff2"><label>2</label>Division of Translational Medical Oncology, German Cancer Research Center (DKFZ), Im Neuenheimer Feld 581, 69120 Heidelberg, Germany</aff>
      <aff id="aff3"><label>3</label>Department of Quantitative Biomedicine, University of Zurich, Winterthurerstrasse 190, 8057 Zurich, Switzerland</aff>
      <aff id="aff4"><label>4</label>Institute of Molecular Health Sciences, ETH Zurich, Otto-Stern-Weg 7, 8093 Zurich, Switzerland</aff>
    </contrib-group>
    <author-notes>
      <corresp id="cor1"><label>∗</label>Corresponding author <email>art@zurich.ibm.com</email></corresp>
      <corresp id="cor2"><label>∗∗</label>Corresponding author <email>aap@zurich.ibm.com</email></corresp>
      <fn id="fn1">
        <label>5</label>
        <p id="ntpara0010">Technical contact</p>
      </fn>
      <fn id="fn2">
        <label>6</label>
        <p id="ntpara0015">Lead contact</p>
      </fn>
    </author-notes>
    <pub-date pub-type="pmc-release">
      <day>20</day>
      <month>7</month>
      <year>2022</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on <pub-date
						pub-type="epub">.-->
    <pub-date pub-type="collection">
      <day>16</day>
      <month>9</month>
      <year>2022</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>20</day>
      <month>7</month>
      <year>2022</year>
    </pub-date>
    <volume>3</volume>
    <issue>3</issue>
    <elocation-id>101578</elocation-id>
    <permissions>
      <copyright-statement>© 2022 The Author(s)</copyright-statement>
      <copyright-year>2022</copyright-year>
      <license>
        <ali:license_ref xmlns:ali="http://www.niso.org/schemas/ali/1.0/" specific-use="textmining" content-type="ccbyncndlicense">https://creativecommons.org/licenses/by-nc-nd/4.0/</ali:license_ref>
        <license-p>This is an open access article under the CC BY-NC-ND license (http://creativecommons.org/licenses/by-nc-nd/4.0/).</license-p>
      </license>
    </permissions>
    <abstract id="abs0010">
      <title>Summary</title>
      <p>With mass and flow cytometry, millions of single-cell profiles with dozens of parameters can be measured to comprehensively characterize complex tumor ecosystems. Here, we present scQUEST, an open-source Python library for cell type identification and quantification of tumor ecosystem heterogeneity in patient cohorts. We provide a step-by-step protocol on the application of scQUEST on our previously generated human breast cancer single-cell atlas using mass cytometry and discuss how it can be adapted and extended for other datasets and analyses.</p>
      <p>For complete details on the use and execution of this protocol, please refer to <xref rid="bib22" ref-type="bibr">Wagner et al. (2019)</xref>.</p>
    </abstract>
    <abstract abstract-type="graphical" id="abs0015">
      <title>Graphical abstract</title>
      <fig id="undfig1" position="anchor">
        <graphic xlink:href="fx1"/>
      </fig>
    </abstract>
    <abstract abstract-type="author-highlights" id="abs0020">
      <title>Highlights</title>
      <p>
        <list list-type="simple" id="ulist0010">
          <list-item id="u0010">
            <label>•</label>
            <p id="p0010">Tumor ecosystems exhibit a strong degree of phenotypic heterogeneity</p>
          </list-item>
          <list-item id="u0015">
            <label>•</label>
            <p id="p0015">scQUEST facilitates the analysis of large cytometry datasets with millions of cells</p>
          </list-item>
          <list-item id="u0020">
            <label>•</label>
            <p id="p0020">scQUEST implements scores to quantify tumor heterogeneity based on phenotypic profiles</p>
          </list-item>
          <list-item id="u0025">
            <label>•</label>
            <p id="p0025">All scores are easily customizable allowing users to adapt them to their needs</p>
          </list-item>
        </list>
      </p>
    </abstract>
    <abstract abstract-type="editor-highlights" id="abs0025">
      <p>Publisher’s note: Undertaking any experimental protocol requires adherence to local institutional guidelines for laboratory safety and ethics.</p>
    </abstract>
    <abstract abstract-type="teaser" id="abs0030">
      <p>With mass and flow cytometry, millions of single-cell profiles with dozens of parameters can be measured to comprehensively characterize complex tumor ecosystems. Here, we present scQUEST, an open-source Python library for cell type identification and quantification of tumor ecosystem heterogeneity in patient cohorts. We provide a step-by-step protocol on the application of scQUEST on our previously generated human breast cancer single-cell atlas using mass cytometry and discuss how it can be adapted and extended for other datasets and analyses.</p>
    </abstract>
    <kwd-group id="kwrds0010">
      <title>Subject areas</title>
      <kwd>Bioinformatics</kwd>
      <kwd>Single Cell</kwd>
      <kwd>Flow Cytometry/Mass Cytometry</kwd>
      <kwd>Cancer</kwd>
    </kwd-group>
  </article-meta>
</front>
<body>
  <sec id="sec1">
    <title>Before you begin</title>
    <p id="p0035">Cancer is a tissue disease in which tumor cells and cells of the microenvironment form an ecosystem that drives tumor progression and therapy response. Current single-cell technologies generate highly multiplexed profiles for millions of cells and up to hundreds of patients, thus allowing unprecedented insights into the complexity of tumor ecosystem biology. However, new computational challenges arise from large datasets with millions of cells. These datasets can be prohibitive in terms of computational resources for available clustering algorithms that partition high-dimensional data into populations, thus hindering cell type identification and annotation. Another challenge is the quantification of different aspects of tumor heterogeneity. Although several computational scores that quantify heterogeneity from single-cell genomics, transcriptomics or proteomics measurements have been proposed in recent years (<xref rid="bib10" ref-type="bibr">Kashyap et al., 2022</xref>; <xref rid="bib16" ref-type="bibr">Martinelli and Rapsomaniki, 2022</xref>), data-driven approaches that directly learn tumor heterogeneity patterns from those measurements are largely missing.</p>
    <p id="p0040">The following protocol has been designed for mass cytometry data but can also be directly applied to flow cytometry data. Several common mass cytometry data preprocessing steps should be performed before starting this protocol, including data normalization, deconvolution of cellular barcodes, and signal compensation (<xref rid="bib3" ref-type="bibr">Chevrier et al., 2018</xref>). Deconvolution and signal compensation are also important steps for flow cytometry data.</p>
    <sec id="sec1.1">
      <title>Data preprocessing</title>
      <p id="p0045">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: ∼1 day</bold>
          </p>
        </disp-quote>
        <list list-type="simple" id="olist0010">
          <list-item id="o0010">
            <label>1.</label>
            <p id="p0050"><bold>Normalization</bold>: During long mass cytometry data acquisitions, changes in instrument performance can introduce signal variation over time (<xref rid="bib4" ref-type="bibr">Finck et al., 2013</xref>). To address this, metal-containing polystyrene beads are measured together with the biological samples and the bead-derived signature is then used to correct (normalize) occurring signal fluctuations post-acquisition (<xref rid="bib3" ref-type="bibr">Chevrier et al., 2018</xref>).</p>
          </list-item>
          <list-item id="o0015">
            <label>2.</label>
            <p id="p0055"><bold>Deconvolution of sample barcodes</bold>: To minimize inter-sample antibody staining variation, sample multiplexing can be achieved through mass-tag barcoding or fluorescent cell barcoding (<xref rid="bib13" ref-type="bibr">Krutzik and Nolan, 2006</xref>; <xref rid="bib23" ref-type="bibr">Zunder et al., 2015</xref>). Here, unique combinations of barcoding reagents are used to stain individual samples, which can then be pooled for staining with an antibody master mix. Computational deconvolution of barcodes allows the direct comparison of signal intensities for dozens of samples (<xref rid="bib3" ref-type="bibr">Chevrier et al., 2018</xref>).</p>
          </list-item>
          <list-item id="o0020">
            <label>3.</label>
            <p id="p0060"><bold>Signal compensation</bold>: Current mass cytometry and flow cytometry applications allow the simultaneous assessment of 40 and more antibody targets per cell. As reporters, mass cytometry employs heavy metal isotopes as antibody tags and flow cytometry uses fluorescent dyes. Both approaches suffer from signal crosstalk between detection channels and require signal compensation prior to data analysis. Channel crosstalk is more pronounced in flow cytometry due to the broad emission spectra of fluorochromes that lead to spillover effects, than in mass cytometry, where it is caused by isotopic impurities, oxidation, and instrument properties. In both approaches, single-stained controls are used to generate a compensation matrix, which can be applied to the data post-acquisition for signal compensation, e.g., using commercial software like FlowJo<sup>TM</sup> (BD Life Sciences) and Cytobank (<xref rid="bib12" ref-type="bibr">Kotecha et al., 2010</xref>), or the R package CATALYST (<xref rid="bib3" ref-type="bibr">Chevrier et al., 2018</xref>).</p>
          </list-item>
        </list>
      </p>
    </sec>
  </sec>
  <sec id="sec8">
    <title>Key resources table</title>
    <p id="p1115">
      <table-wrap position="float" id="undtbl1">
        <table frame="hsides" rules="groups">
          <thead>
            <tr>
              <th>REAGENT or RESOURCE</th>
              <th>SOURCE</th>
              <th>IDENTIFIER</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="3">
                <bold>Deposited data</bold>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <hr/>
              </td>
            </tr>
            <tr>
              <td>Mass cytometry .fcs files</td>
              <td>(<xref rid="bib22" ref-type="bibr">Wagner et al., 2019</xref>)</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.17632/gb83sywsjc.2" id="intref6910">https://doi.org/10.17632/gb83sywsjc.2</ext-link>
              </td>
            </tr>
            <tr>
              <td>Mass cytometry .fcs files</td>
              <td>(<xref rid="bib15" ref-type="bibr">Levine et al., 2015</xref>)</td>
              <td>
                <ext-link ext-link-type="doi" xlink:href="10.1016/j.cell.2015.05.047" id="intref0040">https://doi.org/10.1016/j.cell.2015.05.047</ext-link>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <hr/>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <bold>Software and algorithms</bold>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <hr/>
              </td>
            </tr>
            <tr>
              <td>scQUEST</td>
              <td>This work</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://github.com/AI4SCR/scQUEST" id="intref0045">https://github.com/AI4SCR/scQUEST</ext-link>
                <break/>
                <ext-link ext-link-type="doi" xlink:href="10.5281/zenodo.6666907" id="intref0050">https://doi.org/10.5281/zenodo.6666907</ext-link>
              </td>
            </tr>
            <tr>
              <td>Tutorial: Application of scQUEST</td>
              <td>This work</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://ai4scr.github.io/scQUEST/scQUEST_tutorial.html" id="intref0055">https://ai4scr.github.io/scQUEST/scQUEST_tutorial.html</ext-link>
              </td>
            </tr>
            <tr>
              <td>Tutorial: Application of scQUEST to AML data</td>
              <td>This work</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://ai4scr.github.io/scQUEST/scQUEST_AML_tutorial.html" id="intref0060">https://ai4scr.github.io/scQUEST/scQUEST_AML_tutorial.html</ext-link>
              </td>
            </tr>
            <tr>
              <td>Tutorial: How to customize scQUEST</td>
              <td>This work</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://ai4scr.github.io/scQUEST/Custom_models.html" id="intref0065">https://ai4scr.github.io/scQUEST/Custom_models.html</ext-link>
              </td>
            </tr>
            <tr>
              <td>Tutorial: How to process .fcs files and create AnnData objects</td>
              <td>This work</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://ai4scr.github.io/scQUEST/process-fcs-files-and-create-annData-object.html" id="intref0070">https://ai4scr.github.io/scQUEST/process-fcs-files-and-create-annData-object.html</ext-link>
              </td>
            </tr>
            <tr>
              <td>Tutorial: Downsampling and clustering</td>
              <td>This work</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://ai4scr.github.io/scQUEST/tutorial_on_downsampling_and_clustering.html" id="intref0075">https://ai4scr.github.io/scQUEST/tutorial_on_downsampling_and_clustering.html</ext-link>
              </td>
            </tr>
            <tr>
              <td>Online documentation</td>
              <td>This work</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://ai4scr.github.io/scQUEST" id="intref0080">https://ai4scr.github.io/scQUEST</ext-link>
              </td>
            </tr>
            <tr>
              <td>Miniconda</td>
              <td>N/A</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://docs.conda.io/en/latest/miniconda.html" id="intref0085">https://docs.conda.io/en/latest/miniconda.html</ext-link>
              </td>
            </tr>
            <tr>
              <td>AnnData</td>
              <td>(<xref rid="bib21" ref-type="bibr">Virshup et al., 2021</xref>)</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://github.com/theislab/anndata" id="intref0090">https://github.com/theislab/anndata</ext-link>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <hr/>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <bold>Other</bold>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <hr/>
              </td>
            </tr>
            <tr>
              <td>
                <list list-type="simple" id="ulist0130">
                  <list-item id="u0030">
                    <p id="p1120">Hardware:</p>
                  </list-item>
                  <list-item id="u0035">
                    <label>•</label>
                    <p id="p1125">Memory: 8 GB required, 16GB recommended.</p>
                  </list-item>
                  <list-item id="u0040">
                    <label>•</label>
                    <p id="p1130">Processors: 1 required, 4 recommended.</p>
                  </list-item>
                </list>
              </td>
              <td>N/A</td>
              <td>N/A</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
    </p>
  </sec>
  <sec id="sec2">
    <title>Step-by-step method details</title>
    <sec id="sec2.1">
      <title>Install scQUEST and download dataset</title>
      <p id="p0065">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 15–30 min</bold>
          </p>
        </disp-quote>
      </p>
      <p id="p0070">scQUEST is a Python package that runs on all operating systems (Windows, Linux, and MAC OSX) with Python (ideally version 3.8) installed. To simplify the installation process, we recommend using Miniconda (<xref rid="sec8" ref-type="sec">key resources table</xref>), as described below. The minimal hardware requirements to complete this protocol largely depend on the dataset used. As an example, to successfully complete this protocol using the supplied mass cytometry dataset of ∼13.5 million cells, a system with 16 GB of RAM is recommended. A detailed Jupyter Notebook tutorial with step-by-step instructions to reproduce all results and figures of this protocol is supplied (<xref rid="sec8" ref-type="sec">key resources table</xref>). Although prior knowledge of popular Python libraries (e.g., numpy, matplotlib, pandas) is a plus, it is still possible to follow all steps of the protocol using the supplied code in the Jupyter Notebook. Furthermore, additional detailed tutorials demonstrate how users can customize the analysis to fit their dataset or question or interest (<xref rid="sec8" ref-type="sec">key resources table</xref>). scQUEST runs on top of AnnData, a Python package for handling annotated single-cell datasets. For users without prior experience with AnnData, we strongly recommend the corresponding paper (<xref rid="bib21" ref-type="bibr">Virshup et al., 2021</xref>) (<xref rid="sec8" ref-type="sec">key resources table</xref>) to familiarize themselves with the structure of the AnnData object prior to executing this protocol. To simplify the use of this protocol, a pre-uploaded version of the mass cytometry dataset measured with the tumor epithelial cell-centric antibody panel from <xref rid="bib22" ref-type="bibr">Wagner et al. (2019)</xref> is included in scQUEST as an AnnData object. The dataset measured with the immune cell-centric antibody panel from <xref rid="bib22" ref-type="bibr">Wagner et al. (2019)</xref> is not included here and can be found in the original publication (<xref rid="sec8" ref-type="sec">key resources table</xref>). For users interested in using scQUEST with their own mass or flow cytometry data, we also provide a simple tutorial that illustrates how to load and process .fcs files, and construct an AnnData object (<xref rid="sec8" ref-type="sec">key resources table</xref>). We note that in our original paper <xref rid="bib22" ref-type="bibr">Wagner et al. (2019)</xref>, our analyses focused on patient samples for which both a tumor epithelial cell-centric and an immune cell-centric measurement was available, resulting in 144 breast tumor and 50 non-tumor tissue samples. Since the original tumor epithelial cell centric-only measurements involved 23 additional tumor samples and nine additional non-tumor samples, we included these in the dataset provided with this protocol (AnnData object), resulting in the final dataset of 226 samples from 163 patients. We next outline all major steps and explain how to tailor the protocol to different datasets or analyses.<list list-type="simple" id="olist0015"><list-item id="o0025"><label>1.</label><p id="p0075">Installation:<list list-type="simple" id="olist0020"><list-item id="o0030"><label>a.</label><p id="p0080">If you are new to Python, install the latest version of Miniconda (<xref rid="sec8" ref-type="sec">key resources table</xref>) according to your system specifications.</p></list-item><list-item id="o0035"><label>b.</label><p id="p0085">Once Miniconda is installed, open up your system terminal/console, create and activate a new virtual environment by typing:<boxed-text id="dtbox1"><p id="p0090">&gt; conda create -y -n scquest python=3.8</p><p id="p0095">&gt; conda activate scquest</p></boxed-text></p></list-item><list-item id="o0040"><label>c.</label><p id="p0110">Install scQUEST:<boxed-text id="dtbox3"><p id="p0115">&gt; pip installai4scr-scQUEST</p></boxed-text></p></list-item><list-item id="o0045"><label>d.</label><p id="p0125">Install Jupyter Notebook:<boxed-text id="dtbox5"><p id="p0130">&gt; pip install jupyterlab</p></boxed-text></p><p id="p0135">Download the supplied Jupyter Notebook tutorial (<xref rid="sec8" ref-type="sec">key resources table</xref>).<boxed-text id="dtbox6"><p id="p0140">&gt; curl -o scQUEST_tutorial.ipynb<ext-link ext-link-type="uri" xlink:href="https://raw.githubusercontent.com/AI4SCR/scQUEST/master/tutorials/scQUEST_tutorial.ipynb" id="intref0020">https://raw.githubusercontent.com/AI4SCR/scQUEST/master/tutorials/scQUEST_tutorial.ipynb</ext-link></p></boxed-text></p></list-item><list-item id="o0050"><label>e.</label><p id="p0155">In your terminal/console, fire up a Jupyter Notebook by typing:<boxed-text id="dtbox9"><p id="p0160">&gt; jupyter notebook scQUEST_tutorial.ipynb</p></boxed-text></p><p id="p0165">Alternatively, you can run the notebook on a remote host (e.g., an HPC environment). To do that, start the server on the remote:<boxed-text id="dtbox10"><p id="p0170">&gt; jupyter notebook scQUEST_tutorial.ipynb --no-browser --port=8080</p></boxed-text></p><p id="p0175">and setup an SSH tunnel. On your local machine run:<boxed-text id="dtbox11"><p id="p0180">&gt; ssh -L 8080:localhost:8080 &lt;REMOTE_USER&gt;@&lt;REMOTE_HOST&gt;</p></boxed-text><disp-quote><p><bold><italic>Note:</italic></bold> scQUEST automatically installs all dependencies, such as pandas, PyTorch, sklearn, and AnnData.</p></disp-quote></p></list-item></list></p></list-item></list><list list-type="simple" id="olist0025"><list-item id="o0055"><label>2.</label><p id="p0200">Explore example dataset:<list list-type="simple" id="olist0030"><list-item id="o0060"><label>a.</label><p id="p0205">Load pre-uploaded mass cytometry dataset in an AnnData object by simply typing:<boxed-text id="dtbox15"><p id="p0210">&gt; ad = scq.dataset.breastCancerAtlasRaw()</p></boxed-text></p></list-item><list-item id="o0065"><label>b.</label><p id="p0220">Explore the AnnData object:<boxed-text id="dtbox17"><p id="p0225">&gt; ad</p></boxed-text></p></list-item><list-item id="o0070"><label>c.</label><p id="p0235">Notice that ad contains 13,384,828 single-cell measurements of 68 channels (stored in .X) with channel annotations (stored in .var). Cell-level annotations (stored in .obs) include various patient metadata, such as tissue type of origin or patient ID (patient_number).</p></list-item></list></p></list-item></list></p>
    </sec>
    <sec id="sec2.2">
      <title>Cell type assignment</title>
      <p id="p0240">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 1–2 h</bold>
          </p>
        </disp-quote>
      </p>
      <p id="p0245">Identification of cell populations of interest is a common task in cytometry-based single-cell analyses, performed traditionally through gating, or, more recently, using clustering algorithms (e.g., PhenoGraph (<xref rid="bib15" ref-type="bibr">Levine et al., 2015</xref>) or FlowSOM (<xref rid="bib19" ref-type="bibr">Van Gassen et al., 2015</xref>)). An emerging challenge is that often, the acquired single-cell measurements are in the order of millions of cells, which prohibits analyzing the whole dataset at once. A common solution is subsampling, which however implies that a large part of data will be discarded. In our previous work (<xref rid="bib22" ref-type="bibr">Wagner et al., 2019</xref>), we were interested in detecting cells of an epithelial phenotype among our ∼13.5 million single-cells dataset stained with 37 different antibodies, and designed an alternative approach to overcome this challenge. The main idea behind our approach was to cluster and annotate a smaller, representative subset of the whole dataset, acquired by a custom down-sampling approach (<xref rid="fig1" ref-type="fig">Figure 1</xref>A, Tutorial: Downsampling and clustering, <xref rid="sec8" ref-type="sec">key resources table</xref>). This smaller dataset was clustered using PhenoGraph (<xref rid="bib15" ref-type="bibr">Levine et al., 2015</xref>), resulting in 42 clusters, which were in turn annotated as epithelial based on the expression of one or more of the following epithelial markers: Epithelial cell adhesion molecule (EpCAM), E-Cadherin, cytokeratin 5 (K5), K7, K8, K14, K18, and/or a pan-cytokeratin marker. All clusters negative for all the above markers were labeled as non-epithelial (<xref rid="fig1" ref-type="fig">Figure 1</xref>B). The single-cell proteomic measurements with their class assignments were used to train a neural network classifier (<xref rid="fig1" ref-type="fig">Figure 1</xref>C), that, once trained, was used to classify the remaining data into epithelial or non-epithelial (<xref rid="fig1" ref-type="fig">Figure 1</xref>D). Here, we show how to perform these steps using the same annotated dataset, which is also supplied with scQUEST.<list list-type="simple" id="olist0035"><list-item id="o0075"><label>3.</label><p id="p0250">Load and explore the annotated dataset, ad_anno:<boxed-text id="dtbox19"><p id="p0255">&gt; ad_anno = scq.dataset.breastCancerAtlas()</p></boxed-text><list list-type="simple" id="olist0040"><list-item id="o0080"><label>a.</label><p id="p0260">Notice how ad_anno consists of 687,161 single-cell measurements that have been previously clustered in 42 clusters (cluster label found in .obs['cluster']).</p></list-item><list-item id="o0085"><label>b.</label><p id="p0265">The 42 clusters have in turn been annotated as epithelial or non-epithelial based on marker expression. We see that in total, there are 484,279 non-epithelial and 202,882 epithelial cells (information included in .obs[celltype_class]).<disp-quote><p><inline-graphic xlink:href="fx3.gif"/><bold>CRITICAL:</bold> When working with your own data, you can use your algorithm of choice to cluster and annotate the single-cell measurements. It is critical, however, that the smaller, subsampled dataset that you will annotate is representative of the whole population of cells you want to analyze. See also <xref rid="sec5" ref-type="sec">troubleshooting</xref> for more information on how to evaluate the quality of your annotated dataset.</p></disp-quote></p></list-item></list></p></list-item></list><list list-type="simple" id="olist0045"><list-item id="o0090"><label>4.</label><p id="p0270">Prepare the dataset for classification:<list list-type="simple" id="olist0050"><list-item id="o0095"><label>a.</label><p id="p0275">First, subset the dataset such that it only contains the features/markers relevant for the classification (typically, the ones used for annotating the data).</p></list-item><list-item id="o0100"><label>b.</label><p id="p0280">Create a binary integer label with 0: non-epithelial and 1: epithelial:<boxed-text id="dtbox20"><p id="p0285">&gt; ad_anno.obs['is_epithelial'] = (ad_anno.obs.celltype_class == 'epithelial').astype(int)</p></boxed-text></p></list-item><list-item id="o0105"><label>c.</label><p id="p0295">Apply the inverse hyperbolic sine (arcsinh) transformation and save the transformed data in a new layer of the AnnData object:<boxed-text id="dtbox22"><p id="p0300">&gt; X = ad_anno.X.copy()</p><p id="p0305">&gt; cofactor = 5</p><p id="p0310">&gt; np.divide(X, cofactor, out=X)</p><p id="p0315">&gt; np.arcsinh(X, out=X)</p><p id="p0320">&gt; ad_anno.layers['arcsinh'] = X</p></boxed-text></p></list-item><list-item id="o0110"><label>d.</label><p id="p0350">Normalize the data from 0 to 1 using a min-max scaler and save the results in a new layer of the AnnData object:<boxed-text id="dtbox24"><p id="p0355">&gt; minMax = MinMaxScaler()</p><p id="p0360">&gt; X = minMax.fit_transform(X)</p><p id="p0365">&gt; ad_anno.layers['arcsinh_norm'] = X</p></boxed-text><disp-quote><p><bold><italic>Note:</italic></bold> Before training the classifier, you can visualize the data distribution per channel for epithelial and non-epithelial cells (<xref rid="fig2" ref-type="fig">Figure 2</xref>). Notable differences in abundance for multiple marker channels are observed, among which are the epithelial markers (e.g., EpCAM, E-Cadherin), as expected.</p></disp-quote><fig id="fig2"><label>Figure 2</label><caption><p>Distribution of marker expression per channel for epithelial (orange) and non-epithelial cells (blue) in the annotated training dataset</p></caption><graphic xlink:href="gr2"/></fig></p></list-item></list></p></list-item></list><list list-type="simple" id="olist0055"><list-item id="o0115"><label>5.</label><p id="p0385">Train the neural network classifier:<list list-type="simple" id="olist0060"><list-item id="o0120"><label>a.</label><p id="p0390">Initialize the model by setting the dimensions of the input layer equal to the number of markers in the training data. Also set a seed for reproducibility:<boxed-text id="dtbox26"><p id="p0395">&gt; clf = scq.Classifier(n_in=ad_anno.shape[1], seed=1)</p></boxed-text></p></list-item><list-item id="o0125"><label>b.</label><p id="p0405">Train the classifier:<boxed-text id="dtbox28"><p id="p0410">&gt; clf.fit(ad_anno, layer='arcsinh_norm', target='is_epithelial', max_epochs=20, seed=1)</p></boxed-text><disp-quote><p><bold><italic>Note:</italic></bold> By default, the model architecture consists of 1 hidden layer of 20 neurons with a ReLU activation function and one output layer of two neurons. The dataset is split in a stratified fashion into training (90%) and test (10%) sets. Of the training set, 10% are used to validate the model. The classifier is trained using the Adam optimizer (<xref rid="bib11" ref-type="bibr">Kingma and Ba, 2017</xref>) with a learning rate of 0.001 and a batch size of 256. Its performance is evaluated using a standard cross-entropy loss function. Training is finalized after 20 epochs; we further use an early stopping criterion by terminating training when the model’s performance fails to improve for 10 consecutive runs. In our online documentation (<xref rid="sec8" ref-type="sec">key resources table</xref>), we provide an example on how to create custom model architectures.</p></disp-quote></p></list-item><list-item id="o0130"><label>c.</label><p id="p0420">Examine model performance by assessing the performance of the classifier in the test data. Some additional ways to evaluate the model is by observing the evolution of the loss, the percentage of accurately predicted epithelial or non-epithelial cells in the form of a confusion matrix and the ROC curve (<xref rid="fig3" ref-type="fig">Figure 3</xref>).<disp-quote><p><inline-graphic xlink:href="fx3.gif"/><bold>CRITICAL:</bold> If the model fails during training, a number of issues may be the reason. Check <xref rid="sec5" ref-type="sec">troubleshooting</xref> for possible solutions. It is important to make sure that your model is not overfitting the data. Overfitting occurs when the model fits precisely the training data, but cannot generalize to unseen test data. To learn how to detect and avoid overfitting, check <xref rid="sec5" ref-type="sec">troubleshooting</xref>.</p></disp-quote><fig id="fig3"><label>Figure 3</label><caption><p>Assessing the performance of the classifier</p><p>(A) Evolution of the loss during model training, with training loss indicated in blue, validation loss indicated in orange, and test loss indicated in green.</p><p>(B and C) Confusion matrix and (C) receiver operator characteristic (ROC) curve, indicating very high accuracy in predicting epithelial and non-epithelial cells.</p></caption><graphic xlink:href="gr3"/></fig><fig id="fig4"><label>Figure 4</label><caption><p>UMAP projection of all single-cell measurements, marked with blue hues for non-epithelial cells (dark blue: annotated, light blue: predicted) and orange hues for epithelial cells (dark orange: annotated, light orange: predicted)</p></caption><graphic xlink:href="gr4"/></fig></p></list-item></list></p></list-item></list><list list-type="simple" id="olist0065"><list-item id="o0135"><label>6.</label><p id="p0425">Once you are confident about the model performance, you can use the trained classifier to predict all epithelial cells across in the ∼13.5 million cell measurements:<list list-type="simple" id="olist0070"><list-item id="o0140"><label>a.</label><p id="p0430">Again, prepare the whole dataset for classification by applying an arcsinh transformation and scaling the data, as in step 4c:<boxed-text id="dtbox30"><p id="p0435">  &gt; ad_pred = ad[:, ad.var.used_in_clf]</p><p id="p0440">  &gt; X = ad_pred.X.copy()</p><p id="p0445">  &gt; np.divide(X, cofactor, out=X)</p><p id="p0450">  &gt; np.arcsinh(X, out=X)</p><p id="p0455">  &gt; ad_pred.layers['arcsinh'] = X</p><p id="p0460">&gt; X = minMax.transform(X)</p><p id="p0465">&gt; ad_pred.layers['arcsinh_norm'] = X</p></boxed-text><disp-quote><p><inline-graphic xlink:href="fx3.gif"/><bold>CRITICAL:</bold> When scaling the unseen data, it is important to apply the min-max scaler that was fitted on the training data without re-fitting it on the new data (use transform instead of fit_transform).</p></disp-quote></p></list-item><list-item id="o0145"><label>b.</label><p id="p0505">Feed the data to the classifier and save the results:<boxed-text id="dtbox32"><p id="p0510">&gt; clf.predict(ad_pred, layer='arcsinh_norm')</p><p id="p0515">&gt; ad.obs['is_epithelial'] = ad_pred.obs.clf_is_epithelial.values</p></boxed-text></p></list-item><list-item id="o0150"><label>c.</label><p id="p0530">Examining the final classification results, you can see that the model classified the ∼13.5 million cells into ∼3.97 million epithelial cells and ∼9.4 million non-epithelial cells. The classification results can be further examined, for example by generating a dimensionality reduction uniform manifold approximation and projection (UMAP) plot (<xref rid="bib25" ref-type="bibr">McInnes et al., 2018</xref>). The UMAP plot shows the expected separation of epithelial and non-epithelial cells and at the same time, annotated and predicted cells of each respective class are well-mixed (<xref rid="fig4" ref-type="fig">Figure 4</xref>).</p></list-item></list></p></list-item></list><fig id="fig1"><label>Figure 1</label><caption><p>Workflow for cell type assignment from single-cell mass cytometry data</p><p>(A) Random subsampling step for large datasets.</p><p>(B) Clustering of the data, cluster annotation by class based on the respective marker expression profiles, and labeling of each cell according to class.</p><p>(C) Splitting the annotated data and using the training set to train a neural network to achieve an accurate class prediction for each cell. The test set is used to evaluate the model performance.</p><p>(D) Using the trained neural network to assign the remaining cells to their respective class based on the marker expression profile. Some figure elements have been adapted from <xref rid="bib22" ref-type="bibr">Wagner et al. (2019)</xref>.</p></caption><graphic xlink:href="gr1"/></fig></p>
    </sec>
    <sec id="sec2.3">
      <title>Phenotypic abnormality score</title>
      <p id="p0535">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 1–2 h</bold>
          </p>
        </disp-quote>
      </p>
      <p id="p0540">Tumor cell heterogeneity is believed to be a source of cancer aggressiveness and an obstacle for complete elimination of tumor cells during therapy (<xref rid="bib17" ref-type="bibr">Ramos and Bentires-Alj, 2015</xref>). Molecular phenotypic deviation of breast tumor cells from normal mammary epithelial cells is routinely assessed in the clinic and has prognostic value, e.g., protein levels of estrogen receptor (ER), progesterone receptor (PR), human epidermal growth factor receptor 2 (HER2), and proliferation marker Ki-67 (<xref rid="bib1" ref-type="bibr">Amin et al., 2017</xref>). In our previous work, we showed how a type of unsupervised artificial neural network called an autoencoder (<xref rid="bib6" ref-type="bibr">Goodfellow et al., 2016</xref>; <xref rid="bib8" ref-type="bibr">Hinton and Salakhutdinov, 2006</xref>) could be used to comprehensively describe the phenotypic abnormality of breast tumor cells in relation to non-cancerous mammary epithelial cells. Briefly, we first trained a “reference” autoencoder with epithelial cells derived from juxta-tumoral non-cancerous mammary gland tissue so it could reconstruct their proteomic phenotypes (<xref rid="fig5" ref-type="fig">Figure 5</xref>A). We then fed the trained autoencoder with a “query” dataset with tumor-derived epithelial cells to determine how much they had deviated from the reference phenotypes. The autoencoder calculated a mean squared error (MSE) of the reconstruction for each tumor cell, which represented the phenotypic abnormality (dissimilarity) of that cell to non-cancerous tissue-derived cells (<xref rid="fig5" ref-type="fig">Figure 5</xref>B). A <italic>tumor-based</italic> phenotypic abnormality score was computed as the median score of all epithelial cells of a sample (<xref rid="fig5" ref-type="fig">Figure 5</xref>C), and a <italic>tissue-based</italic> phenotypic abnormality score was computed as the median score of all cells of a tissue type (<xref rid="fig5" ref-type="fig">Figure 5</xref>D). In our previous work, we observed a correlation of tumor phenotypic abnormality with features of abnormal growth conditions within the tumor ecosystem, such as a high number of cells positive for the proliferation marker Ki-67 and cells positive for the hypoxia marker carbonic anhydrase 9 (<xref rid="bib22" ref-type="bibr">Wagner et al., 2019</xref>).<fig id="fig5"><label>Figure 5</label><caption><p>Steps to compute the phenotypic abnormality scores per cell, tumor, and tissue type</p><p>(A) Epithelial cells from juxta-tumoral tissue are used to train an autoencoder, which computes a reconstruction error for each cell.</p><p>(B) Tumor-derived epithelial cells are fed to the trained autoencoder and a reconstruction error is computed for each cell.</p><p>(C and D) From this, the median reconstruction error can be calculated per sample (C) and per tissue type (D). Some figure elements have been adapted from <xref rid="bib22" ref-type="bibr">Wagner et al. (2019)</xref>.</p></caption><graphic xlink:href="gr5"/></fig></p>
      <p id="p0545">Here, we explain how to follow the same approach using as example the epithelial measurements of the supplied data.<list list-type="simple" id="olist0075"><list-item id="o0155"><label>7.</label><p id="p0550">Prepare dataset:<list list-type="simple" id="olist0080"><list-item id="o0160"><label>a.</label><p id="p0555">Select a list of patient samples (patients) that will serve as reference (<italic>optional</italic>).</p></list-item><list-item id="o0165"><label>b.</label><p id="p0560">Similarly, select a list of markers (markers) as features of the input data.</p></list-item><list-item id="o0170"><label>c.</label><p id="p0565">Subset the whole ad dataset to include only epithelial cells (ad.obs.is_epithelial == 1) from juxta-tumoral tissue (ad.obs.tissue_type == 'N') of the selected patient samples (ad.obs.patient_number.isin(patients)) and markers (ad.var.used_in_abnormality):<boxed-text id="dtbox34"><p id="p0570">&gt; ad_train = ad[(ad.obs.patient_number.isin(patients)) &amp; (ad.obs.tissue_type == 'N') &amp; (ad.obs.is_epithelial == 1), ad.var.used_in_abnormality]</p></boxed-text></p></list-item><list-item id="o0175"><label>d.</label><p id="p0580">Preprocess the dataset by applying the arcsinh transformation and min-max normalization, as in step 4c.</p></list-item></list></p></list-item></list><list list-type="simple" id="olist0085"><list-item id="o0180"><label>8.</label><p id="p0585">Train the abnormality autoencoder:<list list-type="simple" id="olist0090"><list-item id="o0185"><label>a.</label><p id="p0590">Initialize the model by setting the dimensions of the input/output layer equal to the number of markers in the training data:<boxed-text id="dtbox36"><p id="p0595">&gt; Abn = scq.Abnormality(n_in=ad_train.shape[1])</p></boxed-text></p></list-item><list-item id="o0190"><label>b.</label><p id="p0605">Fit the model to the training data:<boxed-text id="dtbox38"><p id="p0610">&gt; Abn.fit(ad_train, layer='arcsinh_norm', max_epochs=20)</p></boxed-text></p></list-item><list-item id="o0195"><label>c.</label><p id="p0620">As in step 5c, the model performance can be evaluated in terms of the evolution of the loss.</p></list-item></list></p></list-item><list-item id="o0200"><label>9.</label><p id="p0625">Use the trained abnormality autoencoder to reconstruct all epithelial cell measurements:<list list-type="simple" id="olist0100"><list-item id="o0205"><label>a.</label><p id="p0630">Select markers and preprocess the data<boxed-text id="dtbox40"><p id="p0635">ad_pred = ad[ad.obs.is_epithelial == 1, ad.var.used_in_abnormality]</p><p id="p0640">X = ad_pred.X.copy()</p><p id="p0645">np.divide(X, cofactor, out=X)</p><p id="p0650">np.arcsinh(X, out=X)</p><p id="p0655">X = minMax.transform(X)</p><p id="p0660">ad_pred.layers['arcsinh_norm'] = X</p></boxed-text></p></list-item><list-item id="o0210"><label>b.</label><p id="p0695">Reconstruct the measurements and estimate the mean squared error (MSE):<boxed-text id="dtbox42"><p id="p0700">Abn.predict(ad_pred, layer='arcsinh_norm')</p><p id="p0705">mse = (ad_pred.layers['abnormality'] ∗∗ 2).mean(axis=1)</p><p id="p0710">ad_pred.obs['abnormality'] = mse</p></boxed-text></p></list-item><list-item id="o0215"><label>c.</label><p id="p0730">Examine the results across all juxta-tumoral tissue, mammoplasty, and tumor-derived epithelial cells by visualizing and comparing the min-max-normalized protein levels of the input data (<xref rid="fig6" ref-type="fig">Figure 6</xref>A) with the reconstructed data (<xref rid="fig6" ref-type="fig">Figure 6</xref>B) and the resulting reconstruction errors, called residuals (<xref rid="fig6" ref-type="fig">Figure 6</xref>C). The autoencoder nicely reconstructs the protein expression patterns observed in cells derived from juxta-tumoral tissue and mammoplasty samples, resulting in close-to-zero reconstruction errors. For tumor-derived epithelial cells, the reconstruction errors are much more pronounced (<xref rid="fig6" ref-type="fig">Figure 6</xref>C – rows labeled with green).<disp-quote><p><bold><italic>Note:</italic></bold> The reconstruction errors and phenotypic abnormality score are not zero for juxta-tumoral-derived, non-cancerous epithelial cells of the training set because data reconstruction by the autoencoder is by definition lossy.</p></disp-quote><disp-quote><p><inline-graphic xlink:href="fx3.gif"/><bold>CRITICAL:</bold> Before drawing biologically relevant conclusions from the computed score, make sure your data are not confounded by batch effects (<xref rid="sec5" ref-type="sec">troubleshooting</xref>).</p></disp-quote><fig id="fig6"><label>Figure 6</label><caption><p>Evaluation of the performance of the abnormality autoencoder</p><p>(A) Normalized protein expression levels per epithelial cell and marker of the input data.</p><p>(B) Normalized protein expression levels per epithelial cell and marker after reconstruction.</p><p>(C) Reconstruction error (residuals) per cell and marker, ordered by tissue type mammoplasty (blue), juxta-tumoral (orange) and tumor (green). The order of cells is identical across (A), (B), and (C).</p><p>(D–G) Phenotypic abnormality scores by (D) tissue type, (E) tumor grade, (F) estrogen receptor status, and (G) clinical subtype. M = mammoplasty, JT = juxta-tumoral, T = tumor, G = grade, ER = estrogen receptor.</p></caption><graphic xlink:href="gr6"/></fig></p></list-item></list></p></list-item></list></p>
    </sec>
    <sec id="sec2.4">
      <title>Sample individuality score</title>
      <p id="p0735">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 30 min</bold>
          </p>
        </disp-quote>
      </p>
      <p id="p0740">Tumor ecosystems may represent unique compositions of tumor cell molecular phenotypes. To quantify and compare the individuality of tumors, in <xref rid="bib22" ref-type="bibr">Wagner et al. (2019)</xref> we applied a graph-based approach using the epithelial single-cell data from all samples. First, a <italic>k</italic>-nearest neighbor graph was constructed that placed phenotypically similar epithelial cells close to one another in the high-dimensional space (<xref rid="fig7" ref-type="fig">Figure 7</xref>A). Then, for each cell, the respective sample origin labels of their <italic>k</italic> nearest neighboring cells were determined, and a probability distribution was computed based on its neighborhood proportion (<xref rid="fig7" ref-type="fig">Figure 7</xref>B). For each sample, the median value of the probability distribution of all single cells belonging to that sample was computed, resulting in a sample x sample individuality matrix that quantified whether cells were more similar to cells of the same or to cells of other samples. Last, a sample individuality score was obtained using the diagonal of this matrix (<xref rid="fig7" ref-type="fig">Figure 7</xref>C). This analysis revealed that tumors had higher individuality scores than non-cancerous tissue. We further observed higher individuality scores for grade 3 aggressive breast cancers compared with grade 1 and grade 2 less aggressive cancers. Here, we show how to apply this analysis using the single-cell epithelial measurements across all samples.<fig id="fig7"><label>Figure 7</label><caption><p>Workflow for computing the sample individuality score</p><p>(A) A k-nearest neighbor graph is constructed using all epithelial cells.</p><p>(B) For each cell, the neighborhood proportion is computed for a chosen k.</p><p>(C) The median neighborhood proportions for all cells of a sample are determined. Scores on the diagonal represent the sample individuality score. Some figure elements have been adapted from <xref rid="bib22" ref-type="bibr">Wagner et al. (2019)</xref>.</p></caption><graphic xlink:href="gr7"/></fig></p>
      <p id="p0745">To compute the sample-level individuality score, follow the steps below:<list list-type="simple" id="olist0105"><list-item id="o0220"><label>10.</label><p id="p0750">Prepare the dataset:<list list-type="simple" id="olist0110"><list-item id="o0225"><label>a.</label><p id="p0755">Subset the ad dataset to include only epithelial cells and selected markers (here, the same markers as in step 7b):<boxed-text id="dtbox44"><p id="p0760">&gt; ad_indiv = ad[ad.obs.is_epithelial == 1, ad.var.used_in_abnormality]</p></boxed-text></p></list-item><list-item id="o0230"><label>b.</label><p id="p0770">Preprocess the dataset by applying the arcsinh transformation, as in step 4c.</p></list-item><list-item id="o0235"><label>c.</label><p id="p0775">Subsample 200 cells per sample (for samples that have less cells, use them all):<boxed-text id="dtbox46"><p id="p0780">ad_indiv.obs['sample_id'] = ad_indiv.obs.groupby(['tissue_type', 'breast', 'patient_number']).ngroup()</p><p id="p0785">tmp = ad_indiv.obs.groupby(['sample_id']).indices</p><p id="p0790">n_cells = 200</p><p id="p0795">indices = []</p><p id="p0800">for key, item in tmp.items():</p><p id="p0805"> size = min(len(item), n_cells)</p><p id="p0810"> idx = np.random.choice(range(len(item)), size, replace=False)</p><p id="p0815"> indices.extend(item[idx])</p><p id="p0820">indices = np.array(indices)</p><p id="p0825">ad_indiv = ad_indiv[indices]</p></boxed-text></p></list-item></list></p></list-item></list><list list-type="simple" id="olist0115"><list-item id="o0240"><label>11.</label><p id="p0880">Initialize the model and compute the individuality score:</p></list-item></list><boxed-text id="dtbox48"><p id="p0885">&gt; Indiv = scq.Individuality()</p><p id="p0890">&gt; Indiv.predict(ad_indiv, ad_indiv.obs.sample_id, layer='arcsinh')</p></boxed-text><list list-type="simple" id="olist0120"><list-item id="o0245"><label>12.</label><p id="p0895">Assess the results:<list list-type="simple" id="olist0125"><list-item id="o0250"><label>a.</label><p id="p0900">The observation-level scores, <italic>i.e</italic>., one vector per single cell, indicating a <italic>cell’s</italic> similarity to all other samples, are saved in the .obsm attribute of the AnnData object, as a matrix of size n_cells x n_samples:<boxed-text id="dtbox49"><p id="p0905">&gt; ad_indiv.obsm['individuality']</p></boxed-text></p></list-item><list-item id="o0255"><label>b.</label><p id="p0915">The aggregated sample-level scores (one vector per sample, indicating a <italic>sample’s</italic> similarity to all other samples) are saved in the .uns attribute of the AnnData object, as a matrix of size n_samples x n_samples:<boxed-text id="dtbox51"><p id="p0920">&gt; ad_indiv.uns['individuality_agg']</p></boxed-text></p></list-item><list-item id="o0260"><label>c.</label><p id="p0930">To assess a sample’s individuality, we will use the diagonal of that matrix:<boxed-text id="dtbox53"><p id="p0935">&gt;dat=pd.DataFrame(np.diag(ad_indiv.uns['individuality_agg']), index=dat.index, columns=['individuality'])</p></boxed-text></p></list-item><list-item id="o0265"><label>d.</label><p id="p0945">Finally, assess the individuality score with respect to different patient clinical data (<xref rid="fig8" ref-type="fig">Figure 8</xref>).<disp-quote><p><inline-graphic xlink:href="fx3.gif"/><bold>CRITICAL:</bold> Ensure your data are not confounded by batch effects (<xref rid="sec5" ref-type="sec">troubleshooting</xref>).</p></disp-quote><fig id="fig8"><label>Figure 8</label><caption><p>Association of individality score with clinical metadata</p><p>Samples individuality scores by (A) tissue type, (B) tumor grade, (C) estrogen receptor status, and (D) clinical subtype. M = mammoplasty, JT = juxta-tumoral, T = tumor, G = grade, ER = estrogen receptor.</p></caption><graphic xlink:href="gr8"/></fig></p></list-item></list></p></list-item></list></p>
    </sec>
  </sec>
  <sec id="sec3">
    <title>Expected outcomes</title>
    <p id="p0950">scQUEST enables a robust discrimination of cell populations in large datasets as well as quantification of different aspects of tumor heterogeneity for inter-patient comparisons and comparisons with a reference tissue. All computations are done seamlessly, and the outcomes are integrated in different components of the AnnData object to facilitate downstream analyses.</p>
    <sec id="sec3.1">
      <title>Cell type assignment</title>
      <p id="p0955">The trained classifier model (clf) can be saved and reused for cell type assignment in future datasets:<boxed-text id="dtbox55"><p id="p0960">torch.save(clf.model.state_dict(), PATH)</p><p id="p0965">clf = scq.Classifier(n_in=ad_anno.shape[1])</p><p id="p0970">clf.model.load_state_dict(torch.load(PATH))</p></boxed-text></p>
      <p id="p0975">The predicted labels are automatically saved as cell-level annotations in the .obs attribute of the AnnData object.</p>
    </sec>
    <sec id="sec3.2">
      <title>Phenotypic abnormality score</title>
      <p id="p0980">The autoencoder model can be saved and reused in the future. The single-cell level abnormality values can be stored in the .obs attribute of the AnnData object.</p>
    </sec>
    <sec id="sec3.3">
      <title>Tumor individuality score</title>
      <p id="p0985">The single-cell level and sample-level individuality scores are automatically saved in the .obsm and .uns attributes of the AnnData object, as explained in steps 4–12.</p>
    </sec>
    <sec id="sec3.4">
      <title>Data export</title>
      <p id="p0990">The data can be exported to different commonly used data formats (e.g., .csv, .xls) to enable data analysis with other tools. For example, the epithelial cell data as classified by the model can be exported together with the associated metadata:<boxed-text id="dtbox56"><p id="p0995">mask=ad.obs['is_epithelial']==1</p><p id="p1000">temp=pd.DataFrame(data=ad.X[mask], columns = ad.var['desc'])</p><p id="p1005">temp.to_csv('all_epithelial_cells.csv')</p><p id="p1010">ad.obs[mask].to_csv('epithelial_metadata.csv')</p></boxed-text></p>
      <p id="p1015">All resulting plots in this protocol can simply be exported using the matplotlib savefig function:<boxed-text id="dtbox57"><p id="p1020">&gt; plt.savefig('figure_name.pdf', dpi=300)</p></boxed-text></p>
    </sec>
  </sec>
  <sec id="sec4">
    <title>Limitations</title>
    <p id="p1025">The performance of the different components of scQUEST depends on several factors, summarized by step below:</p>
    <sec id="sec4.1">
      <title>Cell type assignment</title>
      <p id="p1030">The most crucial aspect for accurate cell type identification is the quality and size of the annotated dataset used for training, which in turn largely depends on the use of cell type-stratifying markers. In this example, we used epithelial lineage markers to separate epithelial cells from cells of other lineages (e.g., mesenchymal and immune cells). Another important aspect is to titrate antibodies for data generation so that they yield an optimal signal-to-noise ratio. Low signal-to-noise ratios in marker channels used for training the neural network may result in poorer separation results for the cell populations of interest. Concerning the dataset size, the more data available to train a neural network for cell type identification the better, with the minimum amount depending largely on the difficulty of the task. Typically, for training datasets, a few thousand cells should suffice. The results of data clustering and applying the neural network to detect cell types of interest may be compared with other approaches that do not use annotated cell populations as input for a neural network but rather pre-specify marker profiles for cell type detection (<xref rid="bib5" ref-type="bibr">Geuenich et al., 2021</xref>). Finally, although the same model can be reused to classify cells from additional, unseen datasets measured with the same panel, it is crucial that the effect of different experimental batches is minimal, or corrected for (see also <xref rid="sec5" ref-type="sec">troubleshooting</xref>).</p>
    </sec>
    <sec id="sec4.2">
      <title>Phenotypic abnormality score</title>
      <p id="p1035">It is important to select a proper reference to serve as the basis to train the autoencoder, and one (or more) query datasets that will be used to compute the abnormality score. Ideally, these datasets deviate considerably in phenotypic space. For calculating a sample abnormality score for tumors, ideally, the corresponding normal tissue-derived cells are used as a reference. It is crucial that the reference and query datasets are free of batch effects (see also <xref rid="sec5" ref-type="sec">troubleshooting</xref>), so that the estimated phenotypic deviation is attributed to biological and not technical variability. The abnormality score indicates how similar (low score) or dissimilar (high score) a tumor cell is compared with the median of the reference. However, two tumor cells with the same abnormality score may be phenotypically very distant, as the score does not suggest a trajectory (i.e., it is not directional). For single-cell trajectory reconstruction, other tools can be explored, as reviewed in (<xref rid="bib2" ref-type="bibr">Cannoodt et al., 2016</xref>). As mentioned in step 2, the more data available to train the autoencoder the better.</p>
    </sec>
    <sec id="sec4.3">
      <title>Tumor individuality score</title>
      <p id="p1040">The individuality score captures the uniqueness of the phenotypic pattern of a sample within a cohort, and as such, is dependent on the choice of markers to describe the phenotypic pattern and the variability of the cohort itself. Therefore, care should be taken when choosing markers to assess cell phenotypes by mass cytometry or flow cytometry and when assembling a patient cohort. As for phenotypic abnormality, the <italic>k</italic>-nearest neighbor graph and individuality scores do not suggest a trajectory of disease evolution, but rather describe how rare or ubiquitous a patient-level tumor profile is within the cohort. Finally, the sample individuality score is highly affected by the number of cells per sample, with estimates of smaller samples being less robust. For imbalanced datasets, we recommend re-sampling an equal number of cells per sample to circumvent this issue.</p>
      <p id="p1045">Due to the modular structure of scQUEST, individual components of the package can be used for alternative applications beyond the dataset presented here. For example, the phenotypic abnormality score approach could be applied to cells before and after drug perturbations or genetic alterations. Alternatively, cells at different timepoints during <italic>in vitro</italic> experiments, in disease models, or during patient disease progression can be compared.</p>
    </sec>
  </sec>
  <sec id="sec5">
    <title>Troubleshooting</title>
    <sec id="sec5.1">
      <title>Problem 1</title>
      <p id="p1050">The model fails to accurately classify the training dataset (step 2).</p>
    </sec>
    <sec id="sec5.2">
      <title>Potential solution</title>
      <p id="p1055">Step 2 may fail if the quality of your annotated dataset is suboptimal. To correct this issue, you first need to evaluate the clustering and ensure that the identified clusters represent distinct cell phenotypes or subpopulations. Maximize the number of cells to cluster according to your computational resources to increase robustness. Decide which markers you want to use for the clustering step, as this will strongly affect the result. An ideal clustering groups cells together with a very similar marker profile, <italic>i.e</italic>., low signal variance in each marker channel. Ideally, marker channels are chosen for clustering that are expressed by cells of one class and not by cells of another class and vice versa. You may want to exclude markers from the clustering with very low signal-to-noise ratios and markers with signal spill into other channels, which may create possible false-positive cells. Examine the robustness of the clustering with respect to the inherent stochasticity of the algorithm (e.g., different random initializations) or different parameter values (e.g., <italic>k</italic> number of neighbors in PhenoGraph), by exploiting metrics such as the Adjusted Rand Index (<xref rid="bib9" ref-type="bibr">Hubert and Arabie, 1985</xref>), the Silhouette coefficient (<xref rid="bib18" ref-type="bibr">Rousseeuw, 1987</xref>) or the adjusted mutual information score (<xref rid="bib20" ref-type="bibr">Vinh et al., 2010</xref>) from repetitive clustering runs. When working with imbalanced data, we recommend subsampling strategies that balance out large discrepancies in sample sizes (see our Downsamplng and clustering tutorial, <xref rid="sec8" ref-type="sec">key resources table</xref>).</p>
    </sec>
    <sec id="sec5.3">
      <title>Problem 2</title>
      <p id="p1060">The model fails to accurately classify the test or unseen data (step 2).</p>
    </sec>
    <sec id="sec5.4">
      <title>Potential solution</title>
      <p id="p1065">Even if the model achieved high accuracy in the training set, it may fail in accurately classifying the test set. One common pitfall may be overfitting. To detect overfitting, make sure the training loss is not getting progressively lower while at the same time the test loss is getting higher. Using a <italic>k</italic>-fold cross validation scheme will allow you to evaluate the model performance. If you have issues with overfitting, you can try reducing the complexity of the model, training with more data and exploiting techniques such as regularization, dropout and early stopping. Another common pitfall may be batch effects, addressed in <xref rid="sec5.5" ref-type="sec">problem 3</xref> below.</p>
    </sec>
    <sec id="sec5.5">
      <title>Problem 3</title>
      <p id="p1070">The abnormality or individuality scores are not capturing patterns relevant to disease variability (steps 3 and 4).</p>
    </sec>
    <sec id="sec5.6">
      <title>Potential solution</title>
      <p id="p1075">The first factor you need to assess is whether your data is confounded by batch effects. Ideally, all samples to be compared should be measured in the same acquisition, so that systematic biases introduced by antibody staining variability, sample handling or machine calibration are absent. If this is not the case, then both the abnormality and individuality scores may highlight samples as abnormal or unique that differ in experimental setup instead of differing in biological means. To address this issue, batch effects first need to be detected and then corrected for, e.g., by comparing different available computational approaches (<xref rid="bib7" ref-type="bibr">Haghverdi et al., 2018</xref>; <xref rid="bib14" ref-type="bibr">Leek et al., 2010</xref>).</p>
    </sec>
    <sec id="sec5.7">
      <title>Problem 4</title>
      <p id="p1080">The Classifier model always converges to the same solution, which makes it hard to test its robustness.</p>
    </sec>
    <sec id="sec5.8">
      <title>Potential solution</title>
      <p id="p1085">In the current tutorial, we are using a fixed seed both in the initialization and fitting of the Classifier module for reproducibility reasons. To test how different stochastic initializations of the model affect the results, change the value of the seed, and compare the outcomes. The same process can be followed for the Abnormality module as well.</p>
    </sec>
    <sec id="sec5.9">
      <title>Problem 5</title>
      <p id="p1090">My dataset is highly unbalanced, resulting in low prediction accuracy of the underrepresented class.</p>
    </sec>
    <sec id="sec5.10">
      <title>Potential solution</title>
      <p id="p1095">This is a common problem in real world cytometry datasets, which can be circumvented by using class weights, as we show in step 2: Train the neural network classifier of our scQUEST AML tutorial (<xref rid="sec8" ref-type="sec">key resources table</xref>).</p>
    </sec>
  </sec>
  <sec id="sec6">
    <title>Resource availability</title>
    <sec id="sec6.1">
      <title>Lead contact</title>
      <p id="p1100">Further information and requests for resources and reagents should be directed to and will be fulfilled by the lead contact, Maria Anna Rapsomaniki (<ext-link ext-link-type="uri" xlink:href="mailto:aap@zurich.ibm.com" id="intref0030">aap@zurich.ibm.com</ext-link>).</p>
    </sec>
    <sec id="sec6.2">
      <title>Materials availability</title>
      <p id="p1105">This study did not generate new unique reagents.</p>
    </sec>
  </sec>
</body>
<back>
  <ref-list id="cebib0010">
    <title>References</title>
    <ref id="bib1">
      <element-citation publication-type="journal" id="sref1">
        <person-group person-group-type="author">
          <name>
            <surname>Amin</surname>
            <given-names>M.B.</given-names>
          </name>
          <name>
            <surname>Greene</surname>
            <given-names>F.L.</given-names>
          </name>
          <name>
            <surname>Edge</surname>
            <given-names>S.B.</given-names>
          </name>
          <name>
            <surname>Compton</surname>
            <given-names>C.C.</given-names>
          </name>
          <name>
            <surname>Gershenwald</surname>
            <given-names>J.E.</given-names>
          </name>
          <name>
            <surname>Brookland</surname>
            <given-names>R.K.</given-names>
          </name>
          <name>
            <surname>Meyer</surname>
            <given-names>L.</given-names>
          </name>
          <name>
            <surname>Gress</surname>
            <given-names>D.M.</given-names>
          </name>
          <name>
            <surname>Byrd</surname>
            <given-names>D.R.</given-names>
          </name>
          <name>
            <surname>Winchester</surname>
            <given-names>D.P.</given-names>
          </name>
        </person-group>
        <article-title>The Eighth Edition AJCC Cancer Staging Manual: continuing to build a bridge from a population-based to a more “personalized” approach to cancer staging</article-title>
        <source>CA Cancer J. Clin.</source>
        <volume>67</volume>
        <year>2017</year>
        <fpage>93</fpage>
        <lpage>99</lpage>
        <pub-id pub-id-type="doi">10.3322/caac.21388</pub-id>
        <pub-id pub-id-type="pmid">28094848</pub-id>
      </element-citation>
    </ref>
    <ref id="bib2">
      <element-citation publication-type="journal" id="sref2">
        <person-group person-group-type="author">
          <name>
            <surname>Cannoodt</surname>
            <given-names>R.</given-names>
          </name>
          <name>
            <surname>Saelens</surname>
            <given-names>W.</given-names>
          </name>
          <name>
            <surname>Saeys</surname>
            <given-names>Y.</given-names>
          </name>
        </person-group>
        <article-title>Computational methods for trajectory inference from single-cell transcriptomics</article-title>
        <source>Eur. J. Immunol.</source>
        <volume>46</volume>
        <year>2016</year>
        <fpage>2496</fpage>
        <lpage>2506</lpage>
        <pub-id pub-id-type="doi">10.1002/eji.201646347</pub-id>
        <pub-id pub-id-type="pmid">27682842</pub-id>
      </element-citation>
    </ref>
    <ref id="bib3">
      <element-citation publication-type="journal" id="sref3">
        <person-group person-group-type="author">
          <name>
            <surname>Chevrier</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Crowell</surname>
            <given-names>H.L.</given-names>
          </name>
          <name>
            <surname>Zanotelli</surname>
            <given-names>V.R.T.</given-names>
          </name>
          <name>
            <surname>Engler</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Robinson</surname>
            <given-names>M.D.</given-names>
          </name>
          <name>
            <surname>Bodenmiller</surname>
            <given-names>B.</given-names>
          </name>
        </person-group>
        <article-title>Compensation of signal spillover in suspension and imaging mass cytometry</article-title>
        <source>Cell Syst.</source>
        <volume>6</volume>
        <year>2018</year>
        <fpage>612</fpage>
        <lpage>620.e5</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2018.02.010</pub-id>
        <pub-id pub-id-type="pmid">29605184</pub-id>
      </element-citation>
    </ref>
    <ref id="bib4">
      <element-citation publication-type="journal" id="sref4">
        <person-group person-group-type="author">
          <name>
            <surname>Finck</surname>
            <given-names>R.</given-names>
          </name>
          <name>
            <surname>Simonds</surname>
            <given-names>E.F.</given-names>
          </name>
          <name>
            <surname>Jager</surname>
            <given-names>A.</given-names>
          </name>
          <name>
            <surname>Krishnaswamy</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Sachs</surname>
            <given-names>K.</given-names>
          </name>
          <name>
            <surname>Fantl</surname>
            <given-names>W.</given-names>
          </name>
          <name>
            <surname>Pe’er</surname>
            <given-names>D.</given-names>
          </name>
          <name>
            <surname>Nolan</surname>
            <given-names>G.P.</given-names>
          </name>
          <name>
            <surname>Bendall</surname>
            <given-names>S.C.</given-names>
          </name>
        </person-group>
        <article-title>Normalization of mass cytometry data with bead standards</article-title>
        <source>Cytometry A.</source>
        <volume>83</volume>
        <year>2013</year>
        <fpage>483</fpage>
        <lpage>494</lpage>
        <pub-id pub-id-type="doi">10.1002/cyto.a.22271</pub-id>
        <pub-id pub-id-type="pmid">23512433</pub-id>
      </element-citation>
    </ref>
    <ref id="bib5">
      <element-citation publication-type="journal" id="sref5">
        <person-group person-group-type="author">
          <name>
            <surname>Geuenich</surname>
            <given-names>M.J.</given-names>
          </name>
          <name>
            <surname>Hou</surname>
            <given-names>J.</given-names>
          </name>
          <name>
            <surname>Lee</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Ayub</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Jackson</surname>
            <given-names>H.W.</given-names>
          </name>
          <name>
            <surname>Campbell</surname>
            <given-names>K.R.</given-names>
          </name>
        </person-group>
        <article-title>Automated assignment of cell identity from single-cell multiplexed imaging and proteomic data</article-title>
        <source>Cell Syst.</source>
        <volume>12</volume>
        <year>2021</year>
        <fpage>1173</fpage>
        <lpage>1186.e5</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2021.08.012</pub-id>
        <pub-id pub-id-type="pmid">34536381</pub-id>
      </element-citation>
    </ref>
    <ref id="bib6">
      <element-citation publication-type="book" id="sref6">
        <person-group person-group-type="author">
          <name>
            <surname>Goodfellow</surname>
            <given-names>I.</given-names>
          </name>
          <name>
            <surname>Bengio</surname>
            <given-names>Y.</given-names>
          </name>
          <name>
            <surname>Courville</surname>
            <given-names>A.</given-names>
          </name>
        </person-group>
        <part-title>Deep Learning</part-title>
        <year>2016</year>
        <publisher-name>MIT press</publisher-name>
      </element-citation>
    </ref>
    <ref id="bib7">
      <element-citation publication-type="journal" id="sref7">
        <person-group person-group-type="author">
          <name>
            <surname>Haghverdi</surname>
            <given-names>L.</given-names>
          </name>
          <name>
            <surname>Lun</surname>
            <given-names>A.T.L.</given-names>
          </name>
          <name>
            <surname>Morgan</surname>
            <given-names>M.D.</given-names>
          </name>
          <name>
            <surname>Marioni</surname>
            <given-names>J.C.</given-names>
          </name>
        </person-group>
        <article-title>Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors</article-title>
        <source>Nat. Biotechnol.</source>
        <volume>36</volume>
        <year>2018</year>
        <fpage>421</fpage>
        <lpage>427</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.4091</pub-id>
        <pub-id pub-id-type="pmid">29608177</pub-id>
      </element-citation>
    </ref>
    <ref id="bib8">
      <element-citation publication-type="journal" id="sref8">
        <person-group person-group-type="author">
          <name>
            <surname>Hinton</surname>
            <given-names>G.E.</given-names>
          </name>
          <name>
            <surname>Salakhutdinov</surname>
            <given-names>R.R.</given-names>
          </name>
        </person-group>
        <article-title>Reducing the dimensionality of data with neural networks</article-title>
        <source>Science</source>
        <volume>313</volume>
        <year>2006</year>
        <fpage>504</fpage>
        <lpage>507</lpage>
        <pub-id pub-id-type="doi">10.1126/science.1127647</pub-id>
        <pub-id pub-id-type="pmid">16873662</pub-id>
      </element-citation>
    </ref>
    <ref id="bib9">
      <element-citation publication-type="journal" id="sref9">
        <person-group person-group-type="author">
          <name>
            <surname>Hubert</surname>
            <given-names>L.</given-names>
          </name>
          <name>
            <surname>Arabie</surname>
            <given-names>P.</given-names>
          </name>
        </person-group>
        <article-title>Comparing partitions</article-title>
        <source>J. Classif.</source>
        <volume>2</volume>
        <year>1985</year>
        <fpage>193</fpage>
        <lpage>218</lpage>
        <pub-id pub-id-type="doi">10.1007/BF01908075</pub-id>
      </element-citation>
    </ref>
    <ref id="bib10">
      <element-citation publication-type="journal" id="sref10">
        <person-group person-group-type="author">
          <name>
            <surname>Kashyap</surname>
            <given-names>A.</given-names>
          </name>
          <name>
            <surname>Rapsomaniki</surname>
            <given-names>M.A.</given-names>
          </name>
          <name>
            <surname>Barros</surname>
            <given-names>V.</given-names>
          </name>
          <name>
            <surname>Fomitcheva-Khartchenko</surname>
            <given-names>A.</given-names>
          </name>
          <name>
            <surname>Martinelli</surname>
            <given-names>A.L.</given-names>
          </name>
          <name>
            <surname>Rodriguez</surname>
            <given-names>A.F.</given-names>
          </name>
          <name>
            <surname>Gabrani</surname>
            <given-names>M.</given-names>
          </name>
          <name>
            <surname>Rosen-Zvi</surname>
            <given-names>M.</given-names>
          </name>
          <name>
            <surname>Kaigala</surname>
            <given-names>G.</given-names>
          </name>
        </person-group>
        <article-title>Quantification of tumor heterogeneity: from data acquisition to metric generation</article-title>
        <source>Trends Biotechnol.</source>
        <volume>40</volume>
        <year>2022</year>
        <fpage>647</fpage>
        <lpage>676</lpage>
        <pub-id pub-id-type="doi">10.1016/j.tibtech.2021.11.006</pub-id>
        <pub-id pub-id-type="pmid">34972597</pub-id>
      </element-citation>
    </ref>
    <ref id="bib11">
      <element-citation publication-type="journal" id="sref11">
        <person-group person-group-type="author">
          <name>
            <surname>Kingma</surname>
            <given-names>D.P.</given-names>
          </name>
          <name>
            <surname>Ba</surname>
            <given-names>J.</given-names>
          </name>
        </person-group>
        <article-title>Adam: a method for stochastic optimization</article-title>
        <comment>Preprint at</comment>
        <source>arXiv</source>
        <year>2017</year>
        <pub-id pub-id-type="doi">10.48550/ARXIV.1412.6980</pub-id>
      </element-citation>
    </ref>
    <ref id="bib12">
      <element-citation publication-type="journal" id="sref12">
        <person-group person-group-type="author">
          <name>
            <surname>Kotecha</surname>
            <given-names>N.</given-names>
          </name>
          <name>
            <surname>Krutzik</surname>
            <given-names>P.O.</given-names>
          </name>
          <name>
            <surname>Irish</surname>
            <given-names>J.M.</given-names>
          </name>
        </person-group>
        <article-title>Web-based analysis and publication of flow cytometry experiments</article-title>
        <source>Curr. Protoc. Cytom.</source>
        <volume>Chapter 10</volume>
        <year>2010</year>
        <fpage>Unit10.17</fpage>
        <pub-id pub-id-type="doi">10.1002/0471142956.cy1017s53</pub-id>
      </element-citation>
    </ref>
    <ref id="bib13">
      <element-citation publication-type="journal" id="sref13">
        <person-group person-group-type="author">
          <name>
            <surname>Krutzik</surname>
            <given-names>P.O.</given-names>
          </name>
          <name>
            <surname>Nolan</surname>
            <given-names>G.P.</given-names>
          </name>
        </person-group>
        <article-title>Fluorescent cell barcoding in flow cytometry allows high-throughput drug screening and signaling profiling</article-title>
        <source>Nat. Methods</source>
        <volume>3</volume>
        <year>2006</year>
        <fpage>361</fpage>
        <lpage>368</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth872</pub-id>
        <pub-id pub-id-type="pmid">16628206</pub-id>
      </element-citation>
    </ref>
    <ref id="bib14">
      <element-citation publication-type="journal" id="sref14">
        <person-group person-group-type="author">
          <name>
            <surname>Leek</surname>
            <given-names>J.T.</given-names>
          </name>
          <name>
            <surname>Scharpf</surname>
            <given-names>R.B.</given-names>
          </name>
          <name>
            <surname>Bravo</surname>
            <given-names>H.C.</given-names>
          </name>
          <name>
            <surname>Simcha</surname>
            <given-names>D.</given-names>
          </name>
          <name>
            <surname>Langmead</surname>
            <given-names>B.</given-names>
          </name>
          <name>
            <surname>Johnson</surname>
            <given-names>W.E.</given-names>
          </name>
          <name>
            <surname>Geman</surname>
            <given-names>D.</given-names>
          </name>
          <name>
            <surname>Baggerly</surname>
            <given-names>K.</given-names>
          </name>
          <name>
            <surname>Irizarry</surname>
            <given-names>R.A.</given-names>
          </name>
        </person-group>
        <article-title>Tackling the widespread and critical impact of batch effects in high-throughput data</article-title>
        <source>Nat. Rev. Genet.</source>
        <volume>11</volume>
        <year>2010</year>
        <fpage>733</fpage>
        <lpage>739</lpage>
        <pub-id pub-id-type="doi">10.1038/nrg2825</pub-id>
        <pub-id pub-id-type="pmid">20838408</pub-id>
      </element-citation>
    </ref>
    <ref id="bib15">
      <element-citation publication-type="journal" id="sref15">
        <person-group person-group-type="author">
          <name>
            <surname>Levine</surname>
            <given-names>J.H.</given-names>
          </name>
          <name>
            <surname>Simonds</surname>
            <given-names>E.F.</given-names>
          </name>
          <name>
            <surname>Bendall</surname>
            <given-names>S.C.</given-names>
          </name>
          <name>
            <surname>Davis</surname>
            <given-names>K.L.</given-names>
          </name>
          <name>
            <surname>Amir</surname>
            <given-names>E.a.D.</given-names>
          </name>
          <name>
            <surname>Tadmor</surname>
            <given-names>M.D.</given-names>
          </name>
          <name>
            <surname>Litvin</surname>
            <given-names>O.</given-names>
          </name>
          <name>
            <surname>Fienberg</surname>
            <given-names>H.G.</given-names>
          </name>
          <name>
            <surname>Jager</surname>
            <given-names>A.</given-names>
          </name>
          <name>
            <surname>Zunder</surname>
            <given-names>E.R.</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Data-driven phenotypic dissection of AML reveals progenitor-like cells that correlate with prognosis</article-title>
        <source>Cell</source>
        <volume>162</volume>
        <year>2015</year>
        <fpage>184</fpage>
        <lpage>197</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2015.05.047</pub-id>
        <pub-id pub-id-type="pmid">26095251</pub-id>
      </element-citation>
    </ref>
    <ref id="bib16">
      <element-citation publication-type="journal" id="sref16">
        <person-group person-group-type="author">
          <name>
            <surname>Martinelli</surname>
            <given-names>A.L.</given-names>
          </name>
          <name>
            <surname>Rapsomaniki</surname>
            <given-names>M.A.</given-names>
          </name>
        </person-group>
        <article-title>ATHENA: analysis of tumor heterogeneity from spatial omics measurements</article-title>
        <source>Bioinformatics</source>
        <volume>38</volume>
        <year>2022</year>
        <fpage>3151</fpage>
        <lpage>3153</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btac303</pub-id>
      </element-citation>
    </ref>
    <ref id="bib25">
      <element-citation publication-type="journal" id="optiA8L2uMCtA">
        <person-group person-group-type="author">
          <name>
            <surname>McInnes</surname>
            <given-names>L.</given-names>
          </name>
          <name>
            <surname>Healy</surname>
            <given-names>J.</given-names>
          </name>
          <name>
            <surname>Melville</surname>
            <given-names>J.</given-names>
          </name>
        </person-group>
        <article-title>Umap: Uniform manifold approximation and projection for dimension reduction</article-title>
        <source>ArXiv</source>
        <year>2018</year>
        <object-id pub-id-type="publisher-id">1802.03426</object-id>
      </element-citation>
    </ref>
    <ref id="bib17">
      <element-citation publication-type="journal" id="sref17">
        <person-group person-group-type="author">
          <name>
            <surname>Ramos</surname>
            <given-names>P.</given-names>
          </name>
          <name>
            <surname>Bentires-Alj</surname>
            <given-names>M.</given-names>
          </name>
        </person-group>
        <article-title>Mechanism-based cancer therapy: resistance to therapy, therapy for resistance</article-title>
        <source>Oncogene</source>
        <volume>34</volume>
        <year>2015</year>
        <fpage>3617</fpage>
        <lpage>3626</lpage>
        <pub-id pub-id-type="doi">10.1038/onc.2014.314</pub-id>
        <pub-id pub-id-type="pmid">25263438</pub-id>
      </element-citation>
    </ref>
    <ref id="bib18">
      <element-citation publication-type="journal" id="sref18">
        <person-group person-group-type="author">
          <name>
            <surname>Rousseeuw</surname>
            <given-names>P.J.</given-names>
          </name>
        </person-group>
        <article-title>Silhouettes: a graphical aid to the interpretation and validation of cluster analysis</article-title>
        <source>J. Comput. Appl. Math.</source>
        <volume>20</volume>
        <year>1987</year>
        <fpage>53</fpage>
        <lpage>65</lpage>
        <pub-id pub-id-type="doi">10.1016/0377-0427(87)90125-7</pub-id>
      </element-citation>
    </ref>
    <ref id="bib19">
      <element-citation publication-type="journal" id="sref19">
        <person-group person-group-type="author">
          <name>
            <surname>Van Gassen</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Callebaut</surname>
            <given-names>B.</given-names>
          </name>
          <name>
            <surname>Van Helden</surname>
            <given-names>M.J.</given-names>
          </name>
          <name>
            <surname>Lambrecht</surname>
            <given-names>B.N.</given-names>
          </name>
          <name>
            <surname>Demeester</surname>
            <given-names>P.</given-names>
          </name>
          <name>
            <surname>Dhaene</surname>
            <given-names>T.</given-names>
          </name>
          <name>
            <surname>Saeys</surname>
            <given-names>Y.</given-names>
          </name>
        </person-group>
        <article-title>FlowSOM: using self-organizing maps for visualization and interpretation of cytometry data</article-title>
        <source>Cytometry A.</source>
        <volume>87</volume>
        <year>2015</year>
        <fpage>636</fpage>
        <lpage>645</lpage>
        <pub-id pub-id-type="doi">10.1002/cyto.a.22625</pub-id>
        <pub-id pub-id-type="pmid">25573116</pub-id>
      </element-citation>
    </ref>
    <ref id="bib20">
      <element-citation publication-type="journal" id="sref20">
        <person-group person-group-type="author">
          <name>
            <surname>Vinh</surname>
            <given-names>N.X.</given-names>
          </name>
          <name>
            <surname>Epps</surname>
            <given-names>J.</given-names>
          </name>
          <name>
            <surname>Bailey</surname>
            <given-names>J.</given-names>
          </name>
        </person-group>
        <article-title>Information theoretic measures for clusterings comparison: variants, properties, normalization and correction for chance</article-title>
        <source>J. Mach. Learn. Res.</source>
        <volume>11</volume>
        <year>2010</year>
        <fpage>2837</fpage>
        <lpage>2854</lpage>
      </element-citation>
    </ref>
    <ref id="bib21">
      <element-citation publication-type="journal" id="sref21">
        <person-group person-group-type="author">
          <name>
            <surname>Virshup</surname>
            <given-names>I.</given-names>
          </name>
          <name>
            <surname>Rybakov</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>F.J.</given-names>
          </name>
          <name>
            <surname>Angerer</surname>
            <given-names>P.</given-names>
          </name>
          <name>
            <surname>Wolf</surname>
            <given-names>F.A.</given-names>
          </name>
        </person-group>
        <article-title>anndata: annotated data</article-title>
        <comment>Preprint at</comment>
        <source>bioRxiv</source>
        <year>2021</year>
        <pub-id pub-id-type="doi">10.1101/2021.12.16.473007</pub-id>
      </element-citation>
    </ref>
    <ref id="bib22">
      <element-citation publication-type="journal" id="sref22">
        <person-group person-group-type="author">
          <name>
            <surname>Wagner</surname>
            <given-names>J.</given-names>
          </name>
          <name>
            <surname>Rapsomaniki</surname>
            <given-names>M.A.</given-names>
          </name>
          <name>
            <surname>Chevrier</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Anzeneder</surname>
            <given-names>T.</given-names>
          </name>
          <name>
            <surname>Langwieder</surname>
            <given-names>C.</given-names>
          </name>
          <name>
            <surname>Dykgers</surname>
            <given-names>A.</given-names>
          </name>
          <name>
            <surname>Rees</surname>
            <given-names>M.</given-names>
          </name>
          <name>
            <surname>Ramaswamy</surname>
            <given-names>A.</given-names>
          </name>
          <name>
            <surname>Muenst</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Soysal</surname>
            <given-names>S.D.</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A single-cell atlas of the tumor and immune ecosystem of human breast cancer</article-title>
        <source>Cell</source>
        <volume>177</volume>
        <year>2019</year>
        <fpage>1330</fpage>
        <lpage>1345.e18</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2019.03.005</pub-id>
        <pub-id pub-id-type="pmid">30982598</pub-id>
      </element-citation>
    </ref>
    <ref id="bib23">
      <element-citation publication-type="journal" id="sref23">
        <person-group person-group-type="author">
          <name>
            <surname>Zunder</surname>
            <given-names>E.R.</given-names>
          </name>
          <name>
            <surname>Finck</surname>
            <given-names>R.</given-names>
          </name>
          <name>
            <surname>Behbehani</surname>
            <given-names>G.K.</given-names>
          </name>
          <name>
            <surname>Amir</surname>
            <given-names>E.-A.D.</given-names>
          </name>
          <name>
            <surname>Krishnaswamy</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Gonzalez</surname>
            <given-names>V.D.</given-names>
          </name>
          <name>
            <surname>Lorang</surname>
            <given-names>C.G.</given-names>
          </name>
          <name>
            <surname>Bjornson</surname>
            <given-names>Z.</given-names>
          </name>
          <name>
            <surname>Spitzer</surname>
            <given-names>M.H.</given-names>
          </name>
          <name>
            <surname>Bodenmiller</surname>
            <given-names>B.</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Palladium-based mass tag cell barcoding with a doublet-filtering scheme and single-cell deconvolution algorithm</article-title>
        <source>Nat. Protoc.</source>
        <volume>10</volume>
        <year>2015</year>
        <fpage>316</fpage>
        <lpage>333</lpage>
        <pub-id pub-id-type="doi">10.1038/nprot.2015.020</pub-id>
        <pub-id pub-id-type="pmid">25612231</pub-id>
      </element-citation>
    </ref>
  </ref-list>
  <sec sec-type="data-availability" id="da0010">
    <title>Data and code availability</title>
    <p id="p0030">The code generated during this study is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/AI4SCR/scQUEST" id="intref0010">https://github.com/AI4SCR/scQUEST</ext-link>. Original data used in this protocol were generated as described in <xref rid="bib22" ref-type="bibr">Wagner et al. (2019)</xref> and are deposited in Mendeley data: <ext-link ext-link-type="doi" xlink:href="10.17632/gb83sywsjc.1" id="intref0015">https://doi.org/10.17632/gb83sywsjc.1</ext-link>. The single-cell measurements of the tumor epithelial cell-centric panel (raw and pre-annotated) are also pre-uploaded in scQUEST as AnnData objects. The AnnData object contains 23 additional tumors and 9 additional non-tumor samples which were not previously included in the Wagner et al. dataset deposited on Mendeley data.</p>
  </sec>
  <ack id="ack0010">
    <title>Acknowledgments</title>
    <p id="p1135">This work has been supported by the <funding-source id="gs1">Swiss National Science Foundation</funding-source> Sinergia grant CRSII5_202297. J.W. is supported by a <funding-source id="gs2"><institution-wrap><institution-id institution-id-type="doi">10.13039/100004410</institution-id><institution>European Molecular Biology Organization</institution></institution-wrap></funding-source> (EMBO) Postdoctoral Fellowship ALTF 599-2021.</p>
    <sec id="sec9">
      <title>Author contributions</title>
      <p id="p1140">Conceptualization, J.W., B.B., and M.A.R.; methodology, A.L.M. and M.A.R.; software, A.L.M.; investigation, A.L.M.; visualization and data interpretation, J.W., A.L.M., and M.A.R.; writing, J.W. and M.A.R. with input from B.B.; supervision, M.A.R.; funding acquisition, J.W. and M.A.R.</p>
    </sec>
    <sec sec-type="COI-statement" id="sec10">
      <title>Declaration of interests</title>
      <p id="p1145">The authors declare no competing interests.</p>
    </sec>
  </ack>
</back>
