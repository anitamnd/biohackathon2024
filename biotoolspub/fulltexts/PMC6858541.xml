<?all-math-mml yes?>
<?use-mml?>
<?properties open_access?>
<?properties manuscript?>
<?origin nihpa?>
<?iso-abbr Nat. Neurosci.?>
<?submitter-system nihms?>
<?submitter-canonical-name Nature Publishing Group?>
<?submitter-canonical-id NATURE-STRUCTUR?>
<?submitter-userid 8068858?>
<?submitter-authority myNCBI?>
<?submitter-login nature-structure?>
<?submitter-name Nature Publishing Group?>
<?domain nihpa?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-journal-id">9809671</journal-id>
    <journal-id journal-id-type="pubmed-jr-id">21092</journal-id>
    <journal-id journal-id-type="nlm-ta">Nat Neurosci</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat. Neurosci.</journal-id>
    <journal-title-group>
      <journal-title>Nature neuroscience</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1097-6256</issn>
    <issn pub-type="epub">1546-1726</issn>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6858541</article-id>
    <article-id pub-id-type="pmid">31570865</article-id>
    <article-id pub-id-type="doi">10.1038/s41593-019-0492-2</article-id>
    <article-id pub-id-type="manuscript">nihpa1537261</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Accurate quantification of astrocyte and neurotransmitter fluorescence dynamics for single-cell and population-level physiology</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Wang</surname>
          <given-names>Yizhi</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref rid="FN1" ref-type="author-notes">*</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>DelRosso</surname>
          <given-names>Nicole V.</given-names>
        </name>
        <xref ref-type="aff" rid="A2">2</xref>
        <xref rid="FN1" ref-type="author-notes">*</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Vaidyanathan</surname>
          <given-names>Trisha V.</given-names>
        </name>
        <xref ref-type="aff" rid="A3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Cahill</surname>
          <given-names>Michelle K.</given-names>
        </name>
        <xref ref-type="aff" rid="A3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Reitman</surname>
          <given-names>Michael E.</given-names>
        </name>
        <xref ref-type="aff" rid="A3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Pittolo</surname>
          <given-names>Silvia</given-names>
        </name>
        <xref ref-type="aff" rid="A2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Mi</surname>
          <given-names>Xuelong</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Yu</surname>
          <given-names>Guoqiang</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref rid="CR1" ref-type="corresp">¶</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Poskanzer</surname>
          <given-names>Kira E.</given-names>
        </name>
        <xref ref-type="aff" rid="A2">2</xref>
        <xref ref-type="aff" rid="A3">3</xref>
        <xref ref-type="aff" rid="A4">4</xref>
        <xref rid="CR1" ref-type="corresp">¶</xref>
      </contrib>
    </contrib-group>
    <aff id="A1"><label>1</label>Bradley Department of Electrical and Computer Engineering, Virginia Polytechnic Institute and State University, Arlington, VA</aff>
    <aff id="A2"><label>2</label>Department of Biochemistry &amp; Biophysics, University of California, San Francisco, San Francisco, CA</aff>
    <aff id="A3"><label>3</label>Neuroscience Graduate Program, University of California, San Francisco, San Francisco, CA</aff>
    <aff id="A4"><label>4</label>Kavli Institute for Fundamental Neuroscience, San Francisco, CA</aff>
    <author-notes>
      <fn fn-type="equal" id="FN1">
        <label>*</label>
        <p id="P1">Equal contribution</p>
      </fn>
      <fn fn-type="con" id="FN2">
        <p id="P3">Author Contributions</p>
        <p id="P4">K.E.P and G.Y. conceived and designed the study. Y.W. and G.Y. designed and implemented the AQuA algorithm, software, and simulations. N.V.D. analyzed all imaging data and provided critical conceptual input to software design. T.V.V. carried out GluSnFR experiments; M.K.C. performed <italic>ex vivo</italic> Ca<sup>2+</sup>, GABASnFR, and GluSnFR experiments; M.E.R. performed <italic>in vivo</italic> Ca<sup>2+</sup> imaging experiments; and S.P. performed GRAB-NE experiments. X.M. implemented the Java version of the software, and built and tested the 3D prototype. K.E.P supervised the experimental team. G.Y. supervised the computational team. Y.W., N.V.D., K.E.P, and G.Y. wrote the manuscript with input from all authors.</p>
      </fn>
      <corresp id="CR1"><label>¶</label><bold>Corresponding authors:</bold> Kira E. Poskanzer: <email>kira.poskanzer@ucsf.edu</email>, Guoqiang Yu: <email>yug@vt.edu</email></corresp>
    </author-notes>
    <pub-date pub-type="nihms-submitted">
      <day>13</day>
      <month>8</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>30</day>
      <month>9</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <month>11</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>30</day>
      <month>3</month>
      <year>2020</year>
    </pub-date>
    <volume>22</volume>
    <issue>11</issue>
    <fpage>1936</fpage>
    <lpage>1944</lpage>
    <!--elocation-id from pubmed: 10.1038/s41593-019-0492-2-->
    <permissions>
      <license>
        <license-p>Users may view, print, copy, and download text and data-mine the content in such documents, for the purposes of academic research, subject always to the full Conditions of use:<uri xlink:type="simple" xlink:href="http://www.nature.com/authors/editorial_policies/license.html#terms">http://www.nature.com/authors/editorial_policies/license.html#terms</uri></license-p>
      </license>
    </permissions>
    <abstract id="ABS1">
      <p id="P5">Recent work examining astrocytic physiology centers on fluorescence imaging, due to development of sensitive fluorescent indicators and observation of spatiotemporally complex calcium activity. However, the field remains hindered in characterizing these dynamics, both within single cells and at the population level, because of the insufficiency of current region-of-interest (ROI)-based approaches to describe activity that is often spatially unfixed, size-varying, and propagative. Here, we present an analytical framework that releases astrocyte biologists from ROI-based tools. The Astrocyte Quantitative Analysis (AQuA) software takes an event-based perspective to model and accurately quantify complex calcium and neurotransmitter activity in fluorescence imaging datasets. We apply AQuA to a range of <italic>ex vivo</italic> and <italic>in vivo</italic> imaging data, and uncover novel physiological phenomena. Since AQuA is data-driven and based on machine learning principles, it can be applied across model organisms, fluorescent indicators, experimental modes, and imaging resolutions and speeds, enabling researchers to elucidate fundamental neural physiology.</p>
    </abstract>
  </article-meta>
</front>
<body>
  <sec id="S1">
    <title>Introduction</title>
    <p id="P6">With increased prevalence of multiphoton imaging and optical probes to study astrocyte physiology<sup><xref rid="R1" ref-type="bibr">1</xref>–<xref rid="R3" ref-type="bibr">3</xref></sup>, many groups now have tools to study fundamental functions that previously remained unclear. Recent work has focused on new ways to decipher how astrocytes respond to neurotransmitter and neuromodulator circuit signals<sup><xref rid="R4" ref-type="bibr">4</xref>–<xref rid="R7" ref-type="bibr">7</xref></sup> and how the spatiotemporal patterns of their activity shape local neuronal activity<sup><xref rid="R8" ref-type="bibr">8</xref>–<xref rid="R10" ref-type="bibr">10</xref></sup>. Recording astrocytic dynamics to decoding their disparate roles in neural circuits has centered on expression of genetically encoded probes to carry out intracellular calcium (Ca<sup>2+</sup>) imaging using GCaMP variants<sup><xref rid="R3" ref-type="bibr">3</xref></sup>. In addition, many groups study astrocytic function by performing extracellular glutamate imaging using GluSnFR<sup><xref rid="R2" ref-type="bibr">2</xref></sup>, and several more recently developed genetically encoded fluorescent probes for neurotransmitters such as GABA<sup><xref rid="R11" ref-type="bibr">11</xref></sup>, norepinephrine (NE)<sup><xref rid="R12" ref-type="bibr">12</xref></sup>, ATP<sup><xref rid="R13" ref-type="bibr">13</xref></sup>, and dopamine<sup><xref rid="R14" ref-type="bibr">14</xref></sup> are poised to further expand our understanding of astrocytic circuit biology.</p>
    <p id="P7">Compared to neuronal Ca<sup>2+</sup> imaging, astrocytic GCaMP imaging presents particular challenges for analysis due to the complex spatiotemporal dynamics observed. Astrocyte-specific analysis software has been developed to capture these Ca<sup>2+</sup> dynamics, several of which identify subcellular regions-of-interest (ROIs) for analysis<sup><xref rid="R4" ref-type="bibr">4</xref>,<xref rid="R15" ref-type="bibr">15</xref></sup>. Likewise, GluSnFR imaging analysis techniques are based on manually or semi-manually selected ROIs, or by analyzing the entire imaging field together as one ROI<sup><xref rid="R2" ref-type="bibr">2</xref>,<xref rid="R6" ref-type="bibr">6</xref>,<xref rid="R8" ref-type="bibr">8</xref>,<xref rid="R16" ref-type="bibr">16</xref></sup>. Thus most, although not all<sup><xref rid="R17" ref-type="bibr">17</xref>,<xref rid="R18" ref-type="bibr">18</xref></sup>, other current techniques rely on the conceptual framework of ROIs for image analysis. However, astrocytic Ca<sup>2+</sup> and GluSnFR fluorescence dynamics are particularly ill-suited for ROI-based approaches, because the concept of the ROI has several inherent assumptions that cannot be satisfied for astrocytic activity data. For example, astrocytic Ca<sup>2+</sup> signals can occupy regions that change size or location across time, propagate within or across cells, and spatially overlap with other Ca<sup>2+</sup> signals that are temporally distinct. ROI-based approaches assume that for a given ROI, all signals have a fixed size and shape, and all locations within the ROI undergo the same dynamics, without propagation. Accordingly, ROI-based techniques may over- or under-sample these data, obscuring true dynamics and hindering discovery. An ideal imaging analysis framework for astrocytes would take into account all these dynamic features and be free of ROI-based analytical restrictions. In addition, an ideal tool should be applicable to astrocyte imaging data across spatial scales, encompassing subcellular, cellular, and population-wide fluorescence dynamics.</p>
    <p id="P8">We set out to design an image analysis toolbox that would capture the complex, wide-ranging fluorescent signals observed in most dynamic astrocyte imaging datasets. We reasoned that a non-ROI-based approach would better describe the observed fluorescent dynamics, and applied probability theory, machine learning, and computational optimization techniques to generate an algorithm to do so. We name this resulting software package Astrocyte Quantitative Analysis (AQuA) and validate its utility by applying it to simulated datasets that reflect the specific features that make analyzing astrocyte data challenging. We next apply AQuA to experimental two-photon (2P) imaging datasets—<italic>ex vivo</italic> Ca<sup>2+</sup> imaging of GCaMP6 from acute cortical slices; <italic>in vivo</italic> Ca<sup>2+</sup> imaging of GCaMP6 in primary visual cortex (V1) of awake, head-fixed mice; and <italic>ex vivo</italic> extracellular glutamate, GABA, and NE imaging. In these test cases, we find that AQuA accurately detects fluorescence dynamics by capturing events as they change in space and time, rather than from a single location, as in ROI-based approaches. AQuA outputs a comprehensive set of biologically relevant parameters from these datasets, including propagation speed, propagation direction, area, shape, and spatial frequency. Using these detected events and associated output features, we uncover neurobiological phenomena.</p>
    <p id="P9">A wide variety of functions have been ascribed to astrocytes, and a key question currently under examination in the field is whether certain types of Ca<sup>2+</sup> activities correspond to particular neurobiological functions. However, current techniques with which to classify these observed dynamics remain inadequate since they do not capture many of the dynamics recorded in fluorescent imaging of astrocytic activity. The framework we describe allows for a rigorous, in-depth dissection of astrocyte physiology across spatial and temporal imaging scales, and sets the stage for a comprehensive categorization of heterogeneous astrocyte activities both at baseline and after experimental manipulations.</p>
  </sec>
  <sec id="S2">
    <title>Results</title>
    <sec id="S3">
      <title>Design principles of the AQuA algorithm</title>
      <p id="P10">To move away from ROI-based analysis approaches and accurately capture heterogeneous astrocyte fluorescence dynamics, we designed an algorithm to decompose raw dynamic astrocyte imaging data into a set of quantifiable events (<xref rid="F1" ref-type="fig">Fig 1a</xref>, <xref rid="SD2" ref-type="supplementary-material">Supp. Video 1</xref>, <xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 1</xref>–<xref rid="SD1" ref-type="supplementary-material">3</xref>). Here, we define an event as a cycle of a signal increase and decrease that coherently occurs in a spatially connected region defined by the fluorescence dynamics, not <italic>a priori</italic> by the user or the cell morphology. Algorithmically, this definition is converted to the following two rules: 1) the temporal trajectory for an event contains only one peak (single-cycle rule, <xref rid="F1" ref-type="fig">Fig. 1b</xref>) and <xref rid="F2" ref-type="fig">2</xref>) adjacent locations in the same event have similar trajectories (smoothness rule, <xref rid="F1" ref-type="fig">Fig. 1b</xref>). The task of the AQuA algorithm is to detect all events, and, for each event, to identify the temporal trajectory, the spatial footprint, and the signal propagation. Briefly, our strategy of event-detection is to a) explore the single-cycle rule to find peaks, which are used to specify the time window and temporal trajectory, b) explore the smoothness rule to group spatially adjacent peaks, whose locations specify the footprint, c) apply machine learning and optimization techniques to iteratively refine the spatial and temporal properties of the event to best fit the data, and d) apply statistical theory to determine whether a detected event is purely due to noise (<xref rid="F1" ref-type="fig">Fig. 1</xref>).</p>
      <p id="P11">Full statistical and computational details are provided in the Methods, but we highlight one technical innovation (Graphical Time Warping [GTW])<sup><xref rid="R19" ref-type="bibr">19</xref></sup> and one new concept (the single-source rule) that jointly enable a nuanced analysis of astrocyte fluorescence dynamics as shown below when applied to experimental datasets. To the best of our knowledge, signal propagation has never been rigorously accounted for and has been considered an obstacle to analysis. With GTW, we can estimate and quantify propagation patterns in the data. With the introduction of the single-source rule (<xref rid="F1" ref-type="fig">Fig. 1b</xref>), each event only contains a single initiation source and we can separate events that are initiated at different locations but meet in the middle. The single-source rule also allows us to divide large-scale activity across an entire field-of-view into individual events, each with a single initiation location.</p>
      <p id="P12">The output of the event-based AQuA algorithm is a list of detected events, each associated with three categories of parameters: 1) the spatial map indicating where the event occurs, 2) the dynamic curve corresponding to fluorescence change over time (dF/F), and 3) the propagation map indicating signal propagation. For each event, we use the spatial map to compute the event area, diameter and shape of the domain it occupies (<xref rid="F1" ref-type="fig">Fig 1c</xref>). Using the dynamic curve, we can calculate maximum dF/F, duration, onset-time, rise-time and decay-time. Using the propagation map, we extract event initiation location, as well as propagation path, direction, and speed. In addition, AQuA computes features involving more than one event, such as the frequency of events at a position, and the overall number of events in a specified region or cell. A complete list of features is in the Methods.</p>
    </sec>
    <sec id="S4">
      <title>Validation of AQuA using simulated data</title>
      <p id="P13">To validate AQuA, we designed three simulation datasets to know the ground truth dynamics of each event. These datasets independently vary the three key phenomena in astrocyte imaging datasets that cause ROI-based approaches to misanalyze the data: size-variability, location-variability, and propagation. While these phenomena usually co-occur in real datasets, we simulated each independently to examine its individual impact and test AQuA’s performance relative to other image analysis tools, including CaImAn<sup><xref rid="R20" ref-type="bibr">20</xref></sup>, Suite2P<sup><xref rid="R21" ref-type="bibr">21</xref></sup>, CaSCaDe<sup><xref rid="R15" ref-type="bibr">15</xref></sup>, and GECI-quant<sup><xref rid="R4" ref-type="bibr">4</xref></sup>. CaImAn and Suite2P are widely used for neuronal Ca<sup>2+</sup> imaging analysis while CaSCaDe and GECI-quant were designed specifically for Ca<sup>2+</sup> activity in astrocytes; all four methods are ROI-based. In our analysis of these simulated datasets, we optimally tuned the ROI-detection for all methods for an objective comparison of the best performance of each method. We also systematically changed the signal-to-noise-ratio (SNR) to examine the effect of noise.</p>
      <p id="P14">To evaluate the performance on all simulated datasets, we used two measures: IoU and a map of the event counts. IoU (intersection over union) measures the consistency between detected and the ground-truth events, and takes into account both the spatial and temporal accuracy of detected events. IoU ranges from 0 to 1, where 1 indicates perfect detection and 0 indicates a complete failure in detection. The map of the event counts is obtained by counting the number of events at each pixel in the field, and is used to visually assess the accuracy of event-detection results by a comparison to the ground-truth map.</p>
      <p id="P15">We first studied the impact of size-varying events (<xref rid="F2" ref-type="fig">Fig. 2a</xref>), in which multiple events occurred at the same location and the event centers remain fixed, but sizes changed across different events. The degree of size change is quantified using size-change odds (see <xref rid="S9" ref-type="sec">Methods</xref>) where a size-change odds of 1 indicates events with the same size, while an odds of 5 is the largest simulated size change. For example, when the odds are at 5, events with sizes randomly distributed between 0.2 and 5 times the baseline size are simulated. When there was no size change (odds=1), all methods performed well with IoUs near 0.95 (<xref rid="F2" ref-type="fig">Fig. 2a</xref>). When the size change was increased, AQuA still performed well (IoU=0.95), while all other methods quickly drop to 0.4–0.5. We next studied the impact of SNR on performance by varying SNR, but fixing the size-change odds. AQuA performed better with increasing SNR and achieved nearly perfect detection accuracy (IoU=1) at 20dB. In comparison, all other methods had an IoU less than 0.6, even at high SNR (<xref rid="F2" ref-type="fig">Fig. 2a</xref>). We also examined the results by visualizing event counts at each pixel (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 4</xref>–<xref rid="SD1" ref-type="supplementary-material">5</xref>). These maps show that AQuA faithfully reported the events under various SNRs but the other methods had erroneous event counts with artificial patterns.</p>
      <p id="P16">We next focused on shifting event locations. In these simulated datasets, event size was fixed but location changed, the degree of which was represented by a location-change score (<xref rid="F2" ref-type="fig">Fig. 2b</xref>). Zero indicates no location change and greater values represent larger degrees of change. Here, results are similar to changing size, as above. AQuA models the location change well and its performance is not affected by degree of location change. Likewise, AQuA reached near perfect results when SNR was high. In contrast, all other analysis methods performed poorly with changing locations (<xref rid="F2" ref-type="fig">Fig. 2b</xref>, <xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 4</xref>).</p>
      <p id="P17">In our third simulated dataset, we asked how fluorescence signal propagation impacts the performance of AQuA and other methods. Two propagation types—growing and moving—were simulated in this dataset (<xref rid="F2" ref-type="fig">Fig. 2c</xref>), although they were also separately evaluated (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig 6</xref>). Propagation frame number denotes the difference between the earliest and latest onset times within a single event. When propagation frame number is zero, all signals within one ROI are synchronized and there is no propagation. Similar results to the two scenarios above were obtained here, with AQuA out-performing all the other methods by a large margin. These results indicate that AQuA handles various types of propagation well, while the performance of other methods degrades rapidly when propagation is introduced.</p>
      <p id="P18">In summary, when any of the three ROI-violating factors—size-variability, location-variability, and propagation—is introduced, other methods do not accurately capture the dynamics of the simulated data, and AQuA outperforms them by a large margin. We expect that the performance margin on real experimental data is larger than those quantified in the simulation studies here, since real data exhibits multiple ROI-violating factors. However, these IoU analyses and the event count visualizations informed us about different types of errors observed in ROI-based methods: CaSCaDe tends to over-segment, as it is based on watershed segmentation, and GECI-quant is particularly challenged by noise, causing many lost signals (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 5</xref>). We note that propagation caused ROI-based approaches to quickly decline in performance, with GECI-quant influenced by noise level and CaSCaDe’s assumption of synchronized signals not allowing for accurate capture of event dynamics.</p>
    </sec>
    <sec id="S5">
      <title>AQuA enables identification of single-cell physiological heterogeneities</title>
      <p id="P19">To test AQuA’s performance on real astrocyte fluorescence imaging data and ask whether AQuA could classify Ca<sup>2+</sup> activities observed in single cells, we next ran AQuA on Ca<sup>2+</sup> activity recorded from astrocytes in acute cortical slices from mouse V1 using 2P microscopy. We used a viral approach to express the genetically encoded Ca<sup>2+</sup> indicator GCaMP6f<sup><xref rid="R3" ref-type="bibr">3</xref></sup> in layer 2/3 (L2/3) astrocytes. Unlike ROI-based approaches, AQuA detects both propagative and non-propagative activity, revealing Ca<sup>2+</sup> events with a variety of shapes and sizes (<xref rid="F3" ref-type="fig">Fig. 3a</xref>, left). Further, since AQuA detects Ca<sup>2+</sup> events’ spatial footprint and time-course, we can apply AQuA to measure the propagation direction each event travels over its lifetime. Imaging single cells, we used the soma as a landmark, and classified events as traveling toward the soma (pink), away from the soma (purple), or static (blue) for the majority of its lifetime (<xref rid="F3" ref-type="fig">Fig. 3a</xref>, right). We then combined multiple measurements (size, propagation direction, duration, and minimum proximity to soma) into one spatiotemporal summary plot (<xref rid="F3" ref-type="fig">Fig. 3b</xref>). Since astrocytes exhibit a wide diversity of Ca<sup>2+</sup> activities across subcellular compartments<sup><xref rid="R6" ref-type="bibr">6</xref>,<xref rid="R22" ref-type="bibr">22</xref>,<xref rid="R23" ref-type="bibr">23</xref></sup>, plotting the signals this way rather than standard dF/F transients highlights these heterogeneities, allows us to map the subcellular location of the Ca<sup>2+</sup> signals, and enables a quick, visual impression of large amounts of complex data (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 7</xref>). We note that while the expression of GCaMP6 in these experiments enabled us to analyze events within single cells, some probes do not allow clear delineation of single cells. However, a secondary fluorophore (such as TdTomato) often serves the purpose of defining the morphology of single cells, and the AQuA software is designed to overlay morphological masks on the dynamic fluorescence channel.</p>
      <p id="P20">We next asked whether some subcellular regions of astrocytes have more dynamic activity than others. Although we detected more static events than dynamic ones overall (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 8a</xref>), we observed a higher proportion of dynamic events than static events in the soma (59%, <xref rid="F3" ref-type="fig">Fig. 3c</xref>, <xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 8b</xref>). We then characterized events by propagation direction and event initiation location (<xref rid="F3" ref-type="fig">Fig. 3d</xref>). Events that begin close to the soma and propagate away (purple) were on average larger than the events propagating toward the soma (pink, two-tailed t-test). Similarly, those events that began close to the soma and propagated away showed a longer duration than events propagating toward the soma (two-tailed t-test, <xref rid="F3" ref-type="fig">Fig. 3e</xref>, <xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 8</xref>).</p>
      <p id="P21">AQuA automatically extracts many features which can be used to form a comprehensive Ca<sup>2+</sup> measurement matrix, where each row represents an event and each column an extracted feature (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 9</xref>). Dimensionality reduction applied to this matrix can then be used to visualize each cell’s Ca<sup>2+</sup> signature (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 9</xref>, white rows separate individual cells). To do this, we applied t-distributed Stochastic Neighbor Embedding (t-SNE)<sup><xref rid="R24" ref-type="bibr">24</xref></sup>, followed by k-means clustering to assign the cells to groups (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 9</xref>), revealing clusters marked by cells with large differences in median frequency (<xref rid="F3" ref-type="fig">Fig. 3f</xref>). Astrocytic Ca<sup>2+</sup> frequency is commonly measured as the number of transients in time within an ROI. Here, we instead define frequency from an event-based perspective in two ways: 1) for each event, the number of other events that overlap in time, and 2) for each event, the number of other events that overlap in space. We used these two measures (temporal and spatial overlap) and several other extracted measures (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 9</xref>) to construct the matrix used for t-SNE visualization and clustering. We then tested how well our AQuA-specific features perform at clustering compared to two ROI-based methods (<xref rid="F3" ref-type="fig">Fig. 3g</xref>), and found that the AQuA-based method outperformed the others. In fact, even when we only use AQuA-specific features—area, temporal overlap, spatial overlap, and propagation speed—for this analysis and remove all features that can be extracted from ROI-based methods, AQuA still significantly outperforms in clustering cells (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 9g</xref>–<xref rid="SD1" ref-type="supplementary-material">i</xref>). AQuA-extracted features that correspond to those that can be obtained by ROI-based methods—frequency, amplitude, duration—do not allow clustering significantly better than the ROI-based approaches themselves (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 9g</xref>–<xref rid="SD1" ref-type="supplementary-material">i</xref>), suggesting that AQuA-specific features best capture dynamic fluorescence features that vary among single cells. This indicates that AQuA may be used to extract data from existing <italic>ex vivo</italic> Ca<sup>2+</sup> imaging datasets to reveal previously uncovered dynamics and sort cells into functionally relevant clusters.</p>
    </sec>
    <sec id="S6">
      <title>In vivo astrocytic Ca<sup>2+</sup> bursts display anatomical directionality</title>
      <p id="P22">Recent interest in astrocytic activity at the mesoscale has been driven by multi-cellular astrocytic Ca<sup>2+</sup> imaging<sup><xref rid="R1" ref-type="bibr">1</xref>,<xref rid="R5" ref-type="bibr">5</xref>,<xref rid="R7" ref-type="bibr">7</xref>,<xref rid="R8" ref-type="bibr">8</xref>,<xref rid="R25" ref-type="bibr">25</xref>–<xref rid="R27" ref-type="bibr">27</xref></sup>, so we next applied AQuA to <italic>in vivo</italic>, population-level astrocyte Ca<sup>2+</sup> activity. Previous studies have described temporal details of astrocyte activation<sup><xref rid="R4" ref-type="bibr">4</xref>,<xref rid="R5" ref-type="bibr">5</xref>,<xref rid="R7" ref-type="bibr">7</xref>,<xref rid="R8" ref-type="bibr">8</xref>,<xref rid="R25" ref-type="bibr">25</xref></sup>, yet have left largely unaddressed the combined spatiotemporal properties of Ca<sup>2+</sup> activity at the circuit-level, across multiple cells. Here, we explored whether AQuA can uncover spatial patterns within populations of cortical astrocytes in an awake animal, and carried out head-fixed, 2P imaging of GCaMP6f in V1 astrocytes. <italic>In vivo</italic> cortical astrocytes exhibit both small, focal, desynchronized Ca<sup>2+</sup> activity<sup><xref rid="R25" ref-type="bibr">25</xref></sup>, and large, coordinated activities<sup><xref rid="R4" ref-type="bibr">4</xref>,<xref rid="R5" ref-type="bibr">5</xref></sup> that we refer to as bursts. Importantly, AQuA detected both types of Ca<sup>2+</sup> activity within the same <italic>in vivo</italic> imaging datasets (<xref rid="SD2" ref-type="supplementary-material">Video 2</xref>, <xref rid="F4" ref-type="fig">Fig. 4a</xref>). Similar to previous studies, we observed many of the bursts co-occurring with locomotion (<xref rid="F4" ref-type="fig">Fig. 4b</xref>, pink), and many events within these bursts displayed propagation (<xref rid="F4" ref-type="fig">Fig. 4c</xref>, top). Propagative events were larger in area and propagated greater distances than those occurring during the inter-burst periods (<xref rid="F4" ref-type="fig">Fig. 4c</xref>, bottom). To test whether AQuA could help us discover discrete features of this phenomenon, we next focused our investigation on the burst-period events (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 10</xref>).</p>
      <p id="P23">To analyze the structure of these burst-period Ca<sup>2+</sup> events, we investigated fluorescence propagation across multiple spatial scales: at the level of individual events, of subregions of the imaging field encompassing multiple events, and of the entire imaging field. At the level of individual events within a single burst, plotting the individual event direction within the entire field of view did not reveal a consistent propagation direction (<xref rid="F4" ref-type="fig">Fig. 4d</xref>). However, when we divided our field-of-view into equivalently sized, subregional tiles (<xref rid="F4" ref-type="fig">Fig. 4e</xref>), we observed more consistent propagation direction within single subregions (<xref rid="F4" ref-type="fig">Fig. 4f</xref>). When we plot the cumulative count of the percentage of bursts with regions that propagate in the same direction, we indeed observe that this curve is right-shifted compared to a simulated random assignment of majority regional propagation direction (<xref rid="F4" ref-type="fig">Fig. 4g</xref>), suggesting regularity in the propagation pattern within bursts that only becomes apparent at larger spatial scales. Thus, we next explored whole imaging field dynamics during Ca<sup>2+</sup> bursts. The percentage of the active field-of-view varied across burst periods (<xref rid="F4" ref-type="fig">Fig. 4b</xref>), with a wide variability from few to hundreds of events (<xref rid="F4" ref-type="fig">Fig. 4h</xref>). To control for number and size of events, we used the difference between each event’s onset time to calculate a single burst-wide propagation direction (<xref rid="F4" ref-type="fig">Fig. 4h</xref>, black arrow). Doing so revealed a consistent posterior-medial directionality of population Ca<sup>2+</sup> activity (<xref rid="F4" ref-type="fig">Fig. 4i</xref>). Although Ca<sup>2+</sup> bursts have been previously observed using GCaMP6 imaging in awake mice<sup><xref rid="R4" ref-type="bibr">4</xref>,<xref rid="R5" ref-type="bibr">5</xref></sup>, consistent spatial directionality with respect to the underlying anatomy has never been described. This observed posterior-medial directionality may be revealing anatomical and physiological underpinnings of these bursts, and since they have been shown to be at least partly mediated by norepinephrine<sup><xref rid="R5" ref-type="bibr">5</xref>,<xref rid="R7" ref-type="bibr">7</xref></sup>, they could be reflective of responses to incoming adrenergic axons originating in locus coeruleus. Regardless of mechanism(s), these results suggest that <italic>in vivo</italic>, astrocytic Ca<sup>2+</sup> propagation dynamics differ depending on the spatial scale examined, which may explain previously described discrepancies.</p>
    </sec>
    <sec id="S7">
      <title>AQuA-based analysis of extracellular neurotransmitter fluorescence dynamics</title>
      <p id="P24">We next asked whether AQuA could be used to detect other spatiotemporally complex fluorescent dynamics distinct from astrocytic Ca<sup>2+</sup>. We decided to image extracellular-facing neurotransmitter probes, including GluSnFR<sup><xref rid="R2" ref-type="bibr">2</xref>,<xref rid="R6" ref-type="bibr">6</xref>,<xref rid="R8" ref-type="bibr">8</xref></sup> since astrocytes regulate extracellular glutamate. GluSnFR dynamics are much faster than GCaMP dynamics, causing detection to be very susceptible to low SNR. This can be an additional challenge and many previous GluSnFR analyses have relied on averaging across multiple trials. While GluSnFR has been expressed both in astrocytes and in neurons previously<sup><xref rid="R2" ref-type="bibr">2</xref>,<xref rid="R8" ref-type="bibr">8</xref>,<xref rid="R16" ref-type="bibr">16</xref>,<xref rid="R28" ref-type="bibr">28</xref></sup>, how cell type-specific expression and morphology determines its fluorescent dynamics has not been fully explored<sup><xref rid="R16" ref-type="bibr">16</xref>,<xref rid="R28" ref-type="bibr">28</xref></sup>. Likewise, no previously applied analytical tools have been reported to automatically detect GluSnFR or other neurotransmitter events to accommodate different event sizes and shapes. Here, we explored whether application of AQuA could be used to detect cell type-specific differences in glutamate dynamics that may be based on heterogeneous underlying morphologies and cell biological mechanisms.</p>
      <p id="P25">We expressed GluSnFR in either astrocytes or neurons using cell type-specific viruses<sup><xref rid="R2" ref-type="bibr">2</xref></sup> and carried out 2P imaging of spontaneous GluSnFR activity in acute cortical V1 slices. Distinct morphological differences between astrocytic and neuronal expression of GluSnFR were evident, as observed previously<sup><xref rid="R8" ref-type="bibr">8</xref>,<xref rid="R29" ref-type="bibr">29</xref>,<xref rid="R30" ref-type="bibr">30</xref></sup> (<xref rid="F5" ref-type="fig">Fig. 5a</xref>). We applied AQuA to these datasets to detect significant fluorescent increases, and were able to detect events that were too small and fast to detect by eye (<xref rid="SD2" ref-type="supplementary-material">Video 3</xref>); AQuA-detected events were confirmed by <italic>post hoc</italic> ROI-based analysis. 62% of astrocytic events had an area less than the size of a single astrocyte, and 8% of astrocytic and 35% of neuronal glutamate events had a small maximum dF/F (less than 0.5). Because GluSnFR events have previously been detected by spatial averaging or by manual detection, many AQuA-detected event are most likely missed by ROI-based methods<sup><xref rid="R6" ref-type="bibr">6</xref>,<xref rid="R8" ref-type="bibr">8</xref>,<xref rid="R16" ref-type="bibr">16</xref></sup> (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 11</xref>). Because AQuA detects events independently from shape or size, events of heterogeneous size and shape were revealed during this analysis (<xref rid="F5" ref-type="fig">Fig. 5a</xref>–<xref rid="F5" ref-type="fig">b</xref>). A large proportion of these spontaneous GluSnFR events changed size over the course of the event, with 42% of total astrocytic and 32% of total neuronal glutamate events exhibiting area changes. On average, astrocytic GluSnFR events were significantly larger (274 ± 39.56 μm<sup>2</sup>) than neuronal events (172 ± 57.06 μm<sup>2</sup>), sometimes encompassing an entire astrocyte (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 11</xref>). Neuronal GluSnFR events were significantly more circular (<xref rid="F5" ref-type="fig">Figure 5b</xref>–<xref rid="F5" ref-type="fig">d</xref>), perhaps reflecting morphological differences between cell types. Between cell types, GluSnFR events also exhibited different size dynamics (<xref rid="F5" ref-type="fig">Fig. 5b</xref>–<xref rid="F5" ref-type="fig">c</xref>). We also observed that the rate of size decrease of astrocytic events between frames was larger than that of neuronal events (<xref rid="F5" ref-type="fig">Fig. 5c</xref>), which may reflect differential synaptic and extrasynaptic glutamate dynamics in proximity to subcellular compartments of each cell type.</p>
      <p id="P26">After showing that AQuA-based detection was effective for quantification of spontaneous GluSnFR activity, we tested its performance on fast, evoked glutamate events, since GluSnFR is used to measure synaptic glutamate release at fast acquisition rates<sup><xref rid="R2" ref-type="bibr">2</xref>,<xref rid="R31" ref-type="bibr">31</xref></sup>. To do this, we performed fast (~100Hz) GluSnFR imaging while photoactivating a caged glutamate compound (RuBi-glutamate<sup><xref rid="R10" ref-type="bibr">10</xref>,<xref rid="R32" ref-type="bibr">32</xref></sup>) with a second laser beam. In these experiments, we uncaged glutamate for varying durations (25–150ms), and applied AQuA to detect these small-scale, fast events (<xref rid="F5" ref-type="fig">Fig. 5d</xref>, right). AQuA detection showed high accuracy levels across all uncaging durations, with a minimum of 96% average accuracy across durations (<xref rid="F5" ref-type="fig">Fig. 5d</xref>, right; n=5 cells, 3 replicates/cell), indicateing that AQuA works well for event detection at fast frame rates.</p>
      <p id="P27">We lastly tested whether AQuA can be used with other probes relevant for astrocyte-neuron physiology by imaging two recently developed genetically encoded probes that report extracellular neurotransmitter dynamics: GABASnFR<sup><xref rid="R11" ref-type="bibr">11</xref></sup> and GRAB-NE<sup><xref rid="R12" ref-type="bibr">12</xref></sup>. We expressed GABASnFR (<xref rid="F5" ref-type="fig">Fig. 5e</xref>, left) in cortical astrocytes and GRAB-NE in cortical neurons (<xref rid="F5" ref-type="fig">Fig 5f</xref>, left), and performed <italic>ex vivo</italic> imaging with bath application of either GABA or NE. For GABASnFR expression in individual astrocytes, AQuA-detected events increased in amplitude and area with cell-specific dynamics (<xref rid="F5" ref-type="fig">Fig. 5e</xref>, right). The widespread neuronal expression of GRAB-NE allowed us to detect the location, amplitude, and area of NE waves as they progressed across the slice (<xref rid="F5" ref-type="fig">Fig 5f</xref>, right), indicating that AQuA may be useful to quantify propagating wavefronts in other contexts. Together, these results suggest that AQuA-based detection can be used to quantify dynamics of extracellular molecules at a range of speeds and spatial spreads, across multiple cell types and expression patterns.</p>
    </sec>
  </sec>
  <sec id="S8">
    <title>Discussion</title>
    <p id="P28">With the development of an event-based analysis tool, we have enabled accurate quantification of fluorescence dynamics that are un-fixed, propagative, and size varying. Here, we demonstrate that AQuA performs better than other image analysis methods on simulated datasets, and describe event detection using several genetically encoded indicators. AQuA can also be applied to datasets not directly tested here, including those captured under different magnifications and spatial resolutions, as well as under confocal or wide-field imaging. Since AQuA functions independently from frame rate, datasets captured faster or slower<sup><xref rid="R17" ref-type="bibr">17</xref>,<xref rid="R25" ref-type="bibr">25</xref></sup> are also amenable to an AQuA-based analysis. Further, AQuA is applicable to fluorescent indicators other than the ones tested here, particularly those that exhibit complex dynamics.</p>
    <p id="P29">We envision the AQuA software as enabling problem-solving for a wide range of astrocyte physiological questions, because it accurately captures dynamics exhibited by commonly used fluorescent indicators. Since AQuA-specific features captured observed heterogeneities among single cells, these features may be more physiologically relevant than the standard measurements (amplitude, frequency, duration) used to describe astrocytic physiology. Beyond baseline differences, we expect that AQuA will be a powerful tool to quantify physiological effects of pharmacological, genetic, and optogenetic manipulations.</p>
    <p id="P30">Significant disagreement about basic physiological functions of astrocytes remains. One outstanding issue is whether astrocytes release transmitters such as glutamate. While we don’t address this topic here, we expect that the heterogeneous activities uncovered using in-depth GluSnFR analysis may be key in determining different sources of glutamate under different conditions, and could help untangle conflicting data. AQuA here may be particularly useful in this regard as next-generation GluSnFR variants become available and make multiplexed imaging experiments increasingly accessible<sup><xref rid="R31" ref-type="bibr">31</xref></sup>. Astrocyte Ca<sup>2+</sup> imaging data can largely be grouped into two categories: single-cell imaging and population-wide imaging focusing of many cells. Experimental data and neurobiological conclusions from these two groups can differ quite widely. This may be due, in part, to population-wide bursts observed with locomotion onset <italic>in vivo</italic>. Many ROI-based techniques used to analyze these bursts can under-sample inter-burst events by swamping out smaller or shorter signals. Our technique can sample small- and large-scale activity in the same dataset and may aid researchers in resolving outstanding physiological problems.</p>
    <p id="P31">As demonstrated by its utility with Ca<sup>2+</sup>, glutamate, GABA, and NE datasets, AQuA can now be applied to many other fluorescence imaging datasets that exhibit non-static or propagative activity, particularly since it is open-source and user-tunable. For example, recently described Ca<sup>2+</sup> dynamics in oligodendrocytes display some similar properties to astrocyte Ca<sup>2+<xref rid="R33" ref-type="bibr">33</xref>,<xref rid="R34" ref-type="bibr">34</xref></sup>. Likewise, subcellular neuronal compartments, such as dendrites or dendritic spines can exhibit propagative, wave-like Ca<sup>2+</sup> signals<sup><xref rid="R35" ref-type="bibr">35</xref></sup> while whole-brain neuronal imaging can capture burst-like, population-wide events<sup><xref rid="R36" ref-type="bibr">36</xref></sup>.</p>
    <p id="P32">We predict that the potential applications of AQuA are wide, but AQuA also has limitations. Since it detects local fluorescence increases, AQuA is not well suited to analyze morphological dynamics, such as those observed in microglia, and it does not improve on tools built for analyzing somatic neuronal Ca<sup>2+<xref rid="R20" ref-type="bibr">20</xref>,<xref rid="R21" ref-type="bibr">21</xref></sup>, where ROI assumptions are well satisfied. In addition, AQuA was optimized for 2D datasets, as these comprise the majority of current astrocyte imaging experiments. As techniques for volumetric imaging advance, an extension to accommodate 3D imaging experiments will be necessary. AQuA is expandable to 3D datasets since the algorithmic design is not restricted to 2D assumptions. A full 3D AQuA version is beyond the scope of this paper, but a 3D prototype performed well on simulated 3D data based on published<sup><xref rid="R17" ref-type="bibr">17</xref></sup> astrocytes (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 12</xref>). These results suggest that a full 3D version will work on real volumetric datasets in the future and demonstrate that AQuA is a flexible and robust platform that can accommodate new data types without large changes to the underlying algorithm.</p>
  </sec>
  <sec id="S9">
    <title>Methods</title>
    <sec id="S10">
      <title>Viral injections and surgical procedures</title>
      <p id="P33">All procedures were carried out in accordance with protocols approved by the UCSF Institutional Animal Care and Use Committee. For slice experiments, neonatal mice (Swiss Webster, P0–P4) were anesthetized by crushed ice anesthesia for 3 minutes and injected with 90nL total virus of <italic>AAV5-GFaABC1D.Lck-GCaMP6f</italic>, <italic>AAV5-GFaABC1D.cyto-GCaMP6f, AAV1-GFAP-iGluSnFR, AAV1-hsyn-iGluSnFR, AAV2-GFAP-iGABASnFR.F102G, and AAV9-hsyn-NE2.1</italic> at a rate of 2–3nL/sec. Six injections 0.5μm apart in a 2×3 grid pattern with 15nL/injection into assumed V1 were performed 0.2μm below pial surface using a UMP-3 microsyringe pump (World Precision Instruments). Mice were used for slice imaging experiments at P10–23.</p>
      <p id="P34">For <italic>in vivo</italic> experiments, adult mice (C57Bl/6, P50–100) were given dexamethasone (5mg/kg) subcutaneously prior to surgery and then anesthetized under isoflurane. A titanium headplate was attached to the skull using C&amp;B Metabond (Parkell) and a 3mm diameter craniotomy was cut over the right hemisphere ensuring access to visual cortex. Two 300nL injections (600nL total virus) of <italic>AAV5-GFaABC1D.cyto-GCaMP6f</italic> were made into visual cortex (0.5–1.0mm anterior and 1.75–2.5mm lateral of bregma) at a depth of 0.2–0.3mm and 0.5mm from the pial surface, respectively. Virus was injected at a rate of 2nL/s, with a 10min wait following each injection to allow for diffusion. Following viral injection, a glass cranial window was implanted to allow for chronic imaging and secured using C&amp;B metabond<sup><xref rid="R37" ref-type="bibr">37</xref></sup>. Mice were given at least ten days to recover, followed by habituation for three days to head fixation on a circular treadmill, prior to imaging.</p>
    </sec>
    <sec id="S11">
      <title>Two-photon imaging</title>
      <p id="P35">All 2P imaging experiments were carried out on a microscope (Bruker Ultima IV) equipped with a Ti:Sa laser (MaiTai, SpectraPhysics). The laser beam was intensity-modulated using a Pockels cell (Conoptics) and scanned with linear or resonant galvonometers. Images were acquired with a 16x, 0.8 N.A. (Nikon, <italic>in vivo</italic> GCaMP and <italic>ex vivo</italic> GRAB-NE) or 40x, 0.8. N.A. objective (Nikon, <italic>ex vivo</italic> GCaMP, GluSnFR, and GABASnFR) via a photomultiplier tube (Hamamatsu) using PrairieView (Bruker) software. For imaging, 950nm (GCaMP), 910nm (GluSnFR and GABASnFR), or 920nm (GRAB-NE) excitation and a 515/30 emission filter was used.</p>
    </sec>
    <sec id="S12">
      <title>Ex vivo imaging</title>
      <p id="P36">Coronal, acute neocortical slices (400μm thick) from P10–P23 mice were cut with a vibratome (VT 1200, Leica) in ice-cold cutting solution (in mM): 27 NaHCO<sub>3</sub>, 1.5 NaH<sub>2</sub>PO<sub>4</sub>, 222 sucrose, 2.6 KCl, 2 MgSO<sub>4</sub>, 2 CaCl<sub>2</sub>. Slices were incubated in standard continuously aerated (95% O<sub>2</sub>/5% CO<sub>2</sub>) artificial cerebrospinal fluid (ACSF) containing (in mM): 123 NaCl, 26 NaHCO<sub>3</sub>, 1 NaH<sub>2</sub>PO<sub>4</sub>, 10 dextrose, 3 KCl, 2 CaCl<sub>2</sub>, 2 MgSO<sub>4</sub>, heated to 37°C and removed from water bath immediately before introducing slices. Slices were held in ACSF at room temperature until imaging. Experiments were performed in continuously aerated, standard ACSF. 2P scanning for all probes was carried out at 512×512 pixel resolution. Acquisition frame rates were 1.1Hz (GCaMP), 4–100Hz (GluSnFR), 6Hz (GABASnFR), and 1.4Hz (GRAB-NE). For GluSnFR imaging and RuBi-glutamate uncaging experiments, GluSnFR imaging was performed at 950nm excitation to ensure that no RuBi-glutamate was released during scanning. Acquisition rates were between 95–100Hz, using resonant galvonometers. 300μM RuBi-glutamate was added to the circulating ACSF and using a second MaiTai laser tuned to 800nm, five uncaging points were successively uncaged at each cell at durations indicated in the figure and at power &lt;3mW that were shown in control experiments to cause no direct cell activation.</p>
    </sec>
    <sec id="S13">
      <title>In vivo GCaMP imaging</title>
      <p id="P37">At least two weeks following surgery mice were head-fixed to a circular treadmill and astrocyte calcium activity was visualized at ~2Hz effective frame rate from layers 2/3 of visual cortex with a 512×512 pixel resolution at 0.8 microns/pixel. Locomotion speed was monitored using an optoswitch (Newark Element 14) connected to an Arduino.</p>
    </sec>
    <sec id="S14">
      <title>AQuA algorithm and event detection</title>
      <sec id="S15">
        <title>Overview of the AQuA algorithm</title>
        <p id="P38">Astrocytic events are heterogeneous and varying with respect to many aspects of their properties. In AQuA, we extensively applied machine learning techniques to flexibly model these events, so that our approach is data-driven and physiologically relevant parameters are extracted from the data instead of imposing <italic>a priori</italic> assumptions. Probability theory and numerical optimization techniques were applied to optimally extract fluorescent signals from background fluctuations. Here, we delineate the eight major steps in AQuA (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 1</xref>), discuss motivations behind the algorithm design, and describe key technical considerations in further detail.</p>
        <p id="P39">Step 1: data normalization and preprocessing. This step removes experimental artifacts such as motion effects, and processes the data so that noise can be well approximated by a standard Gaussian distribution. Particular attention is paid to the variance stabilization, estimate of baseline fluorescence, and variance. Step 2: detect active voxels. Step 3: identify seeds for peak detection. Step 4: detect peaks and their spatiotemporal extension. These three steps work together to achieve peak detection. To detect peaks we start from a seed, which is modeled as a spatiotemporal local maximum. However, since random fluctuations due to background noise can also result in local maxima, we need to detect active voxels such that only the local maxima on the active voxels are considered as seeds. Here, active voxels are those likely to have signals. Step 5: cluster peaks to identify candidates for super-events. Temporarily ignoring the single-source requirement, the set of spatially-adjacent and temporally-close peaks is defined as a super-event. However, clustering results of spatially adjacent peaks are not super-events themselves, because a peak group may consist of noise voxels and temporally distant events. Step 6: estimate the signal propagation patterns. Step 7: Detect super-events. To get super-events from peak clusters, we compute the temporal closeness between spatially adjacent peaks by estimating signal propagation patterns. The propagation pattern for each event is also important for its own sake, by providing a new way to quantify activity patterns. Step 8: split super-event into individual events with different sources. A super-event is split into individual events by further exploiting propagation patterns. Based on propagation patterns within a super-event, the locations of event initiation are identified as local minima of the onset time map. Each initiation location serves as the event seed. Individual events are obtained by assigning each pixel to an event based on spatial connectivity and temporal similarity.</p>
      </sec>
      <sec id="S16">
        <title>Step 1(Data normalization and preprocessing):</title>
        <p id="P40">We correct for motion artifacts in the <italic>in vivo</italic> dataset using standard image registration techniques before applying AQuA. However, AQuA does not necessarily require motion correction because it performs event-based analysis, which is localized temporally and thus less prone to motion artifacts.</p>
        <p id="P41">We perform data normalization and preprocessing to approximate noise by a Gaussian distribution with mean=0 and standard deviation=1. For those who want to directly modify our code, pseudocode is available (<xref rid="SD2" ref-type="supplementary-material">Supp. Table 1</xref>). To achieve this normalization, we first apply a square-root transformation to the data to ensure that the noise variance after transformation is not related to the intensity itself, an operation also known as variance stabilization. Variance stabilization is important so that events with bright signals are not over-emphasized and events with dim signals not neglected. Next, the noise variance of the transformed data for each pixel is estimated as half of the median of the square of differences between two adjacent values in the time series at the pixel. Mathematically, denote <italic>X</italic><sub><italic>i</italic></sub> the time series at the <italic>i</italic>th pixel, where <italic>X</italic><sub><italic>i</italic></sub>[<italic>t</italic>] is the value of the <italic>t</italic>th time point. Then, the noise variance <inline-formula><mml:math display="inline" id="M1" overflow="scroll"><mml:mrow><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> at the <italic>i</italic>th pixel is estimated as
<disp-formula id="FD1"><mml:math display="block" id="M2" overflow="scroll"><mml:mrow><mml:msubsup><mml:mi>σ</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mn>2</mml:mn></mml:mfrac><mml:msub><mml:mrow><mml:mtext>median</mml:mtext></mml:mrow><mml:mrow><mml:mi>t</mml:mi><mml:mtext>=2,</mml:mtext><mml:mn>…</mml:mn><mml:mtext>,T</mml:mtext></mml:mrow></mml:msub><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>X</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:msub><mml:mi>X</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow><mml:mo>}</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p>
        <p id="P42">We do not use the conventional sample variance <inline-formula><mml:math display="inline" id="M3" overflow="scroll"><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mi>T</mml:mi></mml:mfrac><mml:msup><mml:mrow><mml:mstyle><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>T</mml:mi></mml:msubsup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>X</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mtext>mean</mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>X</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:math></inline-formula> as the estimate, which tends to inflate the variance when signals exist in the time series. Third, to estimate the baseline fluorescence <italic>F</italic><sub>0</sub> for each pixel, we compute the minimum of the moving average of 25 time-points in a user-specified local time window (default=200 in our experiments). We do not use the full time series to identify the minimum, in order to be robust to image degradation or other long-term trends. Considering the minimum is a biased estimate of the baseline fluorescence, we add a pre-determined quantity to the minimum to serve as the estimate of <italic>F</italic><sub>0</sub>. Here, the pre-determined quantity depends on the extent of the moving average and the size of the time window, and is found through simulation. Denote <italic>V</italic><sub><italic>i</italic></sub>[<italic>t</italic>] as the value of <italic>i</italic>th pixel at the <italic>t</italic>th frame in the raw video data. In the following, all modeling is performed on the normalized data,
<disp-formula id="FD2"><mml:math display="block" id="M4" overflow="scroll"><mml:mrow><mml:msub><mml:mi>Z</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msqrt><mml:mrow><mml:msub><mml:mi>V</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mi>t</mml:mi><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msqrt><mml:mo>−</mml:mo><mml:msqrt><mml:mrow><mml:msub><mml:mi>F</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:msqrt></mml:mrow><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>
where the subscript <italic>i</italic> denotes that the baseline fluorescence and noise variance are location- and pixel-specific. It is worth noting that the data normalization and preprocessing is used to build an accurate statistical model so that signals can be reliably distinguished from noise. When we extract activity-related features such as rise and decay time, raw data is used.</p>
      </sec>
      <sec id="S17">
        <title>Step 2 (Detecting active voxels):</title>
        <p id="P43">A voxel is defined as a pixel of a certain frame. For example, voxel (<italic>x</italic>, <italic>y</italic>, <italic>t</italic>) denotes the pixel at location (<italic>x</italic>, <italic>y</italic>) in the <italic>t</italic>th frame in the movie. An active voxel is the voxel that contains an activity signal. If a voxel is not associated with any event, it is not considered active. Since an event often occupies multiple pixels and extends several frames, we first apply 3D Gaussian filtering to smooth the data to reduce the impact of noise. Then, we calculate the z-scores for each voxel in the smoothed data. Here, z-score is computed as the value of the voxel divided by its standard deviation, which can be estimated as in the normalization procedure above, but now on the smoothed data. All voxels that have z-scores larger than a given threshold are considered tentative active voxels. A liberal threshold is used here to retain most signals, often at a z-score of 3. We next calculate the size of groups of connected tentative active voxels, with spatially connected tentative active belonging to the same group and a minimum size threshold (often 4). If a group of tentative active voxels is less than the threshold, all voxels in this group are removed, resulting in a final list of active voxels. Pseudocode is presented in <xref rid="SD2" ref-type="supplementary-material">Supp. Table 1</xref>.</p>
        <p id="P44">Our event detection can be roughly described as finding bumps in space-time, and it could be asked why we don’t simply set a threshold on the ΔF data and identify all components larger than the threshold as events. This method is essentially equivalent to our Step 2 (<italic>Detecting active voxels</italic>), but there are motivations to go beyond this step. Even if simple thresholding detected individual events perfectly, many features of each event—such as propagation patterns—cannot be directly derived. More importantly, no threshold we have found can faithfully detect real events (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 3</xref>). Three types of commonly observed complexities lead to this insufficiency in thresholding (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig 3b</xref>). First, not all pixels drop below the threshold because of residual signals. Second, neighboring events occurring at different times can be spatiotemporally connected. Third, two events can be temporally separated when they appear, but meet with each other after propagation.</p>
      </sec>
      <sec id="S18">
        <title>Step 3 (Identifying seeds for peak detection):</title>
        <p id="P45">Similar to the detection of active voxels, we apply 3D Gaussian smoothing to the normalized data and then find all local maxima, defined as connected components of pixels with a constant intensity value and with all neighboring pixels having a lower value. Considering our time-lapse images as three-dimensional arrays (2D space plus 1D time), each single pixel has 26 neighbors. Although each local maximum generally occupies one pixel due to random fluctuation inherent in the data, this definition allows a local maximum to occupy multiple pixels of the same intensity value. This is helpful for the case in which some pixels have saturated values. Because pure random fluctuation can also lead to local maxima, we restrict the search of local maxima to active voxels only (see pseudocode in <xref rid="SD2" ref-type="supplementary-material">Supp. Table 1</xref>). The resultant local maxima are considered seeds for the purpose of peak detection, the subsequent step in the algorithm. We start peak detection by identifying the local maxima as seeds because the maxima are likely to contain the strongest signal and thus have a better SNR than other points. The 3D Gaussian smoothing is used to further improve SNR, motivated by the fact that an event occupies multiple pixels and spans multiple time points.</p>
      </sec>
      <sec id="S19">
        <title>Step 4 (Detecting peaks and their spatiotemporal extent):</title>
        <p id="P46">We partially and temporally extend each seed detected above to all voxels that are potentially associated with each event. We call the collection of the seed and its extended voxels the <italic>super voxel</italic>. Seeds are processed one-by-one, with higher intensity seeds processed first. Each seed is first extended temporally, then spatially.</p>
        <p id="P47">The spatiotemporal index (<italic>x</italic><sub>0</sub>, <italic>y</italic><sub>0</sub>, <italic>t</italic><sub>0</sub>) denotes the seed. When we temporally extend the seed backwards and forwards (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig 2b</xref>, <xref rid="SD2" ref-type="supplementary-material">Supp. Table 2</xref>), we encounter two main scenarios. In the first, a voxel before (<italic>x</italic><sub>0</sub>, <italic>y</italic><sub>0</sub>, <italic>t</italic><sub>0</sub>) has a value close to the baseline <italic>F</italic><sub>0</sub>, and a voxel after (<italic>x</italic><sub>0</sub>, <italic>y</italic><sub>0</sub>, <italic>t</italic><sub>0</sub>) also is close to <italic>F</italic><sub>0</sub>. If a voxel has an intensity &lt;20% of the seed value, it is defined as close to baseline. In this scenario, the seed is extended temporally until it reaches these two voxels. In the second scenario, extension in at least one of two directions never meets a voxel with value that is considered close to the baseline before meeting another seed. This scenario could happen when one event begins before the previous event drops completely to the baseline fluorescence level. To determine whether these two seeds should be merged and thus belong to the same event, we denote <italic>V</italic><sub>min</sub> the minimum value between the two seeds and calculate the difference between <italic>V</italic><sub>min</sub> and value at the seed (<italic>x</italic><sub>0</sub>, <italic>y</italic><sub>0</sub>, <italic>t</italic><sub>0</sub>). If the difference is larger than the threshold Δ<sub><italic>tw</italic></sub>, which is 2<italic>σ</italic><sub>0</sub> by default for most data, the minimum is considered the end of the extension. Otherwise, these two seeds are merged and the extension continues. For very high peaks, this threshold is too low for perceptually meaningful separation. To split two adjacent high Δ<italic>F</italic> peaks, a strong decrease between them is needed and the threshold is changed to Δ<sub><italic>tw</italic></sub> = max(0.3<italic>ΔF</italic>(<italic>x</italic>, <italic>y</italic>, <italic>t</italic><sub>0</sub>), 2<italic>σ</italic><sub>0</sub>).</p>
        <p id="P48">Once each seed <italic>i</italic> is temporally extended from (<italic>x</italic><sub><italic>i</italic></sub>, <italic>y</italic><sub><italic>i</italic></sub>, <italic>t</italic><sub><italic>i</italic></sub>) to a peak (<italic>x</italic><sub><italic>i</italic></sub>, <italic>y</italic><sub><italic>i</italic></sub>, (<italic>t</italic><sub><italic>i</italic></sub> − <italic>a</italic><sub><italic>i</italic></sub>): (<italic>t</italic><sub><italic>i</italic></sub> + <italic>b</italic><sub><italic>i</italic></sub>)), (<italic>t</italic><sub><italic>i</italic></sub> − <italic>a</italic><sub><italic>i</italic></sub>): (<italic>t</italic><sub><italic>i</italic></sub> + <italic>b</italic><sub><italic>i</italic></sub>) denotes a time window spanning from <italic>t</italic><sub><italic>i</italic></sub> − <italic>a</italic><sub><italic>i</italic></sub> to <italic>t</italic><sub><italic>i</italic></sub> + <italic>b</italic><sub><italic>i</italic></sub>. We define reference curve <italic>c</italic><sub><italic>i</italic></sub> as the average of nine pixels around (<italic>x</italic><sub><italic>i</italic></sub>, <italic>y</italic><sub><italic>i</italic></sub>) in that time window. To spatially extend each peak to cover most signals-of-interest, each seed becomes a set of voxels <inline-formula><mml:math display="inline" id="M5" overflow="scroll"><mml:mrow><mml:msubsup><mml:mtext>∪</mml:mtext><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>K</mml:mi></mml:msubsup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mspace width="1pt"/><mml:msub><mml:mi>y</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mspace width="1pt"/><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>a</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>:</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>t</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>b</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></inline-formula> after extension, where the corresponding spatial footprint, <italic>K</italic> pixels {(<italic>x</italic><sub><italic>ik</italic></sub>, <italic>y</italic><sub><italic>ik</italic></sub>), <italic>k</italic> = 1 … <italic>K</italic>}, is spatially connected. During this process, each seed is associated with two sets. The first is Ω<sub><italic>i</italic></sub>, which are pixels already associated with seed <italic>i</italic>. Each pixel in this set, (<italic>x</italic><sub><italic>i</italic>1</sub>, <italic>y</italic><sub><italic>i</italic>1</sub>), e. g., corresponds to a set of voxels: (<italic>x</italic><sub><italic>i</italic>1</sub>, <italic>y</italic><sub><italic>i</italic>1</sub>, <italic>t</italic><sub><italic>i</italic></sub> – <italic>a</italic><sub><italic>i</italic></sub>: <italic>t</italic><sub><italic>i</italic></sub> + <italic>b</italic><sub><italic>i</italic></sub>). The second set is Θ<sub><italic>i</italic></sub>, the set of pixels to avoid. Initially, Ω<sub><italic>i</italic></sub> = {(<italic>x</italic><sub><italic>i</italic></sub>, <italic>y</italic><sub><italic>i</italic></sub>)} and Θ<sub><italic>i</italic></sub> is empty.</p>
        <p id="P49">The spatial extension operation for each seed is repeated a maximum of 40 rounds. For each seed, the set Ω<sub><italic>i</italic></sub> is spatially dilated with a 3×3 square, thus only testing pixels adjacent to the Ω<sub><italic>i</italic></sub> boundary. Next, Θ<sub><italic>i</italic></sub> is removed from the dilated region. We then test whether each new pixel should be added to Ω<sub><italic>i</italic></sub> or not. Because for each given new pixel and each time window we have a time series, we can calculate the Pearson correlation coefficient between this time series and <italic>c</italic><sub><italic>i</italic></sub>. The correlation coefficient is converted to a z-score using the Fisher transform. If the z-score is higher than the user-defined given threshold, the pixel is added to Ω<sub><italic>i</italic></sub>. Otherwise, it is added to Θ<sub><italic>i</italic></sub>. Because all seeds are local maxima, no time alignment is needed here.</p>
        <p id="P50">During the extension process, different super voxels can meet. We want to stop the extension process of one super voxel only when it meets the bright part of other super voxels (50% rising to 50% decaying). For example, we have two peaks from two seeds: (<italic>x</italic><sub>1</sub>, <italic>y</italic><sub>1</sub>, (<italic>t</italic><sub>1</sub> – <italic>a</italic><sub>1</sub>): (<italic>t</italic><sub>1</sub> + <italic>b</italic><sub>1</sub>)) and (<italic>x</italic><sub>2</sub>, <italic>y</italic><sub>2</sub>, (<italic>t</italic><sub>2</sub> – <italic>a</italic><sub>2</sub>): (<italic>t</italic><sub>2</sub> + <italic>b</italic><sub>2</sub>)). Assume the first seed has already occupied pixel (<italic>x</italic><sub>3</sub>, <italic>y</italic><sub>3</sub>). When the second seed tries to determine whether it should extend to (<italic>x</italic><sub>3</sub>, <italic>y</italic><sub>3</sub>) or not, we calculate whether (<italic>t</italic><sub>1</sub> – <italic>a</italic><sub>1</sub>: <italic>t</italic><sub>1</sub> + <italic>b</italic><sub>1</sub>) and (<italic>t</italic><sub>2</sub> – <italic>a</italic><sub>2</sub>: <italic>t</italic><sub>2</sub> + <italic>b</italic><sub>2</sub>) sufficiently overlap. Two peaks sufficient overlap if the 50% rising to 50% decay ranges of the two peaks overlap. Thus, if (<italic>t</italic><sub>1</sub> – <italic>a</italic><sub>1</sub>: <italic>t</italic><sub>1</sub> + <italic>b</italic><sub>1</sub>) and (<italic>t</italic><sub>2</sub> – <italic>a</italic><sub>2</sub>: <italic>t</italic><sub>2</sub> + <italic>b</italic><sub>2</sub>) sufficiently overlap, seed two will not include pixel (<italic>x</italic><sub>3</sub>, <italic>y</italic><sub>3</sub>) and it is added to Θ<sub>2</sub>. Otherwise, it is added to Ω<sub>2</sub>. After spatial extension is complete, we remove super voxels with Ω<sub><italic>i</italic></sub> &lt; 4 pixels or total voxels &lt; 8 pixels.</p>
      </sec>
      <sec id="S20">
        <title>Step 5 (Clustering peaks to identify candidates for super-events):</title>
        <p id="P51">A super-event is defined as a group of events connected spatially but originating from different initiation locations. This step was motivated by the frequent observation in real data that multiple events can be spatially connected at some time point. One example is a large burst in the <italic>in vivo</italic> dataset, where multiple events start at different places but merge as a burst at later stage. Another example is a set of two events originating from different places, propagating and meeting each other in the middle (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 3</xref>). Thus, in a spatial direction, we may encounter multiple events within the super-event. However, we never encounter two or more events in the temporal direction, which guides the following algorithm. To identify candidates for super-events, we next cluster peaks, but these results are not identical to super-events, because voxels extended to be associated with the peak may have some errors. As discussed below, the candidate super-event must be purified to resolve the final super-event.</p>
        <p id="P52">Since each super-voxel extends from its seed (representative peak), we also call the process of clustering super-voxels as clustering peaks for conceptual convenience. If two super-voxels are connected and their rise-time difference is less than a given threshold (as discussed below), they are considered neighbors. For two super-voxels, if 10% of pixels of either super-voxel is also occupied by the other, they are a conflicting pair. For each super-voxel, we list all its neighbors and conflicting counterparts. To cluster peaks/super-voxels (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 2b</xref>, <xref rid="SD2" ref-type="supplementary-material">Supp. Table 3</xref>), we begin with the earliest occurring super-voxel and check each of its neighbors. If a neighbor is not conflicting with that super-voxel, it is combined with the super-voxel. This process is repeated until no new super-voxel can be added. Then we move to the next earliest super-voxel that is not added to any others, and repeat this process. An iterative approach prioritizes events that are close to each other. Supposing the largest rising time difference for super-voxels that is allowed to be neighbors is 10, we start the procedure with the allowed difference as 0 and merge the super voxels. Then we increment the allowed difference by 1 and repeat the step above, until the rising time difference allowed reaches 10.</p>
      </sec>
      <sec id="S21">
        <title>Step 6 (Estimating signal propagation patterns):</title>
        <p id="P53">For each spatial location/pixel, an associated time series indicates the signal dynamics. Estimation of propagation patterns is formulated as a mathematical problem of time alignment between the time series at each location and a representative/reference time series. Time alignment results directly relay the delay of a given pixel at a time frame with respect to the representative dynamics. Conventionally, time alignment is accomplished by dynamic time warping (DTW). However, DTW is notoriously prone to noise, which leads to unreliable propagation estimation. Since two adjacent pixels have more similar propagation patterns than two distant pixels, we impose a smoothness constraint on neighboring pixels using our recently developed mathematical model—Graphical Time Warping (GTW)—to explicitly incorporate this constraint. However, since we do not have a representative time series at the very beginning, our strategy is to guess a reference time series from the data and align time series at each pixel to this reference. Then, we use alignment results to obtain an updated reference, and iterate the process of alignment and update of reference until it converges (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 2b</xref>, <xref rid="SD2" ref-type="supplementary-material">Supp. Table 3</xref>).</p>
        <p id="P54">To initialize the reference time series, we search for the voxel with the largest Δ<italic>F</italic>/<italic>F</italic> value and record that voxel’s location. The initial reference is then estimated as the average time series of the pixels in the 5×5 square around that location, with the square size a user-tunable parameter. The voxel with the largest Δ<italic>F</italic>/<italic>F</italic> value is used because it has the best signal-to-noise ratio. We do not use the time series at a single pixel to initiate the reference because it is noisy, nor do we use the average time series over all the pixels, because the average would be a large distortion to the representative dynamics due to signal propagation. Next, we supply the neighborhood graph and the reference time series to GTW to calculate the time alignment between all pixels and the reference. For each pixel, we consider the 8 pixels around the 3×3 grid as neighbors. A GTW parameter controls the balance between fitness and smoothness of the alignment. We empirically found 1 to be a good value. To control computational complexity, GTW has another parameter corresponding to the maximum time delay allowed. In all our experiments, we found no time delay induced by propagation is larger than 11 frames. So, we set that parameter to 11.</p>
      </sec>
      <sec id="S22">
        <title>Step 7 (Detecting super-events):</title>
        <p id="P55">Once the time alignment between the representative dynamics and the time series at each pixel is obtained, we refine candidate super-events to obtain final super-events. A super-event is defined as detected when the representative dynamics and all voxels are associated with the super-event. Since each voxel is jointly specified by spatial location and time frame, we next determine which pixels and time frames jointly belong to the super-event. Since representative dynamics are already obtained in the previous step of propagation estimation, here we focus on how to determine which pixels and which time frames are covered by the super-event.</p>
        <p id="P56">Because each pixel corresponds to a time series, if a pixel belongs to a super-event, its time series should be highly correlated to the representative dynamics of the super-event. Note that the correlation is calculated based on the aligned time series to account for the time distortion due to signal propagation. Thus, we first obtain a new time series for each pixel based on the time alignment obtained previously. Then, we calculate the Pearson correlation between each new time series and the representative dynamics, leading to a correlation map. We further convert the Pearson correlation to z-score using Fisher’s transform. Here, we do not use a threshold for each z-score to determine whether that pixel is statistically significantly associated with the super-event because that ignores the neighborhood information in the correlation map and is less statistically powerful. Instead, incorporating the information from the neighboring pixels, we apply our recently developed order-statistics-based region-growing method to determine which pixels should be associated with the super-event (<xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 2b</xref>, <xref rid="SD2" ref-type="supplementary-material">Supp. Table 3</xref>).</p>
        <p id="P57">To determine which time frames are associated with the super-event, we now examine the representative time series, calculating the maximum intensity along the curve and considering all time frames with intensity &gt;10% of the maximum to be associated with the super-event. Different pixels may have different time frames associated with the super-event. We use the time alignment results above to identify the time frames associated with the super-event for each pixel. A time frame at a given pixel is associated with the super-event as long as its corresponding time frame in the representative curve is associated with the super-event.</p>
      </sec>
      <sec id="S23">
        <title>Step 8 (Splitting super-events into individual events with different sources):</title>
        <p id="P58">For each super-event, we have a 2D map of rise-time for each pixel by re-aligning the super-event using GTW. The local minima in this map are potential originating locations for events in this super-event. However, noise may produce random local minima, which do not correspond to true originating locations and are removed by merging with spatially adjacent local minima. We use rise-time to determine whether two local minima should be merged. This idea can be illustrated with the following 1D example: [1 2 4 2 2]. The two local minima are the first and the last pixel (pixel <italic>i</italic> and <italic>j</italic>, respectively), occurring at time 1 (<italic>t</italic><sub>0</sub>) and 2 (<italic>t</italic><sub>1</sub>), respectively. To determine whether they should be merged, we find all paths connecting them. In this example, there is only one path and the pixel with the latest rise-time in this path is the third pixel (rise-time=4 (<italic>t</italic><sub><italic>m</italic></sub>)). The distance between pixel <italic>i</italic> and pixel <italic>j</italic> induced by this path is therefore defined as max(<italic>t</italic><sub><italic>m</italic></sub> – <italic>t</italic><sub>0</sub>, <italic>t</italic><sub><italic>m</italic></sub> – <italic>t</italic><sub>1</sub>). If the distance induced by any path is less than the given threshold, these two local minima are merged.</p>
        <p id="P59">We next separate super-events into individual events by simultaneously extending all remaining local minima. Each remaining local minimum corresponds to one event. Pixels attached to a local minimum are defined as growing. With each iteration, we add the earliest-occurring pixel to a growing event. If the pixel under examination is adjacent to a growing event, it is done, and then we find the next earliest occurring pixels. Otherwise, we add it to the waitlist and continue with the next earliest occurring one. Each time a pixel is successfully added to a growing event, pixels in the waitlist are checked as to whether they can be added to growing events. When the growing process ends, all individual events are obtained. (see pseudocode in <xref rid="SD2" ref-type="supplementary-material">Supp. Table 3</xref>).</p>
      </sec>
      <sec id="S24">
        <title>Run-time analysis of AQuA algorithm:</title>
        <p id="P60">In our implementation, ~ 60–70% of the total running time is spent on propagation estimation, and super-event detection and splitting. The super voxel detection step takes about 15% of the total time. Another 7% extracts features from each detected event. The event cleaning and post-processing takes ~6% of the total time, while it takes &lt;1% of the time to load the data and &lt;2% in the active voxel step, which finds baseline, estimates noise, and gets seeds. Tested on a desktop computer with Intel Xeon E5–2630 CPU and 128 GB memory using Windows and MATLAB version R2018b, the total running time ranges from several minutes to 1.5 hours, depending on file size and data complexity (<xref rid="SD2" ref-type="supplementary-material">Supp. Table 4</xref>).</p>
      </sec>
    </sec>
    <sec id="S25">
      <title>Generation of simulation data sets</title>
      <sec id="S26">
        <title>Spatial footprint templates:</title>
        <p id="P61">We built a set of templates for event footprints from real <italic>ex vivo</italic> data which serve as the basis for the ROI maps in the subsequent step. Footprints are processed by morphology closing, hole filling, and morphology opening to clean boundaries, with 1683 templates generated total.</p>
      </sec>
      <sec id="S27">
        <title>ROI maps:</title>
        <p id="P62">2D ROI maps generated from spatial footprint are used to generate events in subsequent steps. Different simulation types have a different preference for the size of the ROIs. Maximum number of ROIs is set at 100; ROIs are randomly chosen and placed onto a 2D map &lt;5 pixels from existing ROIs.</p>
      </sec>
      <sec id="S28">
        <title>Simulation dataset 1 (size-varying events):</title>
        <p id="P63">To simulate event size changes, we generate events for each ROI and then alter them to have different sizes so that each ROI in the 2D map will be related to multiple events whose centers are inside that ROI, but whose sizes are different. The degree of size change is characterized by the odds ratio (maximum = 5) between the maximum and the minimum allowable sizes of the events associated with that ROI. For example, with an odds ratio of 2, the size of the event will range from 50–200% of the ROI area. The chances for the event size to be larger or smaller than the area of the ROI are the same. To achieve this, we generate a random number between 1 and 2, then randomly assign whether to enlarge size by multiplying or shrink by dividing by this factor. Event duration is four frames.</p>
        <p id="P64">To determine the frames at which the event occurs, we first put the event 10–30 frames (randomly) after the ROI occurs. Spatial distance of this event from others must be ≥3 pixels and temporal distance ≥4 frames. Part of the event may be inside the spatial footprint of other ROIs, as long as its spatiotemporal distance to other events is larger than the threshold set above. Events are generated for each ROI; on average, we simulate 250 frames with 800 events on 90 ROIs.</p>
      </sec>
      <sec id="S29">
        <title>Simulation dataset 2 (location-changing events):</title>
        <p id="P65">To simulate event location changes, we generate events with the same size for each ROI and shift them to nearby locations. Thus, each ROI (450–550 pixel size) is related to multiple events near to that ROI. Denote <italic>dist</italic> the distance between the event center and the ROI center. Denote <italic>diam</italic> the diameter of the ROI. The degree of location change is quantified by the ratio between <italic>dist</italic> and <italic>diam</italic>. For example, if we set 0.5 as the maximum degree of location change, the distance of the center of a new event to the ROI will be 0–0.5 times the diameter of the ROI. If the ratio is 0, we simulate a pure ROI dataset. The new event may be located any direction from the ROI, randomly picked from 0–2π. Shapes of new events are randomly picked from the templates, so may be different from the ROI while size is constant. Event duration is four frames, and the remaining steps are the same as above. On average, we simulate 250 frames with 800 events on 90 ROIs.</p>
      </sec>
      <sec id="S30">
        <title>Simulation dataset 3 (propagating events):</title>
        <p id="P66">We simulated two types of propagation: growing and moving, leading to three types of synthetic datasets: growing only, moving only, and mixed. These three types are generated similarly. The ROI map is generated as above, and ROI sizes are 4,000–10,000 pixels, with events generated inside each ROI. In comparison, events in the size-change and location-change simulations can be (fully or partially) outside their corresponding ROIs. We simulate only one seed (starting propagation point) in each ROI. For each event, we generate a rise-time map (for each pixel in the ROI) and construct event-propagation based on the map. We obtain this map by simulating a growing process starting from the seed pixel, with the seed pixel active at the first time-point. At the next time point, its neighboring pixels are active with a variable success probability. Growth continues until ≥90% of pixels in the ROI are included in the event. Based on the rise-time map, we identify frames at which pixels become active in the event. To determine when the event ends, we treat growing and moving propagation differently. In growing propagation, all pixels are inactive simultaneously 2 frames after the last pixel becomes active. For moving propagation, the duration is 5 frames. Typically, we generate approximately 140 events in 14 ROIs for each synthetic dataset.</p>
      </sec>
      <sec id="S31">
        <title>Simulate various SNRs:</title>
        <p id="P67">Gaussian noise is added to the synthetic data to achieve various SNRs. We define the signal intensity as the average of all active pixels in all frames. SNR is defined as
<disp-formula id="FD3"><mml:math display="block" id="M6" overflow="scroll"><mml:mrow><mml:mn>20</mml:mn><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mtext>log</mml:mtext></mml:mrow><mml:mrow><mml:mn>10</mml:mn></mml:mrow></mml:msub><mml:mfrac><mml:mrow><mml:mtext>average signal intensity</mml:mtext></mml:mrow><mml:mrow><mml:mtext>noise standard deviation</mml:mtext></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p>
        <p id="P68">When we change the degree of location change, size change, and propagation duration, we add noise with 10 dB SNR. To study the impact of SNR on size changes, size-change degree is 3. For location changes, distance-change ratio is 0.5 while varying SNRs. For propagation, propagation duration is 5 frames. Seven SNRs are tested: 0, 2.5, 5, 7.5, 10, 15, 20 (all in dB).</p>
      </sec>
      <sec id="S32">
        <title>Post-processing simulated data:</title>
        <p id="P69">We set the average signal intensity at 0.2, with a range from 0–1. Synthetic data is spatially filtered to mimic blurred boundaries in real data. The smoothing is performed with a Gaussian filter with a standard deviation of 1. Signals with intensity &lt;0.05 after smoothing are removed. Remaining signals are temporally filtered with a kernel with a decay τ of 0.6 frames. The rising kernel is linear. For propagation simulation, data is down-sampled by five. Next, we perform a cleaning step. For each pixel in each event, we find the highest intensity (x_peak) across frames. For that pixel, we set signals that are &lt;0.2 times of x_peak to 0. Finally, a uniform background intensity of 0.2 is added (except for GECI-quant, where no background is added; see below).</p>
      </sec>
    </sec>
    <sec id="S33">
      <title>Application of AQuA and peer methods on the simulation data sets</title>
      <p id="P70">Based on our knowledge about simulated datasets, we apply specific considerations for each analytical method in order to set optimal parameters for each. In this way, we aim to assess the methodological limit of each method, rather than suboptimal performance due to inadequate parameter-setting. We expect that the performance of the peer methods on simulation data is an overestimate of their performance on real experimental data, because here we take advantage of the ground-truth knowledge, which is not available for experimental astrocyte data.</p>
      <sec id="S34">
        <title>Event detection using peer methods:</title>
        <p id="P71">AQuA and CaSCaDe report detected events, while other methods report detected ROIs. For a consistent comparison, we detect events from those methods that use ROIs. Once ROIs are detected, we calculate the average dF/F curve for each ROI, as follows: The curve is temporally smoothed with a time-window of 20. The minimum value in the smoothed curve is considered baseline. Assume the minimum value occurs at time <italic>t</italic><sub><italic>base</italic></sub>. The baseline is then subtracted to obtain the dF curve. The noise standard deviation σ is estimated using 40 frames around <italic>t</italic><sub><italic>base</italic></sub>. We then obtain a z-score curve as dF/σ. A large z-score indicates an event; we use a z-score threshold of <italic>z</italic><sub>0</sub>. The value <italic>z</italic><sub>0</sub> is set according to ground-truth knowledge, so that the smallest-size event in the simulation data is detected by this threshold. Denote <italic>x</italic><sub>0</sub> and <italic>s</italic><sub>0</sub> the peak intensity and the size for the smallest event in the ground truth. We also denote the ground truth noise level as <italic>σ</italic><sub>0</sub>. Then, the threshold is calculated as,
<disp-formula id="FD4"><mml:math display="block" id="M7" overflow="scroll"><mml:mrow><mml:msub><mml:mi>z</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>=</mml:mo><mml:mtext>min</mml:mtext><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mfrac><mml:mrow><mml:mn>0.9</mml:mn><mml:msub><mml:mi>x</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:msqrt><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mrow></mml:msqrt></mml:mrow><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mrow></mml:mfrac><mml:mo>,</mml:mo><mml:mn>10</mml:mn></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p>
        <p id="P72">We clip the score to 10 to avoid setting large values for high SNR. For CaSCaDe, we supply this value as the peak intensity threshold parameter.</p>
        <p id="P73">Using the z-score curves and threshold, we detect events from ROIs for CaImAn, Suite2P, and GECI-quant. For each z-score curve, we find all frames with values &gt;<italic>z</italic><sub>0</sub>. Each frame is a seed for an event. Assume the z-score for that frame is <italic>z</italic><sub>1</sub> and we search before and after that frame. If the intensity of the frame is ≥ 0.2<italic>z</italic><sub>1</sub>, the frame is associated with the event. If we meet frames with intensities &lt;0.2<italic>z</italic><sub>1</sub>, we stop searching that direction. Once finished, we obtain all frames associated with the event. We continue with another seed frame to find another event. Note that if a frame is considered part of an event, we do not consider it as a seed for another event, even if it is &gt;<italic>z</italic><sub>0</sub>. The spatial footprint is fixed for all frames in an event, based on the ROI detected. Combining spatial footprint and frames, we obtain events for each ROI and identify all voxels belonging to an event.</p>
      </sec>
      <sec id="S35">
        <title>Parameter setting for AQuA:</title>
        <p id="P74">The parameters of AQuA are based on the ex-vivo-GCaMP-cyto preset with the following modifications: For different noise levels, we apply different smoothness levels. The smoothing is performed only spatially and values are empirically chosen. The smoothness parameter is the standard deviation of the Gaussian smoothing kernel used.
<table-wrap id="T1" position="anchor" orientation="portrait"><table frame="box" rules="all"><colgroup span="1"><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/><col align="left" valign="middle" span="1"/></colgroup><tbody><tr><td align="left" valign="top" rowspan="1" colspan="1">SNR (dB)</td><td align="left" valign="top" rowspan="1" colspan="1">0</td><td align="left" valign="top" rowspan="1" colspan="1">2.5</td><td align="left" valign="top" rowspan="1" colspan="1">5</td><td align="left" valign="top" rowspan="1" colspan="1">7.5</td><td align="left" valign="top" rowspan="1" colspan="1">10</td><td align="left" valign="top" rowspan="1" colspan="1">15</td><td align="left" valign="top" rowspan="1" colspan="1">20</td></tr><tr><td align="left" valign="top" rowspan="1" colspan="1">Smoothness</td><td align="left" valign="top" rowspan="1" colspan="1">1</td><td align="left" valign="top" rowspan="1" colspan="1">0.9</td><td align="left" valign="top" rowspan="1" colspan="1">0.8</td><td align="left" valign="top" rowspan="1" colspan="1">0.7</td><td align="left" valign="top" rowspan="1" colspan="1">0.6</td><td align="left" valign="top" rowspan="1" colspan="1">0.5</td><td align="left" valign="top" rowspan="1" colspan="1">0.1</td></tr></tbody></table></table-wrap></p>
        <p id="P75">We do not simulate motion of the field-of-view, so we do not discard any boundary pixels, and we set regMaskGap = 0. We do not simulate Poisson Gaussian noise; we use additional Gaussian noise only, so PG = 0. Event sizes in the simulation are &gt;200 pixels, so we set the minimum event size to be a value much smaller: minSize = 16. An event may not have more than one peak, so we set cOver = 0. We do not simulate temporally adjacent events, so we set thrTWScl = 4. We do not use proofreading, so we choose a more stringent z-score of events: zThr = 5.</p>
      </sec>
      <sec id="S36">
        <title>Specific considerations for CaSCaDe:</title>
        <p id="P76">We use the following parameters for CaSCaDe: According to the duration and temporal distances of the simulated events, we can safely set peak distance p.min_peak_dist_ed = 3 and minimum peak length p.min_peak_length = 2. We set the spatial smoothing filter size in the 3D smoothing function (bpass3d_v1) according to the size of the event, so we set p.hb equal to 2x median of the radius of the spatial footprint of all events. We use this setting because the default settings could not detect larger events on the simulation data sets. For temporal smoothing, we set p.zhb=21. We do not need to correct background, so we set p.int_correct= 0. The minimum peak intensity is p.peak_int_ed = z0, as discussed above. Minimum event intensity is p.min_int_ed = min(2, p.peak_int_ed *0.2). We modified the low-frequency part of the watershed segmentation step to allow larger events to be detected, by changing the function <italic>bpassW</italic> inside the function <italic>domain_segment</italic>. We replaced the noise estimator in CaSCaDe (function <italic>estibkg</italic>) with the more robust one used by AQuA.</p>
        <p id="P77">CaSCaDe uses a supervised approach to classify detected events. Instead of manually labeling a large number of events and training many SVM models, we directly use ground truth to perform training. For example, for each event detected by CaSCaDe, we check the ground-truth data to test whether it is (part of) a true event. If so, it is retained; otherwise, it is discarded.</p>
      </sec>
      <sec id="S37">
        <title>Specific considerations for GECI-quant:</title>
        <p id="P78">GECI-quant requires user input at each step. Here, we describe how to automate these steps by taking advantage of ground-truth information. This allows us to test many conditions and repeat many times.</p>
        <p id="P79">First, we do not add background signals to the synthetic data, so background subtraction is ignored. The domain- and the soma-detection steps require manual thresholding. We estimate the best threshold using the ground-truth data for each simulation. To do so, we scan 255 thresholds and use the one that leads to the best correlation between binarized data and ground truth. We next cleaned the binarized signals with sizes &lt;4 pixels. The data here is also smoothed as it is in GECI-quant (3×3 spatial averaging). Events with spatial footprints &lt; 1,000 pixels are treated as domains and others are treated as somas. The soma segmentation step also uses a threshold. We first process the data as in GECI-quant: for every three frames, a standard-deviation map is calculated so that each voxel in ground-truth data is associated with a standard deviation value. The average of all standard deviations from the ground-truth data is used as the threshold.</p>
        <p id="P80">We next made the entire analysis pipeline automatic. Fiji is called from the command line in each step and parameters are passed as well. The final ROIs from Fiji are brought back into MATLAB. ROIs are &gt; 15 pixels in area. All other parameters are unchanged, including those for the particle detector. Note that this modification cannot be used as an automated version of GECI-quant for real applications since it relies on ground-truth information.</p>
      </sec>
      <sec id="S38">
        <title>Specific considerations for CaImAn:</title>
        <p id="P81">We experimented with different parameters for CaImAn and found the following set of parameters performed best on simulation data. As event size can be large, we enlarge the patch size, so patch_size = [128,128] and overlap = [32,32]. Components to be found is set to K = 50. The standard deviation of the Gaussian kernel (half size of a neuron) is enlarged to tau = 16. Maximum size is 5,000 and the minimum size is 25. Decay time is 0.5. Other parameters are based on default settings. No spatial or temporal down-sampling is used. Adjusting these parameters dis not impact results on our simulated data. We used the 5/5/2018 version downloaded from <ext-link ext-link-type="uri" xlink:href="https://github.com/flatironinstitute/CaImAn-MATLAB">https://github.com/flatironinstitute/CaImAn-MATLAB</ext-link>.</p>
      </sec>
      <sec id="S39">
        <title>Specific consideration for Suite2P:</title>
        <p id="P82">The most critical parameter for Suite2P is neuron size. We set db.diameter equal to the minimum between 50 and the median of the radius of the spatial footprint of all events. Setting the diameter too large leads to an out-of-memory issue. We bypass the registration step. We used the 6/4/18 version downloaded from <ext-link ext-link-type="uri" xlink:href="https://github.com/cortex-lab/Suite2P">https://github.com/cortex-lab/Suite2P</ext-link>.</p>
      </sec>
    </sec>
    <sec id="S40">
      <title>Performance evaluation on the simulated data</title>
      <p id="P83">To evaluate the accuracy of detected events, we quantify the intersection over the union (IoU). We consider all event voxels, not only pixels as in ROI-based methods. For each detected event <italic>i</italic>, we find all the ground-truth events that have common voxels with event <italic>i</italic>. For each such ground-truth event, e.g., event <italic>j</italic>, we calculate an IoU score (also known as Jaccard index) between this pair of events as the following,
<disp-formula id="FD5"><mml:math display="block" id="M8" overflow="scroll"><mml:mrow><mml:mi>I</mml:mi><mml:mi>o</mml:mi><mml:msub><mml:mi>U</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mtext>Number</mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtext>Voxels in event </mml:mtext><mml:mi>i</mml:mi><mml:mtext> </mml:mtext><mml:mo>∩</mml:mo><mml:mtext>Voxels in event </mml:mtext><mml:mi>j</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Number</mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtext>Voxels in event </mml:mtext><mml:mi>i</mml:mi><mml:mtext> </mml:mtext><mml:mo>∪</mml:mo><mml:mtext>Voxels in event </mml:mtext><mml:mi>j</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p>
      <p id="P84">When a detected event can be perfectly matched with a ground-truth event, its IoU score is 1. A score of 0 indicates this pair of events has nothing in common. For each detected event <italic>i</italic>, we find the maximum IoU score among all pairs between this event and a ground-truth event. We denote this maximum score as <italic>IoU</italic><sub><italic>i</italic></sub>. Similarly, we can compute a score <italic>IoU</italic><sub><italic>j</italic></sub> for the ground truth event <italic>j</italic>. The final IoU score is obtained by averaging over all events, including detected and ground-truth events. Supposing we have <italic>I</italic> detected events and <italic>J</italic> ground truth events, where <italic>I</italic> and <italic>J</italic> are not necessarily equal, we compute the final score as the following,
<disp-formula id="FD6"><mml:math display="block" id="M9" overflow="scroll"><mml:mrow><mml:mi>I</mml:mi><mml:mi>o</mml:mi><mml:mi>U</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mstyle><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>I</mml:mi></mml:msubsup><mml:mrow><mml:mi>I</mml:mi><mml:mi>o</mml:mi><mml:msub><mml:mi>U</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:mstyle><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>J</mml:mi></mml:msubsup><mml:mrow><mml:mi>I</mml:mi><mml:mi>o</mml:mi><mml:msub><mml:mi>U</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:mrow><mml:mrow><mml:mi>I</mml:mi><mml:mo>+</mml:mo><mml:mi>J</mml:mi></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p>
      <p id="P85">Each simulation is repeated 10 times. The mean and 95% confidence interval (CI) of IoU score is calculated and plotted. The CI is calculated as [<italic>μ</italic><sub><italic>sim</italic></sub> – 2<italic>σ</italic><sub><italic>sim</italic></sub>, <italic>μ</italic><sub><italic>sim</italic></sub> + 2<italic>σ</italic><sub><italic>sim</italic></sub>], where <italic>μ</italic><sub><italic>sim</italic></sub> is the estimated mean and <italic>σ</italic><sub><italic>sim</italic></sub> is the estimated standard deviation (<italic>σ</italic><sub><italic>sim</italic></sub>) based on 10 repetitive runs.</p>
    </sec>
    <sec id="S41">
      <title>Open-source software for analyzing and visualizing dynamic fluorescent signals in astrocytes</title>
      <p id="P86">Applying software engineering principles, we developed an open-source toolbox for astrocyte fluorescent imaging data with detailed user guidelines. The software not only implements the AQuA algorithm for detecting events, but also provides an integrated environment for users to see the <xref rid="S2" ref-type="sec">results</xref>, interact with the analysis, and combine other types of data such as cell/region masks and landmarks. There are two versions of the software with the same functionality, based on MATLAB or Fiji. The software is freely available at <ext-link ext-link-type="uri" xlink:href="https://github.com/yu-lab-vt/aqua">https://github.com/yu-lab-vt/aqua</ext-link> where detailed documents and example applications can be found. A list of extracted features is shown in <xref rid="SD2" ref-type="supplementary-material">Supp. Table 5</xref>. Highlights of the software follow.</p>
      <p id="P87">First, the software implements AQuA and provides several options to export the event-detection results, including TIFF files with color-coded events, event features in Excel, and MATLAB or Java data structures to be used by other programs. Second, the software can display analysis results by adding color to the raw video, where color encodes the value of a user-defined extracted feature such as propagation speed. Users can specify which feature to be displayed, either an existing feature in AQuA or a user-designed feature based on features provided by AQuA. We provide several pre-defined colormaps, but allow users to manually define colormaps as well. AQuA also provides a side-by-side view, to simultaneously display two features or a raw video plus one feature. Third, the software provides a convenient way to interactively view detected events and their associated features. By clicking on an event, the dF/F curve for the event is shown in a separate panel below the video, and the time-frames during which the event occurs are highlighted in red. The values of several other features for that event are also shown in another panel. The software allows multiple events to be selected simultaneously, so that their curves and features can be plotted together and compared. Fourth, the software provides both automatic and manual ways to proofread the results. For automatic proofreading, events are filtered by setting desired ranges for features-of-interest. Alternatively, users can choose the ‘delete/restore’ button and manually click an event to remove it. Fifth, the software provides flexible ways to incorporate cell morphology or landmark information. Users can manually supply cell morphology or regional information such as the cell boundary, which can assign events to individual cells. Users can also provide landmark information such as the location of a pipette for pharmacological application. Users can also load cell, region, or landmark information from other data sources, such as another fluorescence channel that captures cell morphology. The software can extract landmark-related features for each event, including the direction of propagation relative to a landmark.</p>
    </sec>
    <sec id="S42">
      <title>Statistics</title>
      <p id="P88">The confidence intervals in <xref rid="F2" ref-type="fig">Fig. 2</xref> and <xref rid="SD2" ref-type="supplementary-material">Supp. Fig. 6</xref> (confidence level, 95%) were estimated as 2 times of the standard deviation based on 10 independent simulations. The confidence intervals in <xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 12</xref> were based on 5 independent simulations. For imaging experiments, the following statistical tests were employed, as appropriate, and as indicated: one- and two-tailed t-test, Wilcoxon rank sum, chi-square test, k-means clustering, and the Freedman-Diaonis’s rule. No statistical methods were used to predetermine sample sizes but our sample sizes are similar to those reported in previous publications<sup><xref rid="R4" ref-type="bibr">4</xref>–<xref rid="R6" ref-type="bibr">6</xref>,<xref rid="R8" ref-type="bibr">8</xref></sup>, and statistical significance was calculated using <italic>post hoc</italic> tests. Data distribution was assumed to be normal but this was not formally tested. In terms of randomization, samples were allocated into experimental groups by cell-type expression of each individual fluorescent sensor, and <italic>ex vivo</italic> or <italic>in vivo</italic> methodology. Within each group, imaging datasets were collected at similar ages. Both male and female were used and randomly selected. Data collection and analysis were not performed blind to the conditions of the experiments. For GluSnFR studies, blinding was not possible, because cell-type expression is evident from the images themselves. Likewise, for GABASnFR and GRAB-NE experiments, blinding was not possible because we injected a single virus and bath applied only the relevant neurotransmitter. For GCaMP imaging studies, blinding was not relevant because all data within each dataset were grouped and analyzed together. No animals or data points were excluded from the analyses.</p>
    </sec>
    <sec id="S43">
      <title>Reporting Summary</title>
      <p id="P89">Further information on experimental design is available in the Life Sciences Reporting Summary linked to this article.</p>
    </sec>
    <sec id="S44">
      <title>Code availability</title>
      <p id="P90">The code has been released under GNU General Public License v3.0 and is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/yu-lab-vt/AQuA">https://github.com/yu-lab-vt/AQuA</ext-link>.</p>
    </sec>
    <sec sec-type="data-availability" id="S45">
      <title>Data Availability Statement</title>
      <p id="P91">The data that support the findings of this study are available from the corresponding authors upon request.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material" id="SM1">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="SD1">
      <label>1</label>
      <media xlink:href="NIHMS1537261-supplement-1.doc" orientation="portrait" xlink:type="simple" id="d36e2807" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD2">
      <label>2</label>
      <media xlink:href="NIHMS1537261-supplement-2.pdf" orientation="portrait" xlink:type="simple" id="d36e2811" position="anchor"/>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack id="S46">
    <title>Acknowledgements</title>
    <p id="P92">The authors acknowledge members of the Poskanzer and Yu labs for helpful discussions and comments on the manuscript. We thank Gregory Chin and Sae Yokoyama for excellent technical assistance. K.E.P. is supported by NIH R01NS099254, NIH R21DA048497, NSF 1604544, Brain Research Foundation Frank/Fay Seed Grant, E. Matilda Ziegler Foundation for the Blind, and the Bold &amp; Basic grant from the QBI at UCSF. G.Y. is supported by NIH R01MH110504 and NSF 1750931.</p>
  </ack>
  <fn-group>
    <fn fn-type="COI-statement" id="FN5">
      <p id="P93">Competing Interests</p>
      <p id="P94">The authors declare no competing interests.</p>
    </fn>
  </fn-group>
  <ref-list>
    <title>References</title>
    <ref id="R1">
      <label>1.</label>
      <mixed-citation publication-type="journal"><name><surname>Srinivasan</surname><given-names>R</given-names></name><etal/><article-title>New Transgenic Mouse Lines for Selectively Targeting Astrocytes and Studying Calcium Signals in Astrocyte Processes In Situ and In Vivo</article-title>. <source>Neuron</source><volume>92</volume>, <fpage>1181</fpage>–<lpage>1195</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">27939582</pub-id></mixed-citation>
    </ref>
    <ref id="R2">
      <label>2.</label>
      <mixed-citation publication-type="journal"><name><surname>Marvin</surname><given-names>JS</given-names></name><etal/><article-title>An optimized fluorescent probe for visualizing glutamate neurotransmission</article-title>. <source>Nat. Methods</source><volume>10</volume>, <fpage>162</fpage>–<lpage>170</lpage> (<year>2013</year>).<pub-id pub-id-type="pmid">23314171</pub-id></mixed-citation>
    </ref>
    <ref id="R3">
      <label>3.</label>
      <mixed-citation publication-type="journal"><name><surname>Chen</surname><given-names>T-W</given-names></name><etal/><article-title>Ultrasensitive fluorescent proteins for imaging neuronal activity</article-title>. <source>Nature</source><volume>499</volume>, <fpage>295</fpage>–<lpage>300</lpage> (<year>2013</year>).<pub-id pub-id-type="pmid">23868258</pub-id></mixed-citation>
    </ref>
    <ref id="R4">
      <label>4.</label>
      <mixed-citation publication-type="journal"><name><surname>Srinivasan</surname><given-names>R</given-names></name><etal/><article-title>Ca(2+) signaling in astrocytes from Ip3r2(−/−) mice in brain slices and during startle responses in vivo</article-title>. <source>Nat. Neurosci</source><volume>18</volume>, <fpage>708</fpage>–<lpage>717</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">25894291</pub-id></mixed-citation>
    </ref>
    <ref id="R5">
      <label>5.</label>
      <mixed-citation publication-type="journal"><name><surname>Paukert</surname><given-names>M</given-names></name><etal/><article-title>Norepinephrine controls astroglial responsiveness to local circuit activity</article-title>. <source>Neuron</source><volume>82</volume>, <fpage>1263</fpage>–<lpage>1270</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24945771</pub-id></mixed-citation>
    </ref>
    <ref id="R6">
      <label>6.</label>
      <mixed-citation publication-type="journal"><name><surname>Haustein</surname><given-names>MD</given-names></name><etal/><article-title>Conditions and constraints for astrocyte calcium signaling in the hippocampal mossy fiber pathway</article-title>. <source>Neuron</source><volume>82</volume>, <fpage>413</fpage>–<lpage>429</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24742463</pub-id></mixed-citation>
    </ref>
    <ref id="R7">
      <label>7.</label>
      <mixed-citation publication-type="journal"><name><surname>Ding</surname><given-names>F</given-names></name><etal/><article-title>α1-Adrenergic receptors mediate coordinated Ca2+ signaling of cortical astrocytes in awake, behaving mice</article-title>. <source>Cell Calcium</source><volume>54</volume>, <fpage>387</fpage>–<lpage>394</lpage> (<year>2013</year>).<pub-id pub-id-type="pmid">24138901</pub-id></mixed-citation>
    </ref>
    <ref id="R8">
      <label>8.</label>
      <mixed-citation publication-type="journal"><name><surname>Poskanzer</surname><given-names>KE</given-names></name> &amp; <name><surname>Yuste</surname><given-names>R</given-names></name>
<article-title>Astrocytes regulate cortical state switching in vivo</article-title>. <source>Proc. Natl. Acad. Sci. U.S.A</source>
<comment>201520759</comment> (<year>2016</year>). doi:<pub-id pub-id-type="doi">10.1073/pnas.1520759113</pub-id></mixed-citation>
    </ref>
    <ref id="R9">
      <label>9.</label>
      <mixed-citation publication-type="journal"><name><surname>Ma</surname><given-names>Z</given-names></name>, <name><surname>Stork</surname><given-names>T</given-names></name>, <name><surname>Bergles</surname><given-names>DE</given-names></name> &amp; <name><surname>Freeman</surname><given-names>MR</given-names></name>
<article-title>Neuromodulators signal through astrocytes to alter neural circuit activity and behaviour</article-title>. <source>Nature</source>
<volume>539</volume>, <fpage>428</fpage>–<lpage>432</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">27828941</pub-id></mixed-citation>
    </ref>
    <ref id="R10">
      <label>10.</label>
      <mixed-citation publication-type="journal"><name><surname>Poskanzer</surname><given-names>KE</given-names></name> &amp; <name><surname>Yuste</surname><given-names>R</given-names></name>
<article-title>Astrocytic regulation of cortical UP states</article-title>. <source>Proc. Natl. Acad. Sci. U.S.A</source>
<volume>108</volume>, <fpage>18453</fpage>–<lpage>18458</lpage> (<year>2011</year>).<pub-id pub-id-type="pmid">22027012</pub-id></mixed-citation>
    </ref>
    <ref id="R11">
      <label>11.</label>
      <mixed-citation publication-type="journal"><name><surname>Looger</surname><given-names>LL</given-names></name><article-title>A genetically encoded fluorescent sensor for in vivo imaging of GABA</article-title>. <source>bioRxiv</source><comment>322578</comment> (<year>2018</year>). doi:<pub-id pub-id-type="doi">10.1101/322578</pub-id></mixed-citation>
    </ref>
    <ref id="R12">
      <label>12.</label>
      <mixed-citation publication-type="journal"><name><surname>Feng</surname><given-names>J</given-names></name><etal/><article-title>A Genetically Encoded Fluorescent Sensor for Rapid and Specific In Vivo Detection of Norepinephrine</article-title>. <source>Neuron</source> (<year>2019</year>). doi:<pub-id pub-id-type="doi">10.1016/j.neuron.2019.02.037</pub-id></mixed-citation>
    </ref>
    <ref id="R13">
      <label>13.</label>
      <mixed-citation publication-type="journal"><name><surname>Lobas</surname><given-names>MA</given-names></name><etal/><article-title>A genetically encoded single-wavelength sensor for imaging cytosolic and cell surface ATP</article-title>. <source>Nature Communications</source><volume>10</volume>, <fpage>711</fpage> (<year>2019</year>).</mixed-citation>
    </ref>
    <ref id="R14">
      <label>14.</label>
      <mixed-citation publication-type="journal"><name><surname>Patriarchi</surname><given-names>T</given-names></name><etal/><article-title>Ultrafast neuronal imaging of dopamine dynamics with designed genetically encoded sensors</article-title>. <source>Science</source><volume>360</volume>, <fpage>eaat4422</fpage> (<year>2018</year>).<pub-id pub-id-type="pmid">29853555</pub-id></mixed-citation>
    </ref>
    <ref id="R15">
      <label>15.</label>
      <mixed-citation publication-type="journal"><name><surname>Agarwal</surname><given-names>A</given-names></name><etal/><article-title>Transient Opening of the Mitochondrial Permeability Transition Pore Induces Microdomain Calcium Transients in Astrocyte Processes</article-title>. <source>Neuron</source><volume>93</volume>, <fpage>587</fpage>–<lpage>605.e7</lpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28132831</pub-id></mixed-citation>
    </ref>
    <ref id="R16">
      <label>16.</label>
      <mixed-citation publication-type="journal"><name><surname>Armbruster</surname><given-names>M</given-names></name>, <name><surname>Hanson</surname><given-names>E</given-names></name> &amp; <name><surname>Dulla</surname><given-names>CG</given-names></name>
<article-title>Glutamate Clearance Is Locally Modulated by Presynaptic Neuronal Activity in the Cerebral Cortex</article-title>. <source>J. Neurosci</source>
<volume>36</volume>, <fpage>10404</fpage>–<lpage>10415</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">27707974</pub-id></mixed-citation>
    </ref>
    <ref id="R17">
      <label>17.</label>
      <mixed-citation publication-type="journal"><name><surname>Bindocci</surname><given-names>E</given-names></name><etal/><article-title>Three-dimensional Ca(2+) imaging advances understanding of astrocyte biology</article-title>. <source>Science</source><volume>356</volume>, <fpage>eaai8185</fpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28522470</pub-id></mixed-citation>
    </ref>
    <ref id="R18">
      <label>18.</label>
      <mixed-citation publication-type="journal"><name><surname>Wu</surname><given-names>Y-W</given-names></name><etal/><article-title>Spatiotemporal calcium dynamics in single astrocytes and its modulation by neuronal activity</article-title>. <source>Cell Calcium</source><volume>55</volume>, <fpage>119</fpage>–<lpage>129</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24484772</pub-id></mixed-citation>
    </ref>
    <ref id="R19">
      <label>19.</label>
      <mixed-citation publication-type="journal"><name><surname>Wang</surname><given-names>Y</given-names></name><etal/><article-title>Graphical Time Warping for Joint Alignment of Multiple Curves</article-title>. <source>Neural Information Processing Systems</source><fpage>3648</fpage>–<lpage>3656</lpage> (<year>2016</year>).</mixed-citation>
    </ref>
    <ref id="R20">
      <label>20.</label>
      <mixed-citation publication-type="journal"><name><surname>Giovannucci</surname><given-names>A</given-names></name><etal/><article-title>CaImAn: An open source tool for scalable Calcium Imaging data Analysis</article-title>. <source>bioRxiv</source><comment>339564</comment> (<year>2018</year>). doi:<pub-id pub-id-type="doi">10.1101/339564</pub-id></mixed-citation>
    </ref>
    <ref id="R21">
      <label>21.</label>
      <mixed-citation publication-type="other"><name><surname>Pachitariu</surname><given-names>M</given-names></name><etal/><source>Suite2p: beyond 10,000 neurons with standard two-photon microscopy</source>. (<year>2016</year>). doi:<pub-id pub-id-type="doi">10.1101/061507</pub-id></mixed-citation>
    </ref>
    <ref id="R22">
      <label>22.</label>
      <mixed-citation publication-type="journal"><name><surname>Poskanzer</surname><given-names>KE</given-names></name> &amp; <name><surname>Molofsky</surname><given-names>AV</given-names></name>
<article-title>Dynamism of an Astrocyte In Vivo: Perspectives on Identity and Function</article-title>. <source>Annu. Rev. Physiol</source>
<volume>80</volume>, <fpage>143</fpage>–<lpage>157</lpage> (<year>2018</year>).<pub-id pub-id-type="pmid">29166242</pub-id></mixed-citation>
    </ref>
    <ref id="R23">
      <label>23.</label>
      <mixed-citation publication-type="journal"><name><surname>Shigetomi</surname><given-names>E</given-names></name><etal/><article-title>Imaging calcium microdomains within entire astrocyte territories and endfeet with GCaMPs expressed using adeno-associated viruses</article-title>. <source>J. Gen. Physiol</source><volume>141</volume>, <fpage>633</fpage>–<lpage>647</lpage> (<year>2013</year>).<pub-id pub-id-type="pmid">23589582</pub-id></mixed-citation>
    </ref>
    <ref id="R24">
      <label>24.</label>
      <mixed-citation publication-type="journal"><name><surname>van der Maaten</surname><given-names>L</given-names></name> &amp; <name><surname>Hinton</surname><given-names>G</given-names></name>
<article-title>Visualizing Data using t-SNE</article-title>. <source>Journal of Machine Learning Research</source>
<volume>9</volume>, <fpage>2579</fpage>–<lpage>2605</lpage> (<year>2008</year>).</mixed-citation>
    </ref>
    <ref id="R25">
      <label>25.</label>
      <mixed-citation publication-type="journal"><name><surname>Stobart</surname><given-names>JL</given-names></name><etal/><article-title>Cortical Circuit Activity Evokes Rapid Astrocyte Calcium Signals on a Similar Timescale to Neurons</article-title>. <source>Neuron</source><volume>98</volume>, <fpage>726</fpage>–<lpage>735.e4</lpage> (<year>2018</year>).<pub-id pub-id-type="pmid">29706581</pub-id></mixed-citation>
    </ref>
    <ref id="R26">
      <label>26.</label>
      <mixed-citation publication-type="journal"><name><surname>Kanemaru</surname><given-names>K</given-names></name><etal/><article-title>In vivo visualization of subtle, transient, and local activity of astrocytes using an ultrasensitive Ca(2+) indicator</article-title>. <source>Cell Rep</source><volume>8</volume>, <fpage>311</fpage>–<lpage>318</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24981861</pub-id></mixed-citation>
    </ref>
    <ref id="R27">
      <label>27.</label>
      <mixed-citation publication-type="journal"><name><surname>Nimmerjahn</surname><given-names>A</given-names></name>, <name><surname>Mukamel</surname><given-names>EA</given-names></name> &amp; <name><surname>Schnitzer</surname><given-names>MJ</given-names></name>
<article-title>Motor behavior activates Bergmann glial networks</article-title>. <source>Neuron</source>
<volume>62</volume>, <fpage>400</fpage>–<lpage>412</lpage> (<year>2009</year>).<pub-id pub-id-type="pmid">19447095</pub-id></mixed-citation>
    </ref>
    <ref id="R28">
      <label>28.</label>
      <mixed-citation publication-type="journal"><name><surname>Parsons</surname><given-names>MP</given-names></name><etal/><article-title>Real-time imaging of glutamate clearance reveals normal striatal uptake in Huntington disease mouse models</article-title>. <source>Nature Communications</source><volume>7</volume>, <fpage>11251</fpage> (<year>2016</year>).</mixed-citation>
    </ref>
    <ref id="R29">
      <label>29.</label>
      <mixed-citation publication-type="journal"><name><surname>Jiang</surname><given-names>R</given-names></name>, <name><surname>Diaz-Castro</surname><given-names>B</given-names></name>, <name><surname>Looger</surname><given-names>LL</given-names></name> &amp; <name><surname>Khakh</surname><given-names>BS</given-names></name>
<article-title>Dysfunctional Calcium and Glutamate Signaling in Striatal Astrocytes from Huntington’s Disease Model Mice</article-title>. <source>J. Neurosci</source>
<volume>36</volume>, <fpage>3453</fpage>–<lpage>3470</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">27013675</pub-id></mixed-citation>
    </ref>
    <ref id="R30">
      <label>30.</label>
      <mixed-citation publication-type="journal"><name><surname>Hefendehl</surname><given-names>JK</given-names></name><etal/><article-title>Mapping synaptic glutamate transporter dysfunction in vivo to regions surrounding Aβ plaques by iGluSnFR two-photon imaging</article-title>. <source>Nature Communications</source><volume>7</volume>, <fpage>13441</fpage> (<year>2016</year>).</mixed-citation>
    </ref>
    <ref id="R31">
      <label>31.</label>
      <mixed-citation publication-type="journal"><name><surname>Marvin</surname><given-names>JS</given-names></name><etal/><article-title>Stability, affinity, and chromatic variants of the glutamate sensor iGluSnFR</article-title>. <source>Nat. Methods</source><volume>15</volume>, <fpage>936</fpage>–<lpage>939</lpage> (<year>2018</year>).<pub-id pub-id-type="pmid">30377363</pub-id></mixed-citation>
    </ref>
    <ref id="R32">
      <label>32.</label>
      <mixed-citation publication-type="journal"><name><surname>Fino</surname><given-names>E</given-names></name><etal/><article-title>RuBi-Glutamate: Two-Photon and Visible-Light Photoactivation of Neurons and Dendritic spines</article-title>. <source>Front Neural Circuits</source><volume>3</volume>, <fpage>2</fpage> (<year>2009</year>).<pub-id pub-id-type="pmid">19506708</pub-id></mixed-citation>
    </ref>
    <ref id="R33">
      <label>33.</label>
      <mixed-citation publication-type="journal"><name><surname>Baraban</surname><given-names>M</given-names></name>, <name><surname>Koudelka</surname><given-names>S</given-names></name> &amp; <name><surname>Lyons</surname><given-names>DA</given-names></name>
<article-title>Ca 2+ activity signatures of myelin sheath formation and growth in vivo</article-title>. <source>Nat. Neurosci</source>
<volume>19</volume>, <fpage>190</fpage> (<year>2017</year>).</mixed-citation>
    </ref>
    <ref id="R34">
      <label>34.</label>
      <mixed-citation publication-type="journal"><name><surname>Krasnow</surname><given-names>AM</given-names></name>, <name><surname>Ford</surname><given-names>MC</given-names></name>, <name><surname>Valdivia</surname><given-names>LE</given-names></name>, <name><surname>Wilson</surname><given-names>SW</given-names></name> &amp; <name><surname>Attwell</surname><given-names>D</given-names></name>
<article-title>Regulation of developing myelin sheath elongation by oligodendrocyte calcium transients in vivo</article-title>. <source>Nat. Neurosci</source>
<volume>93</volume>, <fpage>9887</fpage> (<year>2017</year>).</mixed-citation>
    </ref>
    <ref id="R35">
      <label>35.</label>
      <mixed-citation publication-type="journal"><name><surname>Higley</surname><given-names>MJ</given-names></name> &amp; <name><surname>Sabatini</surname><given-names>BL</given-names></name>
<article-title>Calcium signaling in dendritic spines</article-title>. <source>Cold Spring Harb Perspect Biol</source>
<volume>4</volume>, <fpage>a005686</fpage>–<lpage>a005686</lpage> (<year>2012</year>).<pub-id pub-id-type="pmid">22338091</pub-id></mixed-citation>
    </ref>
    <ref id="R36">
      <label>36.</label>
      <mixed-citation publication-type="journal"><name><surname>Keller</surname><given-names>PJ</given-names></name> &amp; <name><surname>Ahrens</surname><given-names>MB</given-names></name>
<article-title>Visualizing whole-brain activity and development at the single-cell level using light-sheet microscopy</article-title>. <source>Neuron</source>
<volume>85</volume>, <fpage>462</fpage>–<lpage>483</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">25654253</pub-id></mixed-citation>
    </ref>
    <ref id="R37">
      <label>37.</label>
      <mixed-citation publication-type="journal"><name><surname>Goldey</surname><given-names>GJ</given-names></name><etal/><article-title>Removable cranial windows for long-term imaging in awake mice</article-title>. <source>Nat Protoc</source><volume>9</volume>, <fpage>2515</fpage>–<lpage>2538</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">25275789</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig id="F1" orientation="portrait" position="float">
    <label>Figure 1.</label>
    <caption>
      <title>AQuA-based event detection.</title>
      <p id="P95"><bold>(a)</bold> Individual representative frames from 5-min <italic>ex vivo</italic> astrocytic GCaMP imaging experiment (top, <xref rid="SD2" ref-type="supplementary-material">Video 1</xref>) with AQuA-detected events shown below. Each color represents individual event and is chosen at random. Right column shows the average GCaMP fluorescence (top) and all AQuA-detected events (bottom) from the entire video. Note that contrast differs between rows to highlight events. Similar event detection results are observed in all 48 <italic>ex vivo</italic>, 46 <italic>in vivo</italic> GCaMP data sets and 14 GluSnFr data sets used in this report. <bold>(b)</bold> Flowchart of AQuA algorithm. Raw data is visualized as a stack of images across time with grey level indicating signal intensity. In the <italic>detect peaks</italic> panel, five peaks are detected and highlighted by solid diamonds, each color denoting one peak. Based on the single-cycle rule and spatial adjacency of the apexes (solid dots) of each peak, peaks are clustered into spatially disconnected groups. Based on smoothness, propagation patterns are estimated for each peak group. By applying the single-source rule, two events are detected for peak group 1. Three total events are detected. (<bold>c</bold>) Feature extraction. Based on the event-detection results, AQuA outputs four sets of features relevant to astrocytic activity: 1) propagation-related (path, direction, and speed); 2) source of events, indicating where an event is initiated; 3) features related to the event footprint, including area and shape. Event 2 is plotted here; 4) features derived from the dF/F dynamics.</p>
    </caption>
    <graphic xlink:href="nihms-1537261-f0001"/>
  </fig>
  <fig id="F2" orientation="portrait" position="float">
    <label>Figure 2.</label>
    <caption>
      <title>Performance comparison among image-analysis methods.</title>
      <p id="P96">(<bold>a–c</bold>) Schematic (top<bold>)</bold> and results (bottom) of five image analysis methods (AQuA, GECI-quant, CaSCaDe, CaImAn, and Suite2P) on simulated datasets, independently changing event size (a), location (b), and propagation duration (c). In results, independent parameter change is shown in the left panel, and varying SNR in the right. For each, the smallest value of the independent parameter corresponds to a simulation under pure ROI assumptions. The larger the values, the greater the violation of the ROI assumptions. IoU (intersection over union) measures the overlap between detected and ground-truth events. An IoU=1 is the best achievable performance, meaning that all detected events are ground-truth and all ground-truth events are detected. For all graphs, mean value is plotted, and error bars indicate the 95% confidence interval calculated from 10 independent replications of simulation, where each simulation contains hundreds of events.</p>
    </caption>
    <graphic xlink:href="nihms-1537261-f0002"/>
  </fig>
  <fig id="F3" orientation="portrait" position="float">
    <label>Figure 3.</label>
    <caption>
      <title>AQuA features capture heterogeneities among single astrocytes.</title>
      <p id="P97">(<bold>a</bold>) Representative GCaMP6f <italic>ex vivo</italic> image (left) with AQuA events overlaid from 1 min of a 5 min video. Soma marked with black <italic>s</italic>. (<xref rid="SD2" ref-type="supplementary-material">Video 1</xref>). Right: Representative image sequence for each propagation direction class (blue = static, pink = toward soma, purple = away from soma. Soma direction marked with s and white arrow. Data from a total of 11 cells from 5 slices. (<bold>b</bold>) Spatiotemporal plot of Ca<sup>2+</sup> activity from 1 min of video. Each event is represented by a polygon that is proportional to its area as it changes over its lifetime. (<bold>c</bold>) Distribution of dynamic and static events as a function of minimum distance from soma. All bin widths calculated by Freedman-Diaconis’s rule. (<bold>d</bold>) Left: Propagative event size versus starting distance from soma, segregated by propagation direction. Dashed gray line denotes half the distance between the soma and the cell border. Right: Average event area for those that start &lt;50% (top) and &gt;50% (bottom) from the soma, (one-tailed paired t-test, *p=0.0107). Graphs in d and e display mean ± s.e.m. (<bold>e</bold>) Left: Event duration versus starting distance from soma. Right: Average event duration for those that start &lt;50% (top) and &gt;50% (bottom) from the soma (one-tailed paired t-test, *p=0.0269). (<bold>f</bold>) Two event-based measurements of frequency are schematized: events with activity overlapping in time (left) and in space (right;). Left: one example event (orange) co-occurs with six other events (white) within 10s. Right: event colors indicate event number/min (0.2–4) at each location. Median (red) and interquartile range (gray) from cells in each cluster in <xref rid="SD1" ref-type="supplementary-material">Supp. Fig. 9</xref> (one-tailed Wilcoxon rank sum, ***p&lt;0.001). (<bold>g</bold>) Centroid distances between cells from two clusters determined by t-SNE plots of Ca<sup>2+</sup> activity using features calculated from ROIs and 5×5μm tiles (top), (bottom, one-tailed paired t-test, ***p=9.37e-8(tiles), 2.11e-10(ROIs)).</p>
    </caption>
    <graphic xlink:href="nihms-1537261-f0003"/>
  </fig>
  <fig id="F4" orientation="portrait" position="float">
    <label>Figure 4.</label>
    <caption>
      <title>AQuA resolves astrocytic Ca<sup>2+</sup> propagation directionality across scales.</title>
      <p id="P98">(<bold>a</bold>) Representative <italic>in vivo</italic> GCaMP6f images during a burst period (top) and inter-burst period (bottom) with overlaid AQuA-detected events. (<bold>b</bold>) Population Ca<sup>2+</sup> events represented as percentage of the imaging field active as a function of time. Burst periods (pink) are defined by Ca<sup>2+</sup> activity &gt;1% of the field of view and &gt;10% of the maximum number of event onsets. (<bold>c</bold>) <italic>In vivo</italic> Ca<sup>2+</sup> events propagate with specific directionality. Top: representative propagative event from the burst in panel a. The propagation direction (change of centroid relative to its original location) for each frame is overlaid on the event (right). Bottom: Total propagation distance versus event size for all events within bursts (n=6 mice, 66 bursts, 14,967 events for all data in this figure). (<bold>d</bold>) Event propagation direction from all events over the entire field in the burst in <italic>e</italic>. Arrow length indicates propagation distance. (<bold>e</bold>) To test consistency of subregional directionality during bursts, sixteen 96×96μm tiles are overlaid on images. (<bold>f</bold>) Top: All events within highlighted tile in <italic>d</italic> (<italic>red square</italic>) for five burst periods, color-coded by propagation direction (top). Bottom: Event propagation direction distributions (P=posterior; A=anterior; M=medial; L=lateral). (<bold>g</bold>) Cumulative distribution of percentage of bursts with events (within individual tiles/regions) propagating in the same direction in actual (solid) and simulated (dashed) data (one-tailed Wilcoxon rank sum, ***p=3.77e-15) (<bold>h</bold>) Two representative maps of population burst propagation direction with each event color-coded by onset time relative to the beginning of the burst, demonstrating variability of burst size. (<bold>i</bold>) Burst propagation direction calculated from onset maps in <italic>h</italic> (n=66 bursts). Event locations from the first 20% of the frames after burst onset are averaged together to determine burst origin. Event locations from 20% of the last frames after burst onset are averaged together and the difference between this and the origin determines burst propagation distance. Red arrow denotes average of all bursts.</p>
    </caption>
    <graphic xlink:href="nihms-1537261-f0004"/>
  </fig>
  <fig id="F5" orientation="portrait" position="float">
    <label>Figure 5.</label>
    <caption>
      <title>AQuA-based detection of extracellular dynamics via astrocytic and neuronal expression of genetically encoded neurotransmitter sensors.</title>
      <p id="P99">(<bold>a</bold>) Representative images of <italic>ex vivo</italic> slices with expression of astrocytic (left) or neuronal (right) GluSnFR. Color indicates detected events. Those with dynamic shape are shown in magenta, and static events in cyan. (<bold>b</bold>) Examples of timecourse of astrocytic (left, top) and neuronal (right, top) glutamate events. Scale bar = 10μm. Raster plot of astrocytic (left, bottom) and neuronal (right, bottom) glutamate event area. (<bold>c</bold>) Size dynamics (area increase [left] and decrease [middle] per frame) and shape (circularity index, right) of glutamate events when GluSnFR is expressed on astrocytes (red) or neurons (blue). (n=3 slices for each cell type, comparison using two-tailed t-test with mean displayed as center, p=0.414(left), 0.0297(middle), 4.26e-6(right)) (<bold>d</bold>) Left: Single astrocyte expressing GluSnFR, with AQuA-detected events (colors) with ~100Hz frame rate imaging and 25–150ms uncaging of RuBi-glutamate. Uncaging locations marked with white circles. Right: Percent correct events detected by AQuA, as a function of laser uncaging pulse duration. (n=5 cells, mean ± s.e.m.) (<bold>e</bold>) Example of three AQuA-detected events at single timepoint (97s) after addition of 300μM GABA to slice with astrocytes expressing GABASnFR (left). Right: Detected events before and after addition of 300μM GABA (gray bar) to circulating bath. Events are plotted to display spatial position in imaging field (y-axis), event area (height), and gradually increasing amplitude (color) over time. (n=1 slice) (<bold>f</bold>) Left: two detected events in cortical slice expressing GRAB-NE in neurons after addition of 10μM NE. Right: Events plotted to display spatial position (y-axis), event area (height), and amplitude (color) dynamics over the course of the experiment. In (e) and (f), average xy position at each timepoint is calculated using the following equation: (((xLoc-1)*frameSize) + yLoc)/frameSize. (n=1 slice)</p>
    </caption>
    <graphic xlink:href="nihms-1537261-f0005"/>
  </fig>
</floats-group>
