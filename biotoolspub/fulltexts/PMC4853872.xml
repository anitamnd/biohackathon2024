<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD Journal Publishing DTD v2.3 20070202//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName journalpublishing.dtd?>
<?SourceDTD.Version 2.3?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 2?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">J Synchrotron Radiat</journal-id>
    <journal-id journal-id-type="iso-abbrev">J Synchrotron Radiat</journal-id>
    <journal-id journal-id-type="publisher-id">J. Synchrotron Rad.</journal-id>
    <journal-title-group>
      <journal-title>Journal of Synchrotron Radiation</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">0909-0495</issn>
    <issn pub-type="epub">1600-5775</issn>
    <publisher>
      <publisher-name>International Union of Crystallography</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">4853872</article-id>
    <article-id pub-id-type="publisher-id">fv5047</article-id>
    <article-id pub-id-type="doi">10.1107/S1600577516003052</article-id>
    <article-id pub-id-type="coden">JSYRES</article-id>
    <article-id pub-id-type="pii">S1600577516003052</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Research Papers</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title><italic>MMX-I</italic>: data-processing software for multimodal X-ray imaging and tomography</article-title>
      <alt-title><italic>MMX-I</italic> data-processing software</alt-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Bergamaschi</surname>
          <given-names>Antoine</given-names>
        </name>
        <xref ref-type="aff" rid="a">a</xref>
        <xref ref-type="corresp" rid="cor">*</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Medjoubi</surname>
          <given-names>Kadda</given-names>
        </name>
        <xref ref-type="aff" rid="a">a</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Messaoudi</surname>
          <given-names>Cédric</given-names>
        </name>
        <xref ref-type="aff" rid="b">b</xref>
        <xref ref-type="aff" rid="c">c</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Marco</surname>
          <given-names>Sergio</given-names>
        </name>
        <xref ref-type="aff" rid="b">b</xref>
        <xref ref-type="aff" rid="c">c</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Somogyi</surname>
          <given-names>Andrea</given-names>
        </name>
        <xref ref-type="aff" rid="a">a</xref>
      </contrib>
      <aff id="a"><label>a</label><institution>Synchrotron SOLEIL</institution>, BP 48, Saint-Aubin, 91192 Gif sur Yvette, <country>France</country></aff>
      <aff id="b"><label>b</label>UMR 9187, <institution>Université Paris-Saclay, CNRS</institution>, Université Paris-Saclay, F-91405 Orsay, <country>France</country></aff>
      <aff id="c"><label>c</label>U1196, <institution>Institut Curie, INSERM</institution>, PSL Reseach University, F-91405 Orsay, <country>France</country></aff>
    </contrib-group>
    <author-notes>
      <corresp id="cor">Correspondence e-mail: <email>antoine.bergamaschi@synchrotron-soleil.fr</email></corresp>
    </author-notes>
    <pub-date pub-type="collection">
      <day>01</day>
      <month>5</month>
      <year>2016</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>12</day>
      <month>4</month>
      <year>2016</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>12</day>
      <month>4</month>
      <year>2016</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on the
							<pub-date pub-type="epub"/>. -->
    <volume>23</volume>
    <issue>Pt 3</issue>
    <issue-id pub-id-type="publisher-id">s160300</issue-id>
    <fpage>783</fpage>
    <lpage>794</lpage>
    <history>
      <date date-type="received">
        <day>17</day>
        <month>11</month>
        <year>2015</year>
      </date>
      <date date-type="accepted">
        <day>20</day>
        <month>2</month>
        <year>2016</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© Antoine Bergamaschi et al. 2016</copyright-statement>
      <copyright-year>2016</copyright-year>
      <license license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/2.0/uk/">
        <license-p>This is an open-access article distributed under the terms of the Creative Commons Attribution Licence, which permits
unrestricted use, distribution, and reproduction in any medium, provided the original authors and source are cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:type="simple" xlink:href="http://dx.doi.org/10.1107/S1600577516003052">A full version of this article is available from Crystallography Journals Online.</self-uri>
    <abstract abstract-type="toc">
      <p>The <italic>MMX-I</italic> open-source software has been developed for processing and reconstruction of large multimodal X-ray imaging and tomography datasets. The recent version of <italic>MMX-I</italic> is optimized for scanning X-ray fluorescence, phase-, absorption- and dark-field contrast techniques. This, together with its implementation in Java, makes <italic>MMX-I</italic> a versatile and friendly user tool for X-ray imaging.</p>
    </abstract>
    <abstract>
      <p>A new multi-platform freeware has been developed for the processing and reconstruction of scanning multi-technique X-ray imaging and tomography datasets. The software platform aims to treat different scanning imaging techniques: X-ray fluorescence, phase, absorption and dark field and any of their combinations, thus providing an easy-to-use data processing tool for the X-ray imaging user community. A dedicated data input stream copes with the input and management of large datasets (several hundred GB) collected during a typical multi-technique fast scan at the Nanoscopium beamline and even on a standard PC. To the authors’ knowledge, this is the first software tool that aims at treating all of the modalities of scanning multi-technique imaging and tomography experiments.</p>
    </abstract>
    <kwd-group>
      <kwd>scanning multimodal X-ray imaging</kwd>
      <kwd>scanning X-ray tomography</kwd>
      <kwd>tomographic reconstruction</kwd>
      <kwd>phase retrieval</kwd>
      <kwd>scanning multimodal X-ray imaging</kwd>
      <kwd>scanning X-ray tomography</kwd>
      <kwd>tomographic reconstruction</kwd>
      <kwd>phase retrieval</kwd>
    </kwd-group>
  </article-meta>
</front>
<body>
  <sec id="sec1">
    <label>1.</label>
    <title>Introduction   </title>
    <p>The Nanoscopium beamline of Synchrotron SOLEIL (Somogyi <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb39"> ▸</xref>) is dedicated to scanning multi-technique X-ray imaging in the 5–20 keV energy range. It aims to offer two-dimensional/three-dimensional (2D/3D) quantitative information on the elemental composition and electronic density of samples with high spatial resolution (down to 50 nm in 3D) and analytical sensitivity, <italic>i.e.</italic> trace, sub-parts-per-million (sub-p.p.m.), detection limit. The beamline is especially well suited for hierarchical length-scale studies of highly heterogeneous samples providing simultaneous morphological, elemental and chemical information at multiple length scales. Indeed, the scanning range can be scaled from millimetres to micrometres with spatial resolution down to 50 nm. The main scientific fields of application at the beamline are biology, life sciences, geo-biology and environmental sciences. Distribution of biologically important transition metals in organic tissues and cells (Colvin <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb9"> ▸</xref>), elemental composition and morphology of geological and paleo-geological samples (Sforna <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb45"> ▸</xref>), metal uptake and sequestration mechanisms in plants are some representative examples of research which can be performed at the Nano­scopium beamline. The multi-technique ‘FLYSCAN’ data acquisition scheme developed at Synchrotron SOLEIL (Medjoubi <italic>et al.</italic>, 2013<italic>b</italic>
<xref ref-type="bibr" rid="bb26"> ▸</xref>; Leclercq <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb22"> ▸</xref>), based on the specific technical features of Nanoscopium, is crucial for such multi-length scale scanning imaging. It permits scanning X-ray fluorescence spectrometry combined with absorption, differential phase contrast and dark-field imaging to be performed with down to millisecond dwell time per pixel. As such, large-field-of-view measurements become feasible in a few hours of measurement time. The principle of the scanning nanoprobe station is presented in Fig. 1<xref ref-type="fig" rid="fig1"> ▸</xref>. During a usual experiment a large overview map of 2000 × 2000 pixels (∼2 mm × 2 mm) is recorded with millisecond dwell time per pixel. This results in a half-terabyte dataset in about 1 h. The large overview mapping is followed by a more resolved, but slower, scan performed on a ≤100–200 µm<sup>2</sup> sized region. This produces a similar amount of data in 1–2 h. Obviously, on-line and off-line data processing is a crucial part of the success of the experiments. However, the treatment of such large datasets, regularly generated during synchrotron user experiments, still represents a challenge. These large amounts of raw data have to be imported, reduced, corrected and pre-processed within the time frame of the experiment for on-site data viewing. Moreover, it must also be feasible to perform these data treatment steps on a standard PC by users for thorough post-experimental data processing in their own home institutes, where they often do not possess a high-performance workstation. Such data-reconstruction software and algorithms must be easy to be used as well by users inexperienced in image processing. In order to cope with these challenges, we have developed a dedicated data processing tool at the Nanoscopium beamline, which will be proposed as freeware for the scientific community.</p>
    <p>One of the main requirements for such a software tool, both for 2D imaging and tomography, is to extract the physical properties from the samples encoded in the raw data [recorded at SOLEIL in a single NeXus file (Poirier <italic>et al.</italic>, 2009<xref ref-type="bibr" rid="bb32"> ▸</xref>)]. These properties are transformed into images of phase, scattering contrast, absorption contrast and elemental distribution maps. Moreover, calibrations and corrections for detector imperfections (<italic>e.g.</italic> hot pixels of the 2D detector) and for eventual positioning irregularities of the sample stage, have to be performed in a transparent manner. Furthermore, due to the large variety of samples, the sampling strategy and the recorded signals can be very different from one experiment to another (<italic>e.g.</italic> intensity, background). As such, several tomographic reconstruction algorithms and phase-retrieval methods, tailored to the different measurement strategies and imaging contrasts, must be proposed.</p>
    <p>Many open-source software or frameworks exist for transmission tomographic reconstruction or phase retrieval, such as <italic>TomoPy</italic> (Gürsoy <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb16"> ▸</xref>), <italic>TomoJ</italic> (Messaoudii <italic>et al.</italic>, 2007<xref ref-type="bibr" rid="bb28"> ▸</xref>), <italic>AnkaPhase</italic> (Weitkamp <italic>et al.</italic>, 2011<xref ref-type="bibr" rid="bb44"> ▸</xref>) and <italic>PITRE</italic> (Chen <italic>et al.</italic>, 2012<xref ref-type="bibr" rid="bb8"> ▸</xref>) (a non-exhaustive list). However, they are mostly oriented for full-field imaging and not for scanning imaging. To our knowledge, the open freewares mostly dedicated for scanning X-ray fluorescence (XRF) and X-ray absorption near-edge structure (XANES) applications are <italic>PyMCA</italic> (Solé <italic>et al.</italic>, 2007<xref ref-type="bibr" rid="bb38"> ▸</xref>), <italic>Mantis</italic> (Lerotic <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb23"> ▸</xref>), <italic>MAPS</italic> (Vogt, 2003<xref ref-type="bibr" rid="bb43"> ▸</xref>), <italic>TXM-Wizard</italic> (Liu <italic>et al.</italic>, 2012<xref ref-type="bibr" rid="bb24"> ▸</xref>) and <italic>Axis2000</italic> (aXis2000, 1997<xref ref-type="bibr" rid="bb2"> ▸</xref>).</p>
    <p>This made it necessary to develop the open-source <italic>MMX-I</italic> software for the off-line processing of multimodal scanning X-ray imaging and tomography datasets. Taking into account the already existing widely used XRF spectrum-fitting software (<italic>e.g.</italic>
<italic>PyMCA</italic>), we did not intend to develop such fitting tools for <italic>MMX-I</italic>. Instead, it is possible to import <italic>PyMCA</italic> results, namely elemental intensities obtained by fitting each pixel spectra, into <italic>MMX-I</italic> for further processing.</p>
    <p><italic>MMX-I</italic> has been designed following a modular architecture, based on the model view controller (MVC) pattern (Reenskaug, 1979<xref ref-type="bibr" rid="bb33"> ▸</xref>). This allows enlarging its application even beyond scanning imaging by including the processing of any other imaging datasets requiring tomographic or phase reconstruction.</p>
  </sec>
  <sec id="sec2">
    <label>2.</label>
    <title><italic>MMX-I</italic> for data reduction and processing   </title>
    <sec id="sec2.1">
      <label>2.1.</label>
      <title>Software platform and workflow   </title>
      <p>The <italic>MMX-I</italic> project aims to offer both expert users and beginners the possibility of processing and analysing raw data, either on-site or off-site, for each scanning imaging technique included in the software and any of their combinations. Therefore we have developed a multi-platform (Mac, Windows and Linux 64-bit) data processing tool, which is easy to install, comprehensive, intuitive and user friendly.</p>
      <p>As software developments based on scripting languages, such as Matlab or IDL, require the installation of rather expensive software packages, we preferred to develop <italic>MMX-I</italic> in Java. Java has a good synergy with the widely used (by different scientific communities) image processing software <italic>ImageJ</italic> (Saalfeld <italic>et al.</italic>, 2012<xref ref-type="bibr" rid="bb36"> ▸</xref>; Schneider <italic>et al.</italic>, 2012<xref ref-type="bibr" rid="bb37"> ▸</xref>; Rizk <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb34"> ▸</xref>). Several advantages have been considered with this choice: (i) Java code can run on all Java-supporting platforms without the need of recompilation; (ii) the software tool can be installed with a single executable file, which can even include the appropriate Java version; (iii) the application can be launched from a USB stick and, as such, is easily delivered to the users; (iv) Java includes a large number of scientific class libraries, which allows the easy development of numerical calculations adapted to our needs; (v) <italic>ImageJ</italic> libraries provide the basic image visualization and processing tools.</p>
      <p>The <italic>MMX-I</italic> workflow is presented in Fig. 2<xref ref-type="fig" rid="fig2"> ▸</xref>. The data processing chain is divided into four modules: data importation, reduction, correction and reconstruction. Each module is detailed in the following sections.</p>
    </sec>
    <sec id="sec2.2">
      <label>2.2.</label>
      <title>Implemented modules   </title>
      <sec id="sec2.2.1">
        <label>2.2.1.</label>
        <title>Data importation   </title>
        <p>At SOLEIL, raw data including metadata (such as scan parameters, sample identifier, beamline parameters and timestamp), obtained during an experiment, are recorded in an HDF5 (The HDF Group, 2015<italic>a</italic>
<xref ref-type="bibr" rid="bb42"> ▸</xref>) file following the NeXus convention (Könnecke <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb21"> ▸</xref>). Fig. 3<xref ref-type="fig" rid="fig3"> ▸</xref> presents a file tree of a single NeXus file of data taken during a multi-technique X-ray 2D scanning experiment at Nanoscopium. Being an HDF5 file it is opened using the <italic>HDFView</italic> software (The HDF Group, 2015<italic>b</italic>
<xref ref-type="bibr" rid="bb41"> ▸</xref>). The hierarchical HDF5 format facilitates data processing and interpretation, because the data from each subsystem (sensors, motors, <italic>etc.</italic>) are recorded in a single HDF5 file following the order of the acquisition process. The HDF5 is a binary file indexed in B-tree (tree data structure). In addition to being self-describing, the HDF5 format is quasi-unlimited in size (<italic>i.e.</italic> limited by the file system). HDF5 is well supported and continuously improved by the HDF Group in order to stay at the cutting edge of innovation.</p>
        <p>Reading and processing large HDF5 files of 0.5–1 TB volumes, produced regularly by Flyscan at Nanoscopium, requires high computing performances, which is not available by standard PC or laptop computers. As such, the optimization of the computing resources was a crucial part of the <italic>MMX-I</italic> project in order to cope with the handling of big data files even by standard user-PCs. For this purpose, a dedicated readout API, named Hdf5Opener, has been developed. Indeed, reducing data takes only a small fraction of the computation power compared with file readout. The bottlenecks of the reduction procedure are the memory available for the readout of the complete dataset contained in the file and the time necessary for data transfer from the disk to the memory. In order to address these problems, Hdf5Opener owns its own dedicated memory and execution thread, which allows working in parallel with the other processing threads of <italic>MMX-I</italic>. The strategy is to partially read the Hdf5 file and to separate data reading and processing. In detail, as shown in Fig. 4<xref ref-type="fig" rid="fig4"> ▸</xref>, a stream object sends to the API a list of read requests, each containing the selection of the partial dataset to be sequentially read out. After the readout of the first request of the list, the block of data is stored in the storage array and queued up to be processed. The operation is performed continuously for all elements of the list, according to the available memory size. Once one of the parallel-processing tasks on a given block of data is terminated, the corresponding memory space in the storage array is released. By default, the size of the block of data is set to be equal to the size of the first dimension of the scan. As an example, for a 2D scan, the block of data will contain the elements of one line. This strategy is detailed in §2.2.2<xref ref-type="sec" rid="sec2.2.2"/>.</p>
        <p>The data contained in each block may not be necessarily adjacent in the pixel map. Indeed, for rapid overview of very large datasets, the API can read each second pixel of the map in all dimensions. This mode is called ‘low resolution’ in <italic>MMX-I</italic> and is described below. Moreover, it can be decided not to process parts of the dataset which are considered to be uninteresting (region outside of the sample or corresponding to beam loss <italic>etc</italic>.).</p>
      </sec>
      <sec id="sec2.2.2">
        <label>2.2.2.</label>
        <title>Data reduction   </title>
        <p>Data reduction consists of processing X-ray transmission and XRF raw data to obtain: (i) images from the transmitted signal; (ii) horizontal and vertical differential phase contrast images; (iii) dark-field images; (iv) the orientation of the scattering (to be implemented in the near future); (v) elemental distribution maps.</p>
        <p>Previous to data reduction, raw data have to be pre-treated. For instance, the signal type (absorption, phase, dark field and fluorescence) contained in the treated data matrix has to be identified, denoised and calibrated.</p>
        <p><italic>Pre-treatment.</italic> Usually, the largest part of the total data volume is represented by the transmission images. In order to save computing resources and time, only those image-fractions [image region of interest (ROI)] of the detected raw transmission images will be read by Hdf5Opener, which contains ‘significant’ information for calculating the transmission modalities. To this end, when the raw data file is loaded for the first time, <italic>MMX-I</italic> will automatically read 10% of the whole transmission dataset, uniformly distributed in the coordinates of the scan. From this step, the ROI containing the whole transmitted and scattered beam is determined (see Fig. 5<xref ref-type="fig" rid="fig5"> ▸</xref>). In a second step, a mask of the illumination pattern is defined, which is especially important for the calculation of the dark-field images as described later. The ROI images are thresholded with a minimal value, transformed to binary images and then summed. The resulting ‘illumination mask’ represents for each pixel the number of times the pixel was illuminated by X-rays (above the threshold value) during the whole scan. To obtain a reasonable transmitted beam shape we only consider the pixels which are illuminated within the 95–100% range of the maximum value of the illumination mask (see Fig. 5<xref ref-type="fig" rid="fig5"> ▸</xref>). This ROI and illumination mask are then proposed to the user as the default ones (see §2.5<xref ref-type="sec" rid="sec2.5"/>). The default ROI and illumination mask can be customized by the user.</p>
        <p>Hot pixels are removed from each 2D detector image before further data processing. A dedicated function has been developed in order to identify and remove those pixels, which are significantly different from their neighbours. For this, a local histogram statistics algorithm based on the variance value of each pixel in its neighbourhood (Gonzalez &amp; Woods, 2006<xref ref-type="bibr" rid="bb12"> ▸</xref>) is used. The available default parameters such as the convolution kernel, used to compute the variance, or the histogram threshold can be modified by the user. The positions of the reliably identified hot pixels are then recorded in a look-up table. Then, they are either replaced by the average intensity value of the neighbouring pixels or not considered at all in the reduction processes.</p>
        <p>XRF is an analytical method for determining the chemical composition of the specimen. When a sample is exposed to an X-ray beam with sufficient energy, characteristic X-ray fluorescence radiation will be emitted with discrete energies that are specific of the excited elements. By measuring their energies and intensities, it is possible to determine the concentration of the measured elements. This information for a given element is obtained by measuring, for each pixel of the map, the area of the corresponding peak. Energy calibration of the XRF spectra is a crucial step for the identification of the elements contained in the sample and the reconstruction of the elements maps. By default, <italic>MMX-I</italic> calculates the sum spectra separately for each X-ray fluorescence detector. The energy calibration of the spectrum is performed in the standard way (Grieken &amp; Markowicz, 2001<xref ref-type="bibr" rid="bb14"> ▸</xref>), by selecting at least two known X-ray lines. Then, the user can interactively select ROIs, containing the characteristic X-ray peaks of interest, which will be used during the further data reduction process. XRF spectrum deconvolution and background subtraction have not been integrated in <italic>MMX-I</italic>, since the strategy was not to re-create existing functions, which have been optimized and widely used in excellent software for several years, <italic>e.g.</italic>
<italic>PyMCA</italic> (Solé <italic>et al.</italic>, 2007<xref ref-type="bibr" rid="bb38"> ▸</xref>). Instead, <italic>MMX-I</italic> provides the possibility to export sum spectra in ‘<italic>mca</italic>’ file format in order to be processed by <italic>PyMCA</italic>. The resulting ‘fit’ file can be imported into <italic>MMX-I</italic> in order to create ROI images. An additional option allows fitted elemental maps obtained by <italic>PyMCA</italic> to be re-injected into <italic>MMX-I</italic> for further processing, <italic>e.g.</italic> for tomographic reconstruction.</p>
        <p><italic>Data reduction step.</italic> The data reduction step is performed by default for all the pixels of the scan. The transmission modalities are determined from the images of the transmitted beam (see Fig. 5<xref ref-type="fig" rid="fig5"> ▸</xref>). The transmission contrast image is calculated by the numerical summation of the pixels within the beam ROI (see the <italic>Pre-treatment</italic> section above) giving access to absorption contrast typical of conventional radiography.</p>
        <p>The differential phase contrast (DPC) is proportional to the refraction angle (Mukaide <italic>et al.</italic>, 2009<xref ref-type="bibr" rid="bb29"> ▸</xref>) as described in the following formulae,<disp-formula id="fd1"><graphic xlink:href="s-23-00783-efd1.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where φ is the phase, <inline-formula><inline-graphic xlink:href="s-23-00783-efi1.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and <inline-formula><inline-graphic xlink:href="s-23-00783-efi2.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> are the respective refraction angles along the horizontal and vertical directions, and λ is the wavelength. The refractions angles are determined by calculating the centroid of the transmitted beam, inside the ROI, along the horizontal and vertical directions. DPC images are used for phase map reconstructions (described below). It has to be noted that the scanning DPC technique allows the phase to be measured beyond 2π and therefore does not suffer from any phase-wrapping effects (de Jonge <italic>et al.</italic>, 2008<xref ref-type="bibr" rid="bb18"> ▸</xref>).</p>
        <p>The dark-field data represent the intensity of the scattering signal. Its amplitude is linked to the density fluctuation on a length-scale smaller than the illuminated area (Menzel <italic>et al.</italic>, 2010<xref ref-type="bibr" rid="bb27"> ▸</xref>) and is evaluated by integrating the scattered intensity outside of the transmitted beam, <italic>i.e.</italic> outside the illumination mask shown in Fig. 5<xref ref-type="fig" rid="fig5"> ▸</xref>. The anisotropy of the scattering can also be exploited and provides contrast information on the orientation of structures in the sample. Orientation may be retrieved by dividing each integrated area of a large annulus ROI into smaller parts, spread over 360°, and then computing the angle by fitting the intensity of each part with a cosine function (Bunk <italic>et al.</italic>, 2009<xref ref-type="bibr" rid="bb7"> ▸</xref>).</p>
      </sec>
    </sec>
    <sec id="sec2.3">
      <label>2.3.</label>
      <title>Data correction   </title>
      <p>In order to improve the quality of the reduced data images, an additional correction step is performed. This allows users to correct the effects of the beam intensity variation, the translation stage positioning errors, the image background variation and, for tomographic acquisition, the slight misalignment and eccentricity (called wobble) of the rotation axis. Correction of the reduced images is a crucial step in order to obtain reconstructed images with a high degree of fidelity. It is the reason why this image processing has been carefully developed in <italic>MMX-I</italic>.</p>
      <p>In order to correct for the variation of the incoming beam flux, an intensity monitor is inserted upstream of the sample. As such, the transmission, XRF and dark-field modalities are normalized with the incoming beam intensity measured in each pixel.</p>
      <p>In fast-scanning multi-technique nanoprobe methods, the sample is scanned in continuous motion along one dimension while the detectors (intensity monitor, 2D detector and XRF detectors) and the encoder positions are recorded for each pixel/voxel. The simultaneous data acquisition of each device is started by an external trigger signal. In the FLYSCAN architecture, the triggers are provided by a periodic TTL pulse generator. Due to motor acceleration/deceleration, motion speed stability and backlash, the pixel size of the map will not be equivalent in the whole scan. This inhomogeneity can strongly restrain the use of algorithms requiring data continuity. Therefore, each image has to be rescaled by the recorded encoder positions. <italic>MMX-I</italic> includes an algorithm to correct for such imperfections by positioning each measured pixel in a new perfect virtual grid. The virtual grid is created based on the measured motor position of each pixel. This grid is first reshaped in order to have pixels of the same size only. The new pixel size is defined as having the mean height and width of the measured pixels. The value of each measured pixel is then re-assigned in the virtual grid. Pixels from the virtual grid may contain the value of several measured pixels or none. To avoid these brutal discontinuities the virtual grid is finally smoothed where aberrant pixel values appear.</p>
      <p>Obtaining absolute absorption, dark-field and phase modalities requires reference values, which correspond to the value of the modality obtained without sample. These can only be derived in the case of well isolated objects (producing background pixels on the right and left part of each row). In this case an automatic edge detection function is applied defining the reference ‘background’ value for each row. A reference background region can also be manually defined, which is recommended in the case of non-isolated specimens.</p>
      <p>In the case of tomographic measurements, sinograms are extracted for each contrast modality from the projection images measured at different angles. For artefact-free tomography reconstruction, parameters such as the position of the axis of rotation have to be known and correction for irregular angular movements (wobble) has to be performed.</p>
      <p><italic>MMX-I</italic> includes correction algorithms for sample wobbling and slight misalignment of the rotation axis. The method, described in detail by Azavedo <italic>et al.</italic> (1990<xref ref-type="bibr" rid="bb3"> ▸</xref>), consists of computing the centre of mass for each projection and fitting the resulting sinogram curve with a sinus function. In order to perform correctly, this method implies that the object must always be in the field of view of the projections. In addition, special care is given to the sine fit function to minimize the influence of noise. The offset of the fit gives the centre of rotation. The distance between the centre of mass and the fitted curve for each projection is used to correct for the wobble effect. This method requires using preferably a sinogram over 360°. The evaluated shift correction obtained from the modality which has the largest signal contrast is then applied for all the other modalities. In the example shown below, the shift correction is evaluated from the transmission sinograms.</p>
    </sec>
    <sec id="sec2.4">
      <label>2.4.</label>
      <title>Data reconstruction   </title>
      <p>Reconstruction is the last step of data processing in <italic>MMX-I</italic>. In the case of 2D imaging, reconstruction concerns the phase determination from the horizontal and vertical differential phase contrast images. The different phase-retrieval methods implemented in <italic>MMX-I</italic> are presented and compared in the next section.</p>
      <p>For tomographic reconstruction, <italic>MMX-I</italic> provides both classical filtered back-projection (FBP) (Kak &amp; Slaney, 2001<xref ref-type="bibr" rid="bb19"> ▸</xref>) and iterative techniques, such the algebraic reconstruction technique (ART) and the simultaneous iterative reconstruction technique (SIRT) (Kak &amp; Slaney, 2001<xref ref-type="bibr" rid="bb19"> ▸</xref>). Each tomographic reconstruction method can be optimized independently for each contrast modality in order to extract the correct information. Tomographic reconstruction is described in §2.4.2<xref ref-type="sec" rid="sec2.4.2"/>.</p>
      <sec id="sec2.4.1">
        <label>2.4.1.</label>
        <title>Phase contrast reconstruction   </title>
        <p>Two methods have been implemented in <italic>MMX-I</italic> for quantitative phase reconstruction. The first is the Fourier integration method (Kottler <italic>et al.</italic>, 2007<xref ref-type="bibr" rid="bb46"> ▸</xref>), which applies a Fourier derivative technique to integrate directional phase gradients. The second procedure is the finite-difference-based least-squares integration methods with Southwell (Southwell, 1980<xref ref-type="bibr" rid="bb40"> ▸</xref>) configuration. The two methods and their performance on quantitative reconstruction of scanning X-ray phase contrast data are described and discussed below.</p>
        <p>The Fourier technique is based on the properties of the Fourier transform of a derivative function. A 2D Fourier transform is performed on the complex image formed by the vertical and horizontal phase gradient images as real and imaginary parts, respectively. Thus, the phase image weighted by the complex sum of the frequency coordinates is obtained in the Fourier space. An inverse Fourier transform of the phase image representation in frequency space is performed to determinate the quantitative phase shift φ information in the direct space,<disp-formula id="fd2"><graphic xlink:href="s-23-00783-efd2.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where <inline-formula><inline-graphic xlink:href="s-23-00783-efi3.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and <inline-formula><inline-graphic xlink:href="s-23-00783-efi4.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> are the horizontal and vertical phase gradients, <inline-formula><inline-graphic xlink:href="s-23-00783-efi5.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and <inline-formula><inline-graphic xlink:href="s-23-00783-efi6.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> are the reciprocal coordinates, and Real(…) indicates the real part of the complex function. The imaginary part of the inverse Fourier transform contains the error of the phase reconstruction and it is usually represented in terms of intensity less than 10% of the real part (Holzner, 2010<xref ref-type="bibr" rid="bb17"> ▸</xref>).</p>
        <p>Direct integration using the fast Fourier transform (FFT) algorithm is very fast and easy to implement. The drawback of methods based on discrete Fourier transform (DFT) is that the transformation assumes periodicity in the input image. Hence, when the investigated sample crosses the image boundaries, it will create artefacts in the reconstruction. To overcome this limitation, <italic>MMX-I</italic> offers the user the possibilty to create Von-Neumann boundary conditions by mirror processing in both directions of the differential phase contrast images (see Fig. 6<xref ref-type="fig" rid="fig6"> ▸</xref>). The images are mirrored in both directions following either the mirrored derivative integration (MDI) or antisymmetric derivative integration (ASDI) (Bon <italic>et al.</italic>, 2012<xref ref-type="bibr" rid="bb4"> ▸</xref>). Phase reconstruction is then carried out on the resulting images and automatically cropped to obtain the investigated phase. It has to be noted that, to avoid divergence in equation (2)<xref ref-type="disp-formula" rid="fd2"/>, the zero frequency value of the Fourier transform of the phase is set to zero. This means that the phase offset is lost and the sum of the integrated phase has to be null. Nevertheless, the phase shift can be calibrated using areas of the phase map where no objects are present.</p>
        <p>Iterative approaches such as least-squares integration with Southwell configuration methods are well known to be efficient especially when strong discontinuities are present in the DPC images. The Southwell methods consist of the linear integration of the gradients in the horizontal and vertical directions. At each iteration step, the phase shift map <inline-formula><inline-graphic xlink:href="s-23-00783-efi7.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> is calculated as follows,<disp-formula id="fd3"><graphic xlink:href="s-23-00783-efd3.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where <italic>i</italic> is the iteration step, <italic>w</italic> the relaxation factor and <italic>j</italic>, <italic>k</italic> the pixel coordinates.</p>
        <p>The relaxation factor <italic>w</italic>, which will make the solution converge towards the real phase value, is dependent on the algorithm update strategy. Jacobien and Gaussian Seidel algorithms are proposed to the users. In the first case, the phase is updated when the whole map has been processed. The relaxation factor must be defined in the interval ]0, 1]. In the second case, the phase map is updated after the processing of each pixel. The relaxation <italic>w</italic> has an optimal value, which depends only on <italic>N</italic>, the number of measured gradient values,<disp-formula id="fd4"><graphic xlink:href="s-23-00783-efd4.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>Fig. 6<xref ref-type="fig" rid="fig6"> ▸</xref> presents an example of phase reconstruction, using both integration techniques, performed on scanning imaging data of a head of a moth (Medjoubi <italic>et al.</italic>, 2013<italic>b</italic>
<xref ref-type="bibr" rid="bb26"> ▸</xref>). The DPC shows a large discontinuity produced by the strong absorption of the sample holder (Fig. 6<italic>c</italic>
<xref ref-type="fig" rid="fig6"> ▸</xref>). As expected, the Fourier reconstruction technique induced a large low-frequency intensity variation, which contaminates the whole image and restrains any quantitative information. This effect is found to be more localized using the iterative methods: the artefacts are circumscribed in a region around the discontinuity. The figure presents two profiles taken in the phase images reconstructed, respectively, with both methods. It can be seen that the dynamic is strongly reduced with the FFT method compared with the iterative one. Meanwhile, the main drawback of the Southwell technique is the long computation time: it can reach several minutes in the case of a 1 Megapixel projection image like that of the moth.</p>
        <p>By proposing in <italic>MMX-I</italic> these two phase integration methods, the user can make a sound compromise between calculation time and the expected more precise quantitative phase reconstruction.</p>
        <p>Quantitative phase reconstruction has been investigated by using the Fourier integration method. In order to validate the reconstruction performed by <italic>MMX-I</italic>, DPC images of nylon wires have been measured at an energy of 14 keV. The relation among the phase shift φ of the X-ray beam having a wavelength λ within the sample of thickness <italic>t</italic> for which the real part of the refraction index is δ can be written as <disp-formula id="fd5"><graphic xlink:href="s-23-00783-efd5.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>The nominal diameters of the horizontal and vertical wires are 50 µm and 100 µm, respectively. The wire thickness distribution is determined from the phase-shift map by using equation (5)<xref ref-type="disp-formula" rid="fd5"/> and is shown in Fig. 7(<italic>a</italic>)<xref ref-type="fig" rid="fig7"> ▸</xref>. The real part of the refraction index at 14 keV and the density of the nylon used are, respectively, 1.63 × 10<sup>−6</sup> and 1.13 g cm<sup>−3</sup> (Keyriläinen <italic>et al.</italic>, 2002<xref ref-type="bibr" rid="bb20"> ▸</xref>). The calculated thickness presents a very good agreement with the nominal values. The error of the thickness reconstruction is estimated to be ∼1 µm RMS from the noise within an area outside of the sample (orange square in Fig. 7<italic>a</italic>
<xref ref-type="fig" rid="fig7"> ▸</xref>). For comparison, the thickness distribution calculated from the absorption image is shown in Fig. 7(<italic>b</italic>)<xref ref-type="fig" rid="fig7"> ▸</xref>; it is very noisy with a poor signal-to-noise ratio (SNR) compared with the thickness map reconstructed from the phase shift. Moreover, the noise evaluated outside the object is about 12 µm RMS (orange square in Fig. 7<italic>b</italic>
<xref ref-type="fig" rid="fig7"> ▸</xref>).</p>
      </sec>
      <sec id="sec2.4.2">
        <label>2.4.2.</label>
        <title>Multimodal tomographic reconstruction   </title>
        <p>X-ray tomographic reconstruction algorithms are well known and well described in the literature (Kak &amp; Slaney, 2001<xref ref-type="bibr" rid="bb19"> ▸</xref>). Reconstruction algorithms such as FBP (Bracewell &amp; Riddle, 1967<xref ref-type="bibr" rid="bb6"> ▸</xref>) and ART (Gordon <italic>et al.</italic>, 1970<xref ref-type="bibr" rid="bb13"> ▸</xref>) are implemented in <italic>MMX-I</italic>. Each processing method has specific filters and reconstruction parameters, which can be optimized for reconstruction calculations of each contrast modality.</p>
        <p>FBP is based on the Fourier slice theorem (Kak &amp; Slaney, 2001<xref ref-type="bibr" rid="bb19"> ▸</xref>). This theorem describes the equality between the Fourier transform of a parallel 1D projection of an object obtained at a given angle and a profile taken at the same angle in the 2D Fourier transform of the object. When including additional projections, the frequency space is filled by additional rotational angles. The over-representation of low frequencies around the zero frequency is corrected by appropriate frequency weighting.</p>
        <p>Weight functions such as the ramp function multiplied by a hamming window are widely used as generally they provide the best results for most of the contrast modalities. The differential phase contrast is a specific case. Indeed, by using the Hilbert filter (Pfeiffer <italic>et al.</italic>, 2007<xref ref-type="bibr" rid="bb31"> ▸</xref>), phase integration is directly obtained from the DPC sinograms. Therefore, these two filters are implemented into <italic>MMX-I</italic>.</p>
        <p>FBP is a very fast and robust method. Meanwhile, reconstructed images are artefact-free only if the total number of angular projections is superior or equal to half the mean resolution of the projection (Kak &amp; Slaney, 2001<xref ref-type="bibr" rid="bb19"> ▸</xref>) and if the SNR is high. In scanning methods, especially for the XRF modality (<italic>e.g.</italic> trace element detection), these two conditions are not always fulfilled. In this case, the iterative method is well adapted. It allows, in spite of being computationally expensive, fewer projections to be handled and low SNR. The method starts with an initial estimate of the density distribution of the object obtained by a simple back-projection. By comparing the projections predicted from this initial estimate with those that are actually acquired, changes are made to the estimated tomogram. Each projection <inline-formula><inline-graphic xlink:href="s-23-00783-efi8.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> is modelled as follows,<disp-formula id="fd6"><graphic xlink:href="s-23-00783-efd6.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>with <italic>i</italic> the projection number (from 1 to <italic>M</italic>, the total number of projections), <italic>j</italic> the pixel number in the tomogram, <italic>N</italic> the total number of pixels of the tomogram image, <inline-formula><inline-graphic xlink:href="s-23-00783-efi9.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> the attenuation value of the pixel <italic>j</italic>, and <inline-formula><inline-graphic xlink:href="s-23-00783-efi10.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> the weighting factor for the <italic>i</italic>th projection and <italic>j</italic>th pixel. This latter corresponds to the fractional area of the <italic>j</italic>th pixel intercepted by the <italic>i</italic>th projection <inline-formula><inline-graphic xlink:href="s-23-00783-efi11.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>. This can also be a logic value (0 or 1) in order to save time for creating the <italic>w</italic> matrix but is less accurate.</p>
        <p>Two methods for the determination of <inline-formula><inline-graphic xlink:href="s-23-00783-efi9.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> have been integrated into <italic>MMX-I</italic>: standard ART and SIRT (Gilbert, 1972<xref ref-type="bibr" rid="bb11"> ▸</xref>). In the first case, the <inline-formula><inline-graphic xlink:href="s-23-00783-efi9.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> value at the pixel <italic>j</italic> is updated by using one projection at each time. The corresponding expression of <inline-formula><inline-graphic xlink:href="s-23-00783-efi9.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> for the <italic>k</italic>th iteration is<disp-formula id="fd7"><graphic xlink:href="s-23-00783-efd7.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>In the SIRT technique, the <italic>f</italic> value at the pixel <italic>j</italic> is updated by using the whole projections. The corresponding expression of <italic>f</italic> for the <italic>k</italic>th iteration is<disp-formula id="fd8"><graphic xlink:href="s-23-00783-efd8.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>The SIRT technique presents the advantage of strongly reducing the noise and the edge-enhancement artefacts (Leis, 2009<xref ref-type="bibr" rid="bb1"> ▸</xref>). On the other hand, the SIRT method converges slower and requires more computational resources than the other techniques detailed in this paper.</p>
        <p>As previously indicated, iterative approaches (ART and SIRT) are well suited for XRF tomography. In order to illustrate this, XRF tomography datasets acquired on a test sample at an energy of 14 keV (Medjoubi <italic>et al.</italic>, 2013<italic>a</italic>
<xref ref-type="bibr" rid="bb25"> ▸</xref>) were processed with <italic>MMX-I</italic>. This test sample consists of a glass capillary of 500 µm diameter containing three nylon fibres (two with a diameter of 100 µm and a 50 µm-diameter one) and a copper wire (40 µm in diameter). A virtual slice of the sample was measured through 500 angular projections equally distributed over 360°. One projection consisted of 500 pixels of 4 µm step size.</p>
        <p>FBP and SIRT tomographic reconstructions have been performed using in one case all the 500 projections and in the other case a sub-dataset of only 30 projections. Results are presented in Fig. 8<xref ref-type="fig" rid="fig8"> ▸</xref>.</p>
        <p>As expected, tomograms reconstructed with the SIRT method present a better SNR compared with FBP and are presenting fewer artefacts [<italic>e.g.</italic> missing star-like artefacts in Fig. 8(<italic>d</italic>)<xref ref-type="fig" rid="fig8"> ▸</xref> compared with Fig. 8(<italic>b</italic>)<xref ref-type="fig" rid="fig8"> ▸</xref>]. The signal in the XRF sinograms is usually low compared with transmission modalities. Under such conditions, even using the full dataset, the FBP reconstructed tomogram is noisy, as can be seen in Fig. 8(<italic>a</italic>)<xref ref-type="fig" rid="fig8"> ▸</xref>, which is less the case for the SIRT reconstructed tomogram [<italic>cf.</italic> Figs. 8(<italic>c</italic>) and 8(<italic>d</italic>)<xref ref-type="fig" rid="fig8"> ▸</xref>]. With a large angular sampling interval, <italic>i.e.</italic> 12° between each projection (30 projections dataset), FBP produces significant star-like artefacts which superimpose on the useful signals. Such artefacts are not observed with SIRT. Moreover, the SNR of the SIRT tomogram is above 5, <italic>i.e.</italic> better than the Rose criteria (Rose, 1948<xref ref-type="bibr" rid="bb35"> ▸</xref>). The spatial resolution is worse in the case of treating the 30 projections dataset, due to the limited angular projections.</p>
        <p>Regardless of the method used, tomographic reconstruction algorithms are based on combining the projections at different angles which requires that the sinograms are corrected for measurement errors, such as those depicted in §2.3<xref ref-type="sec" rid="sec2.3"/>, otherwise the reconstruction will contain artefacts resulting in reduced image quality. To treat this problem, correction algorithms have been carefully integrated into <italic>MMX-I</italic>.</p>
      </sec>
    </sec>
    <sec id="sec2.5">
      <label>2.5.</label>
      <title>User interface   </title>
      <p>The graphical user interface (GUI) has been designed in order to guide non-expert users through the complex data processing. It follows the panel structure of the workflow, starting from data importation to phase contrast and tomographic reconstruction. Each panel displays the main information required to validate or tune the default parameters of the actual process. Expert users find more options and parameters by navigating within the dedicated menu bar of each panel. Each step/panel of <italic>MMX-I</italic> is accessible in a specific order, which must be completed sequentially to ensure the input of the essential parameters of data processing. Only when a panel is completed may users advance to the next step, <italic>i.e.</italic> they can proceed to the next panel or they can return to a previous one to tune or add parameters. The GUI is based on the <italic>Swing</italic> platform-independent Java widget toolkit and <italic>ImageJ</italic>, which has been used to display images and provide image interaction with user input.</p>
      <p>The panel of the GUI corresponding to the raw data importation and visualization parts is presented in Fig. 9<xref ref-type="fig" rid="fig9"> ▸</xref>. In this panel the raw data of the HDF5 file, <italic>e.g.</italic> measured transmission images (as actually shown in the upper part of the figure), are displayed in the top right of the interface and the XRF spectrum panel in the bottom right. The current ROI for the 2D detector images is automatically shown and can be modified manually by the user. The shown data are updated while navigating with a scroll bar through the measured pixels of the scan. As an option, the sum spectrum of each XRF detector for the whole dataset can also be obtained by selecting the ‘mean function’ as shown in Fig. 9<xref ref-type="fig" rid="fig9"> ▸</xref>. This spectrum can be used, for example, for energy calibration. Moreover, ROIs in the XRF spectra, motor position correction and hot pixel removal parameters can be set in this tab.</p>
    </sec>
  </sec>
  <sec id="sec3">
    <label>3.</label>
    <title>Examples   </title>
    <p>The possibilities offered by <italic>MMX-I</italic> are illustrated here by some examples. Measurements were performed at the FZP-based micro-probe end-station of Nanoscopium.</p>
    <sec id="sec3.1">
      <label>3.1.</label>
      <title>Bi-dimensional multimodal imaging of a standard structure   </title>
      <p>A 2D fast-scanning imaging of a nanostructure calibration chart, which includes the SOLEIL logo (250 µm wide and 75 µm high), was measured with a 400 nm × 400 nm pixel size. For a scan of 300 × 800 pixels the total measurement time was less than 10 min and represents a data volume of 40 GBytes. The absorption contrast, differential phase contrast, dark-field contrast, phase contrast and Au, Ni maps were reconstructed with <italic>MMX-I</italic> in less than 5 min with a laptop (Intel core i7-4900MQ, 16Go Ram, 1To Samsung SSD EVO 840) and can be seen in Fig. 10<xref ref-type="fig" rid="fig10"> ▸</xref>. The reconstructed phase shifts of the gold and nickel structures are 0.6 and 0.66 rad, respectively, which agree well with the thickness values extracted from the absorption image.</p>
    </sec>
    <sec id="sec3.2">
      <label>3.2.</label>
      <title>Multitechnique tomography of a microfossil   </title>
      <p>Microfossils are valuable tools for paleo-environmental interpretations. Due to their ubiquity in most marine environments and their abundance in the geological records from the Cambrian (&gt;500 million of years) to the present times, foraminifera are one of the most widely studied groups of fossil records worldwide in paleoceanography (Fischer &amp; Wefer, 1999<xref ref-type="bibr" rid="bb10"> ▸</xref>).</p>
      <p>Foraminifera are single-cell eukaryotes (Protozoa). Many species secrete shells, which are composed of calcium carbonate (CaCO<sub>3</sub>). During its secretion, trace elements are incorporated into this calcareous shell from the sea water (Boyle, 1981<xref ref-type="bibr" rid="bb5"> ▸</xref>; Munsel <italic>et al.</italic>, 2010<xref ref-type="bibr" rid="bb30"> ▸</xref>), in concentrations depending on the ambient sea water conditions. As such, geochemical data obtained from foraminifera measurements are used as proxies also in paleo-climatology. Moreover, if we can understand how organisms in the past responded to environmental changes, then that information can be used to predict how future natural or anthropogenic environmental change might affect the Earth’s biota. Understanding mechanisms of heavy metals incorporation during biomineralization processes in foraminifera is a fundamental key for interpretation of these geological records, where spatially resolved and high analytical sensitivity 3D elemental and morphological studies might bring important new information to the existing mostly bulk studies.</p>
      <p>In order to test the possibility of scanning hard X-ray tomography on such samples, we performed 3D multi-technique tomography on a fossil foraminifera. Tomography has been performed with an angular step <inline-formula><inline-graphic xlink:href="s-23-00783-efi15.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> = 1.8° over 180°. We aimed at the acquisition of moderate 2 µm × 2 µm spatial resolutions, due to the large 300 µm × 100 µm × 120 µm size of the sample. We measured 23 virtual slices in 1 µm steps between the slices. The acquisition was accomplished slice by slice in the <italic>x</italic> (scanning line), <inline-formula><inline-graphic xlink:href="s-23-00783-efi16.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> (rotation in the axis perpendicular to the scanning line) and <italic>z</italic> (axis perpendicular to the scanning line) sequence, by scanning a full horizontal line with <inline-formula><inline-graphic xlink:href="s-23-00783-efi17.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> = 1 µm steps and then performing a rotational step (<inline-formula><inline-graphic xlink:href="s-23-00783-efi15.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>). The measurement time was 3 ms per pixel. The total measurement time of the 500 × 200 × 23 voxels, each containing the XRF, the transmission data, data coordinate <italic>etc.</italic> as described above, was 3 h. It resulted in a 500 GB data file. This dataset was analysed and the tomograms of the different modalities were reconstructed by <italic>MMX-I</italic>. In Fig. 11<xref ref-type="fig" rid="fig11"> ▸</xref> the volume rendering of the reconstructed phase, dark field and the distributions of Fe and Ca are shown. The best morphological contrast is obtained by DPC in the case of the foraminifera, which contains a thin (∼10 µm) CaCO<sub>3</sub> shell. The highest dark-field contrast indicating highly scattering granular structure corresponds to structures with lower absorption, which contain no Ca. These light highly scattering structures can be found mostly in the interior of the shell. Interestingly, Fe is distributed within the highly scattering internal structure and also as a small Fe grain at the exterior of the foraminifera. No significant Fe was found within other highly scattering structures.</p>
    </sec>
  </sec>
  <sec id="sec4">
    <label>4.</label>
    <title>Discussion and conclusion   </title>
    <p>The <italic>MMX-I</italic> software developed at the Nanoscopium beamline of SOLEIL is, to our knowledge, the first software tool that aims at treating all modalities (except ptychography) of scanning multi-technique imaging and tomography experiments.</p>
    <p><italic>MMX-I</italic> includes different data-correction and reconstruction methods both for 2D imaging and tomography. For each included contrast modality, which up to now is scanning XRF, differential phase contrast, absorption contrast and dark field, the software offers a dedicated default data-treatment and tomographic reconstruction method which is, according to our experience, the best suited to a given modality for most sample types. As such, users unfamiliar with X-ray imaging can readily use the software. This is well illustrated by the examples of the foraminifera and the standard structure, where the default ROI, ‘illumination mask’, reconstruction methods and variables were used for data treatment. Users experienced in the treatment of X-ray imaging have the possibility to modify and optimize all the parameters. This diversity and flexibility makes <italic>MMX-I</italic> a software tool well adapted to data treatment of fast multimodal imaging. Multimodal imaging opens the additional possibility of the combination of all modalities in order to obtain complete information for quantification. For light elements in strongly absorbing sample matrices, self-absorption correction of XRF tomographic data is crucial, which will be developed as a further option in <italic>MMX-I</italic>.</p>
    <p>The modular construction of <italic>MMX-I</italic> makes the integration of other imaging modalities or reconstruction algorithms (Gürsoy <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb15"> ▸</xref>) easy and readily available. For example, it is possible to integrate other methods, <italic>e.g.</italic> full-field tomography, as a new modality which could be useful for correlative imaging. However, <italic>MMX-I</italic> does not intend to replace the already existing powerful full-field tomographic reconstruction software tools.</p>
    <p>In addition, one of the important features of the software is the dedicated data read-in API, named Hdf5Opener, which makes the read-in and treatment of large, several hundred GB, data files possible also with standard and laptop user PCs. This is a crucial criterion for its utilization by a large user community. Moreover, fast data read-in provided by the beamline data-treatment server makes data pre-treatment and tomographic reconstruction possible during user experiments. The standalone Hdf5Opener API can be readily used by other software.</p>
    <p>The <italic>MMX-I</italic> freeware is available for data treatment of scanning multimodal imaging both for users at the Nanoscopium beamline and for other user communities. The compiled version of <italic>MMX-I</italic> is available at <ext-link ext-link-type="uri" xlink:href="https://bitbucket.org/antoinebergamaschi/mmx-i/wiki/Home">https://bitbucket.org/antoinebergamaschi/mmx-i/wiki/Home</ext-link>. The source code is available from the authors on demand.</p>
  </sec>
</body>
<back>
  <ack>
    <p>The authors are grateful for the continuous help, advice and expertise of the SOLEIL Support Groups. Special thanks for Nicolas Leclercq for his work with the development of the FLYSCAN. We acknowledge Isvan Mohacsi and Delphine Desmares for providing the test structures and foraminifera samples.</p>
  </ack>
  <ref-list>
    <title>References</title>
    <ref id="bb1">
      <mixed-citation publication-type="other">Andrew Leis, B. R. (2009). <italic>Trends Biochem. Sci.</italic>
<bold>34</bold>, 60–70.</mixed-citation>
    </ref>
    <ref id="bb2">
      <mixed-citation publication-type="other">aXis2000 (1997). <italic>aXis2000</italic>, http://unicorn.mcmaster.ca/aXis2000.html.</mixed-citation>
    </ref>
    <ref id="bb3">
      <mixed-citation publication-type="other">Azevedo, S. G., Schneberk, D. J., Fitch, J. &amp; Martz, H. E. (1990). <italic>IEEE Trans. Nucl. Sci.</italic>
<bold>37</bold>, 1525–1540.</mixed-citation>
    </ref>
    <ref id="bb4">
      <mixed-citation publication-type="other">Bon, P., Monneret, S. &amp; Wattellier, B. (2012). <italic>Appl. Opt.</italic>
<bold>51</bold>, 5698–5704.</mixed-citation>
    </ref>
    <ref id="bb5">
      <mixed-citation publication-type="other">Boyle, E. A. (1981). <italic>Earth Planet. Sci. Lett.</italic>
<bold>53</bold>, 11–35.</mixed-citation>
    </ref>
    <ref id="bb6">
      <mixed-citation publication-type="other">Bracewell, R. N. &amp; Riddle, A. C. (1967). <italic>Astrophys. J.</italic>
<bold>150</bold>, 427.</mixed-citation>
    </ref>
    <ref id="bb7">
      <mixed-citation publication-type="other">Bunk, O., Bech, M., Jensen, T. H., Feidenhans’l, R., Binderup, T., Menzel, A. &amp; Pfeiffer, F. (2009). <italic>New J. Phys.</italic>
<bold>11</bold>, 123016.</mixed-citation>
    </ref>
    <ref id="bb8">
      <mixed-citation publication-type="other">Chen, R.-C., Dreossi, D., Mancini, L., Menk, R., Rigon, L., Xiao, T.-Q. &amp; Longo, R. (2012). <italic>J. Synchrotron Rad.</italic>
<bold>19</bold>, 836–845.</mixed-citation>
    </ref>
    <ref id="bb9">
      <mixed-citation publication-type="other">Colvin, R. A., Lai, B., Holmes, W. R. &amp; Lee, D. (2015). <italic>Metallomics</italic>, <bold>7</bold>, 1111–1123.</mixed-citation>
    </ref>
    <ref id="bb10">
      <mixed-citation publication-type="other">Fischer, G. &amp; Wefer, G. (1999). <italic>Use of Proxies in Paleoceanography.</italic> Berlin/Heidelberg: Springer.</mixed-citation>
    </ref>
    <ref id="bb11">
      <mixed-citation publication-type="other">Gilbert, P. (1972). <italic>J. Theor. Biol.</italic>
<bold>36</bold>, 105–117.</mixed-citation>
    </ref>
    <ref id="bb12">
      <mixed-citation publication-type="other">Gonzalez, R. C. &amp; Woods, R. E. (2006). <italic>Digital Image Processing</italic>, 3rd ed. New Jersey: Prentice-Hall.</mixed-citation>
    </ref>
    <ref id="bb13">
      <mixed-citation publication-type="other">Gordon, R., Bender, R. &amp; Herman, G. T. (1970). <italic>J. Theor. Biol.</italic>
<bold>29</bold>, 471–481.</mixed-citation>
    </ref>
    <ref id="bb14">
      <mixed-citation publication-type="other">Grieken, R. V. &amp; Markowicz, A. (2001). <italic>Handbook of X-ray Spectrometry</italic>, 2nd ed. New York: CRC Press.</mixed-citation>
    </ref>
    <ref id="bb15">
      <mixed-citation publication-type="other">Gürsoy, D., Biçer, T., Lanzirotti, A., Newville, M. G. &amp; De Carlo, F. (2015). <italic>Opt. Express</italic>, <bold>23</bold>, 9014–9023.</mixed-citation>
    </ref>
    <ref id="bb16">
      <mixed-citation publication-type="other">Gürsoy, D., De Carlo, F., Xiao, X. &amp; Jacobsen, C. (2014). <italic>J. Synchrotron Rad.</italic>
<bold>21</bold>, 1188–1193.</mixed-citation>
    </ref>
    <ref id="bb17">
      <mixed-citation publication-type="other">Holzner, C. (2010). <italic>Hard X-ray Phase Contrast Microscopy – Techniques and Applications.</italic> NY: Stony Brook University.</mixed-citation>
    </ref>
    <ref id="bb18">
      <mixed-citation publication-type="other">Jonge, M. D. de, Hornberger, B., Holzner, C., Legnini, D., Paterson, D., McNulty, I., Jacobsen, C. &amp; Vogt, S. (2008). <italic>Phys. Rev. Lett.</italic>
<bold>100</bold>, 163902.</mixed-citation>
    </ref>
    <ref id="bb19">
      <mixed-citation publication-type="other">Kak, A. C. &amp; Slaney, M. (2001). <italic>Principles of Computerized Tomographic Imaging.</italic> Philadelphia: Society for Industrial and Applied Mathematics.</mixed-citation>
    </ref>
    <ref id="bb20">
      <mixed-citation publication-type="other">Keyriläinen, J., Fernández, M. &amp; Suortti, P. (2002). <italic>Nucl. Instrum. Methods Phys. Res. A</italic>, <bold>488</bold>, 419–427.</mixed-citation>
    </ref>
    <ref id="bb21">
      <mixed-citation publication-type="other">Könnecke, M., Akeroyd, F. A., Bernstein, H. J., Brewster, A. S., Campbell, S. I., Clausen, B., Cottrell, S., Hoffmann, J. U., Jemian, P. R., Männicke, D., Osborn, R., Peterson, P. F., Richter, T., Suzuki, J., Watts, B., Wintersberger, E. &amp; Wuttke, J. (2015). <italic>J. Appl. Cryst.</italic>
<bold>48</bold>, 301–305.</mixed-citation>
    </ref>
    <ref id="bb46">
      <mixed-citation publication-type="other">Kottler, C., David, C., Pfeiffer, F. &amp; Bunk, O. (2007). <italic>Opt. Express</italic>, <bold>15</bold>, 1175–1181.</mixed-citation>
    </ref>
    <ref id="bb22">
      <mixed-citation publication-type="other">Leclercq, N., Berthault, J., Langlois, F., Le, S., Poirier, S., Bisou, J., Blache, F., Medjoubi, K. &amp; Mocuta, C. (2015). <italic>FLYSCAN: A Fast and Multi-Technique Data Acquisition Platform for the SOLEIL Beamlines.</italic> Melbourne, Australia.</mixed-citation>
    </ref>
    <ref id="bb23">
      <mixed-citation publication-type="other">Lerotic, M., Mak, R., Wirick, S., Meirer, F. &amp; Jacobsen, C. (2014). <italic>J. Synchrotron Rad.</italic>
<bold>21</bold>, 1206–1212.</mixed-citation>
    </ref>
    <ref id="bb24">
      <mixed-citation publication-type="other">Liu, Y., Meirer, F., Williams, P. A., Wang, J., Andrews, J. C. &amp; Pianetta, P. (2012). <italic>J. Synchrotron Rad.</italic>
<bold>19</bold>, 281–287.</mixed-citation>
    </ref>
    <ref id="bb25">
      <mixed-citation publication-type="other">Medjoubi, K., Bonissent, A., Leclercq, N., Langlois, F., Mercère, P. &amp; Somogyi, A. (2013<italic>a</italic>). <italic>Proc. SPIE</italic>, <bold>8851</bold>, 88510.</mixed-citation>
    </ref>
    <ref id="bb26">
      <mixed-citation publication-type="other">Medjoubi, K., Leclercq, N., Langlois, F., Buteau, A., Lé, S., Poirier, S., Mercère, P., Sforna, M. C., Kewish, C. M. &amp; Somogyi, A. (2013<italic>b</italic>). <italic>J. Synchrotron Rad.</italic>
<bold>20</bold>, 293–299.</mixed-citation>
    </ref>
    <ref id="bb27">
      <mixed-citation publication-type="other">Menzel, A., Kewish, C. M., Kraft, P., Henrich, B., Jefimovs, K., Vila-Comamala, J., David, C., Dierolf, M., Thibault, P., Pfeiffer, F. &amp; Bunk, O. (2010). <italic>Ultramicroscopy</italic>, <bold>110</bold>, 1143–1147.</mixed-citation>
    </ref>
    <ref id="bb28">
      <mixed-citation publication-type="other">Messaoudii, C., Boudier, T., Sanchez Sorzano, C. O. &amp; Marco, S. (2007). <italic>BMC Bioinformatics</italic>, <bold>8</bold>, 288.</mixed-citation>
    </ref>
    <ref id="bb29">
      <mixed-citation publication-type="other">Mukaide, T., Takada, K., Watanabe, M., Noma, T. &amp; Iida, A. (2009). <italic>Rev. Sci. Instrum.</italic>
<bold>80</bold>, 033707.</mixed-citation>
    </ref>
    <ref id="bb30">
      <mixed-citation publication-type="other">Munsel, D., Kramar, U., Dissard, D., Nehrke, G., Berner, Z., Bijma, J., Reichart, G.-J. &amp; Neumann, T. (2010). <italic>Biogeosciences</italic>, <bold>7</bold>, 2339–2350.</mixed-citation>
    </ref>
    <ref id="bb31">
      <mixed-citation publication-type="other">Pfeiffer, F., Kottler, C., Bunk, O. &amp; David, C. (2007). <italic>Phys. Rev. Lett.</italic>
<bold>98</bold>, 108105.</mixed-citation>
    </ref>
    <ref id="bb32">
      <mixed-citation publication-type="other">Poirier, S., Marechal, C., Ounsy, M., Buteau, A., Martinez, P., Gagey, B., Pierrot, P., Mederbel, M. &amp; Rochat, J. (2009). <italic>Experimental Data Storage Management in Nexus Format at Synchrotron Soleil</italic>, p. 75. Kobe Japan.</mixed-citation>
    </ref>
    <ref id="bb33">
      <mixed-citation publication-type="other">Reenskaug, T. (1979). <italic>The Model-View-Controller (MVC) – Its Past and Present</italic>, https://heim.ifi.uio.no/~trygver/themes/mvc/mvc-index.html.</mixed-citation>
    </ref>
    <ref id="bb34">
      <mixed-citation publication-type="other">Rizk, A., Paul, G., Incardona, P., Bugarski, M., Mansouri, M., Niemann, A., Ziegler, U., Berger, P. &amp; Sbalzarini, I. F. (2014). <italic>Nat. Protoc.</italic>
<bold>9</bold>, 586–596.</mixed-citation>
    </ref>
    <ref id="bb35">
      <mixed-citation publication-type="other">Rose, A. (1948). <italic>J. Opt. Soc. Am.</italic>
<bold>38</bold>, 196–208.</mixed-citation>
    </ref>
    <ref id="bb36">
      <mixed-citation publication-type="other">Saalfeld, S., Fetter, R., Cardona, A. &amp; Tomancak, P. (2012). <italic>Nat. Methods</italic>, <bold>9</bold>, 717–720.</mixed-citation>
    </ref>
    <ref id="bb37">
      <mixed-citation publication-type="other">Schneider, C. A., Rasband, W. S. &amp; Eliceiri, K. W. (2012). <italic>Nat. Methods</italic>, <bold>9</bold>, 671–675.</mixed-citation>
    </ref>
    <ref id="bb45">
      <mixed-citation publication-type="other">Sforna, M. C., Philippot, P., Somogyi, A., van Zuilen, M. A., Medjoubi, K., Schoepp-Cothenet, B., Nitschke, W. &amp; Visscher, P. T. (2014). <italic>Nat. Geosci.</italic>
<bold>7</bold>, 811–815.</mixed-citation>
    </ref>
    <ref id="bb38">
      <mixed-citation publication-type="other">Solé, V. A., Papillon, E., Cotte, M., Walter, P. &amp; Susini, J. (2007). <italic>Spectrochim. Acta B</italic>, <bold>62</bold>, 63–68.</mixed-citation>
    </ref>
    <ref id="bb39">
      <mixed-citation publication-type="other">Somogyi, A., Medjoubi, K., Baranton, G., Le Roux, V., Ribbens, M., Polack, F., Philippot, P. &amp; Samama, J.-P. (2015). <italic>J. Synchrotron Rad.</italic>
<bold>22</bold>, 1118–1129.</mixed-citation>
    </ref>
    <ref id="bb40">
      <mixed-citation publication-type="other">Southwell, W. H. (1980). <italic>J. Opt. Soc. Am.</italic>
<bold>70</bold>, 998–1006.</mixed-citation>
    </ref>
    <ref id="bb41">
      <mixed-citation publication-type="other">The HDF Group (2015<italic>b</italic>). <italic>Hdf5View.</italic> The HDF Group, Illinois, USA.</mixed-citation>
    </ref>
    <ref id="bb42">
      <mixed-citation publication-type="other">The HDF Group (2015<italic>a</italic>). <italic>The Hdf5 Group</italic>, https://www.hdfgroup.org/.</mixed-citation>
    </ref>
    <ref id="bb43">
      <mixed-citation publication-type="other">Vogt, S. (2003). <italic>J. Phys. IV</italic>, <bold>104</bold>, 4.</mixed-citation>
    </ref>
    <ref id="bb44">
      <mixed-citation publication-type="other">Weitkamp, T., Haas, D., Wegrzynek, D. &amp; Rack, A. (2011). <italic>J. Synchrotron Rad.</italic>
<bold>18</bold>, 617–629.</mixed-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig id="fig1" position="float">
    <label>Figure 1</label>
    <caption>
      <p>Principle of the scanning nanoprobe station. The sample is raster scanned in the focused beam while recording simultaneously the XRF spectra by energy-dispersive detectors and the transmitted beam by a fast and sensitive 2D detector. The resulting data matrix includes the XRF spectra, the 2D magnified transmission images, the values of the intensity, and beam position monitors and sample scan positions.</p>
    </caption>
    <graphic xlink:href="s-23-00783-fig1"/>
  </fig>
  <fig id="fig2" position="float">
    <label>Figure 2</label>
    <caption>
      <p><italic>MMX-I</italic> workflow. Raw data are imported from an HDF5 file <italic>via</italic> Hdf5Opener and then reduced to absorption, dark-field, phase-contrast (DPC) and elemental maps. After this step data can be exported as tiff files or existing maps can be imported. This is followed by data correction and then data reconstruction.</p>
    </caption>
    <graphic xlink:href="s-23-00783-fig2"/>
  </fig>
  <fig id="fig3" position="float">
    <label>Figure 3</label>
    <caption>
      <p>File tree of a single NeXus file corresponding to a 2D multi-technique scan. The images of the bi-dimensional detector are contained in a 4D matrix (each pixel of the 2D data map contains a 2D detector image), XRF spectra are in a 3D matrix, the positions and intensity values are in a 2D matrix.</p>
    </caption>
    <graphic xlink:href="s-23-00783-fig3"/>
  </fig>
  <fig id="fig4" position="float">
    <label>Figure 4</label>
    <caption>
      <p>Scheme of the Hdf5Opener streaming process. The ‘Stream’ object passes to the Hdf5Opener (red arrow) to the read queue which consists of a list of read requests. Hdf5Opener reads sequentially, in ‘continuous’ mode, each read request and stores the result in the storage array (blue arrow).</p>
    </caption>
    <graphic xlink:href="s-23-00783-fig4"/>
  </fig>
  <fig id="fig5" position="float">
    <label>Figure 5</label>
    <caption>
      <p>Transmitted X-ray beam recorded by the XPAD 2D photon-counting detector. The image is displayed on a log scale. Pixels used for data reduction are inside the default ROI marked with a white square. The white circle represents the outer limit of the default ‘illumination mask’ used for determining the pixels belonging to the dark field.</p>
    </caption>
    <graphic xlink:href="s-23-00783-fig5"/>
  </fig>
  <fig id="fig6" position="float">
    <label>Figure 6</label>
    <caption>
      <p>Phase retrieval of a moth head by using Southwell (<italic>a</italic>) and Fourier integration (<italic>b</italic>) techniques. Vertical profiles measured on both images are compared in (<italic>d</italic>). The absorption-contrast image (<italic>c</italic>) shows the high attenuation of the sample holder.</p>
    </caption>
    <graphic xlink:href="s-23-00783-fig6"/>
  </fig>
  <fig id="fig7" position="float">
    <label>Figure 7</label>
    <caption>
      <p>Quantitative thickness reconstruction obtained from phase-retrieval image (<italic>a</italic>) and absorption image (<italic>b</italic>).</p>
    </caption>
    <graphic xlink:href="s-23-00783-fig7"/>
  </fig>
  <fig id="fig8" position="float">
    <label>Figure 8</label>
    <caption>
      <p>Reconstructed scattering (Rayleigh + Compton) distributions by FBP (top row) and SIRT (bottom row) by using 500 (<italic>a</italic> and <italic>c</italic>) and 30 angular projections (<italic>b</italic> and <italic>d</italic>) of a capillary containing three nylon fibres and a copper wire [marked by the red circle in (<italic>a</italic>) for clarity].</p>
    </caption>
    <graphic xlink:href="s-23-00783-fig8"/>
  </fig>
  <fig id="fig9" position="float">
    <label>Figure 9</label>
    <caption>
      <p>Graphical user interface of <italic>MMX-I</italic>.</p>
    </caption>
    <graphic xlink:href="s-23-00783-fig9"/>
  </fig>
  <fig id="fig10" position="float">
    <label>Figure 10</label>
    <caption>
      <p>Absorption (<italic>a</italic>), phase (<italic>b</italic>), dark-field (<italic>c</italic>) and XRF (<italic>d</italic>) images of the SOLEIL logo made of gold (in red) and nickel (in green) and with structure size down to 200 nm.</p>
    </caption>
    <graphic xlink:href="s-23-00783-fig10"/>
  </fig>
  <fig id="fig11" position="float">
    <label>Figure 11</label>
    <caption>
      <p>Multimodal volume rendering of a foraminifera sample. The reconstructed phase is shown in grey.</p>
    </caption>
    <graphic xlink:href="s-23-00783-fig11"/>
  </fig>
</floats-group>
