<?all-math-mml yes?>
<?use-mml?>
<?properties open_access?>
<?properties manuscript?>
<?origin ukpmcpa?>
<?ManuscriptPrefix new?>
<?iso-abbr Nat. Methods?>
<?submitter-system ukmss?>
<?submitter-canonical-name Nature Publishing Group?>
<?submitter-canonical-id NATURE-STRUCTUR?>
<?submitter-userid 0?>
<?submitter-authority publisher?>
<?submitter-login NPG?>
<?submitter-name Nature Publishing Group?>
<?domain wtpa?>
<?origin ukpmcpa?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-journal-id">101215604</journal-id>
    <journal-id journal-id-type="nlm-ta">Nat Methods</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat. Methods</journal-id>
    <journal-title-group>
      <journal-title>Nature methods</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1548-7091</issn>
    <issn pub-type="epub">1548-7105</issn>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6858868</article-id>
    <article-id pub-id-type="pmid">31591575</article-id>
    <article-id pub-id-type="doi">10.1038/s41592-019-0580-y</article-id>
    <article-id pub-id-type="manuscript">ems84178</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Real-time cryo–EM data pre-processing with <italic>Warp</italic></article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Tegunov</surname>
          <given-names>Dimitry</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Cramer</surname>
          <given-names>Patrick</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
      </contrib>
    </contrib-group>
    <aff id="A1"><label>1</label>Max Planck Institute for Biophysical Chemistry, Department of Molecular Biology, Am Fassberg 11, 37077 Göttingen, Germany</aff>
    <author-notes>
      <corresp id="CR1">Correspondence should be addressed to D.T. (<email>dteguno@mpibpc.mpg.de</email>) and P.C. (<email>patrick.cramer@mpibpc.mpg.de</email>).</corresp>
    </author-notes>
    <pub-date pub-type="nihms-submitted">
      <day>22</day>
      <month>8</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>07</day>
      <month>10</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <month>11</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>07</day>
      <month>4</month>
      <year>2020</year>
    </pub-date>
    <volume>16</volume>
    <issue>11</issue>
    <fpage>1146</fpage>
    <lpage>1152</lpage>
    <!--elocation-id from pubmed: 10.1038/s41592-019-0580-y-->
    <permissions>
      <license xlink:href="http://www.nature.com/authors/editorial_policies/license.html#terms">
        <license-p>Users may view, print, copy, and download text and data-mine the content in such documents, for the purposes of academic research, subject always to the full Conditions of use:<ext-link ext-link-type="uri" xlink:href="http://www.nature.com/authors/editorial_policies/license.html#terms">http://www.nature.com/authors/editorial_policies/license.html#terms</ext-link></license-p>
      </license>
    </permissions>
    <abstract>
      <p id="P1">The acquisition of cryo-electron microscopy (cryo-EM) data from biological specimen must be tightly coupled to data pre-processing to ensure best data quality and microscope usage. Here we provide <italic>Warp</italic>, a software for real-time evaluation and pre-processing of cryo-EM data during their acquisition. <italic>Warp</italic> corrects micrographs for global and local motion, estimates the local defocus with the use of novel algorithms, and monitors key parameters for each recorded micrograph or tomographic tilt series in real time. The software further includes deep learning-based models for accurate particle picking and image denoising. The output from <italic>Warp</italic> can be fed into established programs for particle classification and 3D map refinement. Our benchmarks show improvement in the nominal resolution from 3.9 Å to 3.2 Å through fully automated processing of a published cryo-EM data set for influenza virus hemagglutinin. <italic>Warp</italic> is easy to install, computationally inexpensive, and has an intuitive and streamlined user interface.</p>
    </abstract>
  </article-meta>
</front>
<body>
  <sec sec-type="intro" id="S1">
    <title>Introduction</title>
    <p id="P2">Modern cryo–electron microscopy (cryo–EM) allows structures of protein assemblies to be solved at an ever-increasing speed. Automation of the data acquisition process and improved instrument stability have reduced the time required to collect hundreds of thousands of particle images to mere days. As the field attracts more scientists and the research projects become more ambitious, data collection time on a high-end microscope will remain a scarce and expensive resource<sup><xref rid="R1" ref-type="bibr">1</xref></sup>. To make the best use of microscope time, the operator needs to continuously monitor data quality<sup><xref rid="R2" ref-type="bibr">2</xref></sup>. Because many artifacts only become evident at the later stages of processing, the results of as many processing steps as possible should be available quickly to enable informed decisions during data collection.</p>
    <p id="P3">The standard cryo–EM processing pipeline begins with the alignment of dose-fractionated image frames to cancel out sample motion<sup><xref rid="R3" ref-type="bibr">3</xref></sup>. This is followed by an estimation of the contrast transfer function (CTF)<sup><xref rid="R4" ref-type="bibr">4</xref></sup>. Particles are then selected and extracted from the images<sup><xref rid="R5" ref-type="bibr">5</xref></sup>. These steps are usually referred to as ‘data pre-processing’. Subsequent 2D and 3D classification of the particles serves to separate different complex conformations. Finally, 3D refinement is performed to obtain a three-dimensional map that is used to build a model.</p>
    <p id="P4">Separate tools exist that can handle different steps of pre-processing. Global frame alignment and, optionally, dose weighting is performed by tools such as MotionCorr<sup><xref rid="R6" ref-type="bibr">6</xref></sup>, Unblur<sup><xref rid="R7" ref-type="bibr">7</xref></sup> and SerialEM<sup><xref rid="R8" ref-type="bibr">8</xref></sup>; while MotionCor2<sup><xref rid="R9" ref-type="bibr">9</xref></sup>, alignparts_lmbfgs<sup><xref rid="R10" ref-type="bibr">10</xref></sup> and Zorro<sup><xref rid="R11" ref-type="bibr">11</xref></sup> can also align the images locally to account for beam-induced motion (BIM). The CTF can be estimated using CTFFIND<sup><xref rid="R12" ref-type="bibr">12</xref></sup> or EMAN2.1<sup><xref rid="R13" ref-type="bibr">13</xref></sup>, while gctf<sup><xref rid="R14" ref-type="bibr">14</xref></sup> will also estimate per-particle defocus if coordinates are available. Due to its complexity, particle picking remains the most actively researched part of the pipeline, with correlation-based approaches available in RELION<sup><xref rid="R15" ref-type="bibr">15</xref></sup>, FindEM<sup><xref rid="R16" ref-type="bibr">16</xref></sup> or Signature<sup><xref rid="R17" ref-type="bibr">17</xref></sup>, and more advanced machine learning techniques implemented in Xmipp<sup><xref rid="R18" ref-type="bibr">18</xref></sup> and DeepPicker<sup><xref rid="R19" ref-type="bibr">19</xref></sup>. Software packages like Appion<sup><xref rid="R20" ref-type="bibr">20</xref></sup>, FOCUS<sup><xref rid="R21" ref-type="bibr">21</xref></sup> and Scipion<sup><xref rid="R22" ref-type="bibr">22</xref></sup> are built around these tools to provide a common interface and automate the execution of all steps. Although several tools can be combined to cover the full pipeline, reliably performing pre-processing of cryo–EM raw data at the speed of data collection remains a struggle, and manual reprocessing is possibly required afterwards. Only for exceptionally favorable samples, data processing has been reduced to “one push of a button” by fully automated procedures<sup><xref rid="R23" ref-type="bibr">23</xref>, <xref rid="R24" ref-type="bibr">24</xref></sup>. In most cases, however, human intervention remains required, and cryo–EM data pre-processing is generally still carried out subsequent to data collection.</p>
    <p id="P5">Here we present <italic>Warp</italic>, a new software that takes over all pre-processing steps for 2D and tomographic cryo–EM data. <italic>Warp</italic> offers improved, real-time algorithms and a fully visual, intuitive interface that assists the user with immediate feedback and an augmenting presentation during data collection and pre-processing. The new algorithms can handle both standard data collection strategies and advanced scenarios such as tilted 2D data collection<sup><xref rid="R25" ref-type="bibr">25</xref></sup> or dose-symmetric tilt series<sup><xref rid="R26" ref-type="bibr">26</xref></sup>, in a transparent, unsupervised manner. Coupled with automated acquisition software<sup><xref rid="R2" ref-type="bibr">2</xref>, <xref rid="R8" ref-type="bibr">8</xref></sup>, Warp provides a continuous low-latency stream of reliably picked and corrected particle images that can be seamlessly fed into 2D classification, <italic>ab initio</italic> reconstruction, and 3D refinement using other packages<sup><xref rid="R24" ref-type="bibr">24</xref></sup>. <italic>Warp</italic> offers an accurate impression of the data quality during data collection, monitors the microscope behavior, and enables advanced data analysis during data acquisition. In favorable cases, this can result in high-resolution cryo-EM structure solution during ongoing data collection.</p>
  </sec>
  <sec sec-type="results" id="S2">
    <title>Results</title>
    <sec id="S3">
      <title>Rationale of <italic>Warp</italic></title>
      <p id="P6">We aim to enable microscope users to evaluate, correct, and process cryo-EM raw data immediately during data acquisition. The rationale was to provide a unified, streaming interface between the data acquisition software that produces the raw data, and existing software solutions for 2D classification and 3D refinement of cryo-EM single-particle data, such as RELION<sup><xref rid="R23" ref-type="bibr">23</xref></sup> or cryoSPARC<sup><xref rid="R24" ref-type="bibr">24</xref></sup>. We called the resulting software package ‘<italic>Warp</italic>’ in reference to its fast correction of object distortions that occur in cryo-EM, and its GPU-based implementation that results in quick output. <italic>Warp</italic> is meant to be used for the pre-processing of both 2D and tilt series cryo-EM data. <italic>Warp</italic> can be installed on standard platforms and operated by non-expert users via a streamlined user interface (UI) that has been developed in parallel to the underlying algorithms to augment their operation. <italic>Warp</italic> was designed to be widely applicable for biological data acquisition at any cryo-EM facility and substantially speeds up the process of cryo-EM structure determination with improved results.</p>
    </sec>
    <sec id="S4">
      <title>Overall design</title>
      <p id="P7">A schematic of the computational steps carried out by Warp is provided in <xref ref-type="fig" rid="F1">Fig. 1</xref>. For simplicity, we first describe the workflow for 2D data, before we describe the application to tomographic tilt series at the end of the results section. At the beginning of the pipeline, <italic>Warp</italic> reads any new data saved by the acquisition software. <italic>Warp</italic> then estimates and corrects the object motion across the micrograph movie both globally and locally. Next, <italic>Warp</italic> fits a spatially resolved CTF model, enabling the assignment of local defocus values to any particles extracted from the micrograph later. <italic>Warp</italic> then uses a neural network-based approach to automatically pick particles from the data with very high accuracy. Finally, <italic>Warp</italic> exports the resulting dose-weighted particle images to a downstream structure determination program such as RELION<sup><xref rid="R23" ref-type="bibr">23</xref></sup> or cryoSPARC<sup><xref rid="R24" ref-type="bibr">24</xref></sup>, which carry out 2D and 3D classification, map refinement and reconstruction. During pre-processing, <italic>Warp</italic> provides a comprehensive overview of important data parameters, allowing the operator to tune acquisition settings to achieve optimal results faster. In the following we describe the most important components in more detail.</p>
    </sec>
    <sec id="S5">
      <title>User interface</title>
      <p id="P8"><italic>Warp</italic>’s UI is designed to help the user to comprehend and interact with the thousands of micrographs generated routinely during cryo-EM data collection (<xref ref-type="supplementary-material" rid="SD2">Fig. S1</xref>). The ‘Overview’ tab displays various properties, such as defocus, estimated resolution, amount of motion, or particle count, for all processed items as interactive plots. The user can immediately grasp the statistics, observe intrinsic patterns, and make an informed decision to adjust the acquisition strategy, e.g. to tune the lens astigmatism, increase the stage settling time, or skip a bad grid square. A range can be specified for every plotted parameter to automatically exclude lower-quality images from downstream processing. Any item can be quickly inspected in more detail in a tab called ‘Fourier &amp; Real Space’. Here, a display of the power spectrum and the CTF fit allows optimization of CTF fitting parameters. In the real-space view, a deconvolution filter and neural net-based denoising (<xref ref-type="sec" rid="S19">Methods</xref>, <xref ref-type="supplementary-material" rid="SD2">Fig. S2</xref>) can be instantly applied to micrographs to improve the contrast and make the particles more visible to the human eye. The defocus variation obtained through local CTF estimation can be overlaid semi-transparently. Particle picking results can be assessed, and edited manually. Dedicated dialogs assist the user with tasks like micrograph list export, particle extraction, template matching, tomogram reconstruction, and neural network training.</p>
    </sec>
    <sec id="S6">
      <title>Motion correction</title>
      <p id="P9">The motion, i.e. the translational shift observed between frames, is due to two effects: movement of the mechanical sample stage, and BIM. Stage movement causes global shifts over the entire field of view, whereas BIM leads to shifts between adjacent micrograph patches<sup><xref rid="R6" ref-type="bibr">6</xref>, <xref rid="R27" ref-type="bibr">27</xref></sup>. While stage drift can lead to rapid shift changes between frames, BIM occurs more slowly after rapid relaxation during initial exposure<sup><xref rid="R3" ref-type="bibr">3</xref></sup>. <italic>Warp</italic> corrects for both global drift and local BIM at variable temporal resolution (<xref ref-type="supplementary-material" rid="SD2">Fig. S3</xref>). The strategy is similar to the one used by MotionCor2<sup><xref rid="R9" ref-type="bibr">9</xref></sup>, except that <italic>Warp</italic> does not apply additional <italic>a priori</italic> assumptions about BIM beyond those imposed by the parameter grid resolution (<xref ref-type="sec" rid="S19">Methods</xref>). As a result, <italic>Warp</italic> corrects efficiently and thoroughly for the two types of motion that occur during cryo-EM data acquisition in any kind of sample morphology and orientation.</p>
    </sec>
    <sec id="S7">
      <title>Estimation of local defocus and resolution</title>
      <p id="P10">The CTF model can be estimated based on the power spectrum (PS) of a micrograph. However, the defocus varies over the micrograph area due to stage inclination, uneven sample surface, or an uneven particle distribution along the optical axis<sup><xref rid="R28" ref-type="bibr">28</xref></sup>. <italic>Warp</italic> provides a flexible way to model local defocus in spatial and temporal dimensions without the need for <italic>a priori</italic> knowledge of particle positions. Instead of one global estimate, a tilted plane or more complex geometry is fitted to the PS of a movie patch to estimate local defocus. A 1D average of all local power spectra rescaled to a common defocus value allows the user to easily assess whether fitting the more complex geometry recovered more Thon rings beyond the spatial frequencies used for the fitting (<xref ref-type="supplementary-material" rid="SD2">Fig. S4</xref>). Thus, <italic>Warp</italic> goes beyond state-of-the-art CTF estimation by providing a spatially resolved model without the need for <italic>a priori</italic> knowledge of particle positions and hyper-parameter tuning. The spatially resolved CTF model can converge on the correct solution for tilts as high as 60°. This makes <italic>Warp</italic> a useful tool for tilted 2D data collection, which has been shown to improve resolution isotropy for samples with preferred orientation<sup><xref rid="R25" ref-type="bibr">25</xref></sup>.</p>
    </sec>
    <sec id="S8">
      <title>Particle picking with BoxNet</title>
      <p id="P11">The next step in cryo-EM structure determination is the accurate selection of particles from the corrected micrographs. <italic>Warp</italic> includes a novel particle picking routine based on a machine learning algorithm (<xref ref-type="sec" rid="S19">Methods</xref>). For several years, the computer vision community has been using convolutional neural nets (ConvNets) to vastly outperform template matching in object recognition tasks<sup><xref rid="R29" ref-type="bibr">29</xref>, <xref rid="R30" ref-type="bibr">30</xref></sup>. First attempts to apply ConvNets to the particle picking problem in cryo-EM have shown performance on par with traditional template matching approaches<sup><xref rid="R19" ref-type="bibr">19</xref></sup>. Today, deep residual network (ResNet) architectures enable the training of arbitrarily deep models<sup><xref rid="R31" ref-type="bibr">31</xref></sup>. <italic>Warp</italic> employs ‘BoxNet’ – a fully convolutional ResNet architecture with 72 layers, implemented in TensorFlow<sup><xref rid="R32" ref-type="bibr">32</xref></sup>. BoxNet was trained with real data curated manually from the EMPIAR repository<sup><xref rid="R33" ref-type="bibr">33</xref></sup> and synthetic data simulated from PDB<sup><xref rid="R34" ref-type="bibr">34</xref></sup> structures with a molecular weight range of 0.064–18 MDa. Because of these efforts, the pre-trained neural network bundled with <italic>Warp</italic> performs well on many particle species and is able to accurately mask out high-contrast artifacts, such as ethane. The performance of BoxNet compares favorably with available tools when representative cryo-EM data are used as input (<xref ref-type="fig" rid="F2">Fig. 2</xref>). For heterogeneous data sets, BoxNet’s generic model can provide an advantage compared to the generic model in crYOLO<sup><xref rid="R35" ref-type="bibr">35</xref></sup> or the Laplacian of Gaussian approach in RELION 3.0<sup><xref rid="R36" ref-type="bibr">36</xref></sup> (<xref ref-type="supplementary-material" rid="SD2">Fig. S5</xref>).</p>
    </sec>
    <sec id="S9">
      <title>Retraining of BoxNet</title>
      <p id="P12">Since BoxNet’s performance can vary between different samples, <italic>Warp</italic> offers a retraining interface for it. Such retraining leads to a very high accuracy in automated particle picking. For retraining, the user must provide positive examples of particle positions. Using ~1000 examples, retraining of BoxNet typically takes less than 10 minutes. After retraining, the user can pick the same micrographs with the re-trained network and select more examples for another round of retraining if required. To decrease the need for retraining in the future, <italic>Warp</italic> also provides the option of submitting training data to a central repository. <italic>De novo</italic> training will be carried out by us periodically with all deposited data, and the resulting updated pre-trained BoxNet offered to the community. The training set is centrally curated and a list of particle species in the current version is available from <ext-link ext-link-type="uri" xlink:href="https://github.com/cramerlab/boxnet">https://github.com/cramerlab/boxnet</ext-link>. The BoxNet version name will be stored in each micrograph’s metadata to ensure reproducibility of picking results obtained with older versions.</p>
    </sec>
    <sec id="S10">
      <title>Online pre-processing during data collection</title>
      <p id="P13"><italic>Warp</italic> is optimized for processing raw cryo-EM data immediately during data collection. Files written out by the image acquisition software are detected automatically in the specified input folder and added to the list of ‘processable items’ in <italic>Warp</italic>. Each item maintains its metadata in an XML file that includes the exact previous processing settings. <italic>Warp</italic> continuously performs the processing steps necessary to bring each item into accord with the currently specified settings. All results can be immediately inspected during processing. Items can be forcibly included (i. e. exempted from the quality filters) or excluded from downstream processing. Processing must be stopped to change the settings or to retrain the BoxNet model. If changes were made, <italic>Warp</italic> will first reprocess all outdated items. During online processing, <italic>Warp</italic> executes all processing steps for a micrograph within less than 30 seconds after the data become available. In our experience, high-quality data of complexes of RNA polymerase II enable the user to obtain detailed 2D classes of particles and 3D reconstructions at better than 5 Å resolution using <italic>Warp</italic> and cryoSPARC within only a few hours after the start of data collection.</p>
    </sec>
    <sec id="S11">
      <title>Interoperability with other software</title>
      <p id="P14">To ensure interoperability with a plethora of cryo-EM tools, <italic>Warp</italic> allows the user to import and export data at several steps in its workflow using widely accepted formats and standards. Raw movie data in the MRC, TIFF and EM formats are supported, and a ‘headerless’ option allows the user to manually specify properties of an unknown binary format. Image data are exported in the widely used MRC format, whereas all metadata are saved in the STAR format, adhering to the conventions established by RELION and adopted by many other tools. Any pre-processing step can be turned off if required. Results obtained with other tools can be imported to skip or benefit from particular algorithms in <italic>Warp</italic>. For instance, particle positions can be imported to export aligned particle averages, update their CTF models with <italic>Warp</italic>’s local estimates, to obtain a comprehensive overview of the particle distribution in a large project, or to retrain a BoxNet model. Frame alignment data can be exported to initiate a more accurate, reference-based alignment in RELION 3.0. Micrograph and particle lists adhering to user-selected quality criteria can be quickly prepared and exported. Taken together, <italic>Warp</italic> is highly flexible and allows for easy interoperation with other tools used by the community.</p>
    </sec>
    <sec id="S12">
      <title>Pre-processing tomographic data</title>
      <p id="P15"><italic>Warp</italic> can also be used to pre-process data from cryo-electron tomographic (cryo-ET) tilt series. <italic>Warp</italic> can reconstruct tomograms from a tilt series and perform template matching in tomograms with available 3D structures. The (sub)-tomogram reconstruction considers the local CTF, sample distortion and magnification anisotropy. Additionally, a deconvolved version of the tomograms can be produced using the same interface to help with their visual evaluation. To ensure the CTF model is accurate, <italic>Warp</italic>’s CTF fitting procedure goes beyond fitting the tilt images individually. Instead, local patch 2D power spectra from all tilts are fitted simultaneously, with constraints imposed on the inter-tilt angles, and regularizing assumptions made for the progression of phase shift and astigmatism. The tilt series CTF fitting can also be performed as part of the online processing.</p>
    </sec>
    <sec id="S13">
      <title>Template matching</title>
      <p id="P16">In addition to picking particles of a new species of unknown shape with a system like BoxNet, finding a previously known structure in new data is central to many stages of cryo-EM data processing. The structure must be compared at many different orientations to every position in the new data while considering the CTF. <italic>Warp</italic> implements template matching only for 3D templates, because <italic>de novo</italic> 2D particle picking is better handled by a neural network such as BoxNet. A template volume can be provided by the user or automatically downloaded from the EMDB<sup><xref rid="R37" ref-type="bibr">37</xref></sup> through the same UI. For template matching, 2D micrographs are subdivided into tiles, and normalized cross-correlation is computed between the tiles and 2D projections generated from the 3D template at the specified angular intervals, convolved with the local 2D CTF (<xref ref-type="sec" rid="S19">Methods</xref>). All local correlation peaks with a minimum inter-peak distance corresponding to the template particle diameter, and the corresponding best-scoring template orientations are saved so that the user can later instantly explore different peak thresholds without repeating the costly correlation step. This procedure is also implemented for tomographic volumes, where the local patches are replaced by local sub-volumes, and the local 3D CTF is considered to incorporate knowledge of defocus and the missing wedge. In both cases, the matching should be performed at a resolution significantly lower than the expected map resolution to avoid template bias<sup><xref rid="R38" ref-type="bibr">38</xref></sup>. In case the map resolution does not surpass the resolution used for template matching, the procedure should be rerun at a lower resolution, and the results reprocessed.</p>
    </sec>
    <sec id="S14">
      <title>Software implementation</title>
      <p id="P17"><italic>Warp</italic> is written in the programming languages C#, C++ and CUDA C. The expressiveness of C# and the availability of powerful development tools kept the high-level data management layer brief and maintainable. <italic>Warp</italic>’s rich UI is enabled by the Windows Presentation Foundation (WPF) framework. All performance-critical parts are implemented to run on a GPU. Central data primitives, such as 2D movies and tilt series, and all associated algorithms are wrapped in a stand-alone C# library called ‘WarpLib’. The granularity of most of these methods is fine enough to make them useful for applications beyond those implemented in <italic>Warp</italic>. Thus, WarpLib has the potential to speed up the development of future GPU-enabled tools that provide new functionality around the same data. We intend to keep developing <italic>Warp</italic> to enable state-of-the-art, rapid cryo-EM data pre-processing in the future. Updates will be shared with the community via GitHub.</p>
    </sec>
    <sec id="S15">
      <title>Benchmarking for 2D data</title>
      <p id="P18">To test the performance of <italic>Warp</italic>, we reprocessed a published single-particle cryo-EM data set for the influenza hemagglutinin trimer<sup><xref rid="R25" ref-type="bibr">25</xref></sup> (<xref ref-type="sec" rid="S19">Methods</xref>) (<xref ref-type="fig" rid="F3">Fig. 3</xref>). We chose this case for benchmarking because the processing of a 150 kDa protein imaged at 40° tilt required a significant amount of manual screening in the original analysis<sup><xref rid="R25" ref-type="bibr">25</xref></sup>, providing a challenging test case for the <italic>Warp</italic> pipeline. With the original set of 130,000 particles, cryoSPARC reached a similar resolution as that reported in the original analysis (<xref ref-type="fig" rid="F3">Fig. 3a, b</xref>), showing that refinement in cryoSPARC and RELION yields equivalent results for this data set. However, because this particle set and the general particle population both exhibit significant heterogeneity, we draw the comparison between results obtained after subjecting all data to the same 3D classification steps in cryoSPARC (<xref ref-type="sec" rid="S19">Methods</xref>). For the original set, the best class containing 57,346 particles reached a global resolution of 3.9 Å with a B-factor of -200 Å<sup>2</sup>. The same particles, updated with the defocus information from <italic>Warp</italic>, reached a notably higher resolution of 3.5 Å with a B-factor of -170 Å<sup>2</sup>. This suggests that <italic>Warp</italic>’s local CTF model is more accurate than the per-particle CTF fitting in gCTF<sup><xref rid="R14" ref-type="bibr">14</xref></sup> used in the original study. <italic>Warp</italic> processing also estimated a narrower range of astigmatism amplitudes (<xref ref-type="fig" rid="F3">Fig. 3c</xref>), in agreement with the assumption of a stable optical system. For the full, completely automated <italic>Warp</italic> pre-processing pipeline, the best class containing 249,495 particles reached a global resolution of 3.2 Å with a B-factor of -170 Å<sup>2</sup>, accompanied by a significantly increased level of detail in the map (<xref ref-type="fig" rid="F3">Fig. 3a</xref>). This improvement from 3.5 Å to 3.2 Å is due to the higher particle count, which was obtained by <italic>Warp</italic> in a fully automated fashion at no time cost to the user. After classification in cryoSPARC, the best classes contained 45% and 51% of all particles in the original EMPIAR-10097 set and <italic>Warp</italic>’s automatically picked set, respectively, suggesting a similar degree of particle ‘purity’ in the manual and automated approaches. Furthermore, this demonstrates that tilted data collection can lead to near-atomic resolution with minimal efforts at the data pre-processing step.</p>
      <p id="P19">The pre-processing of 668 movies from EMPIAR-10097 in <italic>Warp</italic> required ca. 3 h using a system with 4 Nvidia Titan X GPUs, thus averaging to ca. 220 movies per hour. <italic>Warp</italic> v1.0.7, released during the revision of this manuscript, increased the speed to ca. 1400 movies (dimensions: 3710x3838x40) per hour on the same hardware. This speed allows <italic>Warp</italic> to keep up with any of the current automated acquisition schemes, which collect ca. 120 movies per hour on a Titan Krios microscope (Thermo Scientific, USA), and can reach up to 300 movies per hour in the most favorable cases. Taken together, our results establish <italic>Warp</italic> as a very useful tool for high-performance, automated cryo-EM data pre-processing.</p>
    </sec>
    <sec id="S16">
      <title>Complementarity of <italic>Warp</italic> with other tools</title>
      <p id="P20">We further tested <italic>Warp</italic>’s performance on a data set of β-galactosidase particles<sup><xref rid="R39" ref-type="bibr">39</xref></sup> that is often used for benchmarking purposes (<xref ref-type="fig" rid="F4">Fig. 4</xref>). Because of the sample’s high structural stability, these data stress the software’s ability to obtain particularly accurate CTF and motion estimates to reach the highest end of cryo-EM resolution. Furthermore, the particles are difficult to pick due to the low defocus and prevalence of high-contrast objects in the micrographs. To estimate the frame alignment accuracy independently of 3D refinement, we calculated the average CTF fit quality for aligned movie averages processed with MotionCor2<sup><xref rid="R9" ref-type="bibr">9</xref></sup> or <italic>Warp</italic>. <italic>Warp</italic>’s averages could be fitted to 2.6 Å, and those of MotionCor2 to 2.7 Å (<xref ref-type="fig" rid="F4">Fig. 4c</xref>), indicating slightly better frame alignment in <italic>Warp</italic>. After refinement of particles from the full, completely automated <italic>Warp</italic> pre-processing pipeline, the best class containing 127,000 particles reached a global resolution of 2.09 Å with a B-factor of -35 Å<sup>2</sup>.</p>
      <p id="P21">To test the advantage of using reference-based refinements implemented in RELION 3.0<sup><xref rid="R36" ref-type="bibr">36</xref></sup>, the same particle set was first subjected to beam tilt refinement and reached a resolution of 1.95 Å with a B-factor of -29 Å<sup>2</sup>. Adding per-particle defocus refinement did not improve the resolution further. Adding reference-based frame alignment, referred to as ‘polishing’ in RELION, improved the resolution further to 1.86 Å with a B-factor of -26 Å<sup>2</sup>. This slightly surpasses the result reported<sup><xref rid="R36" ref-type="bibr">36</xref></sup> for the same set of refinements in RELION 3.0 by 0.04 Å, possibly through cleaner initial particle picking. Whereas the additional refinements improved the resolution beyond that achieved with the pure <italic>Warp</italic> pre-processing pipeline, we note that these procedures required the data to be fully classified and refined first. In contrast, <italic>Warp</italic> provided its accurate initial results before any downstream processing took place. This was evident for the hemagglutinin trimer data, where Warp obtained the local defocus values immediately, whereas several rounds of refinement were required by RELION 3.0<sup><xref rid="R36" ref-type="bibr">36</xref></sup>. Thus, the pre-processing in <italic>Warp</italic> and reference-based refinements in RELION 3.0 are complementary approaches, whose combination leads to faster convergence and higher resolution.</p>
    </sec>
    <sec id="S17">
      <title>Benchmarking for tilt series data</title>
      <p id="P22">To assess the benefits of using the full local 3D CTF for template matching in tomograms compared to a binary missing wedge mask, we matched 7 tomograms from a publicly available 80S ribosome data set<sup><xref rid="R40" ref-type="bibr">40</xref></sup>. Among the 3,288 top-scoring matches, the false positive rate was 1% when using the full local 3D CTF, and 15% when using the binary missing wedge mask. At 15.9 standard deviations, the CTF-aware correlation peaks rose 2.7 times higher above the respective background distribution than the 5.8 standard deviations of the CTF-unaware peaks (<xref ref-type="fig" rid="F5">Fig. 5</xref>), thus allowing more accurate matching.</p>
      <p id="P23">To benchmark the proposed CTF estimation routine and sub-tomogram export for tilt series, we pre-processed, exported and refined particles from two publicly available data sets. For EMPIAR-10045 and EMPIAR-10164 (subset of 5 tomograms used in the assessment of NovaCTF<sup><xref rid="R41" ref-type="bibr">41</xref></sup>), we obtained a resolution of 11.6 Å with 3,200 particles (<xref ref-type="fig" rid="F6">Fig. 6a, b</xref>), and 3.8 Å with 22,000 particles (<xref ref-type="fig" rid="F6">Fig. 6c, d</xref>), respectively. These results slightly surpass the resolution figures of 12.8 Å and 3.9 Å reported in the original studies.</p>
    </sec>
  </sec>
  <sec sec-type="discussion" id="S18">
    <title>Discussion</title>
    <p id="P24">Here we present <italic>Warp</italic>, a novel software tool for real-time evaluation and pre-processing of cryo-EM data during data collection. <italic>Warp</italic> bridges between the microscope and available software for 2D classification and 3D reconstruction, taking care of all pre-processing steps in an automated fashion. <italic>Warp</italic> also helps the microscopist to monitor data quality during acquisition, thus allowing to optimize the acquisition strategy during ongoing data collection. This contributes to making the best use of microscope time and prevents disappointing results during traditional data processing long after the data collection is concluded. <italic>Warp</italic> includes the deep learning-based models to perform reliable, automated particle picking and image denoising. Benchmarking studies establish <italic>Warp</italic> as a very reliable tool that matches or surpasses available software in performance. <italic>Warp</italic> is easy to install, has an intuitive user interface, and will be maintained and improved over the next years.</p>
    <p id="P25">To further improve cryo–EM data collection efficiency in the future, we envision an automated feedback loop between the acquisition software and <italic>Warp</italic>. Such feedback would help to maximize the number of high-quality images collected by quickly skipping areas with low estimated resolution or particle count, adjusting the stage settling time dynamically based on <italic>Warp</italic>’s motion estimate for the previous image, and performing the time-consuming focus estimation procedure less frequently, using defocus values from <italic>Warp</italic>’s precise CTF fits instead. Additional feedback from <italic>Warp</italic> users will also contribute to further development of the software, and updates will be shared with the community as they become available.</p>
  </sec>
  <sec sec-type="methods" specific-use="web-only" id="S19">
    <title>Online Methods</title>
    <sec id="S20">
      <title>Spline interpolation on multi-dimensional grids</title>
      <p id="P26">Many methods in Warp are based on a continuous parametrization of 1—3-dimensional spaces. This parameterization is achieved by spline interpolation between points on a coarse, uniform grid, which is computationally efficient. A grid extends over the entirety of each dimension that needs to be modeled. The grid resolution is defined by the number of control points in each dimension and is scaled according to physical constraints (e. g. number of frames or pixels) and available signal. The latter provides regularization to prevent overfitting of sparse data with too many parameters. When a parameter described by the grid is retrieved for a point in space (and time), e. g. for a particle (frame), B-spline interpolation is performed at that point on the grid. To fit a grid’s parameters, in general, a cost function associated with the interpolants at specific positions on the grid is optimized. In the following, we distinguish between 2—3 spatial grid dimensions (X and Y axes in micrographs; X, Y and Z in tomographic volumes), and a temporal dimension as a function of the accumulated electron dose. We note that B-splines are only used to interpolate parameters, not image data. For the latter higher-order schemes are used.</p>
    </sec>
    <sec id="S21">
      <title>Motion model</title>
      <p id="P27">Two sources contribute to the observed translational shift between frames in a dose-fractionated image sequence. First, mechanical stage instability leads to rapid shift changes that are uniform within the entire frame. Second, beam-induced motion (BIM) causes slowly changing, local motion. Warp considers the physical properties of both sources in its motion model, using two sets of grids to parametrize the frame shifts and sample deformation. Global motion is described by two grids, X<sub>global</sub> and Y<sub>global</sub>, with high temporal, and no spatial resolution. The temporal resolution can match the number of frames, or, in case finer dose fractionation is performed to reduce intra-frame motion, the resolution can be lower to regularize a potentially overfitted model. BIM is described by two grids, X<sub>local</sub> and Y<sub>local</sub>, with a temporal resolution of at most 3, and a spatial resolution of typically 4—5 in both dimensions. The overall shifts required to bring the same object in all frames into a common reference frame are then defined as (X<sub>global</sub> + X<sub>local</sub>, Y<sub>global</sub> + Y<sub>local</sub>).</p>
    </sec>
    <sec id="S22">
      <title>Global and local motion correction</title>
      <p id="P28">In the absence of known particle positions and high-resolution reference projections, individual frame patches are aligned to their averages. The movie is subdivided into groups of 512<sup>2</sup> px patches with a 50 % spatial overlap, masked with a raised cosine. To simplify computation, the images are transformed into Fourier space where complex multiplication replaces translation. For each group, the patches are shifted according to the interpolants at their extraction positions using the current grid values. The average of a group’s shifted patches is then compared to the individual patches to calculate the patch costs as <disp-formula id="FD1"><mml:math display="block" id="M1" overflow="scroll"><mml:mrow><mml:mi>C</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mo>Σ</mml:mo><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mo>Σ</mml:mo><mml:mi>f</mml:mi></mml:msub><mml:msup><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mi>I</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>f</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mover accent="true"><mml:mrow><mml:msub><mml:mi>I</mml:mi><mml:mi>f</mml:mi></mml:msub></mml:mrow><mml:mo stretchy="true">¯</mml:mo></mml:mover></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where <italic>i</italic> denotes the frame index, <italic>f</italic> denotes the spatial frequency, <italic>I</italic> is the Fourier transform of a shifted patch frame, and <italic>Ī</italic> is the average of all shifted patch frames. The shifts are obtained by interpolating on the current state of the parameter grids at the patch frame’s position in space and time. The derivative is approximated numerically with the symmetric difference quotient. The overall cost for all grid control points is the sum of all patch costs, and the derivative for each grid control point is the weighted sum of the derivatives of all patches affected by it. The weights for each control point’s derivative can be precomputed by applying a one-pixel shift to the control point and storing all resulting non-zero patch shifts. The cost and derivatives are used by the Limited-memory Broyden-Fletcher-Goldfarb-Shanno (L-BFGS) algorithm<sup><xref rid="R42" ref-type="bibr">42</xref></sup> to optimize the values of all control points. The optimization is performed in several steps to improve global convergence. In the first step, the temporal resolution of X<sub>global</sub> and Y<sub>global</sub> is set to 3, and increased to the next power of 3 in subsequent steps until the desired temporal resolution is reached.</p>
      <p id="P29">Further details of this motion fitting algorithm are available as pseudo-code in <bold>Supplementary Note 1</bold>.</p>
    </sec>
    <sec id="S23">
      <title>Contrast transfer function estimation in micrographs</title>
      <p id="P30">The CTF analytically describes the convolution applied to the images by the electron-optical system. Estimating its properties with high precision is essential for reversing the effects and obtaining high-resolution reconstructions<sup><xref rid="R43" ref-type="bibr">43</xref></sup>. Whereas the methodology for measuring defocus and astigmatism from a micrograph’s power spectrum (PS) has been well-established<sup><xref rid="R12" ref-type="bibr">12</xref>, <xref rid="R44" ref-type="bibr">44</xref></sup>, the recent increase in EM map resolution calls for a more localized approach. Local defocus variation of a seemingly flat sample can exceed 60 nm within a single micrograph, resulting in an out-of-phase CTF for some particles at resolutions beyond 3 Å. Attempts to address this issue by fitting the defocus per-particle have been made<sup><xref rid="R14" ref-type="bibr">14</xref></sup>, but they require knowledge of particle positions, and lack robustness for all but the largest particle species. Even with a local smoothing approach, per-particle defocus requires high particle density to not lose accuracy compared to a global estimate. On the other hand, strong local irregularities in the specimen surface are almost never observed in tomographic volumes in vitro<sup><xref rid="R28" ref-type="bibr">28</xref></sup>, suggesting per-particle precision might be unnecessary.</p>
    </sec>
    <sec id="S24">
      <title>Estimation of local defocus</title>
      <p id="P31">To parametrize the defocus, a single grid typically consists of 5x5 spatial control points. Optionally, another single grid with exclusively temporal resolution tracks the development of the phase shift generated by a Volta Phase Plate<sup><xref rid="R45" ref-type="bibr">45</xref></sup>. Global parameters, such as astigmatism magnitude and angle, are optimized as additional scalars in the model. In practice, the effect of using a more complex geometry or temporal resolution appears negligible. However, the increased signal of future camera hardware might make these options relevant. Like in the frame alignment procedure, groups of patches matching the desired PS size (e. g. 512<sup>2</sup>—1024<sup>2</sup> px) are extracted with a spatial overlap of 50% from the raw movie data, transformed into Fourier space, and converted to PS by taking their squared amplitudes. If no temporal resolution is desired, each group will be averaged to a single PS to save resources. Similarly, in the absence of spatial resolution, the same frame from all groups will be averaged.</p>
      <p id="P32">For the initial, exhaustive search, a 1D rotationally averaged PS is calculated from all patches. A B-spline with 3 control points is then fitted through it and subtracted to remove most of the background. The user-defined range of defocus and, optionally, phase shift values is evaluated by matching a simulated 1D CTF. The result with the highest normalized correlation is then used to estimate the 1D PS background and envelope more accurately to consider both in subsequent 2D CTF fitting. The cost function to be minimized is calculated between a 2D PS, and the 2D CTF simulated based on the local defocus at the patch extraction position: <disp-formula id="FD2"><mml:math display="block" id="M2" overflow="scroll"><mml:mrow><mml:mi>C</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mo>Σ</mml:mo><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mo>Σ</mml:mo><mml:mi>f</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:mi>C</mml:mi><mml:mi>T</mml:mi><mml:msub><mml:mi>F</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>f</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mo>⋅</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mi>f</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>N</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mi>m</mml:mi></mml:mrow></mml:msub><mml:mo>⋅</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mi>I</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>f</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:msub><mml:mi>B</mml:mi><mml:mi>f</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>N</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mi>m</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where <italic>i</italic> denotes the frame index (in case a temporal dimension is used), <italic>f</italic> denotes the spatial frequency within the range used for fitting, <italic>CTF</italic> is the 2D contrast transfer function, <italic>I</italic> is the FT of a patch frame, <italic>E</italic> is the envelope of the 1D PS, <italic>B</italic> is the background of the 1D PS, and (…)<sub><italic>Norm</italic></sub> is a normalization operator that brings the value distribution to mean = 0, standard deviation = 1. The defocus and, optionally, phase shift is obtained by interpolating on the current state of the respective parameter grid at the patch frame’s position in space and time. The derivative is approximated numerically with the symmetric difference quotient. The same pre-computed weights strategy as in the frame alignment procedure is employed for the control point derivatives. An L-BFGS algorithm finally optimizes the model for all control point values.</p>
      <p id="P33">The PS of a tilted plane will usually only show low-resolution Thon rings, regardless of what model was used for the defocus gradient. To provide the user with feedback on whether the more complex defocus model is beneficial, the 2D spectra from all patches, whose parameters are herein referred to as the “source” PS, are rescaled and rotationally averaged to a 1D PS with a single defocus value, referred to as the “target” PS, such that the CTF phases match using the following scaling function: <disp-formula id="FD3"><mml:math display="block" id="M3" overflow="scroll"><mml:mrow><mml:msubsup><mml:mi>x</mml:mi><mml:mi>φ</mml:mi><mml:mo>′</mml:mo></mml:msubsup><mml:mo>=</mml:mo><mml:msqrt><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:mfrac><mml:mrow><mml:mo>−</mml:mo><mml:msqrt><mml:mrow><mml:msubsup><mml:mi>p</mml:mi><mml:mi>φ</mml:mi><mml:mrow><mml:mo>′</mml:mo><mml:mn>4</mml:mn></mml:mrow></mml:msubsup><mml:mo>⋅</mml:mo><mml:msubsup><mml:mi>p</mml:mi><mml:mi>φ</mml:mi><mml:mn>4</mml:mn></mml:msubsup><mml:mo>⋅</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msubsup><mml:mi>C</mml:mi><mml:mi>S</mml:mi><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup><mml:mo>⋅</mml:mo><mml:msup><mml:mi>λ</mml:mi><mml:mrow><mml:mn>4</mml:mn></mml:mrow></mml:msup><mml:mo>⋅</mml:mo><mml:msup><mml:mrow><mml:msub><mml:mstyle displaystyle="true"><mml:mi>f</mml:mi></mml:mstyle><mml:mi>N</mml:mi></mml:msub></mml:mrow><mml:mn>4</mml:mn></mml:msup><mml:mo>⋅</mml:mo><mml:msubsup><mml:mi>x</mml:mi><mml:mi>φ</mml:mi><mml:mn>4</mml:mn></mml:msubsup><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mi>C</mml:mi><mml:mi>S</mml:mi></mml:msub><mml:mo>⋅</mml:mo><mml:msup><mml:mi>λ</mml:mi><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>⋅</mml:mo><mml:msup><mml:mrow><mml:msub><mml:mstyle displaystyle="true"><mml:mi>f</mml:mi></mml:mstyle><mml:mi>N</mml:mi></mml:msub></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>⋅</mml:mo><mml:msubsup><mml:mi>p</mml:mi><mml:mi>φ</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>⋅</mml:mo><mml:msubsup><mml:mi>x</mml:mi><mml:mi>φ</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>⋅</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mi>φ</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msubsup><mml:mi>p</mml:mi><mml:mi>φ</mml:mi><mml:mn>4</mml:mn></mml:msubsup><mml:mo>⋅</mml:mo><mml:msubsup><mml:mi>z</mml:mi><mml:mi>φ</mml:mi><mml:mrow><mml:mo>′</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:msubsup><mml:mi>p</mml:mi><mml:mi>φ</mml:mi><mml:mrow><mml:mo>′</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:msubsup><mml:mo>⋅</mml:mo><mml:msubsup><mml:mi>p</mml:mi><mml:mi>φ</mml:mi><mml:mn>4</mml:mn></mml:msubsup><mml:mo>⋅</mml:mo><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msubsup><mml:mi>z</mml:mi><mml:mi>φ</mml:mi><mml:mo>′</mml:mo></mml:msubsup></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow></mml:msqrt></mml:mrow><mml:mrow><mml:msub><mml:mi>C</mml:mi><mml:mi>S</mml:mi></mml:msub><mml:mo>⋅</mml:mo><mml:msup><mml:mi>λ</mml:mi><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>⋅</mml:mo><mml:msup><mml:mrow><mml:msub><mml:mstyle displaystyle="true"><mml:mi>f</mml:mi></mml:mstyle><mml:mi>N</mml:mi></mml:msub></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>⋅</mml:mo><mml:msubsup><mml:mi>p</mml:mi><mml:mi>φ</mml:mi><mml:mn>4</mml:mn></mml:msubsup></mml:mrow></mml:mfrac></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow></mml:msqrt><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where ′ denotes the “target” PS coordinate system, and its absence denotes the “source” PS coordinate system; 𝜑 is the sampling angle coordinate, <italic>p</italic> is the anisotropic pixel size, <italic>C<sub>S</sub></italic> is the spherical aberration, <italic>λ</italic> is the electron wavelength, <italic>f<sub>N</sub></italic> is the spatial Nyquist frequency, <italic>z</italic> is the anisotropic defocus value, and <italic>x</italic> is the sampling radius coordinate. A similar formulation was provided before<sup><xref rid="R44" ref-type="bibr">44</xref></sup> for the special case of isotropic pixel size, and was used to reduce the comparison between CTF and PS to a 1D problem. However, <italic>Warp</italic> performs the fitting in 2D and only uses the rescaling for visualization purposes. If the complex defocus model fits the data better, the recovery of additional high-resolution Thon rings can be observed in the 1D average.</p>
      <p id="P34">Further details of this CTF fitting algorithm are available as pseudo-code in <bold>Supplementary Note 1</bold>.</p>
    </sec>
    <sec id="S25">
      <title>Resolution estimation</title>
      <p id="P35">To estimate the useful resolution range, a normalized cross-correlation value between the averaged 1D PS and the simulated 1D CTF curve is calculated within a sliding window. The window size at any given position scales to twice the width between the zero points of the closest CTF peak, but is not allowed to fall below 16 samples. The resolution limit is then reported as the frequency where the cross-correlation falls below 0.3 for the first time. Since the higher number of optimizable parameters allows for some overfitting, it is important that the useful resolution extends beyond the range used for fitting.</p>
    </sec>
    <sec id="S26">
      <title>Contrast transfer function estimation in tilt series</title>
      <p id="P36">The single micrograph CTF estimation procedure with planar sample geometry described in the previous section can be used for tilted 2D data collection. However, full tilt series pose additional challenges for CTF fitting. Mechanical stage instabilities and imperfect eucentric height setting necessitate additional exposures for tracking and focusing<sup><xref rid="R8" ref-type="bibr">8</xref></sup> to correct the stage position between individual tilt images. Thus, the defocus cannot be assumed to stay constant, or change smoothly over the course of a tilt series. Each tilt image requires its own defocus value, which can be challenging due to the small amount of signal available. Even at 120 e<sup>-</sup>/Å<sup>2</sup> for an entire series of 60 images, each tilt only has 2 e<sup>-</sup>/Å<sup>2</sup> to perform the same estimation as for a 40 e<sup>-</sup>/Å<sup>2</sup> 2D image, while striving to achieve comparable accuracy.</p>
      <p id="P37">CTF estimation in tilt series has traditionally received less attention than its equivalent in 2D data, with the most recent publication<sup><xref rid="R46" ref-type="bibr">46</xref></sup> predating the introduction of direct electron detectors and phase plates. As the resolution obtainable through sub-tomogram averaging has come close to parity with 2D data<sup><xref rid="R47" ref-type="bibr">47</xref></sup> since then, simplifying assumptions such as the neglect of astigmatism<sup><xref rid="R48" ref-type="bibr">48</xref></sup> or the assumed flatness of the sample can limit the resolution. Combined with the lack of integration of dedicated tilt series CTF estimation tools into common sub-tomogram averaging pipelines<sup><xref rid="R49" ref-type="bibr">49</xref></sup>, this has created a situation where state-of-the-art studies<sup><xref rid="R47" ref-type="bibr">47</xref>, <xref rid="R50" ref-type="bibr">50</xref></sup> employ tools designed for 2D data such as CTFFIND<sup><xref rid="R12" ref-type="bibr">12</xref></sup>.</p>
      <p id="P38">To improve the fit accuracy, the individual tilt image fits must be subjected to a common set of constraints. As the imaged sample content does not change significantly throughout the tilt series, 1D background and envelope can be derived from the average 1D spectrum of all tilt images. The relative tilt angles and the tilt axis orientation are known to a higher precision than could be derived from fitting a planar geometry <italic>de novo</italic>, and are kept constant throughout the optimization as suggested previously<sup><xref rid="R48" ref-type="bibr">48</xref></sup>. However, the absolute inclination of the sample plane is unknown. This is especially critical in some of the typical applications of tomography, like the imaging of lamellae prepared through FIB milling because a lamella can be tilted by over 20° relative to the grid. This additional inclination remains constant throughout the tilt series, and is made a single optimizable parameter for all tilt images. Astigmatism and, optionally, phase shift can be kept constant throughout 2D image exposures, but can benefit from a temporally resolved model in a tilt series where the overall exposure is fractionated over a much longer time, e. g. 20—30 min. <italic>Warp</italic> uses 3 control points in the temporal dimension to model these parameters.</p>
      <p id="P39">With these considerations, the full estimation process is as follows. 2D patches are extracted from all aligned tilt movie averages, as described in the micrograph CTF fitting procedure, and treated in parallel in all subsequent calculations. To provide a better initialization for the per-tilt defocus searches, an estimate for the average defocus of the entire series is obtained by preparing 1D spectra from all patches, and comparing them to simulated CTF curves for the defocus values at the respective positions and tilts, taking into account the fixed relative tilt information and the currently tested average defocus (and phase shift, optionally). This search is performed exhaustively over a range of values specified by the user. The result is used as the starting point of a more complex optimization. Defocus values for all individual tilts, 3 astigmatism magnitude/angle pairs, 3 optional phase shift values, and the two global inclination angles (i. e. the plane normal) are optimized using the L-BFGS algorithm with the derivatives obtained numerically as described in the micrograph CTF fitting section. Upon convergence, the 1D spectra of all patches are rescaled to a common defocus value. This is especially useful for validation in tilt series since the individual images will have very noisy spectra. If the useful resolution range does not extend sufficiently beyond the fitting range, the latter is automatically decreased and the optimization repeated.</p>
      <p id="P40">In our experience, the direction of the tilt axis is often miscalibrated. Correct handedness in structures obtained from sub-tomogram averaging does not guarantee the tilt angle sign is not flipped. In Warp, a positive rotation around the positive Y image axis is defined to result in an increased underfocus at positions to the positive X side of the tilt axis, i. e. those parts of the sample come physically closer to the electron beam source. The CTF fitting procedure in Warp can detect such mistakes by optionally repeating the optimization with the tilt angles flipped, and notifying the user if the “wrong” set of angles provides a better fit. Such a test can be used to re-calibrate the acquisition software for future data collection.</p>
    </sec>
    <sec id="S27">
      <title>Considerations for tomogram reconstruction</title>
      <p id="P41">Whereas the process of 3D map reconstruction from 2D images of single particles is well established today, full-tomogram reconstruction breaks some of the simplifying assumptions so they must be handled explicitly to obtain better results. In the 2D case, the CTF can be assumed to be the same for all parts of a single particle image, although corrections for a wider range of defocus values in images of large objects have been proposed<sup><xref rid="R51" ref-type="bibr">51</xref></sup>. In a tomographic tilt series, the highest tilt image can show a defocus spread of 1 um or more. Accounting for such variations in local defocus is necessary for reaching high resolution<sup><xref rid="R41" ref-type="bibr">41</xref></sup>. Furthermore, each region in the tomographic volume is reconstructed from images with different CTFs, and the zeros and peaks of those CTFs will not overlap in Fourier space. CTF-based weighting of individual projections is commonplace for 2D data<sup><xref rid="R23" ref-type="bibr">23</xref>, <xref rid="R52" ref-type="bibr">52</xref></sup>, but the algorithms used in tomographic reconstruction do not go beyond CTF phase flipping, giving all spectral components equal weight<sup><xref rid="R41" ref-type="bibr">41</xref>, <xref rid="R53" ref-type="bibr">53</xref></sup>. This gives spectral components with pure noise (CTF = 0) the same weight as the best available signal (|CTF| = 1) if they overlap. Performing CTF-, dose- and tilt-based weighting later in sub-tomogram averaging has been shown to be beneficial<sup><xref rid="R49" ref-type="bibr">49</xref></sup>, but it has an even more significant effect when applied at the level of initial tomogram reconstruction. Anisotropic magnification has been described in the past<sup><xref rid="R54" ref-type="bibr">54</xref></sup> and is routinely corrected in 2D data. In tomography, the real-space distortion is even more pronounced than in single particle reconstructions because the distances affected by the distortion are more than 1 μm, i. e. the extent of the entire tomogram, leading to positional errors on the order of nanometers in scenarios where the anisotropy does not coincide with the tilt axis.</p>
    </sec>
    <sec id="S28">
      <title>Tomogram reconstruction</title>
      <p id="P42">Warp takes the local defocus and sample distortion, as well as magnification anisotropy into account when reconstructing full or partial tomographic volumes. For a partial reconstruction at any position in the volume, the original 2D images are sampled at the following positions: <disp-formula id="FD4"><mml:math display="block" id="M4" overflow="scroll"><mml:mrow><mml:mtext mathvariant="bold">s</mml:mtext><mml:mo>=</mml:mo><mml:msub><mml:mtext mathvariant="bold">R</mml:mtext><mml:mrow><mml:mi>E</mml:mi><mml:mi>u</mml:mi><mml:mi>l</mml:mi><mml:mi>e</mml:mi><mml:mi>r</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:msub><mml:mi>α</mml:mi><mml:mrow><mml:mi>T</mml:mi><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>ψ</mml:mi><mml:mrow><mml:mi>T</mml:mi><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>⋅</mml:mo><mml:mtext mathvariant="bold">p</mml:mtext><mml:mo>+</mml:mo><mml:msub><mml:mtext mathvariant="bold">o</mml:mtext><mml:mrow><mml:mi>T</mml:mi><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where <bold>R</bold><sub><italic>Euler</italic></sub> is the rotation matrix for 3 Euler angles following the Xmipp convention<sup><xref rid="R55" ref-type="bibr">55</xref></sup>, <italic>α</italic> is the stage tilt angle, <italic>ψ</italic> is the in-plane angle of the tilt axis, <bold>p</bold> is the particle position within the tomographic volume, and <bold>o</bold> is the in-plane offset of the tilt axis. The coordinates are centered within the volume and images. The CTF for each 2D image is calculated using a defocus of: <disp-formula id="FD5"><mml:math display="block" id="M5" overflow="scroll"><mml:mrow><mml:mi>z</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>T</mml:mi><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:mtext mathvariant="bold">s</mml:mtext><mml:mo>∗</mml:mo><mml:msub><mml:mtext mathvariant="bold">n</mml:mtext><mml:mrow><mml:mi>T</mml:mi><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mtext mathvariant="bold">n</mml:mtext><mml:mrow><mml:mi>T</mml:mi><mml:mi>i</mml:mi><mml:mi>l</mml:mi><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>z</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where <italic>z<sub>Tilt</sub></italic> is the average defocus estimated for the tilt image, <bold>n</bold><sub><italic>Tilt</italic></sub> is the sample plane normal, <bold>n</bold><sub><italic>Tilt,z</italic></sub> is the z component of the normal, and * denotes the scalar product between two vectors. The reconstruction is performed in Fourier space using a gridding algorithm<sup><xref rid="R23" ref-type="bibr">23</xref></sup>, with the data weighted by the respective CTF, and the dose- and tilt-dependent heuristic from RELION<sup><xref rid="R49" ref-type="bibr">49</xref></sup>, but without the final deconvolution step (i. e. the weights are inserted as |CTF|, not as CTF<sup><xref rid="R2" ref-type="bibr">2</xref></sup>). To obtain a full tomogram, <italic>Warp</italic> reconstructs a uniform grid of small, cubical volumes with an overlap of 50%, and inserts the central 50% into the overall volume to account for artifacts associated with Fourier space reconstruction at the borders of the local volumes. This ensures the corrections can be applied with local precision and remain reasonably continuous between adjacent sub-volumes.</p>
    </sec>
    <sec id="S29">
      <title>Export of corrected data</title>
      <p id="P43">Whereas the <italic>Warp</italic> model for a movie or tilt series describes the non-linear deformation of the entire particle ensemble and its environment, it is unclear whether this deformation gradient stays continuous throughout a single particle, i. e. if the protein structure is subject to the same compression and shearing as the ice around it. Many recent high-resolution maps were reconstructed using particles extracted from dose-weighted averages produced by MotionCor2<sup><xref rid="R9" ref-type="bibr">9</xref></sup>. The tool assumes the deformation gradient to be continuous in all parts of the image, and will thus deform images of particles and ice in the same way. This will be beneficial if the underlying physical model is indeed continuous. However, it also distorts the CTF locally without passing any knowledge of the distortion to downstream processing tools. In case of a strong local change in the motion direction, this will result in an artifact similar to lens astigmatism.</p>
      <p id="P44"><italic>Warp</italic> assumes a continuous deformation field when exporting dose-weighted averages of whole 2D movies, i. e. each pixel will be shifted according to the grid interpolants at that exact position. This has the benefit of uniformly sharper images for visual inspection and particle picking. For particle and sub-tomogram extraction, however, the entire particle image will be shifted uniformly according to the grid interpolants at the particle’s center. This keeps the CTF true to its fitted analytical description, but makes the assumption that the protein is more rigid than the surrounding ice and thus deforms less due to BIM. For whole-tomogram reconstruction, a hybrid approach is pursued: the local volumes are produced using the same procedure as sub-tomogram extraction, but the combined volume is largely continuous depending on how small the local volumes were.</p>
      <p id="P45">Dose weighting in <italic>Warp</italic> adds a B-factor of -4 Å<sup>2</sup> per 1 e-/Å<sup>2</sup> of dose, similar to a heuristic published previously<sup><xref rid="R7" ref-type="bibr">7</xref></sup>. While a different heuristic is used in MotionCor2<sup><xref rid="R9" ref-type="bibr">9</xref></sup> and Unblur<sup><xref rid="R7" ref-type="bibr">7</xref></sup>, the accuracy of both approaches is of decreased significance as data-driven re-weighting is likely to be performed using an approach like the “particle polishing” in RELION 3.0.</p>
    </sec>
    <sec id="S30">
      <title>Particle picking with a residual neural net</title>
      <p id="P46">In the past years, the recipe for improving the performance of deep learning algorithms has been “deeper networks, more training data”. Outside of cryo-EM, deep ResNet architectures have been demonstrated to enable the training of very deep models by essentially solving the vanishing gradient problem<sup><xref rid="R31" ref-type="bibr">31</xref></sup>. At the same time, the EMPIAR raw data repository<sup><xref rid="R33" ref-type="bibr">33</xref></sup> has accumulated a diverse collection of 2D cryo-EM data sets that can be leveraged for training. <italic>Warp</italic> employs a model with 35 ResNet blocks and 2 conventional convolution layers (<xref ref-type="supplementary-material" rid="SD2">Fig. S6</xref>) to segment a micrograph into 3 classes: background, particle, and high-contrast artifact (e. g. ethane drops). The input window has a constant size of 256<sup>2</sup> px. After initial convolution with 32 5x5 kernels the data are processed by a sequence of 5 groups of each 5 ResNet blocks. At the beginning of each but the first group, the data are down-sampled by a factor of 2, while the number of channels is doubled. This enables the recognition of an increasing number of large, higher-order features. After reaching a spatial extent of 16x16 in the contractive part of the network, the data are processed by the expanding part: a sequence of 4 groups of each 2 ResNet blocks. At the beginning of each group, the data are up-sampled by a factor of 2. Each group’s output is concatenated with the output of its mirror counterpart from the contractive part in a U-Net-like fashion<sup><xref rid="R56" ref-type="bibr">56</xref></sup>. This combines the global context and higher-order features obtained in the contractive part with the higher spatial resolution of the previous layers. After reaching the original extent of 256x256 in the expanding part, the data are processed by the final 2 ResNet blocks and projected onto 3 channels by convolution with 3 1x1 kernels. A pixelwise argmax operation finally retrieves the most likely label at each location in the original image. The model graph and variables are initialized and saved using TensorFlow’s Python API, while all subsequent training and inference are performed through its C API, wrapped in C# classes.</p>
      <p id="P47">To segment a micrograph, it is down-scaled to the standard 8 Å/px resolution and divided into 256<sup>2</sup> px tiles with 64 px overlap. Each tile is extracted, normalized, and presented to the network. All tiles’ softmax and argmax outputs are combined and subjected to a user-defined threshold for the softmax value to remove uncertain picks. Connected components of pixels labeled as “particle” are extracted, and their centroids are used as particle positions. In cases where two particles overlap according to a user-defined diameter, the particle with the bigger connected component is kept. To obtain a mask from the “artifact” label, a threshold of 0.1 is applied to the softmax values, and connected components with less than 20 pixels are removed. The remaining pixels are saved as a binary mask. The final list of particle positions only contains those with a user-defined minimum distance to the masked regions.</p>
    </sec>
    <sec id="S31">
      <title>Initial training of BoxNet</title>
      <p id="P48">11 EMPIAR and 14 in-house data sets (<xref ref-type="supplementary-material" rid="SD2">Fig. S5</xref>, <bold>Table S1</bold>) each contributed 20–50 micrographs to the training set. Additionally, synthetic data were prepared from 21 PDB models (<bold>Table S1</bold>) using a modified version of the InSilicoTEM<sup><xref rid="R57" ref-type="bibr">57</xref></sup> package, contributing ca. 1600 particles per species. The simulated data contained only one species per micrograph, although more heterogeneous examples might be added in the future. The training set was split 9/1 for training/validation, and trained with the momentum optimizer in TensorFlow 1.5 using a learning rate gradually decreasing from 1E-2 to 1E-5. The normalized data were augmented in each training epoch by extracting the 256<sup>2</sup> px window at random positions, and applying random rotation, flipping, shearing, and Gaussian noise with a random standard deviation between 0.0 and 0.6. This augmentation was observed to have an excellent regularizing effect, as the final training and validation scores were virtually identical. The training was performed for 800 epochs, using a batch size of 1.</p>
    </sec>
    <sec id="S32">
      <title>Retraining of BoxNet</title>
      <p id="P49">User-supplied positions of positive examples and, optionally, areas of increased and decreased certainty in the micrographs are automatically converted to training data. If requested, the training set is diluted with data from the latest version of the centrally curated set (in the following referred to as ‘old data’) in a 1:1 ratio to prevent possible overfitting of the new data. The retraining regime is identical to initial training, but lasts only 100 epochs. During the retraining, 4 metrics are calculated continuously for every batch: the old network’s accuracy for old and new data, and the retrained network’s accuracy for old and new data. Ideally, the retrained network’s accuracy for new data will improve to approach or even surpass the old network’s accuracy for old data by the end of the retraining process, whereas the accuracy for old data will stay constant.</p>
    </sec>
    <sec id="S33">
      <title>Template matching in micrographs and tomograms</title>
      <p id="P50">2D micrographs are subdivided in tiles with an overlap matching twice the template particle diameter. For each square, 2D projections of the template are prepared at user-defined angular intervals, convolved by the square’s CTF, and normalized to mean = 0, standard deviation = 1 in real space. The square’s FT is multiplied by the conjugate of the projection’s FT, and an IFT yields the cross-correlation scores for all positions within the square. These scores are normalized by the local standard deviation within the square. The scores are compared for all template orientations, and the best one is stored for each pixel within the square. Finally, the result is cropped to exclude a border matching the template particle diameter, and combined with the results from other squares to obtain the correlation scores for the entire micrograph. A local peak search is performed using the template particle diameter as the minimum distance, and all peak positions are stored for further processing. Template matching in tomographic volumes follows the same concept. Instead of square tiles, local cubes are cross-correlated with the template convolved by the local 3D CTF. Optionally, a spectrum whitening of the target micrograph/tomogram can be performed as previously described<sup><xref rid="R58" ref-type="bibr">58</xref></sup>. This has the benefit of equalizing the spectral noise amplitudes for all spatial frequencies, effectively giving more weight to the higher frequencies and sharpening the correlation peaks.</p>
    </sec>
    <sec id="S34">
      <title>Deconvolution</title>
      <p id="P51">In the absence of a phase plate, the CTF will be dominated by its sine component, i. e. have very little contrast in the lowest spatial frequencies. This creates a high-pass filter effect in the raw data and, due to increasingly noisier higher frequency components, makes it hard to assess the image content visually. On the other hand, a phase plate creating the desired phase shift of π/2 will apply a low-pass filter in defocused images, rendering them blurry. Both scenarios do not affect subsequent alignment and averaging procedures significantly, and the filters will be reversed in the final reconstruction by dividing its 3D FT by the weighted average of all contributing CTFs. This becomes possible because the spectral signal-to-noise ratio (SSNR) is sufficiently high after averaging enough particles with different CTFs. However, even in single images the lowest frequency components often contain enough signal so that boosting them by inverting the CTF will increase the visible low-frequency contrast while maintaining acceptable noise levels. This provides conventional images with a better definition of object boundaries, making their manual selection easier. In defocused phase plate images, this improves sharpness.</p>
      <p id="P52">To construct a Wiener-like filter, <italic>Warp</italic> makes ad hoc assumptions about the SSNR that can be adjusted by the user. The SSNR is assumed to be a combination of an exponential decay curve and a raised cosine high-pass filter: <disp-formula id="FD6"><mml:math display="block" id="M6" overflow="scroll"><mml:mrow><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:msub><mml:mi>R</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mo>⋅</mml:mo><mml:mn>100</mml:mn><mml:mi>F</mml:mi></mml:mrow></mml:msup><mml:mo>⋅</mml:mo><mml:msup><mml:mrow><mml:mn>10</mml:mn></mml:mrow><mml:mrow><mml:mn>3</mml:mn><mml:mi>S</mml:mi></mml:mrow></mml:msup><mml:mo>⋅</mml:mo><mml:msub><mml:mi>H</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where <italic>f</italic> denotes the spatial frequency, <italic>H</italic> is an optional high-pass filter, <italic>F</italic> is the custom fall-off parameter, and <italic>S</italic> is the custom strength parameter. The factors for <italic>F</italic> and <italic>S</italic> are empirically tuned so that the default values of 1 produce good results for typical direct electron detector data, although adjustments might be required in some cases. The SSNR is then used in a Wiener-like filter: <disp-formula id="FD7"><mml:math display="block" id="M7" overflow="scroll"><mml:mrow><mml:msubsup><mml:mi>I</mml:mi><mml:mi>f</mml:mi><mml:mo>′</mml:mo></mml:msubsup><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>I</mml:mi><mml:mi>f</mml:mi></mml:msub><mml:mo>⋅</mml:mo><mml:mi>C</mml:mi><mml:mi>T</mml:mi><mml:msub><mml:mi>F</mml:mi><mml:mi>f</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:mi>C</mml:mi><mml:mi>T</mml:mi><mml:msubsup><mml:mi>F</mml:mi><mml:mi>f</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>+</mml:mo><mml:mi>S</mml:mi><mml:mi>S</mml:mi><mml:mi>N</mml:mi><mml:msubsup><mml:mi>R</mml:mi><mml:mi>f</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula> where <italic>I</italic> is the FT of the image, and <italic>CTF</italic> is the 2D contrast transfer function. The shape of the SSNR curve prevents the lowest frequency components from being boosted too much, giving rise to a noisy sample background, and acts as a low-pass filter at the same time to suppress the noisy high frequency components. An example of such a filter and its effect on a 2D micrograph are shown in <xref ref-type="supplementary-material" rid="SD2">Fig. S2b</xref>. In practice, a higher electron dose helps to obtain good low-frequency contrast in conventional images. The commonly used dose of 30–40 e<sup>-</sup>/Å<sup>2</sup> works well for holey grids with thin ice, while more might be required in the presence of carbon support or thick ice. The deconvolution works especially well in tomograms, where the overall dose often surpasses 100 e<sup>-</sup>/Å<sup>2</sup>.</p>
    </sec>
    <sec id="S35">
      <title>Denoising improves particle visibility</title>
      <p id="P53">Even after deconvolution, micrographs will often display a high amount of noise that makes their visual inspection difficult. Deep convolutional neural network-based denoisers have been shown to perform better than hand-crafted statistical models<sup><xref rid="R59" ref-type="bibr">59</xref>, <xref rid="R60" ref-type="bibr">60</xref></sup>. [REFs]. However, their training has traditionally required pairs of noisy and noise-free observations of the same signal. This prevented denoiser training on cryo–EM data, where a noise-free ground truth is not available due to quickly increasing radiation damage in sensitive samples. Recently, the Noise2Noise principle<sup><xref rid="R61" ref-type="bibr">61</xref></sup> has been proposed to circumvent this limitation while achieving comparable performance. Pairs of independently noisy observations of the same signal are used in training as input and output. In the absence of correlation between the noise patterns, the expectation value is the underlying noise-free signal, which the model learns to predict. Pairs of independently noisy data are readily available in cryo–EM. Since every micrograph’s signal is fractionated in a multitude of frames, computing the aligned averages of all odd and even frames renders a pair of almost identical observations with independent patterns of camera shot noise. By using odd and even frames instead of the first and second halves of a movie, the effect of radiation damage is very similar in both averages.</p>
      <p id="P54"><italic>Warp</italic> adopts the published Noise2Noise U-net-like network architecture with one change; a batch normalization layer is added before each leaky ReLU layer. The denoising is performed on overlapping 256<sup>2</sup> px tiles, and the central 128<sup>2</sup> px windows are combined to produce the final image shown in <xref ref-type="supplementary-material" rid="SD2">Fig. S2c</xref>. <italic>Warp</italic> generates training data from processed movies automatically. These images are also pre-deconvolved. While deconvolution and denoising are independent processes, their combination provides the most natural-looking result for the human observer. Once enough training examples have been generated (up to 128 are supported by default), the user can request to retrain the model, which will take a few minutes. A default pre-trained model is provided with <italic>Warp</italic> that covers a narrow range of conventional and VPP data. However, the best denoising performance is achieved by retraining the model for every new data set. Like deconvolution, denoising can be applied on-the-fly to any micrograph displayed in <italic>Warp</italic>, using the default or retrained model. While denoising provides a great visual aid for human interpretation of raw data, the process removes all signal that cannot be reliably distinguished from noise in a single observation. Thus, denoised particle images do not render themselves to averaging as a means of increasing the SNR at higher resolution.</p>
    </sec>
    <sec id="S36">
      <title>Benchmarking for 2D data</title>
      <p id="P55">For the influenza hemagglutinin trimer benchmark, raw movie data and pre-extracted particles from EMPIAR-10097 were downloaded. The movies were processed with the full <italic>Warp</italic> pipeline using the following settings: motion correction with a temporal resolution of 40 for the global motion, and 5x5 spatial resolution for the local motion, using the 0.03–0.25 Nyquist range and a B-factor of -400 A<sup>2</sup>; CTF estimation with 6x6 spatial resolution, using the 0.1–0.35 Nyquist range; particle picking with a BoxNet model retrained on particles from 3 micrographs, using the default 0.95 threshold. Quality filters were applied in Warp as follows: defocus between 0.3 and 5.0 µm, resolution better than 8 Å, intra-frame motion of at most 1.5 Å, particle count above 120. Particles were extracted from the micrographs meeting these filters and subjected to processing in cryoSPARC: no 2D classification was performed; <italic>ab initio</italic> refinement was performed with 6 classes and no symmetry; the 6 classes were then refined heterogeneously, with no symmetry imposed; the only class showing the expected Hemagglutinin structure was refined with C3 symmetry. The original particle set from EMPIAR-10097 was subjected to 3 different processing strategies. First, the full set was refined in cryoSPARC with C3 symmetry using the original CTF estimates. Second, the full set was subjected to the same classification and refinement as the particles from Warp, using the original CTF estimates. Third, particles from the Hemagglutinin class obtained in the second processing branch were updated with local CTF estimates from Warp, and refined again with C3 symmetry. Resolution estimates were obtained for all maps using the respective masks automatically generated by cryoSPARC.</p>
      <p id="P56">For the β-galactosidase benchmarking studies, raw data from EMPIAR-10061 were downloaded. The movies were processed with the full <italic>Warp</italic> pipeline using the following settings: motion correction with a temporal resolution of 38 for the global motion, and a 5x5 spatial resolution for the local motion, using the 0.03–0.60 Nyquist range and a B-factor of -160 Å<sup>2</sup>; CTF estimation with 5x5 spatial resolution, using the 0.08–0.60 Nyquist range; particle picking with a BoxNet model retrained on particles from 5 micrographs, using a threshold of 0.30. No quality filters were used as the data already represent a high-quality subset curated for the initial publication. Picked and extracted particles were subjected to 2D and 3D classification with C1 symmetry in RELION 2.1 to remove incomplete particles. The remaining particles were refined with D2 symmetry. The final half-maps were then used to refine beam tilt and per-particle defocus in RELION 3.0. Global motion tracks for all movies were exported from <italic>Warp</italic> to RELION 3.0 to perform Bayesian particle polishing.</p>
      <p id="P57">To assess the frame alignment accuracy in <italic>Warp</italic> independently of downstream map refinement, β-galactosidase movies were aligned in <italic>Warp</italic> as described above, and using the default settings in MotionCor2. CTF fitting was performed with 5x5 spatial resolution, using the 0.08–50 Nyquist range. Frequency-dependent fit quality was calculated as described in the ‘Resolution estimation’ section, and all resulting curves averaged. The resolution was then estimated at a cut-off value of 0.3.</p>
    </sec>
    <sec id="S37">
      <title>Benchmarking for tilt series data</title>
      <p id="P58">For the template matching benchmark, pre-aligned tilt series from EMPIAR-10045 were downloaded. The defocus was estimated, and full tomograms were reconstructed with a pixel size of 10 Å in Warp. The 80S ribosome map derived from these data in the original publication<sup><xref rid="R40" ref-type="bibr">40</xref></sup> and deposited under EMD-3228 was used as the template. Template matching was performed on the 10 Å/px tomograms with an angular sampling of 7.5 °, using a local 3D CTF. The same steps were performed using a binary missing wedge mask instead of the 3D CTF. The picked positions were screened manually to determine the false positive rate. Background statistics were calculated for the correlation volume trimmed to remove the vacuum region, and excluding 48 px windows around the peaks.</p>
      <p id="P59">To benchmark CTF estimation and sub-tomogram export on EMPIAR-10045 data, the particles previously picked through template matching were exported together with their 3D CTF volumes at a pixel size of 5 Å. The sub-tomograms were then subjected to 3D refinement in RELION 3.0 without prior classification.</p>
      <p id="P60">To benchmark CTF estimation and sub-tomogram export on HIV-1 particles, raw data from EMPIAR-10164 were downloaded. A subset of 5 tilt series previously used by the authors of NovaCTF<sup><xref rid="R41" ref-type="bibr">41</xref></sup> was selected. Movies were aligned in <italic>Warp</italic> using only global alignment with a temporal resolution of 5. Gold beads were picked manually and used to align the tilt series in IMOD<sup><xref rid="R62" ref-type="bibr">62</xref></sup>. Full tomograms were reconstructed with a pixel size of 5 Å in <italic>Warp</italic>. Template matching was performed with the EMD-4015 map with an angular sampling of 7.5 ° and C6 symmetry. A custom script was used to remove particles not fitting into a regular hexagonal grid as described previously<sup><xref rid="R47" ref-type="bibr">47</xref></sup>. The particles were exported together with their 3D CTF volumes at a pixel size of 1.35 Å. The sub-tomograms were then subjected to 3D refinement in RELION 3.0 without prior classification.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material" id="SM">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="SD1">
      <label>Supplementary information</label>
      <media xlink:href="EMS84178-supplement-Supplementary_information.pdf" mimetype="application" mime-subtype="pdf" orientation="portrait" xlink:type="simple" id="d36e2057" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD2">
      <label>Supplementary figures</label>
      <media xlink:href="EMS84178-supplement-Supplementary_figures.doc" mimetype="application" mime-subtype="msword" orientation="portrait" xlink:type="simple" id="d36e2061" position="anchor"/>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack id="S38">
    <title>Acknowledgements</title>
    <p>We thank members of the Cramer lab for beta-testing early versions of <italic>Warp</italic> and providing feedback on bugs in the software. We thank C. Bernecky, S. Dodonova, W. Hagen, D. Lyumkis, C. Plaschka, J. Söding and Y.Z. Tan for critical reading of the manuscript. PC was supported by ERC Advanced Grant TRANSREGULON (grant agreement No 693023) of the European Research Council, the Deutsche Forschungsgemeinschaft (SFB 860), and the Volkswagen Foundation.</p>
  </ack>
  <fn-group>
    <fn id="FN1">
      <p id="P61">
        <bold>Data availability</bold>
      </p>
      <p id="P62"><xref ref-type="fig" rid="F1">Figures 1</xref> and <xref ref-type="supplementary-material" rid="SD2">S1</xref> use exemplary data from EMPIAR-10078 (doi:<ext-link ext-link-type="uri" xlink:href="http://www.ebi.ac.uk/pdbe/emdb/empiar/entry/10078">10.6019/EMPIAR-10078</ext-link>). <xref ref-type="fig" rid="F2">Figure 2</xref> uses a cryo-EM image of RNA Pol II complexes, available from the authors upon request. <xref ref-type="fig" rid="F3">Figure 3</xref> and the benchmark section use data from EMPIAR-10097 (doi:<ext-link ext-link-type="uri" xlink:href="http://www.ebi.ac.uk/pdbe/emdb/empiar/entry/10097/">10.6019/EMPIAR-10097</ext-link>) re-analyzed in this study. The refined maps shown in Figure 3a are available in Supplementary Data 1–4. The "Full <italic>Warp</italic> pipeline" map shown in <xref ref-type="fig" rid="F3">Figure 3a</xref> has been deposited in EMDB as EMD-0025 (<ext-link ext-link-type="uri" xlink:href="http://www.ebi.ac.uk/pdbe/entry/emdb/EMD-0025">http://www.ebi.ac.uk/pdbe/entry/emdb/EMD-0025</ext-link>). <xref ref-type="fig" rid="F4">Figure 4</xref> and the benchmark section use data from EMPIAR-10061 (doi:<ext-link ext-link-type="uri" xlink:href="http://www.ebi.ac.uk/pdbe/emdb/empiar/entry/10061/">10.6019/EMPIAR-10061</ext-link>) re-analyzed in this study, the 1.86 Å map shown in Figure 4a is available as Supplementary Data 5. <xref ref-type="fig" rid="F5">Figure 5a</xref> uses a tomogram reconstructed from data from EMPIAR-10045 (doi:<ext-link ext-link-type="uri" xlink:href="http://www.ebi.ac.uk/pdbe/emdb/empiar/entry/10045/">10.6019/EMPIAR-10045</ext-link>). <xref ref-type="fig" rid="F6">Figure 6</xref> and the benchmark section use data from EMPIAR-10045 and EMPIAR-10164 (doi:<ext-link ext-link-type="uri" xlink:href="http://www.ebi.ac.uk/pdbe/emdb/empiar/entry/10164/">10.6019/EMPIAR-10164</ext-link>) re-analyzed in this study, the maps shown in Figure 6a and 6b are available in Supplementary Data 6 and 7, respectively. <xref ref-type="supplementary-material" rid="SD2">Figure S2</xref> uses exemplary data from EMPIAR-10061. <xref ref-type="supplementary-material" rid="SD2">Figure S3</xref> uses exemplary data from EMPIAR-10097 (doi:<ext-link ext-link-type="uri" xlink:href="http://www.ebi.ac.uk/pdbe/emdb/empiar/entry/10097/">10.6019/EMPIAR-10097</ext-link>). <xref ref-type="supplementary-material" rid="SD2">Figure S5</xref> uses in-house data, available upon request. <xref ref-type="supplementary-material" rid="SD2">Figure S6</xref> uses exemplary data from EMPIAR-10078. <xref ref-type="supplementary-material" rid="SD2">Figure S7</xref> uses exemplary data from (left) EMPIAR-10078, (center) in-house data available upon request, and (right) EMPIAR-10153 (doi:<ext-link ext-link-type="uri" xlink:href="http://www.ebi.ac.uk/pdbe/emdb/empiar/entry/10153/">10.6019/EMPIAR-10153</ext-link>). Training data for <italic>BoxNet</italic> can be accessed through <ext-link ext-link-type="uri" xlink:href="https://github.com/cramerlab/boxnet">https://github.com/cramerlab/boxnet</ext-link>.</p>
    </fn>
    <fn id="FN2">
      <p id="P63">
        <bold>Code availability</bold>
      </p>
      <p id="P64"><italic>Warp</italic> binaries, source code and user guide can be downloaded from <ext-link ext-link-type="uri" xlink:href="https://github.com/cramerlab/warp">https://github.com/cramerlab/warp</ext-link>. <italic>BoxNet</italic> source code can be downloaded from <ext-link ext-link-type="uri" xlink:href="https://github.com/cramerlab/boxnet">https://github.com/cramerlab/boxnet</ext-link>.</p>
    </fn>
    <fn fn-type="con" id="FN3">
      <p id="P65">
        <bold>Author contributions</bold>
      </p>
      <p id="P66">D.T. designed <italic>Warp</italic>’s architecture and all algorithms, and carried out all implementation and application. P.C. provided scientific environment, funding and additional interpretations and implications. D.T. and P.C. wrote the manuscript.</p>
    </fn>
    <fn fn-type="COI-statement" id="FN4">
      <p id="P67">
        <bold>Competing financial interests</bold>
      </p>
      <p id="P68">The authors declare no competing financial or other interests.</p>
    </fn>
  </fn-group>
  <ref-list>
    <ref id="R1">
      <label>1</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Saibil</surname>
            <given-names>HR</given-names>
          </name>
          <name>
            <surname>Grünewald</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Stuart</surname>
            <given-names>DI</given-names>
          </name>
        </person-group>
        <article-title>A national facility for biological cryo-electron microscopy</article-title>
        <source>Acta Crystallographica Section D: Biological Crystallography</source>
        <year>2015</year>
        <volume>71</volume>
        <fpage>127</fpage>
        <lpage>135</lpage>
        <pub-id pub-id-type="pmid">25615867</pub-id>
      </element-citation>
    </ref>
    <ref id="R2">
      <label>2</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Suloway</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Automated molecular microscopy: the new Leginon system</article-title>
        <source>Journal of structural biology</source>
        <year>2005</year>
        <volume>151</volume>
        <fpage>41</fpage>
        <lpage>60</lpage>
        <pub-id pub-id-type="pmid">15890530</pub-id>
      </element-citation>
    </ref>
    <ref id="R3">
      <label>3</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Brilot</surname>
            <given-names>AF</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Beam-Induced Motion of Vitrified Specimen on Holey Carbon Film</article-title>
        <source>Journal of structural biology</source>
        <year>2012</year>
        <volume>177</volume>
        <fpage>630</fpage>
        <lpage>637</lpage>
        <pub-id pub-id-type="pmid">22366277</pub-id>
      </element-citation>
    </ref>
    <ref id="R4">
      <label>4</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Huang</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Baldwin</surname>
            <given-names>PR</given-names>
          </name>
          <name>
            <surname>Mullapudi</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Penczek</surname>
            <given-names>PA</given-names>
          </name>
        </person-group>
        <article-title>Automated determination of parameters describing power spectra of micrograph images in electron microscopy</article-title>
        <source>Journal of structural biology</source>
        <year>2003</year>
        <volume>144</volume>
        <fpage>79</fpage>
        <lpage>94</lpage>
        <pub-id pub-id-type="pmid">14643211</pub-id>
      </element-citation>
    </ref>
    <ref id="R5">
      <label>5</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>van Heel</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Detection of objects in quantum-noise-limited images</article-title>
        <source>Ultramicroscopy</source>
        <year>1982</year>
        <volume>7</volume>
        <fpage>331</fpage>
        <lpage>341</lpage>
      </element-citation>
    </ref>
    <ref id="R6">
      <label>6</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>X</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Electron counting and beam-induced motion correction enable near-atomic-resolution single-particle cryo-EM</article-title>
        <source>Nat Methods</source>
        <year>2013</year>
        <volume>10</volume>
        <fpage>584</fpage>
        <lpage>590</lpage>
        <pub-id pub-id-type="pmid">23644547</pub-id>
      </element-citation>
    </ref>
    <ref id="R7">
      <label>7</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Grant</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Grigorieff</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Measuring the optimal exposure for single particle cryo-EM using a 2.6 Å reconstruction of rotavirus VP6</article-title>
        <year>2015</year>
      </element-citation>
    </ref>
    <ref id="R8">
      <label>8</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Mastronarde</surname>
            <given-names>DN</given-names>
          </name>
        </person-group>
        <article-title>Automated electron microscope tomography using robust prediction of specimen movements</article-title>
        <source>Journal of structural biology</source>
        <year>2005</year>
        <volume>152</volume>
        <fpage>36</fpage>
        <lpage>51</lpage>
        <pub-id pub-id-type="pmid">16182563</pub-id>
      </element-citation>
    </ref>
    <ref id="R9">
      <label>9</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zheng</surname>
            <given-names>SQ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>MotionCor2: anisotropic correction of beam-induced motion for improved cryo-electron microscopy</article-title>
        <source>Nat Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>331</fpage>
        <lpage>332</lpage>
        <pub-id pub-id-type="pmid">28250466</pub-id>
      </element-citation>
    </ref>
    <ref id="R10">
      <label>10</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rubinstein</surname>
            <given-names>JL</given-names>
          </name>
          <name>
            <surname>Brubaker</surname>
            <given-names>MA</given-names>
          </name>
        </person-group>
        <article-title>Alignment of cryo-EM movies of individual particles by optimization of image translations</article-title>
        <source>Journal of structural biology</source>
        <year>2015</year>
        <volume>192</volume>
      </element-citation>
    </ref>
    <ref id="R11">
      <label>11</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>McLeod</surname>
            <given-names>RA</given-names>
          </name>
          <name>
            <surname>Kowal</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Ringler</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Stahlberg</surname>
            <given-names>H</given-names>
          </name>
        </person-group>
        <article-title>Robust image alignment for cryogenic transmission electron microscopy</article-title>
        <source>Journal of structural biology</source>
        <year>2017</year>
        <volume>197</volume>
        <fpage>279</fpage>
        <lpage>293</lpage>
        <pub-id pub-id-type="pmid">28038834</pub-id>
      </element-citation>
    </ref>
    <ref id="R12">
      <label>12</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rohou</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Grigorieff</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>CTFFIND4: Fast and accurate defocus estimation from electron micrographs</article-title>
        <source>Journal of structural biology</source>
        <year>2015</year>
        <volume>192</volume>
        <fpage>216</fpage>
        <lpage>221</lpage>
        <pub-id pub-id-type="pmid">26278980</pub-id>
      </element-citation>
    </ref>
    <ref id="R13">
      <label>13</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bell</surname>
            <given-names>JM</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Baldwin</surname>
            <given-names>PR</given-names>
          </name>
          <name>
            <surname>Ludtke</surname>
            <given-names>SJ</given-names>
          </name>
        </person-group>
        <article-title>High resolution single particle refinement in EMAN2.1</article-title>
        <source>Methods (San Diego, Calif.)</source>
        <year>2016</year>
        <volume>100</volume>
        <fpage>25</fpage>
        <lpage>34</lpage>
      </element-citation>
    </ref>
    <ref id="R14">
      <label>14</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhang</surname>
            <given-names>K</given-names>
          </name>
        </person-group>
        <article-title>Gctf: Real-time CTF determination and correction</article-title>
        <source>J Struct Biol</source>
        <year>2016</year>
        <volume>193</volume>
        <fpage>1</fpage>
        <lpage>12</lpage>
        <pub-id pub-id-type="pmid">26592709</pub-id>
      </element-citation>
    </ref>
    <ref id="R15">
      <label>15</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Scheres</surname>
            <given-names>SH</given-names>
          </name>
        </person-group>
        <article-title>Semi-automated selection of cryo-EM particles in RELION-1.3</article-title>
        <source>Journal of structural biology</source>
        <year>2015</year>
        <volume>189</volume>
        <fpage>114</fpage>
        <lpage>122</lpage>
        <pub-id pub-id-type="pmid">25486611</pub-id>
      </element-citation>
    </ref>
    <ref id="R16">
      <label>16</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Roseman</surname>
            <given-names>AM</given-names>
          </name>
        </person-group>
        <article-title>FindEM--a fast, efficient program for automatic selection of particles from electron micrographs</article-title>
        <source>Journal of structural biology</source>
        <year>2004</year>
        <volume>145</volume>
        <fpage>91</fpage>
        <lpage>99</lpage>
        <pub-id pub-id-type="pmid">15065677</pub-id>
      </element-citation>
    </ref>
    <ref id="R17">
      <label>17</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Chen</surname>
            <given-names>JZ</given-names>
          </name>
          <name>
            <surname>Grigorieff</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>SIGNATURE: a single-particle selection system for molecular electron microscopy</article-title>
        <source>Journal of structural biology</source>
        <year>2007</year>
        <volume>157</volume>
        <fpage>168</fpage>
        <lpage>173</lpage>
        <pub-id pub-id-type="pmid">16870473</pub-id>
      </element-citation>
    </ref>
    <ref id="R18">
      <label>18</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sorzano</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Automatic particle selection from electron micrographs using machine learning techniques</article-title>
        <source>Journal of structural biology</source>
        <year>2009</year>
        <volume>167</volume>
        <fpage>252</fpage>
        <lpage>260</lpage>
        <pub-id pub-id-type="pmid">19555764</pub-id>
      </element-citation>
    </ref>
    <ref id="R19">
      <label>19</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>DeepPicker: A deep learning approach for fully automated particle picking in cryo-EM</article-title>
        <source>Journal of structural biology</source>
        <year>2016</year>
        <volume>195</volume>
        <fpage>325</fpage>
        <lpage>336</lpage>
        <pub-id pub-id-type="pmid">27424268</pub-id>
      </element-citation>
    </ref>
    <ref id="R20">
      <label>20</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lander</surname>
            <given-names>GC</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Appion: an integrated, database-driven pipeline to facilitate EM image processing</article-title>
        <source>Journal of structural biology</source>
        <year>2009</year>
        <volume>166</volume>
        <fpage>95</fpage>
        <lpage>102</lpage>
        <pub-id pub-id-type="pmid">19263523</pub-id>
      </element-citation>
    </ref>
    <ref id="R21">
      <label>21</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Biyani</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Focus: The interface between data collection and data processing in cryo-EM</article-title>
        <source>Journal of structural biology</source>
        <year>2017</year>
        <volume>198</volume>
        <fpage>124</fpage>
        <lpage>133</lpage>
        <pub-id pub-id-type="pmid">28344036</pub-id>
      </element-citation>
    </ref>
    <ref id="R22">
      <label>22</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>de la Rosa-Trevin</surname>
            <given-names>JM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Scipion: A software framework toward integration, reproducibility and validation in 3D electron microscopy</article-title>
        <source>Journal of structural biology</source>
        <year>2016</year>
        <volume>195</volume>
        <fpage>93</fpage>
        <lpage>99</lpage>
        <pub-id pub-id-type="pmid">27108186</pub-id>
      </element-citation>
    </ref>
    <ref id="R23">
      <label>23</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Scheres</surname>
            <given-names>SH</given-names>
          </name>
        </person-group>
        <article-title>RELION: implementation of a Bayesian approach to cryo-EM structure determination</article-title>
        <source>Journal of structural biology</source>
        <year>2012</year>
        <volume>180</volume>
        <fpage>519</fpage>
        <lpage>530</lpage>
        <pub-id pub-id-type="pmid">23000701</pub-id>
      </element-citation>
    </ref>
    <ref id="R24">
      <label>24</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Punjani</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Rubinstein</surname>
            <given-names>JL</given-names>
          </name>
          <name>
            <surname>Fleet</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Brubaker</surname>
            <given-names>MA</given-names>
          </name>
        </person-group>
        <article-title>cryoSPARC: algorithms for rapid unsupervised cryo-EM structure determination</article-title>
        <source>Nature Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>290</fpage>
        <pub-id pub-id-type="pmid">28165473</pub-id>
      </element-citation>
    </ref>
    <ref id="R25">
      <label>25</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tan</surname>
            <given-names>YZ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Addressing preferred specimen orientation in single-particle cryo-EM through tilting</article-title>
        <source>Nat Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>793</fpage>
        <lpage>796</lpage>
        <pub-id pub-id-type="pmid">28671674</pub-id>
      </element-citation>
    </ref>
    <ref id="R26">
      <label>26</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hagen</surname>
            <given-names>WJH</given-names>
          </name>
          <name>
            <surname>Wan</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Briggs</surname>
            <given-names>JAG</given-names>
          </name>
        </person-group>
        <article-title>Implementation of a cryo-electron tomography tilt-scheme optimized for high resolution subtomogram averaging</article-title>
        <source>Journal of structural biology</source>
        <year>2017</year>
        <volume>197</volume>
        <fpage>191</fpage>
        <lpage>198</lpage>
        <pub-id pub-id-type="pmid">27313000</pub-id>
      </element-citation>
    </ref>
    <ref id="R27">
      <label>27</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Campbell</surname>
            <given-names>MG</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Movies of ice-embedded particles enhance resolution in electron cryo-microscopy</article-title>
        <source>Structure (London, England: 1993)</source>
        <year>2012</year>
        <volume>20</volume>
        <fpage>1823</fpage>
        <lpage>1828</lpage>
      </element-citation>
    </ref>
    <ref id="R28">
      <label>28</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Noble</surname>
            <given-names>AJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Routine Single Particle CryoEM Sample and Grid Characterization by Tomography</article-title>
        <source>eLife</source>
        <year>2018</year>
        <volume>7</volume>
        <fpage>e34257</fpage>
        <comment>2018</comment>
        <pub-id pub-id-type="pmid">29809143</pub-id>
      </element-citation>
    </ref>
    <ref id="R29">
      <label>29</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lecun</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Bottou</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Bengio</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Haffner</surname>
            <given-names>P</given-names>
          </name>
        </person-group>
        <article-title>Gradient-based learning applied to document recognition</article-title>
        <source>Proceedings of the IEEE</source>
        <year>1998</year>
        <volume>86</volume>
        <fpage>2278</fpage>
        <lpage>2324</lpage>
      </element-citation>
    </ref>
    <ref id="R30">
      <label>30</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Krizhevsky</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Sutskever</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Hinton</surname>
            <given-names>GE</given-names>
          </name>
        </person-group>
        <article-title>ImageNet classification with deep convolutional neural networks</article-title>
        <source>Proceedings of the 25th International Conference on Neural Information Processing Systems</source>
        <year>2012</year>
        <volume>1</volume>
        <fpage>1097</fpage>
        <lpage>1105</lpage>
      </element-citation>
    </ref>
    <ref id="R31">
      <label>31</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>He</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Ren</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Sun</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Deep Residual Learning for Image Recognition</article-title>
        <source>IEEE Conference on Computer Vision and Pattern Recognition (CVPR)</source>
        <year>2016</year>
        <volume>770</volume>
        <fpage>778</fpage>
      </element-citation>
    </ref>
    <ref id="R32">
      <label>32</label>
      <element-citation publication-type="confproc">
        <person-group person-group-type="author">
          <name>
            <surname>Abadi</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>TensorFlow: a system for large-scale machine learning</article-title>
        <conf-name>Proceedings of the 12th USENIX conference on Operating Systems Design and Implementation</conf-name>
        <year>2016</year>
        <fpage>265</fpage>
        <lpage>283</lpage>
      </element-citation>
    </ref>
    <ref id="R33">
      <label>33</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Iudin</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Korir</surname>
            <given-names>PK</given-names>
          </name>
          <name>
            <surname>Salavert-Torres</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Kleywegt</surname>
            <given-names>GJ</given-names>
          </name>
          <name>
            <surname>Patwardhan</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>EMPIAR: a public archive for raw electron microscopy image data</article-title>
        <source>Nat Methods</source>
        <year>2016</year>
        <volume>13</volume>
        <fpage>387</fpage>
        <lpage>388</lpage>
        <pub-id pub-id-type="pmid">27067018</pub-id>
      </element-citation>
    </ref>
    <ref id="R34">
      <label>34</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Berman</surname>
            <given-names>HM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The Protein Data Bank</article-title>
        <source>Nucleic Acids Res</source>
        <year>2000</year>
        <volume>28</volume>
        <fpage>235</fpage>
        <lpage>242</lpage>
        <pub-id pub-id-type="pmid">10592235</pub-id>
      </element-citation>
    </ref>
    <ref id="R35">
      <label>35</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wagner</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>SPHIRE-crYOLO is a fast and accurate fully automated particle picker for cryo-EM</article-title>
        <source>Communications Biology</source>
        <year>2019</year>
        <volume>2</volume>
        <fpage>218</fpage>
        <pub-id pub-id-type="pmid">31240256</pub-id>
      </element-citation>
    </ref>
    <ref id="R36">
      <label>36</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zivanov</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>RELION-3: new tools for automated high-resolution cryo-EM structure determination</article-title>
        <source>eLife</source>
        <year>2018</year>
        <volume>7</volume>
        <fpage>e42166</fpage>
        <comment>2018</comment>
        <pub-id pub-id-type="pmid">30412051</pub-id>
      </element-citation>
    </ref>
    <ref id="R37">
      <label>37</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tagari</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Newman</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Chagoyen</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Carazo</surname>
            <given-names>JM</given-names>
          </name>
          <name>
            <surname>Henrick</surname>
            <given-names>K</given-names>
          </name>
        </person-group>
        <article-title>New electron microscopy database and deposition system</article-title>
        <source>Trends in biochemical sciences</source>
        <year>2002</year>
        <volume>27</volume>
        <fpage>589</fpage>
        <pub-id pub-id-type="pmid">12417136</pub-id>
      </element-citation>
    </ref>
    <ref id="R38">
      <label>38</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Henderson</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Avoiding the pitfalls of single particle cryo-electron microscopy: Einstein from noise</article-title>
        <source>Proceedings of the National Academy of Sciences of the United States of America</source>
        <year>2013</year>
        <volume>110</volume>
        <fpage>18037</fpage>
        <lpage>18041</lpage>
        <pub-id pub-id-type="pmid">24106306</pub-id>
      </element-citation>
    </ref>
    <ref id="R39">
      <label>39</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bartesaghi</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>2.2 A resolution cryo-EM structure of beta-galactosidase in complex with a cell-permeant inhibitor</article-title>
        <source>Science (New York, N.Y.)</source>
        <year>2015</year>
        <volume>348</volume>
        <fpage>1147</fpage>
        <lpage>1151</lpage>
      </element-citation>
    </ref>
    <ref id="R40">
      <label>40</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bharat</surname>
            <given-names>TA</given-names>
          </name>
          <name>
            <surname>Scheres</surname>
            <given-names>SH</given-names>
          </name>
        </person-group>
        <article-title>Resolving macromolecular structures from electron cryo-tomography data using subtomogram averaging in RELION</article-title>
        <source>Nature protocols</source>
        <year>2016</year>
        <volume>11</volume>
        <fpage>2054</fpage>
        <lpage>2065</lpage>
        <pub-id pub-id-type="pmid">27685097</pub-id>
      </element-citation>
    </ref>
    <ref id="R41">
      <label>41</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Turonova</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Schur</surname>
            <given-names>FKM</given-names>
          </name>
          <name>
            <surname>Wan</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Briggs</surname>
            <given-names>JAG</given-names>
          </name>
        </person-group>
        <article-title>Efficient 3D-CTF correction for cryo-electron tomography using NovaCTF improves subtomogram averaging resolution to 3.4A</article-title>
        <source>Journal of structural biology</source>
        <year>2017</year>
        <volume>199</volume>
        <fpage>187</fpage>
        <lpage>195</lpage>
        <pub-id pub-id-type="pmid">28743638</pub-id>
      </element-citation>
    </ref>
    <ref id="R42">
      <label>42</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Nocedal</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Updating quasi-Newton matrices with limited storage</article-title>
        <source>Mathematics of Computation</source>
        <year>1980</year>
        <volume>35</volume>
        <fpage>773</fpage>
        <lpage>773</lpage>
      </element-citation>
    </ref>
    <ref id="R43">
      <label>43</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sorzano</surname>
            <given-names>CO</given-names>
          </name>
          <name>
            <surname>Otero</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Olmos</surname>
            <given-names>EM</given-names>
          </name>
          <name>
            <surname>Carazo</surname>
            <given-names>JM</given-names>
          </name>
        </person-group>
        <article-title>Error analysis in the determination of the electron microscopical contrast transfer function parameters from experimental power Spectra</article-title>
        <source>BMC structural biology</source>
        <year>2009</year>
        <volume>9</volume>
        <fpage>18</fpage>
        <pub-id pub-id-type="pmid">19321015</pub-id>
      </element-citation>
    </ref>
    <ref id="R44">
      <label>44</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Penczek</surname>
            <given-names>PA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>CTER—Rapid estimation of CTF parameters with error assessment</article-title>
        <source>Ultramicroscopy</source>
        <year>2014</year>
        <volume>140</volume>
        <fpage>9</fpage>
        <lpage>19</lpage>
        <pub-id pub-id-type="pmid">24562077</pub-id>
      </element-citation>
    </ref>
    <ref id="R45">
      <label>45</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Danev</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Tegunov</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Baumeister</surname>
            <given-names>W</given-names>
          </name>
        </person-group>
        <article-title>Using the Volta phase plate with defocus for cryo-EM single particle analysis</article-title>
        <source>eLife</source>
        <year>2017</year>
        <volume>6</volume>
      </element-citation>
    </ref>
    <ref id="R46">
      <label>46</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Voortman</surname>
            <given-names>LM</given-names>
          </name>
          <name>
            <surname>Stallinga</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Schoenmakers</surname>
            <given-names>RHM</given-names>
          </name>
          <name>
            <surname>Vliet</surname>
            <given-names>LJv</given-names>
          </name>
          <name>
            <surname>Rieger</surname>
            <given-names>B</given-names>
          </name>
        </person-group>
        <article-title>A fast algorithm for computing and correcting the CTF for tilted, thick specimens in TEM</article-title>
        <source>Ultramicroscopy</source>
        <year>2011</year>
        <volume>111</volume>
        <fpage>1029</fpage>
        <lpage>1036</lpage>
        <pub-id pub-id-type="pmid">21740865</pub-id>
      </element-citation>
    </ref>
    <ref id="R47">
      <label>47</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schur</surname>
            <given-names>FK</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>An atomic model of HIV-1 capsid-SP1 reveals structures regulating assembly and maturation</article-title>
        <source>Science (New York, N.Y.)</source>
        <year>2016</year>
        <volume>353</volume>
        <fpage>506</fpage>
        <lpage>508</lpage>
      </element-citation>
    </ref>
    <ref id="R48">
      <label>48</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Xiong</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Morphew</surname>
            <given-names>MK</given-names>
          </name>
          <name>
            <surname>Schwartz</surname>
            <given-names>CL</given-names>
          </name>
          <name>
            <surname>Hoenger</surname>
            <given-names>AH</given-names>
          </name>
          <name>
            <surname>Mastronarde</surname>
            <given-names>DN</given-names>
          </name>
        </person-group>
        <article-title>CTF determination and correction for low dose tomographic tilt series</article-title>
        <source>Journal of structural biology</source>
        <year>2009</year>
        <volume>168</volume>
        <fpage>378</fpage>
        <lpage>387</lpage>
        <pub-id pub-id-type="pmid">19732834</pub-id>
      </element-citation>
    </ref>
    <ref id="R49">
      <label>49</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bharat</surname>
            <given-names>TA</given-names>
          </name>
          <name>
            <surname>Russo</surname>
            <given-names>CJ</given-names>
          </name>
          <name>
            <surname>Lowe</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Passmore</surname>
            <given-names>LA</given-names>
          </name>
          <name>
            <surname>Scheres</surname>
            <given-names>SH</given-names>
          </name>
        </person-group>
        <article-title>Advances in Single-Particle Electron Cryomicroscopy Structure Determination applied to Sub-tomogram Averaging</article-title>
        <source>Structure (London, England : 1993)</source>
        <year>2015</year>
        <volume>23</volume>
        <fpage>1743</fpage>
        <lpage>1753</lpage>
      </element-citation>
    </ref>
    <ref id="R50">
      <label>50</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hutchings</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Stancheva</surname>
            <given-names>V</given-names>
          </name>
          <name>
            <surname>Miller</surname>
            <given-names>EA</given-names>
          </name>
          <name>
            <surname>Zanetti</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Subtomogram averaging of COPII assemblies reveals how coat organization dictates membrane shape</article-title>
        <source>Nat Commun</source>
        <year>2018</year>
        <volume>9</volume>
      </element-citation>
    </ref>
    <ref id="R51">
      <label>51</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Russo</surname>
            <given-names>CJ</given-names>
          </name>
          <name>
            <surname>Henderson</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Ewald sphere correction using a single side-band image processing algorithm</article-title>
        <source>Ultramicroscopy</source>
        <year>2018</year>
        <volume>187</volume>
        <fpage>26</fpage>
        <lpage>33</lpage>
        <pub-id pub-id-type="pmid">29413409</pub-id>
      </element-citation>
    </ref>
    <ref id="R52">
      <label>52</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Grigorieff</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>FREALIGN: high-resolution refinement of single particle structures</article-title>
        <source>Journal of structural biology</source>
        <year>2007</year>
        <volume>157</volume>
        <fpage>117</fpage>
        <lpage>125</lpage>
        <pub-id pub-id-type="pmid">16828314</pub-id>
      </element-citation>
    </ref>
    <ref id="R53">
      <label>53</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kunz</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Frangakis</surname>
            <given-names>AS</given-names>
          </name>
        </person-group>
        <article-title>Three-dimensional CTF correction improves the resolution of electron tomograms</article-title>
        <source>Journal of structural biology</source>
        <year>2017</year>
        <volume>197</volume>
        <fpage>114</fpage>
        <lpage>122</lpage>
        <pub-id pub-id-type="pmid">27343995</pub-id>
      </element-citation>
    </ref>
    <ref id="R54">
      <label>54</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Grant</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Grigorieff</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Automatic estimation and correction of anisotropic magnification distortion in electron microscopes</article-title>
        <source>Journal of structural biology</source>
        <year>2015</year>
        <volume>192</volume>
        <fpage>204</fpage>
        <lpage>208</lpage>
        <pub-id pub-id-type="pmid">26278979</pub-id>
      </element-citation>
    </ref>
    <ref id="R55">
      <label>55</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Heymann</surname>
            <given-names>JB</given-names>
          </name>
          <name>
            <surname>Chagoyen</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Belnap</surname>
            <given-names>DM</given-names>
          </name>
        </person-group>
        <article-title>Common conventions for interchange and archiving of three-dimensional electron microscopy information in structural biology</article-title>
        <source>Journal of structural biology</source>
        <year>2005</year>
        <volume>151</volume>
        <fpage>196</fpage>
        <lpage>207</lpage>
        <pub-id pub-id-type="pmid">16043364</pub-id>
      </element-citation>
    </ref>
    <ref id="R56">
      <label>56</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ronneberger</surname>
            <given-names>O</given-names>
          </name>
          <name>
            <surname>Fischer</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Brox</surname>
            <given-names>T</given-names>
          </name>
        </person-group>
        <article-title>U-Net: Convolutional Networks for Biomedical Image Segmentation</article-title>
        <year>2015</year>
      </element-citation>
    </ref>
    <ref id="R57">
      <label>57</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Vulovic</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Image formation modeling in cryo-electron microscopy</article-title>
        <source>Journal of structural biology</source>
        <year>2013</year>
        <volume>183</volume>
        <fpage>19</fpage>
        <lpage>32</lpage>
        <pub-id pub-id-type="pmid">23711417</pub-id>
      </element-citation>
    </ref>
    <ref id="R58">
      <label>58</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rickgauer</surname>
            <given-names>JP</given-names>
          </name>
          <name>
            <surname>Grigorieff</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Denk</surname>
            <given-names>W</given-names>
          </name>
        </person-group>
        <article-title>Single-protein detection in crowded molecular environments in cryo-EM images</article-title>
        <source>eLife</source>
        <year>2017</year>
        <volume>6</volume>
      </element-citation>
    </ref>
    <ref id="R59">
      <label>59</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Mao</surname>
            <given-names>X-J</given-names>
          </name>
          <name>
            <surname>Shen</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>Y-B</given-names>
          </name>
        </person-group>
        <article-title>Image Restoration Using Convolutional Auto-encoders with Symmetric Skip Connections</article-title>
        <source>arXiv</source>
        <year>2016</year>
      </element-citation>
    </ref>
    <ref id="R60">
      <label>60</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Iizuka</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Simo-Serra</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Ishikawa</surname>
            <given-names>H</given-names>
          </name>
        </person-group>
        <article-title>Globally and locally consistent image completion</article-title>
        <source>ACM Transactions on Graphics (TOG)</source>
        <year>2017</year>
        <volume>36</volume>
        <fpage>107</fpage>
      </element-citation>
    </ref>
    <ref id="R61">
      <label>61</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lehtinen</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Noise2Noise: Learning Image Restoration without Clean Data</article-title>
        <source>arXiv</source>
        <year>2018</year>
      </element-citation>
    </ref>
    <ref id="R62">
      <label>62</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kremer</surname>
            <given-names>JR</given-names>
          </name>
          <name>
            <surname>Mastronarde</surname>
            <given-names>DN</given-names>
          </name>
          <name>
            <surname>McIntosh</surname>
            <given-names>JR</given-names>
          </name>
        </person-group>
        <article-title>Computer visualization of three-dimensional image data using IMOD</article-title>
        <source>Journal of structural biology</source>
        <year>1996</year>
        <volume>116</volume>
        <fpage>71</fpage>
        <lpage>76</lpage>
        <pub-id pub-id-type="pmid">8742726</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig id="F1" orientation="portrait" position="float">
    <label>Figure 1</label>
    <caption>
      <title><italic>Warp</italic> handles all pre-processing steps to close a gap in the 2D cryo–EM pipeline.</title>
      <p>Data is acquired by the microscope in an automated fashion and stored as compressed stacks of movie frames. <italic>Warp</italic> continuously monitors its input folder for new files, and subjects them to all steps of the pre-processing pipeline: frame alignment, CTF estimation and particle picking. <italic>Warp</italic> writes out a stack of particles for each pre-processed micrograph and maintains a dynamically updated STAR file with references to all particles and their local CTF parameters. This file can be used as a data source in a tool such as cryoSPARC, which will periodically run subsequent processing steps like 2D classification and <italic>ab initio</italic> reconstruction on the latest set of particles.</p>
    </caption>
    <graphic xlink:href="EMS84178-f001"/>
  </fig>
  <fig id="F2" orientation="portrait" position="float">
    <label>Figure 2</label>
    <caption>
      <title>Automated particle picking with <italic>Warp</italic>’s deep learning-based BoxNet</title>
      <p>Representative example of automated particle picking with BoxNet in <italic>Warp</italic> on a micrograph with high-contrast artifacts. Areas masked out automatically by BoxNet are colored purple. The generic version of BoxNet was never presented with the sample during training. The re-trained version was given 5 micrographs of the same sample, which did not include the one shown. The template-based picking in RELION used 25 class averages derived from 3000 particles, filtered to 20 A. RELION’s results show the 120 highest-scoring positions. For visualization purposes, the micrograph was deconvolved, high-pass filtered and cropped at the borders.</p>
    </caption>
    <graphic xlink:href="EMS84178-f002"/>
  </fig>
  <fig id="F3" orientation="portrait" position="float">
    <label>Figure 3</label>
    <caption>
      <title><italic>Warp</italic>'s 2D pipeline improves cryo-EM density for influenza hemagglutinin.</title>
      <p>As a benchmarking case we used the published EMPIAR-10097 data set containing influenza hemagglutinin trimer particles. 'Original set': 130,000 pre-extracted particles from EMPIAR-10097 with their original CTF parameters; 'Original set, best class': 57,346 particles from 'Original set' after 3D classification in cryoSPARC with their original CTF parameters; 'Original set, best class + Warp CTF': the same 57 346 particles, but with Warp's CTF estimates; 'Full Warp pipeline': 249,495 particles obtained from the raw EMPIAR-10097 data after unsupervised pre-processing in Warp and 3D classification in cryoSPARC.</p>
      <p>(a) Isosurface renderings of the 3D maps generated with cryoSPARC using the respective sets of particles and CTF parameters, filtered to local resolution using the auto-tightened masks generated by cryoSPARC.</p>
      <p>(b) Global masked FSC plots, and histograms of the local resolution used to filter the maps depicted in (a). 'EMPIAR-10097 half-maps' refers to the original half-map volumes deposited in EMPIAR-10097, obtained from the same 130,000 particles as 'Original set'.</p>
      <p>(c) Histogram comparison between the original defocus parameters and those estimated by Warp for the 130 000 particles from 'Original set'. The mean value for each metric is specified underneath the horizontal axis in the same color as the corresponding histogram.</p>
    </caption>
    <graphic xlink:href="EMS84178-f003"/>
  </fig>
  <fig id="F4" orientation="portrait" position="float">
    <label>Figure 4</label>
    <caption>
      <title>Warp’s 2D pipeline in combination with RELION 3.0 improves cryo-EM density for β-galactosidase.</title>
      <p>For our second benchmark, we used the published EMPIAR-10061 data set containing β-galactosidase particles. The data were processed using the full <italic>Warp</italic> pre-processing pipeline, and beam tilt, per-particle defocus and frame alignment were later refined against high-resolution references in RELION 3.0 to assess the additional improvement provided by these refinements.</p>
      <p>(a) Isosurface rendering of the 1.86 Å map (left) and a detailed view of some of its sidechains, clearly displaying the aromatic rings (right).</p>
      <p>(b) Global masked FSC plots for the map obtained with the Warp pipeline only, and for the additive effects of reference-based beam tilt and per-particle defocus refinement, as well as particle polishing in RELION 3.0.</p>
      <p>(c) Average CTF fit quality curves for aligned movie averages produced with MotionCor2 and Warp. Warp’s averages can be fitted to a higher resolution, indicating more accurate frame alignment. For comparison, a fit quality curve is also included for amplitude spectra obtained from the average of individual frame spectra, which are invariant to residual inter-frame motion and radiation damage.</p>
    </caption>
    <graphic xlink:href="EMS84178-f004"/>
  </fig>
  <fig id="F5" orientation="portrait" position="float">
    <label>Figure 5</label>
    <caption>
      <title>Effect of using the full local 3D CTF for template matching in tomograms.</title>
      <p>During template matching, <italic>Warp</italic> multiplies the rotated 3D reference by the local 3D CTF before correlating it to a local portion of the tomogram volume, as opposed to multiplying it by a binary missing wedge mask. This produces sharper correlation peaks.</p>
      <p>(a) XY slice through a tomogram reconstructed from EMPIAR-10045 data. The faint shapes of 80S ribosomes are visible.</p>
      <p>(b) XY slice through the correlation volume at the same location as (a), using a binary missing wedge mask. White indicates higher correlation. The peaks are broad and hard to distinguish against the background.</p>
      <p>(c) XY slice through the correlation volume at the same location as (a), using the full local 3D CTF. White indicates higher correlation. The peaks are sharper, leading to higher template matching accuracy.</p>
      <p>(d) Rotational average of a 48 px window around all correlation peaks, mean-subtracted and normalized against the respective correlation background. 3D CTF-aware template matching (+CTF) produces peaks rising 2.7 times higher above the background compared to binary missing wedge masks (–CTF).</p>
    </caption>
    <graphic xlink:href="EMS84178-f005"/>
  </fig>
  <fig id="F6" orientation="portrait" position="float">
    <label>Figure 6</label>
    <caption>
      <title>Sub-tomogram averaging results obtained by using <italic>Warp</italic>’s tilt series CTF estimation and sub-tomogram export.</title>
      <p>To assess the benefits of the proposed CTF estimation and sub-tomogram export strategies, data from EMPIAR-10045 and EMPIAR-10164 were pre-processed and exported in <italic>Warp</italic>, and refined in RELION 3.0. Improved resolution was observed in both cases compared to published results.</p>
      <p>(a) Isosurface rendering (left) and FSC plot (right) of the 80S ribosome sub-tomogram average obtained from EMPIAR-10045 data. The originally published resolution was 12.8 Å.</p>
      <p>(b) Isosurface rendering (left) and FSC plot (right) of the HIV-1 sub-tomogram average obtained from 12% of the EMPIAR-10164 data. The originally published resolution for this subset was 3.9 Å.</p>
    </caption>
    <graphic xlink:href="EMS84178-f006"/>
  </fig>
</floats-group>
