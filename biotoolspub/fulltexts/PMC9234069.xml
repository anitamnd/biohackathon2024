<?DTDIdentifier.IdentifierValue -//ES//DTD journal article DTD version 5.6.0//EN//XML?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName art560.dtd?>
<?SourceDTD.Version 5.6.0?>
<?ConverterInfo.XSLTName elsevier2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<?origin publisher?>
<?FILEmeta_XPRO101471 xml ?>
<?FILEmain xml ?>
<?FILEmain pdf ?>
<?FILEgr1 jpg ?>
<?FILEgr2 jpg ?>
<?FILEgr3 jpg ?>
<?FILEgr4 jpg ?>
<?FILEgr5 jpg ?>
<?FILEgr6 jpg ?>
<?FILEgr7 jpg ?>
<?FILEgr8 jpg ?>
<?FILEgr9 jpg ?>
<?FILEgr10 jpg ?>
<?FILEgr11 jpg ?>
<?FILEgr12 jpg ?>
<?FILEgr13 jpg ?>
<?FILEgr14 jpg ?>
<?FILEfx1 jpg ?>
<?FILEfx2 jpg ?>
<?FILEfx3 jpg ?>
<?properties open_access?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">STAR Protoc</journal-id>
    <journal-id journal-id-type="iso-abbrev">STAR Protoc</journal-id>
    <journal-title-group>
      <journal-title>STAR Protocols</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2666-1667</issn>
    <publisher>
      <publisher-name>Elsevier</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">9234069</article-id>
    <article-id pub-id-type="pii">S2666-1667(22)00351-3</article-id>
    <article-id pub-id-type="doi">10.1016/j.xpro.2022.101471</article-id>
    <article-id pub-id-type="publisher-id">101471</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Protocol</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>ukbpheno v1.0: An R package for phenotyping health-related outcomes in the UK Biobank</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" id="au1">
        <name>
          <surname>Yeung</surname>
          <given-names>Ming Wai</given-names>
        </name>
        <email>m.w.yeung@umcg.nl</email>
        <xref rid="aff1" ref-type="aff">1</xref>
        <xref rid="aff2" ref-type="aff">2</xref>
        <xref rid="fn1" ref-type="fn">3</xref>
        <xref rid="fn2" ref-type="fn">4</xref>
        <xref rid="cor1" ref-type="corresp">∗</xref>
      </contrib>
      <contrib contrib-type="author" id="au2">
        <name>
          <surname>van der Harst</surname>
          <given-names>Pim</given-names>
        </name>
        <xref rid="aff1" ref-type="aff">1</xref>
        <xref rid="aff2" ref-type="aff">2</xref>
      </contrib>
      <contrib contrib-type="author" id="au3">
        <name>
          <surname>Verweij</surname>
          <given-names>Niek</given-names>
        </name>
        <email>n.verweij@umcg.nl</email>
        <xref rid="aff1" ref-type="aff">1</xref>
        <xref rid="cor2" ref-type="corresp">∗∗</xref>
      </contrib>
      <aff id="aff1"><label>1</label>University of Groningen, University Medical Center Groningen, Department of Cardiology, 9700 RB Groningen, the Netherlands</aff>
      <aff id="aff2"><label>2</label>Department of Cardiology, Division of Heart &amp; Lungs, University Medical Center Utrecht, University of Utrecht, Utrecht, the Netherlands</aff>
    </contrib-group>
    <author-notes>
      <corresp id="cor1"><label>∗</label>Corresponding author <email>m.w.yeung@umcg.nl</email></corresp>
      <corresp id="cor2"><label>∗∗</label>Corresponding author <email>n.verweij@umcg.nl</email></corresp>
      <fn id="fn1">
        <label>3</label>
        <p id="ntpara0010">Technical contact</p>
      </fn>
      <fn id="fn2">
        <label>4</label>
        <p id="ntpara0015">Lead contact</p>
      </fn>
    </author-notes>
    <pub-date pub-type="pmc-release">
      <day>17</day>
      <month>6</month>
      <year>2022</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on <pub-date
						pub-type="epub">.-->
    <pub-date pub-type="collection">
      <day>16</day>
      <month>9</month>
      <year>2022</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>17</day>
      <month>6</month>
      <year>2022</year>
    </pub-date>
    <volume>3</volume>
    <issue>3</issue>
    <elocation-id>101471</elocation-id>
    <permissions>
      <copyright-statement>© 2022 The Author(s)</copyright-statement>
      <copyright-year>2022</copyright-year>
      <license>
        <ali:license_ref xmlns:ali="http://www.niso.org/schemas/ali/1.0/" specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p>This is an open access article under the CC BY license (http://creativecommons.org/licenses/by/4.0/).</license-p>
      </license>
    </permissions>
    <abstract id="abs0010">
      <title>Summary</title>
      <p>The complexity and volume of data associated with population-based cohorts means that generating health-related outcomes can be challenging. Using one such cohort, the UK Biobank—a major open access resource—we present a protocol to efficiently integrate the main dataset and record-level data files, to harmonize and process the data using an R package named “ukbpheno”. We describe how to use the package to generate binary phenotypes in a standardized and machine-actionable manner.</p>
      <p>For complete details on the use and execution of this protocol, please refer to <xref rid="bib14" ref-type="bibr">Yeung et al. (2022)</xref>.</p>
    </abstract>
    <abstract abstract-type="graphical" id="abs0015">
      <title>Graphical abstract</title>
      <fig id="undfig1" position="anchor">
        <graphic xlink:href="fx1"/>
      </fig>
    </abstract>
    <abstract abstract-type="author-highlights" id="abs0020">
      <title>Highlights</title>
      <p>
        <list list-type="simple" id="ulist0010">
          <list-item id="u0010">
            <label>•</label>
            <p id="p0010">A protocol to efficiently process UK Biobank phenotypic data</p>
          </list-item>
          <list-item id="u0015">
            <label>•</label>
            <p id="p0015">Reproducible and semi-automatic generation of binary health-related phenotypes</p>
          </list-item>
          <list-item id="u0020">
            <label>•</label>
            <p id="p0020">Utilities with visualization to aid data exploration and phenotype definition</p>
          </list-item>
          <list-item id="u0025">
            <label>•</label>
            <p id="p0025">Example analyses common among genetic epidemiological studies</p>
          </list-item>
        </list>
      </p>
    </abstract>
    <abstract abstract-type="editor-highlights" id="abs0025">
      <p>Publisher’s note: Undertaking any experimental protocol requires adherence to local institutional guidelines for laboratory safety and ethics.</p>
    </abstract>
    <abstract abstract-type="teaser" id="abs0030">
      <p>The complexity and volume of data associated with population-based cohorts means that generating health-related outcomes can be challenging. Using one such cohort, the UK Biobank—a major open access resource—we present a protocol to efficiently integrate the main dataset and record-level data files, to harmonize and process the data using an R package named “ukbpheno”. We describe how to use the package to generate binary phenotypes in a standardized and machine-actionable manner.</p>
    </abstract>
    <kwd-group id="kwrds0010">
      <title>Subject areas</title>
      <kwd>Bioinformatics</kwd>
      <kwd>Health Sciences</kwd>
      <kwd>Systems biology</kwd>
    </kwd-group>
  </article-meta>
</front>
<body>
  <sec id="sec1">
    <title>Before you begin</title>
    <p id="p0035">The UK Biobank is a large-scale population cohort with in-depth collection of phenotypic and genetic data (<xref rid="bib7" ref-type="bibr">Sudlow et al., 2015</xref>; <xref rid="bib3" ref-type="bibr">Bycroft et al., 2018</xref>). While it is undoubtedly an invaluable resource for biomedical research, the magnitude of data volume, complexity of information collected as well as the longitudinal nature of data may pose a challenge for researchers to phenotype health related outcomes. The evidence supporting the diagnosis of a certain health outcome may be reported by the participants (during their visits to the assessment centers or online follow-ups) or via linkage to national registries, primary care and secondary care data. The self-report data at the assessment center is further divided into two categories, namely those reported during a nurse interview (Field 20001, 20002, 20003, 20004) and touchscreen (multiple fields) of which customized data-coding systems apply. Reliabilities and coverage of the source in terms of time period as well as proportion of cohort are also likely important factors to consider as well (<xref rid="bib13" ref-type="bibr">Woodfield et al., 2015</xref>; <xref rid="bib4" ref-type="bibr">Eastwood et al., 2016</xref>; <xref rid="bib2" ref-type="bibr">UK Biobank, 2019</xref>). The extent of capture by a data source varies between health outcomes such as in the case of diabetes as reported previously by Eastwood and colleagues (<xref rid="bib4" ref-type="bibr">Eastwood et al., 2016</xref>). An interactive phenotyping process, namely to be able to navigate and explore the data from various sources, is therefore desirable.</p>
    <p id="p0040">In line with the FAIR principle (<xref rid="bib12" ref-type="bibr">Wilkinson et al., 2016</xref>), it is advantageous to transform the data of different sources into a consistent structure with machine readable data / metadata which improves the operability and reproducibility of the phenotyping. Automation of the phenotyping process also helps in reducing human errors. Therefore, we developed an open-access R package (ukbpheno, available at <ext-link ext-link-type="uri" xlink:href="https://github.com/niekverw/ukbpheno" id="intref0020">https://github.com/niekverw/ukbpheno</ext-link>). The package contains functionalities to harmonize data of various sources in a consistent manner accompanied by structured metadata. To allow interactive exploration, the package contains multiple functionalities to visualize the data and it can be run on typical workstations (high-performance computing cluster is not required). <xref rid="fig1" ref-type="fig">Figure 1</xref> illustrates the main concept of data integration and transformation using the ukbpheno package.<fig id="fig1"><label>Figure 1</label><caption><p>Capture of health-related outcome from multiple data sources in UK Biobank using ukbpheno</p></caption><graphic xlink:href="gr1"/></fig></p>
    <p id="p0045">In this protocol, we show how to download and process the data from the UK Biobank as well as to generate health related phenotypes with the use of ukbpheno. More specifically, we utilize the ukbpheno package to first harmonize various data into single episode format and then generate the phenotypes (<xref rid="fig2" ref-type="fig">Figure 2</xref>). We then demonstrate the use of package for in-depth exploration of the harmonized data with example visualizations and analyses. As an example, we demonstrate the ascertainment of type 2 diabetes, considering the rationales put forward by Eastwood and colleagues (outlined in S1 Appendix) (<xref rid="bib4" ref-type="bibr">Eastwood et al., 2016</xref>). We use data from self-report sources (both touchscreen and nurse interview), secondary care data and primary care data to identify people with type 2 diabetes while ruling out other types of diabetes (gestational diabetes and type 1 diabetes) as well as use of metformin due to other conditions. In the second part we show how to automate the phenotyping process, namely to generate multiple cardiometabolic traits used in our previous studies (<xref rid="bib10" ref-type="bibr">van der Harst and Verweij, 2018</xref>; <xref rid="bib11" ref-type="bibr">Verweij et al., 2020</xref>; <xref rid="bib1" ref-type="bibr">Benjamins et al., 2022</xref>; <xref rid="bib14" ref-type="bibr">Yeung et al., 2022</xref>). The diagnosis codes used for these traits are shown in <xref rid="tbl1" ref-type="table">Table 1</xref>. With these phenotypes, we perform some example analyses including the generation of a clinical characteristic table and a survival analysis.<fig id="fig2"><label>Figure 2</label><caption><p>Overview of the workflow</p></caption><graphic xlink:href="gr2"/></fig><table-wrap position="float" id="tbl1"><label>Table 1</label><caption><p>Definitions of the cardiometabolic traits to be generated</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Variable</th><th>ICD-9</th><th>ICD-10</th><th>OPCS-4</th><th>Self-reported fields</th><th>READ2</th><th>CTV3</th></tr></thead><tbody><tr><td>Atrial fibrillation or flutter</td><td>4273</td><td>I48</td><td>K621, K622, K623</td><td>20002(1471, 1483)</td><td>G5730, G573., G5731, G573z, G5733, G5732, 793M0, 793M1, 793M3, 79345, 79348</td><td>XaEga, G573., G5730, G5731, G573z, X202R, X202S, Xa2E8, XaMmd, XaMmc, XaMrB, XaLgF, XaMrA</td></tr><tr><td>Coronary artery disease</td><td>414, 410, 412</td><td>I24, I25, Z955, I21, I22, I23, I252, Z951, Z955</td><td>K40, K41, K42, K43, K44, K45, K46, K49, K50, K75</td><td>20002(1075), 20004(1070, 1095, 1523),6150(1)</td><td>G34y1, G34.., G3..., ZV45L, G34z0, ZV458, 793G., 79280, 79281, 79282, 7928y, 7928z, 79292, 7929y, 7929z, 792.., 7A547, 793Gy, 793Gz, 79283</td><td>G34y1, XE0WG, XE2uV, XaC1g, XaG1Q, XaQiY, ZV458, G34.., X200b, Xa1dP, XaLgU, 79280, 79281, 79282, 7928y, 7928z, 79292, 7929y, 7929z, X00tT, X013N, XE0Em, XaLgZ, XaLga, XaMKE</td></tr><tr><td>Hypertrophic cardiomyopathy</td><td>4251</td><td>I421, I422</td><td/><td>20002(1588)</td><td>G551.</td><td>G551., X201Y</td></tr><tr><td>Heart failure</td><td>428</td><td>I50, I110, I130, I132, Z941, T862</td><td>K02</td><td>20002(1076), 20004(1098)</td><td>14S3., G2101, G2111, G21z1, G232., G234., G58.., G5800, G5802, G5803, G5810, G582., SP084, SP111, G581., 1O1.., G583., ZV421</td><td>14S3., G2101, G2111, G21z1, G232., G234., G58.., G5800, G5802, G5803, G5810, G582., SP084, X202k, X202v, X202w, XE2QG, XaIpn, XaWyi, ZV421, X00y3</td></tr><tr><td>Type 2 diabetes<xref rid="tblfn1" ref-type="table-fn">a</xref></td><td>25000,25002,25010,25012,25020,25022,25030,25032,25040,25042,25050,25052,25060,25062,25070,25072,25080,25082,25090,25092</td><td>E11</td><td/><td>20002(1223)</td><td>C1001, C10F9, C10F., C1093, C1094, C1095, C1097, C10y1, C10z1, C10FJ, C109J, C1099, C10FD, C109D, C10FR, C10FK</td><td>C1001, C1011, C1031, C1071, C1021, C1072, C1093, C1094, C1095, C1097, C10y1, X40J5, X40J6, XaELQ, XaFWI, XaIrf, XaKyX, X40J5</td></tr><tr><td>Hypertension</td><td>402, 403, 404, 405, 401</td><td>I11, I12, I13, I15, O10, I10</td><td/><td>20002(1065, 1072),6150(4),6177(2),6153(2),20003</td><td>G21.., G220., G221., G23.., G24.., G240., G240z, G241., G241z, G24z., L12.., G22.., G22z., G2z.., G2y.., G21z0, G20.., G20z., x01QX</td><td>G21.., G220., G221., G23.., G24.., G240., G240z, G241., G241z, G24z., L12.., XE0Uf, XE0Ug, G2z.., G2y.., Xa0lt, Xa3fQ, Xa0kX, XE0Uc, x01QX</td></tr><tr><td>Hyperlipidemia</td><td>272</td><td>E78</td><td/><td>20002(1473),20003</td><td>C32.., Cyu8D, Cyu8E</td><td>X40Uu, XE11R, C32.., C32z., X40Wx</td></tr></tbody></table><table-wrap-foot><fn id="tspara0015"><p>Variable definitions constructed using ICD-9, ICD-10, OPCS-4, READ2 and CTV3 codes as well as self-report data fields with disease- or procedure-specific codes between brackets are shown.</p></fn><fn id="tspara0020"><p>Abbreviations: CTV3, Clinical Terms Version 3; ICD, International Classification of Diseases; OPCS, Office of Population, Censuses and Surveys: Classification of interventions and Procedure.</p></fn></table-wrap-foot><table-wrap-foot><fn id="tblfn1"><label>a</label><p id="ntpara0020">Cases with type 1 diabetes specific codes are excluded and controls with any diabetes related codes are excluded.</p></fn></table-wrap-foot></table-wrap></p>
    <sec id="sec1.1">
      <title>Download input files from UK Biobank</title>
      <p id="p0050">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 4–12 h</bold>
          </p>
        </disp-quote>
      </p>
      <p id="p0055">Health outcome information is collected in numerous ways. Individual-level data are stored in the main dataset which includes self-report outcomes during the nurse interview, data from cancer registry and death registry. Clinical variables and biomarkers which may be useful for defining a health outcome such as glycated hemoglobin are also stored in the main dataset. Record-level data from hospital inpatient data, primary care data, death registry as well as COVID-19 test results are available through the Data Portal. It is important to note the data from the Data Portal is updated more frequently than the main dataset. As a result, the data in the main dataset and the data from the Data Portal may not be updated at identical dates. Users should be aware of the source of the data and consult the Showcase for the corresponding censoring dates.<disp-quote><p><bold><italic>Note:</italic></bold> The UK Biobank data are an open access resource to any bona-fide researchers. The data analyzed in this protocol were obtained through application number 74395. Please refer to the following link to request access to UK Biobank data: <ext-link ext-link-type="uri" xlink:href="https://www.ukbiobank.ac.uk/enable-your-research/apply-for-access" id="intref0025">https://www.ukbiobank.ac.uk/enable-your-research/apply-for-access</ext-link>.</p></disp-quote><list list-type="simple" id="olist0010"><list-item id="o0010"><label>1.</label><p id="p0060">Download and decrypt the main dataset.<list list-type="simple" id="olist0015"><list-item id="o0015"><label>a.</label><p id="p0065">Follow the steps in section <xref rid="sec2" ref-type="sec">2</xref> of the data access guide (<ext-link ext-link-type="uri" xlink:href="https://biobank.ctsu.ox.ac.uk/%7Ebbdatan/Accessing_UKB_data_v2.3.pdf" id="intref0030">https://biobank.ctsu.ox.ac.uk/∼bbdatan/Accessing_UKB_data_v2.3.pdf</ext-link>) to obtain and decrypt the main dataset from the UK Biobank Data Showcase (Showcase) (<ext-link ext-link-type="uri" xlink:href="https://biobank.ctsu.ox.ac.uk/crystal/download.cgi" id="intref0035">https://biobank.ctsu.ox.ac.uk/crystal/download.cgi</ext-link>). Files needed in this step include:<list list-type="simple" id="olist0020"><list-item id="o0020"><label>i.</label><p id="p0070">An MD5 Checksum to verify download (sent to principal investigator and authorized delegates).</p></list-item><list-item id="o0025"><label>ii.</label><p id="p0075">A key file for decryption (sent to principal investigator and authorized delegates).</p></list-item><list-item id="o0030"><label>iii.</label><p id="p0080">Utilities software “ukbmd5” and “ukbunpack” available on Showcase.</p></list-item></list></p></list-item><list-item id="o0035"><label>b.</label><p id="p0085">Generate a metadata file (.html) of the decrypted main dataset (.enc_ukb) using utility “ukbconv” (available on Showcase).<boxed-text id="dtbox1"><p id="p0090">ukbconv ukbxxxxx.enc_ukb doc</p></boxed-text></p></list-item><list-item id="o0040"><label>c.</label><p id="p0100">Generate a tab-separated file (.tab) of the decrypted main dataset (.enc_ukb) using utility “ukbconv”<boxed-text id="dtbox3"><p id="p0105">ukbconv ukbxxxxx.enc_ukb r</p></boxed-text><disp-quote><p><inline-graphic xlink:href="fx3.gif"/><bold>CRITICAL:</bold> Do not run the accompanied ukbxxxxx.R script generated at this step. Only the tab separated file (.tab) is required.</p></disp-quote></p></list-item></list></p></list-item></list><list list-type="simple" id="olist0025"><list-item id="o0045"><label>2.</label><p id="p0115">Obtain the record-level data from Data Portal on Showcase (<ext-link ext-link-type="uri" xlink:href="https://biobank.ndph.ox.ac.uk/showcase/" id="intref0040">https://biobank.ndph.ox.ac.uk/showcase/</ext-link>).<list list-type="simple" id="olist0030"><list-item id="o0050"><label>a.</label><p id="p0120">Click the “Login” on the top of the webpage which redirects users to the Access Management System.</p></list-item><list-item id="o0055"><label>b.</label><p id="p0125">Once logged in, select “Projects” on the left panel of the Access Management System and view the relevant project (“View/Update”).</p></list-item><list-item id="o0060"><label>c.</label><p id="p0130">Inside the project, select the “Data” tab to connect the Showcase in “logged-in” mode.<list list-type="simple" id="olist0035"><list-item id="o0065"><label>i.</label><p id="p0135">Once in the Showcase, move to “Downloads” tab on the top of the webpage.</p></list-item><list-item id="o0070"><label>ii.</label><p id="p0140">In the “Downloads” page, researchers with access to record-level data will see a tab “Data Portal” next to the tab “Datasets”.</p></list-item><list-item id="o0075"><label>iii.</label><p id="p0145">Connect to the record repository in the “Data Portal” tab.</p></list-item></list></p></list-item><list-item id="o0080"><label>d.</label><p id="p0150">Download the complete data tables (.txt) through the “Table Download” tab.<list list-type="simple" id="olist0040"><list-item id="o0085"><label>i.</label><p id="p0155">Request access to record-level hospital inpatient data via Field 41259.</p></list-item><list-item id="o0090"><label>ii.</label><p id="p0160">Request access to record-level primary care data via Field 42038, 42039 and 42040.</p></list-item><list-item id="o0095"><label>iii.</label><p id="p0165">Request access to record-level death register via Field 40023.</p></list-item></list></p></list-item></list></p></list-item><list-item id="o0100"><label>3.</label><p id="p0170">Obtain the most recent participant withdrawal list for the project.<list list-type="simple" id="olist0045"><list-item id="o0105"><label>a.</label><p id="p0175">This list is sent by the UK Biobank to the principal investigator and delegated collaborators and it contains the identifiers of participants who should be excluded in the analyses.</p></list-item></list></p></list-item></list><disp-quote><p><inline-graphic xlink:href="fx3.gif"/><bold>CRITICAL:</bold> The time required at this step varies depending on the size of dataset that has been approved for the project (please see <xref rid="sec3" ref-type="sec">expected outcomes</xref> for examples).</p></disp-quote></p>
    </sec>
    <sec id="sec1.2">
      <title>Download R and required packages</title>
      <p id="p0180">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 20 min</bold>
          </p>
        </disp-quote>
        <list list-type="simple" id="olist0050">
          <list-item id="o0110">
            <label>4.</label>
            <p id="p0185">Install R (<xref rid="bib5" ref-type="bibr">R Core Team, 2020</xref>) and RStudio (<xref rid="bib6" ref-type="bibr">RStudio Team, 2020</xref>).</p>
          </list-item>
          <list-item id="o0115">
            <label>5.</label>
            <p id="p0190">Install devtools, ukbpheno, data.table, dplyr, tableone, ggforce, ggplot2, survminer and MatchIt (if not installed) inside an R session.</p>
          </list-item>
        </list>
        <boxed-text id="dtbox5">
          <p id="p0195">
install.packages("data.table")
</p>
          <p id="p0200">
install.packages("dplyr")
</p>
          <p id="p0205">
install.packages("ggplot2")
</p>
          <p id="p0210">
install.packages("ggforce")
</p>
          <p id="p0215">
install.packages("tableone")
</p>
          <p id="p0220">
install.packages("survminer")
</p>
          <p id="p0225">
install.packages("MatchIt")
</p>
          <p id="p0230">
install.packages("devtools")
</p>
          <p id="p0235">
devtools::install_github("niekverw/ukbpheno")
</p>
        </boxed-text>
      </p>
      <p id="p0240">There is no hard requirement on R versions for ukbpheno. Results presented in this protocol were produced running with R version 4.0.3 with RStudio version 1.3.959 in a Unix system.<boxed-text id="dtbox6"><p id="p0245">library(data.table)</p><p id="p0250">library(dplyr)</p><p id="p0255">library(ukbpheno)</p><p id="p0260">library(ggplot2)</p><p id="p0265">library(ggforce)</p><p id="p0270">library(tableone)</p><p id="p0275">library(survminer)</p><p id="p0280">library("MatchIt")</p></boxed-text></p>
    </sec>
  </sec>
  <sec id="sec7">
    <title>Key resources table</title>
    <p id="p1855">
      <table-wrap position="float" id="undtbl1">
        <table frame="hsides" rules="groups">
          <thead>
            <tr>
              <th>REAGENT or RESOURCE</th>
              <th>SOURCE</th>
              <th>IDENTIFIER</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="3">
                <bold>Software and algorithms</bold>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <hr/>
              </td>
            </tr>
            <tr>
              <td>R Project for Statistical Computing</td>
              <td>R Core Team</td>
              <td>RRID: SCR_001905<break/><ext-link ext-link-type="uri" xlink:href="https://www.r-project.org/" id="intref0080">https://www.r-project.org/</ext-link></td>
            </tr>
            <tr>
              <td>RStudio</td>
              <td>RStudio Team</td>
              <td>RRID: SCR_000432<break/><ext-link ext-link-type="uri" xlink:href="http://www.rstudio.com/" id="intref0085">http://www.rstudio.com/</ext-link></td>
            </tr>
            <tr>
              <td>ukbpheno</td>
              <td>this paper</td>
              <td><ext-link ext-link-type="uri" xlink:href="https://github.com/niekverw/ukbpheno" id="intref0090">https://github.com/niekverw/ukbpheno</ext-link><break/>Zenodo: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.5281/zenodo.6557829" id="intref0095">https://doi.org/10.5281/zenodo.6557829</ext-link></td>
            </tr>
            <tr>
              <td>ComplexUpset</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=ComplexUpset" id="intref0100">https://cran.r-project.org/package=ComplexUpset</ext-link>
              </td>
            </tr>
            <tr>
              <td>data.table</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=data.table" id="intref0105">https://cran.r-project.org/package=data.table</ext-link>
              </td>
            </tr>
            <tr>
              <td>devtools</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=devtools" id="intref0110">https://cran.r-project.org/package=devtools</ext-link>
              </td>
            </tr>
            <tr>
              <td>dplyr</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=dplyr" id="intref0115">https://cran.r-project.org/package=dplyr</ext-link>
              </td>
            </tr>
            <tr>
              <td>fasttime</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=fasttime" id="intref0120">https://cran.r-project.org/package=fasttime</ext-link>
              </td>
            </tr>
            <tr>
              <td>ggdendro</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=ggdendro" id="intref0125">https://cran.r-project.org/package=ggdendro</ext-link>
              </td>
            </tr>
            <tr>
              <td>ggforce</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=ggforce" id="intref0130">https:// cran.r-project.org/package=ggforce</ext-link>
              </td>
            </tr>
            <tr>
              <td>ggplot2</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=ggplot2" id="intref0135">https://cran.r-project.org/package=ggplot2</ext-link>
              </td>
            </tr>
            <tr>
              <td>ggpubr</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=ggpubr" id="intref0140">https://cran.r-project.org/package=ggpubr</ext-link>
              </td>
            </tr>
            <tr>
              <td>ggrepel</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=ggrepel" id="intref0145">https://cran.r-project.org/package=ggrepel</ext-link>
              </td>
            </tr>
            <tr>
              <td>glue</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=glue" id="intref0150">https://cran.r-project.org/package=glue</ext-link>
              </td>
            </tr>
            <tr>
              <td>jsonlite</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=jsonlite" id="intref0155">https://cran.r-project.org/package=jsonlite</ext-link>
              </td>
            </tr>
            <tr>
              <td>lubridate</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=lubridate" id="intref0160">https://cran.r-project.org/package=lubridate</ext-link>
              </td>
            </tr>
            <tr>
              <td>magrittr</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=magrittr" id="intref0165">https://cran.r-project.org/package=magrittr</ext-link>
              </td>
            </tr>
            <tr>
              <td>MatchIt</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=matrixStats" id="intref0170">https://cran.r-project.org/package=MatchIt</ext-link>
              </td>
            </tr>
            <tr>
              <td>matrixStats</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=matrixStats" id="intref0175">https://cran.r-project.org/package=matrixStats</ext-link>
              </td>
            </tr>
            <tr>
              <td>readxl</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=readxl" id="intref0180">https://cran.r-project.org/package=readxl</ext-link>
              </td>
            </tr>
            <tr>
              <td>RColorBrewer</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=RColorBrewer" id="intref0185">https://cran.r-project.org/package=RColorBrewer</ext-link>
              </td>
            </tr>
            <tr>
              <td>stringr</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=stringr" id="intref0190">https://cran.r-project.org/package=stringr</ext-link>
              </td>
            </tr>
            <tr>
              <td>survminer</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=survminer" id="intref0195">https://cran.r-project.org/package=survminer</ext-link>
              </td>
            </tr>
            <tr>
              <td>tableone</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=tableone" id="intref0200">https://cran.r-project.org/package=tableone</ext-link>
              </td>
            </tr>
            <tr>
              <td>tictoc</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=tictoc" id="intref0205">https://cran.r-project.org/package=tictoc</ext-link>
              </td>
            </tr>
            <tr>
              <td>XML</td>
              <td>The R Foundation</td>
              <td>
                <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=XML" id="intref0210">https://cran.r-project.org/package=XML</ext-link>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <hr/>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <bold>Other</bold>
              </td>
            </tr>
            <tr>
              <td colspan="3">
                <hr/>
              </td>
            </tr>
            <tr>
              <td>UK Biobank</td>
              <td>UK Biobank</td>
              <td>RRID: SCR_012815<break/><ext-link ext-link-type="uri" xlink:href="http://www.ukbiobank.ac.uk/" id="intref0215">http://www.ukbiobank.ac.uk/</ext-link></td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
    </p>
  </sec>
  <sec id="sec2">
    <title>Step-by-step method details</title>
    <sec id="sec2.1">
      <title>Build definition table for target health outcome</title>
      <p id="p0285">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 2–8 h</bold>
          </p>
        </disp-quote>
      </p>
      <p id="p0290">Health outcome information from various data sources / data fields within the main dataset is encoded differently. These relationships have been curated and recorded in the data setting file included in the ukbpheno package. For a target phenotype, survey the various data sources/ data fields on the Showcase and determine the definitions for the target phenotype in UK Biobank. An example definition table to define type 2 diabetes is included in the package. This example table can be used as a template for users to define their target health outcomes.<list list-type="simple" id="olist0055"><list-item id="o0120"><label>1.</label><p id="p0295">Download data setting file (data.settings.tsv) to the project directory from <ext-link ext-link-type="uri" xlink:href="https://github.com/niekverw/ukbpheno/tree/master/inst/extdata/data.settings.tsv" id="intref0045">https://github.com/niekverw/ukbpheno/tree/master/inst/extdata/data.settings.tsv</ext-link>.</p></list-item><list-item id="o0125"><label>2.</label><p id="p0300">Download definition table template to the project directory from <ext-link ext-link-type="uri" xlink:href="https://github.com/niekverw/ukbpheno/tree/master/inst/extdata/definitions_DmRxT2.tsv" id="intref0050">https://github.com/niekverw/ukbpheno/tree/master/inst/extdata/definitions_DmRxT2.tsv</ext-link>.</p></list-item><list-item id="o0130"><label>3.</label><p id="p0305">Fill in one phenotype (such as DmT2) per row. The column “TRAIT” contains the unique identifier of each phenotype which is case sensitive.<list list-type="simple" id="olist0065"><list-item id="o0135"><label>a.</label><p id="p0310">For each of code systems e.g., diagnosis codes ICD10 or operation codes OPCS4 as well as codes used in the self-report fields, fill in the corresponding codes in the table.<list list-type="simple" id="olist0070"><list-item id="o0140"><label>i.</label><p id="p0315">Each code should be separated by a comma.</p></list-item><list-item id="o0145"><label>ii.</label><p id="p0320">For code systems with hierarchical system (refer to data setting file), it is possible to fill in only the parent codes instead of specifying all codes.</p></list-item><list-item id="o0150"><label>iii.</label><p id="p0325">Annotations of the codes can be made using curly bracket “()”.</p><p id="p0330"><xref rid="fig3" ref-type="fig">Figure 3</xref> illustrates an example for the three rules above.<disp-quote><p><bold><italic>Optional:</italic></bold> We included a shiny app to cross-reference codes between systems using the mapping file provided by UK Biobank. (<ext-link ext-link-type="uri" xlink:href="https://github.com/niekverw/ukbpheno/blob/master/inst/util/shiny.lookup_codes.R" id="intref0055">https://github.com/niekverw/ukbpheno/blob/master/inst/util/shiny.lookup_codes.R</ext-link>). Download the code map file (Excel workbook) provided by the UK Biobank (<ext-link ext-link-type="uri" xlink:href="https://biobank.ndph.ox.ac.uk/showcase/refer.cgi?id=592" id="PC_link8zXUCDEttM">https://biobank.ndph.ox.ac.uk/showcase/refer.cgi?id=592</ext-link>): (1) locate the shiny app script and run the shiny app, and (2) visit the address returned (usually in the form of <ext-link ext-link-type="uri" xlink:href="http://127.0.0.1:xxxx" id="PC_link5d69gPHNF1">http://127.0.0.1:xxxx</ext-link>) in a web browser and use the app. A screenshot of the shiny app can be found in <xref rid="fig4" ref-type="fig">Figure 4</xref>.</p></disp-quote><fig id="fig3"><label>Figure 3</label><caption><p>Basic syntax for filling in the definition tables</p></caption><graphic xlink:href="gr3"/></fig><fig id="fig4"><label>Figure 4</label><caption><p>The interface of the shiny app “ukb code explorer”</p></caption><graphic xlink:href="gr4"/></fig></p></list-item></list></p></list-item><list-item id="o0170"><label>b.</label><p id="p0350">Fill in fields with conditions in the “TS” (touchscreen) column.<list list-type="simple" id="olist0080"><list-item id="o0175"><label>i.</label><p id="p0355">Fill in field number as Showcase followed by the condition e.g., “6177=3(insulin)”</p></list-item><list-item id="o0180"><label>ii.</label><p id="p0360"><xref rid="tbl2" ref-type="table">Table 2</xref> shows the conditions symbols accepted: = (equal), != (not equal), &lt;, &lt;=, &gt;, &gt;=, ≥, ≤<table-wrap position="float" id="tbl2"><label>Table 2</label><caption><p>Syntax accepted by the package to describe conditions</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Condition symbol</th><th>Meaning</th></tr></thead><tbody><tr><td>=</td><td>Equal to (value)</td></tr><tr><td>!=</td><td>Not equal to</td></tr><tr><td>&lt;</td><td>Smaller than</td></tr><tr><td>&lt;= OR ≤</td><td>Smaller than or equal to</td></tr><tr><td>&gt;</td><td>Larger than</td></tr><tr><td>&gt;= OR ≥</td><td>Larger than or equal to</td></tr></tbody></table></table-wrap></p></list-item><list-item id="o0185"><label>iii.</label><p id="p0365">Add the corresponding age of diagnosis using “[]” following the condition e.g., “4041=1[2976](Gestational diabetes)”</p></list-item></list></p></list-item></list></p></list-item><list-item id="o0190"><label>4.</label><p id="p0370">It is possible to create a composite phenotype, which involves other phenotypes. Composite phenotypes are constructed using four columns in the definition table (<xref rid="tbl3" ref-type="table">Table 3</xref>).<list list-type="simple" id="olist0090"><list-item id="o0195"><label>a.</label><p id="p0375">“Study_population” can be used to restrict definition on a subgroup of participants with specific phenotype.</p></list-item><list-item id="o0200"><label>b.</label><p id="p0380">Participants with phenotypes in “Include_definition” will be considered to be a case for the composite phenotype.</p></list-item><list-item id="o0205"><label>c.</label><p id="p0385">Users may use the “Exclude_from_cases” and “Exclude_from_controls” column to exclude participants with certain phenotype(s) from cases and controls respectively.</p></list-item></list><table-wrap position="float" id="tbl3"><label>Table 3</label><caption><p>Example usage of composite phenotype columns</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Exclude_from_cases</th><th>Study_population</th><th>Exclude_from_controls</th><th>Include_definitions</th></tr></thead><tbody><tr><td>DmT1</td><td/><td>RxDm</td><td>RxDmOr</td></tr></tbody></table><table-wrap-foot><fn><p>In this example usage: cases with records of “DmT1” (type 1 diabetes) are excluded; Controls with records indicating “RxDm” (use of antidiabetic medication) are excluded; participants with records indicating “RxDmOr” (use of oral antidiabetic medication) will be considered as cases for this composite phenotype.</p></fn></table-wrap-foot></table-wrap></p></list-item></list><disp-quote><p><bold><italic>Note:</italic></bold> For example, a composite phenotype “diabetes mellitus” may include two phenotypes “type 1 diabetes” and “type 2 diabetes”. Alternatively, for the phenotype “type 2 diabetes” we may want to exclude any cases with also a “type 1 diabetes” diagnosis.</p></disp-quote><list list-type="simple" id="olist0095"><list-item id="o0210"><label>5.</label><p id="p0390">The definition table template “definitions_DmRxT2.tsv” contains definitions constructed for the definition of type 2 diabetes in the UK Biobank.<list list-type="simple" id="olist0100"><list-item id="o0215"><label>a.</label><p id="p0395">Trait “DmT2”, “DmT1” and “DmG” contain specific codes for diabetes type 2, type 1 and gestational diabetes respectively;</p></list-item><list-item id="o0220"><label>b.</label><p id="p0400">“RxDm” defines the antidiabetic medication which is further divided into “RxDmIns” (Insulin) and “RxDmOr” (oral antidiabetic drugs);</p></list-item><list-item id="o0225"><label>c.</label><p id="p0405">“Dm” captures general codes for diabetes and the remaining definitions are used to differentiate between type 1 and type 2 diabetes within this group.</p></list-item></list></p></list-item></list></p>
    </sec>
    <sec id="sec2.2">
      <title>Load input files in R</title>
      <p id="p0410">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 15 min</bold>
          </p>
        </disp-quote>
      </p>
      <p id="p0415">Input files required by the package include data files from UK Biobank including the main dataset, the metadata file and optionally data tables from Data Portal; the completed definition table and data setting file.<list list-type="simple" id="olist0105"><list-item id="o0230"><label>6.</label><p id="p0420">Specify data file paths in R.</p></list-item></list><boxed-text id="dtbox7"><p id="p0425"># The directory with data files</p><p id="p0430">pheno_dir &lt;-"mydata/ukb99999/"</p><p id="p0435"># Main dataset</p><p id="p0440">fukbtab &lt;- paste(pheno_dir,"ukb99999.tab",sep="")</p><p id="p0445"># Metadata file</p><p id="p0450">fhtml &lt;- paste(pheno_dir,"ukb99999.html",sep="")</p><p id="p0455"># Hospital inpatient data</p><p id="p0460">fhesin &lt;- paste(pheno_dir,"hesin.txt",sep="")</p><p id="p0465">fhesin_diag &lt;- paste(pheno_dir,"hesin_diag.txt",sep="")</p><p id="p0470">fhesin_oper &lt;- paste(pheno_dir,"hesin_oper.txt",sep="")</p><p id="p0475"># GP data</p><p id="p0480">fgp_clinical &lt;- paste(pheno_dir,"gp_clinical.txt",sep="")</p><p id="p0485">fgp_scripts &lt;- paste(pheno_dir,"gp_scripts.txt",sep="")</p><p id="p0490"># Death registry</p><p id="p0495">fdeath_portal &lt;- paste(pheno_dir,"death.txt",sep="")</p><p id="p0500">fdeath_cause_portal &lt;- paste(pheno_dir,"death_cause.txt",sep="")</p><p id="p0505"># Participant withdrawal list</p><p id="p0510">f_withdrawal&lt;-paste(pheno_dir,"w12345_20210809.csv",sep="")</p></boxed-text><list list-type="simple" id="olist0110"><list-item id="o0235"><label>7.</label><p id="p0515">Specify files paths for the data setting file, the definition table and code maps which are included in the package (extdata/). Alternatively download the files from code repository of ukbpheno hosted at GitHub.</p></list-item></list><boxed-text id="dtbox8"><p id="p0520"># Or download the files from</p><p id="p0525">#<ext-link ext-link-type="uri" xlink:href="https://github.com/niekverw/ukbpheno/tree/master/inst/extdata/" id="intref0070">https://github.com/niekverw/ukbpheno/tree/master/inst/extdata/</ext-link></p><p id="p0530">extdata_dir&lt;-paste0(system.file("extdata", package="ukbpheno"),"/")</p><p id="p0535">fdefinitions &lt;- paste0(extdata_dir,"definitions_DmRxT2.tsv")</p><p id="p0540">fdata_setting &lt;- paste0(extdata_dir,"data.settings.tsv")</p></boxed-text><list list-type="simple" id="olist0115"><list-item id="o0240"><label>8.</label><p id="p0545">Read data setting file. The pre-curated data setting file specifies the characteristics of each data source which are taken into account in the data harmonization process.</p></list-item></list><boxed-text id="dtbox9"><p id="p0550">dfData.settings &lt;- fread(fdata_setting)</p></boxed-text><list list-type="simple" id="olist0120"><list-item id="o0245"><label>9.</label><p id="p0555">Run the “read_definition_table()” function to process the definition table.<list list-type="simple" id="olist0125"><list-item id="o0250"><label>a.</label><p id="p0560">The function “read_definition_table()” expands parent codes using the code maps and sort out codes relevant for inclusion and exclusion accordingly.<list list-type="simple" id="olist0130"><list-item id="o0255"><label>i.</label><p id="p0565">Code maps include all available codes.</p></list-item></list></p></list-item><list-item id="o0260"><label>b.</label><p id="p0570">The function will also cross-check codes entered in the definition with the code maps and warn users of any non-matching codes e.g.,<list list-type="simple" id="olist0135"><list-item id="o0265"><label>i.</label><p id="p0575">A specific ICD10 code may not exist in the UK Biobank ICD10 code map as this code is not present in the data.</p></list-item><list-item id="o0270"><label>ii.</label><p id="p0580">There may be typos.</p></list-item></list></p></list-item></list></p></list-item></list><boxed-text id="dtbox10"><p id="p0585">dfDefinitions_processed_expanded&lt;-read_defnition_table(fdefinitions,fdata_setting,extdata_dir)</p></boxed-text><disp-quote><p><bold><italic>Optional:</italic></bold> Alternatively download the code maps from the UK Biobank Showcase or create them manually by extracting all unique codes from your data using “get_all_exisiting_codes()” which generates flat-form (non-hierarchical) code maps. Adjust the data setting file accordingly.</p></disp-quote><boxed-text id="dtbox11"><p id="p0590"># First input: file path to GP clinical table</p><p id="p0595"># Second input: corresponding column names from the .txt file</p><p id="p0600"># Third input: output file-path</p><p id="p0605">get_all_exsiting_codes(fgp_clinical,c("read_2","read_3"),c("gpclinical.read2.code"," gpclinical.read3.code"))</p></boxed-text></p>
    </sec>
    <sec id="sec2.3">
      <title>Harmonize all data from various sources</title>
      <p id="p0610">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 15–45 min</bold>
          </p>
        </disp-quote>
      </p>
      <p id="p0615">At the harmonization step, we combine all the available data files from various sources and transform them to the format of clinical events to facilitate downstream analyses (<xref rid="fig1" ref-type="fig">Figure 1</xref>). For individual level data including the self-report data, cancer registry and optionally death registry, the corresponding fields containing the information on the diagnosis and time of diagnosis are extracted (in the corresponding data types) from the main dataset and converted to the episodes of clinical events. Touchscreen data are processed according to the conditions described in the definition table, if one is provided. The record level data, downloaded from the Data Portal, will be parsed and reorganized by the data source and classification system.</p>
      <p id="p0620">At the end of the harmonization, all clinical events will be returned in the same episode format. In addition, the original data from main dataset and a full list of participants are also returned.<list list-type="simple" id="olist0140"><list-item id="o0275"><label>10.</label><p id="p0625">Load, process and harmonize all data files using harmonized_ukb_data().<list list-type="simple" id="olist0145"><list-item id="o0280"><label>a.</label><p id="p0630">The “allow_missing_fields” flag specifies whether field(s) required on the definition table but missing in the main dataset is allowed and ignored. If this flag is set to “FALSE”, the harmonization step will halt in case of any missing field.</p></list-item><list-item id="o0285"><label>b.</label><p id="p0635">If the participant withdrawal list is provided, records of these individuals will be removed.</p></list-item></list></p></list-item></list><disp-quote><p><bold><italic>Note:</italic></bold> The function harmonized_ukb_data() harmonizes all available data (minimally works with only the main dataset and meta-data file). Additionally, the function will check if all fields required on the definition table are present in the main dataset and inform the user if any field is missing.</p></disp-quote><boxed-text id="dtbox12"><p id="p0640">lst.harmonized.data&lt;-harmonize_ukb_data(f.ukbtab = fukbtab,f.html = fhtml,dfDefinitions=dfDefinitions_processed_expanded,f.gp_clinical = fgp_clinical,f.gp_scripts = fgp_scripts,f.hesin = fhesin,f.hesin_diag = fhesin_diag,f.hesin_oper =fhesin_oper,f.death_portal = fdeath_portal,f.death_cause_portal = fdeath_cause_portal,f.withdrawal_list=f_withdrawal,allow_missing_fields = TRUE)</p></boxed-text><disp-quote><p><bold><italic>Note:</italic></bold> Time required to harmonize the data is dependent on size of the files. Factors that should be taken into considerations include number of fields approved for the particular project, number of participants included as well as if record-level primary care data are present.</p></disp-quote><list list-type="simple" id="olist0150"><list-item id="o0290"><label>11.</label><p id="p0645">Examine the harmonized data which contains 3 objects: “lst.data”, “dfukb” and “vct.identifiers” (<xref rid="fig5" ref-type="fig">Figure 5</xref>).<boxed-text id="dtbox13"><p id="p0650">View(lst.harmonized.data)</p></boxed-text><list list-type="simple" id="olist0155"><list-item id="o0295"><label>a.</label><p id="p0655">“lst.data” contains data from all sources in same episode format documenting “identifier”, “code”,”eventdate” and an “event” column.<list list-type="simple" id="olist0160"><list-item id="o0300"><label>i.</label><p id="p0660">Diagnosis codes without associated actual event date will have date of visit to assessment center (such as self-report diabetes) in the “eventdate” column and “0” in the “event” indicating that the date does not reflect a true event (<xref rid="fig6" ref-type="fig">Figure 6</xref>).<boxed-text id="dtbox14"><p id="p0665">View(lst.harmonized.data$lst.data)</p></boxed-text><fig id="fig6"><label>Figure 6</label><caption><p>Screenshot of the harmonized records</p></caption><graphic xlink:href="gr6"/></fig></p></list-item></list></p></list-item><list-item id="o0305"><label>b.</label><p id="p0675">“dfukb” is a subset of the main dataset and contains only columns necessary for the definition of target phenotypes.</p></list-item><list-item id="o0310"><label>c.</label><p id="p0680">“vct.identifiers” is a vector of identifiers of all participants in the main dataset.</p></list-item></list><fig id="fig5"><label>Figure 5</label><caption><p>Screenshot of the lst.harmonized.data object</p></caption><graphic xlink:href="gr5"/></fig></p></list-item></list></p>
    </sec>
    <sec id="sec2.4">
      <title>Generate phenotype and explore the data</title>
      <p id="p0685">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 2 h</bold>
          </p>
        </disp-quote>
        <list list-type="simple" id="olist0165">
          <list-item id="o0315">
            <label>12.</label>
            <p id="p0690">To define case/control status of the participants, we need the phenotype (diabetes) definition, the harmonized data tables, the data settings and the individuals to be included (either specified by a vector of participant identifiers or a data-frame containing identifier in the first column and reference dates in the second column).</p>
          </list-item>
        </list>
        <boxed-text id="dtbox16">
          <p id="p0695">
# 1) definition of the target trait “Type 2 diabetes”
</p>
          <p id="p0700">
trait&lt;-"DmRxT2"
</p>
          <p id="p0705">
# 2) harmonized data table - lst.harmonized.data
</p>
          <p id="p0710">
# 3) data setting data-frame - dfData.settings
</p>
          <p id="p0715">
# 4) individuals specified via df_reference_date
</p>
          <p id="p0720">
# Here the dates of baseline visit (f.53.0.0) are taken as reference
</p>
          <p id="p0725">
df_reference_dt_v0&lt;-
</p>
          <p id="p0725a">
lst.harmonized.data$dfukb[,c("identifier","f.53.0.0")]
</p>
        </boxed-text>
        <list list-type="simple" id="olist0170">
          <list-item id="o0320">
            <label>13.</label>
            <p id="p0730">Use “get_cases_controls()” function to obtain the case/control status. The function returns a list of three data.table objects: “df.casecontrol”, “all_event_dt.Include_in_cases” and “all_event_dt.Include_in_cases.summary” (<xref rid="fig7" ref-type="fig">Figure 7</xref>).<boxed-text id="dtbox17"><p id="p0735">lst.DmRxT2.case_control &lt;- get_cases_controls(definitions=dfDefinitions_processed_expanded %&gt;% filter(TRAIT==trait), lst.harmonized.data$lst.data,dfData.settings, df_reference_date=df_reference_dt_v0)</p><p id="p0740">View(lst.DmRxT2.case_control)</p></boxed-text><list list-type="simple" id="olist0175"><list-item id="o0325"><label>a.</label><p id="p0745">“df.casecontrol” is a data.table object of 16 columns providing summary of the diagnosis per participant (<xref rid="tbl4" ref-type="table">Table 4</xref>). Included case/control is marked with 2/1 respectively while excluded case/control will be marked with -2/-1 in this table.<table-wrap position="float" id="tbl4"><label>Table 4</label><caption><p>Column description of the case-control summary table</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Column name</th><th>Information</th></tr></thead><tbody><tr><td>identifier</td><td>Unique identifier of the participant</td></tr><tr><td>reference_date</td><td>The reference dates supplied by user</td></tr><tr><td>count</td><td>Number of episodes/events for that participant related to the target phenotype (diagnosis)</td></tr><tr><td>sum.epidur</td><td>Total number of days hospitalized due to the diagnosis according to secondary care data</td></tr><tr><td>median.epidur</td><td>The median days of hospitalization according to secondary care data</td></tr><tr><td>max.epidur</td><td>The number of days from the longest hospital stay due to the diagnosis.</td></tr><tr><td>survival_days</td><td>Days of survival from the reference date if the participant had died of the diagnosis as evidenced from the death registry</td></tr><tr><td>Death_primary</td><td>Indicates if the participant has died with the diagnosis as primary cause</td></tr><tr><td>Death_any</td><td>Indicates if the participant has died with the diagnosis as either primary or secondary cause</td></tr><tr><td>Hx_days</td><td>Duration of diagnosis in days counting at the reference date</td></tr><tr><td>Fu_days</td><td>Follow-up time until the participant has the diagnosis counting from the reference date</td></tr><tr><td>Hx</td><td>Indicate if the participant has the diagnosis before the reference date (prevalent case)</td></tr><tr><td>Fu</td><td>Indicate if the participant has the diagnosis after the reference date (incident case)</td></tr><tr><td>Ref</td><td>Indicate if the diagnosis was made close to the reference date with a window (default: 0 day)</td></tr><tr><td>first_diagnosis_days</td><td>Difference between first occurrence and reference date (including both Hx and Fu)</td></tr><tr><td>Any</td><td>Indicate if the participant has a diagnosis (including both Hx and Fu)</td></tr></tbody></table></table-wrap></p></list-item><list-item id="o0330"><label>b.</label><p id="p0750">“all_event_dt.Include_in_cases” is data.table object including all event episodes supporting the diagnosis for the cases included (<xref rid="tbl5" ref-type="table">Table 5</xref>).<table-wrap position="float" id="tbl5"><label>Table 5</label><caption><p>Column description of the case event table</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Column name</th><th>Information</th></tr></thead><tbody><tr><td>.id</td><td>Source of this event</td></tr><tr><td>identifier</td><td>Unique identifier of the participant</td></tr><tr><td>code</td><td>Event code</td></tr><tr><td>eventdate</td><td>Event date</td></tr><tr><td>event</td><td>Indicate if this episode contains a true event date (event date from linked data or self-report operation=1, self-report event date except for operations =2, not a true event date=0)</td></tr><tr><td>epidur</td><td>Days hospitalized in this episode documented in secondary care data</td></tr><tr><td>classification</td><td>Refers to the classification system of the code</td></tr></tbody></table></table-wrap></p></list-item><list-item id="o0335"><label>c.</label><p id="p0755">“all_event_dt.Include_in_cases.summary” is a data.table object with the same format with “df.casecontrol” but includes only cases (both included and excluded case).</p></list-item></list><fig id="fig7"><label>Figure 7</label><caption><p>Screenshot of the result obtained from the get_cases_controls() function</p></caption><graphic xlink:href="gr7"/></fig></p>
          </list-item>
          <list-item id="o0340">
            <label>14.</label>
            <p id="p0760">Generate timeline plot to check the relative contribution by various data sources over time (<xref rid="fig8" ref-type="fig">Figure 8</xref>). Events with known event date will be included.<fig id="fig8"><label>Figure 8</label><caption><p>Disease timeline of type 2 diabetes by different data sources</p></caption><graphic xlink:href="gr8"/></fig></p>
          </list-item>
        </list>
        <boxed-text id="dtbox18">
          <p id="p0765">
DmRxT2_timeline&lt;-plot_disease_timeline_by_source(definition=dfDefinitions_processed_expanded%&gt;%filter(TRAIT==trait),lst.harmonized.data$lst.data,dfData.settings, df_reference_dt_v0$identifiers)
</p>
          <p id="p0770">
DmRxT2_timeline
</p>
        </boxed-text>
        <list list-type="simple" id="olist0185">
          <list-item id="o0345">
            <label>15.</label>
            <p id="p0775">Use “make_upsetplot()” to examine the overlaps between the data sources at baseline to gain insight on their relationships (<xref rid="fig9" ref-type="fig">Figure 9</xref>).<fig id="fig9"><label>Figure 9</label><caption><p>UpSet plot of type 2 diabetes at baseline showing the overlaps between different data sources</p></caption><graphic xlink:href="gr9"/></fig></p>
          </list-item>
        </list>
        <boxed-text id="dtbox19">
          <p id="p0780">
upset_plot&lt;-make_upsetplot(definition=dfDefinitions_processed_expanded%&gt;%filter(TRAIT==trait),lst.harmonized.data.gp$lst.data,dfData.settings,df.reference.dates = df_reference_dt_v0)
</p>
          <p id="p0785">
upset_plot
</p>
        </boxed-text>
        <list list-type="simple" id="olist0190">
          <list-item id="o0350">
            <label>16.</label>
            <p id="p0790">Generate summary descriptions on the events with “get_stats_for_events”. For example, generation of a frequency plot of codes among all events from secondary care may help verify or refine the definition (<xref rid="fig10" ref-type="fig">Figure 10</xref>).<fig id="fig10"><label>Figure 10</label><caption><p>Frequency plots of type 2 diabetes diagnosis codes from secondary care</p><p>Left: y-axis in linear scale; Right: y-axis in logarithmic scale.</p></caption><graphic xlink:href="gr10"/></fig></p>
          </list-item>
        </list>
        <boxed-text id="dtbox20">
          <p id="p0795">
# Extract all hospital admission records
</p>
          <p id="p0800">
all_DmRxT2_evnt&lt;-lst.DmRxT2.case_control$all_event_dt.Include_in_cases
</p>
          <p id="p0805">
DmRxT2_hesin_rec&lt;-all_DmRxT2_evnt[grepl ("hesin",all_DmRxT2_evnt$.id)]
</p>
          <p id="p0810">
# Get some descriptive statistics on the records on a code level
</p>
          <p id="p0815">
hesin_stats&lt;-get_stats_for_events(DmRxT2_hesin_rec)
</p>
          <p id="p0820">
hesin_stats$stats.codes.summary.phesin_stats$stats.codes.summary.p
</p>
        </boxed-text>
        <list list-type="simple" id="olist0195">
          <list-item id="o0355">
            <label>17.</label>
            <p id="p0825">Explore secondary care code count by individual (<xref rid="fig11" ref-type="fig">Figure 11</xref>).<fig id="fig11"><label>Figure 11</label><caption><p>Barplot of type 2 diabetes diagnosis code count from secondary care per individual</p></caption><graphic xlink:href="gr11"/></fig></p>
          </list-item>
        </list>
        <boxed-text id="dtbox21">
          <p id="p0830">
# Get some summary statistics on the records on individual level
</p>
          <p id="p0835">
DmRxT2_rec_cnt&lt;-DmRxT2_hesin_rec[,.(count=.N),by=c("identifier")]
</p>
          <p id="p0840">
max(DmRxT2_rec_cnt$count)
</p>
          <p id="p0845">
median(DmRxT2_rec_cnt$count)
</p>
          <p id="p0850">
mean(DmRxT2_rec_cnt$count)
</p>
          <p id="p0855">
quantile(DmRxT2_rec_cnt$count)
</p>
          <p id="p0860">
# Visualize count with barplot with a zoom-in on count between 0-50
</p>
          <p id="p0865">
ggplot2::ggplot(DmRxT2_rec_cnt, ggplot2::aes(x=count)) +
</p>
          <p id="p0870">
 ggplot2::geom_bar(fill="#0073C2FF") + ggplot2::xlab("Number fo secondary care record per person") +
</p>
          <p id="p0875">
 ggplot2::ylab("Frequency") + #theme with white background
</p>
          <p id="p0880">
 ggplot2::theme_bw() + ggplot2::theme(text = ggplot2::element_text(size=22),panel.grid.minor =ggplot2::element_blank(),panel.grid.major =ggplot2::element_blank()) + ggforce::facet_zoom(xlim = c(0, 50))
</p>
        </boxed-text>
        <list list-type="simple" id="olist0200">
          <list-item id="o0360">
            <label>18.</label>
            <p id="p0885">Generate a timeline of the codes contributing to diagnosis for a particular individual (please replace the identifier if copied from the cell below) (<xref rid="fig12" ref-type="fig">Figure 12</xref>).<fig id="fig12"><label>Figure 12</label><caption><p>Diagnosis timeline of a hypothetical participant</p></caption><graphic xlink:href="gr12"/></fig></p>
          </list-item>
        </list>
        <boxed-text id="dtbox22">
          <p id="p0890">
# Plot individual time line
</p>
          <p id="p0895">
plot_individual_timeline(df.data.settings = dfData.settings,lst.data=lst.harmonized.data$lst.data,ind_identifier = 9999999)
</p>
        </boxed-text>
      </p>
      <p id="p0900">To make the definition of the type 2 diabetes more precise, we may screen and exclude individuals with evidence of other types of diabetes as well as the use of metformin not due to diabetes.<list list-type="simple" id="olist0205"><list-item id="o0365"><label>19.</label><p id="p0905">First identify participants with specific diabetes codes (gestational diabetes, type 1 and type 2 diabetes) as well as general diabetes code.</p></list-item></list><boxed-text id="dtbox23"><p id="p0910"># Identify individuals with specific DmT2 codes</p><p id="p0915">lst.DmT2.case_control&lt;-get_cases_controls(definitions=dfDefinitions_processed_expanded %&gt;% filter(TRAIT=="DmT2"), lst.harmonized.data$lst.data,dfData.settings, df_reference_date=df_reference_dt_v0)</p><p id="p0920"># Identify individuals with specific DmT1 codes</p><p id="p0925">lst.DmT1.case_control&lt;-get_cases_controls(definitions=dfDefinitions_processed_expanded %&gt;% filter(TRAIT=="DmT1"), lst.harmonized.data$lst.data,dfData.settings, df_reference_date=df_reference_dt_v0)</p><p id="p0930"># Identify individuals with DmG</p><p id="p0935">lst.DmG.case_control &lt;- get_cases_controls(definitions=dfDefinitions_processed_expanded %&gt;% filter(TRAIT=="DmG"), lst.harmonized.data$lst.data,dfData.settings, df_reference_date=df_reference_dt_v0)</p><p id="p0940"># Identify individuals with general diabetes diagnosis codes excl. medication</p><p id="p0945">lst.Dm.case_control &lt;- get_cases_controls(definitions=dfDefinitions_processed_expanded %&gt;% filter(TRAIT=="Dm"), lst.harmonized.data$lst.data,dfData.settings, df_reference_date=df_reference_dt_v0)</p></boxed-text><list list-type="simple" id="olist0210"><list-item id="o0370"><label>20.</label><p id="p0950">Identify use of different anti-diabetic medications. Find individuals on metformin likely due to diseases other than diabetes by cross checking with the list of individuals with diabetes diagnoses.</p></list-item></list><boxed-text id="dtbox24"><p id="p0955"># Identify individuals with metformin use</p><p id="p0960">lst.RxMet.case_control &lt;- get_cases_controls(definitions=dfDefinitions_processed_expanded %&gt;% filter(TRAIT=="RxMet"), lst.harmonized.data$lst.data,dfData.settings, df_reference_date=df_reference_dt_v0)</p><p id="p0965">#Identify use of insulin/oral diabetic med. excl. metformin</p><p id="p0970">lst.RxDmNoMet.case_control &lt;- get_cases_controls(definitions=dfDefinitions_processed_expanded %&gt;% filter(TRAIT=="RxDmNoMet"), lst.harmonized.data$lst.data,dfData.settings, df_reference_date=df_reference_dt_v0)</p><p id="p0975">#Identify individuals that are on metformin but no diabetes codes</p><p id="p0980">#nor medication other than metformin</p><p id="p0985">RxMet_DmUnlikely&lt;-setdiff(lst.RxMet.case_control$df.casecontrol[Hx==2]$identifier,union(lst.Dm.case_control$df.casecontrol[Hx==2]$identifier,lst.RxDmNoMet.case_control$df.casecontrol[Hx==2]$identifier))</p></boxed-text><list list-type="simple" id="olist0215"><list-item id="o0375"><label>21.</label><p id="p0990">Cross-examine various diagnoses. For example we want to get individuals with young onset diabetes but did not have records supporting a diagnosis of non-type 2 diabetes. Namely these individuals did not have evidence of type 1 diabetes nor gestational diabetes.<list list-type="simple" id="olist0220"><list-item id="o0380"><label>a.</label><p id="p0995">We identify these individuals via set operations of the relevant diagnoses.</p></list-item><list-item id="o0385"><label>b.</label><p id="p1000">Inspect the records of these individuals for evidence of type 2 diabetes.</p></list-item></list></p></list-item></list><boxed-text id="dtbox25"><p id="p1005"># Identify individuals with self-report insulin &lt;12 months post-diagnosis</p><p id="p1010">lst.RxDmInsFirstYear.case_control&lt;-get_cases_controls(definitions=dfDefinitions_processed_expanded %&gt;% filter(TRAIT=="RxDmInsFirstYear"), lst.harmonized.data$lst.data,dfData.settings, df_reference_date=df_reference_dt_v0)</p><p id="p1015"># Identify young onset self reported diabetes (European origin)</p><p id="p1020">lst.SrDmYEw.case_control &lt;- get_cases_controls(definitions=dfDefinitions_processed_expanded %&gt;% filter(TRAIT=="SrDmYEw"), lst.harmonized.data$lst.data,dfData.settings, df_reference_date=df_reference_dt_v0)</p><p id="p1025"># identify young onset self reported diabetes (Caribbean African origin)</p><p id="p1030">lst.SrDmYSaCa.case_control &lt;- get_cases_controls(definitions=dfDefinitions_processed_expanded %&gt;% filter(TRAIT=="SrDmYSaCa"), lst.harmonized.data$lst.data,dfData.settings, df_reference_date=df_reference_dt_v0)</p><p id="p1035"># Individuals of young onset diabetes</p><p id="p1040">ind_young_onset&lt;- union(lst.SrDmYSaCa.case_control$df.casecontrol[Any==2]$identifier,lst.SrDmYEw.case_control$df.casecontrol[Any==2]$identifier)</p><p id="p1045"># Individuals with evidence of other types of diabetes reported</p><p id="p1050">ind_RxInsFirstYear_DmT1_DmG&lt;- union(union(lst.RxDmInsFirstYear.case_control$df.casecontrol[Any==2]$identifier,lst.DmT1.case_control$df.casecontrol[Hx==2]$identifier),lst.DmG.case_control$df.casecontrol[Hx==2]$identifier)</p><p id="p1055"># Young onset but no DM type 1/ gestational diabetes specific codes nor self report of insulin within first year of diagnosis</p><p id="p1060">inds_young_onset_possible_DmT2 &lt;-setdiff(ind_young_onset,ind_RxInsFirstYear_DmT1_DmG)</p><p id="p1065"># Check the records of these individuals</p><p id="p1070">lst.DmRxT2.case_control$all_event_dt.Include_in_cases[identifier %in% inds_young_onset_probable_DmT2]</p></boxed-text></p>
    </sec>
    <sec id="sec2.5">
      <title>Generate phenotypes in batch</title>
      <p id="p1075">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 15–30 min</bold>
          </p>
        </disp-quote>
      </p>
      <p id="p1080">This session demonstrates how to generate multiple phenotypes and make a clinical characteristics table with these phenotypes, stratified by type 2 diabetes status. An example definition table with the selected cardiometabolic diseases, family history of these diseases and diabetes medication usage is provided in the package. We additionally extract demographic information namely age and sex as well as biomarkers BMI, blood glucose, glycated hemoglobin and self-report insulin use within one year of diabetes diagnosis from the main dataset.<list list-type="simple" id="olist0225"><list-item id="o0390"><label>22.</label><p id="p1085">Read and process the definition file.</p></list-item></list><boxed-text id="dtbox26"><p id="p1090"># Read the definitions table</p><p id="p1095">fdefinitions &lt;- paste0(extdata_dir,"definitions_cardiometabolic_traits.tsv")</p><p id="p1100">dfDefinitions_processed_expanded&lt;-read_defnition_table(fdefinitions,fdata_setting, extdata_dir)</p></boxed-text><list list-type="simple" id="olist0230"><list-item id="o0395"><label>23.</label><p id="p1105">Extract only the required fields from the main dataset using read_ukb_tabdata().<list list-type="simple" id="olist0235"><list-item id="o0400"><label>a.</label><p id="p1110">The metadata provides information such as data type of these fields.</p></list-item><list-item id="o0405"><label>b.</label><p id="p1115">Extract age at assessment center visit (Field 21003), sex (Field 31), body mass index (Field 21001), glycated hemoglobin level (Field 30750), glucose level (Field 30740), self-report insulin use within the first year of diabetes diagnosis (Field 2986), UK Biobank assessment center visited (Field 54) and Date of attending assessment center (Field 53).</p></list-item></list></p></list-item></list><boxed-text id="dtbox27"><p id="p1120"># Extract clinical variables from the main dataset using read_ukb_tabdata()</p><p id="p1125"># We need the metadata (.html) file for read_ukb_tabdata()</p><p id="p1130">dfhtml &lt;- read_ukb_metadata(fhtml)</p><p id="p1135"># Rename the identifier column in the metadata</p><p id="p1140">dfhtml[which(dfhtml$field.tab=="f.eid"),]$field.tab&lt;-"identifier"</p><p id="p1145"># Age at assessment center visit, sex, BMI, HbA1c, glucose,insulin within 1 year of diagnosis,UK Biobank assessment center location, date of visit</p><p id="p1150">baseline_fields&lt;-c(21003,31,21001,30750,30740,2986,54,53)</p><p id="p1155"># Extract these variables from main dataset</p><p id="p1160">dfukb_baseline &lt;- read_ukb_tabdata(fukbtab,dfhtml,fields_to_keep = baseline_fields)</p><p id="p1165">gc()</p></boxed-text><list list-type="simple" id="olist0240"><list-item id="o0410"><label>24.</label><p id="p1170">Generate the phenotypes for atrial fibrillation, coronary artery disease, type 2 diabetes, hypertrophic cardiomyopathy, heart failure, hypertension and hyperlipidemia with a loop and merge the phenotype information into one table “dfukb_baseline_pheno”.</p></list-item></list><boxed-text id="dtbox28"><p id="p1175"># The target disease traits we will generate in batch</p><p id="p1180">diseases&lt;-c("Af","Cad","DmT2","Hcm","Hf","HtRx","HyperLipRx")</p><p id="p1185"># Make an output folder to store the result</p><p id="p1190">out_folder&lt;-paste0(pheno_dir,"output/")</p><p id="p1195">if(!dir.exists(file.path(out_folder))){</p><p id="p1200">dir.create(file.path(out_folder))</p><p id="p1205">}</p><p id="p1210">df_withdrawal&lt;-fread(f_withdrawal)</p><p id="p1215"># remove withdrawn participants</p><p id="p1220">dfukb_baseline_pheno&lt;-dfukb_baseline[! identifier %in% df_withdrawal$V1]</p><p id="p1225"># Loop through the traits, including family history of related diseases and the diabetes medication use</p><p id="p1230">for (disease in c(diseases,"HxDm","HxHrt","HxHt","RxDmOr","RxDmIns")){</p><p id="p1235">print(disease)</p><p id="p1240">lst.case_control &lt;- get_cases_controls(definitions=dfDefinitions_processed_expanded %&gt;% filter(TRAIT==disease), lst.harmonized.data$lst.data,dfData.settings, df_reference_date=df_reference_dt_v0)</p><p id="p1245"> # Add the trait to the column names</p><p id="p1250">colnames(lst.case_control$df.casecontrol) &lt;- paste(disease,"0",colnames(lst.case_control$df.casecontrol), sep = "_")</p><p id="p1255"> # Except for participant identifier</p><p id="p1260">names(lst.case_control$df.casecontrol)[names(lst.case_control$df.casecontrol) == paste(disease,"0","identifier", sep = "_")]&lt;-"identifier"</p><p id="p1265"># Merge these columns with dfukb_baseline_pheno</p><p id="p1270">dfukb_baseline_pheno&lt;-merge(dfukb_baseline_pheno,lst.case_control$df.casecontrol,by="identifier",all.x = TRUE,all.y = FALSE)</p><p id="p1275">}</p></boxed-text></p>
    </sec>
    <sec id="sec2.6">
      <title>Report clinical characteristics at baseline</title>
      <p id="p1280">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 10 min</bold>
          </p>
        </disp-quote>
      </p>
      <p id="p1285">In the following example analyses, we investigate the characteristics of participants with type 2 diabetes specific codes. We exclude the cases with type 1 diabetes diagnosis codes and we exclude any controls with non-specific diabetes codes (<xref rid="tbl6" ref-type="table">Table 6</xref>).<list list-type="simple" id="olist0245"><list-item id="o0415"><label>25.</label><p id="p1290">Select variables to be reported in the clinical characteristics table. Rename the variables in the table to improve readability. Create the clinical characteristics table stratified by type 2 diabetes. Write the clinical characteristic table to a file.</p></list-item></list><boxed-text id="dtbox29"><p id="p1295"># Keep only the variables needed for the table</p><p id="p1300">dfukb_baseline_pheno_fortable1&lt;-dfukb_baseline_pheno[,c('identifier',"DmT2_0_Hx","f.21003.0.0","f.21001.0.0","f.30740.0.0","f.30750.0.0","DmT2_0_first_diagnosis_days","f.31.0.0","HxDm_0_Any","HxHrt_0_Any","HxHt_0_Any","HtRx_0_Hx","HyperLipRx_0_Hx","Af_0_Hx","Hcm_0_Hx","Hf_0_Hx","RxDmOr_0_Hx","RxDmIns_0_Hx","f.2986.0.0"),with=FALSE]</p><p id="p1305"># Negative first diagnosis day indicates history while positive indicates follow-up cases</p><p id="p1310">dfukb_baseline_pheno_fortable1$DmT2_0_first_diagnosis_years&lt;-(-1∗dfukb_baseline_pheno_fortable1$DmT2_0_first_diagnosis_days)/365.25</p><p id="p1315"># Rename for readability</p><p id="p1320">colnames(dfukb_baseline_pheno_fortable1)&lt;-c("identifier","Type 2 diabetes","Age","BMI","Glucose","HbA1c","Days since type 2 diabetes diagnosis","Sex","Family history of diabetes","Family history of heart disease","Family history of hypertension","Hypertension","Hyperlipidemia","Atrial fibrillation","Hypertrophic cardiomyopathy","Heart failure","Oral diabetes medication","Insulin","Insulin within 1 year of diagnosis","Years since type 2 diabetes diagnosis")</p><p id="p1325"># Below the parameters for CreateTableOne</p><p id="p1330"># The full variable list</p><p id="p1335">vars&lt;-c("Age","BMI","Glucose","HbA1c","Years since type 2 diabetes diagnosis","Sex","Family history of diabetes","Family history of heart disease","Family history of hypertension","Hypertension","Hyperlipidemia","Atrial fibrillation","Hypertrophic cardiomyopathy","Heart failure","Oral diabetes medication","Insulin","Insulin within 1 year of diagnosis")</p><p id="p1340"># The categorical variables on the clinical characteristics table</p><p id="p1345">factorVars&lt;-setdiff(vars,c("Age","BMI","Glucose","HbA1c","Years since type 2 diabetes diagnosis"))</p><p id="p1350"># Create the clinical characteristic table stratified by type 2 diabetes</p><p id="p1355">tableOne &lt;- CreateTableOne(vars = vars, strata = "Type 2 diabetes", data = dfukb_baseline_pheno_fortable1, factorVars = factorVars)</p><p id="p1360">hist(dfukb_baseline_pheno_fortable1$`Years since type 2 diabetes diagnosis`)</p><p id="p1365">tableOne</p><p id="p1370">tab1Mat &lt;- print(tableOne, quote = FALSE, noSpaces = TRUE, printToggle = FALSE,nonnormal =c("Glucose","HbA1c","Years since type 2 diabetes diagnosis"))</p><p id="p1375"># Save the table to a CSV file</p><p id="p1380">write.csv(tab1Mat, file =paste0(out_folder,"BaselineTable.csv"))</p></boxed-text><table-wrap position="float" id="tbl6"><label>Table 6</label><caption><p>Inclusion and exclusion criteria for the phenotype type 2 diabetes</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Exclude_from_cases</th><th>Study_population</th><th>Exclude_from_controls</th><th>Include_definitions</th></tr></thead><tbody><tr><td>DmT1</td><td/><td>DmRx</td><td/></tr></tbody></table></table-wrap></p>
    </sec>
    <sec id="sec2.7">
      <title>Survival analysis on heart failure stratified by type 2 diabetes</title>
      <p id="p1385">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 5 min</bold>
          </p>
        </disp-quote>
        <list list-type="simple" id="olist0250">
          <list-item id="o0420">
            <label>26.</label>
            <p id="p1390">With time-to-event data as well as the censoring dates for different data sources for different regions, compute the observed time for each participant.<list list-type="simple" id="olist0255"><list-item id="o0425"><label>a.</label><p id="p1395">The start time is the date when the participant visited the assessment center;</p></list-item><list-item id="o0430"><label>b.</label><p id="p1400">Observed time is up to date of event or earliest among date of death and censoring date of hospital inpatient records (last follow up).</p></list-item></list></p>
          </list-item>
        </list>
        <boxed-text id="dtbox30">
          <p id="p1405">
# Get death dates from data
</p>
          <p id="p1410">
deathdt&lt;-unique(lst.harmonized.data$lst.data$tte.death.icd10.primary[,.(identifier,eventdate)])
</p>
          <p id="p1415">
# Rename the column and merge
</p>
          <p id="p1420">
colnames(deathdt)&lt;-c("identifier","deathdt")
</p>
          <p id="p1425">
dfukb_baseline_pheno&lt;-merge(dfukb_baseline_pheno,deathdt,by="identifier",all.x=TRUE,all.y = FALSE)
</p>
          <p id="p1430">
# HESIN censoring date are different by regions
</p>
          <p id="p1435">
# Use the UK Biobank assessment center location attended by the participants
</p>
          <p id="p1440">
england&lt;-c("10003","11001","11002","11007","11008","11009","11010","11011","11012","11013","11014","11016","11017","11018","11019","11020","11021")
</p>
          <p id="p1445">
scotland&lt;-c("11004","11005")
</p>
          <p id="p1450">
wales&lt;-c("11003","11022", "11006","11023")
</p>
          <p id="p1455">
# Corresponding censoring dates
</p>
          <p id="p1460">
dfukb_baseline_pheno[dfukb_baseline_pheno$f.54.0.0 %in% england,"censordateHES"]&lt;-as.Date("2021-03-31")
</p>
          <p id="p1465">
dfukb_baseline_pheno[dfukb_baseline_pheno$f.54.0.0 %in% scotland,"censordateHES"]&lt;-as.Date("2021-03-31")
</p>
          <p id="p1470">
dfukb_baseline_pheno[dfukb_baseline_pheno$f.54.0.0 %in% wales,"censordateHES"]&lt;-as.Date("2018-02-28")
</p>
          <p id="p1475">
# Time-to-event/observed time is determined at earliest of date of event, date of death and censoring date of HESIN data (last follow up)
</p>
          <p id="p1480">
# This is already calculated for those who have events
</p>
          <p id="p1485">
range(dfukb_baseline_pheno[Hf_0_Fu==2,Hf_0_Fu_days])
</p>
          <p id="p1490">
# non-event but died before HESIN censoring date
</p>
          <p id="p1495">
dfukb_baseline_pheno[Hf_0_Fu==1 &amp; !is.na(deathdt) &amp; deathdt-censordateHES&lt;=0,Hf_0_Fu_days:=deathdt-as.Date(f.53.0.0)]
</p>
          <p id="p1500">
# People censored at last fu
</p>
          <p id="p1505">
# non-event but died after censoring date (HESIN),
</p>
          <p id="p1510">
dfukb_baseline_pheno[Hf_0_Fu==1 &amp;!is.na(deathdt)&amp; deathdt-censordateHES&gt;0,Hf_0_Fu_days:=censordateHES-as.Date(f.53.0.0)]
</p>
          <p id="p1515">
# non-event and alive by censoring date
</p>
          <p id="p1520">
dfukb_baseline_pheno[Hf_0_Fu==1 &amp;is.na(deathdt),Hf_0_Fu_days:=censordateHES-as.Date(f.53.0.0)]
</p>
        </boxed-text>
        <list list-type="simple" id="olist0260">
          <list-item id="o0435">
            <label>27.</label>
            <p id="p1525">Create the survival object and Kaplan-Meier plot for new onset heart failure stratified by type 2 diabetes status at baseline.</p>
          </list-item>
        </list>
        <boxed-text id="dtbox31">
          <p id="p1530">
#Estimate risk of new onset heart failure by presence/absence of type 2 diabetes at baseline
</p>
          <p id="p1535">
fit&lt;-survival::survfit(survival::Surv(Hf_0_Fu_days/365.25,Hf_0_Fu) ∼ DmT2_0_Hx, data = dfukb_baseline_pheno[DmT2_0_Hx&gt;0])
</p>
          <p id="p1540">
# summary(fit)
</p>
          <p id="p1545">
# Make Kaplan-Meier plot
</p>
          <p id="p1550">
ggsurvplot(fit, data = dfukb_baseline_pheno[DmT2_0_Hx&gt;0], size = 0.8,
</p>
          <p id="p1555">
 break.time.by=2,
</p>
          <p id="p1560">
 xlab = "Follow up (years)",
</p>
          <p id="p1565">
 censor.size=2,
</p>
          <p id="p1570">
 palette = c("#072A6C", "#FF8400"),
</p>
          <p id="p1575">
 conf.int = TRUE, # Add confidence interval
</p>
          <p id="p1580">
 pval = TRUE, # Add p-value
</p>
          <p id="p1585">
 risk.table = TRUE, # Add risk table
</p>
          <p id="p1590">
 risk.table.col = "strata", # Risk table color by groups
</p>
          <p id="p1595">
 legend.labs = c("No type 2 diabetes at baseline","Type 2 diabetes at baseline"),
</p>
          <p id="p1600">
 risk.table.height = 0.2)
</p>
        </boxed-text>
      </p>
    </sec>
    <sec id="sec2.8">
      <title>Case-control matching with MatchIt</title>
      <p id="p1605">
        <disp-quote>
          <p>
            <inline-graphic xlink:href="fx2.gif"/>
            <bold>Timing: 5 min</bold>
          </p>
        </disp-quote>
      </p>
      <p id="p1610">Sometimes it may be desirable to match cases and controls by characteristics such as age and sex in certain studies. Here we demonstrate how to further process phenotypes created in ukbpheno to generate matched case-control pairs. We utilize an R package MatchIt for the matching task.<list list-type="simple" id="olist0265"><list-item id="o0440"><label>28.</label><p id="p1615">To match type 2 diabetes case to control by age, sex and body mass index. We extract those variables and remove individuals with missing values in either the target phenotype or any covariates.</p></list-item></list><boxed-text id="dtbox32"><p id="p1620">########################################</p><p id="p1625"># 1:2 case control matching with MatchIt</p><p id="p1630">########################################</p><p id="p1635">#library(“MatchIt”)</p><p id="p1640"># Remove individuals with either missing or excluded phenotype for target phenotype (type 2 diabetes at baseline)</p><p id="p1645">df_to_matchit&lt;-dfukb_baseline_pheno[!is.na(DmT2_0_Hx) &amp; DmT2_0_Hx&gt;0]</p><p id="p1650"># Pick three covariates age at assessment center visit, sex and BMI for matching</p><p id="p1655">df_to_matchit&lt;-na.omit(df_to_matchit[,.(identifier,DmT2_0_Hx,f.21003.0.0,f.31.0.0,f.21001.0.0)])</p></boxed-text><list list-type="simple" id="olist0270"><list-item id="o0445"><label>29.</label><p id="p1660">Format the coding of the phenotype and name the rows by participant identifier in preparation for the matchit() function. Run the matchit() function to match 2 controls to each case. Examine the result.</p></list-item></list><boxed-text id="dtbox33"><p id="p1665"># Format the data for the matchit function</p><p id="p1670"># Control/case: 1/2 to 0/1</p><p id="p1675">df_to_matchit$DmT2_0_Hx&lt;-df_to_matchit$DmT2_0_Hx-1</p><p id="p1680"># Name the rows</p><p id="p1685">rownames(df_to_matchit)&lt;-df_to_matchit$identifier</p><p id="p1690">colnames(df_to_matchit)&lt;-c("identifier","Type 2 diabetes","Age","Sex","BMI")</p><p id="p1695"># Run matchit</p><p id="p1700">m.dm2&lt;-matchit(`Type 2 diabetes`∼Age + Sex+BMI,data=df_to_matchit,ratio=2)</p><p id="p1705">#Check result</p><p id="p1710">summary(m.dm2)</p><p id="p1715"># Each row in the match.matrix shows identifier of one case with 2 matched controls</p><p id="p1720">m.dm2$match.matrix</p></boxed-text></p>
    </sec>
  </sec>
  <sec id="sec3">
    <title>Expected outcomes</title>
    <sec id="sec3.1">
      <title>Harmonization of UK Biobank data</title>
      <p id="p1725">After the harmonization step, the user should have in the R workspace the data from both Data Portal (record level data) as well as a subset of the main dataset relevant for the target phenotypes (as specified in the definition table). Users can perform further analyses in R as they see fit (see reporting of clinical characteristics, survival analysis and case-control matching sections).</p>
      <p id="p1730">Using our machine with 64 GB RAM (DDR4 2667 MHz) and 10-core processor (Intel Skylake) under an Ubuntu 16 system, it took 12 min to load and process the main dataset and all record level files. Of which the most time-consuming step was loading the main dataset (six minutes with file size 35.5 GB) followed by the primary care data (three and half minutes with total file size 8.5 GB). The harmonization step was additionally tested on an Ubuntu 16 machine with 16 GB RAM (DDR4 2667 MHz) and 6-core processor (AMD Ryzen 5). It took approximately 45 minutes to complete on this machine.</p>
    </sec>
    <sec id="sec3.2">
      <title>Ascertainment of diabetes status</title>
      <p id="p1735">The “get_cases_controls()” function from ukbpheno determines the case/control status for a target phenotype following the inclusion/exclusion criteria outlined in the definition table. Users can extract prevalent as well as incident cases with a specific reference time point. Results presented in this protocol are produced using data downloaded in June 2021, with primary care data for around 45% of the UK Biobank cohort available and data censoring dates shown in <xref rid="tbl7" ref-type="table">Table 7</xref> (<xref rid="bib9" ref-type="bibr">UK Biobank, 2022b</xref>).<table-wrap position="float" id="tbl7"><label>Table 7</label><caption><p>Censoring dates of different data sources</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Data (provider)</th><th>Censoring date</th></tr></thead><tbody><tr><td>Primary care - England (TPP)</td><td>31May2016</td></tr><tr><td>Primary care - England (Vision)</td><td>31May2017</td></tr><tr><td>Primary care - Scotland</td><td>31Mar2017</td></tr><tr><td>Primary care - Wales</td><td>31Aug2017</td></tr><tr><td>Secondary care - England</td><td>31Mar2021</td></tr><tr><td>Secondary care - Scotland</td><td>31Mar2021</td></tr><tr><td>Secondary care - Wales</td><td>28Feb2018</td></tr><tr><td>Cancer - England/Wales</td><td>31Jul2019</td></tr><tr><td>Cancer - Scotland</td><td>31Oct2015</td></tr><tr><td>Death - England/Wales</td><td>28Feb2021</td></tr><tr><td>Death - Scotland</td><td>28Feb2021</td></tr></tbody></table><table-wrap-foot><fn><p>The censoring dates for the current release can be found in Showcase (<ext-link ext-link-type="uri" xlink:href="https://biobank.ndph.ox.ac.uk/showcase/exinfo.cgi?src=Data_providers_and_dates" id="intref0245">https://biobank.ndph.ox.ac.uk/showcase/exinfo.cgi?src=Data_providers_and_dates</ext-link>).</p></fn></table-wrap-foot></table-wrap></p>
      <p id="p1740">Following the example definition of “DmRxT2”, users should expect a prevalence of 4.7% at the baseline visit, an estimate close to (<xref rid="bib4" ref-type="bibr">Eastwood et al., 2016</xref>). Additionally, it can be observed in the disease timeline (<xref rid="fig8" ref-type="fig">Figure 8</xref>) as well as the UpSet plot (<xref rid="fig9" ref-type="fig">Figure 9</xref>) that the majority of prevalent cases during baseline visit periods were attributed to self-report sources rather than secondary care (hesin) and hence use of secondary care alone for ascertainment would miss out a lot of cases, as reported by Eastwood and colleagues.</p>
      <p id="p1745">Examining the diabetes diagnoses captured in secondary care system, user should be able to obtain similar frequency plots as shown in <xref rid="fig10" ref-type="fig">Figure 10</xref>. Counts of diagnosis code per individual have a highly skewed distribution with median of 3 records from the secondary care (<xref rid="fig11" ref-type="fig">Figure 11</xref>).</p>
      <p id="p1750">With the plot_individual_timeline() function, user should expect visualization of diagnosis codes of a selected participant over time. <xref rid="fig12" ref-type="fig">Figure 12</xref> shows such a timeline of a hypothetical participant.</p>
      <p id="p1755">Lastly in the cross-examinations with other types of diabetes and medication, users should expect similar numbers as reported in the prevalence algorithms by Eastwood and colleagues (<xref rid="bib4" ref-type="bibr">Eastwood et al., 2016</xref>). Users could verify these conditions by inspecting the records in the harmonized data or further investigate with other information (such as the biomarker / genetics). For instance, users should be able to observe that around 300 individuals with young onset diabetes received an E119 diagnosis after their baseline visits.</p>
    </sec>
    <sec id="sec3.3">
      <title>Phenotype generation in batch</title>
      <p id="p1760">In this part users should be able to generate the cardiometabolic phenotypes namely, atrial fibrillation or flutter, coronary artery disease, hypertrophic cardiomyopathy, heart failure, type 2 diabetes, hypertension and hyperlipidemia. Users should also obtain the related phenotypes including family history of diabetes, family history of heart disease, family history of hypertension and the use of diabetes medications. Using our machine with 64 GB RAM (DDR4 2667 MHz) and 10-core processor (Skylake), it took three minutes to process all 12 phenotypes.</p>
    </sec>
    <sec id="sec3.4">
      <title>Report clinical characteristics at baseline and survival analysis</title>
      <p id="p1765">In this part users should obtain a clinical characteristics table stratified by type 2 diabetes status (<xref rid="tbl8" ref-type="table">Table 8</xref>). The diagnosis was ascertained with only type 2 diabetes specific diagnosis codes; potential cases with type 1 diabetes specific diagnosis codes (at any time point) were excluded; potential controls with any diabetes diagnosis codes or medications were also excluded. This resulted in four stratified groups in the table – “Case inclusion”, “Case exclusion”, “Control inclusion” and “Control exclusion”. It can be observed that the group of “Case exclusion” had the highest blood glucose and glycated hemoglobin. The proportion of “Case exclusion” (with specific type 1 diabetes diagnosis codes) on insulin was also the highest with the highest percentage of starting insulin within the first year of diagnosis. Higher blood glucose and glycated hemoglobin as well as proportion of diabetes medication can be observed in the group of “Control exclusion” (with non-specific diabetes diagnosis codes - evidence of diabetes but no type 1 / type 2 specific records at baseline) than the “Control inclusion” group. The non-zero percentage of use of diabetes medication (oral diabetes medication / insulin) at baseline observed in the “Control inclusion” group was likely individuals with pre-diabetes; while the negative values of “Years since type 2 diabetes diagnosis” observed were due to the individuals who received diabetes diagnosis sometime after their baseline visits (incident cases).<table-wrap position="float" id="tbl8"><label>Table 8</label><caption><p>Clinical characteristics table stratified by type 2 diabetes at baseline visit</p></caption><table frame="hsides" rules="groups"><thead><tr><th/><th>Case inclusion</th><th>Case exclusion</th><th>Control inclusion</th><th>Control exclusion</th><th><italic>p</italic></th></tr></thead><tbody><tr><td>n</td><td>13286</td><td>4029</td><td>478864</td><td>6279</td><td/></tr><tr><td>Age (mean (SD))</td><td>60.32 (6.75)</td><td>59.37 (7.33)</td><td>56.40 (8.10)</td><td>56.32 (8.20)</td><td>&lt;0.001</td></tr><tr><td>BMI (mean (SD))</td><td>31.81 (5.90)</td><td>31.13 (6.06)</td><td>27.26 (4.67)</td><td>29.12 (5.51)</td><td>&lt;0.001</td></tr><tr><td>Glucose (median [IQR])</td><td>6.42 [5.28, 8.50]</td><td>7.64 [5.46, 11.30]</td><td>4.91 [4.59, 5.27]</td><td>5.36 [4.79, 6.70]</td><td>&lt;0.001</td></tr><tr><td>Glycated hemoglobin, HbA1c (median [IQR])</td><td>49.50 [43.10, 57.60]</td><td>58.20 [48.90, 69.10]</td><td>35.10 [32.70, 37.50]</td><td>40.70 [36.00, 51.00]</td><td>&lt;0.001</td></tr><tr><td>Years since type 2 diabetes diagnosis (median [IQR])</td><td>4.05 [1.82, 7.16]</td><td>NA [NA, NA]</td><td>-6.27 [-9.09, -3.31]<break/>(Incident cases)</td><td>NA [NA, NA]</td><td>&lt;0.001</td></tr><tr><td>Sex male (%)</td><td>8426 (63.4)</td><td>2370 (58.8)</td><td>215111 (44.9)</td><td>3198 (50.9)</td><td>&lt;0.001</td></tr><tr><td>Family history of diabetes (%)</td><td>6219 (46.8)</td><td>1869 (46.4)</td><td>103336 (21.6)</td><td>2363 (37.6)</td><td>&lt;0.001</td></tr><tr><td>Family history of heart disease (%)</td><td>6870 (51.7)</td><td>2005 (49.8)</td><td>217257 (45.4)</td><td>2900 (46.2)</td><td>&lt;0.001</td></tr><tr><td>Family history of hypertension (%)</td><td>6565 (49.4)</td><td>1927 (47.8)</td><td>234153 (48.9)</td><td>3185 (50.7)</td><td>0.009</td></tr><tr><td>Hypertension (%)</td><td>10406 (78.5)</td><td>3120 (77.5)</td><td>140044 (29.3)</td><td>3275 (52.5)</td><td>&lt;0.001</td></tr><tr><td>Hyperlipidemia (%)</td><td>11038 (83.4)</td><td>3232 (80.4)</td><td>82921 (17.4)</td><td>2964 (48.3)</td><td>&lt;0.001</td></tr><tr><td>Atrial fibrillation (%)</td><td>345 (2.6)</td><td>84 (2.1)</td><td>4511 (0.9)</td><td>65 (1.0)</td><td>&lt;0.001</td></tr><tr><td>Hypertrophic cardiomyopathy (%)</td><td>10 (0.1)</td><td>3 (0.1)</td><td>185 (0.0)</td><td>3 (0.0)</td><td>0.13</td></tr><tr><td>Heart failure (%)</td><td>380 (2.9)</td><td>201 (5.0)</td><td>1981 (0.4)</td><td>63 (1.0)</td><td>&lt;0.001</td></tr><tr><td>On oral diabetes medication (%)</td><td>9057 (69.3)</td><td>1975 (49.4)</td><td>3910 (0.8)</td><td>1361 (22.3)</td><td>&lt;0.001</td></tr><tr><td>On insulin (%)</td><td>1371 (10.4)</td><td>2672 (67.0)</td><td>481 (0.1)</td><td>1243 (19.9)</td><td>&lt;0.001</td></tr><tr><td>Started insulin within 1 year of diagnosis (%)</td><td/><td/><td/><td/><td>&lt;0.001</td></tr><tr><td>No</td><td>11642 (94.9)</td><td>2072 (59.3)</td><td>5988 (95.5)</td><td>2280 (69.7)</td><td/></tr><tr><td>Yes</td><td>508 (4.1)</td><td>1401 (40.1)</td><td>193 (3.1)</td><td>932 (28.5)</td><td/></tr><tr><td>Do not know</td><td>106 (0.9)</td><td>21 (0.6)</td><td>79 (1.3)</td><td>42 (1.3)</td><td/></tr><tr><td>Prefer not to answer</td><td>11 (0.1)</td><td>3 (0.1)</td><td>10 (0.2)</td><td>17 (0.5)</td><td/></tr></tbody></table><table-wrap-foot><fn><p>The negative values of “Years since type 2 diabetes diagnosis” were attributed to future instances (incident cases).</p></fn></table-wrap-foot></table-wrap></p>
      <p id="p1770">In the survival analysis on new-onset heart failure (outcome of interest) between participants with or without type 2 diabetes at baseline, user would obtain a Kaplan-Meier plot similar to <xref rid="fig13" ref-type="fig">Figure 13</xref>. Participants with type 2 diabetes at baseline were more likely to have heart failure. The between-group difference was assessed by log-rank test with <italic>p</italic>&lt;0.0001 in the data analyzed.<fig id="fig13"><label>Figure 13</label><caption><p>Kaplan-Meier plot for new-onset heart failure stratified by type 2 diabetes status at baseline</p><p>The between-group difference in survival was assessed by log-rank test.</p></caption><graphic xlink:href="gr13"/></fig></p>
    </sec>
    <sec id="sec3.5">
      <title>Case-control matching with MatchIt</title>
      <p id="p1775">Following up with the type 2 diabetes phenotype we created, it can be seen that case-control ratio is unbalanced. It can also be seen that the controls were younger, more likely to be female and had lower body mass indices compared to the cases (<xref rid="tbl8" ref-type="table">Table 8</xref>). We used the MatchIt package to match two controls to each case by these three covariates. After matching users should see these variables are balanced in cases and controls (<xref rid="fig14" ref-type="fig">Figure 14</xref>).<fig id="fig14"><label>Figure 14</label><caption><p>Result summary on case-control matching for type 2 diabetes status at baseline</p></caption><graphic xlink:href="gr14"/></fig></p>
    </sec>
  </sec>
  <sec id="sec4">
    <title>Limitations</title>
    <p id="p1780">Phenotyping of a heterogenous resource such as UK Biobank can be challenging due to multiple data origins compounded with varying coverage both in terms of time and individuals. In the current protocol we demonstrate how to use the ukbpheno package to define health-related outcomes and we presented possible analyses with regard to the phenotyping process.</p>
    <p id="p1785">With the ukbpheno package, the case/control status is determined by presence of diagnosis records. In the case of contradictory records, an individual might be classified with theoretically mutually exclusive diagnoses. Ad-hoc analyses would be needed to refine the phenotypes of these individuals should such precision be required.</p>
    <p id="p1790">It is also of note that, while the users can assign different weights to different data sources by adjusting minimum instance filter in the setting, it is not possible to directly weight on individual codes which could be important for a certain phenotype. The limitation could be circumvented by an implementation on the definition level (separating the codes in various definitions). It is important to recognize that there is no gold-standard for many of the health-related outcomes. Users should decide on their definitions based on the study questions at hand.</p>
  </sec>
  <sec id="sec5">
    <title>Troubleshooting</title>
    <sec id="sec5.1">
      <title>Problem 1</title>
      <p id="p1795">Unable to download/decrypt the main dataset (step1).</p>
    </sec>
    <sec id="sec5.2">
      <title>Potential solution</title>
      <p id="p1800">Ensure the most updated project key which is valid for one year after initiation.</p>
    </sec>
    <sec id="sec5.3">
      <title>Problem 2</title>
      <p id="p1805">Unable to download data from Data Portal (step 2).</p>
    </sec>
    <sec id="sec5.4">
      <title>Potential solution</title>
      <p id="p1810">Request the relevant fields listed in step 2 via the UK Biobank Access Management System (<xref rid="bib8" ref-type="bibr">UK Biobank, 2022a</xref>).</p>
    </sec>
    <sec id="sec5.5">
      <title>Problem 3</title>
      <p id="p1815">Error: Failed to install ‘ukbpheno’ from GitHub: installation of package “xx” had non-zero exit status (step 5).</p>
    </sec>
    <sec id="sec5.6">
      <title>Potential solution</title>
      <p id="p1820">Installation of the dependent package “xx” was not successful. Find the error message on console, resolve the error and restart the installation. Possible reason of error includes “dependency “xx” is not available (for R version x.x.x) “, which may be solved by specifying the version of package compatible for the corresponding R version.</p>
    </sec>
    <sec id="sec5.7">
      <title>Problem 4</title>
      <p id="p1825">Certain codes are missing after reading in the definition table (step 9).</p>
    </sec>
    <sec id="sec5.8">
      <title>Potential solution</title>
      <p id="p1830">The package drops codes that are not available in data. If a certain code is dropped not due to this reason, check for special characters (accented characters are not recognized) and make sure codes are comma separated.</p>
    </sec>
    <sec id="sec5.9">
      <title>Problem 5</title>
      <p id="p1835">Data processing step fails (step 10).</p>
    </sec>
    <sec id="sec5.10">
      <title>Potential solution</title>
      <p id="p1840">Run “get_all_varnames()” with the processed definition table and meta-data file to check if but some required fields are missing in the main dataset. Either remove the missing fields from definition table or allow missing fields (set “allow_missing_fields” flag to TRUE) in the “harmonized_ukb_data()”.</p>
    </sec>
  </sec>
  <sec id="sec6">
    <title>Resource availability</title>
    <sec id="sec6.1">
      <title>Lead contact</title>
      <p id="p1845">Further information and requests for resources should be directed to the lead contact, Ming Wai Yeung (<ext-link ext-link-type="uri" xlink:href="mailto:m.w.yeung@umcg.nl" id="intref0075">m.w.yeung@umcg.nl</ext-link>).</p>
    </sec>
    <sec id="sec6.2">
      <title>Materials availability</title>
      <p id="p1850">This study did not generate new unique reagents.</p>
    </sec>
  </sec>
</body>
<back>
  <ref-list id="cebib0010">
    <title>References</title>
    <ref id="bib1">
      <element-citation publication-type="journal" id="sref1">
        <person-group person-group-type="author">
          <name>
            <surname>Benjamins</surname>
            <given-names>J.W.</given-names>
          </name>
          <name>
            <surname>Yeung</surname>
            <given-names>M.W.</given-names>
          </name>
          <name>
            <surname>van de Vegte</surname>
            <given-names>Y.J.</given-names>
          </name>
          <name>
            <surname>Said</surname>
            <given-names>M.A.</given-names>
          </name>
          <name>
            <surname>van der Linden</surname>
            <given-names>T.</given-names>
          </name>
          <name>
            <surname>Ties</surname>
            <given-names>D.</given-names>
          </name>
          <name>
            <surname>Juarez-Orozco</surname>
            <given-names>L.E.</given-names>
          </name>
          <name>
            <surname>Verweij</surname>
            <given-names>N.</given-names>
          </name>
          <name>
            <surname>van der Harst</surname>
            <given-names>P.</given-names>
          </name>
        </person-group>
        <article-title>Genomic insights in ascending aortic size and distensibility</article-title>
        <source>EBioMedicine</source>
        <volume>75</volume>
        <year>2022</year>
        <fpage>103783</fpage>
        <pub-id pub-id-type="doi">10.1016/J.EBIOM.2021.103783</pub-id>
        <pub-id pub-id-type="pmid">34968759</pub-id>
      </element-citation>
    </ref>
    <ref id="bib2">
      <element-citation publication-type="other" id="sref2">
        <person-group person-group-type="author">
          <collab>UK Biobank</collab>
        </person-group>
        <article-title>UK Biobank health outcomes overview</article-title>
        <ext-link ext-link-type="uri" xlink:href="http://www.ukbiobank.ac.uk" id="intref0220">http://www.ukbiobank.ac.uk</ext-link>
        <year>2019</year>
      </element-citation>
    </ref>
    <ref id="bib3">
      <element-citation publication-type="journal" id="sref3">
        <person-group person-group-type="author">
          <name>
            <surname>Bycroft</surname>
            <given-names>C.</given-names>
          </name>
          <name>
            <surname>Freeman</surname>
            <given-names>C.</given-names>
          </name>
          <name>
            <surname>Petkova</surname>
            <given-names>D.</given-names>
          </name>
          <name>
            <surname>Band</surname>
            <given-names>G.</given-names>
          </name>
          <name>
            <surname>Elliott</surname>
            <given-names>L.T.</given-names>
          </name>
          <name>
            <surname>Sharp</surname>
            <given-names>K.</given-names>
          </name>
          <name>
            <surname>Motyer</surname>
            <given-names>A.</given-names>
          </name>
          <name>
            <surname>Vukcevic</surname>
            <given-names>D.</given-names>
          </name>
          <name>
            <surname>Delaneau</surname>
            <given-names>O.</given-names>
          </name>
          <name>
            <surname>O’Connell</surname>
            <given-names>J.</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The UK Biobank resource with deep phenotyping and genomic data</article-title>
        <source>Nature</source>
        <volume>562</volume>
        <year>2018</year>
        <fpage>203</fpage>
        <lpage>209</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-018-0579-z</pub-id>
        <pub-id pub-id-type="pmid">30305743</pub-id>
      </element-citation>
    </ref>
    <ref id="bib4">
      <element-citation publication-type="journal" id="sref4">
        <person-group person-group-type="author">
          <name>
            <surname>Eastwood</surname>
            <given-names>S.V.</given-names>
          </name>
          <name>
            <surname>Mathur</surname>
            <given-names>R.</given-names>
          </name>
          <name>
            <surname>Atkinson</surname>
            <given-names>M.</given-names>
          </name>
          <name>
            <surname>Brophy</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Sudlow</surname>
            <given-names>C.</given-names>
          </name>
          <name>
            <surname>Flaig</surname>
            <given-names>R.</given-names>
          </name>
          <name>
            <surname>de Lusignan</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>Allen</surname>
            <given-names>N.</given-names>
          </name>
          <name>
            <surname>Chaturvedi</surname>
            <given-names>N.</given-names>
          </name>
        </person-group>
        <article-title>Algorithms for the capture and adjudication of prevalent and incident diabetes in UK Biobank</article-title>
        <source>PLoS One</source>
        <volume>11</volume>
        <year>2016</year>
        <fpage>e0162388</fpage>
        <pub-id pub-id-type="doi">10.1371/JOURNAL.PONE.0162388</pub-id>
        <pub-id pub-id-type="pmid">27631769</pub-id>
      </element-citation>
    </ref>
    <ref id="bib5">
      <element-citation publication-type="book" id="sref5">
        <person-group person-group-type="author">
          <collab>R Core Team</collab>
        </person-group>
        <part-title>R: A Language and Environment for Statistical Computing</part-title>
        <year>2020</year>
        <publisher-name>R Foundation for Statistical Computing’</publisher-name>
        <ext-link ext-link-type="uri" xlink:href="https://www.r-project.org/" id="intref0225">https://www.r-project.org/</ext-link>
      </element-citation>
    </ref>
    <ref id="bib6">
      <element-citation publication-type="book" id="sref6">
        <person-group person-group-type="author">
          <collab>RStudio Team</collab>
        </person-group>
        <part-title>RStudio: Integrated Development for R</part-title>
        <year>2020</year>
        <publisher-name>RStudio, PBC</publisher-name>
        <ext-link ext-link-type="uri" xlink:href="http://www.rstudio.com/" id="intref0230">http://www.rstudio.com/</ext-link>
      </element-citation>
    </ref>
    <ref id="bib7">
      <element-citation publication-type="journal" id="sref7">
        <person-group person-group-type="author">
          <name>
            <surname>Sudlow</surname>
            <given-names>C.</given-names>
          </name>
          <name>
            <surname>Gallacher</surname>
            <given-names>J.</given-names>
          </name>
          <name>
            <surname>Allen</surname>
            <given-names>N.</given-names>
          </name>
          <name>
            <surname>Beral</surname>
            <given-names>V.</given-names>
          </name>
          <name>
            <surname>Burton</surname>
            <given-names>P.</given-names>
          </name>
          <name>
            <surname>Danesh</surname>
            <given-names>J.</given-names>
          </name>
          <name>
            <surname>Downey</surname>
            <given-names>P.</given-names>
          </name>
          <name>
            <surname>Elliott</surname>
            <given-names>P.</given-names>
          </name>
          <name>
            <surname>Green</surname>
            <given-names>J.</given-names>
          </name>
          <name>
            <surname>Landray</surname>
            <given-names>M.</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>UK Biobank: an open access resource for identifying the causes of a wide range of complex diseases of middle and old age</article-title>
        <source>PLoS Med.</source>
        <volume>12</volume>
        <year>2015</year>
        <fpage>e1001779</fpage>
        <pub-id pub-id-type="doi">10.1371/journal.pmed.1001779</pub-id>
        <pub-id pub-id-type="pmid">25826379</pub-id>
      </element-citation>
    </ref>
    <ref id="bib8">
      <element-citation publication-type="other" id="sref8">
        <person-group person-group-type="author">
          <name>
            <surname>UK Biobank</surname>
          </name>
        </person-group>
        <article-title>UK Biobank access management system</article-title>
        <ext-link ext-link-type="uri" xlink:href="https://bbams.ndph.ox.ac.uk/ams/" id="intref0235">https://bbams.ndph.ox.ac.uk/ams/</ext-link>
        <year>2022</year>
      </element-citation>
    </ref>
    <ref id="bib9">
      <element-citation publication-type="other" id="sref9">
        <person-group person-group-type="author">
          <name>
            <surname>UK Biobank</surname>
          </name>
        </person-group>
        <article-title>UK Biobank showcase</article-title>
        <ext-link ext-link-type="uri" xlink:href="https://biobank.ctsu.ox.ac.uk/crystal/" id="intref0240">https://biobank.ctsu.ox.ac.uk/crystal/</ext-link>
        <year>2022</year>
      </element-citation>
    </ref>
    <ref id="bib10">
      <element-citation publication-type="journal" id="sref10">
        <person-group person-group-type="author">
          <name>
            <surname>van der Harst</surname>
            <given-names>P.</given-names>
          </name>
          <name>
            <surname>Verweij</surname>
            <given-names>N.</given-names>
          </name>
        </person-group>
        <article-title>Identification of 64 novel genetic loci provides an expanded view on the genetic architecture of coronary artery disease</article-title>
        <source>Circ. Res.</source>
        <volume>122</volume>
        <year>2018</year>
        <fpage>433</fpage>
        <lpage>443</lpage>
        <pub-id pub-id-type="doi">10.1161/CIRCRESAHA.117.312086</pub-id>
        <pub-id pub-id-type="pmid">29212778</pub-id>
      </element-citation>
    </ref>
    <ref id="bib11">
      <element-citation publication-type="journal" id="sref11">
        <person-group person-group-type="author">
          <name>
            <surname>Verweij</surname>
            <given-names>N.</given-names>
          </name>
          <name>
            <surname>Benjamins</surname>
            <given-names>J.W.</given-names>
          </name>
          <name>
            <surname>Morley</surname>
            <given-names>M.P.</given-names>
          </name>
          <name>
            <surname>van de Vegte</surname>
            <given-names>Y.J.</given-names>
          </name>
          <name>
            <surname>Teumer</surname>
            <given-names>A.</given-names>
          </name>
          <name>
            <surname>Trenkwalder</surname>
            <given-names>T.</given-names>
          </name>
          <name>
            <surname>Reinhard</surname>
            <given-names>W.</given-names>
          </name>
          <name>
            <surname>Cappola</surname>
            <given-names>T.P.</given-names>
          </name>
          <name>
            <surname>van der Harst</surname>
            <given-names>P.</given-names>
          </name>
        </person-group>
        <article-title>The genetic makeup of the electrocardiogram</article-title>
        <source>Cell Syst.</source>
        <volume>11</volume>
        <year>2020</year>
        <fpage>229</fpage>
        <lpage>238.e5</lpage>
        <pub-id pub-id-type="doi">10.1016/J.CELS.2020.08.005</pub-id>
        <pub-id pub-id-type="pmid">32916098</pub-id>
      </element-citation>
    </ref>
    <ref id="bib12">
      <element-citation publication-type="journal" id="sref12">
        <person-group person-group-type="author">
          <name>
            <surname>Wilkinson</surname>
            <given-names>M.D.</given-names>
          </name>
          <name>
            <surname>Dumontier</surname>
            <given-names>M.</given-names>
          </name>
          <name>
            <surname>Aalbersberg</surname>
            <given-names>I.J.</given-names>
          </name>
          <name>
            <surname>Appleton</surname>
            <given-names>G.</given-names>
          </name>
          <name>
            <surname>Axton</surname>
            <given-names>M.</given-names>
          </name>
          <name>
            <surname>Baak</surname>
            <given-names>A.</given-names>
          </name>
          <name>
            <surname>Blomberg</surname>
            <given-names>N.</given-names>
          </name>
          <name>
            <surname>Boiten</surname>
            <given-names>J.W.</given-names>
          </name>
          <name>
            <surname>da Silva Santos</surname>
            <given-names>L.B.</given-names>
          </name>
          <name>
            <surname>Bourne</surname>
            <given-names>P.E.</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Comment: the FAIR guiding principles for scientific data management and stewardship</article-title>
        <source>Sci. Data</source>
        <volume>3</volume>
        <year>2016</year>
        <fpage>1</fpage>
        <lpage>9</lpage>
        <pub-id pub-id-type="doi">10.1038/sdata.2016.18</pub-id>
      </element-citation>
    </ref>
    <ref id="bib13">
      <element-citation publication-type="journal" id="sref13">
        <person-group person-group-type="author">
          <name>
            <surname>Woodfield</surname>
            <given-names>R.</given-names>
          </name>
          <name>
            <surname>Sudlow</surname>
            <given-names>C.L.M.</given-names>
          </name>
        </person-group>
        <article-title>Accuracy of patient self-report of stroke: a systematic review from the UK Biobank stroke outcomes group</article-title>
        <source>PLoS One</source>
        <volume>10</volume>
        <year>2015</year>
        <fpage>e0137538</fpage>
        <pub-id pub-id-type="doi">10.1371/JOURNAL.PONE.0137538</pub-id>
        <pub-id pub-id-type="pmid">26355837</pub-id>
      </element-citation>
    </ref>
    <ref id="bib14">
      <element-citation publication-type="journal" id="sref14">
        <person-group person-group-type="author">
          <name>
            <surname>Yeung</surname>
            <given-names>M.W.</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>S.</given-names>
          </name>
          <name>
            <surname>van de Vegte</surname>
            <given-names>Y.J.</given-names>
          </name>
          <name>
            <surname>Borisov</surname>
            <given-names>O.</given-names>
          </name>
          <name>
            <surname>van Setten</surname>
            <given-names>J.</given-names>
          </name>
          <name>
            <surname>Snieder</surname>
            <given-names>H.</given-names>
          </name>
          <name>
            <surname>Verweij</surname>
            <given-names>N.</given-names>
          </name>
          <name>
            <surname>Said</surname>
            <given-names>M.A.</given-names>
          </name>
          <name>
            <surname>van der Harst</surname>
            <given-names>P.</given-names>
          </name>
        </person-group>
        <article-title>Twenty-five novel loci for carotid intima-media thickness: a genome-wide association study in &gt;45 000 individuals and meta-analysis of &gt;100 000 individuals</article-title>
        <source>Arterioscler. Thromb. Vasc. Biol.</source>
        <volume>42</volume>
        <year>2022</year>
        <fpage>484</fpage>
        <lpage>501</lpage>
        <pub-id pub-id-type="doi">10.1161/ATVBAHA.121.317007</pub-id>
        <pub-id pub-id-type="pmid">34852643</pub-id>
      </element-citation>
    </ref>
  </ref-list>
  <sec sec-type="data-availability" id="da0010">
    <title>Data and code availability</title>
    <p id="p0030">Data used and generated are listed in the <xref rid="sec7" ref-type="sec">key resources table</xref>. The UK Biobank data are open to bona-fide researchers and accessible with an approved research project. Application guideline for the UK Biobank data can be found at <ext-link ext-link-type="uri" xlink:href="https://www.ukbiobank.ac.uk/enable-your-research/apply-for-access" id="intref0010">https://www.ukbiobank.ac.uk/enable-your-research/apply-for-access</ext-link>. The code supporting the current study is available at the ukbpheno repository <ext-link ext-link-type="uri" xlink:href="https://github.com/niekverw/ukbpheno/blob/master/inst/workflow_example/run_example.R" id="intref0015">https://github.com/niekverw/ukbpheno/blob/master/inst/workflow_example/run_example.R</ext-link>.</p>
  </sec>
  <ack id="ack0010">
    <title>Acknowledgments</title>
    <p id="p1860">This research has been conducted using the UK Biobank resource under application number 74395. We thank all UK Biobank participants for their contributions.</p>
    <sec id="sec8">
      <title>Author contributions</title>
      <p id="p1865">M.W.Y. and N.V. conceptualized and developed the ukbpheno package and the protocols. M.W.Y. performed the analyses and wrote the manuscript. N.V. and P.v.d.H. reviewed and edited the manuscript. P.v.d.H. provided the data and project administration.</p>
    </sec>
    <sec sec-type="COI-statement" id="sec9">
      <title>Declaration of interests</title>
      <p id="p1870">N.V. is a full-time employee of Regeneron Pharmaceutical Inc. and receives stock options and restricted stock units as compensation.</p>
    </sec>
  </ack>
</back>
