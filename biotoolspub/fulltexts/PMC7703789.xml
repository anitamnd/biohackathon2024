<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.1 20151215//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.1?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">Bioinformatics</journal-id>
    <journal-id journal-id-type="publisher-id">bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1367-4803</issn>
    <issn pub-type="epub">1367-4811</issn>
    <publisher>
      <publisher-name>Oxford University Press</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">7703789</article-id>
    <article-id pub-id-type="pmid">31605112</article-id>
    <article-id pub-id-type="doi">10.1093/bioinformatics/btz736</article-id>
    <article-id pub-id-type="publisher-id">btz736</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Original Papers</subject>
        <subj-group subj-group-type="category-toc-heading">
          <subject>Systems Biology</subject>
        </subj-group>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Identification of metabolites from tandem mass spectra with a machine learning approach utilizing structural features</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid" authenticated="false">http://orcid.org/0000-0001-5971-0355</contrib-id>
        <name>
          <surname>Li</surname>
          <given-names>Yuanyue</given-names>
        </name>
        <xref ref-type="aff" rid="btz736-aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Kuhn</surname>
          <given-names>Michael</given-names>
        </name>
        <xref ref-type="aff" rid="btz736-aff1">1</xref>
        <xref ref-type="corresp" rid="btz736-cor1"/>
        <!--<email>mkuhn@embl.de</email>-->
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Gavin</surname>
          <given-names>Anne-Claude</given-names>
        </name>
        <xref ref-type="aff" rid="btz736-aff1">1</xref>
        <xref ref-type="aff" rid="btz736-aff2">2</xref>
        <xref ref-type="corresp" rid="btz736-cor2"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Bork</surname>
          <given-names>Peer</given-names>
        </name>
        <xref ref-type="aff" rid="btz736-aff1">1</xref>
        <xref ref-type="aff" rid="btz736-aff2">2</xref>
        <xref ref-type="aff" rid="btz736-aff3">3</xref>
        <xref ref-type="aff" rid="btz736-aff4">4</xref>
        <xref ref-type="corresp" rid="btz736-cor1"/>
        <!--<email>bork@embl.de</email>-->
      </contrib>
    </contrib-group>
    <contrib-group>
      <contrib contrib-type="editor">
        <name>
          <surname>Valencia</surname>
          <given-names>Alfonso</given-names>
        </name>
        <role>Associate Editor</role>
      </contrib>
    </contrib-group>
    <aff id="btz736-aff1"><label>1</label><institution>Structural and Computational Biology Unit, European Molecular Biology Laboratory</institution>, 69117 Heidelberg, <country country="DE">Germany</country></aff>
    <aff id="btz736-aff2"><label>2</label><institution>Molecular Medicine Partnership Unit (MMPU)</institution>, 69117 Heidelberg, <country country="DE">Germany</country></aff>
    <aff id="btz736-aff3"><label>3</label><institution>Max Delbrück Center for Molecular Medicine</institution>, 13125 Berlin, <country country="DE">Germany</country></aff>
    <aff id="btz736-aff4"><label>4</label><institution>Department of Bioinformatics, Biocenter, University of Würzburg</institution>, 97074 Würzburg, <country country="DE">Germany</country></aff>
    <author-notes>
      <corresp id="btz736-cor1">To whom correspondence should be addressed. <email>mkuhn@embl.de</email> or <email>bork@embl.de</email></corresp>
      <corresp id="btz736-cor2">Present address: Department for Cell Physiology and Metabolism, Centre Médical Universitaire, University of Geneva, Geneva, Switzerland</corresp>
    </author-notes>
    <pub-date pub-type="ppub">
      <day>15</day>
      <month>2</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="epub" iso-8601-date="2019-10-12">
      <day>12</day>
      <month>10</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>12</day>
      <month>10</month>
      <year>2019</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on the <pub-date pub-type="epub"/>. -->
    <volume>36</volume>
    <issue>4</issue>
    <fpage>1213</fpage>
    <lpage>1218</lpage>
    <history>
      <date date-type="received">
        <day>20</day>
        <month>3</month>
        <year>2019</year>
      </date>
      <date date-type="rev-recd">
        <day>30</day>
        <month>7</month>
        <year>2019</year>
      </date>
      <date date-type="accepted">
        <day>25</day>
        <month>9</month>
        <year>2019</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2019. Published by Oxford University Press.</copyright-statement>
      <copyright-year>2019</copyright-year>
      <license license-type="cc-by" xlink:href="http://creativecommons.org/licenses/by/4.0/">
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted reuse, distribution, and reproduction in any medium, provided the original work is properly cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="btz736.pdf"/>
    <abstract>
      <title>Abstract</title>
      <sec id="s1">
        <title>Motivation</title>
        <p>Untargeted mass spectrometry (MS/MS) is a powerful method for detecting metabolites in biological samples. However, fast and accurate identification of the metabolites’ structures from MS/MS spectra is still a great challenge.</p>
      </sec>
      <sec id="s2">
        <title>Results</title>
        <p>We present a new analysis method, called SubFragment-Matching (SF-Matching) that is based on the hypothesis that molecules with similar structural features will exhibit similar fragmentation patterns. We combine information on fragmentation patterns of molecules with shared substructures and then use random forest models to predict whether a given structure can yield a certain fragmentation pattern. These models can then be used to score candidate molecules for a given mass spectrum. For rapid identification, we pre-compute such scores for common biological molecular structure databases. Using benchmarking datasets, we find that our method has similar performance to CSI: FingerID and those very high accuracies can be achieved by combining our method with CSI: FingerID. Rarefaction analysis of the training dataset shows that the performance of our method will increase as more experimental data become available.</p>
      </sec>
      <sec id="s3">
        <title>Availability and implementation</title>
        <p>SF-Matching is available from <ext-link ext-link-type="uri" xlink:href="http://www.bork.embl.de/Docu/sf_matching">http://www.bork.embl.de/Docu/sf_matching</ext-link>.</p>
      </sec>
      <sec id="s4">
        <title>Supplementary information</title>
        <p><xref ref-type="supplementary-material" rid="sup1">Supplementary data</xref> are available at <italic>Bioinformatics</italic> online.</p>
      </sec>
    </abstract>
    <funding-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">EMBL and the MicrobioS</named-content>
        </funding-source>
        <award-id>ERC-AdG-669830</award-id>
      </award-group>
    </funding-group>
    <counts>
      <page-count count="6"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec>
    <title>1 Introduction</title>
    <p>Untargeted mass spectrometry (MS/MS) is a common approach for identification of metabolites in biological samples (<xref rid="btz736-B2" ref-type="bibr">Beger <italic>et al.</italic>, 2016</xref>; <xref rid="btz736-B22" ref-type="bibr">O’Kell <italic>et al.</italic>, 2017</xref>; <xref rid="btz736-B26" ref-type="bibr">Schrimpe-Rutledge <italic>et al.</italic>, 2016</xref>). Thereby, a complex biological sample is analyzed with liquid chromatography electrospray ionization tandem MS/MS, generating several thousands of MS/MS spectra in a few minutes. Inferring all molecular structures from these spectra in a fast, precise manner is, however, still a challenge. The currently fastest way of analyzing such data is to match fragmentation spectra of unknown substances to a reference spectral library (<xref rid="btz736-B18" ref-type="bibr">Kind <italic>et al.</italic>, 2018</xref>). These spectral libraries are usually built from known purified metabolites or generated by researches experiments. Some databases like METLIN (<xref rid="btz736-B10" ref-type="bibr">Guijas <italic>et al.</italic>, 2018</xref>), GNPS (<xref rid="btz736-B33" ref-type="bibr">Wang <italic>et al.</italic>, 2016</xref>) and Massbank (<xref rid="btz736-B14" ref-type="bibr">Horai <italic>et al.</italic>, 2010</xref>) are collecting these data. This experimental approach has the highest accuracy, however, generating these reference libraries is money- and time-consuming.</p>
    <p>Several methods like MS2LDA (<xref rid="btz736-B30" ref-type="bibr">van der Hooft <italic>et al.</italic>, 2016</xref>, <xref rid="btz736-B31" ref-type="bibr">2017</xref>), ChemFrag (<xref rid="btz736-B27" ref-type="bibr">Schüler <italic>et al.</italic>, 2018</xref>) and ChemDistiller (<xref rid="btz736-B19" ref-type="bibr">Laponogov <italic>et al.</italic>, 2018</xref>) have been developed for the prediction of functional chemical groups from metabolite spectra. Methods like XCMS2 (<xref rid="btz736-B3" ref-type="bibr">Benton <italic>et al.</italic>, 2008</xref>) use a similarity-based search to detect possible structural motifs of unknown metabolites in spectra. Also, many methods have been proposed for <italic>in silico</italic> metabolite identification from spectra (<xref rid="btz736-B13" ref-type="bibr">Heinonen <italic>et al.</italic>, 2012</xref>; <xref rid="btz736-B15" ref-type="bibr">Hummel <italic>et al.</italic>, 2010</xref>; <xref rid="btz736-B21" ref-type="bibr">Nguyen <italic>et al.</italic>, 2018</xref>; <xref rid="btz736-B32" ref-type="bibr">Vaniya and Fiehn, 2015</xref>). <italic>In silico</italic> fragmentation methods, such as ISIS (<xref rid="btz736-B17" ref-type="bibr">Kangas <italic>et al.</italic>, 2012</xref>), MS-FINDER (<xref rid="btz736-B29" ref-type="bibr">Tsugawa <italic>et al.</italic>, 2016</xref>), MetFrag (<xref rid="btz736-B25" ref-type="bibr">Ruttkies <italic>et al.</italic>, 2016</xref>) and CFM-ID (<xref rid="btz736-B1" ref-type="bibr">Allen <italic>et al.</italic>, 2015</xref>) strive to explain all fragment ions; these methods break every possible covalent bond, scoring each broken bond based on its strength. Some methods like CFM-ID can generate a pre-calculated spectral library. However, as molecular rearrangements occur during fragmentation, precise prediction of the rearrangement is very difficult, and these methods suffer from a low identification accuracy (<xref rid="btz736-B4" ref-type="bibr">Blaženović <italic>et al.</italic>, 2018</xref>). Other approaches like CSI: FingerID (<xref rid="btz736-B5" ref-type="bibr">Brouard <italic>et al.</italic>, 2016</xref>; <xref rid="btz736-B6" ref-type="bibr">Dührkop <italic>et al.</italic>, 2015</xref>, <xref rid="btz736-B7" ref-type="bibr">2019</xref>; <xref rid="btz736-B20" ref-type="bibr">Ludwig <italic>et al.</italic>, 2018</xref>) convert a spectrum into a fragmentation tree, search this fragmentation tree against a database of known trees, and then infer a molecular fingerprint. These methods need to search fragmentation trees one by one in an online way, which makes it time-consuming when analyzing many spectra.</p>
    <p>Depending on the type of biological sample, different chemical search spaces can be used. For well-studied sample types, such as cultured cells or human plasma, many of the metabolites in these samples have been analyzed before. In these cases, spectra can often be matched to reference libraries. Even if reference spectra are not available, there is a high chance that the compounds are part of curated databases such as the KEGG pathway database (<xref rid="btz736-B16" ref-type="bibr">Kanehisa <italic>et al.</italic>, 2017</xref>) or the HMDB database of metabolites (<xref rid="btz736-B34" ref-type="bibr">Wishart <italic>et al.</italic>, 2018</xref>). For such compounds, several identification methods have be developed (<xref rid="btz736-B4" ref-type="bibr">Blaženović <italic>et al.</italic>, 2018</xref>). More complex samples such as those from plants or the environment contain many molecules whose structures have not been determined yet, hampering compound identification using MS.</p>
    <p>Here, we describe a new method called SF-Matching (<underline>S</underline>ub<underline>F</underline>ragment-<underline>Matching</underline>) to predict likely peaks in tandem mass spectra for small molecules using a machine learning approach. Circumventing the complexities of accurately modeling the fragmentation processes and probabilities of bond breakage, our new approach relies on detecting ‘fragile’ substructures in the molecule. These enable us to derive the respective fragmentation patterns to achieve high identification accuracy of compounds from mass spectra.</p>
    <p>Unlike similarity-based approaches, which try to annotate spectra with a few features and fail if an unknown metabolite has chemical modifications, SF-Matching can be used for precise identification of a molecule when it contains similar substructures to known metabolites. SF-Matching also does not treat molecular bonds like the <italic>in silico</italic> methods: it does not predict the chemical reaction leading to the fragmentation, it only breaks bonds to find the subfragments, then uses the chemical fingerprint to capture similar molecular structures. Furthermore, the approach described here appears complementary to the existing method CSI: FingerID as a combination with it achieves a much higher accuracy than either method on its own with only a small sensitivity decrease.</p>
  </sec>
  <sec>
    <title>2 Materials and methods</title>
    <sec>
      <title>2.1 Converting spectra to subfragments</title>
      <p>Given a molecular structure, we search for molecular substructures first. We remove all possible bonds <inline-formula id="IE1"><mml:math id="IM1"><mml:msub><mml:mrow><mml:mi>b</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> connecting atoms <inline-formula id="IE2"><mml:math id="IM2"><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula id="IE3"><mml:math id="IM3"><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, with the exception of carbon–carbon bonds in the aliphatic chain and bonds within ring systems. Removing a bond yields two sub-molecules with molecular formulas <inline-formula id="IE4"><mml:math id="IM4"><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula id="IE5"><mml:math id="IM5"><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi><mml:mo>,</mml:mo><mml:mi>s</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. For each heavy atom <inline-formula id="IE6"><mml:math id="IM6"><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> in a molecule, the Merck Molecular Force Field (<xref rid="btz736-B11" ref-type="bibr">Halgren, 1996</xref>) atom type <inline-formula id="IE7"><mml:math id="IM7"><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msub></mml:math></inline-formula> was determined and the bond type <inline-formula id="IE8"><mml:math id="IM8"><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>b</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msub></mml:math></inline-formula> was defined as <inline-formula id="IE9"><mml:math id="IM9"><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>b</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi mathvariant="normal"> </mml:mi><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math></inline-formula>.</p>
      <p>The molecule’s corresponding spectrum can be treated as a list of <inline-formula id="IE10"><mml:math id="IM10"><mml:mi>n</mml:mi></mml:math></inline-formula> peaks <inline-formula id="IE11"><mml:math id="IM11"><mml:mfenced open="{" close="}" separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi mathvariant="normal"> </mml:mi><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi mathvariant="normal"> </mml:mi><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mi mathvariant="normal"> </mml:mi><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math></inline-formula>, here <inline-formula id="IE12"><mml:math id="IM12"><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfenced separators="|"><mml:mrow><mml:mi mathvariant="normal">m</mml:mi><mml:mo>/</mml:mo><mml:mi mathvariant="normal">z</mml:mi><mml:mi mathvariant="normal"> </mml:mi><mml:msub><mml:mrow><mml:mi>M</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo> </mml:mo><mml:mtext>intensity</mml:mtext><mml:mo> </mml:mo><mml:msub><mml:mrow><mml:mi>I</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math></inline-formula>, and the formula of a fragment ion <inline-formula id="IE13"><mml:math id="IM13"><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> can be determined from <inline-formula id="IE14"><mml:math id="IM14"><mml:msub><mml:mrow><mml:mi>M</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. A mass-to-charge ratio <inline-formula id="IE15"><mml:math id="IM15"><mml:msub><mml:mrow><mml:mi>M</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> may correspond to several molecular formulas <inline-formula id="IE16"><mml:math id="IM16"><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. In this situation, only the formulas that are a subset of the precursor ion are considered. If more than one formula meets this criterion, we include all of them with the same weight.</p>
      <p>Then, we test for all <inline-formula id="IE17"><mml:math id="IM17"><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> if they are a subset of <inline-formula id="IE18"><mml:math id="IM18"><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. In this case, we can calculate the difference of the molecular formulas <inline-formula id="IE19"><mml:math id="IM19"><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mi>F</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, and define the subfragment <inline-formula id="IE20"><mml:math id="IM20"><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>T</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>b</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>Δ</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math></inline-formula>. Therefore, each peak <inline-formula id="IE21"><mml:math id="IM21"><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> with intensity <inline-formula id="IE22"><mml:math id="IM22"><mml:msub><mml:mrow><mml:mi>I</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> corresponds to a set of subfragments <inline-formula id="IE23"><mml:math id="IM23"><mml:mfenced open="{" close="}" separators="|"><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>I</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:mi mathvariant="normal"> </mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>I</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:mi mathvariant="normal"> </mml:mi><mml:mi mathvariant="normal">…</mml:mi><mml:mi mathvariant="normal">,</mml:mi><mml:mi mathvariant="normal"> </mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>I</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:math></inline-formula>.</p>
    </sec>
    <sec>
      <title>2.2 Generating models for the subfragments</title>
      <p>To build the prediction models, we collected 16 110 molecules for positive ion, 5884 molecules for negative ion from the GNPS, MassBank and in-house databases (<xref rid="btz736-B14" ref-type="bibr">Horai <italic>et al.</italic>, 2010</xref>; <xref rid="btz736-B33" ref-type="bibr">Wang <italic>et al.</italic>, 2016</xref>) (<xref ref-type="supplementary-material" rid="sup1">Supplementary Tables S1 and S2</xref>). For each spectrum in the database, the intensity of the spectrum was normalized so that the sum over all peak intensities equals one. If one molecule has multiple spectra, they will be treated individually. The spectral peaks were converted to fragment substructures as described earlier. Models were then built for all fragment substructures that occurred in at least five molecules.</p>
      <p>Machine learning methods have difficulties within imbalanced training sets. In our case, most molecules do not generate a certain subfragment. To address this imbalance, the training data for a random forest can be augmented with weights for the individual items in the training data. Spectra that contained a peak corresponding to the fragment substructure were assigned the weight equal to the peak’s normalized intensity (<inline-formula id="IE24"><mml:math id="IM24"><mml:msub><mml:mrow><mml:mi>I</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:math></inline-formula>. The sum of weights is therefore <inline-formula id="IE25"><mml:math id="IM25"><mml:mi>w</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:munder><mml:mo stretchy="false">∑</mml:mo><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:munder><mml:mrow><mml:msub><mml:mrow><mml:mi>I</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:math></inline-formula>. For spectra that did not contain a peak corresponding to the fragment substructure were assigned equal weights such that their sum is <inline-formula id="IE26"><mml:math id="IM26"><mml:mi>w</mml:mi></mml:math></inline-formula>. That is, if there are <inline-formula id="IE27"><mml:math id="IM27"><mml:mi>n</mml:mi></mml:math></inline-formula> spectra without the peak, their weight is <inline-formula id="IE28"><mml:math id="IM28"><mml:mi>w</mml:mi><mml:mo>/</mml:mo><mml:mi>n</mml:mi></mml:math></inline-formula>.</p>
      <p>For each molecule, stereoisomer information was removed, and an 8191-bit chemical fingerprint generated using <xref rid="btz736-B9" ref-type="bibr">RDKit</xref> Fingerprint (Greg Landrum). Then, an extra-trees classifier was built using the scikit-learn (<xref rid="btz736-B24" ref-type="bibr">Pedregosa <italic>et al.</italic>, 2012</xref>) with 100 trees, using the chemical fingerprints of the complete structure as features and the presence of the fragment substructure as class label. A model will be built if a subfragment existed in at least five molecules. In total, models were built for 1 227 627 subfragments. Each of these models predicts the probability <inline-formula id="IE29"><mml:math id="IM29"><mml:mi>P</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi><mml:mo>|</mml:mo></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>C</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> that a peak corresponding to the subfragment <inline-formula id="IE30"><mml:math id="IM30"><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> occurs given the chemical fingerprint <inline-formula id="IE31"><mml:math id="IM31"><mml:mi>C</mml:mi></mml:math></inline-formula>.</p>
    </sec>
    <sec>
      <title>2.3 Predicting possible peaks for a given molecule</title>
      <p>Given a molecule, its chemical fingerprint <inline-formula id="IE32"><mml:math id="IM32"><mml:mi>C</mml:mi></mml:math></inline-formula> was calculated as described earlier. Furthermore, all possible peaks <inline-formula id="IE33"><mml:math id="IM33"><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mi mathvariant="normal"> </mml:mi></mml:math></inline-formula>and their corresponding subfragment <inline-formula id="IE34"><mml:math id="IM34"><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> were determined from the molecular structure. The molecule’s chemical fingerprint was then used to predict a probability for the existence of a peak, using the pre-built models for the subfragment. When several subfragment had associated models for a given peak, the highest probability of these was assigned to that peak.
<disp-formula id="E1"><mml:math id="M1"><mml:mi>P</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mi>C</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:munder><mml:mrow><mml:mi mathvariant="normal">max</mml:mi></mml:mrow><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:munder></mml:mrow><mml:mo>⁡</mml:mo><mml:mrow><mml:mi>P</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mo>|</mml:mo></mml:mrow><mml:mrow><mml:mi>C</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:mrow></mml:math></disp-formula></p>
    </sec>
    <sec>
      <title>2.4 Spectrum scoring</title>
      <p>Given a spectrum with peaks <inline-formula id="IE35"><mml:math id="IM35"><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> normalized peak intensities <inline-formula id="IE36"><mml:math id="IM36"><mml:msub><mml:mrow><mml:mi>I</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, the score for a molecule with chemical fingerprint <inline-formula id="IE37"><mml:math id="IM37"><mml:mi>C</mml:mi></mml:math></inline-formula> is calculated by summing over the peak probabilities, using the intensities as weights:
<disp-formula id="E2"><mml:math id="M2"><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mi>i</mml:mi></mml:munder><mml:mrow><mml:msub><mml:mrow><mml:mi>I</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>|</mml:mo><mml:mi>C</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:math></disp-formula></p>
      <p>Peaks are determined by searching for molecular formulas within a certain mass accuracy.</p>
    </sec>
    <sec>
      <title>2.5 Consensus scoring</title>
      <p>For consensus scoring, candidate molecules were scored both with our method as well with CSI: FingerID. A prediction was only accepted if both methods have the same top prediction. When there was a tie for the top prediction, no consensus prediction was recorded.</p>
    </sec>
    <sec>
      <title>2.6 Performance evaluation</title>
      <p>For the CASMI 2016 dataset, the results of CFM-ID were obtained from the author’s submission, the results of CSI: FingerID were calculated by Sirius 4.0. For the CASMI 2017 dataset, the results of CSI: FingerID were obtained from the author’s submission, the results of CFM-ID were calculated by SE-CFM-trained model. For the EMBL metabolomics core facility (EMBL-MCF) and GNPS datasets, the results of CFM-ID were calculated by SE-CFM-trained model, the results of CSI: FingerID were calculated by Sirius 4.0. If one spectrum had several top predictions, the tie was broken by randomization.</p>
    </sec>
    <sec>
      <title>2.7 Data availability and reproducibility</title>
      <p>The SF-Matching software and a tutorial can be accessed from <ext-link ext-link-type="uri" xlink:href="http://www.bork.embl.de/Docu/sf_matching">http://www.bork.embl.de/Docu/sf_matching</ext-link>. The source code is available at <ext-link ext-link-type="uri" xlink:href="https://git.embl.de/grp-bork/sf-matching">https://git.embl.de/grp-bork/sf-matching</ext-link>. An interactive example of using SF-Matching can be accessed at <ext-link ext-link-type="doi" xlink:href="10.24433/CO.6279326.v2">https://doi.org/10.24433/CO.6279326.v2</ext-link>. We further deposited the software and pre-calculated spectra predictions for relevant biological molecules [taken from KEGG (<xref rid="btz736-B16" ref-type="bibr">Kanehisa <italic>et al.</italic>, 2017</xref>), HMDB (<xref rid="btz736-B34" ref-type="bibr">Wishart <italic>et al.</italic>, 2018</xref>), ChEBI (<xref rid="btz736-B12" ref-type="bibr">Hastings <italic>et al.</italic>, 2016</xref>) and ChEMBL (<xref rid="btz736-B8" ref-type="bibr">Gaulton <italic>et al.</italic>, 2017</xref>)] in Zenodo: <ext-link ext-link-type="doi" xlink:href="10.5281/zenodo.3345099">http://doi.org/10.5281/zenodo.3345099</ext-link>.</p>
    </sec>
  </sec>
  <sec>
    <title>3 Results</title>
    <p>Our concept assumes that molecules consist of fragile and relatively stable substructures. Molecules with similar fragile structures will share similar fragmentation patterns even if they have different stable substructures. For example, in lysophosphatidylinositol and phosphatidylethanolamine, the inositol moiety, ethanolamine and the alkyl chain are stable substructures, connected by a fragile substructure containing ester bonds that are likely to lead to fragmentation. During fragmentation, the two different molecules with different alkyl chains will generate similar fatty acids as fragment ions, although the masses of their fragment ions are different (<xref ref-type="fig" rid="btz736-F1">Fig. 1a</xref>). In the fatty acid that can be detected as a fragmentation product, the alkyl chain is the stable substructure and the carboxyl group is the fragment of the fragile substructure.
</p>
    <fig id="btz736-F1" orientation="portrait" position="float">
      <label>Fig. 1.</label>
      <caption>
        <p>Schematic of the method. (<bold>a</bold>) The fragmentation of a molecule can be considered as breaking a fragile substructure surrounded by stable substructures. The resulting fragment contains both a stable substructure and part of the fragile substructure (which we term ‘subfragment’). (<bold>b</bold>) For training the method, we compare possible substructures to peaks in a reference database and calculate the subfragments that were observed. The presence of such a fragile subfragment can then be predicted based on the molecular fingerprint of the complete molecule</p>
      </caption>
      <graphic xlink:href="btz736f1"/>
    </fig>
    <p>Our aim was therefore to develop a method that can detect the presence of fragile substructures and based on this predict if a given spectrum is likely to belong to a particular compound. We use machine learning to associate structural information contained in 2D chemical fingerprints with fragmentation patterns. Molecular fingerprints encode the presence of various substructures of the molecule in a vector of bits. If two molecules have similar fragile substructures, some bits of the fingerprint will be the same. As the substructure may vary from molecule to molecule, in our approach, we do not try to identify the extract fragile substructure, but instead use the fingerprint to represent it, and use machine learning to detect the predictive parts of the fingerprint. Given a training database of molecular structures and mass spectra, we process each spectrum individually. On a high level, training the model works as follows (<xref ref-type="fig" rid="btz736-F1">Fig. 1b):</xref></p>
    <p>In the molecule associated with the spectrum, we find all substructures by individually breaking all covalent bonds in the molecules. For each broken bond, we record the resulting molecular formulas together with the bond type of the broken bond. For example, –C<sub>17</sub>H<sub>35</sub> is one of the substructures of lysophosphatidylinositol.</p>
    <p>For all peaks in the spectrum, we calculate the fragmentation products’ molecular formulas based on their m/z.</p>
    <p>For each fragmentation product, we check which substructures found in Step 1 are a subset of the fragmentation product’s molecular formula. For any fragmentation product, there may be several such substructures. Considering each substructure individually, we then designate it as the stable substructure. The remaining part of the fragmentation product must therefore be a part of the fragile substructure, and its molecular formula can be determined from the formulas of the fragmentation product and the stable substructure. Together with the bond type information, we call this part of the fragile substructure a ‘subfragment’. Each molecule in the database can be checked if it contains a subfragment.</p>
    <p>For each known molecule, we calculate its molecular fingerprint based on the structure of the complete molecule. After determining the presence of subfragments across all training spectra, random forest classifiers are trained for each subfragment based on the molecular fingerprint and the presence of the subfragment in each spectrum.</p>
    <p>For testing if a certain molecule is likely to belong to a given spectrum, we do the reverse: we calculate its molecular fingerprint and find all possible subfragments based on the peaks of the spectrum. Then for every subfragment, we use the corresponding random forest classifier to predict the probability of the subfragment. After finding the possible molecular substructures, we can calculate the mass of all possible fragment ions by adding the formula of subfragment to the formula of substructure.</p>
    <p>To increase the speed of the method, we pre-calculated the predicted spectra of all biomolecules in four databases that collect most of the known, relevant biological molecules [KEGG (<xref rid="btz736-B16" ref-type="bibr">Kanehisa <italic>et al.</italic>, 2017</xref>), HMDB (<xref rid="btz736-B34" ref-type="bibr">Wishart <italic>et al.</italic>, 2018</xref>), ChEBI (<xref rid="btz736-B12" ref-type="bibr">Hastings <italic>et al.</italic>, 2016</xref>) and ChEMBL (<xref rid="btz736-B8" ref-type="bibr">Gaulton <italic>et al.</italic>, 2017</xref>)]. This allows identification of compounds at a rate of more than 10 spectra per second on a laptop with a solid-state drive. The pre-calculated database and searching scripts can be downloaded from <ext-link ext-link-type="uri" xlink:href="http://www.bork.embl.de/Docu/sf_matching">http://www.bork.embl.de/Docu/sf_matching</ext-link>.</p>
    <p>We evaluated the performance of our approach by comparing it with CFM-ID (<xref rid="btz736-B1" ref-type="bibr">Allen <italic>et al.</italic>, 2015</xref>), and CSI: FingerID (<xref rid="btz736-B6" ref-type="bibr">Dührkop <italic>et al.</italic>, 2015</xref>), the two methods that showed very good performance in CASMI 2016 and can also run in batch mode (<xref rid="btz736-B28" ref-type="bibr">Schymanski <italic>et al.</italic>, 2017</xref>). As many of the test molecules also exist in those software’s training dataset, we remove the test spectra from our training dataset to achieve a fair comparison. First, we used all spectra provided in the context of the CASMI 2016 and 2017 automated structural identification challenge (<xref rid="btz736-B28" ref-type="bibr">Schymanski <italic>et al.</italic>, 2017</xref>) as benchmark dataset. To estimate the performance on multiple chemical databases, we limited the candidates to the molecules that are in the selected database. If one molecule was not present in the target database, the corresponding spectrum was not considered (<xref ref-type="supplementary-material" rid="sup1">Supplementary Table S3 and S4</xref>). In the CASMI 2016 dataset, SF-Matching had the best performance when searching against four different databases of known molecules (<xref ref-type="fig" rid="btz736-F2">Fig. 2a</xref>). In the CASMI 2017 dataset, although the performances of all methods dropped, SF-Matching still showed better performance (<xref ref-type="fig" rid="btz736-F2">Fig. 2b</xref>). As an additional benchmark, we also evaluated the methods using spectra from the EMBL-MCF spectral library (<xref rid="btz736-B23" ref-type="bibr">Palmer <italic>et al.</italic>, 2018</xref>; <xref ref-type="supplementary-material" rid="sup1">Supplementary Table S5</xref>). We selected candidate molecules from the respective chemical database with an m/z within 5 ppm of target molecules. In this dataset, SF-Matching had a better performance than CSI: FingerID and was also superior to CFM-ID (<xref ref-type="fig" rid="btz736-F2">Fig. 2c</xref>).
</p>
    <fig id="btz736-F2" orientation="portrait" position="float">
      <label>Fig. 2.</label>
      <caption>
        <p>Performance evaluations when removing the test spectra from training dataset. The accuracy and the sensitivity of SF-Matching, and the consensus method are compared against random prediction and two established methods on (<bold>a</bold>) the CASMI 2016 dataset, (<bold>b</bold>) the CASMI 2017 dataset and (<bold>c</bold>) the EMBL-MCF dataset. The number in the parentheses indicates the total number of molecules which are contained in the various chemical databases; on right of the bar the number of correctly identified molecules is shown. Details on the ranking can be found in Supplementary Tables</p>
      </caption>
      <graphic xlink:href="btz736f2"/>
    </fig>
    <p>For this and other approaches, the performance of <italic>in silico</italic> methods drops when removing not only test spectra, but all spectra for these molecules from the training dataset (<xref rid="btz736-B7" ref-type="bibr">Dührkop <italic>et al.</italic>, 2019</xref>). In CASMI 2016, the paper on CSI: FingerID reported its performance on positive ion when removing part of test molecules from the training dataset (<xref rid="btz736-B28" ref-type="bibr">Schymanski <italic>et al.</italic>, 2017</xref>). We removed all test molecules from our training dataset and rebuilt the model (<xref ref-type="supplementary-material" rid="sup1">Supplementary Table S6</xref>). In this dataset, our method has similar performance to CSI: FingerID (<xref ref-type="fig" rid="btz736-F3">Fig. 3a</xref>). Based on the published list of CSI: FingerID’s training molecules, we also selected spectra from GNPS dataset whose corresponding spectra are not in CSI: FingerID’s training dataset (<xref ref-type="supplementary-material" rid="sup1">Supplementary Table S7</xref>). For this dataset, we also removed molecules from our training dataset and found that our method performed better than CSI: FingerID (<xref ref-type="fig" rid="btz736-F3">Fig. 3b</xref>).
</p>
    <fig id="btz736-F3" orientation="portrait" position="float">
      <label>Fig. 3.</label>
      <caption>
        <p>Performance evaluations when removing the test molecules from training dataset. The accuracy and the sensitivity of SF-Matching, and the consensus method is compared against CSI: FingerID on (<bold>a</bold>) the positive ion of CASMI 2016 dataset and (<bold>b</bold>) the GNPS dataset. The number in the parentheses indicates the total number of molecules which are contained in the various chemical databases; on right of the bar the number of correctly identified molecules is shown</p>
      </caption>
      <graphic xlink:href="btz736f3"/>
    </fig>
    <p>As our concept differs from existing ones, we reasoned that it should be possible to achieve a better accuracy if we combine prediction methods. As CSI: FingerID showed good performance in all the three benchmark dataset, we selected spectra where both our method and CSI: FingerID gave the same results. These consensus results achieved about 20% increase in accuracy than any single method, reaching &gt;90% accuracy when analyzing the CASMI 2016 and EMBL-MCF datasets, and still &gt;70% when analyzing the CASMI 2017 dataset. Due to the consensus calculation this comes at the cost of making predictions for fewer spectra, in average, around 55% spectra had consensus identification. The fraction varied between 40 and 80% in the CASMI 2016 and EMBL-MCF datasets and between 10 and 45% in CASMI 2017 (<xref ref-type="fig" rid="btz736-F4">Fig. 4</xref>).
</p>
    <fig id="btz736-F4" orientation="portrait" position="float">
      <label>Fig. 4.</label>
      <caption>
        <p>The fraction of spectra with consensus prediction. The number in the parentheses indicates the total number of molecules which are contained in the various chemical databases; on right of the bar the number of spectra with consensus prediction is shown</p>
      </caption>
      <graphic xlink:href="btz736f4"/>
    </fig>
    <p>SF-matching uses structural features of molecules to build machine learning models and predict the probability that a given molecule spectrum gives rise to a measured spectrum. As machine learning approaches gain power with increasing training sets, we randomly selected subsets of the training dataset to evaluate the performance. Indeed, we observed an increase in the prediction performance with increased training set size (<xref ref-type="fig" rid="btz736-F5">Fig. 5</xref>). This result suggests that SF-matching will increase performance with time with more experimental spectra becoming available. As shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Figure S1</xref>, the training data covers a wide range of the chemical space. Therefore, a general increase in the number of training molecules should be sufficient to increase the performance of SF-Matching.
</p>
    <fig id="btz736-F5" orientation="portrait" position="float">
      <label>Fig. 5.</label>
      <caption>
        <p>The effect of training dataset size on the performance on all datasets. For each training dataset size, three training datasets were randomly sampled from the origin whole dataset; here, we use the combination of four databases as candidate database</p>
      </caption>
      <graphic xlink:href="btz736f5"/>
    </fig>
    <p>Taken together, we have developed a new method called SF-Matching to identify the spectra of small molecules in biological samples. Depending on the goals of the MS experiments, SF-matching itself can be used to contribute to candidate molecule identification, given its stand- alone performance, but it can also be used in combination with CSI: FingerID for candidate predictions with high accuracy. Furthermore, as expected from machine learning techniques, the power of the method will increase in the future with the addition of diverse known spectra of biomolecules.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="sup1">
      <label>btz736_Supplementary_Data</label>
      <media xlink:href="btz736_supplementary_data.zip">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack id="ack1">
    <title>Acknowledgements</title>
    <p>We thank Joseph Christian Somody, Marco Hennrich, Prasad Phapale and other members of the Bork and Gavin groups as wells as the EMBL-MCF for helpful discussions, Enric Mila Vilalta for assistance with the benchmark dataset, and Yan Ping Yuan for IT support.</p>
    <sec>
      <title>Funding</title>
      <p>We acknowledge funding from EMBL and the MicrobioS grant [ERC-AdG-669830].</p>
      <p><italic>Conflict of Interest:</italic> none declared.</p>
    </sec>
  </ack>
  <ref-list id="ref1">
    <title>References</title>
    <ref id="btz736-B1">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Allen</surname><given-names>F.</given-names></name></person-group><etal>et al</etal> (<year>2015</year>) 
<article-title>Competitive fragmentation modeling of ESI-MS/MS spectra for putative metabolite identification</article-title>. <source>Metabolomics</source>, <volume>11</volume>, <fpage>98</fpage>–<lpage>110</lpage>.</mixed-citation>
    </ref>
    <ref id="btz736-B2">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Beger</surname><given-names>R.D.</given-names></name></person-group><etal>et al</etal> (<year>2016</year>) 
<article-title>Metabolomics enables precision medicine: “A White Paper, Community Perspective”</article-title>. <source>Metabolomics</source>, <volume>12</volume>, <fpage>149.</fpage><pub-id pub-id-type="pmid">27642271</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B3">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Benton</surname><given-names>H.P.</given-names></name></person-group><etal>et al</etal> (<year>2008</year>) 
<article-title>XCMS2: processing tandem mass spectrometry data for metabolite identification and structural characterization</article-title>. <source>Anal. Chem</source>., <volume>80</volume>, <fpage>6382</fpage>–<lpage>6389</lpage>.<pub-id pub-id-type="pmid">18627180</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B4">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Blaženović</surname><given-names>I.</given-names></name></person-group><etal>et al</etal> (<year>2018</year>) Software tools and approaches for compound identification of LC-MS/MS data in metabolomics <source>Metabolites</source>, <volume>8</volume>, <fpage>31</fpage>.</mixed-citation>
    </ref>
    <ref id="btz736-B5">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Brouard</surname><given-names>C.</given-names></name></person-group><etal>et al</etal> (<year>2016</year>) 
<article-title>Fast metabolite identification with Input Output Kernel Regression</article-title>. <source>Bioinformatics</source>, <volume>32</volume>, <fpage>i28</fpage>–<lpage>i36</lpage>.<pub-id pub-id-type="pmid">27307628</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B6">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Dührkop</surname><given-names>K.</given-names></name></person-group><etal>et al</etal> (<year>2015</year>) 
<article-title>Searching molecular structure databases with tandem mass spectra using CSI: FingerID</article-title>. <source>Proc. Natl. Acad. Sci. USA</source>, <volume>112</volume>, <fpage>12580</fpage>–<lpage>12585</lpage>.<pub-id pub-id-type="pmid">26392543</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B7">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Dührkop</surname><given-names>K.</given-names></name></person-group><etal>et al</etal> (<year>2019</year>) 
<article-title>SIRIUS 4: a rapid tool for turning tandem mass spectra into metabolite structure information</article-title>. <source>Nat. Methods</source>, <volume>16</volume>, <fpage>299</fpage>–<lpage>302</lpage>.<pub-id pub-id-type="pmid">30886413</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B8">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Gaulton</surname><given-names>A.</given-names></name></person-group><etal>et al</etal> (<year>2017</year>) 
<article-title>The ChEMBL database in 2017</article-title>. <source>Nucleic Acids Res</source>., <volume>45</volume>, <fpage>D945</fpage>–<lpage>D954</lpage>.<pub-id pub-id-type="pmid">27899562</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B10">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Guijas</surname><given-names>C.</given-names></name></person-group><etal>et al</etal> (<year>2018</year>) 
<article-title>Metabolomics activity screening for identifying metabolites that modulate phenotype</article-title>. <source>Nat. Biotechnol</source>., <volume>36</volume>, <fpage>316</fpage>–<lpage>320</lpage>.<pub-id pub-id-type="pmid">29621222</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B11">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Halgren</surname><given-names>T.A.</given-names></name></person-group> (<year>1996</year>) 
<article-title>Merck molecular force field. I. Basis, form, scope, parameterization, and performance of MMFF94</article-title>. <source>J. Comput. Chem</source>., <volume>17</volume>, <fpage>490</fpage>–<lpage>519</lpage>.</mixed-citation>
    </ref>
    <ref id="btz736-B12">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Hastings</surname><given-names>J.</given-names></name></person-group><etal>et al</etal> (<year>2016</year>) 
<article-title>ChEBI in 2016: improved services and an expanding collection of metabolites</article-title>. <source>Nucleic Acids Res</source>., <volume>44</volume>, <fpage>D1214</fpage>–<lpage>D1219</lpage>.<pub-id pub-id-type="pmid">26467479</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B13">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Heinonen</surname><given-names>M.</given-names></name></person-group><etal>et al</etal> (<year>2012</year>) 
<article-title>Metabolite identification and molecular fingerprint prediction through machine learning</article-title>. <source>Bioinformatics</source>, <volume>28</volume>, <fpage>2333</fpage>–<lpage>2341</lpage>.<pub-id pub-id-type="pmid">22815355</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B14">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Horai</surname><given-names>H.</given-names></name></person-group><etal>et al</etal> (<year>2010</year>) 
<article-title>MassBank: a public repository for sharing mass spectral data for life sciences</article-title>. <source>J. Mass Spectrom</source>., <volume>45</volume>, <fpage>703</fpage>–<lpage>714</lpage>.<pub-id pub-id-type="pmid">20623627</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B15">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Hummel</surname><given-names>J.</given-names></name></person-group><etal>et al</etal> (<year>2010</year>) 
<article-title>Decision tree supported substructure prediction of metabolites from GC-MS profiles</article-title>. <source>Metabolomics</source>, <volume>6</volume>, <fpage>322</fpage>–<lpage>333</lpage>.<pub-id pub-id-type="pmid">20526350</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B16">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Kanehisa</surname><given-names>M.</given-names></name></person-group><etal>et al</etal> (<year>2017</year>) 
<article-title>KEGG: new perspectives on genomes, pathways, diseases and drugs</article-title>. <source>Nucleic Acids Res</source>., <volume>45</volume>, <fpage>D353</fpage>–<lpage>D361</lpage>.<pub-id pub-id-type="pmid">27899662</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B17">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Kangas</surname><given-names>L.J.</given-names></name></person-group><etal>et al</etal> (<year>2012</year>) 
<article-title>In silico identification software (ISIS): a machine learning approach to tandem mass spectral identification of lipids</article-title>. <source>Bioinformatics</source>, <volume>28</volume>, <fpage>1705</fpage>–<lpage>1713</lpage>.<pub-id pub-id-type="pmid">22592377</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B18">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Kind</surname><given-names>T.</given-names></name></person-group><etal>et al</etal> (<year>2018</year>) 
<article-title>Identification of small molecules using accurate mass MS/MS search</article-title>. <source>Mass Spectrom. Rev</source>., <volume>37</volume>, <fpage>513</fpage>–<lpage>532</lpage>.<pub-id pub-id-type="pmid">28436590</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B19">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Laponogov</surname><given-names>I.</given-names></name></person-group><etal>et al</etal> (<year>2018</year>) 
<article-title>ChemDistiller: an engine for metabolite annotation in mass spectrometry</article-title>. <source>Bioinformatics</source>, <volume>34</volume>, <fpage>2096</fpage>–<lpage>2102</lpage>.<pub-id pub-id-type="pmid">29447341</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B20">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Ludwig</surname><given-names>M.</given-names></name></person-group><etal>et al</etal> (<year>2018</year>) 
<article-title>Bayesian networks for mass spectrometric metabolite identification via molecular fingerprints</article-title>. <source>Bioinformatics</source>, <volume>34</volume>, <fpage>i333</fpage>–<lpage>i340</lpage>.<pub-id pub-id-type="pmid">29949965</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B21">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Nguyen</surname><given-names>D.H.</given-names></name></person-group><etal>et al</etal> (<year>2018</year>) 
<article-title>Recent advances and prospects of computational methods for metabolite identification: a review with emphasis on machine learning approaches</article-title>. <source>Brief. Bioinform</source>., bby066. </mixed-citation>
    </ref>
    <ref id="btz736-B22">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>O’Kell</surname><given-names>A.L.</given-names></name></person-group><etal>et al</etal> (<year>2017</year>) 
<article-title>Untargeted metabolomic analysis in naturally occurring canine diabetes mellitus identifies similarities to human Type 1</article-title>. <source>Diabetes. Sci. Rep</source>., <volume>7</volume>, <fpage>9467</fpage>.<pub-id pub-id-type="pmid">28842637</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B23">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Palmer</surname><given-names>A.</given-names></name></person-group><etal>et al</etal> (<year>2018</year>) 
<article-title>Curatr: a web application for creating, curating and sharing a mass spectral library</article-title>. <source>Bioinformatics</source>, <volume>34</volume>, <fpage>1436</fpage>–<lpage>1438</lpage>.<pub-id pub-id-type="pmid">29253079</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B24">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Pedregosa</surname><given-names>F.</given-names></name></person-group><etal>et al</etal> (<year>2012</year>) 
<article-title>Scikit-learn: machine Learning in Python</article-title>. <source>J. Mach. Learn. Res</source>., <volume>12</volume>, <fpage>2825</fpage>–<lpage>2830</lpage>.</mixed-citation>
    </ref>
    <ref id="btz736-B9">
      <mixed-citation publication-type="other">RDKit: Open-source cheminformatics; http://www.rdkit.org.</mixed-citation>
    </ref>
    <ref id="btz736-B25">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Ruttkies</surname><given-names>C.</given-names></name></person-group><etal>et al</etal> (<year>2016</year>) 
<article-title>MetFrag relaunched: incorporating strategies beyond in silico fragmentation</article-title>. <source>J. Cheminform</source>., <volume>8</volume>, <fpage>3.</fpage><pub-id pub-id-type="pmid">26834843</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B26">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Schrimpe-Rutledge</surname><given-names>A.C.</given-names></name></person-group><etal>et al</etal> (<year>2016</year>) 
<article-title>Untargeted metabolomics strategies—challenges and emerging directions</article-title>. <source>J. Am. Soc. Mass Spectrom</source>., <volume>27</volume>, <fpage>1897</fpage>–<lpage>1905</lpage>.<pub-id pub-id-type="pmid">27624161</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B27">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Schüler</surname><given-names>J.A.</given-names></name></person-group><etal>et al</etal> (<year>2018</year>) 
<article-title>ChemFrag: chemically meaningful annotation of fragment ion mass spectra</article-title>. <source>J. Mass Spectrom</source>., <volume>53</volume>, <fpage>1104</fpage>–<lpage>1115</lpage>.<pub-id pub-id-type="pmid">30103269</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B28">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Schymanski</surname><given-names>E.L.</given-names></name></person-group><etal>et al</etal> (<year>2017</year>) 
<article-title>Critical Assessment of Small Molecule Identification 2016: automated methods</article-title>. <source>J. Cheminform</source>., <volume>9</volume>, <fpage>22</fpage>.<pub-id pub-id-type="pmid">29086042</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B29">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Tsugawa</surname><given-names>H.</given-names></name></person-group><etal>et al</etal> (<year>2016</year>) 
<article-title>Hydrogen rearrangement rules: computational MS/MS fragmentation and structure elucidation using MS-FINDER software</article-title>. <source>Anal. Chem</source>., <volume>88</volume>, <fpage>7946</fpage>–<lpage>7958</lpage>.<pub-id pub-id-type="pmid">27419259</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B30">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>van der Hooft</surname><given-names>J.J.J.</given-names></name></person-group><etal>et al</etal> (<year>2016</year>) 
<article-title>Topic modeling for untargeted substructure exploration in metabolomics</article-title>. <source>Proc. Natl. Acad. Sci. USA</source>, <volume>113</volume>, <fpage>13738</fpage>–<lpage>13743</lpage>.<pub-id pub-id-type="pmid">27856765</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B31">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>van der Hooft</surname><given-names>J.J.J.</given-names></name></person-group><etal>et al</etal> (<year>2017</year>) 
<article-title>Unsupervised discovery and comparison of structural families across multiple samples in untargeted metabolomics</article-title>. <source>Anal. Chem</source>., <volume>89</volume>, <fpage>7569</fpage>–<lpage>7577</lpage>.<pub-id pub-id-type="pmid">28621528</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B32">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Vaniya</surname><given-names>A.</given-names></name>, <name name-style="western"><surname>Fiehn</surname><given-names>O.</given-names></name></person-group> (<year>2015</year>) 
<article-title>Using fragmentation trees and mass spectral trees for identifying unknown compounds in metabolomics</article-title>. <source>Trends Analyt. Chem</source>., <volume>69</volume>, <fpage>52</fpage>–<lpage>61</lpage>.</mixed-citation>
    </ref>
    <ref id="btz736-B33">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Wang</surname><given-names>M.</given-names></name></person-group><etal>et al</etal> (<year>2016</year>) 
<article-title>Sharing and community curation of mass spectrometry data with Global Natural Products Social Molecular Networking</article-title>. <source>Nat. Biotechnol</source>., <volume>34</volume>, <fpage>828</fpage>–<lpage>837</lpage>.<pub-id pub-id-type="pmid">27504778</pub-id></mixed-citation>
    </ref>
    <ref id="btz736-B34">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Wishart</surname><given-names>D.S.</given-names></name></person-group><etal>et al</etal> (<year>2018</year>) 
<article-title>HMDB 4.0: the human metabolome database for 2018</article-title>. <source>Nucleic Acids Res</source>., <volume>46</volume>, <fpage>D608</fpage>–<lpage>D617</lpage>.<pub-id pub-id-type="pmid">29140435</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
