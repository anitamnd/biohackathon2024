<?DTDIdentifier.IdentifierValue article.dtd?>
<?DTDIdentifier.IdentifierType system?>
<?SourceDTD.DTDName article.dtd?>
<?SourceDTD.Version v40?>
<?ConverterInfo.XSLTName bmc2nlm.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">BMC Bioinformatics</journal-id>
    <journal-title>BMC Bioinformatics</journal-title>
    <issn pub-type="epub">1471-2105</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">2724425</article-id>
    <article-id pub-id-type="publisher-id">1471-2105-10-232</article-id>
    <article-id pub-id-type="pmid">19635165</article-id>
    <article-id pub-id-type="doi">10.1186/1471-2105-10-232</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Methodology Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>BSMAP: whole genome bisulfite sequence MAPping program</article-title>
    </title-group>
    <contrib-group>
      <contrib id="A1" contrib-type="author">
        <name>
          <surname>Xi</surname>
          <given-names>Yuanxin</given-names>
        </name>
        <xref ref-type="aff" rid="I1">1</xref>
        <email>yxi@bcm.edu</email>
      </contrib>
      <contrib id="A2" corresp="yes" contrib-type="author">
        <name>
          <surname>Li</surname>
          <given-names>Wei</given-names>
        </name>
        <xref ref-type="aff" rid="I1">1</xref>
        <email>WL1@bcm.edu</email>
      </contrib>
    </contrib-group>
    <aff id="I1"><label>1</label>Division of Biostatistics, Dan L Duncan Cancer Center, Department of Molecular and Cellular Biology, Baylor College of Medicine, One Baylor Plaza, Houston, TX 77030, USA</aff>
    <pub-date pub-type="collection">
      <year>2009</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>27</day>
      <month>7</month>
      <year>2009</year>
    </pub-date>
    <volume>10</volume>
    <fpage>232</fpage>
    <lpage>232</lpage>
    <ext-link ext-link-type="uri" xlink:href="http://www.biomedcentral.com/1471-2105/10/232"/>
    <history>
      <date date-type="received">
        <day>29</day>
        <month>5</month>
        <year>2009</year>
      </date>
      <date date-type="accepted">
        <day>27</day>
        <month>7</month>
        <year>2009</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>Copyright © 2009 Xi and Li; licensee BioMed Central Ltd.</copyright-statement>
      <copyright-year>2009</copyright-year>
      <copyright-holder>Xi and Li; licensee BioMed Central Ltd.</copyright-holder>
      <license license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/2.0">
        <p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/2.0"/>), which permits unrestricted use, distribution, and reproduction in any medium, provided the original work is properly cited.</p>
        <!--<rdf xmlns="http://web.resource.org/cc/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:dc="http://purl.org/dc/elements/1.1" xmlns:dcterms="http://purl.org/dc/terms"><Work xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" rdf:about=""><license rdf:resource="http://creativecommons.org/licenses/by/2.0"/><dc:type rdf:resource="http://purl.org/dc/dcmitype/Text"/><dc:author>
               Xi
               Yuanxin
               
               yxi@bcm.edu
            </dc:author><dc:title>
            BSMAP: whole genome bisulfite sequence MAPping program
         </dc:title><dc:date>2009</dc:date><dcterms:bibliographicCitation>BMC Bioinformatics 10(1): 232-. (2009)</dcterms:bibliographicCitation><dc:identifier type="sici">1471-2105(2009)10:1&#x0003c;232&#x0003e;</dc:identifier><dcterms:isPartOf>urn:ISSN:1471-2105</dcterms:isPartOf><License rdf:about="http://creativecommons.org/licenses/by/2.0"><permits rdf:resource="http://web.resource.org/cc/Reproduction" xmlns=""/><permits rdf:resource="http://web.resource.org/cc/Distribution" xmlns=""/><requires rdf:resource="http://web.resource.org/cc/Notice" xmlns=""/><requires rdf:resource="http://web.resource.org/cc/Attribution" xmlns=""/><permits rdf:resource="http://web.resource.org/cc/DerivativeWorks" xmlns=""/></License></Work></rdf>-->
      </license>
    </permissions>
    <abstract>
      <sec>
        <title>Background</title>
        <p>Bisulfite sequencing is a powerful technique to study DNA cytosine methylation. Bisulfite treatment followed by PCR amplification specifically converts unmethylated cytosines to thymine. Coupled with next generation sequencing technology, it is able to detect the methylation status of every cytosine in the genome. However, mapping high-throughput bisulfite reads to the reference genome remains a great challenge due to the increased searching space, reduced complexity of bisulfite sequence, asymmetric cytosine to thymine alignments, and multiple CpG heterogeneous methylation.</p>
      </sec>
      <sec>
        <title>Results</title>
        <p>We developed an efficient bisulfite reads mapping algorithm BSMAP to address the above issues. BSMAP combines genome hashing and bitwise masking to achieve fast and accurate bisulfite mapping. Compared with existing bisulfite mapping approaches, BSMAP is faster, more sensitive and more flexible.</p>
      </sec>
      <sec>
        <title>Conclusion</title>
        <p>BSMAP is the first general-purpose bisulfite mapping software. It is able to map high-throughput bisulfite reads at whole genome level with feasible memory and CPU usage. It is freely available under GPL v3 license at <ext-link ext-link-type="uri" xlink:href="http://code.google.com/p/bsmap/"/>.</p>
      </sec>
    </abstract>
  </article-meta>
</front>
<body>
  <sec>
    <title>Background</title>
    <p>Cytosine (C) DNA methylation plays a crucial role in various biological processes such as gene expression, chromatin accessibility, and imprinting, as well as in many diseases including cancer. Over the decades, bisulfite sequencing [<xref ref-type="bibr" rid="B1">1</xref>] has remained the gold standard for DNA methylation analysis. Bisulfite treatment of DNA followed by PCR amplification leads to a chemical conversion of unmethylated Cs to Ts without affecting As, Gs, Ts or methylated Cs. This C to T conversion results in non-complementarity in the two strands of DNA (Figure <xref ref-type="fig" rid="F1">1</xref>). Following strand-specific and locus-specific PCR amplification, direct- or pyro-sequencing is used to determine the methylation ratio of any given C locus as the proportion of remaining Cs in all the sequencing reads. This PCR-based procedure is very labor intensive and time-consuming, and therefore inappropriate for high throughput studies.</p>
    <fig position="float" id="F1">
      <label>Figure 1</label>
      <caption>
        <p><bold>Pipeline of bisulfite sequencing</bold>. 1) Denaturation: separating Watson and Crick strands; 2) Bisulfite treatment: converting un-methylated cytosines (blue) to uracils; methylated cytosines (red) remain unchanged; 3) PCR amplification of bisulfite-treated sequences resulting in four distinct strands: Bisulfite Watson (BSW), bisulfite Crick (BSC), reverse complement of BSW (BSWR), and reverse complement of BSC (BSCR).</p>
      </caption>
      <graphic xlink:href="1471-2105-10-232-1"/>
    </fig>
    <p>Tremendous progress has been achieved in the past two years in the development of massively parallel sequencing such as Illumina/Solexa and Applied Biosystems/SOLiD. Tens of millions of short tags (36–75 bases) can now be simultaneously sequenced at less than 1% of the cost of traditional Sanger methods. Without the locus-specific PCR step, bisulfite treatment coupled with next-generation shotgun sequencing (BS-seq) [<xref ref-type="bibr" rid="B2">2</xref>-<xref ref-type="bibr" rid="B4">4</xref>] has become a powerful technique with the potential to quantitatively detect the methylation pattern of every C in the genome. Nevertheless, the mapping of millions of bisulfite reads to the reference genome remains a computational challenge.</p>
    <sec>
      <title>Problems</title>
      <p>First, the searching space is significantly increased relative to the original reference sequence. Unlike normal sequencing, the Watson and Crick strands of bisulfite-treated sequences are not complementary to each other because the bisulfite conversion only occurs on Cs. As a result, there will be four distinct strands after PCR amplification: BSW (bisulfite Watson), BSWR (reverse complement of BSW), BSC (bisulfite Crick), and BSCR (reverse complement of BSC) (Figure <xref ref-type="fig" rid="F1">1</xref>). During shotgun sequencing, a bisulfite read is almost equally likely to be derived from any of the four strands.</p>
      <p>Second, sequence complexity is reduced. In the mammalian genome, although ~19% of the bases are Cs and another 19% are Gs, only ~1.8% of dinucleotides are CpG dinucleotides. Because C methylation occurs almost exclusively at CpG dinucleotide, the vast majority of Cs in BSW and BSC strands will be converted to Ts. Therefore, most reads from the above two strands will be C-poor. However, PCR amplification will transcribe all Gs as Cs in BSWR and BSCR strands, so reads from those two strands are typically G-poor and have a normal C content. As a result, we expect the overall C content of bisulfite reads to be reduced by ~50%.</p>
      <p>Third, C to T mapping is asymmetric. The T in the bisulfite reads could be mapped to either C or T in the reference but not vice versa. This phenomenon not only increases the search space for mapping but also complicates the matching process (Figure <xref ref-type="fig" rid="F2">2</xref>). Efficient implementation of such asymmetric C/T matching is critical for mapping high-throughput bisulfite reads to the reference genome and is still lacking in current short read alignment software.</p>
      <fig position="float" id="F2">
        <label>Figure 2</label>
        <caption>
          <p><bold>Mapping of bisulfite reads</bold>. 1) Increased search space due to the cytosine-thymine conversion in the bisulfite treatment. 2) Mapping asymmetry: thymines in bisulfite reads can be aligned with cytosines in the reference (illustrated in blue) but not the reverse.</p>
        </caption>
        <graphic xlink:href="1471-2105-10-232-2"/>
      </fig>
      <p>A common approach to overcome these issues is to convert all Cs to Ts and map the converted reads to the converted reference; then, the alignment results are post-processed to count false-positive bisulfite C/T alignments as mismatches, where a C in the BS-read is aligned to a T in the reference [<xref ref-type="bibr" rid="B2">2</xref>]. Although this all-inclusive C/T conversion is effective for reads derived from the C-poor strands, it is not appropriate for reads derived from the G-poor strands, where all the Cs are actually transcribed from Gs by PCR amplification and thus could not be converted to Ts during bisulfite treatment. During shotgun sequencing, however, a bisulfite read is almost equally likely to be derived from either the C-poor or the G-poor strands. There is no precise way to determine the original strand a bisulfite read is derived from. Furthermore, by ignoring the C/T mapping asymmetry, this strategy generates a large number of false-positive bisulfite mappings and greatly increases the computational load in a quadratic manner with an increase in the size of the reference sequence. In order to accurately extract the true bisulfite mappings in the post-processing stage, all mapping locations have to be recorded, even the non-unique mappings. Therefore, this approach is only practical for small reference sequences, where only the C-poor strands are sequenced. For example, Meissner et al. used this mapping strategy for reduced representation bisulfite sequencing (RRBS) [<xref ref-type="bibr" rid="B2">2</xref>], where the genomic DNA was digested by the Mspl restriction enzyme and 40–220 bp segments were selected for sequencing. The reference sequence (~27 M nt) is only about 1% of the whole mouse genome, covering 4.8% of the total CpG dinucleotides.</p>
      <p>Lister et al. used another bisulfite mapping strategy in their study of DNA methylation in <italic>Arabidopsis </italic>[<xref ref-type="bibr" rid="B3">3</xref>]. Bisulfite reads were aligned to 3 reference sequences, namely the original genome and the two bisulfite-converted genomes with Cs converted to Ts for the forward strand and Gs converted to As for the reverse strand. The mapping results for all three references were combined to generate methylation information. Unlike the strategy used by Meissner et al. [<xref ref-type="bibr" rid="B2">2</xref>], this approach does not change the bisulfite read but rather captures possible bisulfite C/T alignments by allowing them to be mismatches. The biggest drawback of this approach is that the number of bisulfite C/T alignments that can be detected in a read is bounded by the number of mismatches allowed by the mapping software; this number might be further reduced by true mismatches such as SNPs. In this study, the bisulfite read length was 32 bp and 2 mismatches were allowed, so reads with more than 2 bisulfite C/T alignments, most of which were derived from CpG islands, were not detectable. This strategy could substantially compromise the mapping sensitivity.</p>
      <p>Naturally, it is desirable to map bisulfite reads directly to the reference sequence. Cokus et al. [<xref ref-type="bibr" rid="B4">4</xref>] used a custom-made tool, CokusAlignment, to map bisulfite reads to the <italic>Arabidopsis </italic>genome. This method is based on a tree searching algorithm, which is both computationally intensive and memory demanding. CokusAlignment runs at a moderate speed (~25 reads/sec/CPU) with a relatively small genome (~120 M nt) by applying many project-specific optimizations, which might not be applicable to larger genomes or longer bisulfite reads. In addition, CokusAlignment does not support basic alignment functions such as gapped or pair-end alignment. From a practical point of view, this method is not suitable for general purpose bisulfite sequence mapping due to its slow speed, lack of functions, and excessive hardware requirements, especially for large genomes. To our knowledge, an efficient, multifunctional, general-purpose bisulfite sequence mapping software is not yet available, and the lack of such a tool has become a major bottleneck for whole-genome DNA methylation profiling using bisulfite sequencing.</p>
      <p>We present here a general-purpose Bisulfite Sequence MAPping program, BSMAP, which addresses all the above issues. We used the general premise that all the C positions in the genome, where the asymmetric C/T transition can occur, are already known and can be used to guide the mapping of bisulfite reads. BSMAP masks Ts in the bisulfite reads as Cs (i.e., reverse bisulfite conversion) only at C positions in the original reference while keeping all other Ts in the bisulfite reads unchanged. BSMAP then maps the masked BS read directly to the reference. The asymmetric C/T conversion is achieved through position-specific bitwise masking of the bisulfite reads; this method is extremely fast. In addition, BSMAP is based on the more efficient HASH table seeding algorithm, which indexes the reference for all possible k-mers, called seeds, and only searches the locations where the seeds are perfectly matched with part of the read. By looking up the seed table, the majority of non-mapping positions are skipped, and the searching efficiency is greatly improved. The seeding length and patterns can also be adjusted to allow for a different number of mismatches. Because of these advantages, the seeding algorithm has been incorporated into most short read mapping software, including SOAP [<xref ref-type="bibr" rid="B5">5</xref>], ELAND, MAQ [<xref ref-type="bibr" rid="B6">6</xref>], and RMAP [<xref ref-type="bibr" rid="B7">7</xref>]. By combining fast seeding and bitwise masking (Figure <xref ref-type="fig" rid="F3">3</xref>), BSMAP offers a great improvement in performance as well as flexibility over the existing bisulfite mapping approaches.</p>
      <fig position="float" id="F3">
        <label>Figure 3</label>
        <caption>
          <p><bold>BSMAP algorithm</bold>. A) Bisulfite seed table, using the original seed and bisulfite variants as keys and corresponding coordinates in the reference genome as values. Each read was looked up in the seed table for potential mapping positions. B) A positional specific mask of the corresponding reference sequence was generated by setting 01 to C(light blue) and 11 to A, G, T(black). The original read was masked by a bitwise AND operation with the positional specific mask. C) The reference sequence and the masked read were compared with a bitwise XOR operation. Non-zero XOR results were counted as mismatches (red). Bisulfite alignment is marked in green.</p>
        </caption>
        <graphic xlink:href="1471-2105-10-232-3"/>
      </fig>
    </sec>
  </sec>
  <sec>
    <title>Results and discussion</title>
    <sec>
      <title>HASH table seeding</title>
      <p>We implemented BSMAP based on the open source software SOAP (Short Oligonucleotide Alignment Program) [<xref ref-type="bibr" rid="B5">5</xref>]. To find all possible mapping positions, each bisulfite read is divided into 4 parts, two of which are combined to form 6 possible seeds. To find the possible mapping positions, these seeds are then looked up in a HASH table that is pre-compiled from the reference sequence. To accommodate the C/T mapping issue, the HASH table includes all possible seeds in the reference sequence with their bisulfite variants as keys and the corresponding coordinates as values. The bisulfite variants of a specific seed are generated by enumerating all possible C=&gt;T combinations (Figure <xref ref-type="fig" rid="F3">3A</xref>).</p>
    </sec>
    <sec>
      <title>Bitwise masking</title>
      <p>For each possible mapping location, the actual number of mismatches between the bisulfite read and the reference needs to be counted, allowing a T in the bisulfite read to map to a C in the reference. Each DNA nucleotide is represented by two bits (i.e., A: 00, C: 01, G:10, T:11) and DNA sequences are represented as binary strings. We transfer a T in the bisulfite read to C where a corresponding C in the reference by applying a bit mask. Specifically, a bitwise AND mask (01) is used to convert a T (11) to C (01) or keep a C (01) unchanged where the reference is a C (i.e., active); an AND mask (11), which actually does not change anything (i.e., inactive), is used where the reference is an A, G, or T (Figure <xref ref-type="fig" rid="F3">3B</xref>). The complete matching results between the original bisulfite reads and references are listed in Table <xref ref-type="table" rid="T1">1</xref>.</p>
      <table-wrap position="float" id="T1">
        <label>Table 1</label>
        <caption>
          <p>Bisulfite matching table after bitwise masking</p>
        </caption>
        <table frame="hsides" rules="groups">
          <thead>
            <tr>
              <td align="left">Reference</td>
              <td/>
              <td align="left">A (00)</td>
              <td align="left">C (01)</td>
              <td align="left">G (10)</td>
              <td align="left">T (11)</td>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">Mask</td>
              <td/>
              <td align="left">11 (inactive)</td>
              <td align="left">01 (active)</td>
              <td align="left">11 (inactive)</td>
              <td align="left">11 (inactive)</td>
            </tr>
            <tr>
              <td colspan="6">
                <hr/>
              </td>
            </tr>
            <tr>
              <td align="left">Bisulfite Read</td>
              <td align="left">A(00)</td>
              <td align="left">00 (match)</td>
              <td align="left">01</td>
              <td align="left">10</td>
              <td align="left">11</td>
            </tr>
            <tr>
              <td/>
              <td align="left">C(01)</td>
              <td align="left">10</td>
              <td align="left">00 (match)</td>
              <td align="left">11</td>
              <td align="left">10</td>
            </tr>
            <tr>
              <td/>
              <td align="left">G(10) =&gt; A(00) if reference is C</td>
              <td align="left">10</td>
              <td align="left">01</td>
              <td align="left">00 (match)</td>
              <td align="left">01</td>
            </tr>
            <tr>
              <td/>
              <td align="left">T(11) =&gt; C(01) if reference is C</td>
              <td align="left">11</td>
              <td align="left">00 (match)</td>
              <td align="left">01</td>
              <td align="left">00 (match)</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
      <p>The bitwise masks are also stored in a HASH table structure as values, with the corresponding sequences as keys. Counting bisulfite mismatches only adds one table query and one bitwise AND operation to a normal sequence mapping. Both operations can be executed very efficiently, and the computational load is only slightly increased.</p>
    </sec>
    <sec>
      <title>Mismatch counting</title>
      <p>Mismatch counting is implemented through a bitwise exclusive OR (XOR) operation between the masked bisulfite read and the reference. For any two nucleotides, the XOR operation returns a zero if they are the same (match) and a non-zero (mismatch) otherwise. The number of mismatches between two sequences is the total number of non-zero two-bit segments. As illustrated in Figure <xref ref-type="fig" rid="F3">3B</xref> and <xref ref-type="fig" rid="F3">3C</xref>, the mask "01" generated by a C in the 2<sup>nd </sup>position in the reference genome (light blue) converts the T in the original read to a C in the masked read (green); the result is a match (XOR result "00") in the mismatch counting. The T in the read is correctly aligned with the C in the reference without being identified as a mismatch. On the other hand, normal mismatches are not affected by the bisulfite mask, as indicated by the mismatches detected at the 10<sup>th </sup>and 12<sup>th </sup>nucleotides (red). In the 12<sup>th </sup>nt position, a T in the read was identified as a mismatch to the C in the reference because the mask "11" corresponding to the T in the reference did not change the C in the read, illustrating the asymmetry of C/T alignment.</p>
    </sec>
    <sec>
      <title>Other BSMAP features</title>
      <p>As discussed earlier, each bisulfite read needs to be aligned to four bisulfite strands (BSW, BSWR, BSC, BSCR) instead of two normal strands (Watson and Crick) as in normal read mapping. In BSMAP, each bisulfite read and its reverse complementary sequence are aligned with both the Watson and the Crick strands of the reference sequence. This procedure is equivalent to mapping BS reads to four bisulfite strands (BSW, BSWR, BSC, and BSCR) (Figure <xref ref-type="fig" rid="F4">4</xref>).</p>
      <fig position="float" id="F4">
        <label>Figure 4</label>
        <caption>
          <p><bold>Mapping bisulfite reads to 4 possible bisulfite strands (BSW/BSWR/BSC/BSCR) is equivalent to mapping the bisulfite read and its reverse complementary read to both Watson/Crick strands of the original reference sequence</bold>.</p>
        </caption>
        <graphic xlink:href="1471-2105-10-232-4"/>
      </fig>
      <p>BSMAP supports gapped/pair-end alignment and iterative trimming of low-quality base pairs, as well as parallel computing in multi-thread execution. In addition to providing unique hits, BSMAP can also report non-unique multiple hits with a user-defined maximum number of mismatches. Such "multiple hits" information may lead to more accurate estimates of the methylation ratio. In addition, BSMAP also provides the option of using a simple seeding HASH table, where all Cs are converted into Ts in the keys, as an alternative to the bisulfite seeding HASH table in mapping. This simple seeding option is slower but is more memory efficient and thus would be suitable for computers with less RAM.</p>
    </sec>
    <sec>
      <title>Algorithm comparisons</title>
      <p>We compared BSMAP with CokusAlignment by mapping a real Solexa dataset containing 2,946,339 bisulfite reads (31 nt) to the <italic>Arabidopsis </italic>genome (119,707,899 nt) [<xref ref-type="bibr" rid="B4">4</xref>] (Table <xref ref-type="table" rid="T2">2</xref>). BSMAP is about 6× faster than CokusAlignment with a similar mapping sensitivity. Overall, the mapping results for BSMAP and CokusAlignment were similar. It is worth noting that in BSMAP, up to 2 mismatches were allowed and the read was kept only if the second best hit had &gt;= 1 more mismatches than the best hit; in CokusAlignment, the matching probability scores were calculated based on the original Solexa image file, and the score cutoff could not be explicitly associated with our BSMAP mapping criteria. Therefore, a strict comparison of the mapping sensitivities of BSMAP and CokusAlignment is not feasible.</p>
      <p>Using the same <italic>Arabidopsis </italic>read data, we also simulated the other two bisulfite mapping approaches discussed earlier [<xref ref-type="bibr" rid="B2">2</xref>,<xref ref-type="bibr" rid="B3">3</xref>] and compared them with BSMAP. To simulate the RRBS bisulfite mapping used by Meissner et al. [<xref ref-type="bibr" rid="B2">2</xref>], all Cs were converted to Ts in the reads and references, and converted reads were aligned to the converted reference using SOAP. As discussed earlier, it was not feasible to record all non-unique mappings for post-processing, so reads with more than 100 mappings were discarded. The false-positive bisulfite C/T alignments were counted as mismatches, and only the resulting unique mappings (if there were any) were retained. Meissner mapping was found to detect fewer unique bisulfite mappings (39.1%) than BSMAP (44.9%) (Table <xref ref-type="table" rid="T2">2</xref>). This is due to the fact that the false-positive bisulfite C/T alignments can introduce too many matches to some reads, which exceed the 100 mapping threshold and are therefore discarded. With a larger reference genome, more reads may be discarded because of the larger number of false-positive bisulfite C/T alignments, leading to even lower mapping sensitivity. The estimated speed of Meissner mapping is roughly half that of BSMAP. Because Meissner et al. used a custom-written mapping program, an exact comparison of speed is not applicable. We excluded the post-processing time in our estimation of speed, so the actual mapping speed would be slower than listed.</p>
      <table-wrap position="float" id="T2">
        <label>Table 2</label>
        <caption>
          <p>Comparison of BSMAP and other mapping algorithms</p>
        </caption>
        <table frame="hsides" rules="groups">
          <thead>
            <tr>
              <td/>
              <td align="left">Speed reads/sec/CPU core)</td>
              <td align="left">Uniquely Aligned Reads (%)</td>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left">BSMAP</td>
              <td align="left">146</td>
              <td align="left">44.9%</td>
            </tr>
            <tr>
              <td align="left">Cokus Alignment [<xref ref-type="bibr" rid="B4">4</xref>]</td>
              <td align="left">~25 [<xref ref-type="bibr" rid="B4">4</xref>]</td>
              <td align="left">45.1%</td>
            </tr>
            <tr>
              <td align="left">Meissner mapping [<xref ref-type="bibr" rid="B2">2</xref>]</td>
              <td align="left">83*</td>
              <td align="left">39.1%</td>
            </tr>
            <tr>
              <td align="left">Lister mapping [<xref ref-type="bibr" rid="B3">3</xref>]</td>
              <td align="left">125*</td>
              <td align="left">42.5%</td>
            </tr>
          </tbody>
        </table>
        <table-wrap-foot>
          <p>* estimated speed based on SOAP, excluding the post processing time.</p>
        </table-wrap-foot>
      </table-wrap>
      <p>In simulating the mapping of Lister et al. [<xref ref-type="bibr" rid="B3">3</xref>], three reference sequences were used: the original <italic>Arabidopsis </italic>genome sequence, the Watson strand with all Cs converted to Ts, and the Crick strand with all Gs converted to As. For each read, the mapping results of the three references were merged and duplicated mappings were combined. The actual mismatches were recalculated by excluding the bisulfite alignments, and unique mappings were counted. As expected, Lister mapping reported fewer uniquely mapped reads than BSMAP (Table <xref ref-type="table" rid="T2">2</xref>). It is worth noting that the sensitivity of Lister mapping highly depends on read length. Longer reads will contain more bisulfite C/T alignments and are therefore more likely to exceed the maximum mismatch threshold and become un-mappable. On the other hand, longer reads will have more true mismatches, such as SNPs, and thus will tolerate fewer bisulfite C/T alignments as mismatches. Therefore, with increased read length, we would expect a rapid drop in mapping sensitivity.</p>
      <p>In summary, existing bisulfite mapping approaches either sacrifice mapping sensitivity for time or are too computationally expensive to be applied to large reference sequences. BSMAP offers efficient yet accurate bisulfite mappings through a fast bitwise masking algorithm. A great degree of complexity in bisulfite read mapping is introduced by the fact that within a single read there might be multiple CpGs with heterogeneous methylation status. By algorithm design, BSMAP is able to map multiple-CpG bisulfite reads to the genome considering every possible methylation pattern. BSMAP is also able to detect C methylation other than at CpG content [<xref ref-type="bibr" rid="B4">4</xref>], although it is difficult to determine whether the non-CpG C methylations are generated through a novel methylation mechanism or through incomplete bisulfite conversion.</p>
      <p>Whole genome BS-seq is still too costly, especially for a comparative analysis of large mammalian genomes in multiple cell types and conditions. Recently, front-end array capture [<xref ref-type="bibr" rid="B8">8</xref>] coupled with bisulfite sequencing has become a popular cost-effective strategy to generate methylation profiling of a reduced representation of a large genome, e.g., promoters and CpG islands. Although the capture assay significantly enriches (usually by several hundred fold) the targeted sequences, only 50–90% (capture specificity) of the captured sequences are usually within the targeted regions. The remaining reads are from non-specific genome background. Therefore, we advise BS-seq users to still use the entire genome rather than reduced representation of the genome, as the searching space for bisulfite read mapping.</p>
    </sec>
  </sec>
  <sec>
    <title>Conclusion</title>
    <p>We present a novel, flexible, and efficient general-purpose bisulfite sequence mapping program, BSMAP, for the analysis of whole genome shotgun BS-seq data. BSMAP uses the positions of all Cs in the reference sequences and applies bitwise masking to implement asymmetric C/T transition: T in bisulfite reads can be mapped to either C or T in the reference but not vice versa. The efficient seeding and HASH table used in BSMAP offer both improved flexibility and performance. Additionally, BSMAP supports the detection of multiple CpG heterogeneous methylation patterns and C methylations that are not at a CpG site. Finally, BSMAP is easy to use and supports gapped/pair-end alignment, iterative trimming of low-quality base pairs, and multi-thread parallel computing.</p>
  </sec>
  <sec sec-type="methods">
    <title>Methods</title>
    <sec>
      <title>Dataset</title>
      <p>BS-seq data from the <italic>Arabidopsis </italic>genome were obtained from <ext-link ext-link-type="uri" xlink:href="http://epigenomics.mcdb.ucla.edu/BS-Seq/download.html"/>[<xref ref-type="bibr" rid="B4">4</xref>]</p>
    </sec>
    <sec>
      <title>Software implementation</title>
      <p>BSMAP was developed on Linux64 platform under GNU PL3 licenses, and the C++ source code is freely available at <ext-link ext-link-type="uri" xlink:href="http://code.google.com/p/bsmap/"/>.</p>
      <p>BSMAP takes standard FASTA/FASTQ format as input. The mapping output includes the following information: read ID, read sequence, quality score, read length, mapping flag (MA for matching, NM for not matching, OF for multiple matching overflow), mapping chromosome, position, strand, number of mappings with up to five mismatches, and detailed mismatch positions and nucleotide information in the read.</p>
    </sec>
  </sec>
  <sec>
    <title>Authors' contributions</title>
    <p>YX and WL conceived the project and wrote the paper. YX developed the bisulfite seeding and bit masking algorithm, and coded the BSMAP software based on SOAP. YX and WL tested the BSMAP software. All authors read and approved the final manuscript.</p>
  </sec>
</body>
<back>
  <ack>
    <sec>
      <title>Acknowledgements</title>
      <p>BSMAP is based on the open source software SOAP <ext-link ext-link-type="uri" xlink:href="http://soap.genomics.org.cn/"/>. We thank Dr. Ruiqiang Li and coworkers for the source code and documentation of SOAP. This work was partially supported by the NIH Cancer Center grant (P30 CA125123), the NIH Roadmap Epigenomics Data Analysis and Coordination Center at Baylor College of Medicine (1U01DA025956-01) and the 973 project 2010CB944900 of the ministry of science and technology of China. We thank Drs. Jean-Pierre Issa, Robert Waterland, Aleksandar Milosavljevic, Cristian Coarfa, Rui Chen, Steffi Oesterreich and Gary Chamness for helpful discussions and critical reading of this manuscript.</p>
    </sec>
  </ack>
  <ref-list>
    <ref id="B1">
      <citation citation-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Frommer</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>McDonald</surname>
            <given-names>LE</given-names>
          </name>
          <name>
            <surname>Millar</surname>
            <given-names>DS</given-names>
          </name>
          <name>
            <surname>Collis</surname>
            <given-names>CM</given-names>
          </name>
          <name>
            <surname>Watt</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Grigg</surname>
            <given-names>GW</given-names>
          </name>
          <name>
            <surname>Molloy</surname>
            <given-names>PL</given-names>
          </name>
          <name>
            <surname>Paul</surname>
            <given-names>CL</given-names>
          </name>
        </person-group>
        <article-title>A genomic sequencing protocol that yields a positive display of 5-methylcytosine residues in individual DNA strands</article-title>
        <source>Proc Natl Acad Sci USA</source>
        <year>1992</year>
        <volume>89</volume>
        <fpage>1827</fpage>
        <pub-id pub-id-type="pmid">1542678</pub-id>
        <pub-id pub-id-type="doi">10.1073/pnas.89.5.1827</pub-id>
      </citation>
    </ref>
    <ref id="B2">
      <citation citation-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Meissner</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Mikkelsen</surname>
            <given-names>TS</given-names>
          </name>
          <name>
            <surname>Gu</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Wernig</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Hanna</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Sivachenko</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Bernstein</surname>
            <given-names>BE</given-names>
          </name>
          <name>
            <surname>Nusbaum</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Jaffe</surname>
            <given-names>DB</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Genome-scale DNA methylation maps of pluripotent and differentiated cells</article-title>
        <source>Nature</source>
        <year>2008</year>
        <volume>454</volume>
        <fpage>766</fpage>
        <pub-id pub-id-type="pmid">18600261</pub-id>
      </citation>
    </ref>
    <ref id="B3">
      <citation citation-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lister</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>O'Malley</surname>
            <given-names>RC</given-names>
          </name>
          <name>
            <surname>Tonti-Filippini</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Gregory</surname>
            <given-names>BD</given-names>
          </name>
          <name>
            <surname>Berry</surname>
            <given-names>CC</given-names>
          </name>
          <name>
            <surname>Millar</surname>
            <given-names>AH</given-names>
          </name>
          <name>
            <surname>Ecker</surname>
            <given-names>JR</given-names>
          </name>
        </person-group>
        <article-title>Highly Integrated Single-Base Resolution Maps of the Epigenome in Arabidopsis</article-title>
        <source>Cell</source>
        <year>2008</year>
        <volume>133</volume>
        <fpage>523</fpage>
        <lpage>36</lpage>
        <pub-id pub-id-type="pmid">18423832</pub-id>
        <pub-id pub-id-type="doi">10.1016/j.cell.2008.03.029</pub-id>
      </citation>
    </ref>
    <ref id="B4">
      <citation citation-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cokus</surname>
            <given-names>SJ</given-names>
          </name>
          <name>
            <surname>Feng</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Merriman</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Haudenschild</surname>
            <given-names>CD</given-names>
          </name>
          <name>
            <surname>Pradhan</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Nelson</surname>
            <given-names>SF</given-names>
          </name>
          <name>
            <surname>Pellegrini</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Jacobsen</surname>
            <given-names>SE</given-names>
          </name>
        </person-group>
        <article-title>Shotgun bisulphite sequencing of the Arabidopsis genome reveals DNA methylation patterning</article-title>
        <source>Nature</source>
        <year>2008</year>
        <volume>452</volume>
        <fpage>215</fpage>
        <pub-id pub-id-type="pmid">18278030</pub-id>
        <pub-id pub-id-type="doi">10.1038/nature06745</pub-id>
      </citation>
    </ref>
    <ref id="B5">
      <citation citation-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Kristiansen</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>SOAP: short oligonucleotide alignment program</article-title>
        <source>Bioinformatics</source>
        <year>2008</year>
        <volume>24</volume>
        <fpage>713</fpage>
        <pub-id pub-id-type="pmid">18227114</pub-id>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btn025</pub-id>
      </citation>
    </ref>
    <ref id="B6">
      <citation citation-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Ruan</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Durbin</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Mapping short DNA sequencing reads and calling variants using mapping quality scores</article-title>
        <source>Genome Res</source>
        <year>2008</year>
        <volume>18</volume>
        <fpage>1851</fpage>
        <pub-id pub-id-type="pmid">18714091</pub-id>
        <pub-id pub-id-type="doi">10.1101/gr.078212.108</pub-id>
      </citation>
    </ref>
    <ref id="B7">
      <citation citation-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Smith</surname>
            <given-names>AD</given-names>
          </name>
          <name>
            <surname>Xuan</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>MQ</given-names>
          </name>
        </person-group>
        <article-title>Using quality scores and longer reads improves accuracy of Solexa read mapping</article-title>
        <source>BMC Bioinformatics</source>
        <year>2008</year>
        <volume>9</volume>
        <fpage>128</fpage>
        <pub-id pub-id-type="pmid">18307793</pub-id>
        <pub-id pub-id-type="doi">10.1186/1471-2105-9-128</pub-id>
      </citation>
    </ref>
    <ref id="B8">
      <citation citation-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hodges</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Xuan</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Balija</surname>
            <given-names>V</given-names>
          </name>
          <name>
            <surname>Kramer</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Molla</surname>
            <given-names>MN</given-names>
          </name>
          <name>
            <surname>Smith</surname>
            <given-names>SW</given-names>
          </name>
          <name>
            <surname>Middle</surname>
            <given-names>CM</given-names>
          </name>
          <name>
            <surname>Rodesch</surname>
            <given-names>MJ</given-names>
          </name>
          <name>
            <surname>Albert</surname>
            <given-names>TJ</given-names>
          </name>
          <name>
            <surname>Hannon</surname>
            <given-names>GJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Genome-wide in situ exon capture for selective resequencing</article-title>
        <source>Nat Genet</source>
        <year>2007</year>
        <volume>39</volume>
        <fpage>1522</fpage>
        <pub-id pub-id-type="pmid">17982454</pub-id>
        <pub-id pub-id-type="doi">10.1038/ng.2007.42</pub-id>
      </citation>
    </ref>
  </ref-list>
</back>
