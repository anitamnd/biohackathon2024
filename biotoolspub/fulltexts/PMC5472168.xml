<?DTDIdentifier.IdentifierValue -//NPG//DTD XML Article//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName NPG_XML_Article.dtd?>
<?SourceDTD.Version 2.7.10?>
<?ConverterInfo.XSLTName nature2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Commun</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Commun</journal-id>
    <journal-title-group>
      <journal-title>Nature Communications</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2041-1723</issn>
    <publisher>
      <publisher-name>Nature Publishing Group</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">5472168</article-id>
    <article-id pub-id-type="pii">ncomms14836</article-id>
    <article-id pub-id-type="doi">10.1038/ncomms14836</article-id>
    <article-id pub-id-type="pmid">28594001</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>A BaSiC tool for background and shading correction of optical microscopy images</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Peng</surname>
          <given-names>Tingying</given-names>
        </name>
        <xref ref-type="aff" rid="a1">1</xref>
        <xref ref-type="aff" rid="a2">2</xref>
        <xref ref-type="aff" rid="a3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Thorn</surname>
          <given-names>Kurt</given-names>
        </name>
        <xref ref-type="aff" rid="a4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Schroeder</surname>
          <given-names>Timm</given-names>
        </name>
        <xref ref-type="aff" rid="a5">5</xref>
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-9271-8815</contrib-id>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Wang</surname>
          <given-names>Lichao</given-names>
        </name>
        <xref ref-type="aff" rid="a1">1</xref>
        <xref ref-type="aff" rid="a2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Theis</surname>
          <given-names>Fabian J.</given-names>
        </name>
        <xref ref-type="aff" rid="a2">2</xref>
        <xref ref-type="aff" rid="a3">3</xref>
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-2419-1943</contrib-id>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Marr</surname>
          <given-names>Carsten</given-names>
        </name>
        <xref ref-type="corresp" rid="c1">a</xref>
        <xref ref-type="aff" rid="a2">2</xref>
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-2154-4552</contrib-id>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Navab</surname>
          <given-names>Nassir</given-names>
        </name>
        <xref ref-type="corresp" rid="c2">b</xref>
        <xref ref-type="aff" rid="a1">1</xref>
        <xref ref-type="aff" rid="a6">6</xref>
      </contrib>
      <aff id="a1"><label>1</label><institution>Department of Computer Science, Chair of Computer Aided Medical Procedure, Technische Universität München</institution>, Boltzmannstr. 3, Garching 85748, <country>Germany</country></aff>
      <aff id="a2"><label>2</label><institution>Institute of Computational Biology, Helmholtz Zentrum München—German Research Center for Environmental Health, Institute of Computational Biology</institution>, Ingolstädter Landstraße 1, Neuherberg 85764, <country>Germany</country></aff>
      <aff id="a3"><label>3</label><institution>Center for Mathematics, Chair of Mathematical Modeling of Biological Systems, Technische Universität München</institution>, Boltzmannstr. 3, Garching 85748, <country>Germany</country></aff>
      <aff id="a4"><label>4</label><institution>Department of Biochemistry and Biophysics</institution>, University of California, San Francisco, 600 16th Street, San Francisco, California 94158, <country>USA</country></aff>
      <aff id="a5"><label>5</label><institution>Department of Biosystems Science and Engineering (D-BSSE), ETH Zurich</institution>, Basel 4058, <country>Switzerland</country></aff>
      <aff id="a6"><label>6</label><institution>Department of Computer Science, Chair of Computer Aided Medical Procedure, Johns Hopkins University</institution>, 3400 North Charles Street, Baltimore, Maryland 21218, <country>USA</country></aff>
    </contrib-group>
    <author-notes>
      <corresp id="c1">
        <label>a</label>
        <email>carsten.marr@helmholtz-muenchen.de</email>
      </corresp>
      <corresp id="c2">
        <label>b</label>
        <email>nassir.navab@tum.de</email>
      </corresp>
    </author-notes>
    <pub-date pub-type="epub">
      <day>08</day>
      <month>06</month>
      <year>2017</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2017</year>
    </pub-date>
    <volume>8</volume>
    <elocation-id>14836</elocation-id>
    <history>
      <date date-type="received">
        <day>10</day>
        <month>06</month>
        <year>2016</year>
      </date>
      <date date-type="accepted">
        <day>03</day>
        <month>02</month>
        <year>2017</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>Copyright © 2017, The Author(s)</copyright-statement>
      <copyright-year>2017</copyright-year>
      <copyright-holder>The Author(s)</copyright-holder>
      <license xmlns:xlink="http://www.w3.org/1999/xlink" license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/4.0/">
        <!--author-paid-->
        <license-p>This work is licensed under a Creative Commons Attribution 4.0 International License. The images or other third party material in this article are included in the article's Creative Commons license, unless indicated otherwise in the credit line; if the material is not included under the Creative Commons license, users will need to obtain permission from the license holder to reproduce the material. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link></license-p>
      </license>
    </permissions>
    <abstract>
      <p>Quantitative analysis of bioimaging data is often skewed by both shading in space and background variation in time. We introduce BaSiC, an image correction method based on low-rank and sparse decomposition which solves both issues. In comparison to existing shading correction tools, BaSiC achieves high-accuracy with significantly fewer input images, works for diverse imaging conditions and is robust against artefacts. Moreover, it can correct temporal drift in time-lapse microscopy data and thus improve continuous single-cell quantification. BaSiC requires no manual parameter setting and is available as a Fiji/ImageJ plugin.</p>
    </abstract>
    <abstract abstract-type="web-summary">
      <p>Accurate quantification of bioimaging data is often confounded by uneven illumination (shading) in space and background variation in time. Here the authors present BaSiC, a Fiji plugin solving both issues. It requires fewer input images and is more robust to artefacts than existing shading correction tools.</p>
    </abstract>
  </article-meta>
</front>
<body>
  <p>Optical imaging is an indispensable tool in biomedical research. All modern optical imaging (whether whole slide imaging, high-content screening or high-throughput time-lapse microscopy) relies on image processing and quantification methods to analyse and interpret the acquired data. However, optical microscopy data, and especially fluorescence imaging, is often severely affected by shading or vignetting<xref ref-type="bibr" rid="b1">1</xref>, typically reflected as an attenuation of the brightness intensity from the centre of the optical axis to the edges. This not only degrades the visual quality of an image (for example, by causing discontinuities in whole slide images (WSIs)), but more critically compromises the downstream analysis of, for example, tissue composition or single-cell properties. Besides spatial shading effects, time-lapse movies often exhibit a temporal baseline drift due to background bleaching, which further skews the quantification of the dynamic behaviour of cellular and molecular properties<xref ref-type="bibr" rid="b2">2</xref>.</p>
  <p>The physical process of image formation can be approximated as a linear function<xref ref-type="bibr" rid="b3">3</xref> that relates a measured image, <italic>I</italic><sup><italic>meas</italic></sup>(<italic>x</italic>) at location <italic>x</italic>, to its uncorrupted true correspondence, <italic>I</italic><sup><italic>true</italic></sup>(<italic>x</italic>), as</p>
  <p>
    <disp-formula id="eq1">
      <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e277" xlink:href="ncomms14836-m1.jpg"/>
    </disp-formula>
  </p>
  <p>where the multiplicative term <italic>S</italic>(<italic>x</italic>) represents the change in effective illumination across an image (known as flat-field); the additive term <italic>D</italic>(<italic>x</italic>), known as dark-field, is dominated by camera offset and thermal noise, which are present even if no light is incident on the sensor.</p>
  <p>Existing shading correction methods can be generally divided into two groups: ‘prospective' approaches that determine <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>) from extra reference images<xref ref-type="bibr" rid="b4">4</xref> (<xref ref-type="supplementary-material" rid="S1">Supplementary Note 1</xref>) and ‘retrospective' approaches, which rely on the actual image data itself and hence avoid collection of extra reference images (<xref ref-type="supplementary-material" rid="S1">Supplementary Note 2</xref>). A number of multi-image based approaches have been recently published, for example, Smith <italic>et al</italic>.<xref ref-type="bibr" rid="b5">5</xref> (Fiji Plugin ‘CIDRE'), Coster <italic>et al</italic>.<xref ref-type="bibr" rid="b6">6</xref> and Singh <italic>et al</italic>.<xref ref-type="bibr" rid="b7">7</xref> (the default module in CellProfiler). These approaches take advantage of shared <italic>S</italic>(<italic>x</italic>) among an image sequence and are usually more reliable than single-image based corrections. Yet they require large numbers of images to reach a stable performance and a manual fine-tuning of internal parameters, and their robustness to common bioimage artefacts (such as dust and fluorescence dye particles) has not been tested. Moreover, none of the existing methods is able to model and correct temporal drift (e.g. caused by photobleaching) for time-lapse movies.</p>
  <p>We propose BaSiC, a retrospective method for background and <bold>s</bold>hading correction of image sequences, based on a sparse and low-rank decomposition. In comparison to existing shading correction tools, BaSiC requires fewer input images, works for diverse imaging conditions and is robust against typical image artefacts. Moreover, it can correct temporal drift for time-lapse microscopy data, and hence improve single-cell quantification. BaSiC is available as an easy-to-use Fiji/ImageJ plugin as usually requires no manual parameter tuning.</p>
  <sec disp-level="1">
    <title>Results</title>
    <sec disp-level="2">
      <title>BaSiC workflow</title>
      <p>Inspired by Smith <italic>et al</italic>.<xref ref-type="bibr" rid="b5">5</xref>, we build our method on the shading model (<xref ref-type="disp-formula" rid="eq1">equation (1)</xref>), which accounts for the effect of both <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>). Such a full model is superior as compared to a partial model that considers <italic>S</italic>(<italic>x</italic>) only<xref ref-type="bibr" rid="b5">5</xref>. As shown in the schematic plot of <xref ref-type="fig" rid="f1">Fig. 1</xref>, BaSiC first constructs a measurement matrix <bold>I</bold> (step I), which is then decomposed into a low-rank matrix <bold>I</bold><sup><bold>B</bold></sup> and a sparse residual matrix <bold>I</bold><sup><bold>R</bold></sup> (step II). The low-rank matrix has a maximum rank of two as each column is the sum of a scaled version of <italic>S</italic>(<italic>x</italic>) (with a scaling factor <italic>B</italic><sub><italic>i</italic></sub>) and <italic>D</italic>(<italic>x</italic>), which are all initialized with zeros (step III) and optimized by promoting the sparsity of the residual matrix with a reweighted L1-norm (step IV). In addition, smooth constraints are imposed on both <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>) by regulating their sparsity in Fourier domain (<xref ref-type="supplementary-material" rid="S1">Supplementary Fig. 1</xref>). The optimization is solved in an iterative fashion using the linearized augmented Lagrangian method<xref ref-type="bibr" rid="b8">8</xref>, which is widely used in sparse matrix decomposition like Robust PCA (ref. <xref ref-type="bibr" rid="b9">9</xref>) and RASL (ref. <xref ref-type="bibr" rid="b10">10</xref>) (for a detailed description of the mathematical derivation and matrix updating see Methods and <xref ref-type="supplementary-material" rid="S1">Supplementary Note 3</xref>). An automatic parameter setting strategy determines the smooth regularization parameters for <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>), adaptive to different image contents, so that tedious manual parameter tuning is avoided (<xref ref-type="supplementary-material" rid="S1">Supplementary Note 4</xref>). We provide a statistical interpretation of BaSiC in <xref ref-type="supplementary-material" rid="S1">Supplementary Note 5</xref>. With the estimation of <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>), we can correct the intensity profile of each image tile of a WSI by reversing the image formation process, <xref ref-type="disp-formula" rid="eq1">equation (1)</xref>, leading to a homogenous appearance and correct stitching (<xref ref-type="fig" rid="f1">Fig. 1d versus a</xref>).</p>
    </sec>
    <sec disp-level="2">
      <title>BaSiC requires few images for shading correction</title>
      <p>We first evaluate BaSiC using synthetic images, where the ground-truth of the shading-free image <italic>I</italic><sup>true</sup>, the flat-field <italic>S</italic>(<italic>x</italic>) and the dark-field <italic>D</italic>(<italic>x</italic>) are known (<xref ref-type="supplementary-material" rid="S1">Supplementary Note 6</xref>). We first compare BaSiC with CIDRE (ref. <xref ref-type="bibr" rid="b5">5</xref>), the only other method that is able to simultaneously estimate <italic>S</italic> and <italic>D</italic>. BaSiC requires far fewer images to achieve the same accuracy as CIDRE (for example, 10 versus 100 images to reach an estimation score <italic>Γ</italic>(<italic>S</italic><sup>est</sup>)≤0.1 at three levels of cell density (cell density, <xref ref-type="supplementary-material" rid="S1">Supplementary Fig. 2</xref>). We subsequently evaluate BaSiC using a comprehensive microscope image collection provided by Smith <italic>et al</italic>.<xref ref-type="bibr" rid="b5">5</xref>, which includes 10 real microscopy data sets, one photography data set and one synthetic microscopy data set (refer to Smith <italic>et al</italic>.<xref ref-type="bibr" rid="b5">5</xref> for data set details). We assess the correction quality by the correction score, <italic>Γ</italic>′(<italic>I</italic><sup>corr</sup>), which is the mean absolute difference of pixel pairs in overlapping image regions for each data set after correction, normalized by the difference of the uncorrected pairs<xref ref-type="bibr" rid="b5">5</xref>. A <italic>Γ</italic>′(<italic>I</italic><sup>corr</sup>)&lt;1 suggests reduced shading while <italic>Γ</italic>′(<italic>I</italic><sup>corr</sup>)&gt;1 implies increased shading compared to the uncorrected images. Besides CIDRE, we compare BaSiC also with the methods used in Coster<xref ref-type="bibr" rid="b6">6</xref> and Cellprofiler<xref ref-type="bibr" rid="b7">7</xref> (refer to Methods for technical details), as well as two prospective methods (Calib-zero and Empty-zero)<xref ref-type="bibr" rid="b5">5</xref>. We find that BaSiC improves image quality with as few as five images (<xref ref-type="fig" rid="f2">Fig. 2a</xref>). At around 100 images it matches prospective methods on average, although the performance varies for different data sets (<xref ref-type="supplementary-material" rid="S1">Supplementary Fig. 3</xref>). Among retrospective methods, BaSiC significantly outperforms existing approaches, when fewer than 500 images are used (<xref ref-type="fig" rid="f2">Fig. 2a</xref>). This is practically relevant since WSI acquisition typically contains 50–200 tiles and high-content screening usually works with 96 and 384 well plates, where only images at the same position of each well share a shading profile<xref ref-type="bibr" rid="b6">6</xref>—hence the number of images available for one estimation is 96 or 384.</p>
    </sec>
    <sec disp-level="2">
      <title>BaSiC is robust to typical image artefacts</title>
      <p>Furthermore, we evaluate the robustness of the four considered retrospective methods with respect to typical image artefacts. One type of common artefacts in fluorescence images is bright particles that strongly fluoresce or scatter light (<xref ref-type="fig" rid="f2">Fig. 2b</xref>). BaSiC is robust to these artefacts as it incorporates them in the sparse residual without affecting the low-rank estimation of <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>) (<xref ref-type="fig" rid="f2">Fig. 2c</xref>). By contrast, the estimated flat-fields <italic>S</italic><sup>est</sup>(<italic>x</italic>) from CIDRE and Cellprofiler are sensitive to outliers. While existing methods suffer from artefacts and inhomogeneities at the image edges, BaSiC correction leads to a homogenous distribution of mean cell intensities in a cell culture WSI over the whole slide (<xref ref-type="fig" rid="f2">Fig. 2d</xref>). Other typical artefacts are stray light and residual excitation light due to imperfect filtering, which are difficult to measure experimentally and hence difficult to correct with prospective methods (<xref ref-type="supplementary-material" rid="S1">Supplementary Fig. 4a</xref>). BaSiC incorporates such artefacts in the estimation of <italic>D</italic>(<italic>x</italic>) and can successfully correct their effect (<xref ref-type="supplementary-material" rid="S1">Supplementary Fig. 4b</xref>). A quantitative evaluation of 45 WSIs using the estimation score suggests that BaSiC achieves an accurate estimation of shading in all instances, outperforming existing retrospective methods (<xref ref-type="fig" rid="f2">Fig. 2e</xref>, <xref ref-type="supplementary-material" rid="S1">Supplementary Figs 5–8</xref>).</p>
    </sec>
    <sec disp-level="2">
      <title>BaSiC corrects background variation in time-lapse movies</title>
      <p>Finally, we apply BaSiC to improve single-cell quantification of long-term time-lapse microscopy. We decompose the shading-free true image <inline-formula id="d32e645"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e646" xlink:href="ncomms14836-m2.jpg"/></inline-formula>(<italic>x</italic>) of the <italic>i</italic>th frame of a time-lapse microscopy movie into the sum of a spatially-constant baseline signal, <italic>B</italic><sub><italic>i</italic></sub>, and the spatially varying foreground (fluorescence) signal of biological relevance<xref ref-type="bibr" rid="b6">6</xref>. Hence the full model for a time-lapse movie becomes:</p>
      <p>
        <disp-formula id="eq3">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e664" xlink:href="ncomms14836-m3.jpg"/>
        </disp-formula>
      </p>
      <p>Because of background bleaching and varying experimental conditions, <italic>B</italic><sub><italic>i</italic></sub> is usually not constant between frames (<xref ref-type="fig" rid="f1">Fig. 1b</xref>). We correct the intensity profile of each frame using the estimated <italic>S</italic>(<italic>x</italic>), <italic>D</italic>(<italic>x</italic>) and <italic>B</italic><sub><italic>i</italic></sub> by reversing <xref ref-type="disp-formula" rid="eq3">equation (2)</xref>, which removes both spatial shading effects and the temporal drift (<xref ref-type="fig" rid="f1">Fig. 1e versus b</xref>).</p>
      <p>Continuous monitoring of single-cell differentiation dynamics is an important research tool for stem cell research<xref ref-type="bibr" rid="b11">11</xref>. Besides improving image contrast at the plate edge, BaSiC is able to remove intensity spikes for bright-field images and photo bleaching of the background medium in the fluorescence channel (<xref ref-type="supplementary-material" rid="S1">Supplementary Fig. 9</xref>, <xref ref-type="supplementary-material" rid="S1">Supplementary Movies 1 and 2</xref>). We apply BaSiC on 6 day time-lapse movies of hematopoietic stem and progenitor cells that differentiate towards the granulocyte-macrophage (GM) lineage and the megakaryocyte-erythrocyte (MegE) lineage (<xref ref-type="fig" rid="f3">Fig. 3a</xref>, see Hoppe <italic>et al</italic>.<xref ref-type="bibr" rid="b12">12</xref> for experimental details). The dynamic expression of the transcription factor PU.1 has been quantified in cells over many generations. The BaSiC-corrected intensity profile illustrates a 2–5-fold increase of PU.1 intensity for GM cells at the onset of the lineage marker CD16/32 (<xref ref-type="fig" rid="f3">Fig. 3b</xref>). In contrast, PU.1 levels stay roughly constant in MegE cells, when the onset of the lineage marker Gata1 is observed (<xref ref-type="fig" rid="f3">Fig. 3c</xref>). Importantly, the uncorrected intensity profiles exhibit no obvious change in PU.1 behaviour for the two lineages. When comparing GM versus MegE branches a significant (<italic>P</italic>=1.2 × 10<sup>−3</sup>, Wilcoxon rank-sum test, <xref ref-type="fig" rid="f3">Fig. 3d</xref>) fold-change in PU.1 expression is only observable after BaSiC correction.</p>
    </sec>
  </sec>
  <sec disp-level="1">
    <title>Discussion</title>
    <p>BaSiC is an efficient tool for image correction and can be applied to high-content images, WSIs and high-throughput time-lapse movies. BaSiC has immediate attraction to researchers who create stitched images, since correcting uneven illumination improves stitching and mosaic image quality. Besides, BaSiC can be also used as a pre-processing step in conjunction with automatic methods such as cell counting or measuring the morphology of cells and thus improving down-stream analysis. The crucial contribution of BaSiC is to improve intensity quantification in both static and time-lapse imaging data. Unlike local contrast equalization methods, which could distort the true intensity variations within an original image or across multiple images, BaSiC is built on solid physical models of optical imaging and hence is able to recover biologically relevant intensities for image quantification. Besides of being accurate, BaSiC is also fast to compute: in our Fiji implementation, it usually processes hundreds of images within minutes on a standard laptop.</p>
    <p>From a methodological point of view, there are two key differences between BaSiC and the state-of-the-art shading correction tools that also model flat-field <italic>S</italic>(<italic>x</italic>) and dark-field <italic>D</italic>(<italic>x</italic>). The first distinctive feature of BaSiC is the reweighted L1-norm error measure, which allows for a quicker convergence when dealing with limited amount of images and, more importantly, results in increased resistance to outliers in data such as noise or debris. Besides <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>), BaSiC can also estimate a per-image baseline <italic>B</italic><sub><italic>i</italic></sub>, which accounts for varying background in time-lapse movies. This correction of background bleaching is a unique feature of BaSiC that CIDRE and other existing methods cannot provide.</p>
    <p>As any shading correction method, BaSiC has limitations. One key assumption of BaSiC and all other previously mentioned multi-image based retrospective methods is that the foreground of every image to be processed should be uncorrelated with the foreground of every other image. This assumption can be violated for time-lapse movies of static and quasi-static objects, for example, for a single-cell of high-magnification that is always in the centre of the field of view. In such cases, BaSiC would consider the consistently higher image intensities in the centre of the field of view as a local increase in <italic>S</italic>(<italic>x</italic>), causing removal of the true fluorescence variability. Nevertheless in practice, BaSiC has some tolerance to such correlations, for example, it performs well in a movie of proliferating and slowly moving embryonic stem cell colonies (as shown in <xref ref-type="supplementary-material" rid="S1">Supplementary Movie 2</xref>), in which consecutive frames are correlated. Meanwhile, the regularization parameter <italic>λ</italic><sub><italic>s</italic></sub> (see Methods) can be used to tune the resulting model so that it is more suitable for correlated images. Larger values of <italic>λ</italic><sub><italic>s</italic></sub> lead to a smoother estimation of the low-rank component, thus rejecting small static objects in the estimated <italic>S</italic>(<italic>x</italic>). Another useful strategy is to take samples with a large time gap in between to make images less correlated. In any case, we advise users to visually inspect the estimated shading profiles before making a correction in such challenging cases: a smooth <italic>S</italic>(<italic>x</italic>) usually indicates a good shading correction, while local inhomogeneities that come from highly corrected foreground objects are a hint of non-optimal correction.</p>
    <p>Although BaSiC can compensate background variation, no matter if it is caused by bleaching or by switching microscopy settings, it does not account for variation in the foreground sample fluorescence that may also occur due to photobleaching. In the presented long-term single-cell time-lapse measurements, the dominant corrupting factor is the background variation caused by medium bleaching. Hence subtraction of background bleaching greatly improves the intensity quantification of single cells (as shown in <xref ref-type="fig" rid="f3">Fig. 3</xref>). In fact, existing photobleaching correction methods (such as the Bleaching Correction Plugin in Fiji/ImageJ) are not suitable for correcting foreground cell bleaching in our movies: these methods either assume constant intensity or stable intensity distribution of each frame, which is certainly not the case for transcription factor expression during cell differentiation, where the signal varies depending on the cell type and time. It should also be noted that for fluorescence images, the estimated baseline can converge to the foreground, when the foreground fraction of an image is &gt;50%. This does not affect the practical usage of BaSiC, when a high-cell density is reached only at the end of a movie. Typically then, the bleaching effect is already weak (bleaching usually decays exponentially), and hence the correction for those frames can be skipped. By contrast, for bright-field images, BaSiC is robust to different levels of cell density in background correction.</p>
    <p>With the limitations addressed above in mind, we believe that BaSiC will help to standardize the processing and quantification of bioimage data due to its broad applicability, robust performance, elegant mathematical formulation and easy-to-use interface.</p>
  </sec>
  <sec disp-level="1">
    <title>Methods</title>
    <sec disp-level="2">
      <title>Shading model and optimization</title>
      <p>A measured image sequence, <italic>I</italic><sup>meas</sup>=<inline-formula id="d32e829"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e830" xlink:href="ncomms14836-m4.jpg"/></inline-formula>(<italic>x</italic>), ..., <inline-formula id="d32e835"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e836" xlink:href="ncomms14836-m5.jpg"/></inline-formula>(<italic>x</italic>), can be related to its uncorrupted true correspondence, <italic>I</italic><sup>true</sup>=<italic>I</italic><sub>1</sub><sup>true</sup>(<italic>x</italic>),...,<italic>I</italic><sub><italic>n</italic></sub><sup>true</sup>(<italic>x</italic>), with a multiplicative flat-field <italic>S</italic>(<italic>x</italic>) and an additive dark-field <italic>D</italic>(<italic>x</italic>):</p>
      <p>
        <disp-formula id="eq6">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e883" xlink:href="ncomms14836-m6.jpg"/>
        </disp-formula>
      </p>
      <p>The BaSiC correction begins by sorting the image sequence <italic>I</italic><sup>meas</sup> into <italic>I</italic><sup>sort</sup> by intensities at each pixel <italic>x</italic>, converting each sorted image <inline-formula id="d32e899"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e900" xlink:href="ncomms14836-m7.jpg"/></inline-formula>(<italic>x</italic>) into a column vector <inline-formula id="d32e906"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e907" xlink:href="ncomms14836-m8.jpg"/></inline-formula> (from now on, we denote the same parameter in image space with (<italic>x</italic>) and as vector without (<italic>x</italic>)). Hence, we construct the measurement matrix as</p>
      <p>
        <disp-formula id="eq9">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e917" xlink:href="ncomms14836-m9.jpg"/>
        </disp-formula>
      </p>
      <p>Each column vector of the measurement matrix <bold>I</bold> is decomposed into</p>
      <p>
        <disp-formula id="eq10">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e925" xlink:href="ncomms14836-m10.jpg"/>
        </disp-formula>
      </p>
      <p>where <italic>B</italic><sub><italic>i</italic></sub> is a location independent scalar and <bold>R</bold><sub><bold>i</bold></sub> is the residual. The sum of the first two terms forms a <italic>rank 2</italic> matrix, <inline-formula id="d32e943"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e944" xlink:href="ncomms14836-m11.jpg"/></inline-formula> (<inline-formula id="d32e947"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e948" xlink:href="ncomms14836-m12.jpg"/></inline-formula> and ⊕ denote column-wise multiplication and addition, respectively), as all columns share the same <bold>S</bold> and <bold>D</bold>. The residual matrix, <bold>I</bold><sup><bold>R</bold></sup>, is assumed to be <italic>sparse</italic>, that is, the residual <inline-formula id="d32e966"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e967" xlink:href="ncomms14836-m13.jpg"/></inline-formula>(<italic>x</italic>) generally occupies only a small fraction of image pixels. Assuming sparsity of <bold>I</bold><sup><bold>R</bold></sup>, we have the following constraint optimization problem:</p>
      <p>
        <disp-formula id="eq14">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e980" xlink:href="ncomms14836-m14.jpg"/>
        </disp-formula>
      </p>
      <p>where | |<sub>0</sub> denotes the L0-norm, that is, the number of non-zero elements in <bold>I</bold><sup><bold>R</bold></sup>.</p>
      <p>A direct optimization of <xref ref-type="disp-formula" rid="eq14">equation (5)</xref> is impossible since it has no unique mathematical solution (suppose <bold>D</bold>* is one solution, then <inline-formula id="d32e1000"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1001" xlink:href="ncomms14836-m15.jpg"/></inline-formula> is another solution). Besides, the minimization of an L0-norm is NP-hard<xref ref-type="bibr" rid="b13">13</xref>. Hence, we adapt the objective function by imposing regularization on <bold>S</bold> and <bold>D</bold>, and replace the L0-norm by a reweighted L1-norm minimization:</p>
      <p>
        <disp-formula id="eq16">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1015" xlink:href="ncomms14836-m16.jpg"/>
        </disp-formula>
      </p>
      <p>where the dark-field <bold>D</bold> is decomposed into the sum of its mean <italic>D</italic><sup><italic>Z</italic></sup> and the residual <bold>D</bold><sup><bold>R</bold></sup>. <bold>W</bold> is the weighting matrix which balances the penalty of large coefficients and small coefficients and hence better approximates the L0-norm<xref ref-type="bibr" rid="b14">14</xref>. The detailed setting of <bold>W</bold>, the mathematical derivation of <xref ref-type="disp-formula" rid="eq10">equations (4</xref>, <xref ref-type="disp-formula" rid="eq14">5</xref>, <xref ref-type="disp-formula" rid="eq16">6)</xref> and the numerical solution of <xref ref-type="disp-formula" rid="eq16">equation (6)</xref> are included in <xref ref-type="supplementary-material" rid="S1">Supplementary Note 3</xref>. We have developed a strategy to automatically determine the regularization parameters, <italic>λ</italic><sub><italic>s</italic></sub> and <italic>λ</italic><sub><italic>d</italic></sub>, adaptive to different image content, so that tedious manual parameter tuning is avoided (<xref ref-type="supplementary-material" rid="S1">Supplementary Note 4</xref>). We also provide a statistical interpretation of BaSiC in <xref ref-type="supplementary-material" rid="S1">Supplementary Note 5</xref>. With the estimated <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>), we can invert the image formation process and obtain corrected image:</p>
      <p>
        <disp-formula id="eq17">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1091" xlink:href="ncomms14836-m17.jpg"/>
        </disp-formula>
      </p>
      <p>After sorting intensities, the estimated <italic>B</italic><sub><italic>i</italic></sub> alongside <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>) is no longer the baseline of the original images. Hence, we introduce a two-step strategy to estimate <italic>B</italic><sub><italic>i</italic></sub>: the first step is to compute <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>) only, using the matrix with sorted intensities; in the second step, we estimate <italic>B</italic><sub><italic>i</italic></sub> using the unsorted matrix, <bold>I</bold>=[<inline-formula id="d32e1141"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1142" xlink:href="ncomms14836-m18.jpg"/></inline-formula>, ..., <inline-formula id="d32e1144"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1145" xlink:href="ncomms14836-m19.jpg"/></inline-formula>] and the estimated <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>) from step 1 as model inputs. Hence the optimization problem becomes:</p>
      <p>
        <disp-formula id="eq20">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1162" xlink:href="ncomms14836-m20.jpg"/>
        </disp-formula>
      </p>
      <p>where <bold>S</bold>* and <bold>D</bold>* are the solutions of <xref ref-type="disp-formula" rid="eq16">equation (6)</xref> using sorted images. In comparison to <xref ref-type="disp-formula" rid="eq16">equation (6)</xref>, solving <xref ref-type="disp-formula" rid="eq20">equation (8)</xref> numerically is much faster, due to a reduced degree of freedom. This is practically beneficial as it can reduce the computational complexity in the background correction of long-term time-lapse movies of many frames (details are provided in <xref ref-type="supplementary-material" rid="S1">Supplementary Note 3</xref>). With the estimation of <italic>S</italic>(<italic>x</italic>), <italic>D</italic>(<italic>x</italic>) and <italic>B</italic><sub><italic>i</italic></sub>, the correction of a time-lapse movie will be:</p>
      <p>
        <disp-formula id="eq21">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1205" xlink:href="ncomms14836-m21.jpg"/>
        </disp-formula>
      </p>
      <p>where <italic>B</italic><sub>norm</sub> is an arbitrarily chosen background. In practices, we set <italic>B</italic><sub>norm</sub>=mean<sub><italic>i</italic></sub>(<italic>B</italic><sub><italic>i</italic></sub>) for bright-field movies to ensure that the BaSiC-corrected movie is in the same intensity range as the raw movie. As for fluorescence movies, we can use <italic>B</italic><sub>norm</sub>=0 to remove the background signal.</p>
    </sec>
    <sec disp-level="2">
      <title>Microscopy data sets</title>
      <p>45 WSIs of four types of specimens used often in biological investigations were collected using a Nikon Ti microscope: four fluorescence WSIs of mouse brain sections, three fluorescence WSIs of mouse kidney sections (Molecular Probes FluoCells Prepared Slide #3), four fluorescence WSIs of tissue culture cells (Molecular Probes FluoCells Prepared Slide #2), and four bright-field WSIs of H&amp;E stained tissue section, each in three different channels. Images were acquired with a × 10/0.45 NA Plan Apochromat objective using a Lumencor SpectraX light source for excitation and emission filters for DAPI, Fluorescein and Cy3. The microscope was controlled by μManager<xref ref-type="bibr" rid="b15">15</xref>. Each WSI contains 50–200 image tiles and is stitched using Grid-wise stitching Plugin in Fiji<xref ref-type="bibr" rid="b16">16</xref> before and after intensity collection. For each data set, we also acquire reference images for the flat-field <italic>S(x)</italic> using a concentrated fluorescent dye solution (<xref ref-type="supplementary-material" rid="S1">Supplementary Note 1</xref>), and the dark-field <italic>D(x)</italic> with no light entering the camera. For brain and cell specimens at Cy3 channel, we observed an additive light in the image background, which can be due to residual excitation light or stray light but not captured in the dark-field calibration. Details of all WSIs and the corresponding corrections are included in <xref ref-type="supplementary-material" rid="S1">Supplementary Figs 5–8</xref>.</p>
      <p>Besides the above WSIs, the microscopy data sets used in this study also include: (i) 6,000 synthetic images with three different levels of cell density (<xref ref-type="supplementary-material" rid="S1">Supplementary Note 6</xref>); (ii) The image collection used in CIDRE (ref. <xref ref-type="bibr" rid="b5">5</xref>) including 10 real microscopy data sets, one photography data set and one synthetic microscopy data set; (iii) One long-term (∼6 days) time-lapse movie (one bright-field and three fluorescence channels) of hematopoietic stem and progenitor cells (Hoppe <italic>et al</italic>.<xref ref-type="bibr" rid="b12">12</xref>), which contain ∼7,000 bright-field frames (acquired every 2 min) and ∼320 fluorescence frames for each fluorescence channel (acquired every 30 min).</p>
    </sec>
    <sec disp-level="2">
      <title>Baseline shading correction methods</title>
      <p>We compare BaSiC to three state-of-the-art retrospective methods and three prospective methods for shading correction. Each method is summarized below:</p>
      <p>CIDRE (ref. <xref ref-type="bibr" rid="b5">5</xref>) is recently published state-of-the-art illumination correction method<xref ref-type="bibr" rid="b5">5</xref>, as it achieves the best performance among 13 shading correction methods. CIDRE can estimate both <italic>S</italic>(<italic>x</italic>) and <italic>D</italic>(<italic>x</italic>) and hence does not require any reference images. Yet the simultaneous estimation of two unknown parameters is not stable when the available images are limited or when images are corrupted with ‘spike'-like noise.</p>
      <p>The background correction module in the software package CellProfiler<xref ref-type="bibr" rid="b7">7</xref> approximates <italic>S</italic>(<italic>x</italic>) using the mean image intensity computed at every location and subsequently smoothed by a median filter of a user defined kernel size (we use a kernel size of 20% of the image size). <italic>D</italic>(<italic>x</italic>) is neglected in CellProfiler.</p>
      <p>Coster <italic>et al</italic>.<xref ref-type="bibr" rid="b6">6</xref> proposed a shading correction method for high-throughput microscopy<xref ref-type="bibr" rid="b6">6</xref>. It first subtracts <italic>D</italic>(<italic>x</italic>), required to be obtained via a prospective method, from all images and approximates <italic>S</italic>(<italic>x</italic>) using the median image intensity computed at every location after subtraction. In our implementation, we further smooth <italic>S</italic>(<italic>x</italic>) with a median filter (kernel size is 20% of the image size, which is found to be optimal). Strictly speaking, Coster is not a complete retrospective method, as the calibration of <italic>D</italic>(<italic>x</italic>) is needed for correction.</p>
      <p>Calib-zero<xref ref-type="bibr" rid="b5">5</xref> is a prospective method which approximates the flat-field <italic>S</italic>(<italic>x</italic>) as the average of images of a plastic fluorescent reference slide<xref ref-type="bibr" rid="b17">17</xref>. The dark-field <italic>D</italic>(<italic>x</italic>) is modelled by averaging images with the shutter closed or the light source turned off or otherwise blocked. The major drawback of this method is that the reference slides often have a different thickness as compared to real histology slides, which makes the approximation of <italic>S</italic>(<italic>x</italic>) inaccurate (<xref ref-type="supplementary-material" rid="S1">Supplementary Note 1</xref>).</p>
      <p>Empty-zero<xref ref-type="bibr" rid="b5">5</xref> is another prospective method that approximates the flat-field <italic>S</italic>(<italic>x</italic>) as the average of images of empty images taken at various locations<xref ref-type="bibr" rid="b18">18</xref>. The calibration of the dark-field <italic>D</italic>(<italic>x</italic>) is same as in Calib-zero. This method is appropriate for bright-field images or fluorescence images when the medium fluoresces<xref ref-type="bibr" rid="b5">5</xref> but will be not applicable for images without a medium. Both the correction of Calib-zero and Empty-zero are obtained from Smith <italic>et al</italic>.<xref ref-type="bibr" rid="b5">5</xref> alongside the data.</p>
      <p>Concentrated dye solution approximates the flat-field <italic>S</italic> using images of a thin layer of concentrated dye<xref ref-type="bibr" rid="b4">4</xref>. The calibration of the dark-field <italic>D(x)</italic> is same as in the above two prospective approaches. This method is usually more accurate than Calib-zero as it has a similar thickness to real specimens (<xref ref-type="supplementary-material" rid="S1">Supplementary Note 1</xref>). In our study, we use the concentrated dye solution as the ground-truth to evaluate our correction of WSI.</p>
    </sec>
    <sec disp-level="2">
      <title>Evaluation protocol</title>
      <p>For synthetic data, where the ground-truth <italic>S</italic>(<italic>x</italic>), <italic>D</italic>(<italic>x</italic>), and the true shading-free images, <inline-formula id="d32e1428"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1429" xlink:href="ncomms14836-m22.jpg"/></inline-formula>(<italic>x</italic>), are available, we quantify the error of the estimated flat-field, <italic>S</italic><sup>est</sup>(<italic>x</italic>), the estimated dark-field, <italic>D</italic><sup>est</sup>(<italic>x</italic>), and the corrected image, <italic>I</italic><sup>corr</sup>(<italic>x</italic>) with a score, <italic>Γ</italic>, defined as the mean absolute deviation between the estimation/correction and the ground-truth, normalized by a baseline difference (the baseline for <italic>S</italic>(<italic>x</italic>), <italic>D</italic>(<italic>x</italic>), and <italic>I</italic><sup>corr</sup>(<italic>x</italic>) is a uniform flat-field, zero dark-field and uncorrected image <italic>I</italic><sup>meas</sup>(<italic>x</italic>), respectively):</p>
      <p>
        <disp-formula id="eq23">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1495" xlink:href="ncomms14836-m23.jpg"/>
        </disp-formula>
      </p>
      <p>The score <italic>Γ</italic> is in the interval [0, ∞), where 0 indicates perfect estimation/correction, 1 indicates the same amount of error as the uncorrected images, and &gt;1 indicates greater disagreement.</p>
      <p>For real microscopy images where the ground truth is not available, a thorough evaluation of a shading correction method is not trivial. There are generally two different approaches in the literature to measure the shading correction quality. The first approach uses the prospectively obtained <italic>S</italic> as a reference and quantifies the error to a retrospectively estimated <italic>S</italic>(<italic>x</italic>) (for example in Coster <italic>et al</italic>.<xref ref-type="bibr" rid="b6">6</xref>). One key challenge of such a validation is how to acquire a reliable reference <italic>S</italic>(<italic>x</italic>). Generally, identical microscope settings, similar specimen thickness, and averaging of multiple reference images (or taking the median to be robust to outliers) improve the accuracy of the reference. In our study, we examine the reliability of our prospectively obtained reference <italic>S</italic>(<italic>x</italic>) by inspecting the smoothness of the shading-corrected WSI using <italic>S</italic>(<italic>x</italic>). Taking the reference <italic>S</italic>(<italic>x</italic>) as the ground-truth, we can quantitatively measure the performance of a retrospective method using the estimation score, <italic>Γ</italic>(<italic>S</italic><sup>est</sup>). The second type of evaluation is based on a correction score<xref ref-type="bibr" rid="b5">5</xref>. In real images where the ground-truth, shading-free images are unavailable, the correction score, <italic>Γ</italic>′(<italic>I</italic><sup>corr</sup>), is based on the absolute difference between pairs of overlapping, corrected images <inline-formula id="d32e1562"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1563" xlink:href="ncomms14836-m24.jpg"/></inline-formula>(<italic>x</italic>) and <inline-formula id="d32e1568"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1569" xlink:href="ncomms14836-m25.jpg"/></inline-formula>(<italic>x</italic>) that are precisely aligned, normalized by the benchmark error of the uncorrected image pairs, <inline-formula id="d32e1575"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1576" xlink:href="ncomms14836-m26.jpg"/></inline-formula>(<italic>x</italic>) and <inline-formula id="d32e1581"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1582" xlink:href="ncomms14836-m27.jpg"/></inline-formula>(<italic>x</italic>), as:</p>
      <p>
        <disp-formula id="eq28">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1589" xlink:href="ncomms14836-m28.jpg"/>
        </disp-formula>
      </p>
      <p>This approach avoids the collection of reference images, yet a perfect correction for real images is impossible, as the disagreement between overlapping images includes many other sources besides uneven illumination, such as noise, alignment error, and photobleaching (the second image, <inline-formula id="d32e1592"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1593" xlink:href="ncomms14836-m29.jpg"/></inline-formula>(<italic>x</italic>), of the image pair usually has a lower signal than the first one, <inline-formula id="d32e1598"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1599" xlink:href="ncomms14836-m30.jpg"/></inline-formula>(<italic>x</italic>), due to the bleaching of fluorescence dyes even without shading). In CIDRE (ref. <xref ref-type="bibr" rid="b5">5</xref>), an extra intensity normalization process is involved, which normalizes the median and the s.d. of image pair before and after correction, that is, <inline-formula id="d32e1608"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1609" xlink:href="ncomms14836-m31.jpg"/></inline-formula>(<italic>x</italic>), <inline-formula id="d32e1614"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1615" xlink:href="ncomms14836-m32.jpg"/></inline-formula> to the reference <inline-formula id="d32e1617"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e1618" xlink:href="ncomms14836-m33.jpg"/></inline-formula>(<italic>x</italic>). However, we do not include any extra normalization process in our study, as an intensity normalization between the uncorrected pairs will affect the assessment of shading correction. Nevertheless, the scores we obtained without normalization (<xref ref-type="fig" rid="f2">Fig. 2a</xref>, <xref ref-type="supplementary-material" rid="S1">Supplementary Fig. 3</xref>) are very similar to those reported in CIDRE (ref. <xref ref-type="bibr" rid="b5">5</xref>).</p>
    </sec>
    <sec disp-level="2">
      <title>Data and software availability</title>
      <p>BaSiC is available as a Fiji/ImageJ Plugin from the Fiji/ImageJ update site <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://sites.imagej.net/BaSiC/">http://sites.imagej.net/BaSiC/</ext-link> and from our software website <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="https://www.helmholtz-muenchen.de/icb/research/groups/quantitative-single-cell-dynamics/software/basic/index.html">https://www.helmholtz-muenchen.de/icb/research/groups/quantitative-single-cell-dynamics/software/basic/index.html</ext-link>, where we also provide five different microscopy data sets used in the manuscript to demonstrate the usage of BaSiC. See also <xref ref-type="supplementary-material" rid="S1">Supplementary Note 7</xref> for installation, usage details and practical tips.</p>
    </sec>
  </sec>
  <sec disp-level="1">
    <title>Additional information</title>
    <p><bold>How to cite this article:</bold> Peng, T. <italic>et al</italic>. A BaSiC tool for background and shading correction of optical microscopy images. <italic>Nat. Commun.</italic>
<bold>8,</bold> 14836 doi: 10.1038/ncomms14836 (2017).</p>
    <p><bold>Publisher's note</bold>: Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
  </sec>
  <sec sec-type="supplementary-material" id="S1">
    <title>Supplementary Material</title>
    <supplementary-material id="d32e18" content-type="local-data">
      <caption>
        <title>Supplementary Information</title>
        <p>Supplementary Figures, Supplementary Notes and Supplementary References</p>
      </caption>
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ncomms14836-s1.pdf"/>
    </supplementary-material>
    <supplementary-material id="d32e24" content-type="local-data">
      <caption>
        <title>Supplementary Movie 1</title>
        <p>Supplementary Movie 1 demonstrates the usage of BaSiC to correct shading and background variation of a bright-field time-lapse movie of blood stem cells.</p>
      </caption>
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ncomms14836-s2.mov"/>
    </supplementary-material>
    <supplementary-material id="d32e30" content-type="local-data">
      <caption>
        <title>Supplementary Movie 2</title>
        <p>Supplementary Movie 2 demonstrates the usage of BaSiC to correct shading and background bleaching of a fluorescence time-lapse movie of embryonic stem cells. This movie has a high correlation between the consecutive frames. BaSiC is able to deal with it when the regularization parameters are manually increased.</p>
      </caption>
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ncomms14836-s3.mov"/>
    </supplementary-material>
    <supplementary-material id="d32e36" content-type="local-data">
      <caption>
        <title>Peer Review File</title>
      </caption>
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ncomms14836-s4.pdf"/>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack>
    <p>Whole slide imaging data was acquired at the Nikon Imaging Center at the University of California, San Francisco. T.P. acknowledges a Humboldt Postdoctoral Research Fellowship. T.S. acknowledges financial support for this project from the SNF and SystemsX.ch. C.M. acknowledges support from the Deutsche Forschungsgemeinschaft (MA 5282/3-1). F.T. acknowledges funding from the Bayerisches Forschungsnetzwerk BioSysNet. T.P. and N.N. acknowledge the support of the Collaborative Research Centre SFB 824 (Z2). The authors acknowledge Kevin Smith to provide the microscopy image collection used in CIDRE<xref ref-type="bibr" rid="b5">5</xref> and thank Michael K. Strasser, Felix Buggenthin, Maximilian Baust and Sailesh Conjeti for insightful discussion.</p>
  </ack>
  <ref-list>
    <ref id="b1">
      <mixed-citation publication-type="journal"><name><surname>Goldman</surname><given-names>D. B.</given-names></name><article-title>Vignette and exposure calibration and compensation</article-title>. <source>IEEE Trans. Pattern Anal. Mach. Intell.</source><volume>32</volume>, <fpage>2276</fpage>–<lpage>2288</lpage> (<year>2010</year>).<pub-id pub-id-type="pmid">20975123</pub-id></mixed-citation>
    </ref>
    <ref id="b2">
      <mixed-citation publication-type="journal"><name><surname>Coutu</surname><given-names>D. L.</given-names></name> &amp; <name><surname>Schroeder</surname><given-names>T.</given-names></name>
<article-title>Probing cellular processes by long-term live imaging--historic problems and current solutions</article-title>. <source>J. Cell Sci.</source>
<volume>126</volume>, <fpage>3805</fpage>–<lpage>3815</lpage> (<year>2013</year>).<pub-id pub-id-type="pmid">23943879</pub-id></mixed-citation>
    </ref>
    <ref id="b3">
      <mixed-citation publication-type="journal"><name><surname>Likar</surname><given-names>B.</given-names></name>, <name><surname>Maintz</surname><given-names>J. B.</given-names></name>, <name><surname>Viergever</surname><given-names>M. A.</given-names></name> &amp; <name><surname>Pernus</surname><given-names>F.</given-names></name>
<article-title>Retrospective shading correction based on entropy minimization</article-title>. <source>J. Microsc.</source>
<volume>197</volume>, <fpage>285</fpage>–<lpage>295</lpage> (<year>2000</year>).<pub-id pub-id-type="pmid">10692132</pub-id></mixed-citation>
    </ref>
    <ref id="b4">
      <mixed-citation publication-type="journal"><name><surname>Model</surname><given-names>M.</given-names></name><article-title>Intensity calibration and flat-field correction for fluorescence microscopes</article-title>. <source>Curr. Protoc. Cytom.</source><volume>68</volume>, <fpage>10.14.1</fpage>–<lpage>10.14.10</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24692055</pub-id></mixed-citation>
    </ref>
    <ref id="b5">
      <mixed-citation publication-type="journal"><name><surname>Smith</surname><given-names>K.</given-names></name><etal/>. <article-title>CIDRE: an illumination-correction method for optical microscopy</article-title>. <source>Nat. Methods</source><volume>12</volume>, <fpage>404</fpage>–<lpage>406</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">25775044</pub-id></mixed-citation>
    </ref>
    <ref id="b6">
      <mixed-citation publication-type="journal"><name><surname>Coster</surname><given-names>A. D.</given-names></name>, <name><surname>Wichaidit</surname><given-names>C.</given-names></name>, <name><surname>Rajaram</surname><given-names>S.</given-names></name>, <name><surname>Altschuler</surname><given-names>S. J.</given-names></name> &amp; <name><surname>Wu</surname><given-names>L. F.</given-names></name>
<article-title>A simple image correction method for high-throughput microscopy</article-title>. <source>Nat. Methods</source>
<volume>11</volume>, <fpage>602</fpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24874571</pub-id></mixed-citation>
    </ref>
    <ref id="b7">
      <mixed-citation publication-type="journal"><name><surname>Singh</surname><given-names>S.</given-names></name>, <name><surname>Bray</surname><given-names>M.-A.</given-names></name>, <name><surname>Jones</surname><given-names>T. R.</given-names></name> &amp; <name><surname>Carpenter</surname><given-names>A. E.</given-names></name>
<article-title>Pipeline for illumination correction of images for high-throughput microscopy</article-title>. <source>J. Microsc.</source>
<volume>256</volume>, <fpage>231</fpage>–<lpage>236</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">25228240</pub-id></mixed-citation>
    </ref>
    <ref id="b8">
      <mixed-citation publication-type="journal"><name><surname>Lin</surname><given-names>Z.</given-names></name>, <name><surname>Liu</surname><given-names>R.</given-names></name> &amp; <name><surname>Su</surname><given-names>Z.</given-names></name>
<article-title>Linearized alternating direction method with adaptive penalty for low-rank representation</article-title>. <source>Adv. Neural Inf. Process. Syst.</source>
<volume>24</volume>, <fpage>612</fpage>–<lpage>620</lpage> (<year>2011</year>).</mixed-citation>
    </ref>
    <ref id="b9">
      <mixed-citation publication-type="journal"><name><surname>Candès</surname><given-names>E.</given-names></name>, <name><surname>Li</surname><given-names>X.</given-names></name>, <name><surname>Ma</surname><given-names>Y.</given-names></name> &amp; <name><surname>Wright</surname><given-names>J.</given-names></name>
<article-title>Robust Principal Component Analysis?</article-title>
<source>J. ACM</source>
<volume>58</volume>, <fpage>1</fpage>–<lpage>37</lpage> (<year>2011</year>).</mixed-citation>
    </ref>
    <ref id="b10">
      <mixed-citation publication-type="journal"><name><surname>Peng</surname><given-names>Y.</given-names></name>, <name><surname>Ganesh</surname><given-names>A.</given-names></name>, <name><surname>Wright</surname><given-names>J.</given-names></name>, <name><surname>Xu</surname><given-names>W.</given-names></name> &amp; <name><surname>Ma</surname><given-names>Y.</given-names></name>
<article-title>RASL: robust alignment by sparse and low-rank decomposition for linearly correlated images</article-title>. <source>IEEE Trans. Pattern Anal. Mach. Intell.</source>
<volume>34</volume>, <fpage>2233</fpage>–<lpage>2246</lpage> (<year>2012</year>).<pub-id pub-id-type="pmid">22213763</pub-id></mixed-citation>
    </ref>
    <ref id="b11">
      <mixed-citation publication-type="journal"><name><surname>Etzrodt</surname><given-names>M.</given-names></name>, <name><surname>Endele</surname><given-names>M.</given-names></name> &amp; <name><surname>Schroeder</surname><given-names>T.</given-names></name>
<article-title>Quantitative single-cell approaches to stem cell research</article-title>. <source>Cell Stem Cell</source>
<volume>15</volume>, <fpage>546</fpage>–<lpage>558</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">25517464</pub-id></mixed-citation>
    </ref>
    <ref id="b12">
      <mixed-citation publication-type="journal"><name><surname>Hoppe</surname><given-names>P. S.</given-names></name><etal/>. <article-title>Early myeloid lineage choice is not initiated by random PU.1 to GATA1 protein ratios</article-title>. <source>Nature</source><volume>535</volume>, <fpage>299</fpage>–<lpage>302</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">27411635</pub-id></mixed-citation>
    </ref>
    <ref id="b13">
      <mixed-citation publication-type="journal"><name><surname>Donoho</surname><given-names>D. L.</given-names></name><article-title>Compressed sensing</article-title>. <source>IEEE Trans. Inf. Theory</source><volume>52</volume>, <fpage>1289</fpage>–<lpage>1306</lpage> (<year>2006</year>).</mixed-citation>
    </ref>
    <ref id="b14">
      <mixed-citation publication-type="journal"><name><surname>Candes</surname><given-names>E.</given-names></name>, <name><surname>Wakin</surname><given-names>M.</given-names></name> &amp; <name><surname>Boyd</surname><given-names>S.</given-names></name>
<article-title>Enhancing Sparsity by Reweighted L1 Minimization</article-title>. <source>J. Fourier Anal. Appl.</source>
<volume>14</volume>, <fpage>877</fpage>–<lpage>905</lpage> (<year>2008</year>).</mixed-citation>
    </ref>
    <ref id="b15">
      <mixed-citation publication-type="journal"><name><surname>Edelstein</surname><given-names>A.</given-names></name>, <name><surname>Amodaj</surname><given-names>N.</given-names></name>, <name><surname>Hoover</surname><given-names>K.</given-names></name>, <name><surname>Vale</surname><given-names>R.</given-names></name> &amp; <name><surname>Stuurman</surname><given-names>N.</given-names></name>
<article-title>Computer control of microscopes using μManager</article-title>. <source>Curr. Protoc. Mol. Biol.</source> Chapter 14, Unit14.20 (2010).</mixed-citation>
    </ref>
    <ref id="b16">
      <mixed-citation publication-type="journal"><name><surname>Preibisch</surname><given-names>S.</given-names></name>, <name><surname>Saalfeld</surname><given-names>S.</given-names></name> &amp; <name><surname>Tomancak</surname><given-names>P.</given-names></name>
<article-title>Globally optimal stitching of tiled 3D microscopic image acquisitions</article-title>. <source>Bioinformatics</source>
<volume>25</volume>, <fpage>1463</fpage>–<lpage>1465</lpage> (<year>2009</year>).<pub-id pub-id-type="pmid">19346324</pub-id></mixed-citation>
    </ref>
    <ref id="b17">
      <mixed-citation publication-type="journal"><name><surname>Varga</surname><given-names>V. S.</given-names></name><etal/>. <article-title>Scanning fluorescent microscopy is an alternative for quantitative fluorescent cell analysis</article-title>. <source>Cytometry. A</source><volume>60</volume>, <fpage>53</fpage>–<lpage>62</lpage> (<year>2004</year>).<pub-id pub-id-type="pmid">15229857</pub-id></mixed-citation>
    </ref>
    <ref id="b18">
      <mixed-citation publication-type="journal"><name><surname>Young</surname><given-names>I. T.</given-names></name><article-title>Shading correction: compensation for illumination and sensor inhomogeneities</article-title>. <source>Curr. Protoc. Cytom</source> Chapter 2, <fpage>Unit 2.11</fpage> (<year>2001</year>).<pub-id pub-id-type="pmid">18770694</pub-id></mixed-citation>
    </ref>
  </ref-list>
  <fn-group>
    <fn fn-type="COI-statement">
      <p>T.P., N.N. and C.M. have applied for a patent relating to this work.</p>
    </fn>
    <fn>
      <p><bold>Author contributions</bold> T.P. developed and implemented BaSiC. L.W. contributed to method development. K.T. provided WSI data. T.S. provided time-lapse data. T.P. and C.M. wrote the manuscript. F.J.T., K.T. and N.N. commented on the method and the manuscript. C.M. and N.N. supervised the project. All authors approved the final draft.</p>
    </fn>
  </fn-group>
</back>
<floats-group>
  <fig id="f1">
    <label>Figure 1</label>
    <caption>
      <title>BaSiC is an automatic correction method for both static multi-image microscopy data and dynamic time-lapse data.</title>
      <p>(<bold>a</bold>) A mosaic whole slide image (WSI) of a mouse brain slice showing intensity discontinuities and resulting stitching errors (indicated by black arrows). (<bold>b</bold>) A time-lapse movie corrupted by both shading in space and photobleaching in time. (<bold>c</bold>) The BaSiC workflow, (see text for detailed explanation). (<bold>d</bold>) The corrected WSI shows improved stitching with no discontinuities. (<bold>e</bold>) BaSiC corrects both spatial shading and background bleaching over time.</p>
    </caption>
    <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ncomms14836-f1"/>
  </fig>
  <fig id="f2">
    <label>Figure 2</label>
    <caption>
      <title>BaSiC requires significantly fewer images and is robust to image artefacts.</title>
      <p>(<bold>a</bold>) Method evaluation on benchmark data sets<xref ref-type="bibr" rid="b5">5</xref>. Correction quality is evaluated by the correction score, <italic>Γ</italic>′(<italic>I</italic><sup><italic>corr</italic></sup>), the mean absolute difference between overlapping regions after correction, normalized by the difference before correction. A lower correction score suggests better correction results. Each curve represents the average performance on 12 microscope image collections. For less than 500 images, BaSiC significantly outperforms other retrospective methods (<italic>P</italic>&lt;0.023, paired Wilcoxon signed rank test with Bonferrnoi correction for multiple testing). With &gt;100 images, BaSiC outperforms two prospective methods (Calib-zero and Empty-zero). (<bold>b</bold>) Typical WSI artefacts: bright particles on the specimen that strongly emit light (‘spike'-like artefact, top) or scatter light (bottom). (<bold>c</bold>) BaSiC is more robust to the ‘spike'-like artefacts as compared to CIDRE and Cellprofiler. Note that only BaSiC and CIDRE can estimate dark-field, while other methods simply neglect dark-field. (<bold>d</bold>) Surface plots show the averaged cell intensity of different spatial locations before and after shading correction of cell culture WSI. After BaSiC correction, the s.d. of the mean cell intensity over different regions is reduced to around 20% of the uncorrected s.d. (<bold>e</bold>) BaSiC significantly outperforms other methods on 45 WSIs of various types of biological specimen, imaged at different channels and diverse experimental settings, containing noise and artefacts. The estimation score, <italic>Γ</italic>(<italic>S</italic><sup>est</sup>), is the mean absolute difference between the estimated <italic>S</italic><sup>est</sup>(<italic>x</italic>) and the prospectively obtained reference <italic>S</italic>(<italic>x</italic>), normalized by a baseline score. Besides achieving the minimum median score, BaSiC, unlike other methods, does not have a single outlier in all cases (refer to <xref ref-type="supplementary-material" rid="S1">Supplementary Figs 5–8</xref> for the individual scores for all 45 WSIs).</p>
    </caption>
    <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ncomms14836-f2"/>
  </fig>
  <fig id="f3">
    <label>Figure 3</label>
    <caption>
      <title>Single-cell quantification of time-lapse data is significantly improved after BaSiC correction.</title>
      <p>(<bold>a</bold>) Hematopoietic stem and progenitor cells can differentiate into two different lineages (GM or MegE). (<bold>b</bold>,<bold>c</bold>) PU.1 expression along two exemplary cellular branches, one committing to the GM lineage signified by CD16/32 onset (<bold>b</bold>) and the other committing to the MegE lineage signified by Gata1 onset (<bold>c</bold>). The BaSiC-corrected intensity profiles (red) show a PU.1 upregulation in the GM lineage prior to CD16/32 onset, but not in the MegE lineage. The uncorrected profiles (black) suffer from shading, temporal drift and noise. Bright-field, PU.1, CD16/32 and Gata1 image patches of each cell in the branch after BaSiC correction are shown on top (scale bar, 10 μm). (<bold>d</bold>) The BaSiC-corrected PU.1 intensity fold change (right bars) between marker onset and start of the movie (averaged over 6 h) suggests that GM cell branches show a significant (<italic>n</italic>=99, <italic>P</italic>=0.0012, Wilcoxon rank-sum test) PU.1 upregulation in contrast to MegE cell branches (<italic>n</italic>=49). This is not observable in the uncorrected fold changes (left bars).</p>
    </caption>
    <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ncomms14836-f3"/>
  </fig>
</floats-group>
