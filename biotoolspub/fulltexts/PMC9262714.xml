<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Methods</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Methods</journal-id>
    <journal-title-group>
      <journal-title>Nature Methods</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1548-7091</issn>
    <issn pub-type="epub">1548-7105</issn>
    <publisher>
      <publisher-name>Nature Publishing Group US</publisher-name>
      <publisher-loc>New York</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">9262714</article-id>
    <article-id pub-id-type="pmid">35637304</article-id>
    <article-id pub-id-type="publisher-id">1486</article-id>
    <article-id pub-id-type="doi">10.1038/s41592-022-01486-3</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>MSNovelist: de novo structure generation from mass spectra</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-1426-8572</contrib-id>
        <name>
          <surname>Stravs</surname>
          <given-names>Michael A.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-9056-0540</contrib-id>
        <name>
          <surname>Dührkop</surname>
          <given-names>Kai</given-names>
        </name>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-9304-8091</contrib-id>
        <name>
          <surname>Böcker</surname>
          <given-names>Sebastian</given-names>
        </name>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-1271-1021</contrib-id>
        <name>
          <surname>Zamboni</surname>
          <given-names>Nicola</given-names>
        </name>
        <address>
          <email>zamboni@imsb.biol.ethz.ch</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.5801.c</institution-id><institution-id institution-id-type="ISNI">0000 0001 2156 2780</institution-id><institution>Institute of Molecular Systems Biology, Department of Biology, </institution><institution>ETH Zürich, </institution></institution-wrap>Zürich, Switzerland </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.9613.d</institution-id><institution-id institution-id-type="ISNI">0000 0001 1939 2794</institution-id><institution>Chair for Bioinformatics, Faculty of Mathematics and Computer Science, Friedrich-Schiller-Universität Jena, </institution></institution-wrap>Jena, Germany </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="GRID">grid.418656.8</institution-id><institution-id institution-id-type="ISNI">0000 0001 1551 0562</institution-id><institution>Present Address: Eawag, </institution></institution-wrap>Dübendorf, Switzerland </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>30</day>
      <month>5</month>
      <year>2022</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>30</day>
      <month>5</month>
      <year>2022</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <year>2022</year>
    </pub-date>
    <volume>19</volume>
    <issue>7</issue>
    <fpage>865</fpage>
    <lpage>870</lpage>
    <history>
      <date date-type="received">
        <day>6</day>
        <month>7</month>
        <year>2021</year>
      </date>
      <date date-type="accepted">
        <day>7</day>
        <month>4</month>
        <year>2022</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2022</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Current methods for structure elucidation of small molecules rely on finding similarity with spectra of known compounds, but do not predict structures de novo for unknown compound classes. We present MSNovelist, which combines fingerprint prediction with an encoder–decoder neural network to generate structures de novo solely from tandem mass spectrometry (MS<sup>2</sup>) spectra. In an evaluation with 3,863 MS<sup>2</sup> spectra from the Global Natural Product Social Molecular Networking site, MSNovelist predicted 25% of structures correctly on first rank, retrieved 45% of structures overall and reproduced 61% of correct database annotations, without having ever seen the structure in the training phase. Similarly, for the CASMI 2016 challenge, MSNovelist correctly predicted 26% and retrieved 57% of structures, recovering 64% of correct database annotations. Finally, we illustrate the application of MSNovelist in a bryophyte MS<sup>2</sup> dataset, in which de novo structure prediction substantially outscored the best database candidate for seven spectra. MSNovelist is ideally suited to complement library-based annotation in the case of poorly represented analyte classes and novel compounds.</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">MSNovelist combines fingerprint prediction with an encoder–decoder neural network for de novo structure generation of small molecules from mass spectra.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Computational biology and bioinformatics</kwd>
      <kwd>Metabolomics</kwd>
      <kwd>Mass spectrometry</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>This project and NZ is supported by grants from the Strategic Focal Area Personalized Health and Related Technologies (PHRT) of the ETH Domain and by ETH Zürich.</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>MS is supported by grants from the Strategic Focal Area Personalized Health and Related Technologies (PHRT) of the ETH Domain and by ETH Zürich.</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>K.D. and S.B. are supported by Deutsche Forschungsgemeinschaft (BO 1910/20)</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s), under exclusive licence to Springer Nature America, Inc. 2022</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Main</title>
    <p id="Par3">A key challenge in mass spectrometry, particularly in metabolomics and non-targeted analysis, is feature annotation, or the assignment of chemical identity to unknown signals from their exact mass and fragment (tandem mass spectrometry (MS<sup>2</sup>)) spectra. Compounds may be identified by either searching against mass spectral libraries from synthetic standards or searching against data inferred from structures (so-called ‘in silico methods’). Both approaches have limitations. Matching against experimental libraries<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR2">2</xref></sup> is limited by the actual availability of standards and curated spectral data that poorly represents the diversity and complexity of the chemical space. Searching against structural databases (for example, PubChem<sup><xref ref-type="bibr" rid="CR3">3</xref></sup> or KEGG<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>) includes nontrivial simulation of spectra<sup><xref ref-type="bibr" rid="CR5">5</xref></sup> or fragmentation patterns<sup><xref ref-type="bibr" rid="CR6">6</xref></sup> for candidate compounds, or the prediction of high-dimensional molecular descriptors for spectra<sup><xref ref-type="bibr" rid="CR7">7</xref>–<xref ref-type="bibr" rid="CR9">9</xref></sup>. Importantly, none of these methods is able to identify truly novel and unexpected compounds like unknown natural products, drug metabolites or environmental transformation products.</p>
    <p id="Par4">In principle, the simplest and entirely database-independent approach to assigning a structural identity to truly unknown compounds is to first determine the molecular formula, then enumerate all possible candidates, and finally score against experimental data<sup><xref ref-type="bibr" rid="CR10">10</xref>–<xref ref-type="bibr" rid="CR12">12</xref></sup>. This approach fails in practice because of the combinatorial explosion in the number of structures that can exist even for simple formulas<sup><xref ref-type="bibr" rid="CR13">13</xref></sup>. Recent strategies for identification of true unknowns have instead relied on expanding compound databases using chemical reaction rules<sup><xref ref-type="bibr" rid="CR14">14</xref>,<xref ref-type="bibr" rid="CR15">15</xref></sup>, identifying partial structures using spectral networking<sup><xref ref-type="bibr" rid="CR16">16</xref></sup> and ‘hybrid search’ (MS<sup>2</sup> library search including mass shifts)<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> or, recently, assigning chemical classes in silico using machine learning<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>.</p>
    <p id="Par5">In the context of computational drug design, deep learning algorithms for targeted de novo molecule generation have recently emerged. These methods allow querying a large chemical space of novel compounds without enumerating candidates. In analogy to the methods used for text generation, Gómez-Bombarelli et al.<sup><xref ref-type="bibr" rid="CR19">19</xref></sup> used a variational autoencoder (VAE) with a recurrent neural network (RNN) to generate textual representations of molecules, that is, SMILES<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>. Similarly, Segler et al.<sup><xref ref-type="bibr" rid="CR21">21</xref></sup> used an RNN sequence model to generate molecules. Numerous variations of these models generate molecules in the form of SMILES, SMILES-related representations, or directly as graphs, achieving specific chemical properties by fine-tuning, optimization in latent space, or reinforcement learning (see, for example, refs. <sup><xref ref-type="bibr" rid="CR22">22</xref>–<xref ref-type="bibr" rid="CR24">24</xref></sup>).</p>
    <p id="Par6">For mass spectrometry, two recent approaches have used molecule generation to generate candidate libraries based on a target collision cross-section (CCS) and mass<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>, or for a specific compound class<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>. However, these methods do not take the structural information from MS<sup>2</sup> spectra into account, and therefore only provide a list of candidates that needs further filtering. If information from MS<sup>2</sup> spectra could be used directly for targeted structure generation, this would bypass the combinatorial bottleneck for de novo structure elucidation. Unfortunately, using MS<sup>2</sup> spectra to directly train molecule generation models is currently not feasible because of the limited amount of training data. In fact, we estimate that, even by merging the largest MS<sup>2</sup> repositories (that is, NIST2020, MoNA, MassBank.EU, Global Natural Product Social Molecular Networking (GNPS)), experimental MS<sup>2</sup> data would be available for circa 60,000 molecules, which is an order of magnitude below standard requirements for generative models, typically trained with &gt;500,000 structures<sup><xref ref-type="bibr" rid="CR19">19</xref>,<xref ref-type="bibr" rid="CR21">21</xref>,<xref ref-type="bibr" rid="CR22">22</xref></sup>. Many repositories include simulated MS<sup>2</sup> data, but these are based on class-specific fragmentation rules, for example, for peptides and lipids, and therefore of little use to train generative models for more heterogeneous classes.</p>
    <p id="Par7">We tackle the MS<sup>2</sup>-to-structure challenge in two consecutive tasks. We first use CSI:FingerID<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR9">9</xref></sup> to tackle the MS<sup>2</sup>-to-fingerprint problem. CSI:FingerID predicts a high-dimensional molecular fingerprint, which is normally used to query a molecular structure database searching for candidates that have a matching fingerprint. Here, we substitute the database search with an RNN generative model that was trained to address the fingerprint-to-structure task. Combining the two components in a unique workflow resulted in MSNovelist, a method that generates a ranked list of candidate structures directly from MS<sup>2</sup> spectra. As MSNovelist doesn’t use any structural or spectral database to retrieve candidates, it is particularly suited to identify poorly represented analyte classes or novel compounds. We evaluate the method’s performance in the context of the current state-of-the-art database search on a reference dataset from the GNPS spectral library with &gt;3,800 MS<sup>2</sup> spectra<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> and on the CASMI 2016 structure identification challenge<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>. As an exemplary application of de novo spectral annotation, we apply our method to a bryophyte liquid chromatography–mass spectrometry dataset and putatively annotate seven novel chemical structures.</p>
  </sec>
  <sec id="Sec2">
    <title>Overview of the method</title>
    <p id="Par8">MSNovelist performs de novo structure elucidation from MS<sup>2</sup> spectra in two steps (Fig. <xref rid="Fig1" ref-type="fig">1</xref>). First, it relies on SIRIUS and CSI:FingerID to predict a molecular formula <bold>x</bold><sup><italic>M</italic></sup> and a structural fingerprint <bold>x</bold><sup><italic>F</italic></sup>, respectively, from the MS<sup>2</sup> spectrum<sup><xref ref-type="bibr" rid="CR9">9</xref></sup>. The fingerprint <bold>x</bold><sup>F</sup> consists of a vector with 3,609 values ranging from 0 to 1 to express the likelihood that the molecule of interest has given structural characteristics. If known, the molecular formula <bold>x</bold><sup><italic>MM</italic></sup><italic>x</italic><sup><italic>M</italic></sup> can be specified by the user to bypass the SIRIUS prediction. Second, we trained an encoder–decoder RNN model to predict structures in the form of a SMILES sequence from the fingerprint <bold>x</bold><sup><italic>F</italic></sup> under the constraints imposed by the formula <bold>x</bold><sup><italic>M</italic></sup>. Conceptually, the model learns how to represent the structural fingerprint features in a SMILES string. For every query tuple (<bold>x</bold><sup><italic>F</italic></sup>, <bold>x</bold><sup><italic>M</italic></sup>), the model returns a set of <italic>k</italic> structures ranked by the raw RNN model score, that is, the probability of the sequence under the model. As the RNN model can generate invalid SMILES, or also generate different SMILES strings that encode for the same structure, the <italic>k</italic> structures are validated and dereplicated. Finally, the candidate structures are re-ranked by calculating the match to the query fingerprint <bold>x</bold><sup><italic>F</italic></sup> using the modified Platt score<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>.<fig id="Fig1"><label>Fig. 1</label><caption><title>Conceptual overview of MSNovelist.</title><p>Using the existing SIRIUS and CSI:FingerID approach, a molecular fingerprint and a molecular formula were predicted. These data were used as input to an encoder–decoder RNN model with LSTM architecture to predict a SMILES sequence. Finally, candidate structures were ranked by modified Platt score, that is, according to the match to the predicted molecular fingerprint.</p></caption><graphic xlink:href="41592_2022_1486_Fig1_HTML" id="d32e541"/></fig></p>
    <p id="Par9">A key advantage of our approach is that the training of the RNN model for the second step is independent of spectral libraries. As fingerprints can be computed for any molecular structure and independently from spectral libraries, we can obtain virtually unlimited training points<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> without the constraints imposed by limited MS<sup>2</sup> data availability. Specifically, the RNN model was trained on a dataset of 1,232,184 chemical structures compiled from the databases HMDB (4.0)<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>, COCONUT<sup><xref ref-type="bibr" rid="CR30">30</xref></sup> and DSSTox<sup><xref ref-type="bibr" rid="CR31">31</xref></sup>, and 14,047 predicted fingerprints to parametrize fingerprint simulation (that is, to add error to the input). All structures used for fingerprint simulation or present in evaluation datasets were removed from the training set to effectively evaluate the ability to identify structures that have not been observed before, that is, two disjoint sets were used: a test set and a training set (<xref rid="Sec7" ref-type="sec">Methods</xref>).</p>
  </sec>
  <sec id="Sec3">
    <title>Method validation</title>
    <p id="Par10">We benchmarked MSNovelist with two large, diverse and frequently used MS<sup>2</sup> datasets for which the correct structure is known. The full structural prediction model was first validated using 3,863 MS<sup>2</sup> spectra from GNPS<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> closely matching the evaluation setup by Dührkop et al.<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR9">9</xref></sup>. These spectra cover heterogeneous types of compounds, samples, instrumentation, spectral quality, and so on. No additional quality control or cleanup was performed before subjecting these spectra to MSNovelist. For each spectrum, we retrieved the 128 highest-scoring SMILES sequences (top-128). In 99.5% of the instances, MSNovelist generated valid structures with the correct molecular formula. The correct structure was retrieved for 45% and ranked first for 25% of the instances (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>). In comparison, a database search with CSI:FingerID was able to rank the correct structure on top for 39% of the spectra. This represents the maximum that MSNovelist can reach, because it uses the same fingerprint for structure generation as CSI:FingerID uses for database search. In this subset (GNPS-OK, 1,507 spectra; Supplementary Table <xref rid="MOESM1" ref-type="media">2</xref>), MSNovelist correctly retrieved 68% of the true structures. In 61% of the instances, the true structure matched with the top-ranked candidate (Fig. <xref rid="Fig2" ref-type="fig">2b</xref>). In the cases where the true structure was not ranked first by MSNovelist, the generated structures were typically very similar to the target molecule. This is shown by ten examples randomly picked from all incorrect predictions of the GNPS dataset (Fig. <xref rid="Fig2" ref-type="fig">2e</xref> and Supplementary Fig. <xref rid="MOESM1" ref-type="media">2</xref>). In this sample, seven mispredictions were close isomers of the correct structure, one instance showed a partial mismatch in the skeleton, and only two predictions were completely wrong. Further cases are available in the provided supplementary dataset; a quantitative evaluation of similarity on the entire dataset is provided below.<fig id="Fig2"><label>Fig. 2</label><caption><title>Validation of MSNovelist with GNPS dataset.</title><p><bold>a</bold>, Rank of correct structure in results for MSNovelist (blue), and naïve generation (orange), with ranking by modified Platt score (solid line) or by RNN score (dashed line), and comparison to database search (CSI:FingerID on PubChem; green) for the GNPS dataset (<italic>n</italic> = 3,863). <bold>b</bold>, Rank of correct structure in results for MSNovelist and naïve generation, with ranking by modified Platt score or ordered by model probability, and comparison to database search for GNPS-OK dataset (<italic>n</italic> = 1,507). <bold>c</bold>, Tanimoto similarity of best incorrect candidate to correct structure for MSNovelist, naïve generation, database search, best candidate from training set and random candidate from training set. <bold>d</bold>, Modified Platt score of top candidates, for MSNovelist, naïve generation, database search, best candidate from training set (light blue) and random candidate from training set (red) <bold>e</bold>, Three randomly chosen examples of incorrect predictions (top candidate) from GNPS dataset. Structures 1a, 2a and 3a represent de novo prediction; structures 1b, 2b and 3b represent a correct result. Red marks sites predicted incorrectly by the model (or the entire molecule if the prediction was completely wrong), and blue marks the corresponding correct alternative.</p></caption><graphic xlink:href="41592_2022_1486_Fig2_HTML" id="d32e636"/></fig></p>
    <p id="Par11">The importance of structural information was tested with a model that lacked the fingerprint input to the encoder. This naïve generator creates structures with a specific molecular formula, but cannot make use of structural information. Importantly, the results of the naïve generator were ranked by the modified Platt score as in the full workflow. In the GNPS dataset, naïve generation retrieved only 31% of all correct structures, and 17% were ranked first. While this is clearly lower than guided de novo generation, it also shows that deceptively high performance can be achieved purely by sampling large numbers of molecules and a posteriori ranking using the modified Platt score. A similar trend was observed for the GNPS-OK subset, with 37% of structures retrieved, and 35% were first in the ranking. In both datasets, inclusion of structural information from fingerprints in de novo generation increased the recovery of true structures by 13 to 31 percentage points.</p>
    <p id="Par12">As a second benchmark, we generated structures for the 127 positive-mode MS<sup>2</sup> spectra from the CASMI 2016 competition<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>, which is a common benchmark for structure elucidation (Supplementary Fig. <xref rid="MOESM1" ref-type="media">3</xref> and Supplementary Tables <xref rid="MOESM1" ref-type="media">3</xref> and <xref rid="MOESM1" ref-type="media">4</xref>). MSNovelist retrieved 57% of structures (26% ranked first). The naïve model achieved 52% retrieval, and 24% top-1 hits. The marginal improvement of MSNovelist over the naïve model indicates that the structures are likely very similar to training set data. However, from the 47 instances that were correctly identified by database search (CASMI-OK), MSNovelist retrieved 74% and identified 64% at the first rank, while naïve generation only retrieved 56% and identified 51% at the first rank. This demonstrates that the model effectively uses structural information when present in the spectra. Overall, these evaluation tests with two large, diverse and representative datasets demonstrate that de novo structural annotation is in principle possible and in 50–70% of the cases generates candidates that are consistent with the true structure.</p>
  </sec>
  <sec id="Sec4">
    <title>Extrapolation, chemical similarity and model score</title>
    <p id="Par13">We conducted further evaluations to demonstrate model performance and to verify that de novo structures outscore training set structures in terms of similarity to the query fingerprint and molecule. To provide a numerical measure of how close to truth typical predictions are, we compared the chemical similarity of the best incorrect prediction (compare also Cooper et al.<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>) to the correct structure. This allows a direct comparison of de novo predictions with the training set data, which contains only incorrect results (as all true structures are removed from RNN training). Figure <xref rid="Fig2" ref-type="fig">2c</xref> shows the histogram of similarity scores over all instances (median and 25–75% quantile; Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>). The best incorrect de novo predictions (median 0.80) scored higher than the best-in-training set (0.76) and nearly as high as the best incorrect database structure (0.84). This demonstrates that the model systematically generates combinations of chemical features not seen in the training set. In contrast, naïve generation slightly underperformed the best training set candidate, as expected from generation without structural guidance.</p>
    <p id="Par14">The modified Platt score quantifies the match of the generated structure to the input fingerprint. Therefore, it directly measures the performance of the fingerprint-to-structure step of MSNovelist, independent of errors in the fingerprint prediction. For the best MSNovelist candidates, the modified Platt scores (median −5,886) were essentially identical to the best database compounds (−5,883) and higher than best compounds in the training set (−5,928; Fig. <xref rid="Fig2" ref-type="fig">2d</xref>). Again, the naïve model performed slightly worse than the best training set candidate.</p>
    <p id="Par15">We also evaluated the relevance of posterior re-ranking with the modified Platt score. The RNN model without re-ranking by modified Platt score reached notable 19% and 39% correct (top-ranked) identifications in the GNPS and GNPS-OK datasets, respectively (Fig. <xref rid="Fig2" ref-type="fig">2a,b</xref>). The best compounds identified by the RNN model alone had a higher modified Platt score (median −5,910) than the best training set compounds, and reached nearly the same chemical similarity (0.74; Supplementary Fig. <xref rid="MOESM1" ref-type="media">6</xref>). This indicates that the raw RNN score is already informative about the structure–spectrum match, but the additional re-ranking by modified Platt score yields more correct identifications and higher scores in the auxiliary benchmarks.</p>
    <p id="Par16">Similarly, we examined the necessity of element counting and hydrogen estimation for the generation of valid results and their effect on model performance (Supplementary Fig. <xref rid="MOESM1" ref-type="media">4</xref> and <xref rid="MOESM1" ref-type="media">5</xref> and Supplementary Tables <xref rid="MOESM1" ref-type="media">1</xref>–<xref rid="MOESM1" ref-type="media">4</xref>). In summary, the model was still able to produce high-scoring results without the additional components; they increased the number of valid results with the correct molecular formula, and consequently, slightly improved overall retrieval.</p>
    <p id="Par17">Finally, we examined the impact of the number of generated candidates. Generation of only 16 candidates by MSNovelist was sufficient to outcompete the top-128 naïve candidates in all metrics for all four datasets and sub-datasets, except overall retrieval in CASMI (see Supplementary Fig. <xref rid="MOESM1" ref-type="media">3</xref> and <xref rid="MOESM1" ref-type="media">6</xref> and Supplementary Tables <xref rid="MOESM3" ref-type="media">1</xref>–<xref rid="MOESM3" ref-type="media">4</xref>). This provides further evidence that MSNovelist directly generates structures with a high spectrum–structure match without requiring extensive sampling.</p>
  </sec>
  <sec id="Sec5">
    <title>De novo annotation of bryophyte metabolites</title>
    <p id="Par18">An objective of de novo annotation in discovery metabolomics is to identify novel biological small molecules. We demonstrate the use of MSNovelist for this application for a dataset of nine bryophyte species (Peters et al.<sup><xref ref-type="bibr" rid="CR33">33</xref></sup>). Bryophytes are known to produce diverse secondary metabolites, but are not extensively studied, presenting a likely opportunity for natural product discovery. From the data repository (<ext-link ext-link-type="uri" xlink:href="https://www.ebi.ac.uk/metabolights/MTBLS709">MTBLS709</ext-link>), we extracted 576 consolidated MS<sup>2</sup> spectra and analyzed them with SIRIUS to infer formula. For 224 spectra, we obtained a molecular formula with high confidence (≥80% explained peaks, ≥90% explained intensity, ≥0.9% ZODIAC score). These were further analyzed by MSNovelist to predict the molecular structure. First, we compared the modified Platt scores for the best de novo and database candidates. (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>). In 27 cases the same structure was identified with both approaches. For 169 cases (75%), the MSNovelist structure scored higher than the database, indicating that the de novo structure was a better fit to the spectrum than any database entry.<fig id="Fig3"><label>Fig. 3</label><caption><title>De novo annotation of bryophyte metabolites.</title><p><bold>a</bold>, Scores of best MSNovelist candidates versus best database scores for 232 spectra; the solid line represents a 1:1, and the dashed line represents <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{ModPlatt}}_{{\mathrm{MSNovelist}}} = {\mathrm{ModPlatt}}_{{\mathrm{DB} }} + 50$$\end{document}</tex-math><mml:math id="M2"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">ModPlatt</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">MSNovelist</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">ModPlatt</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">DB</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mn>50</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq1.gif"/></alternatives></inline-formula>; labels indicate spectrum ID. <bold>b</bold>, MS<sup>2</sup> spectrum of feature 377. <bold>c</bold>, Proposed spectrum interpretation for structure 377a (MSNovelist) and 377b (database).</p></caption><graphic xlink:href="41592_2022_1486_Fig3_HTML" id="d32e783"/></fig></p>
    <p id="Par19">We inspected in depth the seven cases that had the largest difference between the de novo and database-based modified Platt scores. A detailed discussion of the results is provided in Supplementary Tables <xref rid="MOESM1" ref-type="media">5</xref>–<xref rid="MOESM1" ref-type="media">13</xref>. For the example of feature 377 (mass-to-charge rati (<italic>m/z</italic>) 381.1020, C<sub>21</sub>H<sub>16</sub>O<sub>7</sub>), the de novo-predicted structure 377a is a polyphenolic compound with a flavonoid core (Fig. <xref rid="Fig3" ref-type="fig">3c</xref>) and all observed fragments (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>) are consistent with the proposed structure (Supplementary Fig. <xref rid="MOESM1" ref-type="media">7</xref>). Fragment 153 and neutral loss 126 (fragment 255) are shared with the flavonoid hesperetin. Seven peaks are shared with the structurally similar chrysin-7-O-glucuronide and all matching peaks relate to the aglycon. In contrast, the best database candidate fails to explain peaks 153 and 179. The structure predicted de novo is similar to known natural products formosumone A and struthiolanone. The biosynthetic origin of a C<sub>21</sub> polyphenol remains unclear, but we hypothesize that it could arise from a condensation as in the case of struthiolanone<sup><xref ref-type="bibr" rid="CR34">34</xref></sup>. We noted that multiple alternative de novo structures also strongly outscored the best database suggestion and are compatible with the observed spectrum. In any case, there is solid evidence that feature 377 is a novel natural product with a flavonoid core and an interesting candidate for further structure and biosynthetic pathway elucidation.</p>
    <p id="Par20">Summarizing the in-depth analysis of the seven spectra, in four cases the MSNovelist was better at explaining the MS<sup>2</sup> spectrum, and one is equally good as the top database candidate. This witnesses the complementarity of the two approaches. We initially limited the analysis to <italic>m/z</italic> &lt; 500, but could find five additional instances above threshold analyzing the entire dataset (Supplementary Fig<xref rid="MOESM1" ref-type="media">. 8</xref> and Supplementary Table <xref rid="MOESM1" ref-type="media">5</xref>). Regardless of the origin, all proposed top structures should be seen as starting points for further investigation. These could entail further analyses with more fine-grained MS<sup>n</sup> data, alternative dissociation techniques, or preparative isolation and characterization by nuclear magnetic resonance. Eventually, pure standards would have to be synthesized and analyzed by identical means to validate predictions.</p>
  </sec>
  <sec id="Sec6" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par21">MSNovelist demonstrates that de novo generation of molecular structure from MS<sup>2</sup> spectra without dependency on a structural database is possible. This result challenges the paradigm that the complexity of small-molecule chemical space precludes these approaches. MSNovelist constitutes the first direct application of a chemical generative model to mass spectrometry data. While deep learning models have previously been used to generate candidate libraries to use with independent methods for structure identification by MS<sup>2</sup> (refs. <sup><xref ref-type="bibr" rid="CR25">25</xref>,<xref ref-type="bibr" rid="CR26">26</xref></sup>), MSNovelist is capable of integrating the structural information encoded in probabilistic fingerprints. Given that certain isomers fragment (almost) indistinguishably, structural elucidation from this data is clearly not possible in all cases; yet, MSNovelist suggested reasonable molecular structures for more than half of the MS<sup>2</sup> spectra.</p>
    <p id="Par22">Three aspects made this achievement possible. First, structural fingerprint predictions from MS<sup>2</sup> spectra (by CSI:FingerID) directly encode structural information and may act as a blueprint for a molecule. Second, we decoupled MS<sup>2</sup> interpretation from structure generation, allowing us to train the generative model with millions of structures<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> and independently from experimental MS<sup>2</sup> data. Third, we exploited the analogy between writing a SMILES code based on a chemical fingerprint and image captioning, that is, writing a descriptive sentence based on a feature vector. In this context, de novo structure elucidation is interpreted as a translation-like task from fingerprint to structure. Trained in this manner, the model works independently of preexisting scores for spectrum-to-structure matching; although we acknowledge that final re-ranking with the modified Platt score is important for best results.</p>
    <p id="Par23">De novo annotation could alternatively be treated directly as an optimization task with a preexisting scoring function; that is, candidate structures can be obtained by traversing the latent space in a generative model or with reinforcement learning on the score. This would not require input directly informative about structure (such as fingerprints), and would therefore work with any spectrum–structure score, such as match to simulated MS<sup>2</sup> spectra using CFM-ID<sup><xref ref-type="bibr" rid="CR5">5</xref></sup> or any other score used by database search approaches. It would also allow the integration of orthogonal information, most trivially, retention time prediction.</p>
    <p id="Par24">From the point of view of chemical generative models, the task to generate structures compatible with a fingerprint resembles Tanimoto and Rediscovery benchmarks (for example, ref. <sup><xref ref-type="bibr" rid="CR24">24</xref></sup>), for which strong results have been achieved with existing models. It was, however, unclear whether the probabilistic predicted fingerprint input would provide constraints narrow enough to enable structure elucidation. We showed that our model retrieves a large proportion of correct hits, as well as additional incorrect structures that score highly in the database search. Further, incorrect high-scoring structures were highly similar to the correct answers, both anecdotally and by objective metric. Given how vast we usually perceive small-molecule chemical space to be<sup><xref ref-type="bibr" rid="CR35">35</xref></sup>, our results appear better than naïvely expected. Further, a notable part of results could be rediscovered even by isomer sampling, without structural fingerprint input. This indicates that the chemical space described with the present model and training set is comparably well confined. This might limit the model’s ability to discover chemistry extremely different from known molecules. Even with this ‘conservative’ model of chemical space, we were able to predict plausible novel molecules in biological datasets. Finally, generative models using robust SMILES alternatives<sup><xref ref-type="bibr" rid="CR36">36</xref>,<xref ref-type="bibr" rid="CR37">37</xref></sup> and non-SMILES representations<sup><xref ref-type="bibr" rid="CR38">38</xref>–<xref ref-type="bibr" rid="CR41">41</xref></sup> could provide avenues for further exploration and development, although even the simple SMILES model achieved convincing performance in our setting.</p>
    <p id="Par25">The MSNovelist method specifically addresses the task of structure generation, and relies on existing methods (or external knowledge) for molecular formula determination. For small compounds with <italic>m/z</italic> &lt; 300, error rates of formula determination by SIRIUS are &lt;10%; however, they increase to &gt;50% for compounds with <italic>m/z</italic> up to 800 when considering individual spectra. However, when considering all spectra in a biological sample jointly, error rates of &lt;10% up to <italic>m/z</italic> 800 can be achieved<sup><xref ref-type="bibr" rid="CR42">42</xref></sup>; this is recommended to achieve best results with biological datasets. Alternatively, if the molecular formula is known through orthogonal information, the SIRIUS formula prediction may be bypassed and the formula provided directly. Finally, to address practical limitations, MSNovelist is currently only trained for positive-mode data. CSI:FingerID performance is slightly lower on negative-mode MS<sup>2</sup> spectra; this will be likely reflected in MSNovelist performance in the future. Also, CSI:FingerID and correspondingly MSNovelist processes MS2 spectra with a minimum of three fragment ions; richer spectra are desirable for best performance.</p>
    <p id="Par26">In conclusion, this work contributes a further building block to the growing set of methods for untargeted computational mass spectrometry. It complements recent methods by Dührkop et al.: CANOPUS<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> predicts compound classes for unknown spectra, which can provide biological insight at substance-class level without requiring complete structures, whereas COSMIC<sup><xref ref-type="bibr" rid="CR43">43</xref></sup> aims to increase confidence when annotating compounds in compound databases but not spectral libraries. In contrast, MSNovelist focuses on proposing structures for compounds not in compound databases. Complementary application of MSNovelist and CANOPUS may provide even more information as a starting point for elucidation of specific unknowns.</p>
  </sec>
  <sec id="Sec7">
    <title>Methods</title>
    <sec id="Sec8">
      <title>RNN model architecture</title>
      <p id="Par27">The encoder consists of three hidden layers and yields a real-valued vector <bold>z</bold>, which we consider the latent representation of the molecule (Supplementary Fig. <xref rid="MOESM1" ref-type="media">1</xref>). Vector <bold>z</bold> is further transformed via a single layer to starting state vectors <bold>s</bold><sup>Dec</sup> for the decoder. The decoder is a three-layer long short-term memory (LSTM) RNN<sup><xref ref-type="bibr" rid="CR44">44</xref></sup>, which for any position <italic>i</italic> in a SMILES sequence, predicts probabilities for SMILES character <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{y}_i^S$$\end{document}</tex-math><mml:math id="M4"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq2.gif"/></alternatives></inline-formula> and state <inline-formula id="IEq3"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\bf s}_i^\mathrm{Dec}$$\end{document}</tex-math><mml:math id="M6"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Dec</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq3.gif"/></alternatives></inline-formula> from an input of the previous character <inline-formula id="IEq4"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{y}_{i - 1}^S$$\end{document}</tex-math><mml:math id="M8"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq4.gif"/></alternatives></inline-formula>, the preceding state <inline-formula id="IEq5"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\bf s}_{i - 1}^\mathrm{Dec}$$\end{document}</tex-math><mml:math id="M10"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Dec</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq5.gif"/></alternatives></inline-formula>, and the context vector <bold>z</bold>. This basic decoder model can be extended with additional information from an augmented feature vector <italic>v</italic><sub><italic>i</italic></sub> to increase performance. Vector <italic>v</italic><sub><italic>i</italic></sub> contains the running count of remaining atoms per chemical element, that is, the atom count in <bold>x</bold><sup><italic>M</italic></sup> minus the sum of atoms of this element in the partial sequence up to <italic>y</italic><sub><italic>i</italic></sub>, and the number of open brackets, that is, the count of open minus closing brackets in the partial sequence. This auxiliary vector aids the generation of syntactically correct SMILES, and molecules of a particular formula, because sequence termination is contingent on |<italic>v</italic><sub><italic>i</italic></sub>| = 0 in the training set. Vector <bold>v</bold><sub><italic>i</italic></sub> is directly given from the SMILES sequence for heavy atoms, whereas the number of hydrogen atoms is not directly evident in a partial SMILES. To this end, an auxiliary two-layer LSTM predicts a sequence of hydrogen atom counts per SMILES character, trained such that their sum matches the total hydrogen count in the molecule. For sequence prediction, <bold>x</bold><sup><italic>F</italic></sup> and <bold>x</bold><sup><italic>M</italic></sup> are encoded into <bold>z</bold> and <inline-formula id="IEq6"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\bf s}_0^\mathrm{Dec}$$\end{document}</tex-math><mml:math id="M12"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Dec</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq6.gif"/></alternatives></inline-formula>, and the top-<italic>k</italic> sequences are decoded via beam search. For every query tuple (<bold>x</bold><sup><italic>F</italic></sup>, <bold>x</bold><sup><italic>M</italic></sup>), the model returns <italic>k</italic>′ ≤ <italic>k</italic> valid structures <inline-formula id="IEq7"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$S^{\left( {1..k^\prime } \right)}$$\end{document}</tex-math><mml:math id="M14"><mml:msup><mml:mrow><mml:mi>S</mml:mi></mml:mrow><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:msup><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq7.gif"/></alternatives></inline-formula>, with the corresponding probability under the model (RNN score). To find the structure with the best match to the query fingerprint, the structures are re-ranked by the modified Platt score<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, which measures the match between the input fingerprint (predicted by SIRIUS) and the deterministic fingerprint of each <italic>k</italic>′ candidate structure.</p>
    </sec>
    <sec id="Sec9">
      <title>Definitions</title>
      <p id="Par28">We refer to deterministically calculated structural fingerprints for a molecule as structural fingerprints (struct-FP), and to fingerprints predicted from an MS<sup>2</sup> spectrum with CSI:FingerID as spectrum fingerprints (spec-FP). Fingerprints that were predicted with CSI:FingerID in a tenfold structure–disjoint cross-validation setup are called cross-validated spectrum fingerprints (CV-spec-FP). Fingerprints generated by perturbation from struct-FP to simulate spec-FP are called simulated fingerprints (sim-FP).</p>
      <p id="Par29">We denote ‘Dense<sup>&lt;<italic>n</italic>&gt;</sup>’ a dense, fully connected layer with <italic>n</italic> units and linear activation. We denote <inline-formula id="IEq8"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{Dense}}_{{\mathrm{ReLU}}}^{ &lt; n &gt; }$$\end{document}</tex-math><mml:math id="M16"><mml:msubsup><mml:mrow><mml:mi mathvariant="normal">Dense</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">ReLU</mml:mi></mml:mrow><mml:mrow><mml:mo>&lt;</mml:mo><mml:mi>n</mml:mi><mml:mo>&gt;</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq8.gif"/></alternatives></inline-formula> a corresponding layer with the activation function <inline-formula id="IEq9"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{ReLU}}\left( x \right) = {\mathrm{max}}\left( {0,x} \right)$$\end{document}</tex-math><mml:math id="M18"><mml:mrow><mml:mi mathvariant="normal">ReLU</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mi mathvariant="normal">max</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq9.gif"/></alternatives></inline-formula>. We denote LSTM<sup>&lt;<italic>n,m</italic>&gt;</sup> an LSTM RNN with <italic>n</italic> layers and <italic>m</italic> units per layer as described by Hochreiter and Schmidhuber<sup><xref ref-type="bibr" rid="CR44">44</xref></sup> and implemented in Keras/Tensorflow, with <italic>tanh</italic> activation, sigmoid recurrent activation and no dropout.</p>
      <p id="Par30">We denote ‘Counter<sub><italic>M</italic></sub>’ the (recurrent) countdown function<disp-formula id="Equa"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{Counter}}_M\left( {{\bf x}_i,{\bf v}_{i - 1}} \right) = {\bf v}_{i - 1} - M \times {\bf x}_i$$\end{document}</tex-math><mml:math id="M20"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">Counter</mml:mi></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">v</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">v</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mi>M</mml:mi><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><graphic xlink:href="41592_2022_1486_Article_Equa.gif" position="anchor"/></alternatives></disp-formula>with a starting state <inline-formula id="IEq10"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\bf v}_0 \in \mathbb{R}^n$$\end{document}</tex-math><mml:math id="M22"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">v</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:msup><mml:mrow><mml:mo>∈</mml:mo><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq10.gif"/></alternatives></inline-formula> and a (constant, non-trainable) matrix <inline-formula id="IEq11"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$M \in \mathbb{R}^{n,{\mathrm{dim}}\left( \mathbf{x} \right)}$$\end{document}</tex-math><mml:math id="M24"><mml:mrow><mml:mi>M</mml:mi><mml:msup><mml:mrow><mml:mo>∈</mml:mo><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="normal">dim</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq11.gif"/></alternatives></inline-formula>. Typically <inline-formula id="IEq12"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$M \in \left\{ {1,0, - 1} \right\}^{n,{\mathrm{dim}}\left( {\bf x} \right)}$$\end{document}</tex-math><mml:math id="M26"><mml:mrow><mml:mi>M</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mfenced close="}" open="{"><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="normal">dim</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq12.gif"/></alternatives></inline-formula>.</p>
      <p id="Par31">We denote ‘BatchNorm<sub><italic>θ</italic></sub>’ as the batch normalization function as implemented in Keras/Tensorflow:<disp-formula id="Equb"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{BatchNorm}}_\theta \left( {x_i} \right) = \left( {\gamma _{i,\theta} \left( {x_i - \underline{x} _i} \right)/\sqrt {{\mathrm{var}}(x_i) + {\it{\epsilon }}} } \right) + \beta _{i,\theta}$$\end{document}</tex-math><mml:math id="M28"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">BatchNorm</mml:mi></mml:mrow><mml:mrow><mml:mi>θ</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>γ</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:munder accentunder="true"><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="true">_</mml:mo></mml:mrow></mml:munder></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>/</mml:mo><mml:msqrt><mml:mrow><mml:mi mathvariant="normal">var</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mi>ϵ</mml:mi></mml:mrow></mml:msqrt></mml:mrow></mml:mfenced><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi>β</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><graphic xlink:href="41592_2022_1486_Article_Equb.gif" position="anchor"/></alternatives></disp-formula>for an input vector <bold>x</bold> with elements <inline-formula id="IEq13"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$x_1\,..x_n$$\end{document}</tex-math><mml:math id="M30"><mml:mrow><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mspace width="0.25em"/><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq13.gif"/></alternatives></inline-formula>. During training, <inline-formula id="IEq14"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\underline x _i$$\end{document}</tex-math><mml:math id="M32"><mml:msub><mml:mrow><mml:munder accentunder="true"><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="true">_</mml:mo></mml:mrow></mml:munder></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq14.gif"/></alternatives></inline-formula> is the batch mean and var(<italic>x</italic><sub><italic>i</italic></sub>) is the batch variance, and, during inference, <inline-formula id="IEq15"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\underline x _i$$\end{document}</tex-math><mml:math id="M34"><mml:msub><mml:mrow><mml:munder accentunder="true"><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="true">_</mml:mo></mml:mrow></mml:munder></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq15.gif"/></alternatives></inline-formula> and var(<italic>x</italic><sub><italic>i</italic></sub>) are the moving mean and variance obtained during training, respectively. <italic>γ</italic><sub><italic>θ</italic></sub> and <italic>β</italic><sub><italic>θ</italic></sub> are learned during training, and <inline-formula id="IEq16"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\it{\epsilon }}$$\end{document}</tex-math><mml:math id="M36"><mml:mi>ϵ</mml:mi></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq16.gif"/></alternatives></inline-formula> is set to 0.001. In summary, BatchNorm<sub><italic>θ</italic></sub> normalizes each batch to mean and variance of 0 and 1 per channel during training, and each sample to an approximate overall mean/variance during inference.</p>
    </sec>
    <sec id="Sec10">
      <title>Dataset and data preprocessing</title>
      <p id="Par32">A training set for the LSTM RNN was composed from the databases HMDB (4.0)<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>, COCONUT<sup><xref ref-type="bibr" rid="CR30">30</xref></sup> and DSSTox<sup><xref ref-type="bibr" rid="CR31">31</xref></sup>. The training set was filtered to remove molecules that couldn’t be parsed with RDKit, SMILES codes longer than 127 characters, disconnected SMILES codes (containing a dot), molecular weight larger than 1,000 Da, a formal charge, more than seven rings (as specified in SMILES) or elements other than C, H, N, O, P, S, Br, Cl, I and F. All structures contained in the CV-spec-FP dataset (see below) were removed from the training set. Finally, the training set contained 1,232,184 molecules with 1,048,512 distinct structures (by InChIKey2D), and was split into ten structure–disjoint folds.</p>
      <p id="Par33">For the generation of sim-FP (see below) and model evaluation, a dataset of 14,047 CV-spec-FP was obtained, corresponding to the openly available part of the CANOPUS<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> evaluation data, the GNPS dataset and the CASMI dataset. The CV-spec-FP dataset was split into ten structure–disjoint folds, and (arbitrarily) matched to onefold in the training set. All structures present in the CASMI dataset were assigned to the same fold, such that the dataset is completely unknown to the corresponding model.</p>
      <p id="Par34">All molecules in input data were initially retrieved as SMILES code or InChI code. For every molecule, a SMILES string standardized with the PubChem standardization service was retrieved. Using RDKit, the structure was parsed, the InChIKey was generated, and the first 14 characters (a hash describing atom connectivity ignoring stereochemistry and charge, ‘InChIKey2D’) was extracted. For every unique InChIKey2D, a PubChem-standardized SMILES string<sup><xref ref-type="bibr" rid="CR45">45</xref></sup> was retrieved, from which stereochemical information was removed using regular expressions. The resulting stereochemistry-free SMILES code was processed in Java using the CDK toolkit (version 2.3) and SIRIUS libraries (version 1.4.3-SNAPSHOT at the time of writing) to obtain an aromatic canonical SMILES code and a &gt;8,000-bit struct-FP as described elsewhere containing CDK substructure fingerprints, PubChem fingerprints, Klekota–Roth fingerprints<sup><xref ref-type="bibr" rid="CR46">46</xref></sup>, FP3 fingerprints, MACCS fingerprints, ECFP6 topological fingerprints<sup><xref ref-type="bibr" rid="CR47">47</xref></sup> and custom rules for larger substructures<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>. The aromatic canonical SMILES code was parsed with the toolkit RDKit, and the molecular formula extracted. The struct-FP, SMILES code and molecular formula were stored in a database, or in a CSV-formatted text file. For the CV-spec-FP dataset, the CV-spec-FP was additionally stored. The multiple-kernel SVM method used by SIRIUS predicts (at the time of writing) 3,609 bits from the &gt;8,000-bit struct-FP; in the following, the struct-FP shall denote only these 3,609 bits, and FP(<italic>S</italic>) shall denote the function that calculates the 3,609-bit struct-FP for a chemical structure <italic>S</italic>.</p>
    </sec>
    <sec id="Sec11">
      <title>Input processing and encoding</title>
      <p id="Par35">While deterministic struct-FP by definition perfectly represent the chemical features of their corresponding molecules, spec-FP are statistical predictions and contain error. To train the model for use with such error-affected data, error-affected sim-FP were generated from struct-FP. For training, sim-FP were generated on the fly (during training) from struct-FP by random sampling from the CV-spec-FP dataset (minus the current training fold), using a procedure similar to the description in Dührkop et al.<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> (‘first method’; Supplementary Algorithm <xref rid="MOESM1" ref-type="media">1</xref>).</p>
      <p id="Par36">More precisely, <inline-formula id="IEq17"><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{x}_{{\mathrm{spec}}_i}^ \ast + {\mathrm{jitter}}$$\end{document}</tex-math><mml:math id="M38"><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">spec</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msubsup><mml:mo>+</mml:mo><mml:mi mathvariant="normal">jitter</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq17.gif"/></alternatives></inline-formula> is pseudocode for adding a random number from <inline-formula id="IEq18"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left( {\left. {{\mathrm{uniform}}\left( {0,1} \right) - 0.5} \right)} \right) \times {\mathrm{noisefactor}}$$\end{document}</tex-math><mml:math id="M40"><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mfenced close=")"><mml:mrow><mml:mi mathvariant="normal">uniform</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfenced><mml:mo>−</mml:mo><mml:mn>0.5</mml:mn></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>×</mml:mo><mml:mi mathvariant="normal">noisefactor</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq18.gif"/></alternatives></inline-formula> to <inline-formula id="IEq19"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{x}_{{\mathrm{spec}}_i}^ \ast$$\end{document}</tex-math><mml:math id="M42"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">spec</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq19.gif"/></alternatives></inline-formula> and subsequently clipping the results batchwise to the original range of the bit.</p>
      <p id="Par37">The sim-FP were either used verbatim (probabilistic input) or rounded to 0 or 1 (discrete input). In the final model, discrete input was used for both training and prediction because it led to superior results in correct structure retrieval. For evaluation and in inference mode, spec-FP were also correspondingly rounded.</p>
      <p id="Par38">Additionally, a method based on correlated sampling (similar to ‘second method’; Dührkop et al.<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>) was implemented, which takes into account correlations between fingerprint bits. However, the method led to identical results in correct structure retrieval; therefore, the simpler method was further used.</p>
      <p id="Par39">The molecular formula was encoded as a vector <inline-formula id="IEq20"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{x}^M \in \mathbb{N}^m$$\end{document}</tex-math><mml:math id="M44"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mo>∈</mml:mo><mml:mi mathvariant="double-struck">N</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq20.gif"/></alternatives></inline-formula> for the <italic>m</italic> = 10 elements <inline-formula id="IEq21"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$E \in {\mathrm{C,F,I,Cl,N,O,P,Br,S,H}}$$\end{document}</tex-math><mml:math id="M46"><mml:mrow><mml:mi>E</mml:mi><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">C,F,I,Cl,N,O,P,Br,S,H</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq21.gif"/></alternatives></inline-formula> (with <inline-formula id="IEq22"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$x_i^M$$\end{document}</tex-math><mml:math id="M48"><mml:msubsup><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq22.gif"/></alternatives></inline-formula> denoting the sum of atoms of element <italic>E</italic><sub><italic>i</italic></sub> in the molecule). We denote MF(<italic>S</italic>) the function returning the molecular formula for a structure <italic>S</italic>.</p>
      <p id="Par40">The aromatic canonical SMILES codes were split into tokens consisting of a single character (for example, C,c, =, N,3), the two-letter elements Br and Cl substituted as R and L, or a sequence of characters delimited by square brackets (for example, [nH], [N+]), denoting special environments. <italic>t</italic> = 36 tokens occurring &gt;100 times in the training set were retained, the remaining tokens (20 tokens with a total of &lt;2,000 occurrences) were discarded and ignored. All token sequences were prefixed with a start token ($), postfixed with a final token (*) and padded to a fixed length of <italic>l</italic> = 128 with a pad token (&amp;). The sequences <bold>s</bold> were then transformed to a one-hot encoded matrix <inline-formula id="IEq23"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$Y^S \in \left\{ {0,1} \right\}^{\left( {l,t} \right)}$$\end{document}</tex-math><mml:math id="M50"><mml:mrow><mml:msup><mml:mrow><mml:mi>Y</mml:mi></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mfenced close="}" open="{"><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi>l</mml:mi><mml:mo>,</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq23.gif"/></alternatives></inline-formula> (such that <inline-formula id="IEq24"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$Y_{i,j}^S = 1 \Leftrightarrow s_i = j$$\end{document}</tex-math><mml:math id="M52"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>Y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>⇔</mml:mo><mml:msub><mml:mrow><mml:mi>s</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq24.gif"/></alternatives></inline-formula>) with column vectors <inline-formula id="IEq25"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{y}_i^S$$\end{document}</tex-math><mml:math id="M54"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq25.gif"/></alternatives></inline-formula>.</p>
    </sec>
    <sec id="Sec12">
      <title>Data augmentation: element count and grammar balance</title>
      <p id="Par41">For promoting the formation of correct SMILES and the correct chemical formula, the input vector was augmented with a counter <bold>v</bold><sub><italic>i</italic></sub>. This vector counted the remaining atoms for each element, and open parentheses in the current sequence, starting from the molecular formula <bold>x</bold><sup><italic>M</italic></sup> (and zero open brackets) as the initial state. Formally,<disp-formula id="Equc"><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{v}_i = {{{\mathrm{Hint}}}}\left( {\mathbf{y}_i^S,y_i^H,\mathbf{v}_{i - 1},\mathbf{x}^M} \right) = \left\{ {\begin{array}{*{20}{c}} {{\mathrm{Counter}}_M\left( {{\mathrm{Concatenate}}\left( {\mathbf{y}_i^S,y_i^H } \right)},\mathbf{v}_{i - 1} \right),} &amp; {i &gt; 0} \\ {{\mathrm{Concatenate}}\left( {\mathbf{x}^M,0} \right),} &amp; {i = 0} \end{array}} \right.$$\end{document}</tex-math><mml:math id="M56"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">v</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi mathvariant="normal">Hint</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">v</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mfenced open="{"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:msub><mml:mrow><mml:mi mathvariant="normal">Counter</mml:mi></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="normal">Concatenate</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">v</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mtd><mml:mtd columnalign="center"><mml:mi>i</mml:mi><mml:mo>&gt;</mml:mo><mml:mn>0</mml:mn></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi mathvariant="normal">Concatenate</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mtd><mml:mtd columnalign="center"><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:mrow></mml:math><graphic xlink:href="41592_2022_1486_Article_Equc.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par42">The counter matrix <italic>M</italic> consisted of an upper part mapping input tokens, a row mapping the predicted implicit hydrogen count to the hydrogen element, and a row mapping tokens (,) to 1,−1, respectively:<table-wrap id="Taba"><table frame="hsides" rules="groups"><tbody><tr><td rowspan="2" colspan="2"/><td colspan="11">(tokens)</td></tr><tr><td>C</td><td>c</td><td>[C−]</td><td>N</td><td>n</td><td>[nH]</td><td>...</td><td>(</td><td>)</td><td>‘H’</td><td/></tr><tr><td rowspan="5"><italic>M</italic> =</td><td>C</td><td>1</td><td>1</td><td>1</td><td>0</td><td>0</td><td>0</td><td/><td>0</td><td>0</td><td>0</td><td rowspan="3">(elements)</td></tr><tr><td>N</td><td>0</td><td>0</td><td>0</td><td>1</td><td>1</td><td>1</td><td/><td>0</td><td>0</td><td>0</td></tr><tr><td>…</td><td/><td/><td/><td/><td/><td/><td/><td/><td/><td/></tr><tr><td>H</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td/><td>0</td><td>0</td><td>1</td><td>(implicit H)</td></tr><tr><td>()</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td/><td>−1</td><td>1</td><td>0</td><td>(parentheses)</td></tr></tbody></table></table-wrap></p>
    </sec>
    <sec id="Sec13">
      <title>Data augmentation: hydrogen count estimation</title>
      <p id="Par43">As opposed to heavy atom counts, which are directly specified by tokens in the SMILES sequence, hydrogens are implicitly described, and assigned after constructing the molecular graph. For use in data augmentation (see above), we estimated implicit hydrogens for every token in a partial SMILES sequence from the sequence context. We trained an LSTM network with parameters <italic>ϕ</italic><disp-formula id="Equd"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat y^H_i,\mathbf{s}_{i + 1}^{\mathrm{Hcount}} = \mathrm{Hcount}_\phi \left( {y^S_i,\mathbf{s}_i^{\mathrm{Hcount}};\phi } \right): = {\mathrm{Dense}}_\phi ^{ &lt; 1 &gt; } \circ {\mathrm{LSTM}}_\phi ^{ &lt; 32,2 &gt; }\left( \ldots \right)$$\end{document}</tex-math><mml:math id="M58"><mml:mrow><mml:msubsup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Hcount</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">Hcount</mml:mi></mml:mrow><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Hcount</mml:mi></mml:mrow></mml:msubsup><mml:mo>;</mml:mo><mml:mi>ϕ</mml:mi></mml:mrow></mml:mfenced><mml:mo>:</mml:mo><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="normal">Dense</mml:mi></mml:mrow><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mo>&lt;</mml:mo><mml:mn>1</mml:mn><mml:mo>&gt;</mml:mo></mml:mrow></mml:msubsup><mml:mo>∘</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="normal">LSTM</mml:mi></mml:mrow><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mo>&lt;</mml:mo><mml:mn>32</mml:mn><mml:mo>,</mml:mo><mml:mn>2</mml:mn><mml:mo>&gt;</mml:mo></mml:mrow></mml:msubsup><mml:mfenced close=")" open="("><mml:mrow><mml:mo>…</mml:mo></mml:mrow></mml:mfenced></mml:mrow></mml:math><graphic xlink:href="41592_2022_1486_Article_Equd.gif" position="anchor"/></alternatives></disp-formula>where the output <inline-formula id="IEq26"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$y_i^H$$\end{document}</tex-math><mml:math id="M60"><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq26.gif"/></alternatives></inline-formula> is the estimated hydrogen count for token <italic>i</italic>. Instead of deriving the hydrogen count per sequence element from actual molecular graphs for training, we summed <inline-formula id="IEq27"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$y_{{\mathrm{tot}}}^H = \mathop {\sum}\nolimits_i {y_i^H}$$\end{document}</tex-math><mml:math id="M62"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">tot</mml:mi></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq27.gif"/></alternatives></inline-formula> and minimized the loss <inline-formula id="IEq28"><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$L_\phi = \left( {\hat y^H_{{\mathrm{tot}}} - y_{{\mathrm{tot}}}^H} \right)^2$$\end{document}</tex-math><mml:math id="M64"><mml:mrow><mml:msub><mml:mrow><mml:mi>L</mml:mi></mml:mrow><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="normal">tot</mml:mi></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup><mml:mo>−</mml:mo><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">tot</mml:mi></mml:mrow><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq28.gif"/></alternatives></inline-formula>, such that the sum of hydrogens assigned to each sequence element (ignoring termination and padding tokens) matches the total count in the molecule given by <italic>x</italic><sup><italic>M</italic></sup>. Hcount is trained concomitantly, but separately from the remaining network (no gradients propagate through <italic>y</italic><sup><italic>H</italic></sup>). We note that because only left-hand context is available, ‘hydrogen equivalents’ can be positive or negative numbers (for example, a branch opening may contribute a negative hydrogen).</p>
    </sec>
    <sec id="Sec14">
      <title>Fingerprint encoder and sequence decoder</title>
      <p id="Par44">The encoder block <inline-formula id="IEq29"><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{Enc}}\left( {\mathbf{x}^F,\mathbf{x}^M;\theta } \right)$$\end{document}</tex-math><mml:math id="M66"><mml:mrow><mml:mi mathvariant="normal">Enc</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:msup><mml:mo>;</mml:mo><mml:mi>θ</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq29.gif"/></alternatives></inline-formula> consists of a batch normalization layer and two dense layers (512 and 256 units, respectively; ReLU activation) to compute a latent code <bold>z</bold> from the concatenation of inputs <bold>x</bold><sup><italic>F</italic></sup> and <bold>x</bold><sup><italic>M</italic></sup>, and a dense layer (2*3*256 units, linear activation) to compute 2*3 initial states <inline-formula id="IEq30"><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{s}_0^{{\mathrm{Dec}}}$$\end{document}</tex-math><mml:math id="M68"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Dec</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq30.gif"/></alternatives></inline-formula> for three LSTM layers of 256 units each from the latent code <bold>z</bold>.</p>
      <p id="Par45">Similar to related work, the decoder was implemented as an LSTM with three layers of 256 units per layer and a final dense layer with the number of output tokens. The input to the LSTM consists of the context vector <bold>z</bold> (constant over the sequence), the preceding sequence token <inline-formula id="IEq31"><alternatives><tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{y}_i^S$$\end{document}</tex-math><mml:math id="M70"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq31.gif"/></alternatives></inline-formula>, the molecule target vector <bold>v</bold><sub><italic>i</italic></sub> and the LSTM state <inline-formula id="IEq32"><alternatives><tex-math id="M71">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{s}_i^{{\mathrm{Dec}}}$$\end{document}</tex-math><mml:math id="M72"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Dec</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq32.gif"/></alternatives></inline-formula>:<disp-formula id="Eque"><alternatives><tex-math id="M73">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{array}{*{20}{l}} {\mathbf{v}^{in}} \hfill &amp; = \hfill &amp; {{\mathrm{BatchNorm}}_\theta \circ {\mathrm{Concatenate}}\left( {\mathbf{y}_i^S,\mathbf{v}_i,\mathbf{z}} \right)} \hfill \\ {\hat P\left( {\mathbf{y}_{i + 1}^S} \right),\mathbf{s}^{{\mathrm{Dec}}}_{i + 1}} \hfill &amp; {: = } \hfill &amp; {{\mathrm{Dec}}\left( {\mathbf{v}^{in},\mathbf{s}_i^{{\mathrm{Dec}}};\theta } \right)} \hfill \\ {} \hfill &amp; = \hfill &amp; {{\mathrm{Softmax}} \circ {\mathrm{Dense}}_\theta ^{\langle t\rangle } \circ {\mathrm{LSTM}}_\theta ^{\langle 256,3\rangle }( \ldots )} \hfill \end{array}$$\end{document}</tex-math><mml:math id="M74"><mml:mtable><mml:mtr><mml:mtd columnalign="left"><mml:msup><mml:mrow><mml:mi mathvariant="bold">v</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:mtd><mml:mtd columnalign="left"><mml:mo>=</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:msub><mml:mrow><mml:mi mathvariant="normal">BatchNorm</mml:mi></mml:mrow><mml:mrow><mml:mi>θ</mml:mi></mml:mrow></mml:msub><mml:mo>∘</mml:mo><mml:mi mathvariant="normal">Concatenate</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">v</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi mathvariant="bold">z</mml:mi></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mover accent="true"><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Dec</mml:mi></mml:mrow></mml:msubsup></mml:mtd><mml:mtd columnalign="left"><mml:mo>:</mml:mo><mml:mo>=</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:mi mathvariant="normal">Dec</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">v</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>n</mml:mi></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Dec</mml:mi></mml:mrow></mml:msubsup><mml:mo>;</mml:mo><mml:mi>θ</mml:mi></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"/><mml:mtd columnalign="left"><mml:mo>=</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:mi mathvariant="normal">Softmax</mml:mi><mml:mo>∘</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="normal">Dense</mml:mi></mml:mrow><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mo>⟨</mml:mo><mml:mi>t</mml:mi><mml:mo>⟩</mml:mo></mml:mrow></mml:msubsup><mml:mo>∘</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="normal">LSTM</mml:mi></mml:mrow><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mo>⟨</mml:mo><mml:mn>256</mml:mn><mml:mo>,</mml:mo><mml:mn>3</mml:mn><mml:mo>⟩</mml:mo></mml:mrow></mml:msubsup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mo>…</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:math><graphic xlink:href="41592_2022_1486_Article_Eque.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par46">Parameters <italic>θ</italic> (for Enc,Dec) and <italic>ϕ</italic> (for Hcount) were found (in parallel, but independently) through training in teacher-forcing manner<sup><xref ref-type="bibr" rid="CR48">48</xref></sup> to minimize the categorical cross entropy loss.</p>
      <p id="Par47">As in common image captioning models<sup><xref ref-type="bibr" rid="CR49">49</xref></sup>, the latent space is not explicitly regularized; the translation task (from fingerprint features to SMILES representation) is expected to be a bona fide regularizer, given a small enough latent space. In variational inference, (over)regularized models with complex decoders (particularly when trained with teacher forcing) tend to ignore latent code<sup><xref ref-type="bibr" rid="CR50">50</xref>,<xref ref-type="bibr" rid="CR51">51</xref></sup>. This may be acceptable in tasks where a higher diversity of results is desired. However, the present task requires decoding to be as precise as possible. Multiple regularized models were additionally examined: for example, a VAE-like model regularized with Kullback–Leibler divergence (KL-VAE) or with the more information-preserving maximum mean divergence (MMD-VAE); and a model regularized by imposing the additional objective of reconstructing the true structural fingerprint of a compound from a spectrum-predicted fingerprint. All models with additional regularization performed worse than the base model.</p>
    </sec>
    <sec id="Sec15">
      <title>Implementation and training details</title>
      <p id="Par48">The model, evaluation code and Docker container was implemented in Keras/Tensorflow, version 2.4.1 on Python 3.7.10, with associated packages (<xref rid="MOESM2" ref-type="media">Reporting summary</xref>): matplotlib 3.3.4, pyteomics 4.4.1, rdkit 2020.09.1.0 and 2021.03.1, scipy 1.6.1, sqlite3 3.35.2, tqdm 4.59.0, dill 0.3.3, h5py 2.10.0, jpype1 1.2.1, numpy 1.19.2, pandas 1.2.3, requests 2.25.1, selfies 1.0.3, spectrum_utils 0.3.4, tensorflow 2.4.1, bitstring 3.1.7, chempy 0.8.0, pywebio 1.3.3, molmass 2020.6.10, pyyaml 5.4.1; based on Miniconda 4.10.3, with additional Java libraries BitToBoolean (edu.rutgers.sakai.java.util.BitToBoolean, no version) and ProgressBar (me.tongfei.progressbar 0.8.1), and the shell utility yq (4.9.6) Java code was compiled with Maven 3.7.0 for OpenJDK 11. The network was trained with stochastic gradient descent using the Adam optimizer<sup><xref ref-type="bibr" rid="CR52">52</xref></sup> with a learning rate of 0.001, <italic>β</italic><sub>100 </sub>= 0.9, <italic>β</italic><sub>2 </sub>= 0.999 and <inline-formula id="IEq33"><alternatives><tex-math id="M75">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\it{\epsilon }} = 10^{ - 7}$$\end{document}</tex-math><mml:math id="M76"><mml:mrow><mml:mi>ϵ</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:msup><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>7</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq33.gif"/></alternatives></inline-formula> over 30 epochs. Although the evaluation loss on sim-FP continued to minimally improve up to epoch 30, the evaluation performance of models did not improve or decrease meaningfully anymore after approximately 15 epochs. For evaluation, the weights after 20 epochs were used for all models. Because weights were only stored if the loss had improved over the last epoch, not all folds have a weight at epoch 20; in this case, the last preceding weight was used. The model was trained on an HPC cluster on a GPU node, using one dedicated Nvidia GTX 1080 or Nvidia GTX 1080 Ti GPU, five cores of a Xeon E5-2630v4 processor, and 80 GB RAM. Training time was approximately 45 min per epoch.</p>
    </sec>
    <sec id="Sec16">
      <title>Prediction</title>
      <p id="Par49">For sequence prediction from spec-FP, the latent code <bold>z</bold> and starting states <inline-formula id="IEq34"><alternatives><tex-math id="M77">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{s}_0^{{\mathrm{Dec}}}$$\end{document}</tex-math><mml:math id="M78"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Dec</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq34.gif"/></alternatives></inline-formula> were predicted with the encoder. For hydrogen prediction, <inline-formula id="IEq35"><alternatives><tex-math id="M79">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{s}_0^{\mathrm{Hcount}}$$\end{document}</tex-math><mml:math id="M80"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Hcount</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq35.gif"/></alternatives></inline-formula> was initialized with zeros; for formula/grammar hinting, <inline-formula id="IEq36"><alternatives><tex-math id="M81">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{v}_0 = {\mathrm{Concatenate}}\left( {\mathbf{x}^M,0} \right)$$\end{document}</tex-math><mml:math id="M82"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">v</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi mathvariant="normal">Concatenate</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi>M</mml:mi></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq36.gif"/></alternatives></inline-formula> as stated above. Given <bold>z</bold> and the combined initial state <inline-formula id="IEq37"><alternatives><tex-math id="M83">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{s}_0 = \left( {\mathbf{s}^{{\mathrm{Dec}}},\mathbf{s}^{{\mathrm{Hcount}}},\mathbf{v}} \right)_0$$\end{document}</tex-math><mml:math id="M84"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Dec</mml:mi></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">Hcount</mml:mi></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:mi mathvariant="bold">v</mml:mi></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq37.gif"/></alternatives></inline-formula>, a beam search with beam width typically <italic>k</italic> = 128 was performed with the decoder as described in Supplementary Algorithm <xref rid="MOESM1" ref-type="media">2</xref>, with argtop<sub><italic>k</italic></sub>(<bold>x</bold>) the positions of the top-<italic>k</italic> elements in vector <bold>x</bold>. In the implementation, the decoding is performed in parallel for multiple queries.</p>
      <p id="Par50">For evaluation, structure–disjoint cross-validation was used; that is, the model used for structure prediction for any CV-spec-FP was trained without any fingerprints for this structure in the CV-spec-FP dataset used for fingerprint simulation.</p>
      <p id="Par51">For ablation studies, stochastic decoding was additionally used. Here, <italic>k</italic> sequences are sampled independently. Starting with the initial token, and the given (deterministic) starting state, a token <italic>y</italic><sub><italic>i</italic>+1 </sub>= <italic>t</italic> is sampled according to its probability distribution <inline-formula id="IEq38"><alternatives><tex-math id="M85">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat P\left( {\mathbf{y}^S_{i + 1} = t} \right)$$\end{document}</tex-math><mml:math id="M86"><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq38.gif"/></alternatives></inline-formula>, until the termination token is sampled.</p>
    </sec>
    <sec id="Sec17">
      <title>Recurrent neural network score and modified Platt score</title>
      <p id="Par52">The RNN score is the (log) probability of a SMILES sequence under the RNN model, given the input. It is calculated by adding the log probabilities for each predicted token over the sequence:<disp-formula id="Equf"><alternatives><tex-math id="M87">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{RNN score}} = \mathop {\sum}\nolimits_i {\log \hat P\left( {y_i^S} \right)|y_{1..i - 1}^S}$$\end{document}</tex-math><mml:math id="M88"><mml:mrow><mml:mi mathvariant="normal">RNNscore</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mi>log</mml:mi><mml:mover accent="true"><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced><mml:mo>∣</mml:mo><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mi>i</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:math><graphic xlink:href="41592_2022_1486_Article_Equf.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par53">The modified Platt score<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR53">53</xref></sup> measures the match between a spec-FP <inline-formula id="IEq39"><alternatives><tex-math id="M89">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{x}^F \in \mathbb{R}^n$$\end{document}</tex-math><mml:math id="M90"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mo>∈</mml:mo><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq39.gif"/></alternatives></inline-formula> and a struct-FP <bold>y</bold><sup><italic>F</italic></sup> for a structure <italic>S</italic>; <inline-formula id="IEq40"><alternatives><tex-math id="M91">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathbf{y}^F = {\mathrm{FP}}\left( S \right) \in \left\{ {0,1} \right\}^n$$\end{document}</tex-math><mml:math id="M92"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">y</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mi mathvariant="normal">FP</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>S</mml:mi></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mfenced close="}" open="{"><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq40.gif"/></alternatives></inline-formula>, taking into account the predicted Platt probability (after additive smoothing) and the CSI:FingerID prediction statistics for each bit. The sensitivity <inline-formula id="IEq41"><alternatives><tex-math id="M93">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$a_i = {\mathrm{TP}}_i/\left( {{\mathrm{TP}}_i + {\mathrm{FN}}_i} \right)$$\end{document}</tex-math><mml:math id="M94"><mml:mrow><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">TP</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>/</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">TP</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">FN</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq41.gif"/></alternatives></inline-formula> and specificity <inline-formula id="IEq42"><alternatives><tex-math id="M95">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$b_i = {\mathrm{TN}}_i/\left( {{\mathrm{TN}}_i + {\mathrm{FP}}_i} \right)$$\end{document}</tex-math><mml:math id="M96"><mml:mrow><mml:msub><mml:mrow><mml:mi>b</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">TN</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>/</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">TN</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">FP</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq42.gif"/></alternatives></inline-formula> (with TN indicating the true negatives, TP the true positives, FP the false positives and FN the false negatives for bit <italic>i</italic>, respectively) are obtained from CSI:FingerID output. The ModPlatt score is then calculated as follows:<disp-formula id="Equg"><alternatives><tex-math id="M97">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{array}{lll}{\mathrm{ModPlatt}}\left( {\mathbf{x}^F,\mathbf{y}^F} \right) \\= \mathop {\sum }\limits_{i \in \left( {1..3609} \right)} \left\{ {\begin{array}{*{20}{l}} {0.75\log x_i^F + 0.25\log \left( {1 - a_i} \right),} \hfill &amp; {x_i^F \ge 0.5,} \hfill &amp; {y_i^F = 1} \hfill \\ {0.75\log \left( {1 - x_i^F} \right),} \hfill &amp; {x_i^F \ge 0.5,} \hfill &amp; {y_i^F = 0} \hfill \\ {0.75\log x_i^F,} \hfill &amp; {x_i^F &lt; 0.5,} \hfill &amp; {y_i^F = 1} \hfill \\ {0.75\log \left( {1 - x_i^F} \right) + 0.25\log \left( {1 - b_i} \right),} \hfill &amp; {x_i^F &lt; 0.5,} \hfill &amp; {y_i^F = 0} \hfill \end{array}} \right.\end{array}$$\end{document}</tex-math><mml:math id="M98"><mml:mtable><mml:mtr><mml:mtd columnalign="left"><mml:mi mathvariant="normal">ModPlatt</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">x</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">y</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mo>=</mml:mo><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mn>3609</mml:mn></mml:mrow></mml:mfenced></mml:mrow></mml:munder><mml:mfenced open="{"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="left"><mml:mn>0.75</mml:mn><mml:mi>log</mml:mi><mml:msubsup><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup><mml:mo>+</mml:mo><mml:mn>0.25</mml:mn><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:msubsup><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup><mml:mo>≥</mml:mo><mml:mn>0.5</mml:mn><mml:mo>,</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mn>0.75</mml:mn><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msubsup><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:msubsup><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup><mml:mo>≥</mml:mo><mml:mn>0.5</mml:mn><mml:mo>,</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mn>0.75</mml:mn><mml:mi>log</mml:mi><mml:msubsup><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:msubsup><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup><mml:mo>&lt;</mml:mo><mml:mn>0.5</mml:mn><mml:mo>,</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mn>0.75</mml:mn><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msubsup><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced><mml:mo>+</mml:mo><mml:mn>0.25</mml:mn><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>b</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:msubsup><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup><mml:mo>&lt;</mml:mo><mml:mn>0.5</mml:mn><mml:mo>,</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:msubsup><mml:mrow><mml:mi>y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mi>F</mml:mi></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:mtd></mml:mtr></mml:mtable></mml:math><graphic xlink:href="41592_2022_1486_Article_Equg.gif" position="anchor"/></alternatives></disp-formula></p>
    </sec>
    <sec id="Sec18">
      <title>Evaluation metrics</title>
      <p id="Par54">The model and the corresponding baselines were compared with multiple metrics. The following scores were calculated for every instance of a dataset, and their median and first and third quartiles, and/or their histograms, were reported.<list list-type="bullet"><list-item><p id="Par55">‘% valid SMILES’: for every instance of a dataset, the percentage of predicted sequences that could be successfully parsed to a molecule using RDKit without any modifications.</p></list-item><list-item><p id="Par56">‘% correct MF’: for every instance of a dataset, the percentage of predicted sequences that could be successfully parsed to a molecule using RDKit without any modifications, and that additionally matched the molecular formula of the correct structure.</p></list-item><list-item><p id="Par57">‘Modified Platt score’: for every instance of a dataset, the modified Platt score of the highest-ranked candidate versus the query fingerprint. This score is a direct measure of how closely the generated candidate approaches the target fingerprint.<list list-type="bullet"><list-item><p id="Par58">This metric was calculated both for modified Platt-ranked and RNN score-ranked results.</p></list-item><list-item><p id="Par59">The top score by modified Platt ranking is (trivially) the highest modified Platt score overall (the score of the candidate with the highest score).</p></list-item><list-item><p id="Par60">The top score by RNN ranking is the modified Platt score of the candidate that ranks highest by RNN score.</p></list-item></list></p></list-item><list-item><p id="Par61">‘Similarity’: for every instance of a dataset, the Tanimoto similarity of the highest-ranked candidate to the correct structure, based on the full (8,925-bit) fingerprint of the molecule parsed from SMILES and the correct structure. For this analysis, SMILES that parse to the correct structure are removed from the result set. This permits to compare chemical accuracy of the model with, for example, the training set, without biasing the analysis based on the presence or absence of the correct structure in the dataset.<list list-type="bullet"><list-item><p id="Par62">This metric was calculated both for modified Platt-ranked and RNN score-ranked results.</p></list-item><list-item><p id="Par63">The score was calculated by selecting the candidate with the highest modified Platt score or highest RNN score, respectively, and calculating Tanimoto similarity to the correct structure.</p></list-item><list-item><p id="Par64">We note that this is not necessarily the highest Tanimoto similarity overall, as there is no way to find the candidate with the highest Tanimoto similarity without knowing the correct structure.</p></list-item></list></p></list-item></list></p>
      <p id="Par65">The following scores were calculated for an entire dataset:<list list-type="bullet"><list-item><p id="Par66">retrieval (‘% found’): the fraction of instances for which the correct structure was present in the set of predicted structures</p></list-item><list-item><p id="Par67">rank (top-<italic>n</italic> retrieval): the fraction of instances for which the correct structure was at rank <italic>n</italic> or better in the ordered set of predicted structures<list list-type="bullet"><list-item><p id="Par68">This metric was calculated both for modified Platt-ranked and RNN score-ranked results.</p></list-item></list></p></list-item></list></p>
      <p id="Par69">Results were post-processed, analyzed and plotted with R 4.0.4 and 4.1.1 with packages colorblindr (<ext-link ext-link-type="uri" xlink:href="https://github.com/clauswilke/colorblindr">https://github.com/clauswilke/colorblindr/</ext-link>) 0.1.0@e6730be, directlabels 2021.1.13, ggthemes 4.2.4, glue 1.4.2, gridExtra 2.3, khroma 1.7.0, RColorBrewer 1.1-2, scales 1.1.1 and tidyverse 1.3.1.</p>
    </sec>
    <sec id="Sec19">
      <title>De novo annotation of bryophyte metabolites</title>
      <p id="Par70">The dataset <ext-link ext-link-type="uri" xlink:href="https://www.ebi.ac.uk/metabolights/MTBLS709">MTBLS709</ext-link> was downloaded from the MetaboLights repository (<ext-link ext-link-type="uri" xlink:href="ftp://ftp.ebi.ac.uk/pub/databases/metabolights/studies/public/MTBLS709">ftp://ftp.ebi.ac.uk/pub/databases/metabolights/studies/public/MTBLS709</ext-link>). Using an R script, the 10,436 MS<sup>2</sup> spectra were consolidated by precursor (within 0.002 <italic>m/z</italic>) and similarity (&gt;0.9), and uninformative spectra were removed to yield a dataset of 4,628 spectra. The dataset was submitted to GNPS for further clustering, molecular networking, initial annotation and visualization (<ext-link ext-link-type="uri" xlink:href="https://gnps.ucsd.edu/ProteoSAFe/status.jsp?task">https://gnps.ucsd.edu/ProteoSAFe/status.jsp?task=b8b481147b844ebda2481bf9656baec8</ext-link>). From the resulting clustered spectra set, the 576 spectra with <italic>m/z</italic> &lt; 500 were selected. For completeness, the entire dataset (667 spectra up to <italic>m/z</italic> 750) was also processed. Spectra were processed with SIRIUS 4.4.29 for formula prediction (SIRIUS with profile Q-TOF and 20 ppm maximal MS<sup>2</sup> deviation, standard settings; ZODIAC with standard settings), fingerprint prediction and structure annotation (CSI:FingerID, search in ‘all databases except in silico’). The resulting dataset was filtered to retain only instances with high-confidence formula annotation of ≥80% explained peaks, ≥90% explained intensity and ≥0.9 ZODIAC score; 224 spectra) and used as input for de novo structure prediction.</p>
      <p id="Par71">The structure candidates from database search and de novo prediction were both ranked by modified Platt score and the top candidate selected. Instances where the top candidate from de novo prediction was a markedly better spectrum fit (<inline-formula id="IEq43"><alternatives><tex-math id="M99">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathrm{ModPlatt}}_{{\mathrm{MSNovelist}}} - {\mathrm{ModPlatt}}_{{{\mathrm{database}} }}&gt; 50$$\end{document}</tex-math><mml:math id="M100"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">ModPlatt</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">MSNovelist</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">ModPlatt</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">database</mml:mi></mml:mrow></mml:msub><mml:mo>&gt;</mml:mo><mml:mn>50</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="41592_2022_1486_Article_IEq43.gif"/></alternatives></inline-formula>) were selected for further analysis (seven instances). The corresponding MS<sup>2</sup> spectra were analyzed by hand, by library search (NIST MS version 2.4, in MS/MS Hybrid mode; product ion tolerance 0.02 <italic>m/z</italic>) with the NIST 20 library and the MassBank library, and using the NIST MS Interpreter (version 3.4.4; using protonated mass and 20 ppm).</p>
      <p id="Par72">We note that the implementation and parameters of the modified Platt score are minimally different from the score implemented in SIRIUS 4.4.29, and in rare exceptions the top candidate found by the modified Platt score might differ from the SIRIUS top candidate; however, rescoring was necessary to achieve a comparison based on the same metric.</p>
    </sec>
    <sec id="Sec20">
      <title>Reporting summary</title>
      <p id="Par73">Further information on research design is available in the <xref rid="MOESM2" ref-type="media">Nature Research Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec id="Sec21" sec-type="materials|methods">
    <title>Online content</title>
    <p id="Par74">Any methods, additional references, Nature Research reporting summaries, source data, extended data, supplementary information, acknowledgements, peer review information; details of author contributions and competing interests; and statements of data and code availability are available at 10.1038/s41592-022-01486-3.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec22">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41592_2022_1486_MOESM1_ESM.pdf">
            <label>Supplementary Information</label>
            <caption>
              <p>Supplementary Figs. 1–8, Supplementary Algorithms 1 and 2 and Supplementary Tables 1–13</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="41592_2022_1486_MOESM2_ESM.pdf">
            <caption>
              <p>Reporting Summary</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="41592_2022_1486_MOESM3_ESM.pdf">
            <caption>
              <p>Peer Review File</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM4">
          <media xlink:href="41592_2022_1486_MOESM4_ESM.xlsx">
            <caption>
              <p>Supplementary Tables 1–13</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <sec>
    <title>Supplementary information</title>
    <p>The online version contains supplementary material available at 10.1038/s41592-022-01486-3.</p>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>The authors thank M. Fleischauer for support with the CSI:FingerID web service and SIRIUS, and the HPC team of the ETH Zurich Scientific IT service for providing cluster support. This project was supported by grants from the Strategic Focal Area on Personalized Health and Related Technologies (PHRT) of the ETH Domain (to N.Z.). The funders had no role in study design, data collection and analysis, decision to publish or preparation of the manuscript.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>M.A.S. conceived the idea, implemented, trained and evaluated the model. K.D. and S.B. developed the fingerprint simulation, processed the training data and contributed to the evaluation method. N.Z. supervised the study. All authors contributed to writing the manuscript.</p>
  </notes>
  <notes notes-type="peer-review">
    <title>Peer review</title>
    <sec id="FPar1">
      <title>Peer review information</title>
      <p id="Par75"><italic>Nature Methods</italic> thanks Corey Broeckling and the other, anonymous, reviewer(s) for their contribution to the peer review of this work. Primary Handling Editor: Arunima Singh, in collaboration with the <italic>Nature Methods</italic> team. <xref rid="MOESM3" ref-type="media">Peer reviewer reports</xref> are available.</p>
    </sec>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>The dataset and scripts required to reproduce the validation, bryophyte analysis and figures are provided on Zenodo at 10.5281/zenodo.5705830. The dataset <ext-link ext-link-type="uri" xlink:href="https://www.ebi.ac.uk/metabolights/MTBLS709">MTBLS709</ext-link> analyzed during the current study is available in the MetaboLights repository at <ext-link ext-link-type="uri" xlink:href="https://www.ebi.ac.uk/metabolights/MTBLS709">https://www.ebi.ac.uk/metabolights/MTBLS709</ext-link>. Processed data are available on the GNPS repository at <ext-link ext-link-type="uri" xlink:href="https://gnps.ucsd.edu/ProteoSAFe/status.jsp?task=b8b481147b844ebda2481bf9656baec8">https://gnps.ucsd.edu/ProteoSAFe/status.jsp?task=b8b481147b844ebda2481bf9656baec8</ext-link>. The HMDB and COCONUT databases are available on Zenodo at <ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/3375500">https://zenodo.org/record/3375500</ext-link> and <ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/3778405">https://zenodo.org/record/3778405</ext-link>. The DSSTox database is available at <ext-link ext-link-type="uri" xlink:href="ftp://newftp.epa.gov/COMPTOX/Sustainable_Chemistry_Data/Chemistry_Dashboard/MetFrag_metadata_files/CompTox_17March2019_SelectMetaData.csv">ftp://newftp.epa.gov/COMPTOX/Sustainable_Chemistry_Data/Chemistry_Dashboard/MetFrag_metadata_files/CompTox_17March2019_SelectMetaData.csv</ext-link>. All further data are available from the authors on reasonable request.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>MSNovelist is available on GitHub (<ext-link ext-link-type="uri" xlink:href="https://github.com/meowcat/MSNovelist">https://github.com/meowcat/MSNovelist</ext-link>) or as a Docker image on Dockerhub (stravsm/msnovelist). The software requires a Docker installation, and can be run as a pure command line tool or with a simple web interface. It was tested on Windows and Linux (Ubuntu 18.04, 20.04) computers with 16 or 32 GB RAM. Processing of a single spectrum takes &lt;5 min. Processing of the entire bryophyte dataset (550 spectra) requires 1 h on a workstation with ten cores, and 2.5 h on a laptop with four cores. Note that high-<italic>m/z</italic> molecules may require a long time for spectral fragmentation tree computation.</p>
  </notes>
  <notes id="FPar2" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par76">S.B. and K.D. are cofounders of Bright Giant. The remaining authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stein</surname>
            <given-names>SE</given-names>
          </name>
          <name>
            <surname>Scott</surname>
            <given-names>DR</given-names>
          </name>
        </person-group>
        <article-title>Optimization and testing of mass spectral library search algorithms for compound identification</article-title>
        <source>J. Am. Soc. Mass. Spectrom.</source>
        <year>1994</year>
        <volume>5</volume>
        <fpage>859</fpage>
        <lpage>866</lpage>
        <pub-id pub-id-type="doi">10.1016/1044-0305(94)87009-8</pub-id>
        <?supplied-pmid 24222034?>
        <pub-id pub-id-type="pmid">24222034</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kind</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Identification of small molecules using accurate mass MS/MS search</article-title>
        <source>Mass Spectrom. Rev.</source>
        <year>2018</year>
        <volume>37</volume>
        <fpage>513</fpage>
        <lpage>532</lpage>
        <pub-id pub-id-type="doi">10.1002/mas.21535</pub-id>
        <?supplied-pmid 28436590?>
        <pub-id pub-id-type="pmid">28436590</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kim</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>PubChem 2019 update: improved access to chemical data</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2019</year>
        <volume>47</volume>
        <fpage>D1102</fpage>
        <lpage>D1109</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gky1033</pub-id>
        <?supplied-pmid 30371825?>
        <pub-id pub-id-type="pmid">30371825</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kanehisa</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Goto</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>KEGG: Kyoto encyclopedia of genes and genomes</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2000</year>
        <volume>28</volume>
        <fpage>27</fpage>
        <lpage>30</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/28.1.27</pub-id>
        <?supplied-pmid 10592173?>
        <pub-id pub-id-type="pmid">10592173</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Allen</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Greiner</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Wishart</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>Competitive fragmentation modeling of ESI-MS/MS spectra for putative metabolite identification</article-title>
        <source>Metabolomics</source>
        <year>2014</year>
        <volume>11</volume>
        <fpage>98</fpage>
        <lpage>110</lpage>
        <pub-id pub-id-type="doi">10.1007/s11306-014-0676-4</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ruttkies</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Schymanski</surname>
            <given-names>EL</given-names>
          </name>
          <name>
            <surname>Wolf</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Hollender</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Neumann</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>MetFrag relaunched: incorporating strategies beyond in silico fragmentation</article-title>
        <source>J. Cheminform.</source>
        <year>2016</year>
        <volume>8</volume>
        <fpage>3</fpage>
        <pub-id pub-id-type="doi">10.1186/s13321-016-0115-9</pub-id>
        <?supplied-pmid 26834843?>
        <pub-id pub-id-type="pmid">26834843</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Heinonen</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Shen</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Zamboni</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Rousu</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Metabolite identification and molecular fingerprint prediction through machine learning</article-title>
        <source>Bioinformatics</source>
        <year>2012</year>
        <volume>28</volume>
        <fpage>2333</fpage>
        <lpage>2341</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/bts437</pub-id>
        <?supplied-pmid 22815355?>
        <pub-id pub-id-type="pmid">22815355</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dührkop</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Shen</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Meusel</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Rousu</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Böcker</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Searching molecular structure databases with tandem mass spectra using CSI:FingerID</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2015</year>
        <volume>112</volume>
        <fpage>12580</fpage>
        <lpage>12585</lpage>
        <pub-id pub-id-type="doi">10.1073/pnas.1509788112</pub-id>
        <?supplied-pmid 26392543?>
        <pub-id pub-id-type="pmid">26392543</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dührkop</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>SIRIUS 4: a rapid tool for turning tandem mass spectra into metabolite structure information</article-title>
        <source>Nat. Methods</source>
        <year>2019</year>
        <volume>16</volume>
        <fpage>299</fpage>
        <lpage>302</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0344-8</pub-id>
        <?supplied-pmid 30886413?>
        <pub-id pub-id-type="pmid">30886413</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Peironcely</surname>
            <given-names>JE</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>OMG: open molecule generator</article-title>
        <source>J. Cheminform.</source>
        <year>2012</year>
        <volume>4</volume>
        <fpage>21</fpage>
        <pub-id pub-id-type="doi">10.1186/1758-2946-4-21</pub-id>
        <?supplied-pmid 22985496?>
        <pub-id pub-id-type="pmid">22985496</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Peironcely</surname>
            <given-names>JE</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Automated pipeline for de novo metabolite identification using mass-spectrometry-based metabolomics</article-title>
        <source>Anal. Chem.</source>
        <year>2013</year>
        <volume>85</volume>
        <fpage>3576</fpage>
        <lpage>3583</lpage>
        <pub-id pub-id-type="doi">10.1021/ac303218u</pub-id>
        <?supplied-pmid 23368721?>
        <pub-id pub-id-type="pmid">23368721</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schymanski</surname>
            <given-names>EL</given-names>
          </name>
          <name>
            <surname>Meinert</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Meringer</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Brack</surname>
            <given-names>W</given-names>
          </name>
        </person-group>
        <article-title>The use of MS classifiers and structure generation to assist in the identification of unknowns in effect-directed analysis</article-title>
        <source>Anal. Chim. Acta</source>
        <year>2008</year>
        <volume>615</volume>
        <fpage>136</fpage>
        <lpage>147</lpage>
        <pub-id pub-id-type="doi">10.1016/j.aca.2008.03.060</pub-id>
        <?supplied-pmid 18442519?>
        <pub-id pub-id-type="pmid">18442519</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kerber</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Laue</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Meringer</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Rücker</surname>
            <given-names>C</given-names>
          </name>
        </person-group>
        <article-title>Molecules in silico: potential versus known organic compounds</article-title>
        <source>MATCH Commun. Math. Co.</source>
        <year>2005</year>
        <volume>54</volume>
        <fpage>301</fpage>
        <lpage>312</lpage>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Jeffryes</surname>
            <given-names>JG</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>MINEs: open access databases of computationally predicted enzyme promiscuity products for untargeted metabolomics</article-title>
        <source>J. Cheminform.</source>
        <year>2015</year>
        <volume>7</volume>
        <fpage>44</fpage>
        <pub-id pub-id-type="doi">10.1186/s13321-015-0087-1</pub-id>
        <?supplied-pmid 26322134?>
        <pub-id pub-id-type="pmid">26322134</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Djoumbou-Feunang</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>BioTransformer: a comprehensive computational tool for small molecule metabolism prediction and metabolite identification</article-title>
        <source>J. Cheminform.</source>
        <year>2019</year>
        <volume>11</volume>
        <fpage>2</fpage>
        <pub-id pub-id-type="doi">10.1186/s13321-018-0324-5</pub-id>
        <?supplied-pmid 30612223?>
        <pub-id pub-id-type="pmid">30612223</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Aron</surname>
            <given-names>AT</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Reproducible molecular networking of untargeted mass spectrometry data using GNPS</article-title>
        <source>Nat. Protoc.</source>
        <year>2020</year>
        <volume>15</volume>
        <fpage>1954</fpage>
        <lpage>1991</lpage>
        <pub-id pub-id-type="doi">10.1038/s41596-020-0317-5</pub-id>
        <?supplied-pmid 32405051?>
        <pub-id pub-id-type="pmid">32405051</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Benton</surname>
            <given-names>HP</given-names>
          </name>
          <name>
            <surname>Wong</surname>
            <given-names>DM</given-names>
          </name>
          <name>
            <surname>Trauger</surname>
            <given-names>SA</given-names>
          </name>
          <name>
            <surname>Siuzdak</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>XCMS2: processing tandem mass spectrometry data for metabolite identification and structural characterization</article-title>
        <source>Anal. Chem.</source>
        <year>2008</year>
        <volume>80</volume>
        <fpage>6382</fpage>
        <lpage>6389</lpage>
        <pub-id pub-id-type="doi">10.1021/ac800795f</pub-id>
        <?supplied-pmid 18627180?>
        <pub-id pub-id-type="pmid">18627180</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dührkop</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Systematic classification of unknown metabolites using high-resolution fragmentation mass spectra</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2020</year>
        <volume>39</volume>
        <fpage>462</fpage>
        <lpage>471</lpage>
        <pub-id pub-id-type="doi">10.1038/s41587-020-0740-8</pub-id>
        <?supplied-pmid 33230292?>
        <pub-id pub-id-type="pmid">33230292</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Gómez-Bombarelli</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Automatic chemical design using a data-driven continuous representation of molecules</article-title>
        <source>ACS Cent. Sci.</source>
        <year>2018</year>
        <volume>4</volume>
        <fpage>268</fpage>
        <lpage>276</lpage>
        <pub-id pub-id-type="doi">10.1021/acscentsci.7b00572</pub-id>
        <?supplied-pmid 29532027?>
        <pub-id pub-id-type="pmid">29532027</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Weininger</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>SMILES, a chemical language and information system. 1. Introduction to methodology and encoding rules</article-title>
        <source>J. Chem. Inf. Comput. Sci.</source>
        <year>1988</year>
        <volume>28</volume>
        <fpage>31</fpage>
        <lpage>36</lpage>
        <pub-id pub-id-type="doi">10.1021/ci00057a005</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Segler</surname>
            <given-names>MHS</given-names>
          </name>
          <name>
            <surname>Kogej</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Tyrchan</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Waller</surname>
            <given-names>MP</given-names>
          </name>
        </person-group>
        <article-title>Generating focused molecule libraries for drug discovery with recurrent neural networks</article-title>
        <source>ACS Cent. Sci.</source>
        <year>2018</year>
        <volume>4</volume>
        <fpage>120</fpage>
        <lpage>131</lpage>
        <pub-id pub-id-type="doi">10.1021/acscentsci.7b00512</pub-id>
        <?supplied-pmid 29392184?>
        <pub-id pub-id-type="pmid">29392184</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Elton</surname>
            <given-names>DC</given-names>
          </name>
          <name>
            <surname>Boukouvalas</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Fuge</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>Chung</surname>
            <given-names>PW</given-names>
          </name>
        </person-group>
        <article-title>Deep learning for molecular design—a review of the state of the art</article-title>
        <source>Mol. Syst. Des. Eng.</source>
        <year>2019</year>
        <volume>4</volume>
        <fpage>828</fpage>
        <lpage>849</lpage>
        <pub-id pub-id-type="doi">10.1039/C9ME00039A</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Olivecrona</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Blaschke</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Engkvist</surname>
            <given-names>O</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>H</given-names>
          </name>
        </person-group>
        <article-title>Molecular de novo design through deep reinforcement learning</article-title>
        <source>J. Cheminform.</source>
        <year>2017</year>
        <volume>9</volume>
        <fpage>48</fpage>
        <pub-id pub-id-type="doi">10.1186/s13321-017-0235-x</pub-id>
        <?supplied-pmid 29086083?>
        <pub-id pub-id-type="pmid">29086083</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Brown</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Fiscato</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Segler</surname>
            <given-names>MHS</given-names>
          </name>
          <name>
            <surname>Vaucher</surname>
            <given-names>AC</given-names>
          </name>
        </person-group>
        <article-title>GuacaMol: benchmarking models for de novo molecular design</article-title>
        <source>J. Chem. Inf. Model.</source>
        <year>2019</year>
        <volume>59</volume>
        <fpage>1096</fpage>
        <lpage>1108</lpage>
        <pub-id pub-id-type="doi">10.1021/acs.jcim.8b00839</pub-id>
        <?supplied-pmid 30887799?>
        <pub-id pub-id-type="pmid">30887799</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Colby</surname>
            <given-names>SM</given-names>
          </name>
          <name>
            <surname>Nunez</surname>
            <given-names>JR</given-names>
          </name>
          <name>
            <surname>Hodas</surname>
            <given-names>NO</given-names>
          </name>
          <name>
            <surname>Corley</surname>
            <given-names>CD</given-names>
          </name>
          <name>
            <surname>Renslow</surname>
            <given-names>RS</given-names>
          </name>
        </person-group>
        <article-title>Deep learning to generate in silico chemical property libraries and candidate molecules for small-molecule identification in complex samples</article-title>
        <source>Anal. Chem.</source>
        <year>2020</year>
        <volume>92</volume>
        <fpage>1720</fpage>
        <lpage>1729</lpage>
        <pub-id pub-id-type="doi">10.1021/acs.analchem.9b02348</pub-id>
        <?supplied-pmid 31661259?>
        <pub-id pub-id-type="pmid">31661259</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Skinnider</surname>
            <given-names>MA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A deep generative model enables automated structure elucidation of novel psychoactive substances</article-title>
        <source>Nat. Mach. Intell.</source>
        <year>2021</year>
        <volume>3</volume>
        <fpage>973</fpage>
        <lpage>984</lpage>
        <pub-id pub-id-type="doi">10.1038/s42256-021-00407-x</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Sharing and community curation of mass spectrometry data with Global Natural Products Social Molecular Networking</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2016</year>
        <volume>34</volume>
        <fpage>828</fpage>
        <lpage>837</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.3597</pub-id>
        <?supplied-pmid 27504778?>
        <pub-id pub-id-type="pmid">27504778</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schymanski</surname>
            <given-names>EL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Critical assessment of small molecule identification 2016: automated methods</article-title>
        <source>J. Cheminform.</source>
        <year>2017</year>
        <volume>9</volume>
        <fpage>22</fpage>
        <pub-id pub-id-type="doi">10.1186/s13321-017-0207-1</pub-id>
        <?supplied-pmid 29086042?>
        <pub-id pub-id-type="pmid">29086042</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wishart</surname>
            <given-names>DS</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>HMDB 4.0: the human metabolome database for 2018</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2018</year>
        <volume>46</volume>
        <fpage>D608</fpage>
        <lpage>D617</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkx1089</pub-id>
        <?supplied-pmid 29140435?>
        <pub-id pub-id-type="pmid">29140435</pub-id>
      </element-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sorokina</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Steinbeck</surname>
            <given-names>C</given-names>
          </name>
        </person-group>
        <article-title>Review on natural products databases: where to find data in 2020</article-title>
        <source>J. Cheminform.</source>
        <year>2020</year>
        <volume>12</volume>
        <fpage>20</fpage>
        <pub-id pub-id-type="doi">10.1186/s13321-020-00424-9</pub-id>
        <?supplied-pmid 33431011?>
        <pub-id pub-id-type="pmid">33431011</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>McEachran</surname>
            <given-names>AD</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>‘MS-Ready’ structures for non-targeted high-resolution mass spectrometry screening studies</article-title>
        <source>J. Cheminform.</source>
        <year>2018</year>
        <volume>10</volume>
        <fpage>45</fpage>
        <pub-id pub-id-type="doi">10.1186/s13321-018-0299-2</pub-id>
        <?supplied-pmid 30167882?>
        <pub-id pub-id-type="pmid">30167882</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cooper</surname>
            <given-names>BT</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Hybrid search: a method for identifying metabolites absent from tandem mass spectrometry libraries</article-title>
        <source>Anal. Chem.</source>
        <year>2019</year>
        <volume>91</volume>
        <fpage>13924</fpage>
        <lpage>13932</lpage>
        <pub-id pub-id-type="doi">10.1021/acs.analchem.9b03415</pub-id>
        <?supplied-pmid 31600070?>
        <pub-id pub-id-type="pmid">31600070</pub-id>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Peters</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Chemical diversity and classification of secondary metabolites in nine bryophyte species</article-title>
        <source>Metabolites</source>
        <year>2019</year>
        <volume>9</volume>
        <fpage>222</fpage>
        <pub-id pub-id-type="doi">10.3390/metabo9100222</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ayers</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Struthiolanone: a flavanone-resveratrol adduct from struthiola argentea</article-title>
        <source>Nat. Prod. Commun.</source>
        <year>2008</year>
        <volume>3</volume>
        <fpage>1934578X0800300</fpage>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bohacek</surname>
            <given-names>RS</given-names>
          </name>
          <name>
            <surname>McMartin</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Guida</surname>
            <given-names>WC</given-names>
          </name>
        </person-group>
        <article-title>The art and practice of structure-based drug design: a molecular modeling perspective</article-title>
        <source>Medicinal Res. Rev.</source>
        <year>1996</year>
        <volume>16</volume>
        <fpage>3</fpage>
        <lpage>50</lpage>
        <pub-id pub-id-type="doi">10.1002/(SICI)1098-1128(199601)16:1&lt;3::AID-MED1&gt;3.0.CO;2-6</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <mixed-citation publication-type="other">O’Boyle, N. &amp; Dalke, A. DeepSMILES: an adaptation of SMILES for use in machine-learning of chemical structures. Preprint at 10.26434/chemrxiv.7097960.v1 (2018).</mixed-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Krenn</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Häse</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Nigam</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Friederich</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Aspuru-Guzik</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Self-referencing embedded strings (SELFIES): a 100% robust molecular string representation</article-title>
        <source>Mach. Learn.: Sci. Technol.</source>
        <year>2020</year>
        <volume>1</volume>
        <fpage>045024</fpage>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <mixed-citation publication-type="other">Jin, W., Barzilay, R. &amp; Jaakkola, T. in <italic>Drug Discovery</italic> (ed. Brown, N.) 228–249 (Royal Society of Chemistry, 2020).</mixed-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kwon</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Efficient learning of non-autoregressive graph variational autoencoders for molecular graph generation</article-title>
        <source>J. Cheminform.</source>
        <year>2019</year>
        <volume>11</volume>
        <fpage>70</fpage>
        <pub-id pub-id-type="doi">10.1186/s13321-019-0396-x</pub-id>
        <?supplied-pmid 33430985?>
        <pub-id pub-id-type="pmid">33430985</pub-id>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Samanta</surname>
            <given-names>B</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>NeVAE: a deep generative model for molecular graphs</article-title>
        <source>J. Mach. Learn. Res.</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>1</fpage>
        <lpage>33</lpage>
        <pub-id pub-id-type="pmid">34305477</pub-id>
      </element-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <mixed-citation publication-type="other">You, J., Liu, B., Ying, R., Pande, V. &amp; Leskovec, J. Graph convolutional policy network for goal-directed molecular graph generation. In <italic>Proc. 32nd International Conference on Neural Information Processing Systems</italic> (eds Bengio, S. et al.) 6412–6422 (Curran Associates, 2018)</mixed-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ludwig</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Database-independent molecular formula annotation using Gibbs sampling through ZODIAC</article-title>
        <source>Nat. Mach. Intell.</source>
        <year>2020</year>
        <volume>2</volume>
        <fpage>629</fpage>
        <lpage>641</lpage>
        <pub-id pub-id-type="doi">10.1038/s42256-020-00234-6</pub-id>
      </element-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <mixed-citation publication-type="other">Hoffmann, M. A. et al. High-confidence structural annotation of metabolites absent from spectral libraries. <italic>Nat. Biotechnol</italic>. <bold>40</bold>, 411–421 (2022).</mixed-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hochreiter</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Schmidhuber</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Long short-term memory</article-title>
        <source>Neural Comput.</source>
        <year>1997</year>
        <volume>9</volume>
        <fpage>1735</fpage>
        <lpage>1780</lpage>
        <pub-id pub-id-type="doi">10.1162/neco.1997.9.8.1735</pub-id>
        <?supplied-pmid 9377276?>
        <pub-id pub-id-type="pmid">9377276</pub-id>
      </element-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hähnke</surname>
            <given-names>VD</given-names>
          </name>
          <name>
            <surname>Kim</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Bolton</surname>
            <given-names>EE</given-names>
          </name>
        </person-group>
        <article-title>PubChem chemical structure standardization</article-title>
        <source>J. Cheminform.</source>
        <year>2018</year>
        <volume>10</volume>
        <fpage>36</fpage>
        <pub-id pub-id-type="doi">10.1186/s13321-018-0293-8</pub-id>
        <?supplied-pmid 30097821?>
        <pub-id pub-id-type="pmid">30097821</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Klekota</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Roth</surname>
            <given-names>FP</given-names>
          </name>
        </person-group>
        <article-title>Chemical substructures that enrich for biological activity</article-title>
        <source>Bioinformatics</source>
        <year>2008</year>
        <volume>24</volume>
        <fpage>2518</fpage>
        <lpage>2525</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btn479</pub-id>
        <?supplied-pmid 18784118?>
        <pub-id pub-id-type="pmid">18784118</pub-id>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rogers</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Hahn</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Extended-connectivity fingerprints</article-title>
        <source>J. Chem. Inf. Model.</source>
        <year>2010</year>
        <volume>50</volume>
        <fpage>742</fpage>
        <lpage>754</lpage>
        <pub-id pub-id-type="doi">10.1021/ci100050t</pub-id>
        <?supplied-pmid 20426451?>
        <pub-id pub-id-type="pmid">20426451</pub-id>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Williams</surname>
            <given-names>RJ</given-names>
          </name>
          <name>
            <surname>Zipser</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>A learning algorithm for continually running fully recurrent neural networks</article-title>
        <source>Neural Comput.</source>
        <year>1989</year>
        <volume>1</volume>
        <fpage>270</fpage>
        <lpage>280</lpage>
        <pub-id pub-id-type="doi">10.1162/neco.1989.1.2.270</pub-id>
      </element-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <mixed-citation publication-type="other">Vinyals, O., Toshev, A., Bengio, S. &amp; Erhan, D. Show and tell: a neural image caption generator. In <italic>2015 IEEE Conference on Computer Vision and Pattern Recognition (CVPR)</italic> 3156–3164 (IEEE, 2015).</mixed-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <mixed-citation publication-type="other">Chen, X. et al. Variational lossy autoencoder. In <italic>5th International Conference on Learning Representations</italic> (ICLR, 2017).</mixed-citation>
    </ref>
    <ref id="CR51">
      <label>51.</label>
      <mixed-citation publication-type="other">Zhao, S., Song, J. &amp; Ermon, S. InfoVAE: information maximizing variational autoencoders. Preprint at <ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1706.02262">https://arxiv.org/abs/1706.02262</ext-link> (2018).</mixed-citation>
    </ref>
    <ref id="CR52">
      <label>52.</label>
      <mixed-citation publication-type="other">Kingma, D. P. &amp; Ba, J. Adam: a method for stochastic optimization. In <italic>3rd International Conference on Learning Representations</italic> (ICLR, 2015).</mixed-citation>
    </ref>
    <ref id="CR53">
      <label>53.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ludwig</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Dührkop</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Böcker</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Bayesian networks for mass spectrometric metabolite identification via molecular fingerprints</article-title>
        <source>Bioinformatics</source>
        <year>2018</year>
        <volume>34</volume>
        <fpage>i333</fpage>
        <lpage>i340</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/bty245</pub-id>
        <?supplied-pmid 29949965?>
        <pub-id pub-id-type="pmid">29949965</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
