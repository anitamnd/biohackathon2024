<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NPG//DTD XML Article//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName NPG_XML_Article.dtd?>
<?SourceDTD.Version 2.7.10?>
<?ConverterInfo.XSLTName nature2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Sci Rep</journal-id>
    <journal-id journal-id-type="iso-abbrev">Sci Rep</journal-id>
    <journal-title-group>
      <journal-title>Scientific Reports</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2045-2322</issn>
    <publisher>
      <publisher-name>Nature Publishing Group</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">5299605</article-id>
    <article-id pub-id-type="pii">srep42112</article-id>
    <article-id pub-id-type="doi">10.1038/srep42112</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Open-source algorithm for automatic choroid segmentation of OCT volume reconstructions</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Mazzaferri</surname>
          <given-names>Javier</given-names>
        </name>
        <xref ref-type="aff" rid="a1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Beaton</surname>
          <given-names>Luke</given-names>
        </name>
        <xref ref-type="aff" rid="a1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Hounye</surname>
          <given-names>Gisèle</given-names>
        </name>
        <xref ref-type="aff" rid="a1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Sayah</surname>
          <given-names>Diane N.</given-names>
        </name>
        <xref ref-type="aff" rid="a1">1</xref>
        <xref ref-type="aff" rid="a2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Costantino</surname>
          <given-names>Santiago</given-names>
        </name>
        <xref ref-type="corresp" rid="c1">a</xref>
        <xref ref-type="aff" rid="a1">1</xref>
        <xref ref-type="aff" rid="a2">2</xref>
      </contrib>
      <aff id="a1"><label>1</label><institution>Centre de Recherche Hôpital Maisonneuve-Rosemont</institution>, Montréal, QC, <country>Canada</country></aff>
      <aff id="a2"><label>2</label><institution>Département d’Ophtalmologie, Université de Montréal</institution>, Montréal, QC, <country>Canada</country></aff>
    </contrib-group>
    <author-notes>
      <corresp id="c1">
        <label>a</label>
        <email>santiago.costantino@umontreal.ca</email>
      </corresp>
    </author-notes>
    <pub-date pub-type="epub">
      <day>09</day>
      <month>02</month>
      <year>2017</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2017</year>
    </pub-date>
    <volume>7</volume>
    <elocation-id>42112</elocation-id>
    <history>
      <date date-type="received">
        <day>19</day>
        <month>09</month>
        <year>2016</year>
      </date>
      <date date-type="accepted">
        <day>30</day>
        <month>12</month>
        <year>2016</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>Copyright © 2017, The Author(s)</copyright-statement>
      <copyright-year>2017</copyright-year>
      <copyright-holder>The Author(s)</copyright-holder>
      <license xmlns:xlink="http://www.w3.org/1999/xlink" license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/4.0/">
        <!--author-paid-->
        <license-p>This work is licensed under a Creative Commons Attribution 4.0 International License. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in the credit line; if the material is not included under the Creative Commons license, users will need to obtain permission from the license holder to reproduce the material. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link></license-p>
      </license>
    </permissions>
    <abstract>
      <p>The use of optical coherence tomography (OCT) to study ocular diseases associated with choroidal physiology is sharply limited by the lack of available automated segmentation tools. Current research largely relies on hand-traced, single B-Scan segmentations because commercially available programs require high quality images, and the existing implementations are closed, scarce and not freely available. We developed and implemented a robust algorithm for segmenting and quantifying the choroidal layer from 3-dimensional OCT reconstructions. Here, we describe the algorithm, validate and benchmark the results, and provide an open-source implementation under the General Public License for any researcher to use (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="https://www.mathworks.com/matlabcentral/fileexchange/61275-choroidsegmentation">https://www.mathworks.com/matlabcentral/fileexchange/61275-choroidsegmentation</ext-link>).</p>
    </abstract>
  </article-meta>
</front>
<body>
  <p>The vessels of the choroid are the exclusive source of oxygen and nutrients to the outer retina and its anatomy plays an important role in the symptoms and pathogenesis of several eye conditions<xref ref-type="bibr" rid="b1">1</xref>. It has recently been observed that the choroid is thinner in patients with Type I diabetes<xref ref-type="bibr" rid="b2">2</xref><xref ref-type="bibr" rid="b3">3</xref>, geographic atrophy<xref ref-type="bibr" rid="b4">4</xref>, pathologic myopia<xref ref-type="bibr" rid="b5">5</xref>, and retinopathy of prematurity<xref ref-type="bibr" rid="b6">6</xref><xref ref-type="bibr" rid="b7">7</xref><xref ref-type="bibr" rid="b8">8</xref>. Choroidal visualization based on optical coherence tomography (OCT) has also been used to characterize inflammatory disorders in the posterior segment<xref ref-type="bibr" rid="b9">9</xref>. Furthermore, choroidal thickness measurements have been shown useful to monitor the progression of patients under VEGF treatment<xref ref-type="bibr" rid="b10">10</xref><xref ref-type="bibr" rid="b11">11</xref>.</p>
  <p>These OCT studies require particularly high signal-to-noise ratio (SNR) images of the deepest layers of the ocular fundus to be able to visualize the choroid clearly. Two technologies have recently enabled this: Enhanced Depth Imaging (EDI) OCT<xref ref-type="bibr" rid="b12">12</xref>, which is based on an optimal positioning of the reference mirror, and Swept Source-OCT<xref ref-type="bibr" rid="b13">13</xref>, based on a rapidly tunable infrared laser. However, the choroid topography is delineated manually in the vast majority of studies available in the literature<xref ref-type="bibr" rid="b4">4</xref><xref ref-type="bibr" rid="b10">10</xref><xref ref-type="bibr" rid="b14">14</xref><xref ref-type="bibr" rid="b15">15</xref><xref ref-type="bibr" rid="b16">16</xref><xref ref-type="bibr" rid="b17">17</xref>. This approach is not only tedious and prohibitively time-consuming, but it is also operator-dependent and fundamentally prone to bias. Moreover, any thorough study of the choroidal topology requires a 3-dimensional description that cannot be performed realistically with manual segmentation. Hence, reliable fully automated segmentation tools are critical to produce comprehensive and statistically relevant studies.</p>
  <p>Some modern OCT devices provide automatic segmentation software for the choroid. However, the results depend strongly on the quality of the images, and the software lacks sufficient versatility to adapt to abnormal tissue profiles encountered in many ocular pathologies. A limited group of studies have developed automatic or semiautomatic segmentation algorithms. Zhang <italic>et al</italic>. have developed an algorithm based on the segmentation of individual blood vessels<xref ref-type="bibr" rid="b18">18</xref>, and this method has been used to study the correlation between the choroidal volume and the level of diabetic macular edema<xref ref-type="bibr" rid="b19">19</xref>. Kajic <italic>et al</italic>. have proposed a two stage statistical model based on texture and shape analysis to segment the choroid<xref ref-type="bibr" rid="b20">20</xref><xref ref-type="bibr" rid="b21">21</xref>, which has been applied to assess choroidal thinning in patients with Type-I diabetes<xref ref-type="bibr" rid="b2">2</xref> and to segment the Haller and Sattler Layers<xref ref-type="bibr" rid="b22">22</xref>. DOCTRAP is a patented software, which allows segmentation of several retinal layers, and has been used to measure choroidal thickness in patients with AMD<xref ref-type="bibr" rid="b17">17</xref><xref ref-type="bibr" rid="b23">23</xref>. Finally, Zhang <italic>et al</italic>. have developed a graph-cut method to segment the choroid layer<xref ref-type="bibr" rid="b24">24</xref>. Unfortunately, none of these tools is freely available in closed or open-source format, and therefore despite readily available imaging technologies for visualizing the choroid, we believe the lack of available tools to analyze and quantify these images is unnecessarily delaying the progress of the field.</p>
  <p>We have recently developed a novel algorithm to automatically detect the choroidal boundaries on OCT time series at a single location in the retina<xref ref-type="bibr" rid="b25">25</xref>. The method is based on graph theory and we have successfully applied it to measure ocular rigidity by quantifying pulsatile choroidal volume fluctuations at the frequency of the heart. Building on this algorithm, we have extended the computational approach to create choroidal thickness maps from OCT volume reconstructions.</p>
  <p>The proposed software segments the anterior and posterior interfaces of the choroid from an OCT volume centered at the macula, and automatically builds a 2D thickness map (3D topology). In this article we describe every step of the algorithm in detail, we assess the software performance, we compare against manual and commercial segmentations, and we demonstrate the use of the algorithm for analyzing the choroid layer in 3D using several surface descriptors.</p>
  <p>Finally, in an effort to overcome the shortfall in open-source analysis resources and thereby increase the pace of OCT-based research into ocular pathology, we release the full multiplatform Matlab source code under version 3 of the General Public License <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="https://www.mathworks.com/matlabcentral/fileexchange/61275-choroidsegmentation">https://www.mathworks.com/matlabcentral/fileexchange/61275-choroidsegmentation</ext-link><xref ref-type="bibr" rid="b26">26</xref>.</p>
  <sec disp-level="1">
    <title>Segmentation algorithm</title>
    <p>The program uses as input a set of OCT images of the retina around the macula and detects the position of 3 layers: the retinal-vitreous interface (RVI), the Bruch’s membrane (BM), and the choroid-sclera interface (CSI). The OCT images consist of a series of B-scans that the algorithm segments individually. The segmentation output of all B-scans is analyzed, combined and finally interpolated to build graphic representations as 2D maps, and allow computation of the thickness of the whole retina as well as that of the choroid.</p>
    <p>First, we standardize tomography volume data by representing it as a sorted series of adjacent B-scans and a table describing their positions in the volume. To increase the SNR, images are smoothed using information from adjacent B-scans, retinal interfaces are segmented in each B-scan individually, and finally the 2D retinal and choroidal thickness maps are generated.</p>
    <sec disp-level="2">
      <title>Standardizing tomography images</title>
      <p>Different OCT devices have different image storage formats, hence the first step of the algorithm is to convert the tomography into a sorted series of contiguous B-scans and extract their location information with respect to the fundus coordinates. Here we provide the implementation for the Heidelberg-Spectralis format. For other devices, the user needs to extract the B-scans from the device and store them in individual image files which are named to facilitate contiguous sorting, and run a small Matlab script (that we provide) to input basic size and location information.</p>
    </sec>
    <sec disp-level="2">
      <title>RVI and BM segmentation</title>
      <p>The Bruch’s membrane is commonly used to define the anterior limit of the choroid. This membrane, however, is often difficult to distinguish from the RPE in OCT images, particularly for retinas affected by drusen, edema and epithelial dystrophies. Since the RPE is usually easy to segment, we estimate the location of the BM as the convex hull of the RPE. In other words, the convex hull may be interpreted as the shape of a rubber band stretched around the RPE from the posterior side (<xref ref-type="fig" rid="f1">Fig. 1D</xref>).</p>
      <p>The strategy to segment the RPE is based on the fact that both the RVI and the RPE display the highest intensity contrast among all interfaces in B-scans (<xref ref-type="fig" rid="f1">Fig. 1B</xref>). A Gaussian low pass filter is first used to smooth out imaging noise and irrelevant small features. We find the interfaces by looking at the two highest local maxima of the intensity gradient in the axial direction, assigning the most anterior peak to the RVI, and the next one to the anterior interface of the RPE. We find a first estimation of the posterior interface of the RPE at the first negative local minima of the intensity gradient below the anterior interface. Outliers are removed from each trace by fitting a 5<sup>th</sup> degree polynomial and discarding the points that differ from the fit by more than five times the median deviation. The discarded values are replaced using linear interpolation. Next, the center of the RPE in the anterior-posterior direction is localized more precisely and robustly with a graph search algorithm using all pixels between the anterior and posterior interfaces as nodes, and their corresponding pixel intensities as weights (<xref ref-type="fig" rid="f1">Fig. 1C</xref>). Finally, the posterior interface of the RPE is more precisely found at a fixed distance behind the RPE center, where we measure the shift distance by tracing a graph near the RPE but using the absolute value of the intensity slope as weight.</p>
      <p>Defining the BM as the convex hull of the RPE posterior interface permits an accurate delineation even when these layers get partially detached, as it is the case of several pathologies.</p>
    </sec>
    <sec disp-level="2">
      <title>Smoothing</title>
      <p>To increase the SNR, we perform a Gaussian smoothing operation in the transverse direction (<italic>y</italic>) throughout the whole volume using neighboring B-scans (<xref ref-type="fig" rid="f2">Fig. 2</xref>, left). This operation requires registering the images because the axial (z) position of the retina fluctuates between B-scans due to eye movements and accommodation (<xref ref-type="fig" rid="f2">Fig. 2</xref>, Raw).</p>
      <p>To do this we use the previously segmented BM as the registration reference, but since the shape of this layer varies between B-scans, the smoothing operation would blur its details. Therefore, we shift the individual A-scans that make up each B-scan to render the BM flat (<xref ref-type="fig" rid="f2">Fig. 2</xref>, Flattened) prior to registration. We compute the smoothed B-scans (<inline-formula id="d32e264"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e265" xlink:href="srep42112-m1.jpg"/></inline-formula>) by averaging flattened and registered adjacent images (<inline-formula id="d32e267"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e268" xlink:href="srep42112-m2.jpg"/></inline-formula>) using a Gaussian weight as follows</p>
      <p>
        <disp-formula id="eq3">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e272" xlink:href="srep42112-m3.jpg"/>
        </disp-formula>
      </p>
      <p>where <inline-formula id="d32e275"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e276" xlink:href="srep42112-m4.jpg"/></inline-formula>, <italic>σ</italic><sub><italic>x</italic></sub> is the Gaussian averaging parameter in the <italic>x</italic> direction, <italic>Δx</italic> is the pixel size in the <italic>x</italic> direction, <italic>Δy</italic> is the distance between B-scans, the operator <inline-formula id="d32e297"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e298" xlink:href="srep42112-m5.jpg"/></inline-formula> returns the smallest integer greater than or equal to its argument, and <inline-formula id="d32e300"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e301" xlink:href="srep42112-m6.jpg"/></inline-formula>. A Gaussian averaging in <italic>x</italic> and <italic>z</italic> directions is performed at a later step.</p>
    </sec>
    <sec disp-level="2">
      <title>CSI segmentation</title>
      <p>Using these SNR-improved B-scans, and extending on our previous work, the CSI is segmented on each B-scan using an algorithm based on graph searching<xref ref-type="bibr" rid="b25">25</xref>. First, the image is rescaled to the [0, 255] range, and smoothed in <italic>x</italic> and <italic>z</italic>, using a Gaussian low-pass filter with parameters (<italic>σ</italic><sub><italic>x</italic>,</sub>
<italic>σ</italic><sub><italic>z</italic></sub>). The candidate nodes of the graph are defined as the pixels where the derivative of the intensity with respect to <italic>z</italic> is greater than a predefined positive threshold and the absolute value of the second derivative is near zero (i.e. lower than another very small threshold). In other words, the nodes are defined as the inflexion points of the intensity in the z direction, which localize to the posterior walls of blood vessels where intensity transitions from dark to bright (<xref ref-type="fig" rid="f3">Fig. 3A</xref>) as the A-scan passes from vessel to sclera.</p>
      <p>For the graph-search we assign weights <italic>w(a,b</italic>) to the connections between nodes <italic>a</italic> and <italic>b</italic>, defined as:</p>
      <p>
        <disp-formula id="eq7">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e355" xlink:href="srep42112-m7.jpg"/>
        </disp-formula>
      </p>
      <p>The Euclidean distance between nodes <italic>w</italic><sub><italic>Euclid</italic></sub> favors connecting nodes close to each other. The jump penalties <italic>w</italic><sub><italic>z</italic></sub> and <italic>w</italic><sub><italic>x</italic></sub> are defined as</p>
      <p>
        <disp-formula id="eq8">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e378" xlink:href="srep42112-m8.jpg"/>
        </disp-formula>
      </p>
      <p>to discourage large leaps in <italic>z</italic> and <italic>x</italic> directions respectively, where <italic>A</italic><sub><italic>x</italic></sub>, <italic>A</italic><sub><italic>z</italic></sub>, <italic>T</italic><sub><italic>x</italic></sub>, <italic>T</italic><sub><italic>z</italic></sub>, and <italic>α</italic> are parameters and <italic>H(x</italic>) is the Heaviside step function. Finally, <italic>w</italic><sub><italic>Affin</italic></sub> favors bonds going through regions of high edge probability <italic>P(x,z</italic>). This probability is computed using the Gabor transform <inline-formula id="d32e428"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e429" xlink:href="srep42112-m9.jpg"/></inline-formula>, which provides an estimation of the derivative at the angle <italic>θ</italic> and at scale <italic>s</italic>. It is defined as the correlation between a Gabor function <inline-formula id="d32e437"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e438" xlink:href="srep42112-m10.jpg"/></inline-formula> and the image <italic>I</italic>, where</p>
      <p>
        <disp-formula id="eq11">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e446" xlink:href="srep42112-m11.jpg"/>
        </disp-formula>
      </p>
      <p>and (<italic>x</italic><sub><italic>θ</italic></sub>, <italic>z</italic><sub><italic>θ</italic></sub>) are coordinates in a system rotated by an angle <italic>θ</italic> with respect to (<italic>x, z</italic>) according to</p>
      <p>
        <disp-formula id="eq12">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e469" xlink:href="srep42112-m12.jpg"/>
        </disp-formula>
      </p>
      <p>where <italic>R</italic><sub><italic>θ</italic></sub> is a rotation operator. The edge probability is finally computed pixelwise as</p>
      <p>
        <disp-formula id="eq13">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e481" xlink:href="srep42112-m13.jpg"/>
        </disp-formula>
      </p>
      <p>where the maximum is taken from a set of Gabor transforms at angles in a range [−20<sup>o</sup>, 20<sup>o</sup>] around the positive <italic>z</italic> direction, and scales in the range [10 <italic>μ</italic>m, 20 <italic>μ</italic>m]. The probability is normalized to the range [0, 1] (<xref ref-type="fig" rid="f3">Fig. 3B</xref>). The weight <italic>w</italic><sub><italic>Affin</italic></sub> is computed as 1/<italic>A</italic>, where <italic>A</italic> is the line integral of <italic>P(x,z</italic>) along pixels in a straight line <italic>L</italic> connecting nodes <italic>a</italic> and <italic>b</italic> as</p>
      <p>
        <disp-formula id="eq14">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e530" xlink:href="srep42112-m14.jpg"/>
        </disp-formula>
      </p>
      <p>Only nodes spaced less than 5<italic>T</italic><sub><italic>z</italic></sub> in <italic>z</italic> and 5<italic>T</italic><sub><italic>x</italic></sub> in <italic>x</italic> were allowed to connect.</p>
      <p>For the start and end nodes, we added two virtual nodes before the first and after the last columns respectively. The minimum weight path through the graph is found using the Dijkstra’s algorithm<xref ref-type="bibr" rid="b27">27</xref> (<xref ref-type="fig" rid="f3">Fig. 3C</xref>).</p>
      <p>Sometimes, however, only a few vessels are clearly visible in the B-Scan, and the number of candidate nodes found is not enough to produce a whole trace across the B-scan. In order to profit from those nodes detected, and when a full-length trace fails, we subdivide the graph into connected fragments and search for the shortest path within each fragment. We use Tarjan’s algorithm for the subdivision<xref ref-type="bibr" rid="b28">28</xref>, and after running Dijkstra’s algorithm on each sub graph the resulting path segments are analyzed for consistency. This involves identifying regions in the <italic>x</italic> axis where some segments overlap, and discarding unlikely segments to avoid superposition.</p>
      <p>To make this choice, we assign weights to each segment based on their edge likelihood, computed as follows:</p>
      <p>
        <disp-formula id="eq15">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e569" xlink:href="srep42112-m15.jpg"/>
        </disp-formula>
      </p>
      <p>where <italic>W</italic><sub><italic>sum</italic></sub> is the sum of the edge probability <italic>P</italic> (<xref ref-type="disp-formula" rid="eq13">eq. 2</xref>) along all nodes, <italic>W</italic><sub><italic>mean</italic></sub> is the mean probability, <italic>W</italic><sub><italic>height</italic></sub> is one over the mean height of the segment in <italic>z</italic>, and <italic>A</italic><sub><italic>s</italic></sub>, <italic>A</italic><sub><italic>m</italic></sub>, and <italic>A</italic><sub><italic>h</italic></sub> are arbitrary coefficients adding up to one. The CSI is finally computed by joining the nodes from the remaining path segments.</p>
      <p>The choroidal thickness is computed at each node as the distance between BM and CSI. After computing the value for all nodes from every B-Scan, we use the 2D natural neighbor interpolation method to estimate the thickness of the choroid on a grid of points within the limits defined by the position of the B-scans on the fundus of the eye (<xref ref-type="fig" rid="f3">Fig. 3D</xref>)<xref ref-type="bibr" rid="b29">29</xref>.</p>
    </sec>
  </sec>
  <sec disp-level="1">
    <title>Results</title>
    <sec disp-level="2">
      <title>Performance analysis</title>
      <p>Despite a robust design, the performance of the method depends on image quality and on the health of the retina. Very low signal-to-noise-ratio images, retinas containing large amounts of drusen, or significant damage to the RPE may hinder successful segmentation. Cases where medical specialists are unable to distinguish retinal layers are rarely traced accurately by the software. For images with low signal to noise ratio, or where choroidal vessels are not well defined, CSI segmentation fails at a higher rate.</p>
      <p>For an overall assessment of the segmentation success rate, we applied the method to an image database of 280 patients with various eye conditions from the ophthalmology clinic at the Maisonneuve-Rosemont Hospital, Montreal, Québec, Canada. The study protocol adhered to standards outlined in the Declaration of Helsinki, and all participants signed an informed consent approved by the “Comité d'éthique de la recherche de l’installation de l’Hôpital Maisonneuve-Rosemont du CIUSSS de l’Est-de-l’Île-de-Montréal”. We have examined all maps visually, and guided by outlier regions in the thickness maps we have identified 65 problematic cases. Of these 65 cases, the source of inaccurate map generation resulted from incorrect BM segmentation and CSI segmentation failure in 38 and 27 maps respectively, evenly distributed among patient cohorts (<xref ref-type="fig" rid="f4">Fig. 4A</xref>).</p>
      <p>In the 215 successfully reconstructed maps, we additionally studied the fraction of B-scans successfully segmented. All of these reconstructions showed accurate delineation of the BM. As for the CSI, we calculated the number of B-scans in a map where at least one CSI segment containing at least 4 nodes was found, and plotted this distribution in <xref ref-type="fig" rid="f4">Fig. 4B</xref>, grouped by disease. For all patient cohorts, the mean successful fraction is always above 96% with standard deviation below 5%. Notably, there is a larger fraction of B-scan segmentation errors for AMD patients (3.5%) compared to normal subjects (1.5%). This 2% difference between AMD and Normal patients is completely due to errors in BM detection (2.5% for AMD and 0.5% for normals), where the segmentation process is hampered by strongly damaged RPE layers.</p>
    </sec>
    <sec disp-level="2">
      <title>Validation of segmentation</title>
      <p>We have also validated the method quantitatively by comparing our results with both manual segmentations and the commercial software included in Heidelberg Spectralis OCTs. Since there is no gold standard for assessing the accuracy of segmentation of the retinal layers, we defined as ground truth the tracings made by experienced eye-specialists<xref ref-type="bibr" rid="b25">25</xref>.</p>
      <p>To produce manual segmentations, we selected 30 B-Scans at random from a list of patients with diverse conditions including wet and early AMD, glaucoma, uveitis and normal (healthy) subjects; these 30 raw B-Scans were presented sequentially and twice over (once for tracing the BM and once for the CSI) to a group of 5 independent evaluators who were asked to delineate the layers manually. The evaluators manually segmented the BM and the CSI directly on the touch screen of a tablet computer (Samsung Galaxy Note 10.1, Model SM-P600), using a stylus pen. The two traces were drawn using pre-set colors and analyzed to extract the manual segmentations.</p>
      <p>In order to compensate for inter-subject variability, we defined the ground truth for a particular layer as the mean trace among the five evaluators (<xref ref-type="fig" rid="f5">Fig. 5A</xref>), and all segmentation algorithms and individual evaluators are compared to this average (<xref ref-type="fig" rid="f5">Fig. 5B</xref>–D). The process starts by localizing the pixels displaying the annotation color (<italic>x</italic><sub><italic>c</italic></sub>, <italic>z</italic><sub><italic>c</italic></sub>). At each column <italic>x</italic><sub><italic>c</italic></sub> we compute the mean <inline-formula id="d32e680"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e681" xlink:href="srep42112-m16.jpg"/></inline-formula> and standard deviation <inline-formula id="d32e683"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e684" xlink:href="srep42112-m17.jpg"/></inline-formula> to estimate the position and thickness of the trace in each column. The line thickness is estimated as <inline-formula id="d32e686"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e687" xlink:href="srep42112-m18.jpg"/></inline-formula> across all columns. After discarding columns where <inline-formula id="d32e689"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e690" xlink:href="srep42112-m19.jpg"/></inline-formula>, we obtained the trace coordinates (<italic>x</italic><sub><italic>s</italic></sub>, <italic>z</italic><sub><italic>s</italic></sub>) by interpolating the remaining <inline-formula id="d32e705"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e706" xlink:href="srep42112-m20.jpg"/></inline-formula> with splines (<xref ref-type="fig" rid="f5">Fig. 5A</xref>).</p>
      <p>The traces produced by the five subjects were averaged at each column to render the ground truth trace <inline-formula id="d32e713"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e714" xlink:href="srep42112-m21.jpg"/></inline-formula> as shown in <xref ref-type="fig" rid="f5">Fig. 5A</xref>. When assessing the segmentation accuracy of both manual and automated methods for a given B-scan, we computed the distance between any particular trace and the corresponding ground truth at each column (A-Scan) for all images, and we analyzed the statistical distribution of these distances. In <xref ref-type="fig" rid="f5">Fig. 5C and D</xref> (for the BM and CSI respectively), we plotted the distribution of deviations from the ground truth for all the evaluators, our method, and the Spectralis commercial software.</p>
      <p>The distribution of deviations for the commercial software and our method is largely equivalent to manual evaluators regarding segmentation of the BM, where all distributions medians are smaller than 6 μm. For the CSI, the performance of our method is similar to manual segmentation (all medians are smaller than 11 μm), whereas the commercial software produces larger deviations (more than 30 μm. See <xref ref-type="fig" rid="f5">Fig. 5D</xref>), possibly due to over-smoothing (as appreciated in <xref ref-type="fig" rid="f5">Fig. 5B</xref>).</p>
    </sec>
    <sec disp-level="2">
      <title>Three-dimensional study of the choroid</title>
      <p>Three-dimensional information permits the study of the choroid along new, unexplored avenues. Our open algorithm provides a reliable tool for approaching these studies on large patient databases, which are in turn necessary to uncover novel disease biomarkers with statistical significance.</p>
      <p>In order to illustrate this, we applied the algorithm to a database of 215 patients (129 women and 86 men), spanning a range of ocular disease (63 normal, 43 AMD, 76 OAG, 28 Uveitis, 14 Other). The average age of the cohort is 68 years old with a standard deviation of 11. The image dataset consists of OCT scans over square regions (7.5 × 7.5 mm<sup>2</sup>) approximately centered at the macula (<xref ref-type="fig" rid="f6">Fig. 6A</xref>), composed of either 50 (101 volumes) or 192 B-scans (114 volumes) spaced accordingly.</p>
      <p>We have analyzed the resulting choroidal thickness maps in circular regions centered at the macula (<xref ref-type="fig" rid="f6">Fig. 6A</xref>). By subtracting the RVI from the BM traces in every B-Scan, we have built a map of retinal thickness (<xref ref-type="fig" rid="f6">Fig. 6A</xref>), and we found the coordinates of the local minimum to locate the center of the macula. The largest possible circle centered on this minimum and still bounded by the original scanned region was used as region of interest in every calculation. Overall, the mean diameter of these circles is 5.3 mm, with standard deviation of 0.4 mm, and a minimum value of 3 mm.</p>
      <p>Maps consist of a set of scattered points (<italic>x</italic><sub><italic>k</italic></sub>,<italic>y</italic><sub><italic>k</italic></sub>) within the circular region indicating choroidal thickness (<italic>Δz</italic><sub><italic>k</italic></sub>), and a weight (<italic>W</italic><sub><italic>k</italic></sub>) calculated as the edge probability P defined by <xref ref-type="disp-formula" rid="eq13">eq. 2</xref>. Using this dataset, we have computed a set of anatomical descriptors.</p>
      <p>First we have calculated the mean choroidal thickness using a weighted average as follows</p>
      <p>
        <disp-formula id="eq22">
          <inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e785" xlink:href="srep42112-m22.jpg"/>
        </disp-formula>
      </p>
      <p>We observe that the average thickness correlates negatively with age (<xref ref-type="fig" rid="f6">Fig. 6B</xref>, R<sup>2</sup> = 0.17, p = 10<sup>−10</sup>), and decreases approximately 23 μm per decade, similar to what has been previously reported using manual measurements on single-scan OCT images (10 μm/decade<xref ref-type="bibr" rid="b30">30</xref>, 15.6 μm/decade<xref ref-type="bibr" rid="b31">31</xref>, and 14 μm/decade<xref ref-type="bibr" rid="b32">32</xref>). Similarly, when only normal patients are considered, the choroid mean thickness decreases 27 μm per decade (R<sup>2</sup> = 0.16, p = 10<sup>−3</sup>) suggesting that this measurement is not biased by age related pathologies.</p>
      <p>We have also fit a plane (2D first-degree polynomial) to the thickness map, as illustrated in <xref ref-type="fig" rid="f6">Fig. 6C</xref>, and analyzed the distribution of the angles <italic>θ</italic> (polar) and <italic>ϕ</italic> (azimuthal) describing the direction of the vector normal to such plane. These values indicate the tilt and orientation of choroidal thickness. <xref ref-type="fig" rid="f6">Figure 6D</xref> shows a normalized histogram of the azimuthal angle, oriented to the inferior-nasal quadrant, which reflects that the choroid is thinner in this region. Barteselli <italic>et al</italic>. have reported results consistent with this observation using manual segmentation of OCT volumes. They report that the nasal quadrant has the lowest choroidal volume, and the superior quadrant presents the highest<xref ref-type="bibr" rid="b33">33</xref>. We have also computed the distribution of thickness contrasts between the inferior-nasal and the superior-temporal quadrants (<xref ref-type="fig" rid="f6">Fig. 6F</xref>), along with the contrast between the superior-nasal and the inferior-temporal (<xref ref-type="fig" rid="f6">Fig. 6G</xref>), which confirm the results in <xref ref-type="fig" rid="f6">Fig. 6D</xref>.</p>
    </sec>
  </sec>
  <sec disp-level="1">
    <title>Discussion</title>
    <p>The vast majority of studies based on choroidal thickness maps published so far, which will become seminal for the determination of therapeutic decisions, are based on software black boxes. Due to the variety of eye pathology, the diversity of tissue shapes, and the limitations on image quality (particularly in elderly patients), it is rare that a single piece of software performs optimally in all cases. Open-source algorithms, such as the one we present here, provide the necessary flexibility and freedom as well as long term public support, whereas proprietary software packaged exclusively with new hardware hinders progress in a field in which manual measurements of large cohorts is not a feasible segmentation alternative.</p>
    <p>The segmentation strategy we present also possesses some compelling characteristics. Although the CSI segmentation is based on graph theory, it does not require a fully connected path across an entire B-scan to be successful. Given the tortuosity and variable reflectivity of blood vessels in the choroid, sometimes only a few of them are visible in the images; it is therefore beneficial to make use of all available information to reconstruct the topography. The approach also benefits from averaging adjacent B-Scans to obtain higher signal-to-noise-ratio images for improved segmentation results.</p>
    <p>Additionally, although a 2D scattered interpolation is used to build the visual representation of the maps, quantifications are based solely on detected graph nodes weighted by the edge probability, preventing interpolation artifacts from interfering with results.</p>
    <p>The method is also highly robust, overcoming to a large extent the segmentation challenges posed by tissue anomalies such as drusen and RPE discontinuities, and by low quality images. This is reflected in the high number of correctly segmented maps (<xref ref-type="fig" rid="f4">Fig. 4A</xref>), and it is explained by the substantial fraction of successfully segmented B-Scans per volume (<xref ref-type="fig" rid="f4">Fig. 4B</xref>). Validation against manual tracing demonstrates that the segmentation accuracy performs at least as well as specialists, and it outperforms the software provided by the very device used to capture its input images.</p>
    <p>The software we provide is coded in Matlab, which is multiplatform and is widely used for quantitative analysis of biomedical studies. The code has been tested on Matlab R2014b for OSX El Capitan 64bits, Matlab R2014a for Linux 64 bits, and Matlab 2013b for Windows 10 64 bits.</p>
    <p>The systematic analysis of the role of the deepest layers of the eye in the pathogenesis of disease is becoming the focus of an impressive number of studies. Beyond average choroidal thickness, the analysis of 3-dimensional surfaces opens the door to a panoply of local and global descriptors that may correlate with ocular physiology, and which are presently unexplored. Accurate and flexible tools for delineation of the choroid are essential to find these anatomical and functional biomarkers of the progression and outcome of blinding disorders.</p>
  </sec>
  <sec disp-level="1">
    <title>Additional Information</title>
    <p><bold>How to cite this article:</bold> Mazzaferri, J. <italic>et al</italic>. Open-source algorithm for automatic choroid segmentation of OCT volume reconstructions. <italic>Sci. Rep.</italic>
<bold>7</bold>, 42112; doi: 10.1038/srep42112 (2017).</p>
    <p><bold>Publisher's note:</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
  </sec>
</body>
<back>
  <ack>
    <p>This works was partially supported the Canadian Institutes of Health Research (CIHR) and Fonds Veroneau Troutman. DNS is a recipient of Vision Health Research Network (VHRN) Graduate Student Performance Award. GH is recipient of a Research training grant from Fonds de Recherche du Québec – Santé (FRQS) and VHRN, and a scholarship from the Natural Sciences and Engineering Research Council of Canada (NSERC) – Collaborative Research and Training Experience Program (CREATE): Training Program in Neuroengineering. SC holds an FRQS Chercheur Junior 2 award.</p>
  </ack>
  <ref-list>
    <ref id="b1">
      <mixed-citation publication-type="journal"><name><surname>Chhablani</surname><given-names>J.</given-names></name>, <name><surname>Wong</surname><given-names>I. Y.</given-names></name> &amp; <name><surname>Kozak</surname><given-names>I.</given-names></name>
<article-title>Choroidal imaging: A review</article-title>. <source>Saudi J Ophthalmol</source>
<volume>28</volume>, <fpage>123</fpage>–<lpage>128</lpage>, doi: <pub-id pub-id-type="doi">10.1016/j.sjopt.2014.03.004</pub-id> (<year>2014</year>).<pub-id pub-id-type="pmid">24843305</pub-id></mixed-citation>
    </ref>
    <ref id="b2">
      <mixed-citation publication-type="journal"><name><surname>Esmaeelpour</surname><given-names>M.</given-names></name><etal/>. <article-title>Choroidal thinning in diabetes type 1 detected by 3-dimensional 1060 nm optical coherence tomography</article-title>. <source>Invest Ophthalmol Vis Sci</source><volume>53</volume>, <fpage>6803</fpage>–<lpage>6809</lpage>, doi: <pub-id pub-id-type="doi">10.1167/iovs.12-10314</pub-id> (<year>2012</year>).<pub-id pub-id-type="pmid">22952126</pub-id></mixed-citation>
    </ref>
    <ref id="b3">
      <mixed-citation publication-type="journal"><name><surname>Esmaeelpour</surname><given-names>M.</given-names></name><etal/>. <article-title>Mapping choroidal and retinal thickness variation in type 2 diabetes using three-dimensional 1060-nm optical coherence tomography</article-title>. <source>Invest Ophthalmol Vis Sci</source><volume>52</volume>, <fpage>5311</fpage>–<lpage>5316</lpage>, doi: <pub-id pub-id-type="doi">10.1167/iovs.10-6875</pub-id> (<year>2011</year>).<pub-id pub-id-type="pmid">21508108</pub-id></mixed-citation>
    </ref>
    <ref id="b4">
      <mixed-citation publication-type="journal"><name><surname>Lindner</surname><given-names>M.</given-names></name><etal/>. <article-title>Choroidal thickness in geographic atrophy secondary to age-related macular degeneration</article-title>. <source>Invest Ophthalmol Vis Sci</source><volume>56</volume>, <fpage>875</fpage>–<lpage>882</lpage>, doi: <pub-id pub-id-type="doi">10.1167/iovs.14-14933</pub-id> (<year>2015</year>).<pub-id pub-id-type="pmid">25587059</pub-id></mixed-citation>
    </ref>
    <ref id="b5">
      <mixed-citation publication-type="journal"><name><surname>Ohsugi</surname><given-names>H.</given-names></name>, <name><surname>Ikuno</surname><given-names>Y.</given-names></name>, <name><surname>Oshima</surname><given-names>K.</given-names></name> &amp; <name><surname>Tabuchi</surname><given-names>H.</given-names></name>
<article-title>3-D choroidal thickness maps from EDI-OCT in highly myopic eyes</article-title>. <source>Optom Vis Sci</source>
<volume>90</volume>, <fpage>599</fpage>–<lpage>606</lpage>, doi: <pub-id pub-id-type="doi">10.1097/OPX.0b013e3182924017</pub-id> (<year>2013</year>).<pub-id pub-id-type="pmid">23604298</pub-id></mixed-citation>
    </ref>
    <ref id="b6">
      <mixed-citation publication-type="journal"><name><surname>Anderson</surname><given-names>M. F.</given-names></name>, <name><surname>Ramasamy</surname><given-names>B.</given-names></name>, <name><surname>Lythgoe</surname><given-names>D. T.</given-names></name> &amp; <name><surname>Clark</surname><given-names>D.</given-names></name>
<article-title>Choroidal thickness in regressed retinopathy of prematurity</article-title>. <source>Eye (Lond)</source>
<volume>28</volume>, <fpage>1461</fpage>–<lpage>1468</lpage>, doi: <pub-id pub-id-type="doi">10.1038/eye.2014.207</pub-id> (<year>2014</year>).<pub-id pub-id-type="pmid">25277303</pub-id></mixed-citation>
    </ref>
    <ref id="b7">
      <mixed-citation publication-type="journal"><name><surname>Shao</surname><given-names>Z.</given-names></name><etal/>. <article-title>Choroidal involution is a key component of oxygen-induced retinopathy</article-title>. <source>Invest Ophthalmol Vis Sci</source><volume>52</volume>, <fpage>6238</fpage>–<lpage>6248</lpage>, doi: <pub-id pub-id-type="doi">10.1167/iovs.10-6742</pub-id> (<year>2011</year>).<pub-id pub-id-type="pmid">21546530</pub-id></mixed-citation>
    </ref>
    <ref id="b8">
      <mixed-citation publication-type="journal"><name><surname>Wu</surname><given-names>W. C.</given-names></name><etal/>. <article-title>Choroidal thickness in patients with a history of retinopathy of prematurity</article-title>. <source>JAMA Ophthalmol</source><volume>131</volume>, <fpage>1451</fpage>–<lpage>1458</lpage>, doi: <pub-id pub-id-type="doi">10.1001/jamaophthalmol.2013.5052</pub-id> (<year>2013</year>).<pub-id pub-id-type="pmid">24077425</pub-id></mixed-citation>
    </ref>
    <ref id="b9">
      <mixed-citation publication-type="journal"><name><surname>Baltmr</surname><given-names>A.</given-names></name>, <name><surname>Lightman</surname><given-names>S.</given-names></name> &amp; <name><surname>Tomkins-Netzer</surname><given-names>O.</given-names></name>
<article-title>Examining the choroid in ocular inflammation: a focus on enhanced depth imaging</article-title>. <source>J Ophthalmol</source>
<volume>2014</volume>, <fpage>459136</fpage>, doi: <pub-id pub-id-type="doi">10.1155/2014/459136</pub-id> (<year>2014</year>).<pub-id pub-id-type="pmid">25024846</pub-id></mixed-citation>
    </ref>
    <ref id="b10">
      <mixed-citation publication-type="journal"><name><surname>Razavi</surname><given-names>S.</given-names></name>, <name><surname>Souied</surname><given-names>E. H.</given-names></name>, <name><surname>Darvizeh</surname><given-names>F.</given-names></name> &amp; <name><surname>Querques</surname><given-names>G.</given-names></name>
<article-title>Assessment of Choroidal Topographic Changes by Swept-Source Optical Coherence Tomography After Intravitreal Ranibizumab for Exudative Age-Related Macular Degeneration</article-title>. <source>Am J Ophthalmol</source>
<volume>160</volume>, <fpage>1006</fpage>–<lpage>1013</lpage>, doi: <pub-id pub-id-type="doi">10.1016/j.ajo.2015.08.009</pub-id> (<year>2015</year>).<pub-id pub-id-type="pmid">26275471</pub-id></mixed-citation>
    </ref>
    <ref id="b11">
      <mixed-citation publication-type="journal"><name><surname>Yiu</surname><given-names>G.</given-names></name>, <name><surname>Manjunath</surname><given-names>V.</given-names></name>, <name><surname>Chiu</surname><given-names>S. J.</given-names></name>, <name><surname>Farsiu</surname><given-names>S.</given-names></name> &amp; <name><surname>Mahmoud</surname><given-names>T. H.</given-names></name>
<article-title>Effect of anti-vascular endothelial growth factor therapy on choroidal thickness in diabetic macular edema</article-title>. <source>Am J Ophthalmol</source>
<volume>158</volume>, <fpage>745</fpage>–<lpage>751</lpage> e742, doi: <pub-id pub-id-type="doi">10.1016/j.ajo.2014.06.006</pub-id> (<year>2014</year>).<pub-id pub-id-type="pmid">24952275</pub-id></mixed-citation>
    </ref>
    <ref id="b12">
      <mixed-citation publication-type="journal"><name><surname>Verner-Cole</surname><given-names>E. A.</given-names></name><etal/>. <article-title>Retinal and Choroidal Imaging With 870-nm Spectral-Domain OCT Compared With 1050-nm Spectral-Domain OCT, With and Without Enhanced Depth Imaging</article-title>. <source>Transl Vis Sci Technol</source><volume>3</volume>, <fpage>3</fpage>, doi: <pub-id pub-id-type="doi">10.1167/tvst.3.3.3</pub-id> (<year>2014</year>).</mixed-citation>
    </ref>
    <ref id="b13">
      <mixed-citation publication-type="journal"><name><surname>Tan</surname><given-names>C. S.</given-names></name>, <name><surname>Cheong</surname><given-names>K. X.</given-names></name>, <name><surname>Lim</surname><given-names>L. W.</given-names></name> &amp; <name><surname>Sadda</surname><given-names>S. R.</given-names></name>
<article-title>Comparison of macular choroidal thicknesses from swept source and spectral domain optical coherence tomography</article-title>. <source>Br J Ophthalmol</source>, doi: <pub-id pub-id-type="doi">10.1136/bjophthalmol-2015-307541</pub-id> (<year>2015</year>).</mixed-citation>
    </ref>
    <ref id="b14">
      <mixed-citation publication-type="journal"><name><surname>Haas</surname><given-names>P.</given-names></name>, <name><surname>Esmaeelpour</surname><given-names>M.</given-names></name>, <name><surname>Ansari-Shahrezaei</surname><given-names>S.</given-names></name>, <name><surname>Drexler</surname><given-names>W.</given-names></name> &amp; <name><surname>Binder</surname><given-names>S.</given-names></name>
<article-title>Choroidal thickness in patients with reticular pseudodrusen using 3D 1060-nm OCT maps</article-title>. <source>Invest Ophthalmol Vis Sci</source>
<volume>55</volume>, <fpage>2674</fpage>–<lpage>2681</lpage>, doi: <pub-id pub-id-type="doi">10.1167/iovs.13-13338</pub-id> (<year>2014</year>).<pub-id pub-id-type="pmid">24651554</pub-id></mixed-citation>
    </ref>
    <ref id="b15">
      <mixed-citation publication-type="journal"><name><surname>Harb</surname><given-names>E.</given-names></name><etal/>. <article-title>Choroidal Thickness Profiles in Myopic Eyes of Young Adults in the Correction of Myopia Evaluation Trial Cohort</article-title>. <source>Am J Ophthalmol</source><volume>160</volume>, <fpage>62</fpage>–<lpage>71</lpage> e62, doi: <pub-id pub-id-type="doi">10.1016/j.ajo.2015.04.018</pub-id> (<year>2015</year>).<pub-id pub-id-type="pmid">25896460</pub-id></mixed-citation>
    </ref>
    <ref id="b16">
      <mixed-citation publication-type="journal"><name><surname>Mwanza</surname><given-names>J. C.</given-names></name>, <name><surname>Hochberg</surname><given-names>J. T.</given-names></name>, <name><surname>Banitt</surname><given-names>M. R.</given-names></name>, <name><surname>Feuer</surname><given-names>W. J.</given-names></name> &amp; <name><surname>Budenz</surname><given-names>D. L.</given-names></name>
<article-title>Lack of association between glaucoma and macular choroidal thickness measured with enhanced depth-imaging optical coherence tomography</article-title>. <source>Invest Ophthalmol Vis Sci</source>
<volume>52</volume>, <fpage>3430</fpage>–<lpage>3435</lpage>, doi: <pub-id pub-id-type="doi">10.1167/iovs.10-6600</pub-id> (<year>2011</year>).<pub-id pub-id-type="pmid">21357398</pub-id></mixed-citation>
    </ref>
    <ref id="b17">
      <mixed-citation publication-type="journal"><name><surname>Yiu</surname><given-names>G.</given-names></name><etal/>. <article-title>Relationship of central choroidal thickness with age-related macular degeneration status</article-title>. <source>Am J Ophthalmol</source><volume>159</volume>, <fpage>617</fpage>–<lpage>626</lpage>, doi: <pub-id pub-id-type="doi">10.1016/j.ajo.2014.12.010</pub-id> (<year>2015</year>).<pub-id pub-id-type="pmid">25526948</pub-id></mixed-citation>
    </ref>
    <ref id="b18">
      <mixed-citation publication-type="journal"><name><surname>Zhang</surname><given-names>L.</given-names></name><etal/>. <article-title>Automated segmentation of the choroid from clinical SD-OCT</article-title>. <source>Invest Ophthalmol Vis Sci</source><volume>53</volume>, <fpage>7510</fpage>–<lpage>7519</lpage>, doi: <pub-id pub-id-type="doi">10.1167/iovs.12-10311</pub-id> (<year>2012</year>).<pub-id pub-id-type="pmid">23060139</pub-id></mixed-citation>
    </ref>
    <ref id="b19">
      <mixed-citation publication-type="journal"><name><surname>Gerendas</surname><given-names>B. S.</given-names></name><etal/>. <article-title>Three-dimensional automated choroidal volume assessment on standard spectral-domain optical coherence tomography and correlation with the level of diabetic macular edema</article-title>. <source>Am J Ophthalmol</source><volume>158</volume>, <fpage>1039</fpage>–<lpage>1048</lpage>, doi: <pub-id pub-id-type="doi">10.1016/j.ajo.2014.08.001</pub-id> (<year>2014</year>).<pub-id pub-id-type="pmid">25127697</pub-id></mixed-citation>
    </ref>
    <ref id="b20">
      <mixed-citation publication-type="journal"><name><surname>Kajic</surname><given-names>V.</given-names></name><etal/>. <article-title>Automated three-dimensional choroidal vessel segmentation of 3D 1060 nm OCT retinal data</article-title>. <source>Biomed Opt Express</source><volume>4</volume>, <fpage>134</fpage>–<lpage>150</lpage>, doi: <pub-id pub-id-type="doi">10.1364/BOE.4.000134</pub-id> (<year>2013</year>).<pub-id pub-id-type="pmid">23304653</pub-id></mixed-citation>
    </ref>
    <ref id="b21">
      <mixed-citation publication-type="journal"><name><surname>Kajic</surname><given-names>V.</given-names></name><etal/>. <article-title>Automated choroidal segmentation of 1060 nm OCT in healthy and pathologic eyes using a statistical model</article-title>. <source>Biomed Opt Express</source><volume>3</volume>, <fpage>86</fpage>–<lpage>103</lpage>, doi: <pub-id pub-id-type="doi">10.1364/BOE.3.000086</pub-id> (<year>2012</year>).<pub-id pub-id-type="pmid">22254171</pub-id></mixed-citation>
    </ref>
    <ref id="b22">
      <mixed-citation publication-type="journal"><name><surname>Esmaeelpour</surname><given-names>M.</given-names></name><etal/>. <article-title>Choroidal Haller’s and Sattler’s layer thickness measurement using 3-dimensional 1060-nm optical coherence tomography</article-title>. <source>PLoS One</source><volume>9</volume>, <fpage>e99690</fpage>, doi: <pub-id pub-id-type="doi">10.1371/journal.pone.0099690</pub-id> (<year>2014</year>).<pub-id pub-id-type="pmid">24911446</pub-id></mixed-citation>
    </ref>
    <ref id="b23">
      <mixed-citation publication-type="journal"><name><surname>Chiu</surname><given-names>S. J.</given-names></name><etal/>. <article-title>Validated automatic segmentation of AMD pathology including drusen and geographic atrophy in SD-OCT images</article-title>. <source>Invest Ophthalmol Vis Sci</source><volume>53</volume>, <fpage>53</fpage>–<lpage>61</lpage>, doi: <pub-id pub-id-type="doi">10.1167/iovs.11-7640</pub-id> (<year>2012</year>).<pub-id pub-id-type="pmid">22039246</pub-id></mixed-citation>
    </ref>
    <ref id="b24">
      <mixed-citation publication-type="journal"><name><surname>Zhang</surname><given-names>L.</given-names></name><etal/>. <article-title>Validity of Automated Choroidal Segmentation in SS-OCT and SD-OCT</article-title>. <source>Invest Ophthalmol Vis Sci</source><volume>56</volume>, <fpage>3202</fpage>–<lpage>3211</lpage>, doi: <pub-id pub-id-type="doi">10.1167/iovs.14-15669</pub-id> (<year>2015</year>).<pub-id pub-id-type="pmid">26024104</pub-id></mixed-citation>
    </ref>
    <ref id="b25">
      <mixed-citation publication-type="journal"><name><surname>Beaton</surname><given-names>L.</given-names></name><etal/>. <article-title>Non-invasive measurement of choroidal volume change and ocular rigidity through automated segmentation of high-speed OCT imaging</article-title>. <source>Biomed Opt Express</source><volume>6</volume>, <fpage>1694</fpage>–<lpage>1706</lpage>, doi: <pub-id pub-id-type="doi">10.1364/BOE.6.001694</pub-id> (<year>2015</year>).<pub-id pub-id-type="pmid">26137373</pub-id></mixed-citation>
    </ref>
    <ref id="b26">
      <mixed-citation publication-type="other"><italic>GNU General Public Licence. Version 3</italic>, <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="https://www.gnu.org/licenses/gpl-3.0.en.html">https://www.gnu.org/licenses/gpl-3.0.en.html</ext-link> (<year>2007</year>).</mixed-citation>
    </ref>
    <ref id="b27">
      <mixed-citation publication-type="journal"><name><surname>Dijkstra</surname><given-names>E. W.</given-names></name><article-title>A note on two problems in connexion with graphs</article-title>. <source>Numerische Mathematik</source><volume>1</volume>, <fpage>269</fpage>–<lpage>271</lpage> (<year>1959</year>).</mixed-citation>
    </ref>
    <ref id="b28">
      <mixed-citation publication-type="journal"><name><surname>Tarjan</surname><given-names>R.</given-names></name><article-title>Depth-First Search and Linear Graph Algorithms</article-title>. <source>SIAM Journal on Computing</source><volume>1</volume>, <fpage>146</fpage>–<lpage>160</lpage>, doi: <pub-id pub-id-type="doi">10.1137/0201010</pub-id> (<year>1972</year>).</mixed-citation>
    </ref>
    <ref id="b29">
      <mixed-citation publication-type="journal"><name><surname>Sibson</surname><given-names>R.</given-names></name><article-title>A vector identity for the Dirichlet tessellation</article-title>. <source>Mathematical Proceedings of the Cambridge Philosophical Society</source><volume>87</volume>, <fpage>151</fpage>–<lpage>155</lpage>, doi: <pub-id pub-id-type="doi">10.1017/S0305004100056589</pub-id> (<year>1980</year>).</mixed-citation>
    </ref>
    <ref id="b30">
      <mixed-citation publication-type="journal"><name><surname>Ruiz-Medrano</surname><given-names>J.</given-names></name><etal/>. <article-title>Macular choroidal thickness profile in a healthy population measured by swept-source optical coherence tomography</article-title>. <source>Invest Ophthalmol Vis Sci</source><volume>55</volume>, <fpage>3532</fpage>–<lpage>3542</lpage>, doi: <pub-id pub-id-type="doi">10.1167/iovs.14-13868</pub-id> (<year>2014</year>).<pub-id pub-id-type="pmid">24845638</pub-id></mixed-citation>
    </ref>
    <ref id="b31">
      <mixed-citation publication-type="journal"><name><surname>Margolis</surname><given-names>R.</given-names></name> &amp; <name><surname>Spaide</surname><given-names>R. F.</given-names></name>
<article-title>A pilot study of enhanced depth imaging optical coherence tomography of the choroid in normal eyes</article-title>. <source>Am J Ophthalmol</source>
<volume>147</volume>, <fpage>811</fpage>–<lpage>815</lpage>, doi: <pub-id pub-id-type="doi">10.1016/j.ajo.2008.12.008</pub-id> (<year>2009</year>).<pub-id pub-id-type="pmid">19232559</pub-id></mixed-citation>
    </ref>
    <ref id="b32">
      <mixed-citation publication-type="journal"><name><surname>Ikuno</surname><given-names>Y.</given-names></name>, <name><surname>Kawaguchi</surname><given-names>K.</given-names></name>, <name><surname>Nouchi</surname><given-names>T.</given-names></name> &amp; <name><surname>Yasuno</surname><given-names>Y.</given-names></name>
<article-title>Choroidal thickness in healthy Japanese subjects</article-title>. <source>Invest Ophthalmol Vis Sci</source>
<volume>51</volume>, <fpage>2173</fpage>–<lpage>2176</lpage>, doi: <pub-id pub-id-type="doi">10.1167/iovs.09-4383</pub-id> (<year>2010</year>).<pub-id pub-id-type="pmid">19892874</pub-id></mixed-citation>
    </ref>
    <ref id="b33">
      <mixed-citation publication-type="journal"><name><surname>Barteselli</surname><given-names>G.</given-names></name><etal/>. <article-title>Choroidal volume variations with age, axial length, and sex in healthy subjects: a three-dimensional analysis</article-title>. <source>Ophthalmology</source><volume>119</volume>, <fpage>2572</fpage>–<lpage>2578</lpage>, doi: <pub-id pub-id-type="doi">10.1016/j.ophtha.2012.06.065</pub-id> (<year>2012</year>).<pub-id pub-id-type="pmid">22921388</pub-id></mixed-citation>
    </ref>
  </ref-list>
  <fn-group>
    <fn fn-type="COI-statement">
      <p>The authors declare no competing financial interests.</p>
    </fn>
    <fn>
      <p><bold>Author Contributions</bold> L.B., J.M., and S.C. developed software, G.H. compared the method with manual segmentation and commercial software, DNS recruited participants and performed OCT imaging. J.M. and S.C. wrote the manuscript, and all authors reviewed it.</p>
    </fn>
  </fn-group>
</back>
<floats-group>
  <fig id="f1">
    <label>Figure 1</label>
    <caption>
      <title>Bruch’s membrane segmentation.</title>
      <p>(<bold>A</bold>) Raw B-scan. (<bold>B</bold>) Coarse axial gradient illustrating the two most highly contrasted interfaces: RVI and anterior RPE. (<bold>C</bold>) Segmentation of the RVI, first estimation of anterior and posterior RPE interfaces, and the refined segmentation of the RPE center obtained with a graph search algorithm. (<bold>D</bold>) Delineation of the BM as the convex hull of the RPE plus a shift for placing it on the negative intensity slope peak of the RPE (posterior RPE).</p>
    </caption>
    <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="srep42112-f1"/>
  </fig>
  <fig id="f2">
    <label>Figure 2</label>
    <caption>
      <title>Smoothing scheme.</title>
      <p>Each B-scan (BS<sub><italic>i</italic></sub>) is smoothed in the direction perpendicular to the B-scans (<italic>y</italic>), using a Gaussian weighted average of neighboring B-scans (BS<sub>i+1</sub>, BS<sub>i−1</sub>). Images are registered using the BM as reference. First, the BM is segmented in each raw image (Raw), and then the A-scans are shifted independently to render the BM flat and at the same depth <italic>d</italic> (Flattened). After registration, the smoothed B-scan (<inline-formula id="d32e928"><inline-graphic xmlns:xlink="http://www.w3.org/1999/xlink" id="d32e929" xlink:href="srep42112-m23.jpg"/></inline-formula>) is computed as described in <xref ref-type="disp-formula" rid="eq3">eq. 1</xref>.</p>
    </caption>
    <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="srep42112-f2"/>
  </fig>
  <fig id="f3">
    <label>Figure 3</label>
    <caption>
      <title>CSI segmentation using a graph-search approach.</title>
      <p>(<bold>A</bold>) The nodes of the graph are found as inflexion points of intensity in the <italic>z</italic> direction, below the BM. (<bold>B</bold>) Edge probability <italic>P(x,y</italic>), based on the Gabor transform, and used to compute the weight component <italic>w</italic><sub><italic>Affin</italic></sub>. (<bold>C</bold>) Nodes resulting from the graph-search, delineating the CSI. The bars indicate the edge probability of each node and the arrow illustrates the computation of the choroidal thickness. (<bold>D</bold>) Color coded choroidal thickness map obtained by natural neighbor interpolation of thickness on the scattered nodes along all B-Scans, overlaid on the fundus image.</p>
    </caption>
    <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="srep42112-f3"/>
  </fig>
  <fig id="f4">
    <label>Figure 4</label>
    <caption>
      <title>Segmentation performance.</title>
      <p>(<bold>A</bold>) Number of correctly segmented choroidal thickness maps grouped by eye condition, for a total of 280 patients. (<bold>B</bold>) Violin plots depicting the distribution of the fraction of successfully segmented B-scans per map, for all successfully reconstructed maps (215 cases), described in separate patient cohorts.</p>
    </caption>
    <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="srep42112-f4"/>
  </fig>
  <fig id="f5">
    <label>Figure 5</label>
    <caption>
      <title>Segmentation comparison.</title>
      <p>(<bold>A</bold>) Manual CSI segmentations and their mean trace. (<bold>B</bold>) Sample CSI traces of the ground truth (evaluator mean), our method, and Spectralis algorithm. We studied the differences between each segmentation and the ground-truth trace, which we compute as the mean trace of all specialists. For each specialist and the two automated methods, we compute the deviation (from ground truth) at all A-Scans of all tested B-Scans and present the results as violin plots. (<bold>C</bold>) Comparison of Bruch’s membrane segmentation. (<bold>D</bold>) Comparison of choroid-sclera interface segmentation.</p>
    </caption>
    <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="srep42112-f5"/>
  </fig>
  <fig id="f6">
    <label>Figure 6</label>
    <caption>
      <title>Three-dimensional study of the choroid.</title>
      <p>(<bold>A</bold>) Retina thickness map, computed as the distance between the RVI and BM, and choroidal thickness map. A circular region is defined to extract data centered at the macula. (<bold>B</bold>) Mean choroidal thickness versus age. (<bold>C</bold>) Scatter plot of choroidal thickness in 2D with fitted first-degree 2D polynomial. The normal to the plane is described by the angles <italic>θ</italic> and <italic>ϕ</italic> in spherical coordinates. (<bold>D</bold>) Polar normalized histogram of the azimuthal angle <italic>ϕ</italic> for the whole set of patients. (<bold>E</bold>) Histogram of the polar angle, with median value near 1 degree. (<bold>F</bold>) and (<bold>G</bold>) Histograms of the thickness contrast between inferior-nasal and superior-temporal, and between superior-nasal and inferior-temporal. These contrasts are consistent with the tilt azimuthal angle of plane fit to the map.</p>
    </caption>
    <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="srep42112-f6"/>
  </fig>
</floats-group>
