<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD Journal Publishing DTD v2.3 20070202//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName journalpublishing.dtd?>
<?SourceDTD.Version 2.3?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 2?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">J Appl Crystallogr</journal-id>
    <journal-id journal-id-type="iso-abbrev">J Appl Crystallogr</journal-id>
    <journal-id journal-id-type="publisher-id">J. Appl. Cryst.</journal-id>
    <journal-title-group>
      <journal-title>Journal of Applied Crystallography</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">0021-8898</issn>
    <issn pub-type="epub">1600-5767</issn>
    <publisher>
      <publisher-name>International Union of Crystallography</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">4970499</article-id>
    <article-id pub-id-type="publisher-id">zd5006</article-id>
    <article-id pub-id-type="doi">10.1107/S160057671600995X</article-id>
    <article-id pub-id-type="coden">JACGAR</article-id>
    <article-id pub-id-type="pii">S160057671600995X</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Computer Programs</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title><italic>WavePropaGator</italic>: interactive framework for X-ray free-electron laser optics design and simulations<xref ref-type="fn" rid="fn1">1</xref></article-title>
      <alt-title>
        <italic>WavePropaGator</italic>
      </alt-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Samoylova</surname>
          <given-names>Liubov</given-names>
        </name>
        <xref ref-type="aff" rid="a">a</xref>
        <xref ref-type="corresp" rid="cor">*</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Buzmakov</surname>
          <given-names>Alexey</given-names>
        </name>
        <xref ref-type="aff" rid="b">b</xref>
        <xref ref-type="corresp" rid="cor">*</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Chubar</surname>
          <given-names>Oleg</given-names>
        </name>
        <xref ref-type="aff" rid="c">c</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Sinn</surname>
          <given-names>Harald</given-names>
        </name>
        <xref ref-type="aff" rid="a">a</xref>
      </contrib>
      <aff id="a"><label>a</label><institution>European XFEL GmbH</institution>, Albert-Einstein-Ring 19, Hamburg, 22761, <country>Germany</country></aff>
      <aff id="b"><label>b</label><institution>Institute of Crystallography</institution>, Leninskii prospekt 59, Moscow, 119333, <country>Russian Federation</country></aff>
      <aff id="c"><label>c</label>National Synchrotron Light Source II, <institution>Brookhaven National Laboratory</institution>, Upton, NY 11973, <country>USA</country></aff>
    </contrib-group>
    <author-notes>
      <corresp id="cor">Correspondence e-mail: <email>liubov.samoylova@xfel.eu</email>, <email>buzmakov@gmail.com</email></corresp>
    </author-notes>
    <pub-date pub-type="collection">
      <day>01</day>
      <month>8</month>
      <year>2016</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>06</day>
      <month>7</month>
      <year>2016</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>06</day>
      <month>7</month>
      <year>2016</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on the <pub-date pub-type="epub"/>. -->
    <volume>49</volume>
    <issue>Pt 4</issue>
    <issue-id pub-id-type="publisher-id">j160400</issue-id>
    <fpage>1347</fpage>
    <lpage>1355</lpage>
    <history>
      <date date-type="received">
        <day>09</day>
        <month>2</month>
        <year>2016</year>
      </date>
      <date date-type="accepted">
        <day>19</day>
        <month>6</month>
        <year>2016</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© Liubov Samoylova et al. 2016</copyright-statement>
      <copyright-year>2016</copyright-year>
      <license license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/2.0/uk/">
        <license-p>This is an open-access article distributed under
the terms of the Creative Commons Attribution
Licence, which permits unrestricted use,
distribution, and reproduction in any medium,
provided the original authors and source are
cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:type="simple" xlink:href="http://dx.doi.org/10.1107/S160057671600995X">A full version of this
article is available from Crystallography Journals Online.</self-uri>
    <abstract abstract-type="toc">
      <p>The <italic>WavePropaGator</italic> (<italic>WPG</italic>) package is a new interactive cross-platform open-source software framework for modeling of coherent and partially coherent X-ray wavefront propagation. The <italic>WPG</italic> addresses the needs of beamline scientists and user groups to facilitate the design, optimization and improvement of X-ray optics to meet their experimental requirements. The paper presents a general description of the package and gives some recent application examples.</p>
    </abstract>
    <abstract>
      <p>This article describes the <italic>WavePropaGator</italic> (<italic>WPG</italic>) package, a new interactive software framework for coherent and partially coherent X-ray wavefront propagation simulations. The package has been developed at European XFEL for users at the existing and emerging free-electron laser (FEL) facilities, as well as at the third-generation synchrotron sources and future diffraction-limited storage rings. The <italic>WPG</italic> addresses the needs of beamline scientists and user groups to facilitate the design, optimization and improvement of X-ray optics to meet their experimental requirements. The package uses the <italic>Synchrotron Radiation Workshop</italic> (<italic>SRW</italic>) C/C++ library and its Python binding for numerical wavefront propagation simulations. The framework runs reliably under Linux, Microsoft Windows 7 and Apple Mac OS X and is distributed under an open-source license. The available tools allow for varying source parameters and optics layouts and visualizing the results interactively. The wavefront history structure can be used for tracking changes in every particular wavefront during propagation. The batch propagation mode enables processing of multiple wavefronts in workflow mode. The paper presents a general description of the package and gives some recent application examples, including modeling of full X-ray FEL beamlines and start-to-end simulation of experiments.</p>
    </abstract>
    <kwd-group>
      <kwd>wavefront propagation</kwd>
      <kwd>X-ray free-electron lasers</kwd>
      <kwd>XFELs</kwd>
      <kwd>Fourier optics</kwd>
      <kwd>start-to-end simulations</kwd>
      <kwd>data analysis and visualization</kwd>
      <kwd>computer programs</kwd>
    </kwd-group>
  </article-meta>
</front>
<body>
  <sec id="sec1">
    <label>1.</label>
    <title>Glossary   </title>
    <p>FEL: free-electron laser.</p>
    <p>FFT: fast Fourier transform.</p>
    <p>Git: a distributed revision control and source code management system (<ext-link ext-link-type="uri" xlink:href="http://git-scm.com">http://git-scm.com</ext-link>).</p>
    <p>GitHub: a web-based Git repository hosting service (<ext-link ext-link-type="uri" xlink:href="https://github.com/">https://github.com/</ext-link>).</p>
    <p>HDF5: Hierarchical Data Format. To view HDF5 files one can use the official free <italic>HDFView</italic> tool (<ext-link ext-link-type="uri" xlink:href="https://www.hdfgroup.org/products/java/hdfview">https://www.hdfgroup.org/products/java/hdfview</ext-link>).</p>
    <p><italic>IPython Notebook</italic>: an interactive computational environment for combining code execution, rich text, mathematics, plots and rich media (<ext-link ext-link-type="uri" xlink:href="http://ipython.org/notebook.html">http://ipython.org/notebook.html</ext-link>).</p>
    <p>MPI: Message Passing Interface. A standardized and portable message-passing system designed by a group of researchers from academia and industry to function on a wide variety of parallel computers (<ext-link ext-link-type="uri" xlink:href="http://www.mpi-forum.org/">http://www.mpi-forum.org/</ext-link>).</p>
    <p>SASE: self-amplified spontaneous emission. The process whereby an electron beam passes through a long undulator, such that the initial random field of spontaneous radiation becomes amplified in intensity and enhanced in coherence characteristics. SASE FEL pulses are characterized by spiky structure and fluctuations in wavelength and FEL pulse energy.</p>
  </sec>
  <sec id="sec2">
    <label>2.</label>
    <title>Introduction   </title>
    <p>The X-ray free-electron laser facilities (XFELs) that have emerged in recent years deliver radiation with a unique combination of properties, such as extreme peak field intensities, ultra-short X-ray pulse duration and a high degree of transverse coherence of the XFEL radiation, and thus establish a new specific combination of requirements for X-ray optics. Additional factors such as the varying beam size and divergence as a function of the electron bunch charge, the very large distances to the source, and, as a consequence, the large apertures required for the optics further complicate the environment.</p>
    <p>Besides, the end stations at XFEL facilities have very versatile layouts, which can include multi-crystal monochromators, split-and-delay lines and units for pump–probe experiments (Roling <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb20"> ▸</xref>), monochromators for hard and soft X-ray self-seeding schemes (Amann <italic>et al.</italic>, 2012<xref ref-type="bibr" rid="bb1"> ▸</xref>; Inagaki <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb13"> ▸</xref>), and various refocusing optics. For a correct optics design, one has to analyze and optimize all the factors that have an impact on the beam properties after propagation of the beam through the optics. Hard X-ray FEL wavefronts are subject to distortions caused by imperfections of the optics, in particular the effect of mirror surface errors, which have been measured experimentally at LCLS and SACLA (Rutishauser <italic>et al.</italic>, 2012<xref ref-type="bibr" rid="bb22"> ▸</xref>; Kayser <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb14"> ▸</xref>). Moreover, characterizing focused XFEL intense wavefields is crucial for their use in single-shot diffractive imaging experiments (Loh <italic>et al.</italic>, 2013<xref ref-type="bibr" rid="bb16"> ▸</xref>; Park <italic>et al.</italic>, 2013<xref ref-type="bibr" rid="bb18"> ▸</xref>).</p>
    <p>The wave optics formalism is a natural and reliable way to deal with interference effects that are unavoidable in coherent beam propagation (Bahrdt <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb2"> ▸</xref>; Chubar <italic>et al.</italic>, 2011<xref ref-type="bibr" rid="bb7"> ▸</xref>). We present here the <italic>WavePropaGator</italic> (<italic>WPG</italic>) package, the goal of which is to provide a user-friendly software environment that any scientist involved in XFEL optics design can use, without having specific experience in numerical wave optics calculations. The package is built on top of the open-source <italic>Synchrotron Radiation Workshop</italic> (<italic>SRW</italic>) software (Chubar <italic>et al.</italic>, 2011<xref ref-type="bibr" rid="bb7"> ▸</xref>), which is actively used for development of X-ray and infrared beamlines at synchrotron light sources. The <italic>SRW</italic> code is based on the principle of physical optics using FFT and asymptotic expansion based propagators and is capable of accurate modeling of fully and partially coherent synchrotron radiation emission and propagation through different types of optics. The software is able to calculate the propagation of SASE XFEL pulses, which requires much larger computing resources than propagation of steady state beams or longitudinally coherent pulses.</p>
    <p>For the <italic>WPG</italic> framework we use Python structures, which provide the possibility for coding in self-explaining meta-language, so that a complete beamline with tens of optical elements can be specified within one page of text. One can easily create and modify such scripts without going into implementation details. In addition, an experienced user can create propagators for new optics types in Python and include them in the beamlines. The <italic>WPG</italic> framework scripts can be run either within the <italic>IPython Notebook</italic> interactive environment, combining code execution, rich text, mathematics and plots in one file, or in batch file mode, as a Python script in Python or an IPython shell. The <italic>WPG</italic> also includes modules necessary for start-to-end simulations of XFEL experiments, which simulate propagation of the XFEL pulses (Manetti <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb17"> ▸</xref>) through beamline optics and provide an interface to codes modeling the interaction with the sample (<italic>SingFEL</italic>, <italic>PMI</italic>; Yoon <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb29"> ▸</xref>).</p>
  </sec>
  <sec id="sec3">
    <label>3.</label>
    <title>Coherent wavefront propagation   </title>
    <p>This section summarizes the basics of the calculation methods implemented in the <italic>SRW</italic> (Chubar &amp; Elleaume, 1998<xref ref-type="bibr" rid="bb9"> ▸</xref>; Chubar <italic>et al.</italic>, 2002<xref ref-type="bibr" rid="bb10"> ▸</xref>, 2008<xref ref-type="bibr" rid="bb8"> ▸</xref>, 2011<xref ref-type="bibr" rid="bb7"> ▸</xref>) that are most relevant for FEL applications and are available through the <italic>WPG</italic> interface.</p>
    <p>For small emission and observation angles, the propagation of the transverse components in free space from a point <bold>r</bold>
<sub>1</sub> to a point <bold>r</bold>
<sub>2</sub> can be described in terms of the Huygens−Fresnel principle in the frequency domain as a integral by integration over the plane Σ<sub>1</sub> perpendicular to the <italic>z</italic> axis (beam axis): <disp-formula id="fd1"><graphic xlink:href="j-49-01347-efd1.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where ω is the angular frequency of the wave and <italic>c</italic> the speed of light. The wavefield at the observation plane can be written in a more general form as <disp-formula id="fd2"><graphic xlink:href="j-49-01347-efd2.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where the kernel <bold><italic>K</italic></bold>(<italic>x</italic>
<sub>2</sub>, <italic>y</italic>
<sub>2</sub>, <italic>x</italic>
<sub>1</sub>, <italic>y</italic>
<sub>1</sub>, ω) is given as <disp-formula id="fd3"><graphic xlink:href="j-49-01347-efd3.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>
</p>
    <p>As shown in the following two sections, propagation through most X-ray optics elements can be presented in the form of the convolution integral (2)<xref ref-type="disp-formula" rid="fd2"/>. Using the Fourier optics modular approach, a complete beamline can be described as a set of propagators corresponding to individual optical components, which can be then numerically solved by means of a two-dimensional FFT algorithm.</p>
    <p>The representation (3)<xref ref-type="disp-formula" rid="fd3"/> also enables the analytical treatment of the quadratic phase term, allowing for free-space propagation simulations with a reduced sampling rate (Chubar <italic>et al.</italic>, 2008<xref ref-type="bibr" rid="bb8"> ▸</xref>). This dramatically improves the technical feasibility and robustness of the Fourier optics method.</p>
    <sec id="sec3.1">
      <label>3.1.</label>
      <title>Thin optical elements   </title>
      <p>Many of the optical components of an X-ray beamline can be described as thin optical elements, <italic>i.e.</italic> as linear filters that change the wavefield amplitude and/or phase in the plane normal to the propagation direction. For thin optical elements the kernel (3)<xref ref-type="disp-formula" rid="fd3"/> can be represented as <disp-formula id="fd4"><graphic xlink:href="j-49-01347-efd4.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where <bold><italic>T</italic></bold>(<italic>x</italic>
<sub>1</sub>, <italic>y</italic>
<sub>1</sub>, ω) is a complex transmission function, and δ() is the δ function. For example, the transmission function for a thin lens is given by <disp-formula id="fd5"><graphic xlink:href="j-49-01347-efd5.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where (<italic>x</italic>
<sub>0</sub>, <italic>y</italic>
<sub>0</sub>) are coordinates of the lens center, and <italic>f<sub>x</sub></italic> and <italic>f<sub>y</sub></italic> are focal distances in the horizontal and vertical planes. The transmission for a two-dimensional parabolic compound refractive lens (CRL) (Kohn <italic>et al.</italic>, 2003<xref ref-type="bibr" rid="bb15"> ▸</xref>) is given by <disp-formula id="fd6"><graphic xlink:href="j-49-01347-efd6.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where the complex refractive index of the lens material is <italic>n</italic> = 1 − δ + <italic>i</italic>β, the CRL thickness depending on the distance from the lens center <inline-formula><inline-graphic xlink:href="j-49-01347-efi1.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> is <italic>t</italic> = <italic>N</italic> (<italic>r</italic>/<italic>R</italic> + <italic>d</italic>), <italic>R</italic> is the radius of the parabola tip, <italic>N</italic> is the total number of individual parabolic lenses, <italic>d</italic> is the minimum spacing between two parabolas and <italic>a</italic> is the lens aperture.</p>
    </sec>
    <sec id="sec3.2">
      <label>3.2.</label>
      <title>Extended optical elements   </title>
      <p>The wave optics method that we use for simulation of grazing-incidence mirrors is based on the local stationary-phase approximation (Canestrari <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb6"> ▸</xref>). The kernel is presented as <disp-formula id="fd7"><graphic xlink:href="j-49-01347-efd7.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where <bold><italic>G</italic></bold> is a matrix function defining local transformations of amplitudes of electric field components, <italic>i.e.</italic> the propagation between input (<italic>x</italic>
<sub>1</sub>, <italic>y</italic>
<sub>1</sub>) and output (<italic>x</italic>
<sub>2</sub>, <italic>y</italic>
<sub>2</sub>) planes including the reflection from a mirror surface; <inline-formula><inline-graphic xlink:href="j-49-01347-efi2.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and <inline-formula><inline-graphic xlink:href="j-49-01347-efi3.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> are scalar functions defining the transformation of coordinates for points in transverse planes before and after the optical element; and Λ(<italic>x</italic>
<sub>2</sub>, <italic>y</italic>
<sub>2</sub>, <italic>x</italic>
<sub>1</sub>, <italic>y</italic>
<sub>1</sub>, <italic>ω</italic>) is a scalar function defining the optical path between the points in the input and output planes. These functions can be found by using the asymptotic expansion of the Fresnel−Kirchhoff integral over the mirror surface, namely, the stationary phase approximation, which is Fermat’s principle for mirror reflection expressed in mathematical form. The stationary phase point can be found by defining a ray from the point (<italic>x</italic>
<sub>1</sub>, <italic>y</italic>
<sub>1</sub>) in the input plane in the direction provided by the local gradient of the input radiation field phase, finding its intersection with the mirror surface, generating the specular reflected ray, and finding its intersection with the output plane at the point (<italic>x</italic>
<sub>2</sub>, <italic>y</italic>
<sub>2</sub>) behind the mirror. As a final step, the electric field components are re-calculated on the required rectangular mesh, using a two-dimensional interpolation.</p>
      <p>For gratings (Canestrari <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb6"> ▸</xref>), an extra phase shift ΔΦ(<italic>x</italic>
<sub>2</sub>, <italic>y</italic>
<sub>2</sub>, ω) associated with the reflection should be taken into account: <disp-formula id="fd8"><graphic xlink:href="j-49-01347-efd8.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>This function describes the phase shift introduced by grooves in the transverse direction, the shift being perpendicular to the grooves in the output plane: <disp-formula id="fdu6"><graphic xlink:href="j-49-01347-efd9.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where <italic>m</italic> is the diffraction order, and <inline-formula><inline-graphic xlink:href="j-49-01347-efi4.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> is the effective groove number for a given intersection point. For a variable line spacing (VLS) grating with a groove density that varies along the ‘longitudinal’ direction of the grating surface according to the <italic>n</italic>th order polynomial <inline-formula><inline-graphic xlink:href="j-49-01347-efi5.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>, the effective number of grooves associated with the longitudinal position <inline-formula><inline-graphic xlink:href="j-49-01347-efi6.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> on the grating surface is <disp-formula id="fd10"><graphic xlink:href="j-49-01347-efd10.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>
</p>
      <p>Propagation of the XFEL pulses through a perfect diffracting crystal can be described within the Fourier optics approach (Bushuev, 2008<xref ref-type="bibr" rid="bb5"> ▸</xref>). For that, the crystal propagator known from dynamical diffraction theory is applied to wavefield Fourier amplitudes in reciprocal space. Afterwards the resulting wavefront in real space can be obtained with an inverse Fourier transformation. For implementation details see Sutter <italic>et al.</italic> (2014<xref ref-type="bibr" rid="bb26"> ▸</xref>); the first practical applications of these <italic>SRW</italic> modules were described by Suvorov <italic>et al.</italic> (2015<xref ref-type="bibr" rid="bb27"> ▸</xref>) and Chubar <italic>et al.</italic> (2016<xref ref-type="bibr" rid="bb11"> ▸</xref>).</p>
      <p>The available optical elements are listed in Table 1<xref ref-type="table" rid="table1"> ▸</xref>.</p>
    </sec>
    <sec id="sec3.3">
      <label>3.3.</label>
      <title>Imperfections in optics   </title>
      <p>High-performing X-ray mirrors must be able to preserve the wavefront of the incident radiation inside the focused spot on the sample. Deviation of the mirror surface from an ideal one results in the appearance of scattered waves, which form speckles (irregularities of the radiation intensity caused by irregularities of the wavefront) in the beam spot downstream. In particular, the XFEL radiation divergence is only several microradians, and the source-to-mirror, <italic>r</italic>
<sub>0</sub>, and the mirror-to-sample, <italic>r</italic>
<sub>1</sub>, distances range up to several hundred metres. As a result, the mirror surface errors at the longest spatial wavelengths, comparable to the mirror length, have the greatest effect on the quality of the reflected beam. The spatial frequencies responsible for scattering radiation inside the spot (damaging frequencies) for a flat mirror, <italic>e.g.</italic> horizontal offset mirrors at the European XFEL, can be estimated as (Yashchuk <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb28"> ▸</xref>)<disp-formula id="fd11"><graphic xlink:href="j-49-01347-efd11.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where θ<sub>0</sub> is the incidence angle, δθ is the radiation divergence and λ is the X-ray wavelength. With the parameters of the SASE1 beamline at the European XFEL, the range of spatial frequencies that can produce speckles is ν<italic><sub>x</sub></italic> ≃ 0.033–0.3 cm<sup>−1</sup>. These frequencies correspond to the spatial lengths <italic>d<sub>x</sub></italic> ≃ 3.3–30 cm. Lower spatial frequencies (spatial lengths longer than 30 cm) would lead to splitting of the beam. With the parameters of the SASE3 beamline, the range of spatial frequencies that will generate speckles is ν<italic><sub>x</sub></italic> ≃ 0.02–1.5 cm<sup>−1</sup>. These frequencies correspond to the spatial lengths <italic>d<sub>x</sub></italic> ≃ 0.67–50 cm.</p>
      <p>If the coherent X-ray beam is reflected at grazing angle θ from a very smooth mirror surface with a height profile <italic>h</italic>(<italic>x</italic>
<sub>m</sub>), the optical path differences introduced by the mirror’s imperfections are much smaller than the X-ray wavelength λ: <disp-formula id="fd12"><graphic xlink:href="j-49-01347-efd12.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where <italic>x</italic>
<sub>m</sub> is the coordinate along the mirror surface and <italic>m</italic> is the point number. In this case one can use the complex transmission function <disp-formula id="fdu13"><graphic xlink:href="j-49-01347-efd13.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>to analyze wavefront distortions induced by mirror surface residual height errors. Owing to the very small incidence angle the beam footprint is much larger along the propagation direction than in the sagittal direction. If the full width at half-maximum of the XFEL beam is about 0.5 mm, for a typical incidence angle 2 mrad, the beam footprint is about 25 × 0.5 mm. Since the impact of sagittal errors will be small, one can use here only one-dimensional metrology data to model the surface imperfections along the beam propagation direction.</p>
      <p>The propagator of an imperfect CRL is simulated in a two-step approach. First, it uses the propagator for an ideal CRL as given in §<xref ref-type="sec" rid="sec3.2"/>3.2. Then, voids are simulated respecting a given void size distribution between a minimum and a maximum void diameter and are distributed in accordance with a given void density into a fictive cylinder of the same material, having the same aperture and thickness as the ideal CRL. In the next step, the paraboloids that are defining the CRL shape are removed, including the voids there. Finally, a plain void propagator is generated with the corresponding transmission. The passage of the wavefront through an imperfect CRL is thus calculated with two propagators, first for the ideal CRL, followed by the plane void propagator. To speed up the calculations the propagators for perfect and imperfect CRLs can be calculated only once, saved in a binary format supported by Python and later loaded from the hard drive. See also Roth <italic>et al.</italic> (2014<xref ref-type="bibr" rid="bb21"> ▸</xref>), example 7 (<ext-link ext-link-type="uri" xlink:href="https://github.com/ochubar/SRW">https://github.com/ochubar/SRW</ext-link>), and the <italic>WPG</italic> tutorial (<ext-link ext-link-type="uri" xlink:href="http://wpg.readthedocs.org/en/latest/tutorials.html">http://wpg.readthedocs.org/en/latest/tutorials.html</ext-link>).</p>
    </sec>
    <sec id="sec3.4">
      <label>3.4.</label>
      <title>Wavefront propagation setup   </title>
      <p>In the <italic>WPG</italic> framework the model of wavefront propagation is implemented using two classes, <monospace>Wavefront()</monospace> and <monospace>Beamline()</monospace> as shown in Fig. 1<xref ref-type="fig" rid="fig1"> ▸</xref>. To start the propagation one should define a wavefront, which can be a Gaussian steady state or time-dependent short pulse calculated using corresponding library functions, or an external XFEL pulse, <italic>e.g.</italic> from the X-ray FEL Photon Pulses Database (XPD; Manetti <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb17"> ▸</xref>), or any other external wavefield defined on a uniform Cartesian grid.</p>
      <p>The beamline is defined as a container of propagators with suitable parameters. The basic workflow is shown in Fig. 2<xref ref-type="fig" rid="fig2"> ▸</xref>.</p>
      <sec id="sec3.4.1">
        <label>3.4.1.</label>
        <title>Wavefront data   </title>
        <p>The structure of the HDF5 wavefront file, which is described in glossary file <monospace>wpg/glossary.py</monospace>, is used for mapping the Python wavefront structure to HDF5.</p>
        <p>The <italic>WPG</italic> wavefront HDF5 file contains the obligatory and optional sections described below.</p>
        <p>The main groups include the following:</p>
        <p>(<italic>a</italic>) <italic>data</italic> – contains two three-dimensional arrays of electromagnetic fields with horizontal and vertical polarizations, <monospace>arrEhor</monospace> and <monospace>arrEver</monospace>
</p>
        <p>(<italic>b</italic>) <italic>params</italic> – contains a Cartesian grid of wavefront data, geometrical parameters <italic>etc.</italic>
</p>
        <p>The following are optional groups, especially recommended for use in start-to-end simulations:</p>
        <p>(<italic>a</italic>) <italic>history</italic> – contains a link to a parent wavefront, if it exists, and a hierarchy structure with parent wavefront parameters and a link to its data</p>
        <p>(<italic>b</italic>) <italic>info</italic> – some information about the origin of the current wavefront</p>
        <p>(<italic>c</italic>) <italic>misc</italic> – information for visual checking of wavefront parameters (intensity distribution <italic>etc</italic>.)</p>
        <p>(<italic>d</italic>) <italic>version</italic> – version of the wavefront glossary</p>
      </sec>
      <sec id="sec3.4.2">
        <label>3.4.2.</label>
        <title>Beamline as a container of propagators   </title>
        <p>An example of the beamline definition is shown in Fig. 3<xref ref-type="fig" rid="fig3"> ▸</xref>.</p>
      </sec>
      <sec id="sec3.4.3">
        <label>3.4.3.</label>
        <title>Adjustment of propagation parameters   </title>
        <p>Our framework provides special tools to facilitate propagation parameter adjustment and make the process transparent for the user. In particular, the method <monospace>Use_PP()</monospace> takes none or several propagation parameters defined by the user for a given optical element as arguments (see Fig. 3<xref ref-type="fig" rid="fig3"> ▸</xref>) and provides the core library propagation function with a full propagation parameter set, using for the rest the default values. For instance, <monospace>bl.append(Drift(50.),Use_PP(semi_analytical_treatement=1))</monospace> introduces a 50 m drift in free space and sets up calculations using the semi-analytical processing described in §3<xref ref-type="sec" rid="sec3"/>. To tune the sampling, one can use the parameters <monospace>zoom</monospace> and <monospace>sampling</monospace> (Fig. 3<xref ref-type="fig" rid="fig3"> ▸</xref>). As in all numerical methods involving discrete Fourier transforms, the correct sampling of the signal in real and reciprocal space is critical for correct numerical calculations (see <italic>e.g.</italic> Potter, 1973<xref ref-type="bibr" rid="bb19"> ▸</xref>; Goodman, 2004<xref ref-type="bibr" rid="bb12"> ▸</xref>). To control the choice one can refer to the sampling in reciprocal <italic>Q</italic> space: the angular spectrum can be visualized using corresponding library utilities. See also the <italic>WPG</italic> documentation section with FEL beamline examples (<ext-link ext-link-type="uri" xlink:href="http://wpg.readthedocs.org/en/latest/real_beamlines.html">http://wpg.readthedocs.org/en/latest/real_beamlines.html</ext-link>).</p>
      </sec>
    </sec>
  </sec>
  <sec id="sec4">
    <label>4.</label>
    <title>Examples   </title>
    <sec id="sec4.1">
      <label>4.1.</label>
      <title>FEL pulse visualization   </title>
      <p>Fig. 4<xref ref-type="fig" rid="fig4"> ▸</xref> shows the intensity and phase distribution of an XFEL pulse extracted from the XPD (Manetti <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb17"> ▸</xref>) and visualized by the <italic>WPG</italic> package at the exit of the SASE3 undulator with a maximum length of active segments of 130 m. The FEL data were simulated with the <italic>FAST</italic> code (Saldin <italic>et al.</italic>, 1999<xref ref-type="bibr" rid="bb23"> ▸</xref>) for photon energy 800 eV, electron bunch charge 250 pC and electron energy 14 GeV. Note that the shift is much smaller than the spot size. One can easily observe that the pulse after the tapered undulator is shorter and more collimated.</p>
    </sec>
    <sec id="sec4.2">
      <label>4.2.</label>
      <title>Modeling the SCS SASE3 beamline   </title>
      <p>Fig. 5<xref ref-type="fig" rid="fig5"> ▸</xref> shows the intensity distribution around the sample position of the SCS beamline at the European XFEL. The optical elements considered in this example are offset and distribution mirrors of the beam transport, vertical mirrors of the soft X-ray monochromator, clean-up slits in the vertical and horizontal intermediate foci, and Kirkpatrick–Baez micro-focusing mirrors close to the sample position.</p>
      <p>Cut-off effects of all optical elements were considered, assuming here an idealized Gaussian beam profile as a source with a divergence corresponding to XFEL SASE3 radiation from electron bunch charge 100 pC and electron energy 17.5 GeV. The simulations took into account a slightly deteriorated performance of the beamline mirrors with respect to their specifications. The left panel of Fig. 5<xref ref-type="fig" rid="fig5"> ▸</xref> shows the beam intensity around the focus position with the clean-up slits fully open. The vertical cuts correspond to (left to right) −6, 0 and 6 mm positions around the focus. Asymmetric wings are visible in the horizontal plane, while the focus size is slightly enlarged in the vertical plane. By closing the clean-up slits (right panel), the focus becomes more homogeneous and smaller in the vertical plane. As demonstrated in this example, clean-up slits can in principle be used to reduce the effect of profile distortions from upstream mirrors without losing too much intensity. However, damage effects on these slits have to be carefully monitored and make this equipment usable only for moderate X-ray beam intensities.</p>
    </sec>
    <sec id="sec4.3">
      <label>4.3.</label>
      <title>Module for start-to-end simulation of XFEL experiments   </title>
      <p>The <italic>prop</italic> module numerically propagates the FEL wavefield data from the undulator exit, through the beamline optics, to the sample position using the Python module <italic>multiprocessing</italic>. Each file from the working directory is processed by one free CPU core. On modern PCs or servers this makes it possible to significantly speed up the calculations. However the memory load by every process can become a bottleneck: the required memory for processing of a short 30 fs XFEL pulse can exceed 8 Gb for a beamline including submicrometre focusing optics, such as the Kirkpatrick–Baez mirror system of the SPB-SFX instrument at the European XFEL (Bean <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb3"> ▸</xref>). The module was successfully used for modeling of a single biomolecule imaging experiment at the SPB instrument with the multiphysics simulation framework <italic>simS2E</italic> (Yoon <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb29"> ▸</xref>).</p>
    </sec>
  </sec>
  <sec id="sec5">
    <label>5.</label>
    <title>Software availability and documentation   </title>
    <p>The <italic>WPG</italic> framework runs reliably under Linux, Microsoft Windows 7 and Apple Mac OS X. Using IPython as a web front-end enables the users to run the code on a remote server as well as on their local personal computers. One can use popular Python libraries [such as <italic>SciPy</italic> (<ext-link ext-link-type="uri" xlink:href="https://www.scipy.org/">https://www.scipy.org/</ext-link>), <italic>NumPy</italic> (<ext-link ext-link-type="uri" xlink:href="http://www.numpy.org/">http://www.numpy.org/</ext-link>) and <italic>Matplotlib</italic> (<ext-link ext-link-type="uri" xlink:href="http://matplotlib.org/">http://matplotlib.org/</ext-link>)] for pre- and post-processing as well as for visualizing the simulation results.</p>
    <p>The wavefronts are saved in HDF5 format for eventual further processing and start-to-end simulations of experiments. The HDF5 format allows for keeping the calculation history within a single file, thus facilitating communication between various scientific groups and cross-checking with other simulation results. The <italic>WPG</italic> source code (<ext-link ext-link-type="uri" xlink:href="https://github.com/samoylv/WPG">https://github.com/samoylv/WPG</ext-link>) together with guidelines for installation and application examples (<ext-link ext-link-type="uri" xlink:href="https://wpg.readthedocs.org/en/latest/">https://wpg.readthedocs.org/en/latest/</ext-link>) are open source and available on the web. The installation includes building the C++ written <italic>SRW</italic> library from its sources.</p>
    <p>The installation procedure for Linux, OS X and Windows 7 is described at <ext-link ext-link-type="uri" xlink:href="https://wpg.readthedocs.org/en/latest/wpg.html#getting-started">https://wpg.readthedocs.org/en/latest/wpg.html#getting-started</ext-link> and includes installation of Python, <italic>Numpy</italic>, <italic>Scipy</italic>, <italic>Matplotlib</italic>, <italic>h5py</italic> (<ext-link ext-link-type="uri" xlink:href="http://www.h5py.org/">http://www.h5py.org/</ext-link>) and the <italic>IPython Notebook</italic>.</p>
  </sec>
  <sec id="sec6">
    <label>6.</label>
    <title>Future steps   </title>
    <p>In the near future, we plan to enhance the start-to-end simulation possibilities by employing the MPI technology through the <italic>mpi4py</italic> module and running the propagation of multiple pulses on a cluster. One should, though, keep in mind that transferring the input and resulting pulse data through the network can also become a bottleneck. Thus the efficiency strongly depends on the cluster configuration and the ratio of calculation time for one pulse and network data transfer rate. In addition, we plan for the <italic>WPG</italic> to support full inter-operation with a new framework, based on client–server architecture and using JavaScript and Python for a rich graphical user interface. This is currently under development in a project (Bruhwiler <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb4"> ▸</xref>) sponsored by the US Department of Energy.</p>
  </sec>
  <sec id="sec7">
    <label>7.</label>
    <title>Conclusions   </title>
    <p>Knowledge of temporal, spatial, spectral and coherence properties of the radiation from X-ray FELs is of key importance for planning user experiments. We have developed the <italic>WPG</italic> software package as a new framework for wave optics simulations and have used it successfully for X-ray FEL optics beamline design and experimental data analysis. The software is also used as a part of the multiphysics simulation framework <italic>simS2E</italic> for source-to-experiment simulations of a single-particle imaging experiment, employing pulse data from the XPD as an input. For the upcoming commissioning of the European XFEL, the <italic>WPG</italic> will be available as a versatile tool capable of simulating all relevant optics at the facility.</p>
  </sec>
</body>
<back>
  <fn-group>
    <fn id="fn1">
      <label>1</label>
      <p>This article will form part of a virtual special issue of the journal on free-electron laser software.</p>
    </fn>
  </fn-group>
  <ack>
    <p>We thank Mikhail Yurkov, Eugeny Schneidmiller, Igor Kozhevnikov and Frank Siewert for fruitful discussions, and Ann-Kristin Meyer for help with calculations. The work of AB was funded by the Russian Ministry of Education and Science <italic>via</italic> the program ‘Physics at Accelerators and Reactors of West Europe (excluding CERN)’. OC acknowledges funding from the US DOE Office of Science, Program of Basic Energy Sciences, under SBIR awards DE-SC0006284 and DE-SC0011237, for work on the development of the <italic>SRW</italic> code and its associated frameworks.</p>
  </ack>
  <ref-list>
    <title>References</title>
    <ref id="bb1">
      <mixed-citation publication-type="other">Amann, J. <italic>et al.</italic> (2012). <italic>Nat. Photon.</italic>
<bold>6</bold>, 693–698.</mixed-citation>
    </ref>
    <ref id="bb2">
      <mixed-citation publication-type="other">Bahrdt, J., Flechsig, U., Grizolli, W. &amp; Siewert, F. (2014). <italic>Proc. SPIE</italic>, <bold>9209</bold>, 920908.</mixed-citation>
    </ref>
    <ref id="bb3">
      <mixed-citation publication-type="other">Bean, R., Aquila, A., Samoylova, L. &amp; Mancuso, A. (2016). <italic>J. Opt.</italic>
<bold>18</bold>, 074011.</mixed-citation>
    </ref>
    <ref id="bb4">
      <mixed-citation publication-type="other">Bruhwiler, D., Chubar, O., Nagler, R., Krzywinski, J. &amp; Boehnlein, A. (2014). <italic>Proc. SPIE</italic>, <bold>9209</bold>, 92090Z.</mixed-citation>
    </ref>
    <ref id="bb5">
      <mixed-citation publication-type="other">Bushuev, V. A. (2008). <italic>J. Synchrotron Rad.</italic>
<bold>15</bold>, 495–505.</mixed-citation>
    </ref>
    <ref id="bb6">
      <mixed-citation publication-type="other">Canestrari, N., Bisogni, V., Walter, A., Zhu, Y., Dvorak, J., Vescovo, E. &amp; Chubar, O. (2014). <italic>Proc. SPIE</italic>, <bold>9209</bold>, 92090I.</mixed-citation>
    </ref>
    <ref id="bb7">
      <mixed-citation publication-type="other">Chubar, O., Berman, L., Chu, Y. S., Fluerasu, A., Hulbert, S., Idir, M., Kaznatcheev, K., Shapiro, D., Shen, Q. &amp; Baltser, J. (2011). <italic>Proc. SPIE</italic>, <bold>8141</bold>, 814107.</mixed-citation>
    </ref>
    <ref id="bb8">
      <mixed-citation publication-type="other">Chubar, O., Couprie, M.-E., Labat, M., Lambert, G., Polack, F. &amp; Tcherbakoff, O. (2008). <italic>Nucl. Instrum. Methods Phys. Res. Sect. A</italic>, <bold>593</bold>, 30–34.</mixed-citation>
    </ref>
    <ref id="bb9">
      <mixed-citation publication-type="other">Chubar, O. &amp; Elleaume, P. (1998). <italic>EPAC 98, 6th European Particle Accelerator Conference</italic>, pp. 1177–1179. Geneva: JACoW.</mixed-citation>
    </ref>
    <ref id="bb10">
      <mixed-citation publication-type="other">Chubar, O., Elleaume, P., Kuznetsov, S. &amp; Snigirev, A. (2002). <italic>Proc. SPIE</italic>, <bold>4769</bold>, 145–151.</mixed-citation>
    </ref>
    <ref id="bb11">
      <mixed-citation publication-type="other">Chubar, O., Geloni, G., Kocharyan, V., Madsen, A., Saldin, E., Serkez, S., Shvyd’ko, Y. &amp; Sutter, J. (2016). <italic>J. Synchrotron Rad.</italic>
<bold>23</bold>, 410–424.</mixed-citation>
    </ref>
    <ref id="bb12">
      <mixed-citation publication-type="other">Goodman, J. W. (2004). <italic>Introduction to Fourier Optics</italic>, 3rd ed. Green Village: Roberts and Company Publishers.</mixed-citation>
    </ref>
    <ref id="bb13">
      <mixed-citation publication-type="other">Inagaki, T. <italic>et al.</italic> (2014). <italic>FEL2014, Proceedings of the 36th International Free Electron Laser Conference</italic>, TUC01, pp. 603–608. Geneva: JACoW.</mixed-citation>
    </ref>
    <ref id="bb14">
      <mixed-citation publication-type="other">Kayser, Y., Rutishauser, S., Katayama, T., Ohashi, H., Kameshima, T., Flechsig, U., Yabashi, M. &amp; David, C. (2014). <italic>Opt. Express</italic>, <bold>22</bold>, 9004–9015.</mixed-citation>
    </ref>
    <ref id="bb15">
      <mixed-citation publication-type="other">Kohn, V., Snigireva, I. &amp; Snigirev, A. (2003). <italic>Opt. Commun.</italic>
<bold>216</bold>, 247–260.</mixed-citation>
    </ref>
    <ref id="bb16">
      <mixed-citation publication-type="other">Loh, N. D. <italic>et al.</italic> (2013). <italic>Opt. Express</italic>, <bold>21</bold>, 12385.</mixed-citation>
    </ref>
    <ref id="bb17">
      <mixed-citation publication-type="other">Manetti, M., Samoylova, L., Schneidmiller, E., Sinn, H., Szuba, J., Wrona, K. &amp; Yurkov, M. (2016). <italic>XPD: XFEL Photon Pulses Database</italic>, https://in.xfel.eu/xpd/.</mixed-citation>
    </ref>
    <ref id="bb18">
      <mixed-citation publication-type="other">Park, H. J. <italic>et al.</italic> (2013). <italic>Opt. Express</italic>, <bold>21</bold>, 28729.</mixed-citation>
    </ref>
    <ref id="bb19">
      <mixed-citation publication-type="other">Potter, D. E. (1973). <italic>Computational Physics.</italic> New York: Wiley.</mixed-citation>
    </ref>
    <ref id="bb20">
      <mixed-citation publication-type="other">Roling, S., Zacharias, H., Samoylova, L., Sinn, H., Tschentscher, Th., Chubar, O., Buzmakov, A., Schneidmiller, E., Yurkov, M. V., Siewert, F., Braun, S. &amp; Gawlitza, P. (2014). <italic>Phys. Rev. ST Accel. Beams</italic>, <bold>17</bold>, 110705.</mixed-citation>
    </ref>
    <ref id="bb21">
      <mixed-citation publication-type="other">Roth, T., Helfen, L., Hallmann, J., Samoylova, L., Kwaśniewski, P., Lengeler, B. &amp; Madsen, A. (2014). <italic>Proc. SPIE</italic>, <bold>9207</bold>, 920702.</mixed-citation>
    </ref>
    <ref id="bb22">
      <mixed-citation publication-type="other">Rutishauser, S., Samoylova, L., Krzywinski, J., Bunk, O., Grünert, J., Sinn, H., Cammarata, M., Fritz, D. M. &amp; David, C. (2012). <italic>Nat. Commun.</italic>
<bold>3</bold>, 947.</mixed-citation>
    </ref>
    <ref id="bb23">
      <mixed-citation publication-type="other">Saldin, E. L., Schneidmiller, E. A. &amp; Yurkov, M. V. (1999). <italic>Nucl. Instrum. Methods Phys. Res. Sect. A</italic>, <bold>429</bold>, 233–237.</mixed-citation>
    </ref>
    <ref id="bb24">
      <mixed-citation publication-type="other">Samoylova, L., Sinn, H., Siewert, F., Mimura, H., Yamauchi, K. &amp; Tschentscher, T. (2009). <italic>Proc. SPIE</italic>, <bold>7360</bold>, 1–9.</mixed-citation>
    </ref>
    <ref id="bb25">
      <mixed-citation publication-type="other">Schneidmiller, E. A. &amp; Yurkov, M. V. (2016). <italic>J. Mod. Opt.</italic>
<bold>63</bold>, 288–292.</mixed-citation>
    </ref>
    <ref id="bb26">
      <mixed-citation publication-type="other">Sutter, J., Chubar, O. &amp; Suvorov, A. (2014). <italic>Proc. SPIE</italic>, <bold>9209</bold>, 92090I.</mixed-citation>
    </ref>
    <ref id="bb27">
      <mixed-citation publication-type="other">Suvorov, A., Cunsolo, A., Chubar, O. &amp; Cai, Y. Q. (2015). <italic>Opt. Express</italic>, <bold>23</bold>, 31607–31618.</mixed-citation>
    </ref>
    <ref id="bb28">
      <mixed-citation publication-type="other">Yashchuk, V. V., Samoylova, L. V. &amp; Kozhevnikov, I. V. (2015). <italic>Opt. Eng.</italic>
<bold>54</bold>, 025108.</mixed-citation>
    </ref>
    <ref id="bb29">
      <mixed-citation publication-type="other">Yoon, C. H., Yurkov, M. V., Schneidmiller, E. A., Samoylova, L., Buzmakov, A., Jurek, Z., Ziaja, B., Santra, R., Loh, N. D., Tschentscher, T. &amp; Mancuso, A. (2016). <italic>Sci. Rep.</italic>
<bold>6</bold>, 24791.</mixed-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig id="fig1" position="float">
    <label>Figure 1</label>
    <caption>
      <p>General structure of the <italic>WPG</italic> framework.</p>
    </caption>
    <graphic xlink:href="j-49-01347-fig1"/>
  </fig>
  <fig id="fig2" position="float">
    <label>Figure 2</label>
    <caption>
      <p>Workflow chart: a wavefront propagates through a beamline, which is set up as a container of propagators. Top: a simple ‘linear’ workflow for a regular beamline; bottom: beamline with two branches, <italic>e.g</italic>. XFEL split-and-delay lines.</p>
    </caption>
    <graphic xlink:href="j-49-01347-fig2"/>
  </fig>
  <fig id="fig3" position="float">
    <label>Figure 3</label>
    <caption>
      <p>Example of a beamline definition: the SASE3 beamline at the European XFEL will include two horizontal offset mirrors (M1 and M2), a vertical focusing mirror M3, and horizontal and vertical clean-up slits.</p>
    </caption>
    <graphic xlink:href="j-49-01347-fig3"/>
  </fig>
  <fig id="fig4" position="float">
    <label>Figure 4</label>
    <caption>
      <p>An example of three-dimensional wavefront visualization. For the SASE3 undulator with a defined maximum active segment length of 130 m, the simulated XFEL pulse data taken from the XPD (Manetti <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb17"> ▸</xref>) are used: photon energy 800 eV, electron bunch charge 250 pC and electron energy 14 GeV. The top row corresponds to an untapered undulator and pulse energy 8 mJ, and the bottom row to an undulator with optimized tapering (Schneidmiller &amp; Yurkov, 2016<xref ref-type="bibr" rid="bb25"> ▸</xref>) and pulse energy 17 mJ. (<italic>a</italic>), (<italic>c</italic>) Vertical cuts of the pulse phase and intensity; (<italic>b</italic>), (<italic>d</italic>) slice-to-slice shift of the pulse center of mass. The slice times are color coded and the intensities are represented by the size of the circles.</p>
    </caption>
    <graphic xlink:href="j-49-01347-fig4"/>
  </fig>
  <fig id="fig5" position="float">
    <label>Figure 5</label>
    <caption>
      <p>Intensity distribution around the sample position of the SCS instrument. Left panel (<italic>a</italic>), (<italic>c</italic>): the clean-up slits in the vertical and horizontal focus are fully open. Right panel (<italic>b</italic>), (<italic>d</italic>): both clean-up slits are closed to a gap of 50 µm. The cuts perpendicular to the optical axis in (<italic>c</italic>) and (<italic>d</italic>) correspond to −6, 0 and 6 mm positions around the focus.</p>
    </caption>
    <graphic xlink:href="j-49-01347-fig5"/>
  </fig>
  <table-wrap id="table1" position="float">
    <label>Table 1</label>
    <caption>
      <title>Optical elements (propagators) available in the <italic>WPG</italic>
</title>
      <p>The parameters are shown in <bold><italic>bold italic</italic></bold> and the names of the propagators in <italic>italic</italic>.</p>
    </caption>
    <table frame="hsides" rules="groups">
      <thead valign="top">
        <tr>
          <th style="border-bottom:1px solid black;" rowspan="1" colspan="1" align="left" charoff="50" valign="bottom">Optics</th>
          <th style="border-bottom:1px solid black;" rowspan="1" colspan="1" align="left" charoff="50" valign="bottom">Propagator</th>
          <th style="border-bottom:1px solid black;" rowspan="1" colspan="1" align="left" charoff="50" valign="bottom">Parameters</th>
          <th style="border-bottom:1px solid black;" rowspan="1" colspan="1" align="left" charoff="50" valign="bottom">Comments</th>
        </tr>
      </thead>
      <tbody valign="top">
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Free space</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <italic>Drift</italic>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <bold>
              <italic>Propagation distance</italic>
            </bold>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top">In most cases the semi-analytical propagation is recommended, see §3.1<xref ref-type="sec" rid="sec3.1"/>.</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Slits, apertures</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <italic>Aperture</italic>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top"><bold><italic>Slit or obstacle</italic></bold>, <bold><italic>shape</italic></bold> (rectangular or circular), <bold><italic>slit width</italic></bold>, <bold><italic>height</italic></bold>, <bold><italic>slit center coordinates</italic></bold>
</td>
          <td rowspan="1" colspan="1" align="left" valign="top">For a circular aperture only slit width is used as aperture diameter.</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Grazing-incidence plane elliptical mirror</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <italic>Mirror_elliptical</italic>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top"><bold><italic>Orientation</italic></bold>, <bold><italic>p</italic></bold> and <bold><italic>q</italic></bold>, distances to source and focus, <bold><italic>incidence angle</italic></bold> in the mirror center, <bold><italic>misalignment angle</italic></bold>, <bold><italic>mirror length</italic></bold>
</td>
          <td rowspan="1" colspan="1" align="left" valign="top">See §3.3<xref ref-type="sec" rid="sec3.3"/> for details.</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Thin lens</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <italic>Lens</italic>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top"><bold><italic>Focal lengths</italic></bold> in horizontal and vertical plane, and <bold><italic>lens center coordinates</italic></bold>
</td>
          <td rowspan="1" colspan="1" align="left" valign="top">Can be used to model sagittal bending in a plane elliptical mirror or to approximate focusing with a spherical mirror.</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Mirror surface error<xref ref-type="table-fn" rid="tfn1">†</xref>
</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <italic>WF_dist</italic>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top"><bold><italic>Mesh</italic></bold> and <bold><italic>dimensions</italic></bold>
</td>
          <td rowspan="1" colspan="1" align="left" valign="top">Phase screen approach is used to introduce wavefront distortions caused by residual surface height errors (Samoylova <italic>et al.</italic>, 2009<xref ref-type="bibr" rid="bb24"> ▸</xref>).</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Grazing-incidence VLS grating</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <italic>VLS_grating</italic>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top"><bold><italic>Substrate</italic></bold> (a mirror propagator), <bold><italic>diffraction order number m</italic></bold>, <bold><italic>grove density g</italic><sub>0</sub></bold> in the grating center, <bold><italic>g<sub>k</sub></italic></bold>, <bold><italic>k</italic> = 1,…, 4</bold>, <bold><italic>grove density polynomial coefficients</italic></bold>: <italic>g</italic> = <italic>g</italic>
<sub>0</sub> + <italic>g</italic>
<sub>1</sub>
<italic>x</italic> + <italic>g</italic>
<sub>2</sub>
<italic>x</italic>
<sup>2</sup> + <italic>g</italic>
<sub>3</sub>
<italic>x</italic>
<sup>3</sup> + <italic>g</italic>
<sub>4</sub>
<italic>x</italic>
<sup>4</sup>
</td>
          <td rowspan="1" colspan="1" align="left" valign="top">See §3.3<xref ref-type="sec" rid="sec3.3"/> for details.</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Crystal monochromator</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <italic>Xtal</italic>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top"><bold><italic>Interplanar spacing</italic></bold> of the selected Bragg reflection <italic>H</italic>, <bold><italic>Fourier components of electric susceptibility</italic></bold>,<xref ref-type="table-fn" rid="tfn2">‡</xref> crystal <bold><italic>thickness</italic></bold>, <bold><italic>asymmetry angle</italic></bold>, <bold><italic>deviation of the incidence angle</italic></bold> from the rocking curve center</td>
          <td rowspan="1" colspan="1" align="left" valign="top"> </td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">CRLs</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <italic>CRLs</italic>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top">Obligatory parameters: <bold><italic>which focal plane</italic></bold> (1 for horizontal, 2 for vertical, 3 for both), <bold><italic>δ</italic></bold>, <bold><italic>attenuation length</italic></bold>, <bold><italic>shape</italic></bold> (parabolic or spherical), horizontal and vertical <bold><italic>aperture diameters</italic></bold>, <bold><italic>tip radius</italic></bold>, <bold><italic>number</italic></bold> of CRLs (holes), <bold><italic>lens thickness at apex</italic></bold>; optional parameters: a flat array/list of <bold><italic>void center coordinates and radii</italic></bold>: [<italic>x</italic>
<sub>1</sub>, <italic>y</italic>
<sub>1</sub>, <italic>r</italic>
<sub>1</sub>, <italic>x</italic>
<sub>2</sub>, <italic>y</italic>
<sub>2</sub>, <italic>r</italic>
<sub>2</sub>,…], <bold><italic>initial photon energy</italic></bold>, <bold><italic>final photon energy</italic></bold>
</td>
          <td rowspan="1" colspan="1" align="left" valign="top">See also §3.3<xref ref-type="sec" rid="sec3.3"/> on modeling voids in CRLs. Note: the energy range parameters are used only if the attenuation length and <italic>δ</italic> are arrays. Then the dispersion effect of CRLs is taken into account.</td>
        </tr>
      </tbody>
    </table>
    <table-wrap-foot>
      <fn id="tfn1">
        <label>†</label>
        <p>The propagator should be used together with the <monospace>calculateOPD</monospace>() function, see Fig. 3<xref ref-type="fig" rid="fig3"> ▸</xref>.</p>
      </fn>
      <fn id="tfn2">
        <label>‡</label>
        <p>For <italic>0</italic>, <italic>H</italic> and −<italic>H</italic> reciprocal lattice nodes for reflection <italic>H</italic>.</p>
      </fn>
    </table-wrap-foot>
  </table-wrap>
</floats-group>
