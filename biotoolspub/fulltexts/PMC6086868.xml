<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Commun</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Commun</journal-id>
    <journal-title-group>
      <journal-title>Nature Communications</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2041-1723</issn>
    <publisher>
      <publisher-name>Nature Publishing Group UK</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6086868</article-id>
    <article-id pub-id-type="publisher-id">5658</article-id>
    <article-id pub-id-type="doi">10.1038/s41467-018-05658-8</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Maximal viral information recovery from sequence data using VirMAP</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" corresp="yes" equal-contrib="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-3808-8576</contrib-id>
        <name>
          <surname>Ajami</surname>
          <given-names>Nadim J</given-names>
        </name>
        <address>
          <email>nadimajami@gmail.com</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author" equal-contrib="yes">
        <name>
          <surname>Wong</surname>
          <given-names>Matthew C.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-7621-8829</contrib-id>
        <name>
          <surname>Ross</surname>
          <given-names>Matthew C.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Lloyd</surname>
          <given-names>Richard E.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Petrosino</surname>
          <given-names>Joseph F.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0001 2160 926X</institution-id><institution-id institution-id-type="GRID">grid.39382.33</institution-id><institution>Alkek Center for Metagenomics and Microbiome Research, </institution><institution>Baylor College of Medicine, </institution></institution-wrap>Houston, TX 77030 USA </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0001 2160 926X</institution-id><institution-id institution-id-type="GRID">grid.39382.33</institution-id><institution>Department of Molecular Virology and Microbiology, </institution><institution>Baylor College of Medicine, </institution></institution-wrap>Houston, TX 77030 USA </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>10</day>
      <month>8</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>10</day>
      <month>8</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2018</year>
    </pub-date>
    <volume>9</volume>
    <elocation-id>3205</elocation-id>
    <history>
      <date date-type="received">
        <day>6</day>
        <month>9</month>
        <year>2017</year>
      </date>
      <date date-type="accepted">
        <day>5</day>
        <month>7</month>
        <year>2018</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2018</copyright-statement>
      <license license-type="OpenAccess">
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Accurate classification of the human virome is critical to a full understanding of the role viruses play in health and disease. This implies the need for sensitive, specific, and practical pipelines that return precise outputs while still enabling case-specific post hoc analysis. Viral taxonomic characterization from metagenomic data suffers from high background noise and signal crosstalk that confounds current methods. Here we develop VirMAP that overcomes these limitations using techniques that merge nucleotide and protein information to taxonomically classify viral reconstructions independent of genome coverage or read overlap. We validate VirMAP using published data sets and viral mock communities containing RNA and DNA viruses and bacteriophages. VirMAP offers opportunities to enhance metagenomic studies seeking to define virome-host interactions, improve biosurveillance capabilities, and strengthen molecular epidemiology reporting.</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">Viral taxonomic characterization from metagenomic data suffers from high background noise and signal crosstalk. Here, the authors develop VirMAP, a novel pipeline for analyses of metagenomic data that classifies viral reconstructions independent of genome coverage or read overlap.</p>
    </abstract>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2018</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1" sec-type="introduction">
    <title>Introduction</title>
    <p id="Par3">Accurate classification of viral sequences in metagenomic datasets remains challenging despite large advances in next-generation sequencing and bioinformatics. Current methods rely on the classification of individual reads and/or contigs through either alignments<sup><xref ref-type="bibr" rid="CR1">1</xref>–<xref ref-type="bibr" rid="CR8">8</xref></sup> or kmer analyses<sup><xref ref-type="bibr" rid="CR9">9</xref>,<xref ref-type="bibr" rid="CR10">10</xref></sup>. These approaches are all restricted by similar problems including: reads, contigs, or kmers mapping equally well to different genomes, codon degeneracy allowing two low-identity nucleotide sequences to code identical polypeptides, widely varying sequence coverage impacting assembler heuristics, large amounts of contaminating sequences, and databases lacking sufficient coverage of the viral tree of life. While some of these issues are solved by generating high-quality contigs from an assembly, achieving the necessary coverage for a quality assembly remains challenging. These issues are particularly relevant to clinical and environmental virology as they prevent accurate characterization of viruses from sequence data alone.</p>
    <p id="Par4">We here develop VirMAP to address the current challenges in identification and classification of low coverage and highly divergent viruses within metagenomic datasets. VirMAP uses a variety of techniques including a mapping assembly algorithm combining nucleotide and amino-acid alignment information in a tiered manner to build virus-like super-scaffolds, a merging system designed to hybridize a mapping assembly and a de-novo assembly, an improvement algorithm that iteratively merges and rebuilds contig information, and a taxonomic classification algorithm that is centered around a bits-per-base scoring system (Fig. <xref rid="Fig1" ref-type="fig">1</xref>).<fig id="Fig1"><label>Fig. 1</label><caption><p>A schematic overview of VirMAP. Data processing with VirMAP is achieved through four main stages (shaded colors) divided into nine major steps (top left corner). A putative list of viral genomes and protein pseudo-scaffolds are constructed from <italic>clustered</italic> nucleotide and translated alignments to the Genbank viral and phage divisions (gbvrl and gbphage). Nucleotide and amino acid pseudo-scaffolds are “built” and merged into a single super-scaffold per genome. A merged de novo assembly is constructed and merged in, resulting in contigs that are then <italic>refined</italic> using an iterative rebuild process. The improved dual assembly is filtered against a comprehensive Genbank database and are taxonomically <italic>classified</italic> using a novel per-base contig scoring system</p></caption><graphic xlink:href="41467_2018_5658_Fig1_HTML" id="d29e277"/></fig></p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>Test data sets</title>
      <p id="Par5">To evaluate the performance of VirMAP, we chose four publicly available datasets that encompass common scenarios faced when determining viral taxonomies (e.g., high vs low coverage, high vs. low database homology, high vs. low non-viral background). We also performed the same analysis using a more standard approach described in the online methods to compare VirMAP’s output, runtime, and computational results (Supplementary Data <xref rid="MOESM3" ref-type="media">1</xref> and Supplementary Note <xref rid="MOESM1" ref-type="media">1</xref>). Finally, to evaluate the impact of genome coverage in the classification of viral taxonomies, we ran all samples subsampled at 10%, 1%, and 0.1%, 10 times each. For the results discussed below, VirMAP did not report any taxonomies with &lt;1000 bits of aggregate alignment information across all contigs, unless otherwise noted.</p>
    </sec>
    <sec id="Sec4">
      <title>Mock Communities</title>
      <p id="Par6">We generated a single viral mock community (VMC) (<ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/sra/?term=PRJNA431646">BioProject ID PRJNA431646</ext-link>) by combining purified preparations of seven different viruses (human mastadenovirus B, human mastadenovirus C, murine gammaherpesvirus 4, coxsackievirus B4 [strain Tuscany], echovirus E13 [strain Del Carmen], human poliovirus type 1 [strain Mahoney], and rotavirus A) at different concentrations in phosphate-buffered saline. VMC was extracted, reverse transcribed with random hexamers, amplified using barcoded semi-random primers, and sequenced on the Illumina HiSeq2500 platform (2 × 150 bp) at varying sequencing depths yielding 36,974,536 total reads (Methods). Following standard adapter trimming and filtering (hg38 and PhiX), 6,180,026 total reads remained. The majority of reads were filtered using BBDuk due to a high presence of adapter dimers and human genome contamination (41.75%) likely a consequence of low DNA concentration in the library preparation.</p>
      <p id="Par7">VirMAP assigned 50.1% (3,099,015) of quality trimmed, adapter trimmed, and human-filtered VMC reads to viruses. Of these, 99.99% were assigned to the following: human poliovirus 1 (47.04%), human mastadenovirus C (30.90%), coxsackievirus B4 (13.30%), murid gammaherpesvirus 4 (7.43%), echovirus E13 (0.78%), human mastadenovirus B (0.55%), and rotavirus A (32 reads, 0.0010%) (Fig. <xref rid="Fig2" ref-type="fig">2</xref> and Supplementary Data <xref rid="MOESM4" ref-type="media">2</xref>). The remaining 8 reads were assigned to bosavirus MS-2016a, which is thought to be a cell culture contaminant present in fetal bovine serum. The low abundance of rotavirus reads corresponded to the low titer used to build the VMC. A random subsample and mapping of the remaining reads not classified by VirMAP showed high homology to cell culture and mouse host cell lines. No further investigative efforts were performed.<fig id="Fig2"><label>Fig. 2</label><caption><p>Viral Mock Community (VMC) calculated genome coverage depth and span from remapping source reads to VirMAP reconstructed genomes. The VMC consists of purified preparations of seven different viruses (<bold>a</bold>) human poliovirus type 1 [strain Mahoney], (<bold>b</bold>) echovirus E13 [strain Del Carmen], (<bold>c</bold>) coxsackievirus B4 [strain Tuscany], (<bold>d</bold>) human adenovirus (<bold>b</bold>, <bold>e</bold>) human adenovirus (<bold>c</bold>, <bold>f</bold>) murine gammaherpesvirus 4, and (<bold>g</bold>) rotavirus, combined at different concentrations in phosphate-buffered saline. Coverage depth and span are represented for each of the viruses in VMC per nucleotide position. For coverage span, a value of 1 represents a nucleotide position covered with respect to the source genome. VMC is available at <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/sra/?term=PRJNA431646">BioProject ID PRJNA431646</ext-link></p></caption><graphic xlink:href="41467_2018_5658_Fig2_HTML" id="d29e350"/></fig></p>
      <p id="Par8">At 10 and 1% subsampling, VirMAP reported six of seven viral constituents in all trials, with rotavirus remaining unreported (Supplementary Data <xref rid="MOESM4" ref-type="media">2</xref>). At 0.1% subsampling, VirMAP reported six of seven viral constituents in eight of the ten trials, rotavirus remained unreported in all trials. The two trials reporting only five members missed adenovirus B. In all subsampled trials at all depths, no viruses other than the expected members of the VMC were reported by VirMAP.</p>
      <p id="Par9">In addition to processing the VMC dataset with VirMAP, we applied a standard taxonomic classification method (see “methods” section) for comparative purposes. The standard approach reported eight taxonomies. It missed rotavirus but included an unidentified adenovirus and a misclassified adenovirus taxonomic call, likely misclassifications of human mastadenovirus B contigs (Table <xref rid="Tab1" ref-type="table">1</xref> and Supplementary Data <xref rid="MOESM3" ref-type="media">1</xref>). All subsampling trials using the standard approach failed to report rotavirus, similar to VirMAP. At 10% subsampling, the standard approach reported six of seven members of the VMC in only two of ten trials. At 1% and 0.1% subsampling, the standard approach reported no more than three and two members of the VMC, respectively (Supplementary Data <xref rid="MOESM5" ref-type="media">3</xref>).<table-wrap id="Tab1"><label>Table 1</label><caption><p>Comparative analysis of ten viral sequence classifiers</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Pipeline</th><th>Mapped Reads (%)</th><th>Unique Calls</th><th>Viral Taxonomies</th><th>CCR (% of mapped)</th><th>Precision</th><th>Recall</th><th>F-score</th></tr></thead><tbody><tr><td>VirMAP</td><td>3,099,015 (50.1%)</td><td>8</td><td>8</td><td>3,099,007 (99.999%)</td><td>0.88</td><td>1.00</td><td>0.94</td></tr><tr><td colspan="8">Read classification</td></tr><tr><td> FastViromeExplorer</td><td>2,710,170 (43.85%)</td><td>7</td><td>4</td><td>2,710,170 (100%)</td><td>1.00</td><td>0.57</td><td>0.73</td></tr><tr><td>  VirusSeeker<sup>a</sup></td><td>10,750 (0.174%)</td><td>16</td><td>16</td><td>1,467 (13.65%)</td><td>0.31</td><td>0.57</td><td>0.40</td></tr><tr><td>  Kaiju</td><td>2,287,962 (37.02%)</td><td>227</td><td>227</td><td>433,243 (18.94%)</td><td>0.09</td><td>1.00</td><td>0.17</td></tr><tr><td>  ViromeScan</td><td>663,185 (10.73)</td><td>427</td><td>354</td><td>614,016 (92.586%)</td><td>0.01</td><td>0.57</td><td>0.02</td></tr><tr><td colspan="8">Contig classification</td></tr><tr><td>  drVM<sup>b</sup></td><td>22,404,813 (362.54%)</td><td>673</td><td>158</td><td>18,235,876 (81.39%)</td><td>0.35</td><td>1.00</td><td>0.52</td></tr><tr><td>  VirusTAP</td><td>NA</td><td>5</td><td>5</td><td>NA</td><td>0.6</td><td>0.43</td><td>0.50</td></tr><tr><td>  VIPIE<sup>c</sup></td><td>~109633 (~1.77%)</td><td>13</td><td>11</td><td>~23,731 (~21.65%)</td><td>0.30</td><td>0.71</td><td>0.42</td></tr><tr><td> Standard method<sup>d</sup></td><td>2,319,573 (37.53%)</td><td>8</td><td>8</td><td>2,273,193 (98.03%)</td><td>0.75</td><td>0.86</td><td>0.80</td></tr><tr><td colspan="8">Marker gene classification</td></tr><tr><td>  MetaPhlAn2</td><td>NA</td><td>5</td><td>5</td><td>NA</td><td>0.40</td><td>0.29</td><td>0.34</td></tr></tbody></table><table-wrap-foot><p>The Viral Mock Community (VMC) dataset (6,180,026 trimmed reads) was processed through nine different pipelines for viral taxonomic classification. VMC was generated by combining purified preparations of seven different viruses (human adenovirus B, human adenovirus C, murine gammaherpesvirus 4, coxsackievirus B4 [strain Tuscany], echovirus E13 [strain Del Carmen], human poliovirus type 1 [strain Mahoney], and rotavirus A) in phosphate-buffered saline. Unique calls refer to the distinct database entries reported while viral taxonomies represent a reduction of unique calls to NCBI taxonomic ID. CCR: Correctly Classified Reads. Precision: (true positives/true positives + false positives). Recall: (true positives/true positives + false negatives), F-score: harmonic average of recall and precision scores 2 × ((<italic>P</italic> × <italic>R</italic>) / (<italic>P</italic> + <italic>R</italic>))</p><p><sup>a</sup>VirusSeeker applies filtering and clustering techniques to the reads and final counts are derived from this reduced set</p><p><sup>b</sup>drVM internally counts identical reads across multiple reported entries, so the total counts can exceed 100%</p><p><sup>c</sup>VIPIE reports reads as counts per 100,000 reads, the approximation is a rescaled amount against the original read counts</p><p><sup>d</sup>The standard approach employs a metagenomic assembly using MEGAHIT and a sequential top-hit mapping classification using BLASTn and BLASTx</p></table-wrap-foot></table-wrap></p>
      <p id="Par10">The total number of viral bases reconstructed by VirMAP (162,705 bp) relative to the full VMC contig set decreased to 55.55, 25.99, and 10.0% for 10, 1, and 0.1% subsampling levels, respectively. The total viral bases constructed and identified by the standard approach (60,073 bp) decreased to 24.76, 5.36, 0.11% for 10, 1, and 0.1% subsampling levels, respectively. These results highlight VirMAP’s ability to more correctly build viral genomic reconstructions and assign viral taxonomies despite declining genomic coverage. In addition to VirMAP and the standard assembly and mapping approach, we also employed publicly available taxonomic classifiers that rely on read mapping (FastViromeExplorer<sup><xref ref-type="bibr" rid="CR5">5</xref></sup>, VirusSeeker<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, Kaiju<sup><xref ref-type="bibr" rid="CR9">9</xref></sup>, and ViromeScan<sup><xref ref-type="bibr" rid="CR3">3</xref></sup>), contig mapping (VirusTAP<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>, VIPIE<sup><xref ref-type="bibr" rid="CR2">2</xref></sup>), a combination of both read and contig mapping (drVM<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>), or marker gene mapping (MetaPhlAn2<sup><xref ref-type="bibr" rid="CR6">6</xref></sup>), for comparative purposes using the VMC dataset (Table <xref rid="Tab1" ref-type="table">1</xref>). Other existing pipelines (e.g. metaVIC<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>, VIROME<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, VIP<sup><xref ref-type="bibr" rid="CR13">13</xref></sup>, and MetaVir2<sup><xref ref-type="bibr" rid="CR14">14</xref></sup>) were not included in our analysis due to unavailability of essential resources such as missing databases and discontinued web resources.</p>
      <p id="Par11">Using the list of intended viral constituents in VMC, we evaluated the number of unique viruses and total taxonomic IDs found to calculate values for precision, recall, and F-score for each pipeline. Simultaneously, the total number of reads used and the total number of correctly classified reads were tracked. Precision, recall, and F-score values for VirMAP were 0.88, 1.0, 0.94, respectively, on VMC. The recall value indicated that VirMAP was able to find all expected constituents of the mock community, however, the presence of a single viral contaminant lowered the precision value. The F-score shows that VirMAP was highly accurate. CPU hours used were not tracked as not all methods are were locally operated. Contig classifying approaches generally had higher precision values as aligning longer queries minimizes the chance of a colliding alignment with database entries containing short errors, e.g., flanking vector sequences. However, such approaches are not likely to find low abundance viruses due to most assembler’s inability to make contigs from non-overlapping reads. Read classifying approaches generally suffer more from aberrant database alignments and must implement effective filters to overcome these errors to achieve higher precision scores. FastViromeExplorer’s use of the ratio between observed and expected coverage effectively filters a large amount of noise, resulting in an excellent precision value. However, read count and taxonomic rank cutoffs lowered its recall value, similar to most of the other read classifying pipelines. Marker gene mapping methods offer a separate solution to classifying taxonomies while overcoming database contamination issues; however, they are heavily reliant on properly annotated genome entries as well as high coverage. In order to effectively find viruses, we believe a combination of both read and contig mapping approaches must be effectively used.</p>
      <p id="Par12">To validate the VMC result, a wholly separate mock virome was evaluated. The novel enrichment technique of viromes (NetoVir) method for sample preparation was recently described employing a comprehensive mock viral community of nine viruses<sup><xref ref-type="bibr" rid="CR15">15</xref></sup>, and the resulting dataset was made publicly available (<ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/sra/?term=PRJNA319556">BioProject: PRJNA319556</ext-link>). This mock virome consists of known concentrations (ranging from 10<sup>7</sup> to 10<sup>10</sup> genome copies per mL) of nine viruses spanning diverse taxonomic, genomic, and physical characteristics. We selected the control sample (SRR3458562), as it represented the least processed dataset, and analyzed it with VirMAP. A total of 6,707,800 reads (37.04%) were classified as being of viral origin across 10 distinct viral lineages, which included the nine viruses in the mock community (Fig. <xref rid="Fig3" ref-type="fig">3</xref>). One additional virus identified in the set was southern tomato virus, a virus previously observed to co-infect with pepino mosaic virus<sup><xref ref-type="bibr" rid="CR16">16</xref></sup>, a member of the mock community. Overall, a good correlation was observed between the proportion of viral reads per lineage obtained through VirMAP and those reported by Conceição-Neto (<italic>R</italic><sup>2</sup> = 0.9972)<sup><xref ref-type="bibr" rid="CR15">15</xref></sup>.<fig id="Fig3"><label>Fig. 3</label><caption><p>VirMAP analysis of an external mock community. A mock virome control sample (SRR3458562) recently reported<sup><xref ref-type="bibr" rid="CR15">15</xref></sup> was processed with VirMAP. A total of 5,969,272 reads (32.96%) were classified as being of viral origin across 10 distinct viral lineages which included the nine viral constituents of the mock community. Additionally, one putative contaminant virus was identified: southern tomato virus</p></caption><graphic xlink:href="41467_2018_5658_Fig3_HTML" id="d29e815"/></fig></p>
      <p id="Par13">Following a similar approach to the subsampling strategy with VMC, the NetoVir dataset was subsampled at 10, 1, and 0.1%, 10 times each, and analyzed using VirMAP and the standard approach. In all 10 trials at each subsampling depth, all nine mock community viruses were correctly reported by VirMAP except for a single trial at 0.1% subsampling where bovine alphaherpesvirus 1 was missed (Supplementary Data <xref rid="MOESM6" ref-type="media">4</xref>). Viruses other than those present in the mock community were reported by VirMAP. In five trials at 10% and five trials at 1% subsampling, a contig likely belonging to Dickeya virus Limestone was not incorporated into the main Dickeya virus contig and was subsequently underclassified as “myoviridae”. The unincorporated contig maps across the 5′ and 3′ ends of the pseudo-constructed genome, suggesting a circular genome or chimeric misassembly. However, VirMAP’s merging engine assumes a linear genome and is unable to incorporate contigs in this fashion. In one trial at 10%, 16 reads likely belonging to acanthamoeba polyphaga mimivirus were classified as “mimivirus”. In one trial at 10%, 10 reads from southern tomato virus were reported. Finally, in one trial at 1%, 26 reads likely belonging to Dickeya virus Limestone were reported as “unclassified phage”. This error was traced to two database entries, sharing 99% sequence identity to Dickeya virus Limestone, that were misannotated (see Supplementary Note <xref rid="MOESM1" ref-type="media">2</xref> for further discussion).</p>
      <p id="Par14">For the standard approach at 10% subsampling, eight trials reported all nine members of the community, with one trial missing feline panleukopenia virus and one trial missing human polyomavirus 1. At 1% subsampling, all ten trials missed mimivirus, and eight of ten trials missed bovine alphaherpesvirus. At 0.1%, no trial reported more than six of the nine expected viruses. The standard approach reported an average of 5.5, 2.8, and 1.1 erroneous taxonomic IDs per trial at 10, 1, and 0.1% subsampling, respectively (Supplementary Data <xref rid="MOESM7" ref-type="media">5</xref>).</p>
    </sec>
    <sec id="Sec5">
      <title>Published metagenomic data sets</title>
      <p id="Par15">To test VirMAP using clinical samples, we processed a dataset (submitted by University Medical Center Hamburg-Eppendorf on 2015-05-22 under the title Unbiased metagenomic RNA sequencing (UMERS)) of 20 respiratory specimens (BAL, sputum and swab) of patients with seasonal influenza infection and five BAL samples from patients with influenza-negative pneumonia, (<ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/sra/?term=PRJEB7888">BioProject ID PRJEB7888</ext-link>)<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>.</p>
      <p id="Par16">The dataset contained 25 samples totaling 178 Gb represented by 1.75 billion reads generated with both Illumina HiSeq (2 × 100 bp) and MiSeq (2 × 150, 2 × 250, and 2 × 300) chemistries. Of these, 2,430,488 (0.14%) were determined to be viral and 327,940 reads were incorporated into contigs greater than 500 bp that were unclassifiable by VirMAP (Supplementary Data <xref rid="MOESM8" ref-type="media">6</xref>). All individual fastq sets were concatenated based on biosample id and results were compared to those reported by the authors who used qPCR and sequencing to evaluate the samples.</p>
      <p id="Par17">VirMAP was able to reconstruct contigs representing not only all viral genome segments reported by the authors, but also 32 influenza contigs across four samples for which the authors did not report findings (sample IDs 677, 768, 1116, and 1689) (Supplementary Data <xref rid="MOESM9" ref-type="media">7</xref>). Across all publicly available samples, VirMAP recruited 193% more reads to contigs determined to be influenza compared to the authors (UMERS - 263,210 reads, VirMAP - 509,039 reads).</p>
      <p id="Par18">In two instances, the strongest viral signal determined by VirMAP disagreed with the reported one (samples 677 and 768). In both cases, positive H1N1 qPCR results were reported. These two samples represented the two highest CT values observed for the H1N1 specific probe (both CT of 34). In sample 677, VirMAP detected nine influenza A segments and assigned seven segments to H3N2, one segment (genome segment 4) to H1N1, and one to Influenza A. This likely explains the authors positive H1N1 result as the qPCR probe targets genome segment 4. In sample 768, VirMAP partially reconstructed eight influenza A genome segments, assigning all of them to H3N2. However, the signal in this sample was low, consisting of only 60 total reads. The positive H1N1 qPCR indicates that an H1N1 genome may have been present at a level below the limit of detection for sequencing.</p>
      <p id="Par19">Additionally, VirMAP determined sample 104 to have the strongest H1N1 signal among all samples tested based on the number of recruited reads. However, the authors reported a negative H1N1 qPCR result for this sample. Mapping the probe sequence against VirMAP’s reconstructed H1N1 segment 4 shows a mismatch at base 15 of the probe sequence, potentially explaining their negative result.</p>
      <p id="Par20">The authors also report five samples containing viruses other than influenza. VirMAP found the same viruses in three out of five samples. The data for the remaining two reported samples were not among the publicly available files. In addition to non-influenza viruses reported by the authors, VirMAP was able to detect human herpesvirus 4 in two samples, human parainfluenza virus 3 in a sample other than the one reported by the authors, and astrovirus HK2014 in one sample.</p>
      <p id="Par21">The standard approach for this dataset yielded an average of 6.13 influenza segments per sample across 16 of the 20 known positive samples, with the remaining four samples producing no results, mirroring the authors original result. Segments produced by the standard approach consisted of 1.07 contigs per segment on average (Supplementary Data <xref rid="MOESM10" ref-type="media">8</xref>). For comparison, VirMAP yielded an average of 9.05 influenza segments per sample across all 20 samples. All segments reconstructed by VirMAP consisted of one contig per segment. The average number of segments reported by VirMAP exceeded the number of Influenza genome segments because VirMAP identified multiple influenza virus subtypes per sample across the majority of samples. The extra segments were found in trace amounts and below the threshold that any assembler could use to generate a contig.</p>
      <p id="Par22">The Influenza dataset was subsampled using the same conditions as the mock communities described above. At 10% subsampling, the standard approach reported influenza in 10 out of 20 samples in at least one trial. For trials where influenza was found, an average of 5.23 influenza segments were reported. The remaining 10 samples failed to produce influenza contigs in any trial. Using the same dataset, VirMAP reported influenza across all 20 samples in at least one trial. For trials where influenza was found, an average of 6.55 influenza genome segments were reported. At 1% subsampling, the standard approach, when finding influenza, averaged 2.73 segments across 7 samples, while VirMAP, when finding influenza, averaged 4.22 segments across 18 samples. At 0.1% subsampling, the standard approach, when finding influenza, averaged 2.1 segments in one sample, while VirMAP, when finding influenza, averaged 2.23 segments across 17 samples. However, in two samples the influenza signal was below the default aggregate cutoff of 1000 bits per taxon, and thus would not have been reported. (Supplementary Data <xref rid="MOESM11" ref-type="media">9</xref>). We compared the total reconstructed sequence length of influenza segments between VirMAP and the standard approach at all levels of subsampling. Results show VirMAP improves both the length and contiguity of influenza segments when using the total dataset and at all levels of subsampling (Fig. <xref rid="Fig4" ref-type="fig">4</xref>).<fig id="Fig4"><label>Fig. 4</label><caption><p>A comparison of VirMAP and the Standard Approach using the influenza virus dataset (<ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/sra/?term=PRJEB7888">BioProject ID PRJEB7888</ext-link>). The total length of reconstructed influenza virus segments was calculated at different levels of subsampling by adding the total number of base pairs found for across segments. An average N50 was calculated at each subsampling level by averaging the N50 values for all trials (20 at 100%, 200 at 10, 1, and 0.1). The percentage of positive trials correspond to the ratio of trials with &gt;1 identifiable influenza contig over the total number of trials (20 at 100%, 200 at 10, 1, and 0.1%). Tukey plots, bar: statistical median, edges: low, 25%; high 75% quartiles, whiskers:1.5 × interquartile range, dots: outliers)</p></caption><graphic xlink:href="41467_2018_5658_Fig4_HTML" id="d29e885"/></fig></p>
      <p id="Par23">These results highlight drawbacks of assembly-based classification methods, primarily the dependency on overlapping read segments, which precludes assembly of low abundance viruses. As VirMAP combines information derived from both read mapping and read assembling, it is able to extract and classify viral information even if the underlying coverage of a virus is well below the abilities of a de-novo assembly engine. This is especially apparent in the 0.1% subsampling set; VirMAP still reported the influenza virus in 17 out of 20 samples, while the standard approach reported influenza virus in only one.</p>
      <p id="Par24">To test VirMAP against a more complex metagenomic dataset, we used a data set submitted by the University of Brasilia on 01 August 2017 under the project title “Viral diversity of the Federal District of Brazil” (<ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/sra/?term=PRJNA395784">BioProject ID PRJNA395784</ext-link>). This dataset was chosen due to its recent submission and potentially complex viral community composition. Four samples totaling 19.23 Gb represented by 199.67 million reads generated with Illumina (2 × 100 bp) chemistry from a TruSeq RNA library with a ribosomal depletion step were processed through VirMAP. Of these, 4,932,775 (2.47%) were determined to be viral and 2,062,096 million reads were incorporated into contigs greater than 500 bp that were unclassifiable. A total of 489 viral taxonomies were identified in all four samples, of which Laverivirus UC1 captured the most reads (1,046,272 reads). The virus reported in all four samples that captured the most reads (428,511) was maize rayado fino virus. Sample SRR5868318 contained a high prevalence of human enteric viruses and was collected in June of 2014 (Supplementary Data <xref rid="MOESM12" ref-type="media">10</xref>).</p>
      <p id="Par25">This dataset was also processed with the standard assembly and mapping approach described previously. Initial standard results were filtered to remove taxa IDs with &lt;300 aggregate bits of alignment, which lowered the average number of taxa IDs reported per sample from 480 to 236 (Supplementary Data <xref rid="MOESM13" ref-type="media">11</xref> and Supplementary Data <xref rid="MOESM14" ref-type="media">12</xref>). Three-hundred bits of aggregate alignment information was empirically chosen as a filtering cutoff for the standard approach since the number of taxa containing only contigs with very weak (50–100) bit-scores increased substantially below that threshold. This suggests that the majority of taxa IDs found by the standard approach below that threshold are potentially very low information hits. For VirMAP, the internal pipeline filters all viral contigs below 300 bits of information, and the standard table construction script further filters taxa IDs that score below an aggregate 1000 bits of alignment information. 300 bits is the default threshold as contigs containing less aggregate alignment information were commonly observed to be false positives. VirMAP found an average of 423 taxa IDs per sample in the raw unfiltered output (300 bits/contig minimum), and reported an average of 231 taxa IDs per sample in the filtered table output (1000 bits/taxa ID minimum). As these samples are environmental, there is no underlying ground truth to compare against. The standard approach found 4.3 megabases of contigs that could be mapped to a viral taxonomy; when filtered at 300 aggregate bits per taxon, 4.0 megabases of contigs could be mapped to a viral taxonomy. These results suggest that the taxa IDs filtered by the 300 bit threshold are from short contigs and not longer contigs containing short and weak alignments to viral sequences. VirMAP in its raw output was only able to construct 1.69 megabases of contigs, and 1.04 megabases of contigs when filtered. The disparity between total contig length reported is likely caused by the standard assembly creating longer low coverage contigs that have slight homology to known viral proteins, as only the top scoring alignment per contig is used for classification. One example would be a prophage embedded in highly divergent bacteria serving as a contig’s best alignment event. Such a contig would contribute its full length to the total length of viral contigs on the weight of a single low query coverage alignment event. Contrasting with VirMAP’s strategy to use as much alignment information as possible when calling a contig’s taxonomic origin, this issue causes the standard approach to be prone to false positives, especially in low scoring situations. The amount of contigs per taxa ID in the filtered datasets was 2.29 for VirMAP and 12.25 for the standard approach. For the raw datasets, VirMAP assigned 1.81 contigs per taxa ID while the standard approach assigned 6.94. This shows that the standard approach created more contigs containing only low scoring alignments to a single taxa ID. Upon filtering, the remaining taxa IDs with higher amounts of alignment information are much more fragmented on average. VirMAP exhibits this behavior as well, albeit at a much lower rate.</p>
      <p id="Par26">The four samples from the Brazilian sewage set were subsampled according to the same conditions as the mock communities and Influenza dataset. When unfiltered, the standard approach yielded an average of 274 taxa per sample per trial at 10% subsampling (Supplementary Data <xref rid="MOESM15" ref-type="media">13</xref>). The 1 and 0.1% trials yielded an average of 68 and eight taxa, respectively. When filtered, the standard approach yielded an average of 112, 30, and 4 taxa per sample per trial for the 10, 1 and 0.1% trials, respectively. VirMAP averaged 453, 189, and 77 taxa per sample per trial for the unfiltered tables, and an average of 174, 62, and 24 taxa per sample per trial for the filtered tables of the 10, 1 and 0.1% trials, respectively. For the 10% unfiltered set, VirMAP reported more taxa IDs than the non-subsampled unfiltered run. An inspection showed this to be caused by different random portions of low coverage, low identity viruses not containing enough aggregate alignment information to enter the LCA engine, resulting in an overclassification of contigs. However, when filtering using the default 1000 bit threshold this artifact disappeared. Comparing either filtered or unfiltered tables, the drop-off in detectable taxa when subsampling was not as steep with VirMAP, suggesting a more gradual drop off in the retrieval of meaningful information at increasingly suboptimal coverage levels. A qualitative comparison on how the pipelines presented in Table <xref rid="Tab1" ref-type="table">1</xref> performed on the Influenza and Brazil datasets can be found in Supplementary Note <xref rid="MOESM1" ref-type="media">3</xref>.</p>
    </sec>
  </sec>
  <sec id="Sec6" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par27">Here we present a pipeline for viral metagenomics that aims to maximize viral information recovery and reconstruction to provide the highest level of taxonomic resolution possible. It operates in a manner independent of coverage depth and offers parameters that can be modified to tune the sensitivity/specificity tradeoff (Supplementary Data <xref rid="MOESM16" ref-type="media">14</xref>). VirMAP was created out of the necessity to accurately define viral taxonomies from clinical and environmental samples which lacked closely related database entries. This pipeline provides a unique methodology for viral detection and classification with relevance in clinical virology, viral surveillance, and molecular epidemiology. Overall, VirMAP offers a major advancement over existing viral classification pipelines in the accurate detection and identification of viral sequences from metagenomic datasets and provides the user with intermediate and final outputs to continue post hoc investigation for case-specific studies.</p>
  </sec>
  <sec id="Sec7">
    <title>Methods</title>
    <sec id="Sec8">
      <title>Contig generation</title>
      <p id="Par28">VirMAP employs both de-novo and mapping assembly strategies to create a working set of contigs. For the mapping arm, input reads are dereplicated and digitally normalized<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> using default parameters. These two steps reduce the amount of data used while minimizing information loss; however, they are not required. Processed reads are aligned to a comprehensive viral nucleotide and viral protein database sourced from the Genbank viral (gbvrl) and phage (gbphg) divisions using BBMap<sup><xref ref-type="bibr" rid="CR19">19</xref></sup> and DIAMOND<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>, respectively. All translated alignments within 20% of the subject sequence and within 8% of the top scoring subject per query are reported. For nucleotide alignments the thresholds are 90% and 5%, respectively. These thresholds were empirically found to minimize false positive centroids in the downstream clustering step. Reads are assigned to viral genomes by nucleotide and translated alignments resulting in a set of reads per genome. Genomic read sets are then filtered by Jaccard distance if high numbers of non-unique read membership are observed relative to larger sets. Each nucleotide and amino acid entry associated with a non-filtered genome is individually reconstructed using a naive pileup assembly. Reconstructed protein coding sequences are tiled on top of their originating genome via their annotated CDS positions. Disagreements within an assembly are masked. If there are disagreements between the nucleotide and amino-acid mapping assemblies, precedence is given to the nucleotide call. The entire process creates a pseudo-assembled nucleotide super-scaffold representing coherently assembled viral information. VirMAP’s mapping reconstruction performs well even in situations where an underlying genome has both low read depth and high divergence from the nearest known databaszae entry. For the de-novo arm, the full read set undergoes a multi-kmer de-novo assembly using either MEGAHIT<sup><xref ref-type="bibr" rid="CR21">21</xref>,<xref ref-type="bibr" rid="CR22">22</xref></sup> or Tadpole<sup><xref ref-type="bibr" rid="CR19">19</xref></sup>, or both. This step can provide secondary confirmation of the pseudo-constructed contigs and can allow viral genomes without any nearby database entry to potentially be constructed if coverage is sufficient.</p>
    </sec>
    <sec id="Sec9">
      <title>Iterative assembly improvement</title>
      <p id="Par29">All constructed contigs are mapped to a custom database described in the Taxonomic determination section. Contigs that map outside the viral superkingdom are filtered. Filtering is accomplished with the same technique used in the taxonomic determination step described below. Dereplicated reads are mapped to the remaining contigs and a continuous cycle of merging, mapping, piling up, and re-assembling is carried out until all contigs converge. Merging is accomplished by iteratively mapping the contigs to themselves and joining any two with significant overlap. Reassembly is accomplished using a naive pileup mapping assembly of the dereplicated, non-normalized read set. After convergence, the reads are mapped to the final set of contigs and read abundance is calculated.</p>
    </sec>
    <sec id="Sec10">
      <title>Taxonomic determination</title>
      <p id="Par30">To determine the taxonomic origin of a contig, VirMAP employs a two-pass taxonomic scoring algorithm that considers alignments in terms of maximum bit-score per base achieved by a subject taxon for each contig, as well as the relative bit-score per base for each subject entry per taxon weighted against the best scoring taxon at each position. Pass one calculates a maximum achieved bit score per base for each subject taxon by dividing the bit score by the aligned length for each alignment event and applying the fractional score to the subject taxon across the bases covered. Top scores per taxon and globally across all taxa are tracked for every covered base position. The top scores for each subject taxon across all positions covered by the taxon’s alignment events are summed up and represent a taxon’s best potential alignment independent of subject contiguity. In pass two, once the global top scores per position are known, each subject alignment’s bit score per base is weighted against the global top score per position. All second pass weighted scores per subject entry are summed up for each taxon across all base positions. This second pass creates a secondary store of information akin to an aggregate overall identity of a taxon’s database entries relative to the contig in question. Essentially, the scoring algorithm considers the best possible alignment of a query against an individual taxon (pass one), as well as the aggregate relative accuracy of all alignments achieved by a taxon (pass two) as two independent scores per query. This helps in events where a small amount of misclassified entries in a taxon are slightly closer to the contig in question relative to the true taxon of origin. By using the secondary database “volume,” misclassified entries have a much lower chance of causing a contig classification error as all of the neighboring entries in their taxon will contribute much lower amounts of “volume.” All scores are independently calculated from nucleotide and translated alignments of the improved contigs to a comprehensive Genbank database spanning 16 separate divisions (Supplementary Note <xref rid="MOESM1" ref-type="media">4</xref>). Pass two nucleotide scores are weighed down exponentially while protein scores are weighed down tetrationally. Since protein sequences are generally more conserved, any mismatch in amino acid alignment is penalized more heavily. A contig is filtered if its top scoring pass one taxon is not in the superkingdom virus, or if &gt; 50% of its aligning bases do not resolve to the superkingdom virus. All pass one taxa scoring within a dynamically calculated radius per contig are considered in a rank-wise lowest common ancestor (LCA) algorithm. The radius varies based on the best scoring taxon relative to a hypothetical maximum scoring self-alignment as well as the total bits of information possible given the maximum self-score. In the LCA engine, each taxon contributes its pass two score to its parent taxon if there is no taxon scoring above a dynamically calculated majority threshold at the current rank. The threshold is calculated by the total amount of database “volume” calculated in pass two across all taxa entering the LCA. As the total input database volume increases, the amount of database volume required above a 50% majority decreases. Thus, if a viral taxon is poorly represented in the database, a higher threshold is required to assign taxonomy. Conversely, if a taxon is very well represented, only a slight majority is required. If no taxon exceeds the threshold, the contig is assigned to the taxon that maximizes pass two score (“volume”) above the viral superkingdom. Pass one scores are only used as a barrier to entry for the LCA engine</p>
    </sec>
    <sec id="Sec11">
      <title>Code availability</title>
      <p id="Par31">The VirMAP software is open-source and available online at <ext-link ext-link-type="uri" xlink:href="https://github.com/cmmr/VirMAP">https://github.com/cmmr/VirMAP</ext-link>. VirMAP is implemented in Perl. For questions, comments, and notification of software updates, users can follow the VirMAP GitHub page. A document titled VirMAP_program_usage_and_options_table.xlsx describing command line options and a description of the software components used is available through GitHub.</p>
    </sec>
    <sec id="Sec12">
      <title>Data availability</title>
      <p id="Par32">The raw sequence datasets generated and analyzed during the current study are available through the Sequence Read Archive as follows: Viral Mock Community, <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/sra/?term=PRJNA431646">BioProject ID PRJNA431646</ext-link>; NetoVir mock community, <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/sra/?term=PRJNA319556">BioProject: PRJNA319556</ext-link>; Influenza dataset, <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/sra/?term=PRJEB7888">BioProject ID PRJEB7888</ext-link>; Brazil dataset, <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/sra/?term=PRJNA395784">BioProject ID PRJNA395784</ext-link>. The authors declare that all other data supporting the findings of this study are available within the article and its <xref rid="MOESM2" ref-type="media">supplementary information files</xref>, or are available from the authors upon request.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Electronic supplementary material</title>
    <sec id="Sec14">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41467_2018_5658_MOESM1_ESM.pdf">
            <caption>
              <p>Supplementary Information</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="41467_2018_5658_MOESM2_ESM.pdf">
            <caption>
              <p>Description of Additional Supplementary Files</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="41467_2018_5658_MOESM3_ESM.xlsx">
            <caption>
              <p>Supplementary Data 1</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM4">
          <media xlink:href="41467_2018_5658_MOESM4_ESM.xlsx">
            <caption>
              <p>Supplementary Data 2</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM5">
          <media xlink:href="41467_2018_5658_MOESM5_ESM.xlsx">
            <caption>
              <p>Supplementary Data 3</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM6">
          <media xlink:href="41467_2018_5658_MOESM6_ESM.xlsx">
            <caption>
              <p>Supplementary Data 4</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM7">
          <media xlink:href="41467_2018_5658_MOESM7_ESM.xlsx">
            <caption>
              <p>Supplementary Data 5</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM8">
          <media xlink:href="41467_2018_5658_MOESM8_ESM.xlsx">
            <caption>
              <p>Supplementary Data 6</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM9">
          <media xlink:href="41467_2018_5658_MOESM9_ESM.xlsx">
            <caption>
              <p>Supplementary Data 7</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM10">
          <media xlink:href="41467_2018_5658_MOESM10_ESM.xlsx">
            <caption>
              <p>Supplementary Data 8</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM11">
          <media xlink:href="41467_2018_5658_MOESM11_ESM.xlsx">
            <caption>
              <p>Supplementary Data 9</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM12">
          <media xlink:href="41467_2018_5658_MOESM12_ESM.xlsx">
            <caption>
              <p>Supplementary Data 10</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM13">
          <media xlink:href="41467_2018_5658_MOESM13_ESM.xlsx">
            <caption>
              <p>Supplementary Data 11</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM14">
          <media xlink:href="41467_2018_5658_MOESM14_ESM.xlsx">
            <caption>
              <p>Supplementary Data 12</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM15">
          <media xlink:href="41467_2018_5658_MOESM15_ESM.xlsx">
            <caption>
              <p>Supplementary Data 13</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM16">
          <media xlink:href="41467_2018_5658_MOESM16_ESM.xlsx">
            <caption>
              <p>Supplementary Data 14</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p><bold>Publisher's note:</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
    <fn>
      <p>These authors contributed equally: Nadim J Ajami, Matthew C. Wong</p>
    </fn>
  </fn-group>
  <sec>
    <title>Electronic supplementary material</title>
    <p><bold>Supplementary Information</bold> accompanies this paper at 10.1038/s41467-018-05658-8.</p>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We would like to thank Tulin Ayvaz, Auriole Tamegnon, Hannah Moreno, Nguyen Truong and past members of the CMMR technician team for sample processing. We also thank Mary K. Estes and Paul Ling for providing virus preparations. In addition, we acknowledge Christopher Stewart and Lorenzo D’Amico for contributing to the revision of this work, and Ginger Metcalf, Harsha Doddapaneni, Donna Muzny, and Richard Gibbs at the Human Genome Sequencing Center, Baylor College of Medicine, for support with sequence data generation.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>N.J.A. and M.C.W. contributed to the conceptualization, development, testing, and analysis of VirMAP. M.C.W. developed the code for VirMAP. M.C.R. contributed to the development of laboratory methods for the creation of viral mock communities, data generation, and initial conceptualization of VirMAP. R.E.L. contributed to conceptualization and testing of VirMAP. J.F.P. contributed to the conceptualization of VirMAP. All authors contributed to the preparation and review of this manuscript.</p>
  </notes>
  <notes notes-type="COI-statement">
    <p>The authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lin</surname>
            <given-names>HH</given-names>
          </name>
          <name>
            <surname>Liao</surname>
            <given-names>YC</given-names>
          </name>
        </person-group>
        <article-title>drVM: a new tool for efficient genome assembly of known eukaryotic viruses from metagenomes</article-title>
        <source>Gigascience</source>
        <year>2017</year>
        <volume>6</volume>
        <fpage>1</fpage>
        <lpage>10</lpage>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lin</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Vipie: web pipeline for parallel characterization of viral populations from multiple NGS samples</article-title>
        <source>BMC Genom.</source>
        <year>2017</year>
        <volume>18</volume>
        <fpage>378</fpage>
        <pub-id pub-id-type="doi">10.1186/s12864-017-3721-7</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rampelli</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>ViromeScan: a new tool for metagenomic viral community profiling</article-title>
        <source>BMC Genom.</source>
        <year>2016</year>
        <volume>17</volume>
        <fpage>165</fpage>
        <pub-id pub-id-type="doi">10.1186/s12864-016-2446-3</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Segata</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Metagenomic microbial community profiling using unique clade-specific marker genes</article-title>
        <source>Nat. Methods</source>
        <year>2012</year>
        <volume>9</volume>
        <fpage>811</fpage>
        <lpage>814</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.2066</pub-id>
        <?supplied-pmid 22688413?>
        <pub-id pub-id-type="pmid">22688413</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tithi</surname>
            <given-names>SS</given-names>
          </name>
          <name>
            <surname>Aylward</surname>
            <given-names>FO</given-names>
          </name>
          <name>
            <surname>Jensen</surname>
            <given-names>RV</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>L</given-names>
          </name>
        </person-group>
        <article-title>FastViromeExplorer: a pipeline for virus and phage identification and abundance profiling in metagenomics data</article-title>
        <source>PeerJ</source>
        <year>2018</year>
        <volume>6</volume>
        <fpage>e4227</fpage>
        <pub-id pub-id-type="doi">10.7717/peerj.4227</pub-id>
        <?supplied-pmid 29340239?>
        <pub-id pub-id-type="pmid">29340239</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Truong</surname>
            <given-names>DT</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>MetaPhlAn2 for enhanced metagenomic taxonomic profiling</article-title>
        <source>Nat. Methods</source>
        <year>2015</year>
        <volume>12</volume>
        <fpage>902</fpage>
        <lpage>903</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.3589</pub-id>
        <?supplied-pmid 26418763?>
        <pub-id pub-id-type="pmid">26418763</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Yamashita</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Sekizuka</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Kuroda</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>VirusTAP: viral genome-targeted assembly pipeline</article-title>
        <source>Front. Microbiol.</source>
        <year>2016</year>
        <volume>7</volume>
        <fpage>32</fpage>
        <?supplied-pmid 26870004?>
        <pub-id pub-id-type="pmid">26870004</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhao</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>VirusSeeker, a computational pipeline for virus discovery and virome composition analysis</article-title>
        <source>Virology</source>
        <year>2017</year>
        <volume>503</volume>
        <fpage>21</fpage>
        <lpage>30</lpage>
        <pub-id pub-id-type="doi">10.1016/j.virol.2017.01.005</pub-id>
        <?supplied-pmid 28110145?>
        <pub-id pub-id-type="pmid">28110145</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Menzel</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Ng</surname>
            <given-names>KL</given-names>
          </name>
          <name>
            <surname>Krogh</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Fast and sensitive taxonomic classification for metagenomics with Kaiju</article-title>
        <source>Nat. Commun.</source>
        <year>2016</year>
        <volume>7</volume>
        <fpage>11257</fpage>
        <pub-id pub-id-type="doi">10.1038/ncomms11257</pub-id>
        <?supplied-pmid 27071849?>
        <pub-id pub-id-type="pmid">27071849</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wood</surname>
            <given-names>DE</given-names>
          </name>
          <name>
            <surname>Salzberg</surname>
            <given-names>SL</given-names>
          </name>
        </person-group>
        <article-title>Kraken: ultrafast metagenomic sequence classification using exact alignments</article-title>
        <source>Genome Biol.</source>
        <year>2014</year>
        <volume>15</volume>
        <fpage>R46</fpage>
        <pub-id pub-id-type="doi">10.1186/gb-2014-15-3-r46</pub-id>
        <?supplied-pmid 24580807?>
        <pub-id pub-id-type="pmid">24580807</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <mixed-citation publication-type="other">Modha, S. <italic>MetaViC: Virus Metagenomics Pipeline for Unknown Host or in Absence of a Host Genome</italic><ext-link ext-link-type="uri" xlink:href="https://github.com/sejmodha/MetaViC">https://github.com/sejmodha/MetaViC</ext-link> (2016).</mixed-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wommack</surname>
            <given-names>KE</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>VIROME: a standard operating procedure for analysis of viral metagenome sequences</article-title>
        <source>Stand. Genom. Sci.</source>
        <year>2012</year>
        <volume>6</volume>
        <fpage>427</fpage>
        <lpage>439</lpage>
        <pub-id pub-id-type="doi">10.4056/sigs.2945050</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>VIP: an integrated pipeline for metagenomics of virus identification and discovery</article-title>
        <source>Sci. Rep.</source>
        <year>2016</year>
        <volume>6</volume>
        <fpage>23774</fpage>
        <pub-id pub-id-type="doi">10.1038/srep23774</pub-id>
        <?supplied-pmid 27026381?>
        <pub-id pub-id-type="pmid">27026381</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Roux</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Tournayre</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Mahul</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Debroas</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Enault</surname>
            <given-names>F</given-names>
          </name>
        </person-group>
        <article-title>Metavir 2: new tools for viral metagenome comparison and assembled virome analysis</article-title>
        <source>BMC Bioinforma.</source>
        <year>2014</year>
        <volume>15</volume>
        <fpage>76</fpage>
        <pub-id pub-id-type="doi">10.1186/1471-2105-15-76</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Conceicao-Neto</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Modular approach to customise sample preparation procedures for viral metagenomics: a reproducible protocol for virome analysis</article-title>
        <source>Sci. Rep.</source>
        <year>2015</year>
        <volume>5</volume>
        <fpage>16532</fpage>
        <pub-id pub-id-type="doi">10.1038/srep16532</pub-id>
        <?supplied-pmid 26559140?>
        <pub-id pub-id-type="pmid">26559140</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <mixed-citation publication-type="other">Padmanabhan, C., Zheng, Y., Li, R., Fei, Z. &amp; Ling, K. S. Complete genome sequence of southern tomato virus naturally infecting tomatoes in Bangladesh. <italic>Genome Announc.</italic><bold>3</bold>, 10.1128/genomeA.01522-15 (2015).</mixed-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Fischer</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Evaluation of unbiased next-generation sequencing of RNA (RNA-seq) as a diagnostic method in influenza virus-positive respiratory Samples</article-title>
        <source>J. Clin. Microbiol.</source>
        <year>2015</year>
        <volume>53</volume>
        <fpage>2238</fpage>
        <lpage>2250</lpage>
        <pub-id pub-id-type="doi">10.1128/JCM.02495-14</pub-id>
        <?supplied-pmid 25972420?>
        <pub-id pub-id-type="pmid">25972420</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <mixed-citation publication-type="other">Titus Brown, C., Howe, A., Zhang, Q., Pyrkosz, A. B. &amp; Brom, T. H. A reference-free algorithm for computational normalization of shotgun sequencing data. <italic>arXiv</italic> 1203.4802v2 (2012).</mixed-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Bushnell</surname>
            <given-names>B</given-names>
          </name>
        </person-group>
        <source>BBMap Short Read Aligner</source>
        <year>2016</year>
        <publisher-loc>Berkeley, California</publisher-loc>
        <publisher-name>University of California</publisher-name>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Buchfink</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Xie</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Huson</surname>
            <given-names>DH</given-names>
          </name>
        </person-group>
        <article-title>Fast and sensitive protein alignment using DIAMOND</article-title>
        <source>Nat. Methods</source>
        <year>2015</year>
        <volume>12</volume>
        <fpage>59</fpage>
        <lpage>60</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.3176</pub-id>
        <?supplied-pmid 25402007?>
        <pub-id pub-id-type="pmid">25402007</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Liu</surname>
            <given-names>CM</given-names>
          </name>
          <name>
            <surname>Luo</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Sadakane</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Lam</surname>
            <given-names>TW</given-names>
          </name>
        </person-group>
        <article-title>MEGAHIT: an ultra-fast single-node solution for large and complex metagenomics assembly via succinct de Bruijn graph</article-title>
        <source>Bioinformatics</source>
        <year>2015</year>
        <volume>31</volume>
        <fpage>1674</fpage>
        <lpage>1676</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btv033</pub-id>
        <?supplied-pmid 25609793?>
        <pub-id pub-id-type="pmid">25609793</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>MEGAHIT v1.0: A fast and scalable metagenome assembler driven by advanced methodologies and community practices</article-title>
        <source>Methods</source>
        <year>2016</year>
        <volume>102</volume>
        <fpage>3</fpage>
        <lpage>11</lpage>
        <pub-id pub-id-type="doi">10.1016/j.ymeth.2016.02.020</pub-id>
        <?supplied-pmid 27012178?>
        <pub-id pub-id-type="pmid">27012178</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
