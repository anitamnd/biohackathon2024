<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">BMC Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">BMC Bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>BMC Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="epub">1471-2105</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">5353803</article-id>
    <article-id pub-id-type="publisher-id">1583</article-id>
    <article-id pub-id-type="doi">10.1186/s12859-017-1583-2</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Software</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>microclass: an R-package for 16S taxonomy classification</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Liland</surname>
          <given-names>Kristian Hovde</given-names>
        </name>
        <address>
          <email>kristian.liland@nofima.no</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Vinje</surname>
          <given-names>Hilde</given-names>
        </name>
        <address>
          <email>hilde.vinje@nmbu.no</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-2883-861X</contrib-id>
        <name>
          <surname>Snipen</surname>
          <given-names>Lars</given-names>
        </name>
        <address>
          <email>lars.snipen@nmbu.no</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ISNI">0000 0004 0607 975X</institution-id><institution-id institution-id-type="GRID">grid.19477.3c</institution-id><institution>Department of Chemistry, </institution><institution>Biotechnology and Food Sciences, Norwegian University of Life Sciences, </institution></institution-wrap>Ås, P.O. Box 5003, N-1432 Norway </aff>
      <aff id="Aff2"><label>2</label>Nofima - Norwegian Institute of Food, Fisheries and Aquaculture Research, Osloveien 1, Ås, N-1430 Norway </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>16</day>
      <month>3</month>
      <year>2017</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>16</day>
      <month>3</month>
      <year>2017</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2017</year>
    </pub-date>
    <volume>18</volume>
    <elocation-id>172</elocation-id>
    <history>
      <date date-type="received">
        <day>21</day>
        <month>8</month>
        <year>2016</year>
      </date>
      <date date-type="accepted">
        <day>3</day>
        <month>3</month>
        <year>2017</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2017</copyright-statement>
      <license license-type="OpenAccess">
        <license-p><bold>Open Access</bold> This article is distributed under the terms of the Creative Commons Attribution 4.0 International License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted use, distribution, and reproduction in any medium, provided you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The Creative Commons Public Domain Dedication waiver (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/publicdomain/zero/1.0/">http://creativecommons.org/publicdomain/zero/1.0/</ext-link>) applies to the data made available in this article, unless otherwise stated.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <sec>
        <title>Background</title>
        <p>Taxonomic classification based on the 16S rRNA gene sequence is important for the profiling of microbial communities. In addition to giving the best possible accuracy, it is also important to quantify uncertainties in the classifications.</p>
      </sec>
      <sec>
        <title>Results</title>
        <p>We present an R package with tools for making such classifications, where the heavy computations are implemented in C++ but operated through the standard R interface. The user may train classifiers based on specialized data sets, but we also supply a ready-to-use function trained on a comprehensive training data set designed specifically for this purpose. This tool also includes some novel ways to quantify uncertainties in the classifications.</p>
      </sec>
      <sec>
        <title>Conclusions</title>
        <p>Based on input sequences of varying length and quality, we demonstrate how the output from the classifications can be used to obtain high quality taxonomic assignments from 16S sequences within the R computing environment. The package is publicly available at the Comprehensive R Archive Network.</p>
      </sec>
      <sec>
        <title>Electronic supplementary material</title>
        <p>The online version of this article (doi:10.1186/s12859-017-1583-2) contains supplementary material, which is available to authorized users.</p>
      </sec>
    </abstract>
    <kwd-group xml:lang="en">
      <title>Keywords</title>
      <kwd>R</kwd>
      <kwd>Taxonomy</kwd>
      <kwd>16S</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100008119</institution-id>
            <institution>Norges Miljø- og Biovitenskapelige Universitet</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2017</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Background</title>
    <p>The profiling of microbial communities by the sequencing of the 16S rRNA gene has become a standard approach in metagenomics [<xref ref-type="bibr" rid="CR1">1</xref>]. This means that collected DNA is subject to a targeted sequencing to extract a selected region of the 16S gene from all organisms in the sample. The actual content of the sample can then be described by performing a large scale taxonomic classification of these sequences, i.e. assign them to the proper taxonomic bin, also referred to as binning [<xref ref-type="bibr" rid="CR2">2</xref>]. Since 16S-based microbial profiling has become such a widely adopted approach, it is also important that the bioinformatics tools involved are optimized to the highest standard. A widely used tool for this job is the RDP-classifier [<xref ref-type="bibr" rid="CR3">3</xref>]. It is beyond doubt a good tool for this job, but at the same time it is not perfect, and in a systematic testing of this and other approaches we found there were always other methods that performed better [<xref ref-type="bibr" rid="CR4">4</xref>]. Alternative tools are a benefit to the scientific community, and here we present a software to be used within the popular R computing environment [<xref ref-type="bibr" rid="CR5">5</xref>].</p>
    <p>There are some issues that must be considered when it comes to making tools for the binning of 16S sequences. First, the pattern recognition algorithm itself must be capable of recognizing the, sometimes small, differences in DNA that separates taxa. It must also handle the huge amount of bins or categories we are facing here, thousands rather than 2–3 which is often the case in textbook literature. Precision also very much depends on the quality of the training data [<xref ref-type="bibr" rid="CR6">6</xref>]. Due to the ever expanding taxonomy of prokaryotes, there are no comprehensive gold standard data sets available. Along with the microclass package described here, we also supply the microcontax R data package, containing designed data sets based on a consensus taxonomy assignment among several data repositories. This is probably the closest we get to a gold standard today.</p>
    <p>Speed is another issue. With today’s sequencing technology and low prices, a data set may easily contain millions of reads. Some procedures for OTU (Operational Taxonomic Unit) picking will start out by classifying reads to pre-defined taxa [<xref ref-type="bibr" rid="CR7">7</xref>]. Thus, the number of sequences to classify may be huge. Other procedures cluster the reads before taxonomy assignments, defining OTU’s as ’spherical’ clusters in a space of evolutionary distances approximated by alignment percentage identity, and then classify only the cluster centroids [<xref ref-type="bibr" rid="CR8">8</xref>]. In some applications, e.g. in forensic applications [<xref ref-type="bibr" rid="CR9">9</xref>], we are more interested in recognizing specific taxonomic profiles rather than discovering new taxa. In such cases the classification of all reads into pre-defined bins is clearly what we seek.</p>
    <p>Uncertainty is the third issue. In any collection of reads there will be a number of sequences that cannot be given a high-confidence classification. There are several reasons for this. First, the taxonomy itself is not always well defined, and sometimes even high-quality sequences fall on the border between existing taxa, making the classification uncertain. Second, due to sequencing errors and chimeras some reads may be difficult to recognize, and third, some microbial communities will contain new taxa not previously seen.</p>
    <p>In the presented R-package we have implemented some algorithms that have proved efficient and/or are much used for 16S taxonomic classification. Efforts have been made to make them both fast and memory-efficient. All methods can be trained on new data, but we have also supplied the package with a ready-to-use tool that is already trained and optimized for the contax.trim data set from [<xref ref-type="bibr" rid="CR10">10</xref>]. This tool also quantifies uncertainties in a new way. The microclass R-package, as well as its symbiotic data package microcontax, are freely available at the Comprehensive R Archive Network (CRAN, [<xref ref-type="bibr" rid="CR11">11</xref>]).</p>
  </sec>
  <sec id="Sec2">
    <title>Implementation</title>
    <sec id="Sec3">
      <title>The multinomial method</title>
      <p>Based on our previous testing of <italic>K</italic>-mer based classification methods in [<xref ref-type="bibr" rid="CR4">4</xref>] we found that the best overall results were obtained by the algorithm denoted the multinomial method [<xref ref-type="bibr" rid="CR12">12</xref>]. Thus, we have focused the attention on this method in this package. The function multinomTrain is used to train a model of this type on any data set containing FASTA-formatted sequences along with the correct taxon assignments for each sequence. The function multinomClassify is then used to classify new sequences based on a trained model.</p>
      <p>Both training of a multinomial model and classification of new sequences involves counting a large number of <italic>K</italic>-mers (overlapping words of length <italic>K</italic>) in the sequences. The overhead when doing such operations is large, and efficient vectorization is difficult to achieve. A direct implementation would also require the computation of a matrix product of size (<italic>N</italic>×4<sup><italic>K</italic></sup>) · (4<sup><italic>K</italic></sup>×<italic>M</italic>), where <italic>N</italic> and <italic>M</italic> are the number of sequences to classify and the number of taxa in the training data, respectively. This is a time consuming task for large <italic>N</italic>, <italic>M</italic> and <italic>K</italic>. Therefore, these computations have been implemented in C++ through the Rcpp [<xref ref-type="bibr" rid="CR13">13</xref>] interface in R, and some short-cuts are made, which will be explained in the following paragraphs.</p>
      <p>The nucleotide sequences are first converted to integer vectors my mapping A, C, G and T (or U) to 0, 1, 2, and 3, while all other letters are mapped to - 4<sup>15</sup>. The latter is done to easily discard <italic>K</italic>-mers including alien symbols when counting. For training of a multinomial model, all <italic>K</italic>-mers of each taxon are counted. The counting itself is done by sliding a window along the integer vector of each sequence and computing a position as the inner product between [ 4<sup><italic>K</italic>−1</sup>,4<sup><italic>K</italic>−2</sup>,…,4,1] and the integers in the window. For each of the inner products, this position in the taxon’s counting vector is increased by 1. The result is a matrix, <bold><italic>X</italic></bold>, of size (<italic>M</italic>×4<sup><italic>K</italic></sup>) that holds the counts for all <italic>K</italic>-mers in all taxa. Finally, each position in the matrix is re-scaled to <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\log _{2}\left (\frac {x_{ij}-P/4^{K}}{\sum {x_{i\cdot }}-P}\right)$\end{document}</tex-math><mml:math id="M2"><mml:munder><mml:mrow><mml:mo>log</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:munder><mml:mfenced close=")" open="(" separators=""><mml:mrow><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mtext mathvariant="italic">ij</mml:mtext></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mi>P</mml:mi><mml:mo>/</mml:mo><mml:msup><mml:mrow><mml:mn>4</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:mo>∑</mml:mo><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>·</mml:mo></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mi>P</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq1.gif"/></alternatives></inline-formula>, where <italic>P</italic> is the number of pseudo-counts added. This is stored in an (<italic>M</italic>×4<sup><italic>K</italic></sup>) matrix named <bold><italic>Q</italic></bold> to represent multinomial log-probabilities with pseudo-counts.</p>
      <p>When classifying new sequences using the multinomial method, we avoid the mentioned matrix product by combining the <italic>K</italic>-mer counting with summing of multinomial log-probabilities. For each counted <italic>K</italic>-mer, the corresponding column in the <bold><italic>Q</italic></bold> matrix is added to the result, thus never explicitly creating the <italic>K</italic>-mer count matrix or performing the product with <bold><italic>Q</italic></bold>. As such we reduce from (4<sup><italic>K</italic></sup>·<italic>M</italic>) operations to ((<italic>n</italic>−<italic>K</italic>)·<italic>M</italic>) for a new sequence of length <italic>n</italic>. For full 16S sequences (with <italic>n</italic>≈1500 bases) the number of calculations will be lower for <italic>K</italic>&gt;5.27 and is easily parallelized.</p>
    </sec>
    <sec id="Sec4">
      <title>The taxMachine</title>
      <p>Users often want a ready-to-use tool to classify (many) 16S sequences without having to perform all the training. Based on the work in [<xref ref-type="bibr" rid="CR4">4</xref>] we have arrived at an optimized tool for classifying 16S sequences, called taxMachine in this package. The taxMachine is based on using the multinomial method with a word length of <italic>K</italic>=8 and a pseudo count of 100. It has been trained on full-length 16S sequences to recognize full or partial (reads) sequences at the genus level, using the designed and optimized contax.trim data set for training. See the microcontax data package for details. The taxMachine includes computations of classification uncertainties that requires a detailed explanation.</p>
    </sec>
    <sec id="Sec5">
      <title>Classification uncertainty</title>
      <p>Uncertainty in a taxonomic classification can be split into two types. The first type is when a sequence happens to be very close to the decision boundary between two or more taxa. We can be fairly certain it belongs to one of these taxa, but it lacks the final discriminative power to safely assign it to one of them. The second type of uncertainty occurs when something completely new is seen. This is not uncommon in metagenome samples, and should be flagged separately since it may indicate sequencing errors, chimeras or some novel type of organism.</p>
      <sec id="Sec6">
        <title>The <italic>d</italic>-score</title>
        <p>The first type of uncertainty is measured by what we name the <italic>d</italic>-score. Consider sequence <italic>i</italic> in a set of sequences that we want to classify. In the taxMachine the predicted genus of sequence <italic>i</italic> is found by computing the posterior log-probability for every genus, and classifying to the genus with maximum value. If we sort all posterior log-probabilities for sequence <italic>i</italic> in descending order, <italic>p</italic>
<sub><italic>i</italic>,1</sub> denotes this maximum, while <italic>p</italic>
<sub><italic>i</italic>,2</sub> is the second largest, etc. These log-probabilities all depend on the sequence length, since a longer sequence will in general contain more unique <italic>K</italic>-mers, and the posterior log-probability will be a sum with more (negative) terms. This is illustrated in the left panel of Fig. <xref rid="Fig1" ref-type="fig">1</xref>. Here we have sampled fragments of random length (&gt;100 bases) from all sequences in the contax.trim data set, and then classified them, collecting the <italic>p</italic>
<sub><italic>i</italic>,1</sub> for sequence <italic>i</italic>=1,…,38 781. The <italic>p</italic>
<sub><italic>i</italic>,1</sub> values are clearly biased by sequence length, and their variance is also increasing for longer sequences.
<fig id="Fig1"><label>Fig. 1</label><caption><p>Posterior log-probability normalization. The <italic>left panel</italic> shows posterior log-probabilities for 38 781 sequences. The sequences are random sub-sequences of the contax.trim data set, spanning all lengths from 100 bases to more than 1500. Every sequence has been classified using the multinomial model trained on the full-length data, and each <italic>dot marks</italic> the maximum posterior log-probability for one sequence. There is clearly a linear trend in the values, with larger variance for longer sequences. In the <italic>right panel</italic> the same values are plotted after the normalization procedure described in the text</p></caption><graphic xlink:href="12859_2017_1583_Fig1_HTML" id="MO1"/></fig>
</p>
        <p>We first normalize the posterior log-probability with respect to sequence length. We fitted linear regression models describing how both the mean and the standard deviation of the data in the left panel of Fig. <xref rid="Fig1" ref-type="fig">1</xref> varies by sequence length <italic>l</italic>. Thus, if sequence <italic>i</italic> has length <italic>l</italic> it gets the normalized posterior log-probability 
<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document} $$ \tilde{p}_{i,1} = \frac{p_{i,1}-\hat{p}_{l}}{\hat{s}_{l}}   $$ \end{document}</tex-math><mml:math id="M4"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>ŝ</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="12859_2017_1583_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula>
</p>
        <p>where <inline-formula id="IEq2"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\hat {p}_{l}$\end{document}</tex-math><mml:math id="M6"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq2.gif"/></alternatives></inline-formula> and <inline-formula id="IEq3"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\hat {s}_{l}$\end{document}</tex-math><mml:math id="M8"><mml:msub><mml:mrow><mml:mi>ŝ</mml:mi></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq3.gif"/></alternatives></inline-formula> are the predicted mean and standard deviation at sequence length <italic>l</italic>, using the fitted regression models. Note that <italic>p</italic>
<sub><italic>i</italic>,2</sub> (and any other posterior log-probability) can be normalized in the same way, using the same fitted regression model.</p>
        <p>The <italic>d</italic>-score of sequence <italic>i</italic> is simply the difference between the largest and the second largest normalized posterior log-probability: 
<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document} $$ d_{i} = \tilde{p}_{i,1} - \tilde{p}_{i,2}  $$ \end{document}</tex-math><mml:math id="M10"><mml:msub><mml:mrow><mml:mi>d</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:math><graphic xlink:href="12859_2017_1583_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula>
</p>
        <p>If we are near a decision boundary we expect <italic>d</italic>
<sub><italic>i</italic></sub>≈0 since the second best genus is almost as good as the best. On the other hand, if <italic>d</italic>
<sub><italic>i</italic></sub>&gt;&gt;0 it means the predicted genus is much more likely than any other, and we have a high confidence classification.</p>
      </sec>
      <sec id="Sec7">
        <title>The <italic>r</italic>-score</title>
        <p>The second type of uncertainty is high if we see something very different from what we have in the training data set. Consider sequence <italic>i</italic> belonging to genus <italic>g</italic> with corresponding normalized maximum posterior log-probability <inline-formula id="IEq4"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\tilde {p}_{i,1}$\end{document}</tex-math><mml:math id="M12"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq4.gif"/></alternatives></inline-formula> from (<xref rid="Equ1" ref-type="">1</xref>). From all sequences belonging to genus <italic>g</italic> we computed the sample mean and sample standard deviation of the <inline-formula id="IEq5"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\tilde {p}_{i,1}$\end{document}</tex-math><mml:math id="M14"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq5.gif"/></alternatives></inline-formula>’s, denoted <inline-formula id="IEq6"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\bar {p}_{g}$\end{document}</tex-math><mml:math id="M16"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq6.gif"/></alternatives></inline-formula> and <italic>s</italic>
<sub><italic>g</italic></sub> respectively. The <italic>r</italic>-score for sequence <italic>i</italic> is the standardized residual 
<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document} $$ r_{i} = \frac{\tilde{p}_{i,1} - \bar{p}_{g}}{\bar{s}_{g}}   $$ \end{document}</tex-math><mml:math id="M18"><mml:msub><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>s</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="12859_2017_1583_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula>
</p>
        <p>where <inline-formula id="IEq7"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\bar {s}_{g}$\end{document}</tex-math><mml:math id="M20"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>s</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq7.gif"/></alternatives></inline-formula> is a smoothed version of <italic>s</italic>
<sub><italic>g</italic></sub> as explained below. Thus, the r-score is a standardized measure of how different a sequence is from its predicted genus centre.</p>
        <p>Different genera have different sequence diversity, which is reflected in different values of the sample standard deviation <italic>s</italic>
<sub><italic>g</italic></sub>. However, many genera have too few sequences to provide a reliable estimate of this standard deviation, some even have only 1 sequence making <italic>s</italic>
<sub><italic>g</italic></sub> impossible to compute. Thus, the <inline-formula id="IEq8"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\bar {s}_{g}$\end{document}</tex-math><mml:math id="M22"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>s</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq8.gif"/></alternatives></inline-formula> in (<xref rid="Equ3" ref-type="">3</xref>) is based on a simple smoothing. First, all sample standard deviations where grouped by genus-size. In Fig. <xref rid="Fig2" ref-type="fig">2</xref> we show how smaller genera (few sequences) tend to have smaller sample standard deviations. We used the loess method [<xref ref-type="bibr" rid="CR14">14</xref>] to estimate the size-specific sample standard deviation, shown as black squares in Fig. <xref rid="Fig2" ref-type="fig">2</xref>. We denote this <italic>s</italic>
<sub><italic>n</italic></sub> where <italic>n</italic> is the genus-size. If genus <italic>g</italic> has size <italic>n</italic> we get the genus-specific standard deviation estimate as 
<disp-formula id="Equ4"><label>4</label><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document} $$ \bar{s}_{g} = \sqrt{\frac{(n - 1) s_{g}^{2} + s_{n}^{2}}{n}}   $$ \end{document}</tex-math><mml:math id="M24"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>s</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msqrt><mml:mrow><mml:mfrac><mml:mrow><mml:mo>(</mml:mo><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo>)</mml:mo><mml:msubsup><mml:mrow><mml:mi>s</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup><mml:mo>+</mml:mo><mml:msubsup><mml:mrow><mml:mi>s</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:msqrt></mml:math><graphic xlink:href="12859_2017_1583_Article_Equ4.gif" position="anchor"/></alternatives></disp-formula>
<fig id="Fig2"><label>Fig. 2</label><caption><p>Smoothing genus standard deviation. The sample standard deviations for every genus (<italic>grey rings</italic>) are plotted against genus size (number of sequences). The <italic>black squares</italic> are the mean values for each genus size, after loess-smoothing as described in the text</p></caption><graphic xlink:href="12859_2017_1583_Fig2_HTML" id="MO2"/></fig>
</p>
        <p>When a new sequence is classified, we do not know its true genus. The predicted genus is then used as a plug-in in (<xref rid="Equ3" ref-type="">3</xref>), i.e. we use <inline-formula id="IEq9"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\bar {p}_{g}$\end{document}</tex-math><mml:math id="M26"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq9.gif"/></alternatives></inline-formula> and <inline-formula id="IEq10"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\bar {s}_{g}$\end{document}</tex-math><mml:math id="M28"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>s</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq10.gif"/></alternatives></inline-formula> where <italic>g</italic> is the predicted genus. If the resulting <italic>r</italic>
<sub><italic>i</italic></sub> has a large negative value, it means the computed <inline-formula id="IEq11"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\tilde {p}_{i,1}$\end{document}</tex-math><mml:math id="M30"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq11.gif"/></alternatives></inline-formula> is much smaller than the average <inline-formula id="IEq12"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$\bar {p}_{g}$\end{document}</tex-math><mml:math id="M32"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>g</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2017_1583_Article_IEq12.gif"/></alternatives></inline-formula> for genus <italic>g</italic>, and sequence <italic>i</italic> is unlikely to belong to this genus even if this is where it maximizes the posterior probability.</p>
        <p>Exactly how negative is the <italic>r</italic>-score for an un-recognized sequence? To guide this decision we computed the <italic>r</italic>-scores for all sequences in the contax.full data set [<xref ref-type="bibr" rid="CR10">10</xref>], and from this we computed the empirical cumulative distribution function. For any given <italic>r</italic>
<sub><italic>i</italic></sub> value this gives us the probability of having an <italic>r</italic>-score this small, or smaller, given that the sequence was from the training data. A very small probability means the sequence is very unusual compared to the training data.</p>
      </sec>
    </sec>
    <sec id="Sec8">
      <title>Other methods</title>
      <p>The package also contains some alternatives to the multinomial method, mostly for comparisons. The RDP-classifier [<xref ref-type="bibr" rid="CR3">3</xref>] is a popular tool used in many metagenome applications. The version implemented here is a stripped version without the bootstrapping effort to quantify uncertainties in the classifications. It has been implemented in C++ and accelerated similarly to the multinomial method, see above for details.</p>
      <p>A classification using BLAST is also included, since this approach has been common. It is both slower and less precise then the other methods. It requires the BLAST+ software to be installed on the system.</p>
    </sec>
  </sec>
  <sec id="Sec9">
    <title>Results and discussion</title>
    <p>The microclass package provides optimized tools for taxonomic classification of 16S sequence data in the R computing environment. Some well established and proven methods are available to all users of R, with the possibility to train all methods on new and specialized data sets. However, a ready-made classification tool, taxMachine, is also supplied as an R-function. This has been optimized in several ways to produce the most accurate classifications at the genus level, without consuming too much memory. Specifically, it employs <italic>K</italic>-mers of length 8, where an increase to <italic>K</italic>=9 or <italic>K</italic>=10 comes at high cost in computation time and memory consumption compared to the small gain in accuracy for genus classifications. Pseudo counts have been set to 100 in the taxMachine as a robust compromise regardless of sequence length (see Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Figure S1).</p>
    <p>The classification of 16S is the most fundamental approach to profiling a microbial community, and due to the explosion in metagenomic research activities, tools for recognizing taxa from 16S sequences (reads) should be tuned to their optimal performance. The taxMachine R-function builds on a parallelized sparse-matrix implementation of the multinomial method that makes it efficient both with respect to speed and memory usage. It has been trained on the contax.trim data set, containing 38 871 full-length high-quality sequences covering 1774 genera, where all sequences have a consensus taxonomy, making it the closest we get to a well-balanced gold standard training set.</p>
    <p>The proposed implementation of <italic>K</italic>-mer counting simply discards a word if it contains an ambiguous character. The main reason for this is the added overhead to the computations by introducing another layer of logic to handle these symbols. For instance the occurrence of the letter D in a sequence means that the base in question could be a G, A or T. One could add 1/3 count to each of the three resulting words, but this would require a substantially slower <italic>K</italic>-mer counting logic. Since informative ambiguous characters (not N) are rarely seen in reads, we chose to disregard these words and keep the speed advantage of the integer logic.</p>
    <p>As described in the Implementation section the taxMachine provides information about classification uncertainty, based on the posterior probabilities of the multinomial model. The very first step needed in these computations is to remove the bias from sequence length in the log-probabilities, as suggested in Eq. (<xref rid="Equ1" ref-type="">1</xref>). The right panel of Fig. <xref rid="Fig1" ref-type="fig">1</xref> shows how the normalized posterior log-probabilities have no apparent trends over sequence length, as opposed to the raw-values in the left panel. This normalization makes it possible to compute uncertainty/reliability scores to sequences regardless of their exact lengths.</p>
    <p>The proposed <italic>d</italic>-score for a sequence is the difference in score between the most likely and the second most likely taxon. A <italic>d</italic>-score close to 0 means the sequence is close to a decision border, being almost equally similar to both taxa, and more likely to be mis-classified. To visualize this, we classified fragments of all sequences in the contax.trim data set using the taxMachine. We considered fragments of typical read-lengths; 120–150 and 270–300 bases, which is typical for Illumina HiSeq and MiSeq raw data, and 450–500 bases, which is typical for Roche 454 and merged (paired-end) Illumina MiSeq data. From each of the original 38 871 sequences we sampled 10 such fragments at random locations along each sequence.</p>
    <p>Comparing the predicted genus to the assigned genus, the error percentages were 1% for 450–500 bases reads, 3% for 270–300 bases and 11% for 120–150 bases, respectively, when the sequences from which the reads were generated were included in the model training (see Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Table S1 for cross-validated success rates). The <italic>d</italic>-score should ideally be small for the mis-classified sequences, and large for the others. In Fig. <xref rid="Fig3" ref-type="fig">3</xref> we show a ROC analysis where all sequences are ranked by their <italic>d</italic>-score. Based on the large AUC statistics (0.92−0.93) we conclude that a small <italic>d</italic>-score is an effective criterion for identifying mis-classified sequences. In Fig. <xref rid="Fig4" ref-type="fig">4</xref> we show how the <italic>d</italic>-score distributes for the mis-classified sequences. Clearly, the majority has a <italic>d</italic>-score below 1.0 and the shorter the reads the more the <italic>d</italic>-scores are concentrated near 0. The probability of mis-classification will in general never exceed that of correct classification even for <italic>d</italic>-score almost at 0, but at 0 there is a 50−50 chance of making a mistake. Various applications will require different strictness, but a classification with <italic>d</italic>-score above 1.0 can in general be considered safe. Based on the results in Fig. <xref rid="Fig4" ref-type="fig">4</xref> we found that among all classifications with a <italic>d</italic>&gt;1 there were 1.1, 0.7 and 0.3% errors for input sequences of lengths 120–150, 270–300 and 450–500 bases, respectively.
<fig id="Fig3"><label>Fig. 3</label><caption><p>ROC analysis of <italic>d</italic>-scores. Based on the classification of read-length fragments, each sequence was either correctly or incorrectly classified. Each sequence also has a <italic>d</italic>-score. Ranking by <italic>d</italic>-score produced a separation of incorrect and correct classifications as indicated by the ROC-curves and the corresponding AUC statistics. Each curve is based on results for 387 810 sequences</p></caption><graphic xlink:href="12859_2017_1583_Fig3_HTML" id="MO3"/></fig>
<fig id="Fig4"><label>Fig. 4</label><caption><p>Histogram of <italic>d</italic>-scores. The histograms show the proportions of <italic>d</italic>-scores for the mis-classified sequences only, in the range from 0 to 2.0. This is from the same results as Fig. <xref rid="Fig3" ref-type="fig">3</xref>, with three different read-lengths</p></caption><graphic xlink:href="12859_2017_1583_Fig4_HTML" id="MO4"/></fig>
</p>
    <p>We face a different type of uncertainty when we collect sequences very different from what we have seen in the training data set. In the Implementation section we describe the <italic>r</italic>-score to detect this. A negative <italic>r</italic>-score means the sequence has a lower probability than average for the assigned taxon. But how much lower than the average is critical? To investigate this we used the same results as mentioned above, classifying sub-sequences of typical read-lengths, but in addition we also included full-length sequences. We then computed the <italic>r</italic>-score for all correctly classified sequences. Figure <xref rid="Fig5" ref-type="fig">5</xref> shows the <italic>r</italic>-score densities for the various cases. It is the heavy left tail of the densities that is of interest. First, we notice there is some difference between densities for sequences of different lengths. Next, we see that even for correctly classified sequences, a very negative <italic>r</italic>-score occurs in a few cases. An <italic>r</italic>-score below −4 to −5 is rare for correctly classified sequences, and indicates an unusual sequence. The taxMachine also provides a probabilistic measure related to the <italic>r</italic>-score. Based on the contax.full data set (664 199 sequences) we computed densities similar to those in Fig. <xref rid="Fig5" ref-type="fig">5</xref>, and from these the empirical cumulative distribution functions. The probability <italic>Pr</italic>(<italic>r</italic>&lt;<italic>r</italic>
<sub><italic>i</italic></sub>|trainingdata) is found from this distribution, for any given <italic>r</italic>
<sub><italic>i</italic></sub>. This probability reflects how unusual a sequence is compared to the training data, and if this is very small, its classification is not reliable.
<fig id="Fig5"><label>Fig. 5</label><caption><p>Densities of <italic>r</italic>-scores. Based only on correctly classified sequences, the densities show how the <italic>r</italic>-scores distribute. The densities were estimated by a non-parametric kernel smoother in R. Only negative <italic>r</italic>-scores are of interest, since a (very) negative value indicates a (very) unusual sequence</p></caption><graphic xlink:href="12859_2017_1583_Fig5_HTML" id="MO5"/></fig>
</p>
    <p>In Fig. <xref rid="Fig6" ref-type="fig">6</xref> we demonstrate how the <italic>r</italic>-score histograms change when faced with sequences from unknown taxa. Here we have only focused on sub-sequences of lengths 450−500, but the results were similar for other sequence lengths as well. We used a taxon-wise cross-validation, i.e. in each iteration we leave out all sequences from a taxon, train the model on the rest, and classify the sequences of the left-out taxon. This means all classified sequences are from an unknown taxon, not part of the training data. The upper left panel shows, for comparison, how the distribution looks like without this cross-validation (mean <italic>r</italic>-score −0.1). In the upper right panel each genus has been left out, i.e. the training data contains no sequences from the genus of the classified sequence. The <italic>r</italic>-scores in general become more negative even if some are still quite large, even positive (mean <italic>r</italic>-score −13.5). This is not surprising, since many genera are quite similar, and a sequence from the neighboring genus may not look very unusual. In the lower panels we have cross-validated over order and phylum (mean <italic>r</italic>-scores −17.0 and −19.5), making the classified sequences gradually more distant from those of the training data. The lower left tail of the histograms seems thinner, but a substantial number of sequences got very negative <italic>r</italic>-scores well outside the range of the plots. The proportion of sequences in the green-yellow region (large <italic>r</italic>-scores) is gradually smaller.
<fig id="Fig6"><label>Fig. 6</label><caption><p>Effect of unknown taxa on <italic>r</italic>-scores. The four histograms show distribution of <italic>r</italic>-scores. The colors are: <italic>Green</italic> for all positive <italic>r</italic>-scores and <italic>black</italic> for scores more negative than ever observed in the contax.full data set. The transition from <italic>yellow to red</italic> indicates gradually smaller probabilities (from around 10<sup>−1</sup> at <italic>yellow</italic> to 10<sup>−8</sup> at <italic>dark red</italic>) of observing the corresponding <italic>r</italic>-score in the training set. <italic>Red colors</italic> are probabilities below 10<sup>−5</sup>. The <italic>upper left panel</italic> are <italic>r</italic>-scores where all classified taxa are present in the training data, i.e. no unknown taxa. In the <italic>upper right panel</italic> each genus is unknown, i.e. when classifying a sequence from genus A, there are no sequences from this genus in the training data. In the <italic>lower panels</italic> the same procedure has been repeated but the training data lack sequences from the same order and phylum, respectively</p></caption><graphic xlink:href="12859_2017_1583_Fig6_HTML" id="MO6"/></fig>
</p>
    <p>Figure <xref rid="Fig7" ref-type="fig">7</xref> illustrates, in a similar way, the effect of sequencing errors. The sequences from the upper-left panel of Fig. <xref rid="Fig6" ref-type="fig">6</xref> have been corrupted with random substitution errors at two levels, and then classified. The results are seen in the upper panels of Fig. <xref rid="Fig7" ref-type="fig">7</xref>. A 1<italic>%</italic> substitution error level will distort the <italic>r</italic>-scores, but still the majority of sequences are recognized to an acceptable level, with <italic>r</italic>-scores above −6. In total, more than 98<italic>%</italic> of the sequences are correctly classified. At 5<italic>%</italic> substitution error the majority of the reads have <italic>r</italic>-scores well into the red and even black region, indicating unrecognised sequences. Still, more than 90<italic>%</italic> of them are correctly classified, mostly those with the larger <italic>r</italic>-scores. With NGS technologies like Illumina or PacBio (circular consensus), the substitution error rate is usually well below 1<italic>%</italic> [<xref ref-type="bibr" rid="CR15">15</xref>, <xref ref-type="bibr" rid="CR16">16</xref>]. In the lower panels of Fig. <xref rid="Fig7" ref-type="fig">7</xref> we have corrupted the sequences by insertions and/or deletions in a similar way. For illumina reads indels are virtually non-existing [<xref ref-type="bibr" rid="CR15">15</xref>], while for PacBio reads they occur at the same rate as substitutions [<xref ref-type="bibr" rid="CR16">16</xref>]. We see that even with insertions or deletions of length 10, the effect on the R-score is small. The classification accuracy is around 98<italic>%</italic> for both length 5 and 10 indels, and only slightly smaller than for 1<italic>%</italic> substitution error. This is as expected, since <italic>K</italic>-mer methods like the ones we have here benefit from having the sequencing errors concentrated as a few indels rather then many substitution errors scattered at random along the sequence. We conclude that classifications of the taxMachine is largely unaffected by the sequencing error levels we expect from current NGS technology.
<fig id="Fig7"><label>Fig. 7</label><caption><p>Effect of sequencing error. Histograms of <italic>r</italic>-scores similar to those in Fig. <xref rid="Fig6" ref-type="fig">6</xref>. Reads of lengths 450−500 bases were corrupted at random before classification. In the <italic>upper panels</italic> 1<italic>%</italic> and 5<italic>%</italic> of the bases in each read were corrupted with a base different from the correct one. In the <italic>lower panels</italic> insertions and/or deletions of lengths 5 and 10 bases were distributed randomly at 1<italic>%</italic> of the positions in each read</p></caption><graphic xlink:href="12859_2017_1583_Fig7_HTML" id="MO7"/></fig>
</p>
    <p>Chimera sequences will also result in sequences that are different in <italic>K</italic>-mer composition from its source sequences. In Additional file <xref rid="MOESM3" ref-type="media">3</xref>: Figure S2 we show an example of such a mixture, including <italic>d</italic>- and <italic>r</italic>-scores.</p>
    <p>The <italic>r</italic>-score, and/or its corresponding probability, may be used to discard sequences that appear unusual. As always, the strictness of this procedure will depend on the application. For most applications we would not discard reads unless they are in the lower 1<italic>%</italic> or 0.1<italic>%</italic> quantile, at least (probabilities smaller than 10<sup>−2</sup>−10<sup>−3</sup>). Instead of fixing some threshold, and discarding reads, one may also use these probabilities as weights, and give reads with small <italic>r</italic>-scores less weight. When tabulating read-counts into a taxonomic profile, this seems like a natural procedure. Conservative estimates of the expected success rates in classifying new reads and full sequences can be found in Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Table S1.</p>
    <p>The heavy computations of the microclass package are performed in optimized, parallelized C++. This means that the users can comfortably work in R, knowing that reasonably large data can be processed on a personal computer. Larger problems can be tackled in a further parallelized fashion on computational clusters, simply by splitting data into blocks for separate processing. As the package has an open GPL 2/3 licence, reuse of the code in other, possibly pure C++, implementations is allowed as long as the licencing is correct and proper acknowledgements are used.</p>
  </sec>
  <sec id="Sec10" sec-type="conclusion">
    <title>Conclusions</title>
    <p>The package microclass offers tools for taxonomic classification based on 16S rRNA sequence data to the R community. There are function for training classifiers on your own, specialised data sets, and for using these classifiers to classify new sequences. The taxMachine function has synthesized the designed training data from the microcontax data package with the methods of this package, and is our suggested tool for general classifications. It also implements some novel ways to express uncertainties in the classifications, indicating if the input sequences are difficult to recognize.</p>
  </sec>
</body>
<back>
  <app-group>
    <app id="App1">
      <sec id="Sec11">
        <title>Additional files</title>
        <p>
          <media position="anchor" xlink:href="12859_2017_1583_MOESM1_ESM.pdf" id="MOESM1">
            <label>Additional file 1</label>
            <caption>
              <p>Supplementary Figure 1 Effect of pseudo-counts. The fraction of mis-classified sequences after 10-fold cross-validation, using various number of pseudo-counts in the training of the multinomial models (horizontal axes). This is based on the contax.trim data set, and models have been trained at all levels of the taxonomy, from domain to genus (panels). The effects of different choices of pseudo-counts are modest, and at the genus-level the use of 100 pseudo-counts is a reasonable compromise for all types of input sequence lengths. The amplicon sequences are obtained by using the primer pair 515<italic>F</italic> (GTGYCAGCMGCCGCGGTAA) and 806<italic>rB</italic> (GTGYCAGCMGCCGCGGTAA) to extract subsequences, in general matching the V3-V4 region of the 16S gene. (PDF 5 kb)</p>
            </caption>
          </media>
        </p>
        <p>
          <media position="anchor" xlink:href="12859_2017_1583_MOESM2_ESM.pdf" id="MOESM2">
            <label>Additional file 2</label>
            <caption>
              <p>Supplementary Table 1 Performance of the multinomial classifier. A table with results describing the performance of the multinomial classifier. (PDF 14 kb)</p>
            </caption>
          </media>
        </p>
        <p>
          <media position="anchor" xlink:href="12859_2017_1583_MOESM3_ESM.pdf" id="MOESM3">
            <label>Additional file 3</label>
            <caption>
              <p>Supplementary Figure 2 Chimera example. We constructed a chimera sequence by mixing <italic>Salmonella</italic> and <italic>Enterococcus</italic>. Both sequences have 1503 bases, and the chimera starts as <italic>Salmonella</italic> and ends as <italic>Enterococcus</italic>. The horizontal axis shows the number of <italic>Salmonella</italic> bases, i.e. if the <italic>n</italic> first bases are <italic>Salmonella</italic> then the 1503−<italic>n</italic> last bases are <italic>Enterococcus</italic>. The blue axis/dots shows how the <italic>d</italic>-score changes as we gradually mix the two sequences, and the tan axis/dots similar for the <italic>r</italic>-score. The red/yellow/green band at the top shows the classification at each chimera level. On the left side, when only a minority of the sequence is <italic>Salmonella</italic>, it is recognized as <italic>Enterococcus</italic> (green region). In the middle, it is misclassified as <italic>Escherichia</italic> (yellow region), which is a fairly close relative of <italic>Salmonella</italic>, but as the <italic>Salmonella</italic>-part gets majority it is recognized as <italic>Salmonella</italic> (red region). Notice the low <italic>d</italic>-score values in the middle section, indicating uncertain classifications. The <italic>r</italic>-scores also drop in the middle region. The ’jumps’ in <italic>r</italic>-score are due to the dependency of the classified genus. The posterior log-probabilities do not change abruptly, but the <italic>r</italic>-score is related to what we expect for the assigned genus, and the latter causes the switches. (PDF 37 kb)</p>
            </caption>
          </media>
        </p>
      </sec>
    </app>
  </app-group>
  <glossary>
    <title>Abbreviations</title>
    <def-list>
      <def-item>
        <term>BLAST</term>
        <def>
          <p>Basic local alignment search tool</p>
        </def>
      </def-item>
      <def-item>
        <term>CRAN</term>
        <def>
          <p>Comprehensive R archive network</p>
        </def>
      </def-item>
      <def-item>
        <term>OTU</term>
        <def>
          <p>Operational taxonomic unit</p>
        </def>
      </def-item>
      <def-item>
        <term>RDP</term>
        <def>
          <p>Ribosomal database project</p>
        </def>
      </def-item>
    </def-list>
  </glossary>
  <ack>
    <title>Acknowledgements</title>
    <p>Not applicable.</p>
    <sec id="d29e1832">
      <title>Funding</title>
      <p>This paper is a part of the PhD-project of HV, and this project has been 100% financed by the Norwegian University of Life Sciences.</p>
    </sec>
    <sec id="d29e1837">
      <title>Availability of data and material</title>
      <p>The R package is available for free from The Comprehensive R Archive Network [<xref ref-type="bibr" rid="CR11">11</xref>]. It is most easily obtained by starting R and running install.packages(~microclass~,repos=~http://cran.r-project.org/~) in the console window. All data used in this paper are also publicly available, in the R-package microcontax, at [<xref ref-type="bibr" rid="CR11">11</xref>].</p>
    </sec>
    <sec id="d29e1854">
      <title>Authors’ contributions</title>
      <p>Authors KHL, HV and LS have all contributed significantly to the programming and documentation of the software, and to the preparation and writing of this manuscript. All authors read and approved the final manuscript.</p>
    </sec>
    <sec id="d29e1859">
      <title>Competing interests</title>
      <p>The non-profit corporation Nofima - Norwegian Institute of Food, Fisheries and Aquaculture Research has no competing interests related to this publication or the presented software. The authors declare that they have no competing interests.</p>
    </sec>
    <sec id="d29e1864">
      <title>Consent for publication</title>
      <p>Not applicable.</p>
    </sec>
    <sec id="d29e1869">
      <title>Ethics approval and consent to participate</title>
      <p>Not applicable.</p>
    </sec>
    <sec id="d29e1874">
      <title>Publisher’s Note</title>
      <p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </sec>
  </ack>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1</label>
      <element-citation publication-type="book">
        <person-group person-group-type="editor">
          <name>
            <surname>Özlem</surname>
            <given-names>TaştanBishop</given-names>
          </name>
        </person-group>
        <source>Bioinformatics and Data Analysis in Microbiology</source>
        <year>2014</year>
        <publisher-loc>Rhodes University Bioinformatics, Department of Biochemistry, Microbiology and Biotechnology, Rhodes University, South Africa</publisher-loc>
        <publisher-name>Caister Academic Press</publisher-name>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2</label>
      <mixed-citation publication-type="other">Schloss PD, Westcott SL. Assessing and improving methods used in operational taxonomic unit-based approaches for 16s rrna gene sequence analysis. Appl Environ Microbiol. 2011; 77(10).</mixed-citation>
    </ref>
    <ref id="CR3">
      <label>3</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Garrity</surname>
            <given-names>GM</given-names>
          </name>
          <name>
            <surname>Tiedje</surname>
            <given-names>JM</given-names>
          </name>
          <name>
            <surname>Cole</surname>
            <given-names>JR</given-names>
          </name>
        </person-group>
        <article-title>Naïve bayesian classifier for rapid assignment of rrna sequences into the new bacterial taxonomy</article-title>
        <source>Appl Environ Microbiol</source>
        <year>2007</year>
        <volume>73</volume>
        <fpage>5261</fpage>
        <lpage>7</lpage>
        <pub-id pub-id-type="doi">10.1128/AEM.00062-07</pub-id>
        <?supplied-pmid 17586664?>
        <pub-id pub-id-type="pmid">17586664</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Vinje</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Liland</surname>
            <given-names>KH</given-names>
          </name>
          <name>
            <surname>Almøy</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Snipen</surname>
            <given-names>L</given-names>
          </name>
        </person-group>
        <article-title>Comparing k-mer based methods for improved classification of 16s sequences</article-title>
        <source>BMC Bioinformatics</source>
        <year>2015</year>
        <volume>16</volume>
        <issue>1</issue>
        <fpage>205</fpage>
        <pub-id pub-id-type="doi">10.1186/s12859-015-0647-4</pub-id>
        <?supplied-pmid 26130333?>
        <pub-id pub-id-type="pmid">26130333</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5</label>
      <mixed-citation publication-type="other">R Core Team. R: A Language and Environment for Statistical Computing. R Foundation for Statistical Computing. <ext-link ext-link-type="uri" xlink:href="http://www.R-project.org/">http://www.R-project.org/</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR6">
      <label>6</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Werner</surname>
            <given-names>JJ</given-names>
          </name>
          <name>
            <surname>Koren</surname>
            <given-names>O</given-names>
          </name>
          <name>
            <surname>Hugenholtz</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>DeSantis</surname>
            <given-names>TZ</given-names>
          </name>
          <name>
            <surname>Walters</surname>
            <given-names>WA</given-names>
          </name>
          <name>
            <surname>Caporaso</surname>
            <given-names>JG</given-names>
          </name>
          <name>
            <surname>Angenent</surname>
            <given-names>LT</given-names>
          </name>
          <name>
            <surname>Knight</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Ley</surname>
            <given-names>RE</given-names>
          </name>
        </person-group>
        <article-title>Impact of training sets on classification of high-throughput bacterial 16s rrna gene surveys</article-title>
        <source>ISME J</source>
        <year>2012</year>
        <volume>6</volume>
        <fpage>94</fpage>
        <lpage>103</lpage>
        <pub-id pub-id-type="doi">10.1038/ismej.2011.82</pub-id>
        <?supplied-pmid 21716311?>
        <pub-id pub-id-type="pmid">21716311</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7</label>
      <mixed-citation publication-type="other">Caporaso J, Kuczynski J, Stombaugh J, Bittinger K, Bushman F, Costello E, Fiere N, Pena A, Goodrich J, Gordon J, Huttley, S GA and Kelley, Knights D, Koenig J, Lozupone C, McDonald D, Muegge B, Pirrung M, Reeder J, Sevinsky J, Turnbaugh P, Walters W, Widmann J, Yatsunenko T, Zaneveld J, Knigh R. Qiime allows analysis of high-throughput community sequencing data. Nat Methods. 2010. doi:<ext-link ext-link-type="uri" xlink:href="http://dx.doi.org/10.1038/nmeth.f.303">10.1038/nmeth.f.303</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR8">
      <label>8</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Edgar</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Uparse: highly accurate otu sequences from microbial amplicon reads</article-title>
        <source>Nat Methods</source>
        <year>2013</year>
        <volume>10</volume>
        <fpage>996</fpage>
        <lpage>8</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.2604</pub-id>
        <?supplied-pmid 23955772?>
        <pub-id pub-id-type="pmid">23955772</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Leake</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Pagni</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Falquet</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Taroni</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Greub</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>The salivary microbiome for differentiating individuals: proof of principle</article-title>
        <source>Microbes Infect</source>
        <year>2016</year>
        <volume>18</volume>
        <fpage>399</fpage>
        <lpage>405</lpage>
        <pub-id pub-id-type="doi">10.1016/j.micinf.2016.03.011</pub-id>
        <?supplied-pmid 27063111?>
        <pub-id pub-id-type="pmid">27063111</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10</label>
      <mixed-citation publication-type="other">Microcontax R Package. <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/package=microcontax">https://cran.r-project.org/package=microcontax</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR11">
      <label>11</label>
      <mixed-citation publication-type="other">Comprehensive R Archive Network. <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/">https://cran.r-project.org/</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR12">
      <label>12</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Liu</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Wong</surname>
            <given-names>T</given-names>
          </name>
        </person-group>
        <article-title>Naïve bayesian classifiers with multinomial models for rrna taxonomic assignment</article-title>
        <source>IEEE/ACM Trans Comput Biol Bioinformatics</source>
        <year>2013</year>
        <volume>10</volume>
        <issue>5</issue>
        <fpage>1334</fpage>
        <lpage>9</lpage>
        <pub-id pub-id-type="doi">10.1109/TCBB.2013.114</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Eddelbuettel</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Francois</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Rcpp: Seamless r and c++ integration</article-title>
        <source>J Stat Softw</source>
        <year>2011</year>
        <volume>40</volume>
        <issue>8</issue>
        <fpage>1</fpage>
        <lpage>18</lpage>
        <pub-id pub-id-type="doi">10.18637/jss.v040.i08</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14</label>
      <mixed-citation publication-type="other">Cleveland WS, Grosse E, Shyu WM. Statistical Models in S In: Chambers JM, Hastie TJ, editors.. Wadsworth &amp; BrooksCole: 1992. p. 8.</mixed-citation>
    </ref>
    <ref id="CR15">
      <label>15</label>
      <mixed-citation publication-type="other">Schirmer M, Ijaz UZ, D’Amore R, Hall N, Sloan WT, Quince. Insight into biases and sequencing errors for amplicon sequencing with the illumina miseq platform. Nucl acid Res. 2015; 43(6).</mixed-citation>
    </ref>
    <ref id="CR16">
      <label>16</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schloss</surname>
            <given-names>PD</given-names>
          </name>
          <name>
            <surname>Jenior</surname>
            <given-names>ML</given-names>
          </name>
          <name>
            <surname>Koumpouras</surname>
            <given-names>CC</given-names>
          </name>
          <name>
            <surname>Westcott</surname>
            <given-names>SL</given-names>
          </name>
          <name>
            <surname>Highlander</surname>
            <given-names>SK</given-names>
          </name>
        </person-group>
        <article-title>Sequencing 16s rrna gene fragments using the pacbio smrt dna sequencing system</article-title>
        <source>PeerJ</source>
        <year>2016</year>
        <volume>4</volume>
        <fpage>e1869</fpage>
        <pub-id pub-id-type="doi">10.7717/peerj.1869</pub-id>
        <?supplied-pmid 27069806?>
        <pub-id pub-id-type="pmid">27069806</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
