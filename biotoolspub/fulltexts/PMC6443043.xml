<?all-math-mml yes?>
<?use-mml?>
<?properties open_access?>
<?properties manuscript?>
<?ManuscriptPrefix new?>
<?iso-abbr Nat. Methods?>
<?submitter-system ukmss?>
<?submitter-canonical-name Nature Publishing Group?>
<?submitter-canonical-id NATURE-STRUCTUR?>
<?submitter-userid 1005?>
<?submitter-authority publisher?>
<?submitter-login NPG?>
<?submitter-name Nature Publishing Group?>
<?domain wtpa?>
<?origin ukpmcpa?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-journal-id">101215604</journal-id>
    <journal-id journal-id-type="pubmed-jr-id">32338</journal-id>
    <journal-id journal-id-type="nlm-ta">Nat Methods</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat. Methods</journal-id>
    <journal-title-group>
      <journal-title>Nature methods</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1548-7091</issn>
    <issn pub-type="epub">1548-7105</issn>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6443043</article-id>
    <article-id pub-id-type="pmid">30886410</article-id>
    <article-id pub-id-type="doi">10.1038/s41592-019-0355-5</article-id>
    <article-id pub-id-type="manuscript">ems81815</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Cell composition analysis of bulk genomics using single cell data</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Frishberg</surname>
          <given-names>Amit</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="author-notes" rid="FN1">7</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Peshes-Yaloz</surname>
          <given-names>Naama</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="author-notes" rid="FN1">7</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Cohn</surname>
          <given-names>Ofir</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Rosentul</surname>
          <given-names>Diana</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Steuerman</surname>
          <given-names>Yael</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Valadarsky</surname>
          <given-names>Liran</given-names>
        </name>
        <xref ref-type="aff" rid="A2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Yankovitz</surname>
          <given-names>Gal</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Mandelboim</surname>
          <given-names>Michal</given-names>
        </name>
        <xref ref-type="aff" rid="A3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Iraqi</surname>
          <given-names>Fuad A.</given-names>
        </name>
        <xref ref-type="aff" rid="A4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Amit</surname>
          <given-names>Ido</given-names>
        </name>
        <xref ref-type="aff" rid="A2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Mayo</surname>
          <given-names>Lior</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Bacharach</surname>
          <given-names>Eran</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="author-notes" rid="FN1">8</xref>
        <xref ref-type="corresp" rid="CR1">9</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Gat-Viks</surname>
          <given-names>Irit</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="author-notes" rid="FN1">8</xref>
        <xref ref-type="corresp" rid="CR1">9</xref>
      </contrib>
    </contrib-group>
    <aff id="A1"><label>1</label>School of Molecular Cell Biology and Biotechnology, George S. Wise Faculty of Life Sciences, Tel Aviv University, 6997801 Tel Aviv, Israel</aff>
    <aff id="A2"><label>2</label>Department of Immunology, The Weizmann Institute of Science, 7610001 Rehovot, Israel</aff>
    <aff id="A3"><label>3</label>National Center for Influenza and Respiratory Viruses in the Central Virology Laboratory at Sheba Medical Center in Tel-Hashomer, 5262000 Ramat-Gan, Israel; Department of Epidemiology and Preventive Medicine, School of Public Health, Sackler Faculty of Medicine, Tel Aviv University, 6997801 Tel Aviv, Israel</aff>
    <aff id="A4"><label>4</label>Department of Clinical Microbiology and Immunology, Sackler Faculty of Medicine, Tel Aviv University, Tel Aviv, Israel</aff>
    <aff id="A5"><label>5</label>Sagol School of Neuroscience, Tel Aviv University, Tel Aviv, Israel</aff>
    <author-notes>
      <corresp id="CR1"><label>9</label>To whom correspondence should be addressed: <email>eranba@tauex.tau.ac.il</email> (EB); <email>iritgv@post.tau.ac.il</email> (IG-V)</corresp>
      <fn id="FN1" fn-type="equal">
        <label>7,8</label>
        <p id="P1">These authors contributed equally to this work</p>
      </fn>
    </author-notes>
    <pub-date pub-type="nihms-submitted">
      <day>26</day>
      <month>2</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>18</day>
      <month>3</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <month>4</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>18</day>
      <month>9</month>
      <year>2019</year>
    </pub-date>
    <volume>16</volume>
    <issue>4</issue>
    <fpage>327</fpage>
    <lpage>332</lpage>
    <!--elocation-id from pubmed: 10.1038/s41592-019-0355-5-->
    <permissions>
      <license>
        <license-p>Users may view, print, copy, and download text and data-mine the content in such documents, for the purposes of academic research, subject always to the full Conditions of use:<ext-link ext-link-type="uri" xlink:href="http://www.nature.com/authors/editorial_policies/license.html#terms">http://www.nature.com/authors/editorial_policies/license.html#terms</ext-link></license-p>
      </license>
    </permissions>
    <abstract>
      <p id="P2">Single-cell expression profiling (scRNA-seq) is a rich resource of cellular heterogeneity. While profiling every sample under study would be advantageous, it is time-consuming and costly. Here we introduce Cell Population Mapping (CPM), a deconvolution algorithm in which the composition of cell types and states is inferred from the bulk transcriptome using reference scRNA-seq profiles ('<italic>scBio'</italic> CRAN R-package). Analysis of individual variations in lungs of influenza virus-infected mice, using CPM, revealed that the relationship between cell abundance and clinical symptoms is a cell-state-specific property that varies gradually along the continuum of cell-activation states. The gradual change was confirmed in subsequent experiments and was further explained by a mathematical model in which clinical outcomes relate to cell-state dynamics along the activation process. Our results demonstrate the power of CPM in reconstructing the continuous spectrum of cell states within heterogeneous tissues.</p>
    </abstract>
  </article-meta>
</front>
<body>
  <sec sec-type="intro" id="S1">
    <title>Introduction</title>
    <p id="P3">Single-cell RNA sequencing (scRNA-seq) provides a powerful approach to understanding the composition of different cell identities within a complex tissue, including discrete cell types, cell states that arise transiently during the progression of time-dependent processes, and continuous dynamic transitions within the space of possible cell states<xref rid="R1" ref-type="bibr">1</xref>,<xref rid="R2" ref-type="bibr">2</xref>. The frequency of cell types and cell states may vary between genetically distinct individuals, environments, chemical perturbations, or disease states. To investigate this variation at high resolution, it is possible to generate scRNA-seq profiles for each sample of interest and then use it to evaluate the frequency of the different cell types and states<xref rid="R3" ref-type="bibr">3</xref>–<xref rid="R5" ref-type="bibr">5</xref>. However, such studies are costly and time-consuming, and have therefore been performed only on a limited scale.</p>
    <p id="P4">An alternative strategy would be to construct a comprehensive collection of reference scRNA-seq profiles representing various cell types and cell states. Deconvolution algorithms can then utilize those reference profiles to computationally predict the abundance of different cell types and states within a given sample, based on only the bulk expression data from that sample<xref rid="R2" ref-type="bibr">2</xref>,<xref rid="R6" ref-type="bibr">6</xref>–<xref rid="R8" ref-type="bibr">8</xref>. This strategy should in principle avoid the scaling issues associated with multiple scRNA-seq experiments, but in practice, using a large number of reference profiles typically results in reduced prediction accuracy<xref rid="R9" ref-type="bibr">9</xref>. A standard solution is to cluster the single-cell reference profiles into a relatively small number of cell-groups reference profiles<xref rid="R10" ref-type="bibr">10</xref>–<xref rid="R12" ref-type="bibr">12</xref>. However, while this clustering-based approach may provide a rough quantification of discrete cell types and states, the continuous cell-state space remains sparse and fragmented. Therefore, there is a substantial need for a deconvolution methodology that can exploit the rich spectrum of single-cell reference profiles.</p>
    <p id="P5">Here we propose the Cell Population Mapping (CPM) method, which provides an advantageous alternative to existing deconvolution approaches, particularly in providing a fine-resolution mapping. Similarly to recent studies<xref rid="R10" ref-type="bibr">10</xref>–<xref rid="R12" ref-type="bibr">12</xref>, CPM constructs its reference collection from scRNA-seq profiles derived from one or a few relevant samples, and then exploits this collection to infer cell composition within additional, bulk-profiled samples. However, instead of focusing on quantifying a few dozens of discrete cell subtypes, CPM analyses thousands of single-cell profiles scattered across the wide landscape of cell states. Using synthetic data, we demonstrate that deconvolution with CPM significantly improves the quantification of both gradual and abrupt changes in cell abundance over the continuous space of cell types and states. Furthermore, by analyzing complex changes in lung tissues, across influenza virus-infected mice of various genetic backgrounds, we demonstrated the effectiveness of CPM in probing phenotypic diversity in large cohorts.</p>
  </sec>
  <sec sec-type="results" id="S2">
    <title>Results</title>
    <sec id="S3">
      <title>Overview of CPM</title>
      <p id="P6">We developed CPM, a method based on computational deconvolution for identifying a cell population map from bulk gene expression data of a heterogeneous sample. In our framework, the cell population map is the abundance of cells over a cell-state space. Whereas the biological definition of a cell type refers to the core characteristics of a cell, a cell state can be thought of as the current phenotype in which a given cell type can be found (e.g., various proliferation, activation and differentiation states)<xref rid="R1" ref-type="bibr">1</xref>. The cell-state space specifies each cell state as a point in a multi-dimensional space; as cells undergo changes from one state to another, they travel through the space along a trajectory between these two states<xref rid="R13" ref-type="bibr">13</xref>. Unlike existing computational methods that are focused on reconstruction of the cell-state space from scRNA-seq data<xref rid="R1" ref-type="bibr">1</xref>, CPM takes as its input the previously-reconstructed cell state space of a certain scRNA-seq data, and then relies on this input to infer the abundance of each point in this space within a given bulk cell population.</p>
      <p id="P7">Formally, CPM relies on two input types (<xref ref-type="fig" rid="F1">Fig. 1A</xref>): first, a bulk expression profile of the heterogeneous cell population, and second, scRNA-seq profiles of individual single cells derived from one or a few representative samples ('reference data'). We assume that the cell-state space of the reference cells is given as input and that the particular position of each reference single cell within this space is known. The cell-state space is typically obtained by dimension-reduction (such as t-SNE<xref rid="R14" ref-type="bibr">14</xref>) that capture the essence of gene-regulation variation among the reference single cells (exemplified in <xref ref-type="fig" rid="F1">Fig. 1B</xref> top). It is also possible to use a well-defined trajectory within this space as an alternative "one-dimensional space"; such trajectory can explicitly describe the progression of cells through a biological process (exemplified in <xref ref-type="fig" rid="F1">Fig. 1B</xref> bottom).</p>
      <p id="P8">CPM consists of two steps (<xref ref-type="fig" rid="F1">Fig. 1A</xref> and <xref ref-type="sec" rid="S9">Online Methods</xref>): (i) Applying a deconvolution approach [here, support vector regression (SVR) approach], which combines the bulk profile of a complex tissue with a collection of reference scRNA-seq profiles to infer the composition of cells within the complex tissue input. The output of this step is the abundance of cells at the sub-region of each reference single cell. Such prediction poses two substantial challenges: first, an accuracy problem in deconvolving a very large number of reference profiles (typically, the analysis may involve thousands of single cells<xref rid="R15" ref-type="bibr">15</xref>), and secondly, a potential bias owing to the non-uniform distribution of reference cells over the cell-state space. To address these challenges, CPM applies deconvolution using a relatively small subset of reference profiles, which are obtained by an unbiased random sampling to ensure that every region in the cell space has an equal chance of being sampled (<xref ref-type="fig" rid="F1">Fig. 1C</xref>). The sampling and deconvolution procedures are repeated <italic>N</italic> times (here, <italic>N</italic> = 1,500), and the results are aggregated and averaged into a single inferred abundance for each reference single cell. (ii) From the inferred cell abundance in each particular reference coordinate, CPM extrapolates the cell abundance in any other cell-state coordinate (<xref ref-type="fig" rid="F1">Fig. 1D</xref>). In this extrapolation it is assumed that the shape of the cell distribution over the cell-state space is continuous and smooth. We refer to this smoothed continuous output as the 'cell population map'. Notably, CPM may use input bulk data either as a relative profile (i.e., response between two samples) or as an absolute (single-sample) profile, thereby predicting relative or absolute cell-state abundance, respectively.</p>
    </sec>
    <sec id="S4">
      <title>Performance analysis</title>
      <p id="P9">We used a simulation framework to measure the ability of CPM to predict the cell population map at fine resolution. The simulation was based on a collection of 1860 reference scRNA-seq profiles<xref rid="R16" ref-type="bibr">16</xref> taken from murine lungs during influenza virus infection and encompassing nine major immune and non-immune cell types: fibroblasts, epithelial cells, blood and lymphatic endothelial cells, T cells, B cells, NK cells, granulocytes, and cells of the mononuclear phagocyte system (MPS), encompassing monocytes (MO), macrophages (MΦs) and dendritic cells. In this reference dataset, one well-characterized trajectory is the gradual transition of cell states (within each cell type) from resting (naive)-like cells into active cells that respond to the influenza virus infection<xref rid="R16" ref-type="bibr">16</xref>. Synthetic bulk profiles of a complex tissue were created by mixing these single-cell profiles according to predetermined biologically-relevant functions over the cell-state space, introducing noise in the expression of genes and in the coordinates of single cells (denoted 'expression noise' and 'cell space noise', respectively). The quality of this strategy is demonstrated in <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 1A</xref> and further discussed in <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref>. CPM was compared to three alternative deconvolution methods - DCQ<xref rid="R17" ref-type="bibr">17</xref>, Cibersort<xref rid="R18" ref-type="bibr">18</xref> and standard SVR<xref rid="R19" ref-type="bibr">19</xref> - whose reference collection was the "averaged" profiles of single-cell groups (the larger the number of such single-cell groups, the higher the 'granularity' analyzed by the alternative methods; <xref ref-type="sec" rid="S9">Online Methods</xref>). The 'accuracy' of predictions was evaluated by comparing the ground-truth cell abundance to the predicted abundance of each reference single cell.</p>
      <p id="P10">To analyze performance, we focused on three fundamental types of simulations: (i) The 'cell-type simulation', in which cell abundance varies from one cell type to another, but within each cell type, the abundance is uniformly distributed over the cell-state space; (ii) the 'cell-subtype simulation', consisting of a modified abundance of a subpopulation of cell states within selected cell types; and (iii) the 'gradual-change simulation', representing continuous alterations of cell abundance along the trajectory of cell activation states (within selected cell types) (<xref ref-type="fig" rid="F2">Fig. 2A</xref>). Overall, whereas the cell-type simulation is focused on inter-cell-type variation, the cell-subtype and gradual-change simulations are focused on intra-cell-type variation, which arises from differences among cell states within the same cell type.</p>
      <p id="P11">Consistent with previous observations, changes in discrete cell types were accurately modelled by the alternative deconvolution methods (<xref ref-type="fig" rid="F2">Fig. 2B</xref>, <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 1B</xref>). However, in the case of intra-cell-type changes in the composition of cell states (the 'cell-subtype' and 'gradual-change' simulations), CPM showed consistent improvement in prediction accuracy compared to existing deconvolution methods (relative bulk data: <xref ref-type="fig" rid="F2">Fig. 2CD</xref> and <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 2AB</xref>; absolute bulk data: <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 3AB</xref>) within a reasonable running time (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 2CD</xref>). Unsurprisingly, CPM was able to capture the continuous nature of the input tissue, unlike the alternative deconvolution methods that could provide only a discrete approximation with lower accuracy (<xref ref-type="supplementary-material" rid="SD3">Supplementary Figs. 2E, 3C</xref>). Furthermore, CPM outperformed the existing methods in its ability to handle a high cell-state complexity and in its 'scalability' to a large number of reference profiles (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 2FG</xref>, detailed in <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref>). Quantitatively similar results were also observed for varying parameter settings (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 4</xref>), using different cell-state space solutions (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 5A</xref>), and for regions of different local density within the cell-state space (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 5BC</xref>). Of note, CPM may lose power with lower sequencing depth (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 6</xref>, discussed in <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref>).</p>
    </sec>
    <sec id="S5">
      <title>Relationships between infection symptoms and cell abundance are a cell-state-specific property</title>
      <p id="P12">We applied CPM to investigate <italic>in-vivo</italic> influenza virus infection across the Collaborative Cross (CC) recombinant inbred strains<xref rid="R20" ref-type="bibr">20</xref>, a panel of mouse lines designed to mimic the phenotypic and genotypic diversity seen in human populations. To this end, we generated bulk transcriptional expression profiles derived from lung tissues of 38 infected and 34 phosphate-buffered saline (PBS)-treated control mice (typically one or two individuals of each CC strain; <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 1</xref>, <xref ref-type="sec" rid="S9">Online Methods</xref>). We transformed absolute bulk profiles into relative bulk profiles using a common control profile as the normalizer, and then applied CPM to each of these bulk profiles using the abovementioned single-cell measurements of the same experimental setting (lung tissues from influenza virus-infected mice<xref rid="R16" ref-type="bibr">16</xref>) as the reference data. As the cell-state space, CPM utilized the continuous sequence of cell-activation states that were previously defined for each of the nine immune and non-immune cell types in this reference dataset<xref rid="R16" ref-type="bibr">16</xref>. Altogether, CPM calculated a relative cell population map consisting of relative cell abundance in each cell state for each individual mouse. We found that CPM predictions varied considerably between individuals (see examples in <xref ref-type="fig" rid="F3">Fig. 3A</xref>) and that this variation was robust across the <italic>N</italic> deconvolution repeats (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 7A</xref>).</p>
      <p id="P13">While the inferred cell population maps demonstrated substantial variation, the extent to which these cell-state changes relate to the clinical outcome of disease remained unclear. To elucidate this point, we monitored one of the main clinical symptoms of murine infection, namely the body weight loss (measured at 2 days post-infection (p.i.); <xref ref-type="fig" rid="F3">Fig. 3B</xref>), and calculated the correlation (across individuals) between this outcome and the inferred relative abundance of each reference cell (denoted the 'cell-to-phenotype correlation'). By splitting the reference cells into consecutive activation-state intervals (within each cell type) we could assess the variation in cell-to-phenotype correlations over the activation trajectory (illustrated in <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig.7B</xref>). Intriguingly, cell-to-phenotype correlations across infected mice clearly manifested a gradual increase over the trajectory of cell-activation states, ranging from negative correlations at the lower (naive-like) range toward positive correlations at the upper (activated) range (mainly in T cells, MPS and fibroblasts, <xref ref-type="fig" rid="F3">Fig. 3C</xref>). In fact, no particular threshold could be found that splits the activation-state trajectory into two discrete groups in which cell-to-phenotype correlations did not gradually change. Similar conclusions about the gradual change in cell-to-phenotype correlations were obtained using a second public dataset of influenza virus infection<xref rid="R21" ref-type="bibr">21</xref> and using additional computational analyses (<xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref>, <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 7C-H</xref>). As expected, the use of unrelated (uninfected) reference datasets and alternative deconvolution methods did not yield the same conclusions (<xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref>, <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 7IJ</xref>). Taken together, these findings highlight the advantage of a CPM model that is based on a continuous space of cell states, and further emphasize the importance of using reference and bulk data derived from a similar experimental setting.</p>
    </sec>
    <sec id="S6">
      <title>Experimental validation of predictions</title>
      <p id="P14">To test for the presence of a gradual change in cell-to-phenotype relationships as predicted by CPM, we performed flow cytometry analyses of lung cells from influenza-infected CC mice at 2 days p.i. We focused on MO/MΦ cell types, which constitute a major fraction of the total MPS population. To determine the activation states of MO/MΦs we used flow cytometry with two established cell-activation markers, CD64 and Ly6C<xref rid="R22" ref-type="bibr">22</xref>. The use of these markers enabled us to quantify the distribution of cells over a trajectory of activation states ranging from non-inflammatory (CD64<sup>low</sup>Ly6C<sup>low</sup>) to inflammatory (CD64<sup>high</sup>Ly6C<sup>high</sup>) MO/MΦs. As expected, the fraction of inflammatory MO/MΦs was higher in infected mice than in PBS-treated controls (<xref ref-type="fig" rid="F4">Fig. 4AB</xref>; <xref ref-type="supplementary-material" rid="SD1">Supplementary Table 1</xref>). Encouraged by this observation we then used the flow cytometry measurements to calculate cell-to-phenotype correlation, i.e., the correlation between the clinical readout (weight loss at 2 days p.i.) and the MO/MΦ cell fractions enumerated by flow cytometry across infected individuals. The correlation analysis yielded several lines of evidence that validated the reconstruction by CPM: (i) inflammatory MO/MΦs showed a positive cell-to-phenotype correlation (r<sup>2</sup> = 0.67, <xref ref-type="fig" rid="F4">Fig. 4C</xref> left); (ii) non-inflammatory MO/MΦs had a negative cell-to-phenotype correlation (r<sup>2</sup>=−0.54, <xref ref-type="fig" rid="F4">Fig. 4C</xref> right); (iii) cell-to-phenotype correlations increased with each of the two separate activation markers (<xref ref-type="fig" rid="F4">Fig. 4D</xref>); and (iv) flow cytometry analysis confirmed a gradual increase in correlation values over the CD64-cell-state continuum for both Ly6C<sup>high</sup> and Ly6C<sup>low</sup> cell states (<xref ref-type="fig" rid="F4">Fig. 4E</xref>). The lack of cell-to-phenotype correlation obtained when we used the total MO/MΦs count (r<sup>2</sup>=0.1, <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 8A</xref>) further validated the contention that cell-to-phenotype relationships depend on particular cell-activation states, thus accentuating the importance of fine-resolution deconvolution mapping. Whereas the observed association between activated-inflammatory MO/MΦs and severe physiological responses (<xref ref-type="fig" rid="F4">Fig. 4C</xref> left) has been previously reported<xref rid="R23" ref-type="bibr">23</xref>–<xref rid="R25" ref-type="bibr">25</xref>, the opposite trend of naive MO/MΦs (<xref ref-type="fig" rid="F4">Fig. 4C</xref> right) and the continuous transition between negative and positive correlations over the activation process (<xref ref-type="fig" rid="F4">Fig. 4E</xref>) have not been previously described.</p>
    </sec>
    <sec id="S7">
      <title>Inferring dynamics with a Markov model</title>
      <p id="P15">Given that the CPM-reconstructed map yielded accurate predictions for MPS cells, we next investigated the temporal dynamics over the activation trajectory for these cells. Our results showed that the association between cell abundance and weight loss varies in a gradual manner along the MPS-activation process (<xref ref-type="fig" rid="F3">Figs. 3C</xref>, <xref ref-type="fig" rid="F4">4E</xref>), but that the total MPS counts did not correlate with the body weight loss (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 8A</xref>). A parsimonious explanation for this observation is that the phenotypic diversity is associated with inter-individual variation in temporal dynamics along the activation process; for example, inter-individual variation in onset times, or in cell-state progression rates. Like scRNA-seq data<xref rid="R26" ref-type="bibr">26</xref>, the CPM-reconstructed data provided valuable information that allowed such temporal dynamics to be computationally reconstructed. For instance, we focused here on cell-state progression, and since its underlying mechanism is a stochastic process, we assumed a Markov process of naive-to-activation transitions between consecutive cell states (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 8B</xref>, <xref ref-type="sec" rid="S9">Online Methods</xref>). We used this model to predict the probability of transition ('transition rate') between sequential states in each individual mouse (see examples in <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 8C</xref>). With the assumption that the activation-onset time in all individuals is the same, comparison of the inferred transition rates might reveal complex transition-rate-to-phenotype relationships (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 8D</xref>). By calculating transition rates based on CPM predictions, we found that weight loss is indeed positively correlated with transition rates over a wide range of the MPS activation axis (at its early and intermediate parts; <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 8E</xref>). These CPM-predicted transition rates closely matched the rates calculated from flow cytometry measurements (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 8EF</xref>). Overall, this theoretical approach suggests a mechanistic model of <italic>in-vivo</italic> influenza-outcome diversity and demonstrates a general strategy for uncovering inter-individual variation in temporal dynamics.</p>
    </sec>
  </sec>
  <sec sec-type="discussion" id="S8">
    <title>Discussion</title>
    <p id="P16">Now that the ability to generate scRNA-seq data of multiple experiments exists, it should become possible to gain a detailed understanding of variations in cellular heterogeneity that correlate with clinical and molecular factors<xref rid="R3" ref-type="bibr">3</xref>. However, such analyses will continue to pose substantial challenges: generation of scRNA-seq measurements across multiple experiments is time-consuming, costly and requires expertise in single-cell technologies. In addition, fine-resolution deconvolution using a large repertoire of cell states is not readily available due to a trade-off between tissue-complexity and scalability (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 2F</xref>). CPM tackles this challenge by allowing reconstruction of cellular heterogeneity at fine resolution in many bulk-profiled samples, relying on reference single-cell data from only one or a few representative samples (<xref ref-type="fig" rid="F1">Fig. 1</xref>). Using synthetic data we showed here that although changes in the quantity of a discrete cell population are accurately modelled by existing deconvolution methods (<xref ref-type="fig" rid="F2">Fig. 2B</xref>), CPM outperforms these methods in accurately mapping the continuous spectrum of cell states within discrete cell types (e.g., <xref ref-type="fig" rid="F2">Fig. 2CD</xref>).</p>
    <p id="P17">We further demonstrated the power of CPM by using complex clinical and genomics data derived from <italic>in-vivo</italic> infections of genetically-diverse mice. First, CPM successfully recapitulated the previously reported<xref rid="R23" ref-type="bibr">23</xref>–<xref rid="R25" ref-type="bibr">25</xref> positive cell-to-phenotype correlations in the high-activation range (<xref ref-type="fig" rid="F3">Figs. 3C</xref>). In addition, CPM revealed previously unreported negative cell-to-phenotype correlations at the low-activation range, as well as gradual changes in the relationships between cellular heterogeneity and <italic>in-vivo</italic> phenotypes along the trajectory of cell-activation states (<xref ref-type="fig" rid="F3">Fig. 3C</xref>). Experimental validation of MO/MΦ cells supported these gradual changes from negative to positive correlations (<xref ref-type="fig" rid="F4">Fig. 4C-E</xref>), demonstrating that CPM-inferred cell-state-specific quantities can provide valuable information needed for modelling phenotypic diversity in large cohorts.</p>
    <p id="P18">We believe that CPM is likely to prove useful for additional analysis, such as calculations of cell-state-specific expression within complex tissues<xref rid="R27" ref-type="bibr">27</xref>, reconstruction of temporal dynamics of cell-state progression (<xref ref-type="supplementary-material" rid="SD3">Supplementary Figure 8</xref>), and studying cellular heterogeneity within the massive body of existing bulk genomics data such as TCGA<xref rid="R28" ref-type="bibr">28</xref> and GTeX<xref rid="R29" ref-type="bibr">29</xref>. Furthermore, as extensive single-cell catalogues (e.g. the Human Cell Atlas<xref rid="R30" ref-type="bibr">30</xref>) are currently constructed, it may soon become possible to analyze cellular heterogeneity in bulk expression data without requiring expertise in single-cell technologies (discussed in <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref>).</p>
  </sec>
  <sec sec-type="methods" id="S9" specific-use="web-only">
    <title>Online Methods</title>
    <sec id="S10">
      <title>The CPM algorithm</title>
      <p id="P19">CPM takes as input both bulk transcriptome and reference data. The input bulk transcriptome is represented in a column vector of expression values across all genes. Bulk expression values can be either the measured expression values in a single heterogeneous tissue or the relative values between two experiments, such as disease vs. healthy heterogeneous tissues. The input reference data consists of scRNA-seq profiles, represented in a matrix of the format <italic>R<sub>ij</sub></italic> where the <italic>ij</italic>-th entry is the expression levels of gene <italic>j</italic> in single cell <italic>i</italic>. A row vector <italic>R<sub>i</sub></italic> in this matrix is a RNA-seq signature of a certain reference single cell <italic>i</italic> (referred to as a 'reference profile'). We further assume that the main split of cells into broad cell type categories is known, and that low quality cells were already removed<xref rid="R16" ref-type="bibr">16</xref>. Additionally, we assume that each cell type is associated with a pre-determined neighborhood structure, denoted the 'cell-state space' structure. The cell-state space is represented as a set of coordinates where the <italic>i</italic>-th entry represents the position of reference single cell <italic>i</italic> within the cell-state space. The cell space should be constructed in a pre-processing step through various single-cell analysis techniques. For instance, it is possible to exploit standard dimension reduction methods that provide cell positions in a low dimensionality space (such as t-SNE or using several principle components<xref rid="R14" ref-type="bibr">14</xref>). Alternatively, it is possible to determine the position of cells along a certain trajectory of cell states and utilize this trajectory as a 1-dimensional cell-state space<xref rid="R14" ref-type="bibr">14</xref>.</p>
      <p id="P20">CPM starts with a preprocessing step in which genes carrying many dropout events (here, fraction of zero expression values across single cells &gt; 90%) are filtered. Both the reference profiles and the input bulk profile are then standardized. Next, the algorithm proceeds in two steps: first, infer the level of the reference cells within the complex tissue, and then use this information to predict cell abundance over the entire continuous cell-state space.</p>
      <sec id="S11">
        <title>Step 1 (deconvolution)</title>
        <p id="P21">To infer the abundance level of the reference cells in a bulk expression profile, we solve the following linear regression: <inline-formula><mml:math display="inline" id="M1" overflow="scroll"><mml:mrow><mml:mi>U</mml:mi><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munder><mml:mo>∑</mml:mo><mml:mi>i</mml:mi></mml:munder><mml:mrow><mml:msub><mml:mi>R</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mstyle><mml:mo>⋅</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, where <italic>R<sub>i</sub></italic> is the expression vector of all genes in reference single cell <italic>i</italic>, <italic>U</italic> is the vector of expression levels of all genes in the complex tissue, and β<sub>i</sub> indicates the unknown abundance of single cell <italic>i</italic> in the complex tissue. As in Cibersort<xref rid="R18" ref-type="bibr">18</xref>, we achieve robustness by solving this regression using linear SVR (the "LiblineaR" R package<xref rid="R19" ref-type="bibr">19</xref>) to prevent biases due to outliers. To further improve performance in the presence of a large number of reference profiles, we use a consensus approach, in which the abovementioned SVR inference is repeated <italic>N</italic> times for <italic>N</italic> different subsets of the reference profiles (denoted 'reference subsets'), each reference subset consists of <italic>Ns</italic> profiles. Predicted abundance values of the <italic>N</italic> runs are then averaged for each individual reference cell.</p>
        <p id="P22">We apply several improvements that make step 1 more robust and accurate. First, we perform an unbiased random selection of the reference subset (without replacements) so that the selected subset is uniformly distributed over the cell-state space. To address this, each reference cell is sampled by random sampling of a 'pivot point' within the cell-state space using inverse transform sampling and then choosing an arbitrary reference cell in the proximity of this pivot point. A grid was added to the cell-state space so that all reference cells that fall in a certain entry of this grid are defined as the proximity group for a pivot that falls in this entry. The number of grid-entries, calculated on each cell type separately, is the number of reference single cells divided by the cell neighborhood size. <italic>N</italic> was set to a value in which each reference cell would be selected to an average depth of at least <italic>Nr</italic> repeats. In particular, given that cells in high-density grid-entries are less likely to be selected, we calculate <italic>N</italic> based on the highest-density entry by requiring that each cell in this entry would be selected to an average depth of <italic>Nr</italic> repeats.</p>
        <p id="P23">The second improvement is that each SVR run is applied on a set of genes that is tailored for a specific reference subset. The basic idea is to select a gene set that offers the best ability to distinguish between the reference profiles. Similarly to Cibersort<xref rid="R18" ref-type="bibr">18</xref>, for each gene we compare its expression in different scRNA-seq profiles using one-way ANOVA (the <italic>Nd</italic> nearest neighbors of each cells are used to calculate the within-group variance component); each gene is then associated with the cell profile in which it attains the highest average expression, and the <italic>Ng</italic> top ANOVA-score genes associated with each cell profile are selected. In particular, <italic>Ng</italic> is defined as the number that minimizes the 'condition number' that is calculated with the R 'kappa' function.</p>
      </sec>
      <sec id="S12">
        <title>Step 2 (extrapolation)</title>
        <p id="P24">To infer the abundance of a given candidate cell state, CPM averages the predicted abundances of its <italic>Nd</italic> nearest-neighbor reference cells. This leads to a smoothed cell abundance over the entire cell-state space. We refer to this solution as the 'cell population map'.</p>
        <p id="P25">Overall, the methodology relies on three parameters: the number of deconvolution repeats (determined by <italic>Nr</italic>), the reference subset size (<italic>Ns</italic>) and the cell neighborhood size (<italic>Nd</italic>). Here we used <italic>Nr</italic>=5, <italic>Ns=</italic>50 and <italic>Nd=</italic>10 as our default setting. The contribution of CPM is further discussed in <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref>.</p>
      </sec>
    </sec>
    <sec id="S13">
      <title>The reference single-cell data</title>
      <p id="P26">The reference data is a collection of 1860 single cells that were collected from the lungs of a C57BL/6 mouse at 2 days after infection with 4.8x10<sup>3</sup> pfu (in 40 μl phosphate buffered saline - PBS) of the PR8 influenza virus (published data<xref rid="R16" ref-type="bibr">16</xref> from GEO accession number GSE107947). As previously reported<xref rid="R16" ref-type="bibr">16</xref>, this collection already excludes poor-quality cells, and the cells were already partitioned into nine cell-type groups (in total, 92 B cells, 135 blood endothelial cells, 24 epithelial cells, 291 granulocytes (GN), 345 lymphatic endothelial cells, 375 fibroblasts, 103 mononuclear phagocyte system (MPS) cells, 117 natural killers (NK) cells and 378 T cells). Furthermore, it was previously defined, for each of the nine immune and non-immune cell type, the progression of cell states through a trajectory of an antiviral-activation response<xref rid="R16" ref-type="bibr">16</xref>. We refer to this continuum as the 'trajectory' of cell activation states. Briefly, the cell-state trajectory was constructed in two steps: first, a group of 101 generic-response genes were defined (consisting of all genes that were upregulated in all nine cell types during influenza infection); next, for each single cell, its average expression level across these generic genes was used as the activation-state trajectory<xref rid="R16" ref-type="bibr">16</xref>; in <xref ref-type="fig" rid="F3">Figs. 3AC</xref>, <xref ref-type="fig" rid="F4">4DE</xref> and <xref ref-type="supplementary-material" rid="SD3">Supplementary Figs. 7C-G,I,J</xref>, this trajectory was further binned into equal intervals. Unless stated otherwise, this reference single-cell collection, together with its cell type groups and cell-state trajectory, were utilized as input in our analyses. We note that scRNA-seq data from a replicate infected mouse<xref rid="R16" ref-type="bibr">16</xref> was used to corroborate the results (<xref ref-type="supplementary-material" rid="SD3">Supplementary Figure 7F</xref>).</p>
    </sec>
    <sec id="S14">
      <title>Synthetic data analysis</title>
      <p id="P27">Synthetic bulk profiles were generated by mimicking the heterogeneity of cells within a biological complex tissue. Each synthetic bulk profile was generated as a mixture of reference scRNA-seq profiles according to pre-designed fractions of single cells. Our pre-designed fractions of cells represent prevalent realistic scenarios, including changes in the overall level of a certain subpopulation (the cell-type and cell-subtype simulations), as well as changes along cellular trajectories such as cell-state shifts (the gradual-change simulation). We generated both absolute and relative synthetic bulk profiles and in both cases tested the entire range of noise parameter (ranging from an entirely non-informative data to an almost-zero noise). The 'accuracy' was calculated as the Pearson correlation between the actual and predicted fractions of cells. Technical details about synthetic data generation and the accuracy score are available in <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref>.</p>
      <p id="P28">For each synthetic data collection, CPM's performance were compared to alternative state-of-the-art deconvolution algorithms, including (i) the digital cell quantifier (DCQ) algorithm<xref rid="R17" ref-type="bibr">17</xref> that builds on elastic net regression; (ii) Cibersort<xref rid="R18" ref-type="bibr">18</xref> that utilizes a non-iterative linear support vector regression; and (iii) a standard linear SVR. SVR was applied using L2-regularized L2-loss support (primal) vector regression because it provided similar accuracy compared to alternative settings but is faster than the alternatives. SVR was applied with the optimal setting of its C (the "LiblineaR" R package<xref rid="R19" ref-type="bibr">19</xref>) and ε=0.001 (all results were maintained with alternative εvalues such as 0.1 and 0.001; <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 2H</xref>). Using SVR and Cibersort, in the case of relative data we retained the negative coefficients, as previously suggested<xref rid="R17" ref-type="bibr">17</xref>. For the CPM algorithm, we further tested the effect of modifying the <italic>N</italic>r, <italic>Ns</italic> and <italic>Nd</italic> parameters. Since the three compared deconvolution methods rely on a relatively small number of input reference profiles, the reference data was constructed by grouping the scRNA-seq profiles. We generally used <italic>K</italic>-means clustering of the scRNA-seq data<xref rid="R16" ref-type="bibr">16</xref> and then used the averaged profile of each group as a reference profile. <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref> further describes alternative reference-construction methods whose accuracy levels are presented in <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 4E</xref>). Each of the compared methods was analyzed using a variety of <italic>K</italic> (granularity) values. Finally, we further compared CPM to an alternative approach in which cell composition is evaluated through enrichment of each individual reference profile (an 'enrichment scheme', as previously described<xref rid="R31" ref-type="bibr">31</xref>, detailed in <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref>).</p>
      <p id="P29">To validate that the mixture of single cells fully resembles real-data bulk profiles, we generated synthetic bulk expression values as a mixture of scRNA-seq of an uninfected C57BL/6J mouse (2075 cells derived from the lung tissue, partitioned into nine cell types<xref rid="R16" ref-type="bibr">16</xref>), using quantities that were previously measured within the lungs of naive C57BL/6J mice (flow cytometry fractions from previous studies<xref rid="R22" ref-type="bibr">22</xref>,<xref rid="R32" ref-type="bibr">32</xref>). We further measured bulk lung profiles of a naive C57BL/6J mouse (<xref ref-type="supplementary-material" rid="SD1">Supplementary Table 1</xref>) and found a good match between measured and computationally-synthesized bulk data (<xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 1A</xref>), supporting the validity of aggregating single cells into synthetic bulk profiles.</p>
    </sec>
    <sec id="S15">
      <title>Mice</title>
      <p id="P30">The present study used female mice aged 7-9 weeks from the Tel-Aviv University (TAU) collection of Collaborative Cross recombinant inbred mice<xref rid="R20" ref-type="bibr">20</xref> and the C57BL/6J strain. The mice were raised at the Animal Facility at the Sackler Faculty of Medicine in TAU. All experimental mice and protocols were approved by the Institutional Animal Care and Use Committee (IACUC) of TAU, approval numbers 04-14-049, which adheres to Israeli guidelines and follows the NIH/USA animal care and use protocols. Mice were housed on hardwood chip bedding under 12h light/dark cycle at 21–23°C. Mice given tap water and standard rodent chow diet ad libitum since their weaning day until the end of the experiment.</p>
    </sec>
    <sec id="S16">
      <title><italic>In-vivo</italic> influenza virus infection</title>
      <p id="P31">Mouse-adapted PR8 strain, influenza virus A/Puerto Rico/8/34 (A/PR/8/34, H1N1), was persistently grown in hen egg amnion, and its effective titer was quantified. All mice were anesthetized with 7mg/mL Ketamine and 1.4 mg/mL Xylazine at 0.1 ml/10 gr body weight, I.P. Animals were then infected intranasally with PR8 (4.8·10<sup>3</sup> pfu in 40 μL PBS), whereas mock-treated ('control') animals received only 40 μL of PBS. All mice were monitored daily for percentage of body weight loss and clinical disease manifestations, and sacrificed at 48 hours post treatment. Of note, this experimental setting closely resembles the one of the reference scRNA-seq data<xref rid="R16" ref-type="bibr">16</xref> (e.g., the same gender, time point and virus strain, and a similar age and virus doses).</p>
    </sec>
    <sec id="S17">
      <title>RNA isolation, library construction and pre-processing</title>
      <p id="P32">To test CPM on complex tissues, murine lungs were harvested immediately after the time of sacrifice, sliced into small pieces, homogenized using BeadBlaster Microtube Homogenizer (90sec, 4000rpm) in the presence of QIAzol, and used for total RNA extraction using the miRNeasy Mini Kit (Qiagen, CA). Library quality and concentration was measured using a TapeStation System (Agilent Technologies) and a Qubit Fluorometric Quantitation (Life Technologies) as described earlier<xref rid="R17" ref-type="bibr">17</xref>. mRNA sequencing libraries were constructed as previously described<xref rid="R17" ref-type="bibr">17</xref>. Absolute bulk profiles were generated through reads alignment and transcript quantification as described earlier<xref rid="R17" ref-type="bibr">17</xref> (detailed in <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref>). Absolute profiles were transformed into "relative" profiles using a common control profile as the normalizer, where the control profile was pooled from the PBS-treated mice. Relative profiles were calculated using log-transformed infected and control samples. Unless stated otherwise, reported are the results of using relative profiles.</p>
    </sec>
    <sec id="S18">
      <title>Cell-to-phenotype correlations</title>
      <p id="P33">CPM was applied on each bulk RNA-seq lung sample by integrating the reference single cell collection (a total running time of ~16 minutes for deconvolution of 72 samples, using six cores of a Dell Latitude E6430 laptop, containing an Intel i7-3740QM CPU). Our analysis builds on the CPM-inferred abundance of each reference single cell in each mouse individual. For each reference cell (associated with a particular cell activation state) we calculated the Pearson correlation coefficient between the predicted abundance of cells at this cell state compared to the <italic>in-vivo</italic> clinical phenotype at two days post infection over the individual mice (illustrated in <xref ref-type="supplementary-material" rid="SD3">Supplementary Fig. 7B</xref>). The coefficient is referred to as the 'cell-to-phenotype correlation'. The cell-to-phenotype correlation was calculated using two groups of mice: either the infected or the control (PBS-treated) mice. Cell-to-phenotype correlations were binned into nine equal intervals along the trajectory of cell activation states. <xref ref-type="supplementary-material" rid="SD1">Supplementary Note 1</xref> describes several tests that were applied to support the inferred gradual-changes over the cell activation bins.</p>
    </sec>
    <sec id="S19">
      <title>Fluorescence-activated cell sorting and analysis</title>
      <p id="P34">To validate the performance of CPM we sorted the population of macrophages from the lungs of various CC mice (<xref ref-type="supplementary-material" rid="SD1">Supplementary Table 1</xref>). To address this, the lungs were dissociated into single cell suspensions using Miltenyi Biotec lung dissociation kit (130-095-927), according to manufacturer’s instructions. Isolated lung cells were then enriched for CD45<sup>+</sup> cells by a positive selection (CD45 microbeads, Miltenyi Biotec, 130-052-301), incubated with blocking solution (5% normal mouse serum, 5% normal rat serum, and 1% anti-Mouse CD16/CD32) for 30 min on ice, and stained with fluorochrome-conjugated antibody for CD11b (M1/70), CD64 (X54-5/7.1), I-A/I-E (M5/114.15.2), Ly6G (1A8), Ly6C (HK1.4), and CD45 (30-F11, Miltenyi Biotec). All antibodies were from Biolegend, unless otherwise mentioned (clone number in parentheses). Data was acquired with a SH800 flow cytometer (Sony Biotechnology) and analyzed with FlowJo v.10 Software. Mononulear phagocyte cells were gated as CD11b<sup>+</sup>CD45<sup>+</sup>Ly6G<sup>-</sup>I-A/I-E<sup>+</sup>, as previously described<xref rid="R22" ref-type="bibr">22</xref>, and the expression levels of Ly6C and CD64 were analyzed.</p>
    </sec>
    <sec id="S20">
      <title>Inferring dynamics with a Markov model</title>
      <p id="P35">In this analysis we rely on the assumption that cells along the activation trajectory are partitioned into <italic>D</italic> equal intervals. The <italic>i</italic>-th interval represents a discrete cell state <italic>i</italic>. In addition, we assume that the probability of transition between any two states (per unit time) is constant over time. The 'stochastic matrix' Q<sub>DxD</sub> encodes the probabilities of transitions q<sub>ij</sub> from state <italic>i</italic> to state <italic>j</italic> per unit time (referred to as "transition rates"). Assuming that each cell in each state <italic>i</italic> may remain in the same state or switch into state <italic>i</italic>+1 (but not to any other cell state), it follows that (i) for each <italic>i</italic>, q<sub>ii</sub>+q<sub>i,i+1</sub>=1; and (ii) for each <italic>j</italic> ∉ {<italic>i</italic>,<italic>i</italic> + 1}, <italic>q<sub>ij</sub></italic>=0. We further define a row vector <italic>F<sub>1XD</sub></italic>=(<italic>f<sub>1</sub></italic>, <italic>f<sub>2</sub></italic>,…, <italic>f<sub>D</sub></italic>) where <italic>f<sub>i</sub></italic> is the proportion of cells in state <italic>i</italic> (denoted a 'state proportions vector'). We assume that each cell resides in exactly one of the cell states, and therefore <inline-formula><mml:math display="inline" id="M2" overflow="scroll"><mml:mrow><mml:mstyle displaystyle="true"><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>…</mml:mo><mml:mi>D</mml:mi></mml:mrow></mml:munder><mml:mrow><mml:msub><mml:mi>f</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mstyle></mml:mrow></mml:math></inline-formula>. The state proportions vector before infection and in any time <italic>t</italic> after infection are <italic>F<sup>(0)</sup></italic> and <italic>F<sup>(t)</sup></italic>, respectively. <italic>Q<sup>t</sup></italic> encodes the probability of transitions after <italic>t</italic> units of time and therefore <italic>F<sup>(t)</sup></italic>= <italic>F<sup>(0)</sup>Q<sup>t</sup></italic>. Using known state proportions vectors <italic>F<sup>(0)</sup></italic> and <italic>F<sup>(t)</sup></italic> (either CPM-inferred or FACS-measured, in <xref ref-type="supplementary-material" rid="SD3">Supplementary Figs. 8E and 8F</xref>, respectively), we fit the missing transition rate parameters {<italic>q</italic><sub><italic>i,i</italic>+1</sub> | <italic>i</italic> = 1,…, <italic>D</italic> – 1}.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material" id="SM">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="SD1">
      <label>2</label>
      <media xlink:href="NIHMS81815-supplement-2.pdf" mimetype="application" mime-subtype="pdf" orientation="portrait" xlink:type="simple" id="d36e1207" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD2">
      <label>Reporting Summary</label>
      <media xlink:href="NIHMS81815-supplement-Reporting_Summary.pdf" mimetype="application" mime-subtype="pdf" orientation="portrait" xlink:type="simple" id="d36e1211" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD3">
      <label>Suppl figures</label>
      <media xlink:href="NIHMS81815-supplement-Suppl_figures.doc" mimetype="application" mime-subtype="msword" orientation="portrait" xlink:type="simple" id="d36e1215" position="anchor"/>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack id="S21">
    <title>Acknowledgments</title>
    <p>This work was supported by the European Research Council (637885) (AF, NP-Y, OC, DR, YS and IG-V), and partially supported by the Israeli Centers of Research Excellence (I-CORE) Center No 41/11 (AF, YS), the Broad−Israel Science Foundation (ISF) 1168/14 (DR, NP-Y), ISF 1824/13 (EB), partial fellowships from the Edmond J. Safra Center for Bioinformatics at Tel Aviv University (AF, YS), and a Shulamit Aloni Scholarship (YS). Research in the IG-V lab was supported by an ISF 288/16. IG-V is a Faculty Fellow of the Edmond J. Safra Center for Bioinformatics at Tel Aviv University and an Alon Fellow. We thank Oded Danziger and Hanifa J. Abu-Toamih Atamni (Tel Aviv University, Israel) for help with mouse work, and Shirley Smith for scientific editing.</p>
  </ack>
  <fn-group>
    <fn id="FN2">
      <p id="P36">
        <bold>
          <underline>Code availability</underline>
        </bold>
      </p>
      <p id="P37">CPM is implemented in the 'scBio' CRAN R package (the CPM function): <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/web/packages/scBio/index.html">https://cran.r-project.org/web/packages/scBio/index.html</ext-link></p>
    </fn>
    <fn id="FN3">
      <p id="P38">
        <bold>
          <underline>Data Availability</underline>
        </bold>
      </p>
      <p id="P39">All RNA-seq data that support the findings of this study have been deposited in the Gene Expression Omnibus (GEO) database, under GEO accession numbers GSE113530 and GSE117975.</p>
    </fn>
    <fn id="FN4">
      <p id="P40">
        <bold>
          <underline>Reporting Summary</underline>
        </bold>
      </p>
      <p id="P41">Further information on research design is available in the <ext-link ext-link-type="uri" xlink:href="https://www.nature.com/articles/s41592-018-0262-1#MOESM2">Nature Research Reporting Summary</ext-link> linked to this article.</p>
    </fn>
    <fn fn-type="con" id="FN5">
      <p id="P42">
        <bold>Author Contributions</bold>
      </p>
      <p id="P43">AF, NP-Y, EB and IG-V conceived and designed the study. NP-Y, OC, DR, LV, FI, MM, LM, IA and EB developed experimental protocols and conducted the experiments. AF developed computational methods and performed bioinformatics analysis. YS performed bioinformatic analyses. AF, NP-Y, EB and IG-V wrote the manuscript with input from all authors.</p>
    </fn>
    <fn fn-type="COI-statement" id="FN6">
      <p id="P44">
        <bold>Declaration of Interests</bold>
      </p>
      <p id="P45">The authors declare no competing interests.</p>
    </fn>
  </fn-group>
  <ref-list>
    <ref id="R1">
      <label>1</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wagner</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Yosef</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Revealing the vectors of cellular identity with single-cell genomics</article-title>
        <source>Nature Biotechnology</source>
        <year>2016</year>
        <volume>34</volume>
        <fpage>1145</fpage>
        <pub-id pub-id-type="doi">10.1038/nbt.3711</pub-id>
      </element-citation>
    </ref>
    <ref id="R2">
      <label>2</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Chen</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Teichmann</surname>
            <given-names>SA</given-names>
          </name>
          <name>
            <surname>Meyer</surname>
            <given-names>KB</given-names>
          </name>
        </person-group>
        <article-title>From Tissues to Cell Types and Back: Single-Cell Gene Expression Analysis of Tissue Architecture</article-title>
        <source>Annual Review of Biomedical Data Science</source>
        <year>2018</year>
        <pub-id pub-id-type="doi">10.1146/annurev-biodatasci-080917-013452</pub-id>
      </element-citation>
    </ref>
    <ref id="R3">
      <label>3</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Krieg</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>High-dimensional single-cell analysis predicts response to anti-PD-1 immunotherapy</article-title>
        <source>Nature Medicine</source>
        <year>2018</year>
        <volume>24</volume>
        <fpage>144</fpage>
        <pub-id pub-id-type="doi">10.1038/nm.4466</pub-id>
      </element-citation>
    </ref>
    <ref id="R4">
      <label>4</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Shalek</surname>
            <given-names>AK</given-names>
          </name>
          <name>
            <surname>Benson</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Single-cell analyses to tailor treatments</article-title>
        <source>Science Translational Medicine</source>
        <year>2017</year>
        <volume>9</volume>
        <pub-id pub-id-type="doi">10.1126/scitranslmed.aan4730</pub-id>
      </element-citation>
    </ref>
    <ref id="R5">
      <label>5</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kim</surname>
            <given-names>K-T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Application of single-cell RNA sequencing in optimizing a combinatorial therapeutic strategy in metastatic renal cell carcinoma</article-title>
        <source>Genome Biology</source>
        <year>2016</year>
        <volume>17</volume>
        <fpage>80</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-016-0945-9</pub-id>
        <pub-id pub-id-type="pmid">27139883</pub-id>
      </element-citation>
    </ref>
    <ref id="R6">
      <label>6</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Shen-Orr</surname>
            <given-names>SS</given-names>
          </name>
          <name>
            <surname>Gaujoux</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Computational deconvolution: extracting cell type-specific information from heterogeneous samples</article-title>
        <source>Current opinion in immunology</source>
        <year>2013</year>
        <volume>25</volume>
        <fpage>571</fpage>
        <lpage>578</lpage>
        <pub-id pub-id-type="doi">10.1016/j.coi.2013.09.015</pub-id>
        <pub-id pub-id-type="pmid">24148234</pub-id>
      </element-citation>
    </ref>
    <ref id="R7">
      <label>7</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Baron</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A Single-Cell Transcriptomic Map of the Human and Mouse Pancreas Reveals Inter- and Intra-cell Population Structure</article-title>
        <source>Cell Systems</source>
        <year>2016</year>
        <volume>3</volume>
        <fpage>346</fpage>
        <lpage>360.e344</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2016.08.011</pub-id>
        <pub-id pub-id-type="pmid">27667365</pub-id>
      </element-citation>
    </ref>
    <ref id="R8">
      <label>8</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Frishberg</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Brodt</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Steuerman</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Gat-Viks</surname>
            <given-names>I</given-names>
          </name>
        </person-group>
        <article-title>ImmQuant: a user-friendly tool for inferring immune cell-type composition from gene-expression data</article-title>
        <source>Bioinformatics</source>
        <year>2016</year>
        <volume>32</volume>
        <fpage>3842</fpage>
        <lpage>3843</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btw535</pub-id>
        <pub-id pub-id-type="pmid">27531105</pub-id>
      </element-citation>
    </ref>
    <ref id="R9">
      <label>9</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Avila Cobos</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Vandesompele</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Mestdagh</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>De Preter</surname>
            <given-names>K</given-names>
          </name>
        </person-group>
        <article-title>Computational deconvolution of transcriptomics data from mixed cell populations</article-title>
        <source>Bioinformatics</source>
        <year>2018</year>
        <volume>34</volume>
        <fpage>1969</fpage>
        <lpage>1979</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/bty019</pub-id>
        <pub-id pub-id-type="pmid">29351586</pub-id>
      </element-citation>
    </ref>
    <ref id="R10">
      <label>10</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Puram</surname>
            <given-names>SV</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-Cell Transcriptomic Analysis of Primary and Metastatic Tumor Ecosystems in Head and Neck Cancer</article-title>
        <source>Cell</source>
        <year>2017</year>
        <volume>171</volume>
        <fpage>1611</fpage>
        <lpage>1624.e1624</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2017.10.044</pub-id>
        <pub-id pub-id-type="pmid">29198524</pub-id>
      </element-citation>
    </ref>
    <ref id="R11">
      <label>11</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tirosh</surname>
            <given-names>I</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Dissecting the multicellular ecosystem of metastatic melanoma by single-cell RNA-seq</article-title>
        <source>Science</source>
        <year>2016</year>
        <volume>352</volume>
        <fpage>189</fpage>
        <pub-id pub-id-type="doi">10.1126/science.aad0501</pub-id>
        <pub-id pub-id-type="pmid">27124452</pub-id>
      </element-citation>
    </ref>
    <ref id="R12">
      <label>12</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schelker</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Estimation of immune cell content in tumour tissue using single-cell RNA-seq data</article-title>
        <source>Nat Commun</source>
        <year>2017</year>
        <volume>8</volume>
        <fpage>2032</fpage>
        <pub-id pub-id-type="doi">10.1038/s41467-017-02289-3</pub-id>
        <pub-id pub-id-type="pmid">29230012</pub-id>
      </element-citation>
    </ref>
    <ref id="R13">
      <label>13</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Trapnell</surname>
            <given-names>C</given-names>
          </name>
        </person-group>
        <article-title>Defining cell types and states with single-cell genomics</article-title>
        <source>Genome Res</source>
        <year>2015</year>
        <volume>25</volume>
        <fpage>1491</fpage>
        <lpage>1498</lpage>
        <pub-id pub-id-type="doi">10.1101/gr.190595.115</pub-id>
        <pub-id pub-id-type="pmid">26430159</pub-id>
      </element-citation>
    </ref>
    <ref id="R14">
      <label>14</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rostom</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Svensson</surname>
            <given-names>V</given-names>
          </name>
          <name>
            <surname>Teichmann Sarah</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Kar</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Computational approaches for interpreting scRNA – seq data</article-title>
        <source>FEBS Letters</source>
        <year>2017</year>
        <volume>591</volume>
        <fpage>2213</fpage>
        <lpage>2225</lpage>
        <pub-id pub-id-type="doi">10.1002/1873-3468.12684</pub-id>
        <pub-id pub-id-type="pmid">28524227</pub-id>
      </element-citation>
    </ref>
    <ref id="R15">
      <label>15</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Svensson</surname>
            <given-names>V</given-names>
          </name>
          <name>
            <surname>Vento-Tormo</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Teichmann</surname>
            <given-names>SA</given-names>
          </name>
        </person-group>
        <article-title>Exponential scaling of single-cell RNA-seq in the past decade</article-title>
        <source>Nature Protocols</source>
        <year>2018</year>
        <volume>13</volume>
        <fpage>599</fpage>
        <pub-id pub-id-type="doi">10.1038/nprot.2017.149</pub-id>
        <pub-id pub-id-type="pmid">29494575</pub-id>
      </element-citation>
    </ref>
    <ref id="R16">
      <label>16</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Steuerman</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Dissection of influenza infection in vivo by single-cell RNA sequencing</article-title>
        <source>Cell Systems</source>
        <year>2018</year>
        <volume>6</volume>
        <fpage>679</fpage>
        <lpage>691</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2018.05.008</pub-id>
        <pub-id pub-id-type="pmid">29886109</pub-id>
      </element-citation>
    </ref>
    <ref id="R17">
      <label>17</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Altboum</surname>
            <given-names>Z</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Digital cell quantification identifies global immune cell dynamics during influenza infection</article-title>
        <source>Molecular systems biology</source>
        <year>2014</year>
        <volume>10</volume>
        <fpage>720</fpage>
        <lpage>720</lpage>
        <pub-id pub-id-type="doi">10.1002/msb.134947</pub-id>
        <pub-id pub-id-type="pmid">24586061</pub-id>
      </element-citation>
    </ref>
    <ref id="R18">
      <label>18</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Newman</surname>
            <given-names>AM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Robust enumeration of cell subsets from tissue expression profiles</article-title>
        <source>Nature Methods</source>
        <year>2015</year>
        <volume>12</volume>
        <fpage>453</fpage>
        <lpage>457</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.3337</pub-id>
        <pub-id pub-id-type="pmid">25822800</pub-id>
      </element-citation>
    </ref>
    <ref id="R19">
      <label>19</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Fan</surname>
            <given-names>R-E</given-names>
          </name>
          <name>
            <surname>Chang</surname>
            <given-names>K-W</given-names>
          </name>
          <name>
            <surname>Hsieh</surname>
            <given-names>C-J</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>X-R</given-names>
          </name>
          <name>
            <surname>Lin</surname>
            <given-names>C-J</given-names>
          </name>
        </person-group>
        <article-title>LIBLINEAR: A Library for Large Linear Classification</article-title>
        <source>The Journal of Machine Learning Research</source>
        <year>2008</year>
        <volume>9</volume>
        <fpage>1871</fpage>
        <lpage>1874</lpage>
        <pub-id pub-id-type="doi">10.1145/1390681.1442794</pub-id>
      </element-citation>
    </ref>
    <ref id="R20">
      <label>20</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Welsh</surname>
            <given-names>CE</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Status and access to the Collaborative Cross population</article-title>
        <source>Mammalian Genome</source>
        <year>2012</year>
        <volume>23</volume>
        <fpage>706</fpage>
        <lpage>712</lpage>
        <pub-id pub-id-type="doi">10.1007/s00335-012-9410-6</pub-id>
        <pub-id pub-id-type="pmid">22847377</pub-id>
      </element-citation>
    </ref>
    <ref id="R21">
      <label>21</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bottomly</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Expression quantitative trait Loci for extreme host response to influenza a in pre-collaborative cross mice</article-title>
        <source>G3 (Bethesda, Md.)</source>
        <year>2012</year>
        <volume>2</volume>
        <fpage>213</fpage>
        <lpage>221</lpage>
        <pub-id pub-id-type="doi">10.1534/g3.111.001800</pub-id>
      </element-citation>
    </ref>
    <ref id="R22">
      <label>22</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Yu</surname>
            <given-names>Y-RA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A Protocol for the Comprehensive Flow Cytometric Analysis of Immune Cells in Normal and Inflamed Murine Non-Lymphoid Tissues</article-title>
        <source>PloS one</source>
        <year>2016</year>
        <volume>11</volume>
        <fpage>e0150606</fpage>
        <pub-id pub-id-type="doi">10.1371/journal.pone.0150606</pub-id>
        <pub-id pub-id-type="pmid">26938654</pub-id>
      </element-citation>
    </ref>
    <ref id="R23">
      <label>23</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ferris</surname>
            <given-names>MT</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Modeling host genetic regulation of influenza pathogenesis in the collaborative cross</article-title>
        <source>PLoS pathogens</source>
        <year>2013</year>
        <volume>9</volume>
        <fpage>e1003196</fpage>
        <lpage>e1003196</lpage>
        <pub-id pub-id-type="doi">10.1371/journal.ppat.1003196</pub-id>
        <pub-id pub-id-type="pmid">23468633</pub-id>
      </element-citation>
    </ref>
    <ref id="R24">
      <label>24</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dengler</surname>
            <given-names>L</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cellular changes in blood indicate severe respiratory disease during influenza infections in mice</article-title>
        <source>PloS one</source>
        <year>2014</year>
        <volume>9</volume>
        <fpage>e103149</fpage>
        <lpage>e103149</lpage>
        <pub-id pub-id-type="doi">10.1371/journal.pone.0103149</pub-id>
        <pub-id pub-id-type="pmid">25058639</pub-id>
      </element-citation>
    </ref>
    <ref id="R25">
      <label>25</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Coates</surname>
            <given-names>BM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Inflammatory Monocytes Drive Influenza A Virus–Mediated Lung Injury in Juvenile Mice</article-title>
        <source>The Journal of Immunology</source>
        <year>2018</year>
        <volume>200</volume>
        <fpage>2391</fpage>
        <lpage>2404</lpage>
        <pub-id pub-id-type="doi">10.4049/jimmunol.1701543</pub-id>
        <pub-id pub-id-type="pmid">29445006</pub-id>
      </element-citation>
    </ref>
    <ref id="R26">
      <label>26</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tanay</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Scaling single-cell genomics from phenomenology to mechanism</article-title>
        <source>Nature</source>
        <year>2017</year>
        <volume>541</volume>
        <fpage>331</fpage>
        <pub-id pub-id-type="doi">10.1038/nature21350</pub-id>
        <pub-id pub-id-type="pmid">28102262</pub-id>
      </element-citation>
    </ref>
    <ref id="R27">
      <label>27</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Shen-Orr</surname>
            <given-names>SS</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cell type–specific gene expression differences in complex tissues</article-title>
        <source>Nature Methods</source>
        <year>2010</year>
        <volume>7</volume>
        <fpage>287</fpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.1439</pub-id>
        <pub-id pub-id-type="pmid">20208531</pub-id>
      </element-citation>
    </ref>
    <ref id="R28">
      <label>28</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hutter</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Zenklusen</surname>
            <given-names>JC</given-names>
          </name>
        </person-group>
        <article-title>The Cancer Genome Atlas: Creating Lasting Value beyond Its Data</article-title>
        <source>Cell</source>
        <year>2018</year>
        <volume>173</volume>
        <fpage>283</fpage>
        <lpage>285</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2018.03.042</pub-id>
        <pub-id pub-id-type="pmid">29625045</pub-id>
      </element-citation>
    </ref>
    <ref id="R29">
      <label>29</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kaul</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Enhancing GTEx by bridging the gaps between genotype, gene expression, and disease</article-title>
        <source>Nature Genetics</source>
        <year>2017</year>
        <volume>49</volume>
        <fpage>1664</fpage>
        <lpage>1670</lpage>
        <pub-id pub-id-type="doi">10.1038/ng.3969</pub-id>
        <pub-id pub-id-type="pmid">29019975</pub-id>
      </element-citation>
    </ref>
    <ref id="R30">
      <label>30</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The Human Cell Atlas</article-title>
        <source>eLife</source>
        <year>2017</year>
        <volume>6</volume>
        <fpage>e27041</fpage>
        <pub-id pub-id-type="doi">10.7554/eLife.27041</pub-id>
        <pub-id pub-id-type="pmid">29206104</pub-id>
      </element-citation>
    </ref>
    <ref id="R31">
      <label>31</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Aran</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Hu</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Butte</surname>
            <given-names>AJ</given-names>
          </name>
        </person-group>
        <article-title>xCell: digitally portraying the tissue cellular heterogeneity landscape</article-title>
        <source>Genome Biol</source>
        <year>2017</year>
        <volume>18</volume>
        <fpage>220</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-017-1349-1</pub-id>
        <pub-id pub-id-type="pmid">29141660</pub-id>
      </element-citation>
    </ref>
    <ref id="R32">
      <label>32</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Singer</surname>
            <given-names>BD</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Flow-cytometric method for simultaneous analysis of mouse lung epithelial, endothelial, and hematopoietic lineage cells</article-title>
        <source>American Journal of Physiology - Lung Cellular and Molecular Physiology</source>
        <year>2016</year>
        <volume>310</volume>
        <fpage>L796</fpage>
        <lpage>L801</lpage>
        <pub-id pub-id-type="doi">10.1152/ajplung.00334.2015</pub-id>
        <pub-id pub-id-type="pmid">26944088</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig id="F1" orientation="portrait" position="float">
    <label>Figure 1</label>
    <caption>
      <title>Overview of the CPM algorithm.</title>
      <p>A flowchart of the CPM pipeline (<bold>A</bold>) with illustrations of specific steps (<bold>B</bold>-<bold>D</bold>). The prior (reference) knowledge consists of single-cell RNA-seq profiles (derived from one or a few individuals) together with their associated cell-state space structure (A, top); such space may be constructed either through dimension reduction (e.g., a two-dimensional space in B, top) or through further identification of a well-defined cell trajectory (e.g., a "one-dimensional space" in B, bottom). Given a bulk expression profile of a complex tissue, CPM utilizes a deconvolution approach to infer the quantity of each reference cell (A middle, C) and then extrapolates these predictions over the entire cell-state space, thereby providing the output 'cell population map' (A bottom, D). To avoid simultaneous deconvolution with a very large number of reference profiles, deconvolution is applied <italic>N</italic> times on subsets of the reference profiles, and the inferred quantities are then aggregated.</p>
    </caption>
    <graphic xlink:href="emss-81815-f001"/>
  </fig>
  <fig id="F2" orientation="portrait" position="float">
    <label>Figure 2</label>
    <caption>
      <title>Performance assessed via synthetic data.</title>
      <p>(<bold>A</bold>) Synthetic data were generated either by changes of cell percentage in discrete cell types ('cell-type simulation', top); by changes of cell percentage in cell subtypes, within cell types ('cell-subtype simulation', middle); or by gradual changes in cell percentage along a trajectory of cell states ('gradual-change simulation', bottom). Illustration and abbreviation are as in <xref ref-type="fig" rid="F1">Fig. 1</xref>. (<bold>B</bold>−<bold>D</bold>) Accuracy of inferring cell abundance for the three simulation types: cell-type simulation (<bold>B</bold>), cell-subtype simulation (<bold>C</bold>), and the gradual-change simulation (<bold>D</bold>). Accuracy (<italic>y</italic> axis) is defined as the Pearson correlation coefficient between predicted and true cell abundance and is shown across varying data parameters (<italic>x</italic> axis) for alternative deconvolution methods (colour coded). Results are shown for bulk relative profiles (B left, C and D) or absolute profiles (B right). The alternative methods were applied with a reference dataset that was generated using granularity of 4 cell groups.</p>
    </caption>
    <graphic xlink:href="emss-81815-f002"/>
  </fig>
  <fig id="F3" orientation="portrait" position="float">
    <label>Figure 3</label>
    <caption>
      <title>Cellular heterogeneity during <italic>in-vivo</italic> influenza virus infection, reconstructed by CPM.</title>
      <p>(<bold>A</bold>) Shown are CPM-inferred relative MPS abundance values (<italic>y</italic> axis), averaged over cells from each activation state bin (bins were ranked with increasing activation states from left to right; <italic>x</italic> axis), for three representative infected individuals (colour coded). n=103 cells; error bars, standard deviation. (<bold>B</bold>) Percentages of measured body weight loss (<italic>y</italic> axis) of 38 infected individuals, ranked by disease severity (<italic>x</italic> axis). Marked individuals are the three shown in A. (<bold>C</bold>) Cell-to-phenotype Pearson correlation coefficients across the 38 infected CC mice (<italic>y</italic> axis), averaged by activation state bins (x axis), presented for MPS cells (top, 103 cells), T cells (middle, 378 cells) and fibroblasts (bottom, 375 cells). Error bars, standard deviations.</p>
    </caption>
    <graphic xlink:href="emss-81815-f003"/>
  </fig>
  <fig id="F4" orientation="portrait" position="float">
    <label>Figure 4</label>
    <caption>
      <title>Confirmation of gradual changes in relationships of cells to physiology over a trajectory of cell-activation states.</title>
      <p>Flow cytometry analyses of lung-derived MO/MΦs, stained for CD64 and Ly6C activation markers; cell percentages were calculated relative to the entire population of lung MO/MΦs. (<bold>A</bold>) Shown are representative analyses of control (left) and infected (right) animals (CC line 5001A). Statistics for the remaining individuals is shown in B. (<bold>B</bold>) Box plots showing the percentages of inflammatory MO/MΦs (CD64<sup>+</sup>Ly6C<sup>+</sup>; left) and non-inflammatory MO/MΦs (CD64<sup>-</sup>Ly6C<sup>-</sup> ;right) in 11 infected and 5 control CC animals. Boxes represent the 25th, 50th and 75th percentiles; whiskers show maxima and minima. P-values are indicated, one-sided <italic>t</italic>-test. (<bold>C</bold>) Shown are percentages of body weight loss of infected individual mice (<italic>y</italic> axis) as a function of their percentage of inflammatory (left) and non-inflammatory (right) MO/MΦs (<italic>x</italic> axis). (<bold>D</bold>) Shown are cell-to-phenotype correlation coefficients (calculated across the infected mice), binned and ranked according to the levels of the activation markers (CD64, <italic>y</italic> axis; Ly6C, <italic>x</italic> axis) and colour-coded in each bin. (<bold>E</bold>) Cross sections of the 2-dimensional map in D. Data are mean ± stdev across n=100 bootstrapped samples.</p>
    </caption>
    <graphic xlink:href="emss-81815-f004"/>
  </fig>
</floats-group>
