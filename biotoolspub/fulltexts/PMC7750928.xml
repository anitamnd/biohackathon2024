<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.2 20190208//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.2?>
<?ConverterInfo.XSLTName jats2jats3.xsl?>
<?ConverterInfo.Version 1?>
<?properties open_access?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">Bioinformatics</journal-id>
    <journal-id journal-id-type="publisher-id">bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1367-4803</issn>
    <issn pub-type="epub">1367-4811</issn>
    <publisher>
      <publisher-name>Oxford University Press</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">7750928</article-id>
    <article-id pub-id-type="pmid">32484876</article-id>
    <article-id pub-id-type="doi">10.1093/bioinformatics/btaa539</article-id>
    <article-id pub-id-type="publisher-id">btaa539</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Original Papers</subject>
        <subj-group subj-group-type="category-toc-heading">
          <subject>Genome Analysis</subject>
        </subj-group>
      </subj-group>
      <subj-group subj-group-type="category-taxonomy-collection">
        <subject>AcademicSubjects/SCI01060</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>LuxUS: DNA methylation analysis using generalized linear mixed model with spatial correlation</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid" authenticated="false">http://orcid.org/0000-0003-0369-5701</contrib-id>
        <name>
          <surname>Halla-aho</surname>
          <given-names>Viivi</given-names>
        </name>
        <xref rid="btaa539-cor1" ref-type="corresp"/>
        <aff><institution>Department of Computer Science, Aalto University</institution>, FI-00076 Aalto, <country country="FI">Finland</country></aff>
        <!--viivi.halla-aho@aalto.fi-->
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <name>
          <surname>Lähdesmäki</surname>
          <given-names>Harri</given-names>
        </name>
        <xref rid="btaa539-cor1" ref-type="corresp"/>
        <aff><institution>Department of Computer Science, Aalto University</institution>, FI-00076 Aalto, <country country="FI">Finland</country></aff>
        <!--harri.lahdesmaki@aalto.fi-->
      </contrib>
    </contrib-group>
    <contrib-group>
      <contrib contrib-type="editor">
        <name>
          <surname>Birol</surname>
          <given-names>Inanc</given-names>
        </name>
        <role>Associate Editor</role>
      </contrib>
    </contrib-group>
    <author-notes>
      <corresp id="btaa539-cor1">To whom correspondence should be addressed. E-mail: <email>viivi.halla-aho@aalto.fi</email> or <email>harri.lahdesmaki@aalto.fi</email></corresp>
    </author-notes>
    <pub-date pub-type="collection">
      <day>01</day>
      <month>9</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="epub" iso-8601-date="2020-06-02">
      <day>02</day>
      <month>6</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>02</day>
      <month>6</month>
      <year>2020</year>
    </pub-date>
    <volume>36</volume>
    <issue>17</issue>
    <fpage>4535</fpage>
    <lpage>4543</lpage>
    <history>
      <date date-type="received">
        <day>20</day>
        <month>9</month>
        <year>2019</year>
      </date>
      <date date-type="rev-recd">
        <day>05</day>
        <month>5</month>
        <year>2020</year>
      </date>
      <date date-type="accepted">
        <day>27</day>
        <month>5</month>
        <year>2020</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2020. Published by Oxford University Press.</copyright-statement>
      <copyright-year>2020</copyright-year>
      <license>
        <ali:license_ref xmlns:ali="http://www.niso.org/schemas/ali/1.0/" specific-use="textmining" content-type="ccbynclicense">https://creativecommons.org/licenses/by-nc/4.0/</ali:license_ref>
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution Non-Commercial License (<ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by-nc/4.0/">http://creativecommons.org/licenses/by-nc/4.0/</ext-link>), which permits non-commercial re-use, distribution, and reproduction in any medium, provided the original work is properly cited. For commercial re-use, please contact journals.permissions@oup.com</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="btaa539.pdf"/>
    <abstract>
      <title>Abstract</title>
      <sec id="s1">
        <title>Motivation</title>
        <p>DNA methylation is an important epigenetic modification, which has multiple functions. DNA methylation and its connections to diseases have been extensively studied in recent years. It is known that DNA methylation levels of neighboring cytosines are correlated and that differential DNA methylation typically occurs rather as regions instead of individual cytosine level.</p>
      </sec>
      <sec id="s2">
        <title>Results</title>
        <p>We have developed a generalized linear mixed model, LuxUS, that makes use of the correlation between neighboring cytosines to facilitate analysis of differential methylation. LuxUS implements a likelihood model for bisulfite sequencing data that accounts for experimental variation in underlying biochemistry. LuxUS can model both binary and continuous covariates, and mixed model formulation enables including replicate and cytosine random effects. Spatial correlation is included to the model through a cytosine random effect correlation structure. We show with simulation experiments that using the spatial correlation, we gain more power to the statistical testing of differential DNA methylation. Results with real bisulfite sequencing dataset show that LuxUS is able to detect biologically significant differentially methylated cytosines.</p>
      </sec>
      <sec id="s3">
        <title>Availability and implementation</title>
        <p>The tool is available at <ext-link xlink:href="https://github.com/hallav/LuxUS" ext-link-type="uri">https://github.com/hallav/LuxUS</ext-link>.</p>
      </sec>
      <sec id="s5">
        <title>Supplementary information</title>
        <p><xref rid="sup1" ref-type="supplementary-material">Supplementary data</xref> are available at <italic toggle="yes">Bioinformatics</italic> online.</p>
      </sec>
    </abstract>
    <funding-group>
      <award-group award-type="grant">
        <funding-source>
          <institution-wrap>
            <institution>Academy of Finland</institution>
            <institution-id institution-id-type="DOI">10.13039/501100002341</institution-id>
          </institution-wrap>
        </funding-source>
        <award-id>292660</award-id>
        <award-id>314445</award-id>
      </award-group>
    </funding-group>
    <counts>
      <page-count count="9"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec>
    <title>1 Introduction</title>
    <p>DNA methylation is a widely studied epigenetic modification, which is involved in gene regulation. Aberrant methylation states have been shown to be connected with diseases and cancer. One popular method for quantifying DNA methylation levels is bisulfite sequencing (BS-seq) and its variants. Along with the development of sequencing techniques, several computational tools have been proposed for analysis of differential methylation from BS-seq data. These methods aim to model the underlying methylation proportions and perform statistical tests to assess the statistical significance of the effect of a covariate of interest on the methylation level.</p>
    <p>Spatial correlation of cytosines’ methylation states is a widely known phenomenon (<xref rid="btaa539-B4" ref-type="bibr">Eckhardt <italic toggle="yes">et al.</italic>, 2006</xref>), and methylation state is generally thought to vary rather as regions instead of individual cytosine level. Consequently, many DNA methylation analysis tools have attempted to capture the phenomenon with different model structures and computational techniques. For example the popular beta-binomial regression-based tool RADMeth by <xref rid="btaa539-B3" ref-type="bibr">Dolzhenko and Smith (2014)</xref> outputs log-likelihood ratio test <italic toggle="yes">P</italic>-values for each cytosine separately and then uses weighted <italic toggle="yes">Z</italic>-test to combine the <italic toggle="yes">P</italic>-value of a single site with the <italic toggle="yes">P</italic>-values of its neighbors. RADMeth also includes a feature for merging neighboring differentially methylated cytosines into differentially methylated regions (DMRs). Similarly, <xref rid="btaa539-B24" ref-type="bibr">Wen <italic toggle="yes">et al.</italic> (2016)</xref> first use beta-binomial regression model to calculate <italic toggle="yes">P</italic>-values for individual CpG sites and then combine them using Getis-Ord statistic. BSmooth tool by <xref rid="btaa539-B7" ref-type="bibr">Hansen <italic toggle="yes">et al.</italic> (2012)</xref>, included in bsseq package, is based on local-likelihood smoothing, which can compensate for low-coverage data and then uses signal-to-noise statistic similar to <italic toggle="yes">t</italic>-test for identifying differentially methylated regions. bsseq package also includes implementation of Fisher’s exact test. DSS tool includes two versions of a beta-binomial model with hypothesis testing with Wald test, one with two-group comparison (<xref rid="btaa539-B5" ref-type="bibr">Feng <italic toggle="yes">et al.</italic>, 2014</xref>) and another with a general experimental design (<xref rid="btaa539-B18" ref-type="bibr">Park and Wu, 2016</xref>). metilene tool by <xref rid="btaa539-B11" ref-type="bibr">Jühling <italic toggle="yes">et al.</italic> (2016)</xref> utilizes binary segmentation algorithm with two-dimensional Kolmogorov–Smirnov test for finding differentially methylated regions. Recently published dmrseq tool (<xref rid="btaa539-B13" ref-type="bibr">Korthauer <italic toggle="yes">et al.</italic>, 2019</xref>) combines smoothing and covariance structure with weighted least squares regression. <xref rid="btaa539-B16" ref-type="bibr">Mayo <italic toggle="yes">et al.</italic> (2015)</xref> proposed a kernel based method, M<sup>3</sup>D, where statistical testing of putative DMRs is done through maximum mean discrepancy values. <xref rid="btaa539-B19" ref-type="bibr">Rackham <italic toggle="yes">et al.</italic> (2017)</xref> took a different approach with their tool ABBA, which uses a latent Gaussian model.</p>
    <p>Another approach without spatial correlation, LuxGLM, was proposed by <xref rid="btaa539-B1" ref-type="bibr">Äijo <italic toggle="yes">et al.</italic> (2016)</xref>, and it enables testing for differential methylation for individual cytosines while considering different methylcytosine species and experimental design through generalized linear model part. LuxGLM can also utilize spike-ins, such as the commonly used (unmethylated) lambda phage genome, to model and estimate the experimental parameters at the same time with the actual model parameters. In the study by <xref rid="btaa539-B1" ref-type="bibr">Äijo <italic toggle="yes">et al.</italic> (2016)</xref>, the LuxGLM tool was shown to be accurate and perform on par or even better than other recent methods in detecting differential methylation.</p>
    <p>Here, we propose LuxUS, a method where the methylation proportions are modeled with a generalized linear mixed model (GLMM) that can consider both binary and continuous variables and random effects. Instead of analyzing each cytosine separately, we propose to analyze all cytosines in a moderately sized genomic window at a time. The spatial correlation of the neighboring cytosines’ methylation states is included in the model through a covariance structure of the cytosine random effect. To allow individual variation, we also introduce a replicate random effect. After estimating the model parameters, the user can view summary statistics of the posterior distributions of all linear and mixed effect coefficients, allowing for comprehensive evaluation of their significance and proportions.</p>
  </sec>
  <sec>
    <title>2 Materials and methods</title>
    <p>Here, we present the LuxUS model, which consists of two parts: an observation model and GLMM. Observation model attempts to model the bisulfite sequencing count data generation. The linear model part is used for estimating the methylation proportion parameter for the data generation process. The plate diagram for the whole LuxUS model is presented in<xref rid="btaa539-F1" ref-type="fig">Figure 1</xref>. We use Bayesian approach and probabilistic programming language Stan (<xref rid="btaa539-B2" ref-type="bibr">Carpenter <italic toggle="yes">et al.</italic>, 2017</xref>) for implementing the model and estimating the unknown model parameters. Hypothesis testing of the significance of explanatory variables is done using Bayes factors. To choose the genomic windows for the LuxUS analysis, we also implemented a simple preprocessing step. The workflow of a bisulfite sequencing data analysis with LuxUS is presented in diagram <xref rid="sup1" ref-type="supplementary-material">Supplementary Figure S3</xref>.
</p>
    <fig position="float" id="btaa539-F1">
      <label>Fig. 1.</label>
      <caption>
        <p>Plate diagram of the LuxUS model. The gray and white circles represent observed and latent variables, respectively. Rectangles represent fixed hyperparameters, design matrices or other type of input data</p>
      </caption>
      <graphic xlink:href="btaa539f1" position="float"/>
    </fig>
    <sec>
      <title>2.1 An observation model for bisulfite sequencing data</title>
      <p>We present the LuxUS method for a single genomic window and drop the index denoting a particular window position to simplify notation. The observation model is the same as the one presented in <xref rid="btaa539-B1" ref-type="bibr">Äijo <italic toggle="yes">et al.</italic> (2016)</xref>, which we first review here. From bisulfite sequencing data, we can retrieve, for each cytosine, the total number of reads overlapping the corresponding cytosine in each sample, <inline-formula id="IE1"><mml:math id="IM1" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula>, out of which <inline-formula id="IE2"><mml:math id="IM2" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="normal">C</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> observations were cytosines. This is demonstrated in <xref rid="sup1" ref-type="supplementary-material">Supplementary Figure S2</xref>. Both <inline-formula id="IE3"><mml:math id="IM3" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE4"><mml:math id="IM4" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="normal">C</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> are vectors of length <inline-formula id="IE5"><mml:math id="IM5" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, where <italic toggle="yes">N<sub>R</sub></italic> is the number of samples and <italic toggle="yes">N<sub>C</sub></italic> is the number of cytosines in the genomic window of interest. In bisulfite sequencing, the DNA goes first through a bisulfite conversion treatment, which converts unmethylated cytosines to uracils with probability <inline-formula id="IE6"><mml:math id="IM6" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Eff</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula>. The methylated cytosines stay unconverted with probability <inline-formula id="IE7"><mml:math id="IM7" display="inline" overflow="scroll"><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Eff</mml:mtext></mml:mrow><mml:mo>*</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula>. After the bisulfite treatment, DNA is sequenced and the uraciles are observed as thymines (T) and cytosines are observed as cytosines (C). The probability of sequencing error, i.e. observing uracil as C or cytosine as T, is <inline-formula id="IE8"><mml:math id="IM8" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mtext>seq</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Err</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula>. The experimental parameters <inline-formula id="IE9"><mml:math id="IM9" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mrow><mml:mtext>seq</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Err</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo> </mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Eff</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE10"><mml:math id="IM10" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Eff</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mo>*</mml:mo></mml:msubsup></mml:mrow></mml:math></inline-formula> are used in the model to describe the probabilities of sequencing error, bisulfite conversion and incorrect bisulfite conversion, respectively, for the sample corresponding to the <italic toggle="yes">i</italic>th observation. The complete probability tree for observing a C or T in a BS-seq experiment is presented in <xref rid="sup1" ref-type="supplementary-material">Supplementary Figure S1</xref>. The probability of observing <inline-formula id="IE11"><mml:math id="IM11" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="normal">C</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> many cytosine reads out of total read count <inline-formula id="IE12"><mml:math id="IM12" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> is modeled with binomial distribution with success probability parameter <inline-formula id="IE13"><mml:math id="IM13" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="normal">C</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula>
 <disp-formula id="E1"><label>(1)</label><mml:math id="M1" display="block" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="normal">C</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>∼</mml:mo><mml:mtext>Binomial</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="normal">C</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <inline-formula id="IE14"><mml:math id="IM14" display="inline" overflow="scroll"><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and where the elements of <inline-formula id="IE15"><mml:math id="IM15" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">p</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="normal">C</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="normal">C</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="normal">C</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mi>T</mml:mi></mml:msup></mml:mrow></mml:math></inline-formula> are calculated using the experimental parameters described above
<disp-formula id="E2"><label>(2)</label><mml:math id="M2" display="block" overflow="scroll"><mml:mrow><mml:mtable><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="normal">C</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:msub><mml:mrow><mml:mo>θ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Eff</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mtext>seq</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Err</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mrow/></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Eff</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mtext>seq</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Err</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mrow/></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo>+</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mo>θ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Eff</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mo>*</mml:mo></mml:msubsup><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mtext>seq</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Err</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mrow/></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo>+</mml:mo><mml:msubsup><mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Eff</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow><mml:mo>*</mml:mo></mml:msubsup><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mrow><mml:mtext>seq</mml:mtext></mml:mrow></mml:mrow><mml:mrow><mml:mtext>Err</mml:mtext><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:math></disp-formula>following the probability tree diagram in <xref rid="sup1" ref-type="supplementary-material">Supplementary Figure S1</xref>. The <italic toggle="yes">θ<sub>i</sub></italic> denotes the <italic toggle="yes">i</italic>th element of methylation proportion vector <inline-formula id="IE16"><mml:math id="IM16" display="inline" overflow="scroll"><mml:mi mathvariant="bold-italic">θ</mml:mi></mml:math></inline-formula>, which is modeled with a generalized linear mixed effect model, as described in Section 2.2.</p>
      <p>It is often thought that samples with low bisulfite conversion efficiency should be excluded from analyses, as they are considered unreliable. But as the experimental parameters can be considered with LuxUS, one does not have to leave out such samples from the analysis as long as the conversion efficiencies can be reliably estimated.</p>
    </sec>
    <sec>
      <title>2.2 A generalized mixed model with spatial correlation</title>
      <p>As stated above, the methylation proportions <inline-formula id="IE17"><mml:math id="IM17" display="inline" overflow="scroll"><mml:mi mathvariant="bold-italic">θ</mml:mi></mml:math></inline-formula> are estimated using a GLMM, which includes fixed effect covariates and cytosine and replicate random effects. The number of fixed effect covariates, counting in the possible intercept term, is <italic toggle="yes">N<sub>P</sub></italic>. Here, we assume that the effects of the covariates in design matrix <bold>X</bold> are fixed, but each of the replicates and cytosines have their own random intercept terms. A column vector <inline-formula id="IE18"><mml:math id="IM18" display="inline" overflow="scroll"><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:msup></mml:mrow></mml:math></inline-formula> can be expressed as a sum of fixed and random effects
<disp-formula id="E3"><label>(3)</label><mml:math id="M3" display="block" overflow="scroll"><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi><mml:mo>=</mml:mo><mml:mi mathvariant="bold">X</mml:mi><mml:mi mathvariant="bold">b</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:mi mathvariant="bold">e</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where design matrix <bold>X</bold> of shape <inline-formula id="IE19"><mml:math id="IM19" display="inline" overflow="scroll"><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">P</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and fixed effect coefficient vector <bold>b</bold> of length <italic toggle="yes">N<sub>P</sub></italic> form the fixed effect term, whereas replicate random effect design matrix <inline-formula id="IE20"><mml:math id="IM20" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> of shape <inline-formula id="IE21"><mml:math id="IM21" display="inline" overflow="scroll"><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and replicate random effects vector <inline-formula id="IE22"><mml:math id="IM22" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> of length <italic toggle="yes">N<sub>R</sub></italic> form the replicate random effect term and cytosine random effect design matrix <inline-formula id="IE23"><mml:math id="IM23" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> of shape <inline-formula id="IE24"><mml:math id="IM24" display="inline" overflow="scroll"><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and cytosine random effects vector <inline-formula id="IE25"><mml:math id="IM25" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> of length <italic toggle="yes">N<sub>C</sub></italic> form the cytosine random effect term. The last term, vector <bold>e</bold> of length <inline-formula id="IE26"><mml:math id="IM26" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, is the noise term of the model. The rows of <bold>Y</bold> and design matrices <bold>X</bold>, <inline-formula id="IE27"><mml:math id="IM27" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE28"><mml:math id="IM28" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> should all be ordered with the same principle, e.g. by first listing the <italic toggle="yes">N<sub>R</sub></italic> replicates of the first cytosine, then the replicates of the second cytosine, etc.</p>
      <p>Finally, the covariate and random effects are connected to the methylation proportion vector <inline-formula id="IE29"><mml:math id="IM29" display="inline" overflow="scroll"><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mo>θ</mml:mo></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>θ</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mi>T</mml:mi></mml:msup></mml:mrow></mml:math></inline-formula> through the sigmoid link function
<disp-formula id="E4"><label>(4)</label><mml:math id="M4" display="block" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>θ</mml:mo></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mtext>exp</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>Y</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p>
      <p>The methylation proportions <inline-formula id="IE30"><mml:math id="IM30" display="inline" overflow="scroll"><mml:mi mathvariant="bold-italic">θ</mml:mi></mml:math></inline-formula> are used in the calculation of <inline-formula id="IE31"><mml:math id="IM31" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext><mml:mo>,</mml:mo><mml:mi mathvariant="normal">C</mml:mi><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> as described in <xref rid="E2" ref-type="disp-formula">Equation 2</xref>.</p>
      <p>For the fixed effect, the design matrix <bold>X</bold> contains the experimental design. The <inline-formula id="IE32"><mml:math id="IM32" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo>×</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">P</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> design matrix <bold>D</bold> for one cytosine is used as a block matrix in <bold>X</bold> which is the design matrix of the experiment and applies to the whole genomic window. The rows of the matrix <bold>D</bold> correspond to the replicates in the experiment and the columns correspond to the covariates. The matrix <bold>D</bold> is repeated <italic toggle="yes">N<sub>C</sub></italic> times in the following way to form <bold>X</bold>
 <disp-formula id="E5"><label>(5)</label><mml:math id="M5" display="block" overflow="scroll"><mml:mrow><mml:mi mathvariant="bold">X</mml:mi><mml:mo>=</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtable><mml:mtr><mml:mtd><mml:mi mathvariant="bold">D</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mi mathvariant="bold">D</mml:mi></mml:mtd></mml:mtr></mml:mtable></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p>
      <p>The fixed effect coefficients vector <bold>b</bold> has a normal prior
<disp-formula id="E6"><label>(6)</label><mml:math id="M6" display="block" overflow="scroll"><mml:mrow><mml:mi mathvariant="bold">b</mml:mi><mml:mo>∼</mml:mo><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mn mathvariant="bold">0</mml:mn><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi>b</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mi mathvariant="bold">I</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where the prior variance <inline-formula id="IE33"><mml:math id="IM33" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">b</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> should be set to high enough value to enable sufficiently high variation for the fixed effect coefficients.</p>
      <p>The random effect terms for replicates and cytosines are expressed as vectors <inline-formula id="IE34"><mml:math id="IM34" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE35"><mml:math id="IM35" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> with normal priors
<disp-formula id="E7"><label>(7)</label><mml:math id="M7" display="block" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo>∼</mml:mo><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mn mathvariant="bold">0</mml:mn><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mi mathvariant="bold">I</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></disp-formula>
 <disp-formula id="E8"><label>(8)</label><mml:math id="M8" display="block" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo>∼</mml:mo><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mn mathvariant="bold">0</mml:mn><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>Σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>which are multiplied with random effect design matrices <inline-formula id="IE36"><mml:math id="IM36" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE37"><mml:math id="IM37" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, respectively, in <xref rid="E3" ref-type="disp-formula">Equation 3</xref>. <inline-formula id="IE38"><mml:math id="IM38" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE39"><mml:math id="IM39" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> indicate from which cytosine and replicate each observation is coming from. Random term <inline-formula id="IE40"><mml:math id="IM40" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> has a diagonal covariance matrix with variance <inline-formula id="IE41"><mml:math id="IM41" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> as the diagonal term, whereas <inline-formula id="IE42"><mml:math id="IM42" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> has a covariance matrix <inline-formula id="IE43"><mml:math id="IM43" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> which includes the spatial correlation of the model. The covariance matrix <inline-formula id="IE44"><mml:math id="IM44" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> is defined as
<disp-formula id="E9"><label>(9)</label><mml:math id="M9" display="block" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtable><mml:mtr><mml:mtd><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mtext>cov</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd><mml:mtd><mml:mo>⋯</mml:mo></mml:mtd><mml:mtd><mml:mrow><mml:mtext>cov</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:mtext>cov</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mtd><mml:mtd><mml:mo>⋯</mml:mo></mml:mtd><mml:mtd><mml:mrow><mml:mtext>cov</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd><mml:mtd><mml:mo>⋱</mml:mo></mml:mtd><mml:mtd><mml:mo>⋮</mml:mo></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:mtext>cov</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd><mml:mtd><mml:mrow><mml:mtext>cov</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mtd><mml:mtd><mml:mo>⋯</mml:mo></mml:mtd><mml:mtd><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where the covariance terms between the elements of <inline-formula id="IE45"><mml:math id="IM45" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> are defined as
<disp-formula id="E10"><label>(10)</label><mml:math id="M10" display="block" overflow="scroll"><mml:mrow><mml:mtext>cov</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>·</mml:mo><mml:mo> </mml:mo><mml:mtext>exp</mml:mtext><mml:mo stretchy="true">(</mml:mo><mml:mfrac><mml:mrow><mml:mo>−</mml:mo><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mi>ℓ</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mo stretchy="true">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <inline-formula id="IE46"><mml:math id="IM46" display="inline" overflow="scroll"><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mo> </mml:mo><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, and the genomic coordinates of the cytosines are stored in vector <inline-formula id="IE47"><mml:math id="IM47" display="inline" overflow="scroll"><mml:mrow><mml:mi mathvariant="bold-italic">c</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow><mml:mi>T</mml:mi></mml:msup></mml:mrow></mml:math></inline-formula>. The cytosines in the genomic window are restricted to be located in the same chromosome, as otherwise it would not be possible to calculate genomic distance between the cytosines. The length-scale parameter, <inline-formula id="IE48"><mml:math id="IM48" display="inline" overflow="scroll"><mml:mi>ℓ</mml:mi></mml:math></inline-formula>, is set a gamma prior
<disp-formula id="E11"><label>(11)</label><mml:math id="M11" display="block" overflow="scroll"><mml:mrow><mml:mi>ℓ</mml:mi><mml:mo>∼</mml:mo><mml:mtext>Gamma</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mo>α</mml:mo></mml:mrow><mml:mi>ℓ</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>β</mml:mo></mml:mrow><mml:mi>ℓ</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula></p>
      <p>Hyperparameters are set to <inline-formula id="IE49"><mml:math id="IM49" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>α</mml:mo></mml:mrow><mml:mi>ℓ</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>38</mml:mn></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE50"><mml:math id="IM50" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>β</mml:mo></mml:mrow><mml:mi>ℓ</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math></inline-formula> as they result in covariance that is similar to the methylation correlation plots shown in the studies by <xref rid="btaa539-B4" ref-type="bibr">Eckhardt <italic toggle="yes">et al.</italic> (2006)</xref> and <xref rid="btaa539-B20" ref-type="bibr">Song <italic toggle="yes">et al.</italic> (2017)</xref>. To demonstrate the shape of the covariance term, the term <inline-formula id="IE51"><mml:math id="IM51" display="inline" overflow="scroll"><mml:mrow><mml:mtext>exp</mml:mtext><mml:mo stretchy="true">(</mml:mo><mml:mfrac><mml:mrow><mml:mo>−</mml:mo><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mi>ℓ</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mo stretchy="true">)</mml:mo></mml:mrow></mml:math></inline-formula> has been plotted as a function of the distance <inline-formula id="IE52"><mml:math id="IM52" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> in <xref rid="sup1" ref-type="supplementary-material">Supplementary Figure S4</xref>.</p>
      <p>The random effect variance parameters <inline-formula id="IE53"><mml:math id="IM53" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE54"><mml:math id="IM54" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> have gamma priors
<disp-formula id="E12"><label>(12)</label><mml:math id="M12" display="block" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>∼</mml:mo><mml:mtext>Gamma</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mo>α</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>β</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></disp-formula>
 <disp-formula id="E13"><label>(13)</label><mml:math id="M13" display="block" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>∼</mml:mo><mml:mtext>Gamma</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mo>α</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>β</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <italic toggle="yes">α</italic><sub>R</sub>, <italic toggle="yes">β</italic><sub>R</sub>, <italic toggle="yes">α</italic><sub>C</sub> and <italic toggle="yes">β</italic><sub>C</sub> are set to make the prior distribution match our prior information about the cytosine and replicate random effects. The residual noise term <bold>e</bold> is defined similarly
<disp-formula id="E14"><label>(14)</label><mml:math id="M14" display="block" overflow="scroll"><mml:mrow><mml:mi mathvariant="bold">e</mml:mi><mml:mo>∼</mml:mo><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mn mathvariant="bold">0</mml:mn><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">E</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mi mathvariant="bold">I</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo> </mml:mo><mml:mo> </mml:mo><mml:mtext>with</mml:mtext><mml:mo> </mml:mo><mml:mo> </mml:mo><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">E</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>∼</mml:mo><mml:mtext>Gamma</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mo>α</mml:mo></mml:mrow><mml:mi mathvariant="normal">E</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>β</mml:mo></mml:mrow><mml:mi mathvariant="normal">E</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where <italic toggle="yes">α<sub>E</sub></italic> and <italic toggle="yes">β<sub>E</sub></italic> are the shape and rate parameters of gamma distribution, respectively. We have also implemented an alternative version of the model where inverse-gamma distributions are used instead of the gamma priors for the parameters <inline-formula id="IE55"><mml:math id="IM55" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>,</mml:mo><mml:mo> </mml:mo><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE56"><mml:math id="IM56" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">E</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula>.</p>
      <p>With the above definitions for the fixed and random effect, the distribution of <bold>Y</bold> can be expressed as
<disp-formula id="E15"><label>(15)</label><mml:math id="M15" display="block" overflow="scroll"><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi><mml:mo>∼</mml:mo><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold">X</mml:mi><mml:mi mathvariant="bold">b</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>Σ</mml:mo></mml:mrow><mml:mi>Y</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where the elements of the covariance matrix <inline-formula id="IE57"><mml:math id="IM57" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Σ</mml:mo></mml:mrow><mml:mi>Y</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> are defined as
<disp-formula id="E16"><mml:math id="M16" display="block" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>Σ</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>Y</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mtable><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo> </mml:mo><mml:mtext>exp</mml:mtext><mml:mo stretchy="true">(</mml:mo><mml:mfrac><mml:mrow><mml:mo>−</mml:mo><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mi>ℓ</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mo stretchy="true">)</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo> </mml:mo><mml:mo>,</mml:mo><mml:mo> </mml:mo><mml:mtext>if</mml:mtext><mml:mo> </mml:mo><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:mrow><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>+</mml:mo><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo> </mml:mo><mml:mtext>exp</mml:mtext><mml:mo stretchy="true">(</mml:mo><mml:mfrac><mml:mrow><mml:mo>−</mml:mo><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>c</mml:mi></mml:mrow><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mi>ℓ</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mfrac><mml:mo stretchy="true">)</mml:mo></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo> </mml:mo><mml:mo>,</mml:mo><mml:mo> </mml:mo><mml:mtext>if</mml:mtext><mml:mo> </mml:mo><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:mrow><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo> </mml:mo><mml:mtext>and</mml:mtext><mml:mo> </mml:mo><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:mtd></mml:mtr><mml:mtr columnalign="left"><mml:mtd columnalign="left"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>+</mml:mo><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>+</mml:mo><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">E</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:mtd><mml:mtd columnalign="left"><mml:mrow><mml:mo> </mml:mo><mml:mo>,</mml:mo><mml:mo> </mml:mo><mml:mtext>if</mml:mtext><mml:mo> </mml:mo><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mi>j</mml:mi><mml:mo>,</mml:mo></mml:mrow></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mrow></mml:mrow></mml:math></disp-formula>where <inline-formula id="IE58"><mml:math id="IM58" display="inline" overflow="scroll"><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE59"><mml:math id="IM59" display="inline" overflow="scroll"><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub><mml:mo>·</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE60"><mml:math id="IM60" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE61"><mml:math id="IM61" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>Z</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> denote the <italic toggle="yes">i</italic>th rows of random effect design matrices <inline-formula id="IE62"><mml:math id="IM62" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE63"><mml:math id="IM63" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, respectively.</p>
    </sec>
    <sec>
      <title>2.3 Model estimation</title>
      <p>For further inference based on the model, we have to estimate the unknown parameters. The variables to be estimated are fixed effect coefficients <bold>b</bold>, length-scale parameter <inline-formula id="IE64"><mml:math id="IM64" display="inline" overflow="scroll"><mml:mi>ℓ</mml:mi></mml:math></inline-formula>, replicate random effect variance <inline-formula id="IE65"><mml:math id="IM65" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula>, cytosine random effect variance <inline-formula id="IE66"><mml:math id="IM66" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula>, noise term variance <inline-formula id="IE67"><mml:math id="IM67" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">E</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula>, replicate random effect <inline-formula id="IE68"><mml:math id="IM68" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">R</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula>, cytosine random effect <inline-formula id="IE69"><mml:math id="IM69" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">u</mml:mi></mml:mrow><mml:mi mathvariant="normal">C</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> and linear predictor <bold>Y</bold>, from which methylation proportion <inline-formula id="IE70"><mml:math id="IM70" display="inline" overflow="scroll"><mml:mi mathvariant="bold-italic">θ</mml:mi></mml:math></inline-formula> can be calculated as described in <xref rid="E4" ref-type="disp-formula">Equation 4</xref>.</p>
      <p>The model was implemented with probabilistic programming language Stan (<xref rid="btaa539-B2" ref-type="bibr">Carpenter <italic toggle="yes">et al.</italic>, 2017</xref>), and the model parameters are estimated using the no-U-turn sampling algorithm, which is a locally adaptive version of Hamiltonian Monte Carlo (HMC) sampling as implemented in Stan. The PyStan version (<xref rid="btaa539-B21" ref-type="bibr">Stan Development Team, 2017</xref>) of the software was used for the HMC sampling. Stan also has a built-in automatic differentiation variational inference (ADVI) feature (<xref rid="btaa539-B14" ref-type="bibr">Kucukelbir <italic toggle="yes">et al.</italic>, 2015</xref>), which was also tested for estimating the model parameters. The mean-field algorithm, which is the default option in ADVI, was used. A more detailed description of model estimation algorithms can be found from Supplementary Section S1.1. As variational inference approaches are often faster than Markov chain Monte Carlo (MCMC) methods, it could be a more favorable model estimation method especially when analyzing large reduced representation bisulfite sequencing (RRBS-seq) or whole genome bisulfite sequencing (WGBS-seq) datasets. For running ADVI we utilize CmdStan (<xref rid="btaa539-B22" ref-type="bibr">Stan Development Team, 2018</xref>), which is the command line interface to Stan.</p>
    </sec>
    <sec>
      <title>2.4 Testing for differential methylation</title>
      <p>After estimating the model parameters as described above, differential methylation can be tested. With the models described above, it is possible to perform two types of tests. The type 1 test has null hypothesis <inline-formula id="IE71"><mml:math id="IM71" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>H</mml:mi></mml:mrow><mml:mn>0</mml:mn></mml:msub><mml:mo>:</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula> and alternative hypothesis <inline-formula id="IE72"><mml:math id="IM72" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>H</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>:</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>≠</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula>, i.e. the statistical significance of the covariate <italic toggle="yes">i</italic> is tested. The type 2 test has null hypothesis <inline-formula id="IE73"><mml:math id="IM73" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>H</mml:mi></mml:mrow><mml:mn>0</mml:mn></mml:msub><mml:mo>:</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mi>j</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula> and alternative hypothesis <inline-formula id="IE74"><mml:math id="IM74" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>H</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>:</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mi>j</mml:mi></mml:msub><mml:mo>≠</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></inline-formula>, i.e. the difference between the effects of covariates <italic toggle="yes">i</italic> and <italic toggle="yes">j</italic> is tested for statistical significance. The testing is done using Bayes factors. As calculating the exact values of Bayes factors is often infeasible, instead the Savage–Dickey density ratio estimate of the Bayes factor is used. For the type 1 test, the Savage–Dickey estimate is
<disp-formula id="E17"><label>(16)</label><mml:math id="M17" display="block" overflow="scroll"><mml:mrow><mml:mtext>BF</mml:mtext><mml:mo>≈</mml:mo><mml:mfrac><mml:mrow><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn><mml:mo>|</mml:mo><mml:msub><mml:mrow><mml:mi>H</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn><mml:mo>|</mml:mo><mml:msub><mml:mrow><mml:mi>H</mml:mi></mml:mrow><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mi mathvariant="script">D</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>where we denote data with <inline-formula id="IE75"><mml:math id="IM75" display="inline" overflow="scroll"><mml:mi mathvariant="script">D</mml:mi></mml:math></inline-formula>. The Savage–Dickey estimator for the type 2 test is defined similarly. The numerator of the Savage–Dickey density ratio is analytically solvable as we use normal prior for <bold>b</bold>. As for the denominator, it can be approximated from the posterior samples for <inline-formula id="IE76"><mml:math id="IM76" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">b</mml:mi></mml:mrow><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> by evaluating a kernel density estimate of the posterior at origin. The Gaussian kernel density estimation function from statistical functions module from the SciPy package (<xref rid="btaa539-B23" ref-type="bibr">Virtanen <italic toggle="yes">et al.</italic>, 2020</xref>) is used to calculate the kernel density estimates. Scott’s rule is used as the bandwidth parameter for the kernel density estimation. The Bayes factor is calculated for the whole window being analyzed, as the linear model coefficients <bold>b</bold> are shared among all cytosines.</p>
    </sec>
    <sec>
      <title>2.5 Preanalysis step for determining and filtering the genomic windows</title>
      <p>To prepare a BS-seq experiment dataset for LuxUS analysis, we have provided a script which also includes a simple preanalysis filtering method. The genomic windows, for which the analysis is performed, can be determined using a fixed window size (in terms of number of nucleotides) or number of cytosines in a window. The prefiltering step is computationally efficient and can be used to filter away regions which e.g. do not contain sufficient number of reads or are unlikely to exhibit differential DNA methylation. A coverage limit can be used to filter out cytosines with low coverages. As estimating the model for Bayes factor calculation can be computationally burdensome in genome-wide studies, we have implemented an F-test for testing the significance of a variable of interest using the logit transformed sample means (calculated over all the cytosines in the window) of the methylation states. The <italic toggle="yes">P</italic>-value limit for accepting a window for further analysis with the LuxUS model can be set as desired by the user. Each genomic window can then be analyzed further separately, enabling parallelization.</p>
    </sec>
  </sec>
  <sec>
    <title>3 Results</title>
    <p>To demonstrate the performance of the LuxUS model and to compare it to other tools, we applied LuxUS to real and simulated BS-seq datasets. First, the results from analysis of colon cancer WGBS-seq dataset for LuxUS and RADMeth were compared. The performance of LuxUS, RADMeth, M<sup>3</sup>D, bsseq, DSS and metilene were compared on simulated datasets. For LuxUS, both HMC and ADVI approaches for model fitting were tested. To show the advantage of using spatial correlation structure, each cytosine in the simulated datasets was also analyzed separately.</p>
    <sec>
      <title>3.1 Analysis of colon cancer WGBS-seq data</title>
      <p>The model was tested using a WGBS-seq dataset by <xref rid="btaa539-B8" ref-type="bibr">Hansen (2018)</xref>, consisting of matched human colon and colon cancer samples. The processed sequencing data were provided for two chromosomes, 21 and 22. First, the genomic windows for LuxUS analysis were determined using the preanalysis method. The details of the preanalysis and setting the priors can be found in Supplementary Section S2.1. Then Stan was run with HMC sampling to fit the LuxUS model parameters and finally Bayes factors were calculated. The sampling was done with four chains with 1500 samples in each, out of which half were discarded as burn-in. As a result, 1422 genomic windows were discovered with Bayes factor <inline-formula id="IE77"><mml:math id="IM77" display="inline" overflow="scroll"><mml:mrow><mml:mo>≥</mml:mo><mml:mn>3</mml:mn></mml:mrow></mml:math></inline-formula>. These genomic windows covered 21 127 cytosines in total. <xref rid="btaa539-B12" ref-type="bibr">Kass and Raftery (1995)</xref> proposed that Bayes factor values from 3 to 20 would indicate positive evidence against the null hypothesis, whereas values from 20 to 150 indicate strong evidence and values higher than 150 indicate very strong evidence. These limits can be used as approximate guidelines, as LuxUS computes the Savage–Dickey estimates of the Bayes factors instead of the exact Bayes factors.</p>
      <p>In comparison, we performed RADMeth analysis on the same dataset and discovered 137 142 cytosines with adjusted, FDR-corrected <italic toggle="yes">P</italic>-value <inline-formula id="IE78"><mml:math id="IM78" display="inline" overflow="scroll"><mml:mrow><mml:mo>≤</mml:mo><mml:mn>0.05</mml:mn></mml:mrow></mml:math></inline-formula>. The overlap of the significant cytosines from LuxUS and RADMeth approaches is 15 008 cytosines, i.e. about three-fourths of the differentially methylated cytosines found by LuxUS are also found by RADMeth. The results for a genomic region in chromosome 21 are shown in <xref rid="btaa539-F2" ref-type="fig">Figure 2</xref>, which demonstrates that both LuxUS and RADMeth produce similar results, but LuxUS is more conservative. For example near the end of the genomic region in <xref rid="btaa539-F2" ref-type="fig">Figure 2</xref>, the difference in average methylation state between the cancer and normal colon cells decreases, which RADMeth fails to detect and produces <italic toggle="yes">P</italic>-values smaller than 0.05. Whereas the said region was filtered from the analysis by LuxUS already in the preanalysis phase. The boxplots of the computation times (on one standard computing node in a cluster) for each number of cytosines in a genomic window for LuxUS are shown in <xref rid="sup1" ref-type="supplementary-material">Supplementary Figure S5</xref>. The total computation time on a single core for LuxUS for the 9945 genomic windows was 1623.80 h. Note that LuxUS supports full parallelization across all genomic windows, although the computation time here is reported for a single computing core. Running RADMeth for the whole dataset took 31 min and 33 s.
</p>
      <fig position="float" id="btaa539-F2">
        <label>Fig. 2.</label>
        <caption>
          <p>The top panel shows the methylation states for a chosen genomic region in chromosome 21 (from 28 214 962 to 28 217 867 bp) for the six samples in the colon cancer dataset. The colon cancer sample methylation states have been plotted in orange and the normal colon samples in purple. The experiment was paired, and the cancer and colon samples from the same person have been plotted with the same marker symbols. The middle panel shows the LuxUS Bayes factor values with log scaling. The Bayes factor values have been truncated to 1000. The cytosines which were filtered from further analysis in the preanalysis phase have been plotted with value 0 with empty markers. The horizontal red line corresponds to the Bayes factor value 3. The bottom panel shows the RADMeth <italic toggle="yes">P</italic>-values for the same genomic region. The horizontal red line corresponds to the adjusted <italic toggle="yes">P</italic>-value of 0.05. The cytosines for which RADMeth produced no <italic toggle="yes">P</italic>-value are plotted with <italic toggle="yes">P</italic>-value of 1 with empty markers</p>
        </caption>
        <graphic xlink:href="btaa539f2" position="float"/>
      </fig>
      <p>To investigate the biological significance of the found differentially methylated cytosines, we used the GREAT tool (<xref rid="btaa539-B17" ref-type="bibr">McLean <italic toggle="yes">et al.</italic>, 2010</xref>) for gene set enrichment analysis (online version 3.0.0 with the default parameter settings). The lists of significantly differentially methylated cytosines found by LuxUS and RADMeth were given to the tool as inputs and the unfiltered list of CpG sites for the chromosomes 21 and 22 was used as background regions file. The results from both methods showed enrichment in cancer-related terms in Disease Ontology and Molecular Signatures Database (MSigDB) Perturbation ontology, which indicates that the methods were able to discover truly differentially methylated cytosines. The lists of the enriched terms for LuxUS and RADMeth can be found on <xref rid="sup1" ref-type="supplementary-material">Supplementary Figures S6–S10</xref>. Supplementary Section S2.3 describes how LuxUS preanalysis step was validated using the colon cancer dataset.</p>
      <p>In Supplementary Section S2.4, the estimated variance parameters were utilized for setting simulation parameters. To further investigate the effect of the variance term priors, we applied LuxUS to another BS-seq dataset by <xref rid="btaa539-B9" ref-type="bibr">Hascher <italic toggle="yes">et al.</italic> (2014)</xref>. We also experimented using different <inline-formula id="IE79"><mml:math id="IM79" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">b</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> values to see how they affect the calculated Bayes factors and consequently the performance of the method with this dataset. These experiments are described in detail in Supplementary Section S3.</p>
    </sec>
    <sec>
      <title>3.2 Performance comparisons on simulated BS-seq data</title>
      <p>Simulated BS-seq data were generated for performance comparison purposes. The simulations were made using the LuxUS model, which considers various mechanisms that affect the real bisulfite sequencing process, such as experimental parameters. First, 100 sets of experimental parameters and cytosine locations were generated. The number of cytosines was 10 and their locations were randomly chosen from range <inline-formula id="IE80"><mml:math id="IM80" display="inline" overflow="scroll"><mml:mrow><mml:mo stretchy="false">[</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mn>1000</mml:mn><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:math></inline-formula>. The choice of cytosine frequency is explained in detail in Supplementary Section S2.4. Two BS-seq datasets were then simulated for each of these 100 sets: one with differential methylation and one with no differential methylation between the case and control samples. These 200 simulated genomic regions form a simulated dataset with 50% proportion of differentially methylated regions. The values for the fixed effect coefficient means, <inline-formula id="IE81"><mml:math id="IM81" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow><mml:mi mathvariant="normal">b</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">B</mml:mi><mml:mo>,</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">B</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula>, for the cases with differential methylation were <inline-formula id="IE82"><mml:math id="IM82" display="inline" overflow="scroll"><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mo>−</mml:mo><mml:mn>1.4</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo><mml:mo> </mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mo>−</mml:mo><mml:mn>1.4</mml:mn><mml:mo>,</mml:mo><mml:mn>2.3</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo><mml:mo> </mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1.4</mml:mn><mml:mo>,</mml:mo><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE83"><mml:math id="IM83" display="inline" overflow="scroll"><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1.4</mml:mn><mml:mo>,</mml:mo><mml:mo>−</mml:mo><mml:mn>2.3</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula>. These values correspond to approximate values of 0.2, 0.5, –0.2 and –0.5 of <inline-formula id="IE84"><mml:math id="IM84" display="inline" overflow="scroll"><mml:mrow><mml:mo>Δ</mml:mo><mml:mo>θ</mml:mo></mml:mrow></mml:math></inline-formula>, the difference in methylation proportions between the case and control groups, respectively. The variance for the fixed effect coefficients, <inline-formula id="IE85"><mml:math id="IM85" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">b</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula>, was set to 0.25 for the simulations. The variances for the cytosine and replicate random effects and the noise term, <inline-formula id="IE86"><mml:math id="IM86" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>,</mml:mo><mml:mo> </mml:mo><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE87"><mml:math id="IM87" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">E</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula>, were set to the means of the gamma distributions which were fitted to the posterior samples from the colon cancer WGBS-seq data analysis. Detailed description of this can be found from Supplementary Section S2.4. The coverage (i.e. the number of reads) as well as the number of replicates were varied as 6, 12 and 24. The priors for the variance terms <inline-formula id="IE88"><mml:math id="IM88" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">C</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo>,</mml:mo><mml:mo> </mml:mo><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">R</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> and <inline-formula id="IE89"><mml:math id="IM89" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">E</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> were set using the results from the real data analysis and <inline-formula id="IE90"><mml:math id="IM90" display="inline" overflow="scroll"><mml:mrow><mml:msubsup><mml:mrow><mml:mo>σ</mml:mo></mml:mrow><mml:mi mathvariant="normal">b</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> is set to 15 for the model estimation. The detailed description of the generation of the simulated data can be found from Supplementary Section S4.1.</p>
      <p>The model parameters were then estimated using the ADVI and HMC methods in Stan. The HMC sampler was run with four chains and the number of posterior samples for each chain was 1000, out of which half were discarded as burn-in. When running ADVI, 2000 samples were generated from the approximate posterior distribution to match the number of samples retrieved from HMC sampler. The number of gradient samples was 10, and number of samples used for evidence lower bound estimation was 200. These parameter values were chosen based on the results presented in <xref rid="btaa539-B15" ref-type="bibr">Malonzo <italic toggle="yes">et al.</italic> (2018)</xref>, where the precision and computation times of ADVI were compared to HMC for the LuxGLM model. After estimating the model parameters, the Bayes factors for the type 1 test were calculated. For comparison, the analysis was run for each cytosine separately to see the difference with the model with added spatial correlation. For this purpose, the cytosine random effect was removed from the model, as there was only one cytosine being analyzed at a time. The resulting model corresponds to the LuxGLM method by <xref rid="btaa539-B1" ref-type="bibr">Äijo <italic toggle="yes">et al.</italic> (2016)</xref> except that GLM is changed to GLMM by adding the replicate random effect into the model.</p>
      <p>To compare our method to other published tools, we ran the analysis also with RADMeth, M<sup>3</sup>D, dmrseq, DSS, metilene and bsseq. RADMeth was run with default parameters and the <italic toggle="yes">P</italic>-value adjusting was done for each simulated dataset separately. Presumably because of the beta-binomial nature of the RADMeth model, there were some cases where the methylation states of both the case and control groups were exactly 0 or 1 for which RADMeth failed to calculate <italic toggle="yes">P</italic>-values. The result for these cytosines were removed before ROC and AUROC calculations. dmrseq was run first with default parameters and then with a higher maximum number of permutations and lower cutoff value for the single CpG coefficient, but the AUROC values for the method remained very low (possibly for some technical incompatibility reasons) and were thus left out from the result table. M<sup>3</sup>D was run with default parameters. For M<sup>3</sup>D all the simulated datasets (with one simulation setting) were given to M<sup>3</sup>D at the same time as separate testing regions, each with different dummy chromosome name. For the ROC and AUROC calculations the unadjusted <italic toggle="yes">P</italic>-values were used, as they gave slightly better result than the FDR-adjusted <italic toggle="yes">P</italic>-values even though the FDR-correction should not change the ranking of the <italic toggle="yes">P</italic>-values. metilene, bsseq and DSS were all run to compare the difference between case and control groups for each simulated genomic window separately. metilene was run with <italic toggle="yes">de novo</italic> DMR finding mode, with maximum distance between CpGs in a DMR set to 1000 and minimum number of CpGs in a DMR set to one. Minimum mean methylation difference for calling DMRs was set to zero. Additionally, we ran metilene with predefined regions mode with the same settings as for the default <italic toggle="yes">de novo</italic> DMR finding mode, using the start and end coordinates of each simulated genomic window for defining the regions for which the statistical testing is performed. From now on, we will refer to the <italic toggle="yes">de novo</italic> DMR finding mode as metilene, whereas the predefined regions mode is referred to as metilene mode 2. With bsseq, we first ran the smoothing step with minimum number of cytosines in a smoothing window set to one. Then Fisher’s exact test was run with bsseq. The <italic toggle="yes">t</italic>-test feature in bsseq was not utilized for comparison, as the tool does not include <italic toggle="yes">P</italic>-value calculation for the <italic toggle="yes">t</italic>-test statistics. We ran DSS tool with no smoothing and with smoothing, using two different smoothing window spans, 500 and 1000 bp. The approach with 1000 bp smoothing window span showed the best performance. The most interesting tools to compare LuxUS with are perhaps RADMeth and DSS, which alike LuxUS allow including additional covariates into the analysis.</p>
      <p>The area under receiver operating characteristic curve (AUROC) values for the different approaches are presented in <xref rid="btaa539-T1" ref-type="table">Tables 1</xref> and <xref rid="btaa539-T2" ref-type="table">2</xref>. The ADVI version of LuxUS has a tendency of outputting very high or infinite valued Bayes factors for easier cases. To avoid problems of comparing infinite values to each other in the ROC calculation, the infinite values have been replaced with the greatest non-infinite Bayes factor value with small constant added. For the cytosines for which RADMeth failed to calculate <italic toggle="yes">P</italic>-values, the values were removed. If the DMRs found by metilene with <italic toggle="yes">de novo</italic> DMR finding mode did not cover all the cytosines in a simulated genomic window, the not covered cytosines were given <italic toggle="yes">P</italic>-value 1 for ROC calculation. The AUROC values in <xref rid="btaa539-T1" ref-type="table">Table 1</xref>, presenting results for simulation setting where expected methylation level difference between case and control groups was <inline-formula id="IE91"><mml:math id="IM91" display="inline" overflow="scroll"><mml:mrow><mml:mo>Δ</mml:mo><mml:mo>θ</mml:mo><mml:mo>≈</mml:mo><mml:mo>−</mml:mo><mml:mn>0.2</mml:mn></mml:mrow></mml:math></inline-formula>, show that metilene with predefined regions mode slightly outperforms LuxUS in most of the cases. While in <xref rid="btaa539-T2" ref-type="table">Table 2</xref>, presenting results for simulation setting where <inline-formula id="IE92"><mml:math id="IM92" display="inline" overflow="scroll"><mml:mrow><mml:mo>Δ</mml:mo><mml:mo>θ</mml:mo><mml:mo>≈</mml:mo><mml:mo>−</mml:mo><mml:mn>0.5</mml:mn></mml:mrow></mml:math></inline-formula>, for the most of the cases the LuxUS model gives the highest AUROC values. The difference between the results from running LuxUS for a genomic window and for each cytosine separately is considerable. For these simulation settings, using variational inference for estimating the model parameters results in nearly as good results as using HMC sampling, while also being significantly faster, as can be seen in <xref rid="sup1" ref-type="supplementary-material">Supplementary Table S1</xref> in which the comparison of mean computation times for the HMC and ADVI approaches is presented. RADMeth, M<sup>3</sup>D, metilene with <italic toggle="yes">de novo</italic> DMR finding mode and bsseq show better performance than LuxUS run separately for each cytosine, but they do not achieve the same accuracy as LuxUS and metilene mode 2, with one exception where M<sup>3</sup>D tops all the other methods. DSS performs well, but it has the best AUROC values in only four of the simulation cases shown in the tables. While for LuxUS, RADMeth, metilene, DSS and bsseq performance gets systematically better when the replicate or read count is increases, the performance of M<sup>3</sup>D fluctuates. LuxUS and metilene mode 2 seem to do equally well in this simulation experiment. However, unlike LuxUS metilene is not able to take into account additional covariates which is often desired in real data analysis. The AUROC values and ROC curves for the simulation settings with different <italic toggle="yes">μ<sub>b</sub></italic> can be found in Supplementary Tables S2, S3 and <xref rid="sup1" ref-type="supplementary-material">Supplementary Figures S20–S23</xref>, respectively. Supplementary Section S4.7 demonstrates how LuxUS can estimate the underlying methylation proportions. To demonstrate that LuxUS performs well even with a smaller, more realistic DMR proportion, we also performed comparisons with a dataset consisting of 1000 simulated regions out of which 50 (5%) were DMRs. The results are presented in the form of precision–recall curves and average precision tables in Supplementary Sections S4.5 and S4.6. The results are fairly similar to the ones with 50% DMR proportion, as LuxUS HMC, metilene and DSS are performing approximately equally well when the methylation state difference between case and control samples is small. When the difference is bigger, LuxUS HMC shows the best performance. RADMeth and M<sup>3</sup>D perform relatively well, whereas bsseq and LuxUS run separately for each cytosine have the lowest AUROC values. However, this time LuxUS ADVI was not able to reach the same AUROC value levels as LuxUS HMC and its precision–recall curves show unexpected behavior, which might be because of its tendency of returning very high BF approximation values.
</p>
      <table-wrap position="float" id="btaa539-T1">
        <label>Table 1.</label>
        <caption>
          <p>AUROC values for LuxUS with HMC and ADVI, LuxUS for separate cytosines, RADMeth, M<sup>3</sup>D, metilene, DSS and bsseq for simulated dataset with <inline-formula id="IE93"><mml:math id="IM93" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow><mml:mi mathvariant="normal">b</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1.4</mml:mn><mml:mo>,</mml:mo><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula>, corresponding to <inline-formula id="IE94"><mml:math id="IM94" display="inline" overflow="scroll"><mml:mrow><mml:mo>Δ</mml:mo><mml:mo>θ</mml:mo><mml:mo>≈</mml:mo><mml:mo>−</mml:mo><mml:mn>0.2</mml:mn></mml:mrow></mml:math></inline-formula></p>
        </caption>
        <table frame="hsides" rules="groups">
          <colgroup span="1">
            <col valign="top" align="left" span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
          </colgroup>
          <thead>
            <tr>
              <th rowspan="1" colspan="1">
                <inline-formula id="IE95">
                  <mml:math id="IM95" display="inline" overflow="scroll">
                    <mml:mrow>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>N</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mtext>BS</mml:mtext>
                        </mml:mrow>
                      </mml:msub>
                    </mml:mrow>
                  </mml:math>
                </inline-formula>
              </th>
              <th rowspan="1" colspan="1">
                <italic toggle="yes">N<sub>R</sub></italic>
              </th>
              <th rowspan="1" colspan="1">LuxUS</th>
              <th rowspan="1" colspan="1">LuxUS</th>
              <th rowspan="1" colspan="1">LuxUS</th>
              <th rowspan="1" colspan="1">RAD-</th>
              <th rowspan="1" colspan="1">M<sup>3</sup>D</th>
              <th rowspan="1" colspan="1">metilene</th>
              <th rowspan="1" colspan="1">metilene</th>
              <th rowspan="1" colspan="1">DSS</th>
              <th rowspan="1" colspan="1">bsseq</th>
            </tr>
            <tr>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1">HMC</th>
              <th rowspan="1" colspan="1">ADVI</th>
              <th rowspan="1" colspan="1">sep.</th>
              <th rowspan="1" colspan="1">Meth</th>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1">mode 2</th>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1"/>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">0.734</td>
              <td rowspan="1" colspan="1">0.738</td>
              <td rowspan="1" colspan="1">0.522</td>
              <td rowspan="1" colspan="1">0.607</td>
              <td rowspan="1" colspan="1">0.719</td>
              <td rowspan="1" colspan="1">0.631</td>
              <td rowspan="1" colspan="1">
                <bold>0.767</bold>
              </td>
              <td rowspan="1" colspan="1">0.738</td>
              <td rowspan="1" colspan="1">0.615</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">0.814</td>
              <td rowspan="1" colspan="1">0.783</td>
              <td rowspan="1" colspan="1">0.606</td>
              <td rowspan="1" colspan="1">0.712</td>
              <td rowspan="1" colspan="1">0.703</td>
              <td rowspan="1" colspan="1">0.658</td>
              <td rowspan="1" colspan="1">
                <bold>0.818</bold>
              </td>
              <td rowspan="1" colspan="1">0.801</td>
              <td rowspan="1" colspan="1">0.643</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">
                <bold>0.923</bold>
              </td>
              <td rowspan="1" colspan="1">0.909</td>
              <td rowspan="1" colspan="1">0.687</td>
              <td rowspan="1" colspan="1">0.819</td>
              <td rowspan="1" colspan="1">0.682</td>
              <td rowspan="1" colspan="1">0.759</td>
              <td rowspan="1" colspan="1">0.917</td>
              <td rowspan="1" colspan="1">0.904</td>
              <td rowspan="1" colspan="1">0.711</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">0.687</td>
              <td rowspan="1" colspan="1">0.696</td>
              <td rowspan="1" colspan="1">0.545</td>
              <td rowspan="1" colspan="1">0.632</td>
              <td rowspan="1" colspan="1">0.640</td>
              <td rowspan="1" colspan="1">0.590</td>
              <td rowspan="1" colspan="1">
                <bold>0.698</bold>
              </td>
              <td rowspan="1" colspan="1">0.690</td>
              <td rowspan="1" colspan="1">0.590</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">0.822</td>
              <td rowspan="1" colspan="1">0.803</td>
              <td rowspan="1" colspan="1">0.625</td>
              <td rowspan="1" colspan="1">0.756</td>
              <td rowspan="1" colspan="1">0.701</td>
              <td rowspan="1" colspan="1">0.678</td>
              <td rowspan="1" colspan="1">
                <bold>0.827</bold>
              </td>
              <td rowspan="1" colspan="1">0.812</td>
              <td rowspan="1" colspan="1">0.654</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">0.927</td>
              <td rowspan="1" colspan="1">0.899</td>
              <td rowspan="1" colspan="1">0.721</td>
              <td rowspan="1" colspan="1">0.867</td>
              <td rowspan="1" colspan="1">0.755</td>
              <td rowspan="1" colspan="1">0.781</td>
              <td rowspan="1" colspan="1">
                <bold>0.928</bold>
              </td>
              <td rowspan="1" colspan="1">0.924</td>
              <td rowspan="1" colspan="1">0.754</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">0.667</td>
              <td rowspan="1" colspan="1">0.668</td>
              <td rowspan="1" colspan="1">0.541</td>
              <td rowspan="1" colspan="1">0.612</td>
              <td rowspan="1" colspan="1">
                <bold>0.703</bold>
              </td>
              <td rowspan="1" colspan="1">0.635</td>
              <td rowspan="1" colspan="1">0.686</td>
              <td rowspan="1" colspan="1">0.680</td>
              <td rowspan="1" colspan="1">0.597</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">0.840</td>
              <td rowspan="1" colspan="1">0.835</td>
              <td rowspan="1" colspan="1">0.637</td>
              <td rowspan="1" colspan="1">0.765</td>
              <td rowspan="1" colspan="1">0.777</td>
              <td rowspan="1" colspan="1">0.735</td>
              <td rowspan="1" colspan="1">0.850</td>
              <td rowspan="1" colspan="1">
                <bold>0.852</bold>
              </td>
              <td rowspan="1" colspan="1">0.712</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">0.933</td>
              <td rowspan="1" colspan="1">0.886</td>
              <td rowspan="1" colspan="1">0.762</td>
              <td rowspan="1" colspan="1">0.890</td>
              <td rowspan="1" colspan="1">0.732</td>
              <td rowspan="1" colspan="1">0.830</td>
              <td rowspan="1" colspan="1">
                <bold>0.934</bold>
              </td>
              <td rowspan="1" colspan="1">0.916</td>
              <td rowspan="1" colspan="1">0.773</td>
            </tr>
          </tbody>
        </table>
        <table-wrap-foot>
          <fn id="tblfn1">
            <p><italic toggle="yes">Note</italic>: The highest AUROC value is bolded for each simulation scenario. <inline-formula id="IE96"><mml:math id="IM96" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> denotes the number of sequencing reads overlapping a cytosine and <italic toggle="yes">N<sub>R</sub></italic> denotes the number of samples.</p>
          </fn>
        </table-wrap-foot>
      </table-wrap>
      <table-wrap position="float" id="btaa539-T2">
        <label>Table 2.</label>
        <caption>
          <p>AUROC values for LuxUS with HMC and ADVI, LuxUS for separate cytosines, RADMeth, M<sup>3</sup>D, DSS, metilene and bsseq for simulated dataset with <inline-formula id="IE97"><mml:math id="IM97" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi mathvariant="normal">B</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1.4</mml:mn><mml:mo>,</mml:mo><mml:mo>−</mml:mo><mml:mn>2.3</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula>, corresponding to <inline-formula id="IE98"><mml:math id="IM98" display="inline" overflow="scroll"><mml:mrow><mml:mo>Δ</mml:mo><mml:mo>θ</mml:mo><mml:mo>≈</mml:mo><mml:mo>−</mml:mo><mml:mn>0.5</mml:mn></mml:mrow></mml:math></inline-formula></p>
        </caption>
        <table frame="hsides" rules="groups">
          <colgroup span="1">
            <col valign="top" align="left" span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
          </colgroup>
          <thead>
            <tr>
              <th rowspan="1" colspan="1">
                <inline-formula id="IE99">
                  <mml:math id="IM99" display="inline" overflow="scroll">
                    <mml:mrow>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>N</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mtext>BS</mml:mtext>
                        </mml:mrow>
                      </mml:msub>
                    </mml:mrow>
                  </mml:math>
                </inline-formula>
              </th>
              <th rowspan="1" colspan="1">
                <italic toggle="yes">N<sub>R</sub></italic>
              </th>
              <th rowspan="1" colspan="1">LuxUS</th>
              <th rowspan="1" colspan="1">LuxUS</th>
              <th rowspan="1" colspan="1">LuxUS</th>
              <th rowspan="1" colspan="1">RAD-</th>
              <th rowspan="1" colspan="1">M<sup>3</sup>D</th>
              <th rowspan="1" colspan="1">metilene</th>
              <th rowspan="1" colspan="1">metilene</th>
              <th rowspan="1" colspan="1">DSS</th>
              <th rowspan="1" colspan="1">bsseq</th>
            </tr>
            <tr>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1">HMC</th>
              <th rowspan="1" colspan="1">ADVI</th>
              <th rowspan="1" colspan="1">sep.</th>
              <th rowspan="1" colspan="1">Meth</th>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1">mode 2</th>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1"/>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">
                <bold>0.934</bold>
              </td>
              <td rowspan="1" colspan="1">0.890</td>
              <td rowspan="1" colspan="1">0.737</td>
              <td rowspan="1" colspan="1">0.824</td>
              <td rowspan="1" colspan="1">0.874</td>
              <td rowspan="1" colspan="1">0.816</td>
              <td rowspan="1" colspan="1">0.926</td>
              <td rowspan="1" colspan="1">0.917</td>
              <td rowspan="1" colspan="1">0.770</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">
                <bold>1.000</bold>
              </td>
              <td rowspan="1" colspan="1">0.975</td>
              <td rowspan="1" colspan="1">0.889</td>
              <td rowspan="1" colspan="1">0.974</td>
              <td rowspan="1" colspan="1">0.949</td>
              <td rowspan="1" colspan="1">0.923</td>
              <td rowspan="1" colspan="1">0.999</td>
              <td rowspan="1" colspan="1">0.997</td>
              <td rowspan="1" colspan="1">0.912</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">
                <bold>1.000</bold>
              </td>
              <td rowspan="1" colspan="1">0.960</td>
              <td rowspan="1" colspan="1">0.974</td>
              <td rowspan="1" colspan="1">0.994</td>
              <td rowspan="1" colspan="1">0.969</td>
              <td rowspan="1" colspan="1">0.910</td>
              <td rowspan="1" colspan="1">
                <bold>1.000</bold>
              </td>
              <td rowspan="1" colspan="1">
                <bold>1.000</bold>
              </td>
              <td rowspan="1" colspan="1">0.979</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">0.960</td>
              <td rowspan="1" colspan="1">0.942</td>
              <td rowspan="1" colspan="1">0.781</td>
              <td rowspan="1" colspan="1">0.881</td>
              <td rowspan="1" colspan="1">0.914</td>
              <td rowspan="1" colspan="1">0.821</td>
              <td rowspan="1" colspan="1">
                <bold>0.962</bold>
              </td>
              <td rowspan="1" colspan="1">0.957</td>
              <td rowspan="1" colspan="1">0.825</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">
                <bold>1.000</bold>
              </td>
              <td rowspan="1" colspan="1">0.940</td>
              <td rowspan="1" colspan="1">0.913</td>
              <td rowspan="1" colspan="1">0.978</td>
              <td rowspan="1" colspan="1">0.953</td>
              <td rowspan="1" colspan="1">0.950</td>
              <td rowspan="1" colspan="1">0.999</td>
              <td rowspan="1" colspan="1">0.998</td>
              <td rowspan="1" colspan="1">0.926</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">
                <bold>1.000</bold>
              </td>
              <td rowspan="1" colspan="1">0.940</td>
              <td rowspan="1" colspan="1">0.982</td>
              <td rowspan="1" colspan="1">0.995</td>
              <td rowspan="1" colspan="1">0.959</td>
              <td rowspan="1" colspan="1">0.982</td>
              <td rowspan="1" colspan="1">
                <bold>1.000</bold>
              </td>
              <td rowspan="1" colspan="1">
                <bold>1.000</bold>
              </td>
              <td rowspan="1" colspan="1">0.982</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">
                <bold>0.946</bold>
              </td>
              <td rowspan="1" colspan="1">0.924</td>
              <td rowspan="1" colspan="1">0.795</td>
              <td rowspan="1" colspan="1">0.871</td>
              <td rowspan="1" colspan="1">0.908</td>
              <td rowspan="1" colspan="1">0.836</td>
              <td rowspan="1" colspan="1">0.939</td>
              <td rowspan="1" colspan="1">0.936</td>
              <td rowspan="1" colspan="1">0.830</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">
                <bold>0.995</bold>
              </td>
              <td rowspan="1" colspan="1">0.934</td>
              <td rowspan="1" colspan="1">0.918</td>
              <td rowspan="1" colspan="1">0.966</td>
              <td rowspan="1" colspan="1">0.925</td>
              <td rowspan="1" colspan="1">0.931</td>
              <td rowspan="1" colspan="1">0.993</td>
              <td rowspan="1" colspan="1">0.988</td>
              <td rowspan="1" colspan="1">0.923</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">
                <bold>1.000</bold>
              </td>
              <td rowspan="1" colspan="1">0.945</td>
              <td rowspan="1" colspan="1">0.993</td>
              <td rowspan="1" colspan="1">0.996</td>
              <td rowspan="1" colspan="1">0.972</td>
              <td rowspan="1" colspan="1">0.964</td>
              <td rowspan="1" colspan="1">
                <bold>1.000</bold>
              </td>
              <td rowspan="1" colspan="1">
                <bold>1.000</bold>
              </td>
              <td rowspan="1" colspan="1">0.992</td>
            </tr>
          </tbody>
        </table>
        <table-wrap-foot>
          <fn id="tblfn2">
            <p><italic toggle="yes">Note</italic>: The highest AUROC value is bolded for each simulation scenario. <inline-formula id="IE100"><mml:math id="IM100" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> denotes the number of sequencing reads overlapping a cytosine and <italic toggle="yes">N<sub>R</sub></italic> denotes the number of samples.</p>
          </fn>
        </table-wrap-foot>
      </table-wrap>
      <p>To better demonstrate the concept of adding spatial correlation into the model, we simulated data with different numbers of cytosines in a window of 1000 basepairs and calculated the AUROC values for each case. The coefficient mean <inline-formula id="IE101"><mml:math id="IM101" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">μ</mml:mi></mml:mrow><mml:mi mathvariant="normal">b</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> was set to <inline-formula id="IE102"><mml:math id="IM102" display="inline" overflow="scroll"><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>1.4</mml:mn><mml:mo>,</mml:mo><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> and the number of reads and replicates was 12. Using this simulated data, the LuxUS model was estimated with HMC algorithm and Bayes factors were calculated. The results of this experiment can be seen in <xref rid="btaa539-F3" ref-type="fig">Figure 3</xref>, which shows that analyzing multiple cytosines at a time gives more statistical power and results in higher AUROC values. The turning point for this simulation setting seems to be between six and eight cytosines, after which adding more cytosines does not seem to add more power at least in this specific case. As the number of cytosines in the analysis increases, so does the number of parameters in the model and the size of the covariance matrices. This increases computation time during model estimation and can also lead to estimation inaccuracies or convergence issues during sampling. The increase in computation time for the colon cancer dataset is shown in <xref rid="sup1" ref-type="supplementary-material">Supplementary Figure S5</xref>, where the computation times for different number of cytosines being analyzed at a time are presented. The results shown in <xref rid="btaa539-F3" ref-type="fig">Figure 3</xref> indicate that increasing the number of cytosines in the analysis after some point does not give more power to the analysis, and it is not advisable in the sense of computational efficiency either.
</p>
      <fig position="float" id="btaa539-F3">
        <label>Fig. 3.</label>
        <caption>
          <p>The AUROC value for LuxUS as function of number of cytosines in a 1000 bp window for simulated data and its interpolation with third-degree polynomial. Each AUROC value is estimated using 400 datasets, including 200 datasets with differential methylation and 200 datasets with no differential methylation</p>
        </caption>
        <graphic xlink:href="btaa539f3" position="float"/>
      </fig>
      <p>LuxUS allows a general experimental design to be used in the analysis, and to present the advantages of this feature, we generated a simulated dataset with two confounding covariates. The design matrix consists of an intercept term, a binary covariate distinguishing cases from controls, a confounding binary covariate and a confounding continuous covariate, with corresponding coefficients <inline-formula id="IE103"><mml:math id="IM103" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mo>μ</mml:mo></mml:mrow><mml:mi mathvariant="normal">b</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1.4</mml:mn><mml:mo>,</mml:mo><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mn>2</mml:mn><mml:mo>,</mml:mo><mml:mo>−</mml:mo><mml:mn>3</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> used in generating the data. Details of the data generation can be found from Supplementary Section S4.1. The comparisons were conducted for both 50 and 5% DMR proportions. The AUROC values for each method for the comparison with 50% DMR proportion (200 simulated genomic regions in total) are presented in <xref rid="btaa539-T3" ref-type="table">Table 3</xref>. Corresponding ROC figures can be found in Supplementary Section S4.8. Based on the AUROC values, LuxUS HMC performs the best, whereas LuxUS ADVI and DSS tools also do well in the comparison. The continuous covariate was transformed into a binary covariate so that it could be utilized by RADMeth, but its AUROC values are lower than for LuxUS and DSS, which both allow continuous covariates. metilene mode 2 is performing approximately equally well as RADMeth. Unlike with the simple experimental design, the AUROC values for metilene mode 2 are considerably lower than for LuxUS and DSS for this simulation setting where the confounding coefficients have significant effects, muddling the difference between cases and controls. The default mode of metilene, bsseq, M<sup>3</sup>D and LuxUS run separately for each cytosine have the lowest AUROC values, which is expected as metilene, bsseq and M<sup>3</sup>D tools cannot take confounding covariates into account and bsseq and LuxUS (sep.) cannot utilize spatial correlation. The precision–recall curves and average precision tables for the 5% DMR proportion setting (1000 simulated genomic regions in total) are presented in Supplementary Sections S4.9 and S4.10. Comparing the average precision values, LuxUS HMC shows again the best performance. In this setting, metilene mode 2 seems to be doing slightly better than RADMeth. The average precisions for LuxUS ADVI are again notably lower than for LuxUS HMC in this setting where the DMR proportion is small.
</p>
      <table-wrap position="float" id="btaa539-T3">
        <label>Table 3.</label>
        <caption>
          <p>AUROC values for LuxUS with HMC and ADVI, LuxUS for separate cytosines, RADMeth, M<sup>3</sup>D, DSS, metilene and bsseq for simulated dataset with confounding covariates</p>
        </caption>
        <table frame="hsides" rules="groups">
          <colgroup span="1">
            <col valign="top" align="left" span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
            <col valign="top" align="char" char="." span="1"/>
          </colgroup>
          <thead>
            <tr>
              <th rowspan="1" colspan="1">
                <inline-formula id="IE104">
                  <mml:math id="IM104" display="inline" overflow="scroll">
                    <mml:mrow>
                      <mml:msub>
                        <mml:mrow>
                          <mml:mi>N</mml:mi>
                        </mml:mrow>
                        <mml:mrow>
                          <mml:mtext>BS</mml:mtext>
                        </mml:mrow>
                      </mml:msub>
                    </mml:mrow>
                  </mml:math>
                </inline-formula>
              </th>
              <th rowspan="1" colspan="1">
                <italic toggle="yes">N<sub>R</sub></italic>
              </th>
              <th rowspan="1" colspan="1">LuxUS</th>
              <th rowspan="1" colspan="1">LuxUS</th>
              <th rowspan="1" colspan="1">LuxUS</th>
              <th rowspan="1" colspan="1">RAD-</th>
              <th rowspan="1" colspan="1">M<sup>3</sup>D</th>
              <th rowspan="1" colspan="1">metilene</th>
              <th rowspan="1" colspan="1">metilene</th>
              <th rowspan="1" colspan="1">DSS</th>
              <th rowspan="1" colspan="1">bsseq</th>
            </tr>
            <tr>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1">HMC</th>
              <th rowspan="1" colspan="1">ADVI</th>
              <th rowspan="1" colspan="1">sep.</th>
              <th rowspan="1" colspan="1">Meth</th>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1">mode 2</th>
              <th rowspan="1" colspan="1"/>
              <th rowspan="1" colspan="1"/>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">
                <bold>0.859</bold>
              </td>
              <td rowspan="1" colspan="1">0.851</td>
              <td rowspan="1" colspan="1">0.605</td>
              <td rowspan="1" colspan="1">0.728</td>
              <td rowspan="1" colspan="1">0.674</td>
              <td rowspan="1" colspan="1">0.625</td>
              <td rowspan="1" colspan="1">0.717</td>
              <td rowspan="1" colspan="1">0.845</td>
              <td rowspan="1" colspan="1">0.614</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">6</td>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">
                <bold>0.907</bold>
              </td>
              <td rowspan="1" colspan="1">0.883</td>
              <td rowspan="1" colspan="1">0.682</td>
              <td rowspan="1" colspan="1">0.800</td>
              <td rowspan="1" colspan="1">0.618</td>
              <td rowspan="1" colspan="1">0.735</td>
              <td rowspan="1" colspan="1">0.840</td>
              <td rowspan="1" colspan="1">0.870</td>
              <td rowspan="1" colspan="1">0.688</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">
                <bold>0.809</bold>
              </td>
              <td rowspan="1" colspan="1">0.802</td>
              <td rowspan="1" colspan="1">0.634</td>
              <td rowspan="1" colspan="1">0.702</td>
              <td rowspan="1" colspan="1">0.644</td>
              <td rowspan="1" colspan="1">0.676</td>
              <td rowspan="1" colspan="1">0.712</td>
              <td rowspan="1" colspan="1">0.757</td>
              <td rowspan="1" colspan="1">0.628</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">
                <bold>0.938</bold>
              </td>
              <td rowspan="1" colspan="1">0.899</td>
              <td rowspan="1" colspan="1">0.748</td>
              <td rowspan="1" colspan="1">0.821</td>
              <td rowspan="1" colspan="1">0.722</td>
              <td rowspan="1" colspan="1">0.772</td>
              <td rowspan="1" colspan="1">0.861</td>
              <td rowspan="1" colspan="1">0.915</td>
              <td rowspan="1" colspan="1">0.737</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">12</td>
              <td rowspan="1" colspan="1">
                <bold>0.796</bold>
              </td>
              <td rowspan="1" colspan="1">0.738</td>
              <td rowspan="1" colspan="1">0.641</td>
              <td rowspan="1" colspan="1">0.717</td>
              <td rowspan="1" colspan="1">0.658</td>
              <td rowspan="1" colspan="1">0.592</td>
              <td rowspan="1" colspan="1">0.684</td>
              <td rowspan="1" colspan="1">0.750</td>
              <td rowspan="1" colspan="1">0.626</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">24</td>
              <td rowspan="1" colspan="1">
                <bold>0.915</bold>
              </td>
              <td rowspan="1" colspan="1">0.880</td>
              <td rowspan="1" colspan="1">0.731</td>
              <td rowspan="1" colspan="1">0.827</td>
              <td rowspan="1" colspan="1">0.690</td>
              <td rowspan="1" colspan="1">0.709</td>
              <td rowspan="1" colspan="1">0.836</td>
              <td rowspan="1" colspan="1">0.874</td>
              <td rowspan="1" colspan="1">0.714</td>
            </tr>
          </tbody>
        </table>
        <table-wrap-foot>
          <fn id="tblfn3">
            <p><italic toggle="yes">Note</italic>: The highest AUROC value is bolded for each simulation scenario. <inline-formula id="IE105"><mml:math id="IM105" display="inline" overflow="scroll"><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mtext>BS</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> denotes the number of sequencing reads overlapping a cytosine and <italic toggle="yes">N<sub>R</sub></italic> denotes the number of samples.</p>
          </fn>
        </table-wrap-foot>
      </table-wrap>
    </sec>
    <sec>
      <title>3.3 Performance comparisons on simulated differentially methylated regions based on real BS-seq data</title>
      <p>To make further comparisons of the performance of the tools with a model-independent dataset, we applied them on simulated data by <xref rid="btaa539-B10" ref-type="bibr">Hebestreit <italic toggle="yes">et al.</italic> (2013)</xref>. The simulation was based on RRBS-seq data of 12 control samples. Six of the controls were turned to cases by adding 10 000 simulated differentially methylated regions to randomly chosen CpG islands. The size of the DMRs and the methylation difference between the cases and controls was varied. For this comparison, the CpG islands containing a DMR were divided into DMR and non-DMR sets. For both sets, the LuxUS preanalysis step was run to divide them into genomic windows with LuxUS preanalysis method. The details of the preanalysis and data filtering can be found in Supplementary Section S5.1. About 3000 windows with minimum number of two cytosines were chosen randomly from both DMR and non-DMR groups. LuxUS, RADMeth, M<sup>3</sup>D, bsseq, metilene and DSS analyses were conducted on these 6000 windows. The experimental design consisted of an intercept term and a case–control indicator variable for LuxUS and RADMeth. With M<sup>3</sup>D, bsseq, DSS and metilene the difference between the case and control groups was tested. For RADMeth, the <italic toggle="yes">P</italic>-value adjustment step was performed for all the 6000 genomic windows together. LuxUS was run with HMC sampler, using four chains with 1500 samples in each out of which half were discarded as burn-in. With DSS tool, three different smoothing window spans (500, 1000 and 2000 bp) were tested along with approach with no smoothing. The DSS approach that yielded best AUROC value was smoothing with 500 bp window span and was chosen to be presented here. metilene tool was run with <italic toggle="yes">de novo</italic> DMR finding and predefined regions modes with the same settings, as described in Section 3.2, that the maximum allowed distance between two CpGs in a DMR was increased to 2000 bp. bsseq tool was used to run smoothing and Fisher’s exact test, similarly, as described in Section 3.2. For metilene, DSS and bsseq tools, the picked DMR and non-DMR windows were all analyzed together after sorting them based on their genomic locations.</p>
      <p>As the differentially methylated regions were known for this simulated dataset, ROC computation could be performed. <xref rid="btaa539-F4" ref-type="fig">Figure 4</xref> shows that all methods perform approximately equally well. LuxUS (HMC) has the highest AUROC value of 0.992, LuxUS with ADVI model fitting comes in second with AUROC value of 0.980 and RADMeth is third with AUROC value 0.968. metilene, M<sup>3</sup>D and DSS with 500 bp smoothing window span all performed well with AUROC values 0.957, 0.938 and 0.937, respectively, whereas bsseq has the lowest AUROC value of 0.909. For this dataset, LuxUS with ADVI produced a great number of very high and infinite-valued Bayes factors. The infinite-valued BFs were again replaced with the highest non-infinite BF value with a small constant added for the ROC calculation.
</p>
      <fig position="float" id="btaa539-F4">
        <label>Fig. 4.</label>
        <caption>
          <p>Receiver operating characteristics curves for LuxUS with HMC and ADVI model estimation, RADMeth, M<sup>3</sup>D, bsseq, metilene and DSS for the simulated data by <xref rid="btaa539-B10" ref-type="bibr">Hebestreit <italic toggle="yes">et al.</italic> (2013)</xref>. The dashed black line shows the expected ROC curve for random guessing</p>
        </caption>
        <graphic xlink:href="btaa539f4" position="float"/>
      </fig>
    </sec>
  </sec>
  <sec>
    <title>4 Discussion</title>
    <p>The LuxUS method was tested on both simulated and real datasets. The results for the simulated data show that including spatial correlation to the model gives clear advantage when compared to the analysis with only one cytosine being analyzed at a time. Comparison with other methods showed that our method performed as well or better than the other methods in almost all simulation settings. In real bisulfite sequencing data analysis, LuxUS was more conservative than RADMeth, as the number of differentially methylated cytosines found by LuxUS was considerably lower than for RADMeth. This of course depends on the chosen significance levels and Bayes factor cutoff-values. There was a clear overlap between the differentially methylated cytosines retrieved from these two methods, as three-fourths of the differentially methylated cytosines found by LuxUS were also found by RADMeth. The follow-up analysis with GREAT tool implied that the both methods were able to find biologically significant DMRs.</p>
    <p>Based on the results on the simulated datasets, the optimal number of cytosines in a window might be 5–10, as this enhances the statistical power of the statistical testing, whereas the model estimation can be done computationally efficiently. Based on the AUROC values calculated for the simulated data with 50% DMR proportion, both the HMC and ADVI methods for estimating the model seem to perform equally well. However, with 5% DMR proportion the average precision values LuxUS HMC were higher than for LuxUS ADVI. The HMC approach provides better model inference tools for cases where closer investigation on the fitted model is desirable, whereas ADVI is considerably faster. Simple two-group comparison simulation experiments were conducted both with a 50% and a more realistic 5% DMR proportions, which both yielded similar results. Depending on the simulation setting, usually either LuxUS HMC or metilene mode 2 showed best performance. For the simulated dataset by <xref rid="btaa539-B10" ref-type="bibr">Hebestreit <italic toggle="yes">et al.</italic> (2013)</xref>, all of the methods performed nearly equally well, albeit the preprocessing of the data was done with respect to the restrictions of the RADMeth tool.</p>
    <p>Our method enables including both continuous and binary covariates into the fixed effect design matrix and inference on the estimated model, which is not possible with some other tools such as RADMeth, which cannot handle continuous covariates and does not provide a summary of the fitted models. Some tools, such as metilene, cannot consider any covariates and allow only a comparison between two groups. Accounting for confounding factors is important as several factors, such as age of an individual and smoking history, are known to affect DNA methylation. We demonstrated the advantage of this feature with simulation experiments where two confounding covariates were included. In these experiments, LuxUS had the best AUROC and average precision values. The metilene (mode 2) tool, which performed well with the simple two-group comparison simulation setting, could not reach the same AUROC and AP levels as the tools which could take the confounding effects into account. With LuxUS, the posterior samples for the linear model coefficients and variance parameters can be explored using the summary and plotting utilities provided in Stan.</p>
    <p>Two questions concerning our model are that does the correlation structure match reality well enough and how the priors for the variance parameters should be set. We have provided a set of default parameters for the tool, but the parameter values can be adjusted by the user to match the problem at hand and to the available computational resources. Similarly, the choice of the parameters used in the preanalysis step and the cutoff-value for the Bayes factors affect the final results. As we use the Savage–Dickey Bayes factor estimate, it may be advisable to empirically calibrate Bayes factor cutoffs for significance e.g. using some known differentially methylated loci. As the ADVI estimates of the posteriors seem to underestimate variance, the Savage–Dickey estimates of the Bayes factors tend to have very high values. To scale down the Bayes factor magnitude, one could opt for using wider bandwidth for the kernel density estimation used in the Savage–Dickey estimation calculation. For example the Scott’s ‘rule of thumb’ bandwidth which is currently used in the kernel density estimation step could be doubled to produce more conservative kernel density estimates.</p>
    <p>Finally, it is possible to extend our model to incorporate the oxidized methylcytosine species into the analysis as done previously in LuxGLM.</p>
  </sec>
  <sec>
    <title>5 Conclusion</title>
    <p>We have proposed a new tool for detecting differential methylation, which uses the spatial correlation of neighboring cytosines to enhance the accuracy of detecting differential methylation. The presented results show that our tool is able to quantify differential methylation from both simulated and real BS-seq data. Comparisons on simulated data show that our model performs as well as, or even better, than previous methods.</p>
    <p>The provided preanalysis step can be used to reduce the number of genomic windows for which the Bayesian analysis is done, and the computations can be parallelized for computational efficiency. Opting for variational inference in the model estimation step reduces the needed computation time even further, without having to compromise the accuracy of the fitted model. The tool is available at <ext-link xlink:href="https://github.com/hallav/LuxUS" ext-link-type="uri">https://github.com/hallav/LuxUS</ext-link>.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material id="sup1" position="float" content-type="local-data">
      <label>btaa539_Supplementary_File</label>
      <media xlink:href="btaa539_supplementary_file.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack id="ack1">
    <title>Acknowledgements</title>
    <p>The authors acknowledge the computational resources provided by the Aalto Science-IT project.</p>
    <sec>
      <title>Funding</title>
      <p>This work was supported by the Academy of Finland (project numbers: 292660 and 314445).</p>
      <p><italic toggle="yes">Conflict of Interest</italic>: none declared.</p>
    </sec>
  </ack>
  <ref-list id="ref1">
    <title>References</title>
    <ref id="btaa539-B1">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Äijo</surname><given-names>T.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2016</year>) 
<article-title>LuxGLM: a probabilistic covariate model for quantification of DNA methylation modifications with complex experimental designs</article-title>. <source>Bioinformatics</source>, <volume>32</volume>, <fpage>i511</fpage>–<lpage>i519</lpage>.<pub-id pub-id-type="pmid">27587669</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B2">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Carpenter</surname><given-names>B.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2017</year>) 
<article-title>Stan: a probabilistic programming language</article-title>. <source>J. Stat. Softw</source>., <volume>76</volume>, 1–32.</mixed-citation>
    </ref>
    <ref id="btaa539-B3">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Dolzhenko</surname><given-names>E.</given-names></string-name>, <string-name><surname>Smith</surname><given-names>A.D.</given-names></string-name></person-group> (<year>2014</year>) 
<article-title>Using beta-binomial regression for high-precision differential methylation analysis in multifactor whole-genome bisulfite sequencing experiments</article-title>. <source>BMC Bioinformatics</source>, <volume>15</volume>, <fpage>215</fpage>.<pub-id pub-id-type="pmid">24962134</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B4">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Eckhardt</surname><given-names>F.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2006</year>) 
<article-title>DNA methylation profiling of human chromosomes 6, 20 and 22</article-title>. <source>Nat. Genet</source>., <volume>38</volume>, <fpage>1378</fpage>–<lpage>1385</lpage>.<pub-id pub-id-type="pmid">17072317</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B5">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Feng</surname><given-names>H.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2014</year>) 
<article-title>A Bayesian hierarchical model to detect differentially methylated loci from single nucleotide resolution sequencing data</article-title>. <source>Nucleic Acids Res</source>., <volume>42</volume>, <fpage>e69</fpage>.<pub-id pub-id-type="pmid">24561809</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B7">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Hansen</surname><given-names>K.D.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2012</year>) 
<article-title>BSmooth: from whole genome bisulfite sequencing reads to differentially methylated regions</article-title>. <source>Genome Biol</source>., <volume>13</volume>, <fpage>R83</fpage>.<pub-id pub-id-type="pmid">23034175</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B8">
      <mixed-citation publication-type="other"><person-group person-group-type="author"><string-name><surname>Hansen</surname><given-names>K.D.</given-names></string-name></person-group> (<year>2018</year>) bsseqData: Example whole genome bisulfite data for the bsseq package. R package version 0.20.0. <ext-link xlink:href="http://bioconductor.org/packages/release/data/experiment/html/bsseqData.html" ext-link-type="uri">http://bioconductor.org/packages/release/data/experiment/html/bsseqData.html</ext-link>.</mixed-citation>
    </ref>
    <ref id="btaa539-B9">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Hascher</surname><given-names>A.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2014</year>) 
<article-title>DNA methyltransferase inhibition reverses epigenetically embedded phenotypes in lung cancer preferentially affecting polycomb target genes</article-title>. <source>Clin. Cancer Res</source>., <volume>20</volume>, <fpage>814</fpage>–<lpage>826</lpage>.<pub-id pub-id-type="pmid">24334763</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B10">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Hebestreit</surname><given-names>K.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2013</year>) 
<article-title>Detection of significantly differentially methylated regions in targeted bisulfite sequencing data</article-title>. <source>Bioinformatics</source>, <volume>29</volume>, <fpage>1647</fpage>–<lpage>1653</lpage>.<pub-id pub-id-type="pmid">23658421</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B11">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Jühling</surname><given-names>F.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2016</year>) 
<article-title>metilene: fast and sensitive calling of differentially methylated regions from bisulfite sequencing data</article-title>. <source>Genome Res</source>., <volume>26</volume>, <fpage>256</fpage>–<lpage>262</lpage>.<pub-id pub-id-type="pmid">26631489</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B12">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Kass</surname><given-names>R.</given-names></string-name>, <string-name><surname>Raftery</surname><given-names>A.</given-names></string-name></person-group> (<year>1995</year>) 
<article-title>Bayes factors</article-title>. <source>J. Am. Stat. Assoc</source>., <volume>90</volume>, <fpage>773</fpage>–<lpage>795</lpage>.</mixed-citation>
    </ref>
    <ref id="btaa539-B13">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Korthauer</surname><given-names>K.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2019</year>) 
<article-title>Detection and accurate false discovery rate control of differentially methylated regions from whole genome bisulfite sequencing</article-title>. <source>Biostatistics</source>, <volume>20</volume>, <fpage>367</fpage>–<lpage>383</lpage>.<pub-id pub-id-type="pmid">29481604</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B14">
      <mixed-citation publication-type="other"><person-group person-group-type="author"><string-name><surname>Kucukelbir</surname><given-names>A.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2015</year>) Automatic variational inference in stan. In: <italic toggle="yes">Advances in Neural Information Processing Systems</italic>, Curran Associates Inc., NY, US, p. <fpage>28</fpage>.</mixed-citation>
    </ref>
    <ref id="btaa539-B15">
      <mixed-citation publication-type="other"><person-group person-group-type="author"><string-name><surname>Malonzo</surname><given-names>M.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2018</year>) LuxRep: a technical replicate-aware method for bisulfite sequencing data analysis. bioRxiv 444711 [preprint]. doi: <pub-id pub-id-type="doi">10.1101/444711</pub-id>.</mixed-citation>
    </ref>
    <ref id="btaa539-B16">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Mayo</surname><given-names>T.R.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2015</year>) 
<article-title>M3D: a kernel-based test for spatially correlated changes in methylation profiles</article-title>. <source>Bioinformatics</source>, <volume>31</volume>, <fpage>809</fpage>–<lpage>816</lpage>.<pub-id pub-id-type="pmid">25398611</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B17">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>McLean</surname><given-names>C.Y.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2010</year>) 
<article-title>GREAT improves functional interpretation of cis-regulatory regions</article-title>. <source>Nat. Biotechnol</source>., <volume>28</volume>, <fpage>495</fpage>–<lpage>501</lpage>.<pub-id pub-id-type="pmid">20436461</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B18">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Park</surname><given-names>Y.</given-names></string-name>, <string-name><surname>Wu</surname><given-names>H.</given-names></string-name></person-group> (<year>2016</year>) 
<article-title>Differential methylation analysis for BS-seq data under general experimental design</article-title>. <source>Bioinformatics</source>, <volume>32</volume>, <fpage>1446</fpage>–<lpage>1453</lpage>.<pub-id pub-id-type="pmid">26819470</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B19">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Rackham</surname><given-names>O.J.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2017</year>) 
<article-title>A Bayesian approach for analysis of whole-Genome bisulfite sequencing data identifies disease-associated changes in DNA methylation</article-title>. <source>Genetics</source>, <volume>205</volume>, <fpage>1443</fpage>–<lpage>1458</lpage>.<pub-id pub-id-type="pmid">28213474</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B20">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Song</surname><given-names>Y.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2017</year>) 
<article-title>Collaborations between CpG sites in DNA methylation</article-title>. <source>Int. J. Modern Phys. B</source>, <volume>31</volume>, <fpage>1750243</fpage>.</mixed-citation>
    </ref>
    <ref id="btaa539-B21">
      <mixed-citation publication-type="other">Stan Development Team. (<year>2017</year>) PyStan: the Python interface to Stan, Version 2.16.0.0. <ext-link xlink:href="http://mc-stan.org" ext-link-type="uri">http://mc-stan.org</ext-link>.</mixed-citation>
    </ref>
    <ref id="btaa539-B22">
      <mixed-citation publication-type="other"> interface to Stan, Version 2.18.0. <ext-link xlink:href="https://mc-stan.org/users/citations/" ext-link-type="uri">https://mc-stan.org/users/citations/</ext-link>.</mixed-citation>
    </ref>
    <ref id="btaa539-B23">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Virtanen</surname><given-names>P.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2020</year>) 
<article-title>SciPy 1.0: fundamental algorithms for scientific computing in Python</article-title>. <source>Nat. Methods</source>, <volume>17</volume>, <fpage>261</fpage>–<lpage>272</lpage>.<pub-id pub-id-type="pmid">32015543</pub-id></mixed-citation>
    </ref>
    <ref id="btaa539-B24">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><string-name><surname>Wen</surname><given-names>Y.</given-names></string-name></person-group>  <etal>et al</etal> (<year>2016</year>) 
<article-title>Detection of differentially methylated regions in whole genome bisulfite sequencing data using local Getis-Ord statistics</article-title>. <source>Bioinformatics</source>, <volume>32</volume>, <fpage>3396</fpage>–<lpage>3404</lpage>.<pub-id pub-id-type="pmid">27493194</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
