<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.1d3 20150301//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 39.96?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">PLoS One</journal-id>
    <journal-id journal-id-type="iso-abbrev">PLoS ONE</journal-id>
    <journal-id journal-id-type="publisher-id">plos</journal-id>
    <journal-id journal-id-type="pmc">plosone</journal-id>
    <journal-title-group>
      <journal-title>PLoS ONE</journal-title>
    </journal-title-group>
    <issn pub-type="epub">1932-6203</issn>
    <publisher>
      <publisher-name>Public Library of Science</publisher-name>
      <publisher-loc>San Francisco, CA USA</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">5323003</article-id>
    <article-id pub-id-type="pmid">28231289</article-id>
    <article-id pub-id-type="publisher-id">PONE-D-16-40998</article-id>
    <article-id pub-id-type="doi">10.1371/journal.pone.0171784</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Research Article</subject>
      </subj-group>
      <subj-group subj-group-type="Discipline-v3">
        <subject>Computer and Information Sciences</subject>
        <subj-group>
          <subject>Information Technology</subject>
          <subj-group>
            <subject>Databases</subject>
          </subj-group>
        </subj-group>
      </subj-group>
      <subj-group subj-group-type="Discipline-v3">
        <subject>Research and Analysis Methods</subject>
        <subj-group>
          <subject>Database and Informatics Methods</subject>
          <subj-group>
            <subject>Database Searching</subject>
          </subj-group>
        </subj-group>
      </subj-group>
      <subj-group subj-group-type="Discipline-v3">
        <subject>Medicine and Health Sciences</subject>
        <subj-group>
          <subject>Endocrinology</subject>
          <subj-group>
            <subject>Endocrine Disorders</subject>
            <subj-group>
              <subject>Diabetes Mellitus</subject>
            </subj-group>
          </subj-group>
        </subj-group>
      </subj-group>
      <subj-group subj-group-type="Discipline-v3">
        <subject>Medicine and Health Sciences</subject>
        <subj-group>
          <subject>Metabolic Disorders</subject>
          <subj-group>
            <subject>Diabetes Mellitus</subject>
          </subj-group>
        </subj-group>
      </subj-group>
      <subj-group subj-group-type="Discipline-v3">
        <subject>Medicine and Health Sciences</subject>
        <subj-group>
          <subject>Health Care</subject>
          <subj-group>
            <subject>Primary Care</subject>
          </subj-group>
        </subj-group>
      </subj-group>
      <subj-group subj-group-type="Discipline-v3">
        <subject>Research and Analysis Methods</subject>
        <subj-group>
          <subject>Database and Informatics Methods</subject>
        </subj-group>
      </subj-group>
      <subj-group subj-group-type="Discipline-v3">
        <subject>Medicine and Health Sciences</subject>
        <subj-group>
          <subject>Pulmonology</subject>
          <subj-group>
            <subject>Asthma</subject>
          </subj-group>
        </subj-group>
      </subj-group>
      <subj-group subj-group-type="Discipline-v3">
        <subject>Computer and Information Sciences</subject>
        <subj-group>
          <subject>Information Technology</subject>
          <subj-group>
            <subject>Data Processing</subject>
          </subj-group>
        </subj-group>
      </subj-group>
      <subj-group subj-group-type="Discipline-v3">
        <subject>Medicine and Health Sciences</subject>
        <subj-group>
          <subject>Pharmacology</subject>
          <subj-group>
            <subject>Drug Screening</subject>
          </subj-group>
        </subj-group>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>rEHR: An R package for manipulating and analysing Electronic Health Record data</article-title>
      <alt-title alt-title-type="running-head">rEHR: An R package for manipulating and analysing Electronic Health Record data</alt-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Springate</surname>
          <given-names>David A.</given-names>
        </name>
        <xref ref-type="aff" rid="aff001">
          <sup>1</sup>
        </xref>
        <xref ref-type="aff" rid="aff002">
          <sup>2</sup>
        </xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Parisi</surname>
          <given-names>Rosa</given-names>
        </name>
        <xref ref-type="aff" rid="aff003">
          <sup>3</sup>
        </xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Olier</surname>
          <given-names>Ivan</given-names>
        </name>
        <xref ref-type="aff" rid="aff004">
          <sup>4</sup>
        </xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Reeves</surname>
          <given-names>David</given-names>
        </name>
        <xref ref-type="aff" rid="aff001">
          <sup>1</sup>
        </xref>
        <xref ref-type="aff" rid="aff002">
          <sup>2</sup>
        </xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0001-6450-5815</contrib-id>
        <name>
          <surname>Kontopantelis</surname>
          <given-names>Evangelos</given-names>
        </name>
        <xref ref-type="aff" rid="aff001">
          <sup>1</sup>
        </xref>
        <xref ref-type="aff" rid="aff005">
          <sup>5</sup>
        </xref>
        <xref ref-type="author-notes" rid="currentaff001">
          <sup>¤</sup>
        </xref>
        <xref ref-type="corresp" rid="cor001">*</xref>
      </contrib>
    </contrib-group>
    <aff id="aff001">
      <label>1</label>
      <addr-line>NIHR School for Primary Care Research, University of Manchester, Manchester, United Kingdom</addr-line>
    </aff>
    <aff id="aff002">
      <label>2</label>
      <addr-line>Centre for Biostatistics, Faculty of Biology, Medicine &amp; Health, University of Manchester, Manchester, United Kingdom</addr-line>
    </aff>
    <aff id="aff003">
      <label>3</label>
      <addr-line>Centre for Pharmacoepidemiology &amp; Drug Safety, Faculty of Biology, Medicine &amp; Health, University of Manchester, Manchester, United Kingdom</addr-line>
    </aff>
    <aff id="aff004">
      <label>4</label>
      <addr-line>Informatics Research Centre, School of Computing Mathematics and Digital Technology, Manchester Metropolitan University, Manchester, United Kingdom</addr-line>
    </aff>
    <aff id="aff005">
      <label>5</label>
      <addr-line>The Farr Institute for Health Informatics Research, Faculty of Biology, Medicine &amp; Health, University of Manchester, Manchester, United Kingdom</addr-line>
    </aff>
    <contrib-group>
      <contrib contrib-type="editor">
        <name>
          <surname>Harezlak</surname>
          <given-names>Jaroslaw</given-names>
        </name>
        <role>Editor</role>
        <xref ref-type="aff" rid="edit1"/>
      </contrib>
    </contrib-group>
    <aff id="edit1">
      <addr-line>Indiana University, UNITED STATES</addr-line>
    </aff>
    <author-notes>
      <fn fn-type="COI-statement" id="coi001">
        <p><bold>Competing Interests: </bold>The authors have declared that no competing interests exist.</p>
      </fn>
      <fn fn-type="con">
        <p>
          <list list-type="simple">
            <list-item>
              <p><bold>Conceptualization:</bold> DAS EK.</p>
            </list-item>
            <list-item>
              <p><bold>Funding acquisition:</bold> EK DR.</p>
            </list-item>
            <list-item>
              <p><bold>Methodology:</bold> DAS EK.</p>
            </list-item>
            <list-item>
              <p><bold>Software:</bold> DAS RP.</p>
            </list-item>
            <list-item>
              <p><bold>Supervision:</bold> EK.</p>
            </list-item>
            <list-item>
              <p><bold>Validation:</bold> RP IO.</p>
            </list-item>
            <list-item>
              <p><bold>Visualization:</bold> DAS EK.</p>
            </list-item>
            <list-item>
              <p><bold>Writing – original draft:</bold> DAS.</p>
            </list-item>
            <list-item>
              <p><bold>Writing – review &amp; editing:</bold> RP IO DR EK.</p>
            </list-item>
          </list>
        </p>
      </fn>
      <fn fn-type="current-aff" id="currentaff001">
        <label>¤</label>
        <p>Current address: Vaughan House, Portsmouth Street, M13 9GB, Manchester, United Kingdom</p>
      </fn>
      <corresp id="cor001">* E-mail: <email>e.kontopantelis@manchester.ac.uk</email></corresp>
    </author-notes>
    <pub-date pub-type="collection">
      <year>2017</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>23</day>
      <month>2</month>
      <year>2017</year>
    </pub-date>
    <volume>12</volume>
    <issue>2</issue>
    <elocation-id>e0171784</elocation-id>
    <history>
      <date date-type="received">
        <day>14</day>
        <month>10</month>
        <year>2016</year>
      </date>
      <date date-type="accepted">
        <day>25</day>
        <month>1</month>
        <year>2017</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© 2017 Springate et al</copyright-statement>
      <copyright-year>2017</copyright-year>
      <copyright-holder>Springate et al</copyright-holder>
      <license xlink:href="http://creativecommons.org/licenses/by/4.0/">
        <license-p>This is an open access article distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use, distribution, and reproduction in any medium, provided the original author and source are credited.</license-p>
      </license>
    </permissions>
    <self-uri content-type="pdf" xlink:href="pone.0171784.pdf"/>
    <abstract>
      <p>Research with structured Electronic Health Records (EHRs) is expanding as data becomes more accessible; analytic methods advance; and the scientific validity of such studies is increasingly accepted. However, data science methodology to enable the rapid searching/extraction, cleaning and analysis of these large, often complex, datasets is less well developed. In addition, commonly used software is inadequate, resulting in bottlenecks in research workflows and in obstacles to increased transparency and reproducibility of the research. Preparing a research-ready dataset from EHRs is a complex and time consuming task requiring substantial data science skills, even for simple designs. In addition, certain aspects of the workflow are computationally intensive, for example extraction of longitudinal data and matching controls to a large cohort, which may take days or even weeks to run using standard software. The rEHR package simplifies and accelerates the process of extracting ready-for-analysis datasets from EHR databases. It has a simple import function to a database backend that greatly accelerates data access times. A set of generic query functions allow users to extract data efficiently without needing detailed knowledge of SQL queries. Longitudinal data extractions can also be made in a single command, making use of parallel processing. The package also contains functions for cutting data by time-varying covariates, matching controls to cases, unit conversion and construction of clinical code lists. There are also functions to synthesise dummy EHR. The package has been tested with one for the largest primary care EHRs, the Clinical Practice Research Datalink (CPRD), but allows for a common interface to other EHRs. This simplified and accelerated work flow for EHR data extraction results in simpler, cleaner scripts that are more easily debugged, shared and reproduced.</p>
    </abstract>
    <funding-group>
      <award-group id="award001">
        <funding-source>
          <institution>NIHR School for Primary Care Research</institution>
        </funding-source>
        <award-id>211</award-id>
        <principal-award-recipient>
          <contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0001-6450-5815</contrib-id>
          <name>
            <surname>Kontopantelis</surname>
            <given-names>Evangelos</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
      <award-group id="award002">
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="funder-id">http://dx.doi.org/10.13039/501100000265</institution-id>
            <institution>Medical Research Council</institution>
          </institution-wrap>
        </funding-source>
        <award-id>MR/K006665/1</award-id>
        <principal-award-recipient>
          <contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0001-6450-5815</contrib-id>
          <name>
            <surname>Kontopantelis</surname>
            <given-names>Evangelos</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
      <funding-statement>This study was funded by the National Institute for Health Research (NIHR) School for Primary Care Research (SPCR), under the title ‘An analytical framework for increasing the efficiency and validity of research using primary care databases’ (Project no. 211). This paper presents independent research funded by the National Institute for Health Research (NIHR). The views expressed are those of the authors and not necessarily those of the NHS, the National Institute for Health Research or the Department of Health. In addition, MRC Health eResearch Centre Grant MR/K006665/1 supported the time and facilities of one investigator (EK).</funding-statement>
    </funding-group>
    <counts>
      <fig-count count="0"/>
      <table-count count="3"/>
      <page-count count="25"/>
    </counts>
    <custom-meta-group>
      <custom-meta id="data-availability">
        <meta-name>Data Availability</meta-name>
        <meta-value>Data are available from the Comprehensive R Archive Network (CRAN) (<ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/web/packages/rEHR/index.html">https://cran.r-project.org/web/packages/rEHR/index.html</ext-link>) and via Github (<ext-link ext-link-type="uri" xlink:href="https://github.com/rOpenHealth/rEHR">https://github.com/rOpenHealth/rEHR</ext-link>).</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
  <notes>
    <title>Data Availability</title>
    <p>Data are available from the Comprehensive R Archive Network (CRAN) (<ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/web/packages/rEHR/index.html">https://cran.r-project.org/web/packages/rEHR/index.html</ext-link>) and via Github (<ext-link ext-link-type="uri" xlink:href="https://github.com/rOpenHealth/rEHR">https://github.com/rOpenHealth/rEHR</ext-link>).</p>
  </notes>
</front>
<body>
  <sec id="sec001">
    <title>1 Introduction</title>
    <p>We present the <monospace>R</monospace> R [<xref rid="pone.0171784.ref001" ref-type="bibr">1</xref>] package <monospace>rEHR</monospace> for manipulating and analysing Electronic Health Record (EHR) data and demonstrate its use with rEHR-generated synthetic data. <monospace>rEHR</monospace> is available from the Comprehensive R Archive Network (CRAN) at <ext-link ext-link-type="uri" xlink:href="https://CRAN.R-project.org/package=rEHR">https://CRAN.R-project.org/package=rEHR</ext-link>, and will work with <monospace>R-3.3.2</monospace>.</p>
    <p>The package has been developed using structured primary care data from the UK, which has enjoyed near-universal deployment of EHRs in general practice and clinical coding performed by general practitioners for over twenty years. Comprehensive anonymised extracts of these UK primary care records are made available for research—the main sources are: The Clinical Practice Research Datalink (CPRD, previously known as the General Practice Research Database, GPRD), The Health Improvement Network (THIN), QResearch, The Doctors’ Independent Network (DIN-LINK) and more recently, Research One. These databases hold near complete anonymised medical records for millions of patients and have very similar structures, including data on demographics, symptoms, tests, diagnoses, therapies, health-related behaviours and complete referrals to secondary care (since in the UK general practitioners are the gatekeepers of the health care system and manage specialist referrals). Using the CPRD as an example, in 2015 it reported coverage for over 1.3 million patients from 674 UK practices, with 4.4 million active (alive, meeting CPRD quality criteria and registered with one of the general practices at the end of 2015) patients thus covering approximately 6.9% of the UK population [<xref rid="pone.0171784.ref002" ref-type="bibr">2</xref>]. Due to the fact that these databases tend to be tied to specific clinical systems which demonstrate regional variability [<xref rid="pone.0171784.ref003" ref-type="bibr">3</xref>], there are some UK regions that are under-represented in each [<xref rid="pone.0171784.ref004" ref-type="bibr">4</xref>]. However, the size of all these databases ensures that included patients are broadly representative of the UK general population in terms of age, sex and ethnicity. To date, over 1600 papers have been published using these UK primary care databases (PCDs), with well over 150 papers published per year since 2012. EHR research is set to grow still faster due to advances in analysis methodology [<xref rid="pone.0171784.ref005" ref-type="bibr">5</xref>; <xref rid="pone.0171784.ref006" ref-type="bibr">6</xref>], an increasing body of evidence supporting the validity of such studies [<xref rid="pone.0171784.ref007" ref-type="bibr">7</xref>; <xref rid="pone.0171784.ref008" ref-type="bibr">8</xref>], and efforts to improve transparency and reproducibility [<xref rid="pone.0171784.ref009" ref-type="bibr">9</xref>].</p>
    <p>Despite the research interest in PCDs, data science methodology to enable the rapid searching/extraction, cleaning and analysis of these increasingly large and complex datasets is less well developed. In addition, commonly used software tools are often inadequate, resulting in bottlenecks in the research workflow and in obstacles to increased transparency and reproducibility of research. PCDs such as CPRD store data in complex relational and nested structures, and preparing an analysis-ready dataset requires substantial data science skills, even for simple designs. This complexity is an inevitable consequence of the wide range of information contained within these databases, which detail the primary care history for every patient, including coded data for all diagnoses, prescriptions, referrals and test results for all consultations. To manage this vast wealth of data requires a relational structure based on multiple tables, classifications and terminologies (e.g. Read codes for diagnoses and referrals, product codes for prescriptions). To extract relevant data, research teams have to complete a sequence of non-trivial technical tasks. The more complex the research design the more steps are required to obtain the final dataset. For example, investigating drug outcomes typically involves constructing complex definitions of codes for diagnosis, drug exposure (may be varying over time), mortality, and possible confounding factors (e.g. comorbidities, additional medications, gender, age, referrals, date of diagnosis, etc.). In addition, certain aspects of the workflow are computationally intensive (for example extraction of longitudinal data and matching controls to a large cohort)—often taking days or even weeks to run using standard software. Although more powerful computer facilities help (and are practically a prerequisite for working with these data), an inefficient and slow program running on a fast server will still be inefficient and slow. Some ‘how-to’ papers exist for good practice in observational data management but they address only some of the issues or focus on specific applications [<xref rid="pone.0171784.ref005" ref-type="bibr">5</xref>; <xref rid="pone.0171784.ref010" ref-type="bibr">10</xref>; <xref rid="pone.0171784.ref011" ref-type="bibr">11</xref>; <xref rid="pone.0171784.ref012" ref-type="bibr">12</xref>]. At the same time there is a wealth of health informatics and computer science literature on how to make these research processes more transparent, reducing the duplication of effort and improving the consistency of data processing [<xref rid="pone.0171784.ref013" ref-type="bibr">13</xref>; <xref rid="pone.0171784.ref014" ref-type="bibr">14</xref>]. Finally, several software packages exist for speeding up data analysis, but these are generic, do not apply directly to EHR manipulation and may require specialist knowledge to effectively use for fast manipulation of dataframes [<xref rid="pone.0171784.ref015" ref-type="bibr">15</xref>], for database integration [<xref rid="pone.0171784.ref016" ref-type="bibr">16</xref>], and for parallel processing (<monospace>parallel</monospace> in base <monospace>R</monospace>).</p>
    <p><monospace>rEHR</monospace> simplifies and accelerates the process of extracting ready-for-analysis datasets from EHR databases. In section 2 we provide instructions on loading the software and importing flat text files of the kind supplied by EHR providers into a local SQL database. In section 3 we describe the basic query operations provided by the package, the building of longitudinal data and calculation of prevalence and incidence statistics. In section 4 we convert the longitudinal data from the previous section to a cohort dataset suitable for survival analysis and illustrate algorithms to match controls to cases and to cut cohort data by time-varying covariates. In section 5 we briefly discuss some accessory functions provided in the package. In the final section we discuss the <monospace>.ehr</monospace> environment used to define the EHR database being used and how this can be set to work with different databases.</p>
    <p>The package includes a number of simulated flat files to allow users to familiarise themselves with advanced aspects, which we use in this paper to provide examples.</p>
  </sec>
  <sec id="sec002">
    <title>2 Importing EHR data</title>
    <p>rEHR is installed and loaded in the usual way:</p>
    <boxed-text id="pone.0171784.box001" position="anchor" orientation="portrait">
      <p specific-use="line">if(! <inline-formula id="pone.0171784.e001"><alternatives><graphic xlink:href="pone.0171784.e001.jpg" id="pone.0171784.e001g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M1"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>rEHR</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> %in% <inline-formula id="pone.0171784.e002"><alternatives><graphic xlink:href="pone.0171784.e002.jpg" id="pone.0171784.e002g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M2"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>rownames</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e003"><alternatives><graphic xlink:href="pone.0171784.e003.jpg" id="pone.0171784.e003g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M3"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>installed</mml:mtext><mml:mo>.</mml:mo><mml:mtext>packages</mml:mtext></mml:mstyle><mml:mo>(</mml:mo><mml:mo>)</mml:mo></mml:math></alternatives></inline-formula>)) <inline-formula id="pone.0171784.e004"><alternatives><graphic xlink:href="pone.0171784.e004.jpg" id="pone.0171784.e004g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M4"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>install</mml:mtext><mml:mo>.</mml:mo><mml:mtext>packages</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e005"><alternatives><graphic xlink:href="pone.0171784.e005.jpg" id="pone.0171784.e005g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M5"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>rEHR</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
      <p specific-use="line"><inline-formula id="pone.0171784.e006"><alternatives><graphic xlink:href="pone.0171784.e006.jpg" id="pone.0171784.e006g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M6"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>library</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(rEHR)</p>
    </boxed-text>
    <p>The development version of the package is available from <ext-link ext-link-type="uri" xlink:href="http://www.github.com">Github</ext-link> and is accessible via the devtools package [<xref rid="pone.0171784.ref017" ref-type="bibr">17</xref>]:</p>
    <boxed-text id="pone.0171784.box002" position="anchor" orientation="portrait">
      <p specific-use="line"><inline-formula id="pone.0171784.e007"><alternatives><graphic xlink:href="pone.0171784.e007.jpg" id="pone.0171784.e007g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M7"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>library</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(devtools)</p>
      <p specific-use="line"><inline-formula id="pone.0171784.e008"><alternatives><graphic xlink:href="pone.0171784.e008.jpg" id="pone.0171784.e008g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M8"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>install</mml:mtext><mml:mo>_</mml:mo><mml:mtext>github</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e009"><alternatives><graphic xlink:href="pone.0171784.e009.jpg" id="pone.0171784.e009g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M9"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>rOpenHealth</mml:mtext><mml:mo>/</mml:mo><mml:mtext>rEHR</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
      <p specific-use="line"><inline-formula id="pone.0171784.e010"><alternatives><graphic xlink:href="pone.0171784.e010.jpg" id="pone.0171784.e010g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M10"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>library</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(rEHR)</p>
    </boxed-text>
    <p>EHR data are stored as relational databases but are most commonly made available to researchers in the form of flat text files. This has the advantage of easier access for simple tasks and, for example, viewing the files in a spreadsheet. However, most non-trivial operations require researchers to iterate over a series of (potentially large) different groups of files. For example here we present pseudocode for a simple workflow leading to the production of a dataset of prevalent cases for a condition such as diabetes:</p>
    <boxed-text id="pone.0171784.box003" position="anchor" orientation="portrait">
      <p specific-use="line">
        <inline-formula id="pone.0171784.e011">
          <alternatives>
            <graphic xlink:href="pone.0171784.e011.jpg" id="pone.0171784.e011g" mimetype="image" position="anchor" orientation="portrait"/>
            <mml:math id="M11">
              <mml:mstyle mathcolor="#8F5903" mathvariant="monospace">
                <mml:mo>#</mml:mo>
                <mml:mtext mathvariant="italic">Pseudocode prevalent cases algorithm</mml:mtext>
              </mml:mstyle>
            </mml:math>
          </alternatives>
        </inline-formula>
      </p>
      <p specific-use="line">define a list of clinical codes for the condition</p>
      <p specific-use="line">for each practice:</p>
      <p specific-use="line"> load clinical events <inline-formula id="pone.0171784.e012"><alternatives><graphic xlink:href="pone.0171784.e012.jpg" id="pone.0171784.e012g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M12"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>files</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula> (clinical, referral, drugs etc.)</p>
      <p specific-use="line"> select clinical events matching the clinical code list</p>
      <p specific-use="line"> load patient and practice files</p>
      <p specific-use="line"> for each year:</p>
      <p specific-use="line">  select active patients</p>
      <p specific-use="line">  select events in year</p>
      <p specific-use="line">  merge active patients and events in year on condition algorithm</p>
      <p specific-use="line"> combine all years in practice</p>
      <p specific-use="line">combine patients in all practices</p>
    </boxed-text>
    <p>Each level of iteration (represented by the nested <monospace>for loops</monospace>) and each type of file (e.g. clinical, referral, drugs etc.) in the above algorithm introduces the opportunity for bugs to creep into extraction code, while the repeated opening and closing of multiple text files, combined with the inherent inefficiency of for loops in <monospace>R</monospace> often result in slow, error prone code. The <monospace>rEHR</monospace> package allows researchers to first automatically import these flat files into a SQLite database and then use predefined functions to query this database efficiently and precisely. We use SQLite databases for a variety of reasons:</p>
    <list list-type="bullet">
      <list-item>
        <p>SQLite databases are stored as files in the directory system of the computer and require no installation setup. SQLite3 is installed automatically as a result of installing the dependencies for the package</p>
      </list-item>
      <list-item>
        <p>SQLite files are stored efficiently and are relatively small compared to text files</p>
      </list-item>
      <list-item>
        <p>The SQL language has been optimised for very rapid and efficient queries of SQLite files, resulting in much faster queries than would be available to multiple flat files</p>
      </list-item>
      <list-item>
        <p>Working with SQLite databases allows users to use some very well developed tools that are already available to the <monospace>R</monospace> community such as <monospace>sqldf</monospace> [<xref rid="pone.0171784.ref016" ref-type="bibr">16</xref>] and <monospace>RSQLite</monospace> [<xref rid="pone.0171784.ref018" ref-type="bibr">18</xref>] if they are familiar with <monospace>R</monospace> SQL integration tools. These tools also allow for more specific tool functions to be built to shield users from the complexities of SQL queries.</p>
      </list-item>
    </list>
    <boxed-text id="pone.0171784.box004" position="anchor" orientation="portrait">
      <p specific-use="line">## Use simulated ehr files supplied with the package to build database</p>
      <p specific-use="line">ehr_path &lt;- <inline-formula id="pone.0171784.e013"><alternatives><graphic xlink:href="pone.0171784.e013.jpg" id="pone.0171784.e013g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M13"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>dirname</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e014"><alternatives><graphic xlink:href="pone.0171784.e014.jpg" id="pone.0171784.e014g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M14"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>system</mml:mtext><mml:mo>.</mml:mo><mml:mtext>file</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e015"><alternatives><graphic xlink:href="pone.0171784.e015.jpg" id="pone.0171784.e015g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M15"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>ehr</mml:mtext><mml:mo>_</mml:mo><mml:mtext>data</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e016"><alternatives><graphic xlink:href="pone.0171784.e016.jpg" id="pone.0171784.e016g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M16"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>ehr</mml:mtext><mml:mo>_</mml:mo><mml:mtext>Clinical</mml:mtext><mml:mo>.</mml:mo><mml:mtext>txt</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
      <p specific-use="line">    <inline-formula id="pone.0171784.e017"><alternatives><graphic xlink:href="pone.0171784.e017.jpg" id="pone.0171784.e017g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M17"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>package</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e018"><alternatives><graphic xlink:href="pone.0171784.e018.jpg" id="pone.0171784.e018g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M18"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e019"><alternatives><graphic xlink:href="pone.0171784.e019.jpg" id="pone.0171784.e019g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M19"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>rEHR</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>))</p>
      <p specific-use="line">## create a new database connection to a temporary file</p>
      <p specific-use="line">db &lt;- <inline-formula id="pone.0171784.e020"><alternatives><graphic xlink:href="pone.0171784.e020.jpg" id="pone.0171784.e020g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M20"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>database</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e021"><alternatives><graphic xlink:href="pone.0171784.e021.jpg" id="pone.0171784.e021g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M21"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>tempfile</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e022"><alternatives><graphic xlink:href="pone.0171784.e022.jpg" id="pone.0171784.e022g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M22"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>fileext</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e023"><alternatives><graphic xlink:href="pone.0171784.e023.jpg" id="pone.0171784.e023g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M23"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e024"><alternatives><graphic xlink:href="pone.0171784.e024.jpg" id="pone.0171784.e024g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M24"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mo>.</mml:mo><mml:mtext>sqlite</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>))</p>
      <p specific-use="line">## Import multiple data files into the database</p>
      <p specific-use="line"><inline-formula id="pone.0171784.e025"><alternatives><graphic xlink:href="pone.0171784.e025.jpg" id="pone.0171784.e025g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M25"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>import</mml:mtext><mml:mo>_</mml:mo><mml:mtext>CPRD</mml:mtext><mml:mo>_</mml:mo><mml:mtext>data</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db, <inline-formula id="pone.0171784.e026"><alternatives><graphic xlink:href="pone.0171784.e026.jpg" id="pone.0171784.e026g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M26"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>data</mml:mtext><mml:mo>_</mml:mo><mml:mtext>dir</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula> = ehr_path,</p>
      <p specific-use="line">         <inline-formula id="pone.0171784.e027"><alternatives><graphic xlink:href="pone.0171784.e027.jpg" id="pone.0171784.e027g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M27"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>filetypes</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e028"><alternatives><graphic xlink:href="pone.0171784.e028.jpg" id="pone.0171784.e028g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M28"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e029"><alternatives><graphic xlink:href="pone.0171784.e029.jpg" id="pone.0171784.e029g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M29"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e030"><alternatives><graphic xlink:href="pone.0171784.e030.jpg" id="pone.0171784.e030g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M30"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Clinical</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e031"><alternatives><graphic xlink:href="pone.0171784.e031.jpg" id="pone.0171784.e031g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M31"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Consultation</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
      <p specific-use="line">                 <inline-formula id="pone.0171784.e032"><alternatives><graphic xlink:href="pone.0171784.e032.jpg" id="pone.0171784.e032g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M32"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Patient</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e033"><alternatives><graphic xlink:href="pone.0171784.e033.jpg" id="pone.0171784.e033g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M33"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Practice</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
      <p specific-use="line">                 <inline-formula id="pone.0171784.e034"><alternatives><graphic xlink:href="pone.0171784.e034.jpg" id="pone.0171784.e034g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M34"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Referral</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
      <p specific-use="line">         <inline-formula id="pone.0171784.e035"><alternatives><graphic xlink:href="pone.0171784.e035.jpg" id="pone.0171784.e035g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M35"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>dateformat</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e036"><alternatives><graphic xlink:href="pone.0171784.e036.jpg" id="pone.0171784.e036g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M36"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e037"><alternatives><graphic xlink:href="pone.0171784.e037.jpg" id="pone.0171784.e037g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M37"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mo>%</mml:mo><mml:mtext>Y</mml:mtext><mml:mo>‐</mml:mo><mml:mo>%</mml:mo><mml:mtext>m</mml:mtext><mml:mo>‐</mml:mo><mml:mo>%</mml:mo><mml:mtext>d</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
      <p specific-use="line">         <inline-formula id="pone.0171784.e038"><alternatives><graphic xlink:href="pone.0171784.e038.jpg" id="pone.0171784.e038g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M38"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>yob</mml:mtext><mml:mo>_</mml:mo><mml:mtext>origin</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e039"><alternatives><graphic xlink:href="pone.0171784.e039.jpg" id="pone.0171784.e039g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M39"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e040"><alternatives><graphic xlink:href="pone.0171784.e040.jpg" id="pone.0171784.e040g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M40"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1800</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
      <p specific-use="line">         <inline-formula id="pone.0171784.e041"><alternatives><graphic xlink:href="pone.0171784.e041.jpg" id="pone.0171784.e041g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M41"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>regex</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e042"><alternatives><graphic xlink:href="pone.0171784.e042.jpg" id="pone.0171784.e042g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M42"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e043"><alternatives><graphic xlink:href="pone.0171784.e043.jpg" id="pone.0171784.e043g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M43"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>ehr</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
      <p specific-use="line">         <inline-formula id="pone.0171784.e044"><alternatives><graphic xlink:href="pone.0171784.e044.jpg" id="pone.0171784.e044g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M44"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>recursive</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e045"><alternatives><graphic xlink:href="pone.0171784.e045.jpg" id="pone.0171784.e045g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M45"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e046"><alternatives><graphic xlink:href="pone.0171784.e046.jpg" id="pone.0171784.e046g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M46"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>TRUE</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
      <p specific-use="line">## Individual files can also be added:</p>
      <p specific-use="line"><inline-formula id="pone.0171784.e047"><alternatives><graphic xlink:href="pone.0171784.e047.jpg" id="pone.0171784.e047g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M47"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>add</mml:mtext><mml:mo>_</mml:mo><mml:mtext>to</mml:mtext><mml:mo>_</mml:mo><mml:mtext>database</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db, <inline-formula id="pone.0171784.e048"><alternatives><graphic xlink:href="pone.0171784.e048.jpg" id="pone.0171784.e048g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M48"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>files</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e049"><alternatives><graphic xlink:href="pone.0171784.e049.jpg" id="pone.0171784.e049g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M49"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e050"><alternatives><graphic xlink:href="pone.0171784.e050.jpg" id="pone.0171784.e050g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M50"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>system</mml:mtext><mml:mo>.</mml:mo><mml:mtext>file</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e051"><alternatives><graphic xlink:href="pone.0171784.e051.jpg" id="pone.0171784.e051g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M51"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>ehr</mml:mtext><mml:mo>_</mml:mo><mml:mtext>data</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e052"><alternatives><graphic xlink:href="pone.0171784.e052.jpg" id="pone.0171784.e052g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M52"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>ehr</mml:mtext><mml:mo>_</mml:mo><mml:mtext>Therapy</mml:mtext><mml:mo>.</mml:mo><mml:mtext>txt</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
      <p specific-use="line">    <inline-formula id="pone.0171784.e053"><alternatives><graphic xlink:href="pone.0171784.e053.jpg" id="pone.0171784.e053g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M53"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>package</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e054"><alternatives><graphic xlink:href="pone.0171784.e054.jpg" id="pone.0171784.e054g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M54"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e055"><alternatives><graphic xlink:href="pone.0171784.e055.jpg" id="pone.0171784.e055g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M55"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>rEHR</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
      <p specific-use="line">        <inline-formula id="pone.0171784.e056"><alternatives><graphic xlink:href="pone.0171784.e056.jpg" id="pone.0171784.e056g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M56"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>table</mml:mtext><mml:mo>_</mml:mo><mml:mtext>name</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula> = <inline-formula id="pone.0171784.e057"><alternatives><graphic xlink:href="pone.0171784.e057.jpg" id="pone.0171784.e057g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M57"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Therapy</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e058"><alternatives><graphic xlink:href="pone.0171784.e058.jpg" id="pone.0171784.e058g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M58"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>dateformat</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e059"><alternatives><graphic xlink:href="pone.0171784.e059.jpg" id="pone.0171784.e059g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M59"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e060"><alternatives><graphic xlink:href="pone.0171784.e060.jpg" id="pone.0171784.e060g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M60"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mo>%</mml:mo><mml:mtext>Y</mml:mtext><mml:mo>‐</mml:mo><mml:mo>%</mml:mo><mml:mtext>m</mml:mtext><mml:mo>‐</mml:mo><mml:mo>%</mml:mo><mml:mtext>d</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
      <p specific-use="line">## Use the overloaded `head` function to view a list of</p>
      <p specific-use="line">## tables or the head of individual tables:</p>
      <p specific-use="line"><inline-formula id="pone.0171784.e061"><alternatives><graphic xlink:href="pone.0171784.e061.jpg" id="pone.0171784.e061g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M61"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>head</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db)</p>
    </boxed-text>
    <p specific-use="line">##  type   name   tbl_name</p>
    <p specific-use="line">## 1 table   Clinical   Clinical</p>
    <p specific-use="line">## 2 table Consultation Consultation</p>
    <p specific-use="line">## 3 table    Patient    Patient</p>
    <p specific-use="line">## 4 table   Practice   Practice</p>
    <p specific-use="line">## 5 table   Referral   Referral</p>
    <p specific-use="line">## 6 table   Therapy   Therapy</p>
    <boxed-text id="pone.0171784.box005" position="anchor" orientation="portrait">
      <p specific-use="line"><inline-formula id="pone.0171784.e062"><alternatives><graphic xlink:href="pone.0171784.e062.jpg" id="pone.0171784.e062g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M62"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>head</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db, <inline-formula id="pone.0171784.e063"><alternatives><graphic xlink:href="pone.0171784.e063.jpg" id="pone.0171784.e063g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M63"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>table</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e064"><alternatives><graphic xlink:href="pone.0171784.e064.jpg" id="pone.0171784.e064g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M64"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e065"><alternatives><graphic xlink:href="pone.0171784.e065.jpg" id="pone.0171784.e065g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M65"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Clinical</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
    </boxed-text>
    <p specific-use="line">##  patid  eventdate constype consid medcode   comorbidity practid</p>
    <p specific-use="line">## 1 1001 2003-08-25     0    4   69753   hypertension   1</p>
    <p specific-use="line">## 2 1001 2004-04-13     1    5   96277  atrial_fibrilation    1</p>
    <p specific-use="line">## 3 1001 2004-04-13     1    5   2212 atrial_fibrilation    1</p>
    <p specific-use="line">## 4 1001 2004-04-13     1    5   96076  atrial_fibrilation    1</p>
    <p specific-use="line">## 5 1001 2005-02-08     1    6   23579       chd    1</p>
    <p specific-use="line">## 6 1001 2005-02-18     1    7   16059   hypertension    1</p>
    <p>The <monospace>import_CPRD_data</monospace> and <monospace>add_to_database</monospace> functions are able to import tab-delimited text files or zipped tab-delimited text-files. By default, all date strings are converted to R dates with standard ISO format (“%Y-%m-%d”). A <monospace>regex</monospace> argument should be supplied that is a regular expression to match a common prefix to the filenames, separated from the file type by an underscore.</p>
  </sec>
  <sec id="sec003">
    <title>3 Querying the database</title>
    <sec id="sec004">
      <title>3.1 Selecting all events</title>
      <p>Once EHR data has been imported to the database, the <monospace>rEHR</monospace> package has a number of flexible built-in querying functions for extracting data. These functions are much faster to execute and less error prone than having to loop through hundreds of text files.</p>
      <p>The primary generic query function is <monospace>select_events()</monospace> and is able to select all the events in a database table matching a provided <monospace>where</monospace> argument. This function is also called by the other more specific query functions. An example set of lists of clinical codes for a number of medical conditions is provided with the package (<monospace>data(clinical_codes)</monospace>). <monospace>select_events()</monospace> returns a dataframe of extracted data. This collection of disease specific code lists stems from our previous work and are reposited in <ext-link ext-link-type="uri" xlink:href="http://www.clinicalcodes.org">www.clinicalcodes.org</ext-link> [<xref rid="pone.0171784.ref009" ref-type="bibr">9</xref>]. However, code lists are dynamic and context specific and researchers will very likely need to consider strategies to develop their own code lists, if existing code lists are considered inadequate [<xref rid="pone.0171784.ref019" ref-type="bibr">19</xref>].</p>
      <boxed-text id="pone.0171784.box006" position="anchor" orientation="portrait">
        <p specific-use="line">diabetes_codes &lt;- clinical_codes[clinical_codes$list == <inline-formula id="pone.0171784.e066"><alternatives><graphic xlink:href="pone.0171784.e066.jpg" id="pone.0171784.e066g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M66"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Diabetes</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,]</p>
        <p specific-use="line"><inline-formula id="pone.0171784.e067"><alternatives><graphic xlink:href="pone.0171784.e067.jpg" id="pone.0171784.e067g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M67"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>select</mml:mtext><mml:mo>_</mml:mo><mml:mtext>events</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db, <inline-formula id="pone.0171784.e068"><alternatives><graphic xlink:href="pone.0171784.e068.jpg" id="pone.0171784.e068g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M68"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>tab</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e069"><alternatives><graphic xlink:href="pone.0171784.e069.jpg" id="pone.0171784.e069g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M69"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e070"><alternatives><graphic xlink:href="pone.0171784.e070.jpg" id="pone.0171784.e070g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M70"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Clinical</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e071"><alternatives><graphic xlink:href="pone.0171784.e071.jpg" id="pone.0171784.e071g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M71"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>columns</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e072"><alternatives><graphic xlink:href="pone.0171784.e072.jpg" id="pone.0171784.e072g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M72"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e073"><alternatives><graphic xlink:href="pone.0171784.e073.jpg" id="pone.0171784.e073g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M73"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e074"><alternatives><graphic xlink:href="pone.0171784.e074.jpg" id="pone.0171784.e074g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M74"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>patid</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e075"><alternatives><graphic xlink:href="pone.0171784.e075.jpg" id="pone.0171784.e075g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M75"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
        <p specific-use="line">      <inline-formula id="pone.0171784.e076"><alternatives><graphic xlink:href="pone.0171784.e076.jpg" id="pone.0171784.e076g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M76"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>medcode</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">      <inline-formula id="pone.0171784.e077"><alternatives><graphic xlink:href="pone.0171784.e077.jpg" id="pone.0171784.e077g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M77"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>where</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e078"><alternatives><graphic xlink:href="pone.0171784.e078.jpg" id="pone.0171784.e078g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M78"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e079"><alternatives><graphic xlink:href="pone.0171784.e079.jpg" id="pone.0171784.e079g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M79"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>medcode </mml:mtext><mml:mo>%</mml:mo><mml:mtext>in</mml:mtext><mml:mo>%</mml:mo><mml:mo>.</mml:mo><mml:mo>(</mml:mo><mml:mtext>diabetes</mml:mtext><mml:mo>_</mml:mo><mml:mtext>codes</mml:mtext><mml:mo>$</mml:mo><mml:mtext>medcode</mml:mtext><mml:mo>)</mml:mo><mml:mtext> </mml:mtext><mml:mo>&amp;</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula></p>
        <p specific-use="line">              <inline-formula id="pone.0171784.e080"><alternatives><graphic xlink:href="pone.0171784.e080.jpg" id="pone.0171784.e080g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M80"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mtext>eventdate</mml:mtext><mml:mo>&lt;</mml:mo><mml:mo>'</mml:mo><mml:mn>2006</mml:mn><mml:mo>‐</mml:mo><mml:mn>01</mml:mn><mml:mo>‐</mml:mo><mml:mn>01</mml:mn><mml:mo>'</mml:mo><mml:mo>&amp;</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>&gt;</mml:mo><mml:mo>=</mml:mo><mml:mo>'</mml:mo><mml:mn>2005</mml:mn><mml:mo>‐</mml:mo><mml:mn>01</mml:mn><mml:mo>‐</mml:mo><mml:mn>01</mml:mn><mml:mo>'</mml:mo><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
      </boxed-text>
      <p specific-use="line">##  patid  eventdate medcode</p>
      <p specific-use="line">## 1 3012 2005-09-30    273</p>
      <p specific-use="line">## 2 1037 2005-04-08    277</p>
      <p specific-use="line">## 3 1038 2005-05-19    273</p>
      <p specific-use="line">## 4 1091 2005-05-27    351</p>
      <p specific-use="line">## 5 1091 2005-07-25    351</p>
      <p specific-use="line">## 6 1097 2005-03-10    273</p>
      <p>The <monospace>tab</monospace> argument is used to select the file type (Clinical, Consultation, Patient, Practice or Referral in the previous code example), while the <monospace>columns</monospace> argument selects variables from these files. The <monospace>where</monospace> argument is equivalent to the WHERE clause in SQL, in that it is used to select subsets of the data table. The user must supply a string representation of valid <monospace>R</monospace> code, which is then translated to SQL via the <monospace>dplyr::translate_sql_</monospace> function. There are two important caveats to this:</p>
      <list list-type="order">
        <list-item>
          <p>If an element of the clause represents an R object to be accessed (such as the elements of a vector) it must be wrapped in a <monospace>.()</monospace> (See the example above). String elements wrapped in <monospace>.()</monospace> are processed by the <monospace>expand_string</monospace> function before being passed to <monospace>dplyr::translate_sql_</monospace>.</p>
        </list-item>
        <list-item>
          <p>Dates should separately quoted and entered in ISO format (‘%Y-%m-%d’). This is because dates are stored as ISO text in the database, not as r Date types.</p>
        </list-item>
      </list>
      <p>If the argument <monospace>sql_only == TRUE</monospace>, the function only generates the SQL needed for the query, rather than running the query itself. In this way, <monospace>select_events</monospace> can be used as the base for more complex query functions. The results of this function can also then be passed to <monospace>temp_table()</monospace> to create temporary tables where it is not desirable to keep large query results in RAM. For example:</p>
      <boxed-text id="pone.0171784.box007" position="anchor" orientation="portrait">
        <p specific-use="line">Asthma_codes &lt;- clinical_codes[clinical_codes$list == <inline-formula id="pone.0171784.e081"><alternatives><graphic xlink:href="pone.0171784.e081.jpg" id="pone.0171784.e081g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M81"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Asthma</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,]</p>
        <p specific-use="line">q &lt;- <inline-formula id="pone.0171784.e082"><alternatives><graphic xlink:href="pone.0171784.e082.jpg" id="pone.0171784.e082g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M82"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>select</mml:mtext><mml:mo>_</mml:mo><mml:mtext>events</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db, <inline-formula id="pone.0171784.e083"><alternatives><graphic xlink:href="pone.0171784.e083.jpg" id="pone.0171784.e083g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M83"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>tab</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e084"><alternatives><graphic xlink:href="pone.0171784.e084.jpg" id="pone.0171784.e084g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M84"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e085"><alternatives><graphic xlink:href="pone.0171784.e085.jpg" id="pone.0171784.e085g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M85"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Clinical</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e086"><alternatives><graphic xlink:href="pone.0171784.e086.jpg" id="pone.0171784.e086g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M86"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>columns</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e087"><alternatives><graphic xlink:href="pone.0171784.e087.jpg" id="pone.0171784.e087g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M87"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e088"><alternatives><graphic xlink:href="pone.0171784.e088.jpg" id="pone.0171784.e088g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M88"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e089"><alternatives><graphic xlink:href="pone.0171784.e089.jpg" id="pone.0171784.e089g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M89"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>patid</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e090"><alternatives><graphic xlink:href="pone.0171784.e090.jpg" id="pone.0171784.e090g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M90"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula></p>
        <p specific-use="line">        , <inline-formula id="pone.0171784.e091"><alternatives><graphic xlink:href="pone.0171784.e091.jpg" id="pone.0171784.e091g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M91"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>medcode</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">      <inline-formula id="pone.0171784.e092"><alternatives><graphic xlink:href="pone.0171784.e092.jpg" id="pone.0171784.e092g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M92"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>where</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e093"><alternatives><graphic xlink:href="pone.0171784.e093.jpg" id="pone.0171784.e093g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M93"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e094"><alternatives><graphic xlink:href="pone.0171784.e094.jpg" id="pone.0171784.e094g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M94"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>medcode </mml:mtext><mml:mo>%</mml:mo><mml:mtext>in</mml:mtext><mml:mo>%</mml:mo><mml:mo>.</mml:mo><mml:mo>(</mml:mo><mml:mtext>Asthma</mml:mtext><mml:mo>_</mml:mo><mml:mtext>codes</mml:mtext><mml:mo>$</mml:mo><mml:mtext>medcode</mml:mtext><mml:mo>)</mml:mo><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
        <p specific-use="line">      <inline-formula id="pone.0171784.e095"><alternatives><graphic xlink:href="pone.0171784.e095.jpg" id="pone.0171784.e095g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M95"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>sql</mml:mtext><mml:mo>_</mml:mo><mml:mtext>only</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e096"><alternatives><graphic xlink:href="pone.0171784.e096.jpg" id="pone.0171784.e096g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M96"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e097"><alternatives><graphic xlink:href="pone.0171784.e097.jpg" id="pone.0171784.e097g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M97"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>TRUE</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        <p specific-use="line"><inline-formula id="pone.0171784.e098"><alternatives><graphic xlink:href="pone.0171784.e098.jpg" id="pone.0171784.e098g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M98"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>temp</mml:mtext><mml:mo>_</mml:mo><mml:mtext>table</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db, <inline-formula id="pone.0171784.e099"><alternatives><graphic xlink:href="pone.0171784.e099.jpg" id="pone.0171784.e099g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M99"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>tab</mml:mtext><mml:mo>_</mml:mo><mml:mtext>name</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e100"><alternatives><graphic xlink:href="pone.0171784.e100.jpg" id="pone.0171784.e100g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M100"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e101"><alternatives><graphic xlink:href="pone.0171784.e101.jpg" id="pone.0171784.e101g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M101"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Asthma</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e102"><alternatives><graphic xlink:href="pone.0171784.e102.jpg" id="pone.0171784.e102g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M102"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>select</mml:mtext><mml:mo>_</mml:mo><mml:mtext>query</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e103"><alternatives><graphic xlink:href="pone.0171784.e103.jpg" id="pone.0171784.e103g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M103"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> q)</p>
      </boxed-text>
      <p specific-use="line">## Temporary table 'Asthma' created</p>
      <boxed-text id="pone.0171784.box008" position="anchor" orientation="portrait">
        <p specific-use="line"><inline-formula id="pone.0171784.e104"><alternatives><graphic xlink:href="pone.0171784.e104.jpg" id="pone.0171784.e104g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M104"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>head</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db, <inline-formula id="pone.0171784.e105"><alternatives><graphic xlink:href="pone.0171784.e105.jpg" id="pone.0171784.e105g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M105"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>temp</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e106"><alternatives><graphic xlink:href="pone.0171784.e106.jpg" id="pone.0171784.e106g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M106"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e107"><alternatives><graphic xlink:href="pone.0171784.e107.jpg" id="pone.0171784.e107g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M107"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>TRUE</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
      </boxed-text>
      <p specific-use="line">##   type  name tbl_name</p>
      <p specific-use="line">## 1 table Asthma  Asthma</p>
      <boxed-text id="pone.0171784.box009" position="anchor" orientation="portrait">
        <p specific-use="line"><inline-formula id="pone.0171784.e108"><alternatives><graphic xlink:href="pone.0171784.e108.jpg" id="pone.0171784.e108g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M108"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>head</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db, <inline-formula id="pone.0171784.e109"><alternatives><graphic xlink:href="pone.0171784.e109.jpg" id="pone.0171784.e109g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M109"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>table</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e110"><alternatives><graphic xlink:href="pone.0171784.e110.jpg" id="pone.0171784.e110g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M110"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e111"><alternatives><graphic xlink:href="pone.0171784.e111.jpg" id="pone.0171784.e111g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M111"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Asthma</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
      </boxed-text>
      <p specific-use="line">##  patid  eventdate medcode</p>
      <p specific-use="line">## 1  1025 2014-04-11   1105</p>
      <p specific-use="line">## 2  1035 2012-03-05   1116</p>
      <p specific-use="line">## 3  2065 2006-03-20   1095</p>
      <sec id="sec005">
        <title>3.1.1 Using raw SQL queries</title>
        <p>Since EHR data is stored as a standard SQLite database, users can alternatively make SQL queries to the database using <monospace>sqldf</monospace>, which is imported into the namespace on loading of the <monospace>rEHR</monospace> package:</p>
        <boxed-text id="pone.0171784.box010" position="anchor" orientation="portrait">
          <p specific-use="line"><inline-formula id="pone.0171784.e112"><alternatives><graphic xlink:href="pone.0171784.e112.jpg" id="pone.0171784.e112g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M112"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>sqldf</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e113"><alternatives><graphic xlink:href="pone.0171784.e113.jpg" id="pone.0171784.e113g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M113"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>SELECT patid</mml:mtext><mml:mo>,</mml:mo><mml:mtext> practid</mml:mtext><mml:mo>,</mml:mo><mml:mtext> gender</mml:mtext><mml:mo>,</mml:mo><mml:mtext> yob</mml:mtext><mml:mo>,</mml:mo><mml:mtext> deathdate from Patient WHERE</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula></p>
          <p specific-use="line">     <inline-formula id="pone.0171784.e114"><alternatives><graphic xlink:href="pone.0171784.e114.jpg" id="pone.0171784.e114g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M114"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mtext>deathdate IS NOT NULL LIMIT </mml:mtext><mml:mn>6</mml:mn><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">  <inline-formula id="pone.0171784.e115"><alternatives><graphic xlink:href="pone.0171784.e115.jpg" id="pone.0171784.e115g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M115"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>connection</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e116"><alternatives><graphic xlink:href="pone.0171784.e116.jpg" id="pone.0171784.e116g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M116"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> db)</p>
        </boxed-text>
        <p specific-use="line">##  patid practid gender  yob  deathdate</p>
        <p specific-use="line">## 1 1003    3   0 1983 2001-11-16</p>
        <p specific-use="line">## 2 3015    15   1 1995 2000-05-09</p>
        <p specific-use="line">## 3 2016    16   1 1959 2002-10-28</p>
        <p specific-use="line">## 4 1018    18   0 1992 2009-12-29</p>
        <p specific-use="line">## 5 2020    20   1 1956 2002-11-29</p>
        <p specific-use="line">## 6 1023    23   0 1983 2013-03-24</p>
        <p>There are two methods for including <monospace>R</monospace> objects in raw SQL strings. First, wrapping the string in a call to <monospace>expand_string()</monospace> allows for the <monospace>.()</monospace> notation to be used as in <monospace>where</monospace> arguments to <monospace>select_events()</monospace> based functions. Alternatively, a helper function, <monospace>wrap_sql_query()</monospace> is provided that functions in a similar way to <monospace>base::sprintf</monospace> but formats objects according to SQL syntax. If the result of evaluating the argument is a vector of length 1, it is inserted as is; if it is a vector of length &gt; 1, it is wrapped in parentheses and comma separated.</p>
        <boxed-text id="pone.0171784.box011" position="anchor" orientation="portrait">
          <p specific-use="line">medcodes1 &lt;- <inline-formula id="pone.0171784.e117"><alternatives><graphic xlink:href="pone.0171784.e117.jpg" id="pone.0171784.e117g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M117"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle><mml:mo>:</mml:mo><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>5</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula></p>
          <p specific-use="line">practice &lt;- <inline-formula id="pone.0171784.e118"><alternatives><graphic xlink:href="pone.0171784.e118.jpg" id="pone.0171784.e118g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M118"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>255</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula></p>
          <p specific-use="line"><inline-formula id="pone.0171784.e119"><alternatives><graphic xlink:href="pone.0171784.e119.jpg" id="pone.0171784.e119g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M119"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>expand</mml:mtext><mml:mo>_</mml:mo><mml:mtext>string</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e120"><alternatives><graphic xlink:href="pone.0171784.e120.jpg" id="pone.0171784.e120g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M120"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>SELECT </mml:mtext><mml:mo>*</mml:mo><mml:mtext>FROM clinical WHERE practid</mml:mtext><mml:mo>=</mml:mo><mml:mo>=</mml:mo><mml:mo>.</mml:mo><mml:mo>(</mml:mo><mml:mtext>practice</mml:mtext><mml:mo>)</mml:mo><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        </boxed-text>
        <p specific-use="line">## [1] "SELECT * FROM clinical WHERE practid == 255"</p>
        <boxed-text id="pone.0171784.box012" position="anchor" orientation="portrait">
          <p specific-use="line"><inline-formula id="pone.0171784.e121"><alternatives><graphic xlink:href="pone.0171784.e121.jpg" id="pone.0171784.e121g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M121"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>wrap</mml:mtext><mml:mo>_</mml:mo><mml:mtext>sql</mml:mtext><mml:mo>_</mml:mo><mml:mtext>query</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e122"><alternatives><graphic xlink:href="pone.0171784.e122.jpg" id="pone.0171784.e122g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M122"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>SELECT </mml:mtext><mml:mo>*</mml:mo><mml:mtext>FROM clinical WHERE practid</mml:mtext><mml:mo>=</mml:mo><mml:mo>=</mml:mo><mml:mo>#</mml:mo><mml:mn>1</mml:mn><mml:mtext> AND medcodes</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula></p>
          <p specific-use="line">        <inline-formula id="pone.0171784.e123"><alternatives><graphic xlink:href="pone.0171784.e123.jpg" id="pone.0171784.e123g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M123"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mtext>in </mml:mtext><mml:mo>#</mml:mo><mml:mn>2</mml:mn><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, practice, medcodes1)</p>
        </boxed-text>
        <p specific-use="line">## [1] "SELECT * FROM clinical WHERE practid == 255 AND medcodes in</p>
        <p specific-use="line">(1, 2, 3, 4, 5)"</p>
      </sec>
    </sec>
    <sec id="sec006">
      <title>3.2 Selecting first or last events</title>
      <p>Frequently, users need to find the first clinical event for a given patient (e.g. to identify dates of diagnosis of chronic diseases) or the most recent clinical event (e.g. to identify if a drug therapy has been prescribed within a certain time period). <monospace>rEHR</monospace> provides convenience functions for these common situations. The functions run a <monospace>select_events()</monospace> query and then group by patient id and selects only the earliest/latest event for each patient:</p>
      <boxed-text id="pone.0171784.box013" position="anchor" orientation="portrait">
        <p specific-use="line">first_DM &lt;- <inline-formula id="pone.0171784.e124"><alternatives><graphic xlink:href="pone.0171784.e124.jpg" id="pone.0171784.e124g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M124"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>first</mml:mtext><mml:mo>_</mml:mo><mml:mtext>events</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db, <inline-formula id="pone.0171784.e125"><alternatives><graphic xlink:href="pone.0171784.e125.jpg" id="pone.0171784.e125g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M125"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>tab</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e126"><alternatives><graphic xlink:href="pone.0171784.e126.jpg" id="pone.0171784.e126g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M126"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e127"><alternatives><graphic xlink:href="pone.0171784.e127.jpg" id="pone.0171784.e127g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M127"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Clinical</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
        <p specific-use="line">             <inline-formula id="pone.0171784.e128"><alternatives><graphic xlink:href="pone.0171784.e128.jpg" id="pone.0171784.e128g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M128"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>columns</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e129"><alternatives><graphic xlink:href="pone.0171784.e129.jpg" id="pone.0171784.e129g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M129"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e130"><alternatives><graphic xlink:href="pone.0171784.e130.jpg" id="pone.0171784.e130g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M130"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e131"><alternatives><graphic xlink:href="pone.0171784.e131.jpg" id="pone.0171784.e131g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M131"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>patid</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e132"><alternatives><graphic xlink:href="pone.0171784.e132.jpg" id="pone.0171784.e132g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M132"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e133"><alternatives><graphic xlink:href="pone.0171784.e133.jpg" id="pone.0171784.e133g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M133"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>medcode</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">       <inline-formula id="pone.0171784.e134"><alternatives><graphic xlink:href="pone.0171784.e134.jpg" id="pone.0171784.e134g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M134"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>where</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e135"><alternatives><graphic xlink:href="pone.0171784.e135.jpg" id="pone.0171784.e135g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M135"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e136"><alternatives><graphic xlink:href="pone.0171784.e136.jpg" id="pone.0171784.e136g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M136"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>medcode </mml:mtext><mml:mo>%</mml:mo><mml:mtext>in</mml:mtext><mml:mo>%</mml:mo><mml:mo>.</mml:mo><mml:mo>(</mml:mo><mml:mtext>diabetes</mml:mtext><mml:mo>_</mml:mo><mml:mtext>codes</mml:mtext><mml:mo>$</mml:mo><mml:mtext>medcode</mml:mtext><mml:mo>)</mml:mo><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        <p specific-use="line">last_DM &lt;- <inline-formula id="pone.0171784.e137"><alternatives><graphic xlink:href="pone.0171784.e137.jpg" id="pone.0171784.e137g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M137"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>last</mml:mtext><mml:mo>_</mml:mo><mml:mtext>events</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db, <inline-formula id="pone.0171784.e138"><alternatives><graphic xlink:href="pone.0171784.e138.jpg" id="pone.0171784.e138g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M138"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>tab</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e139"><alternatives><graphic xlink:href="pone.0171784.e139.jpg" id="pone.0171784.e139g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M139"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e140"><alternatives><graphic xlink:href="pone.0171784.e140.jpg" id="pone.0171784.e140g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M140"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Clinical</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
        <p specific-use="line">            <inline-formula id="pone.0171784.e141"><alternatives><graphic xlink:href="pone.0171784.e141.jpg" id="pone.0171784.e141g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M141"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>columns</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e142"><alternatives><graphic xlink:href="pone.0171784.e142.jpg" id="pone.0171784.e142g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M142"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e143"><alternatives><graphic xlink:href="pone.0171784.e143.jpg" id="pone.0171784.e143g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M143"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e144"><alternatives><graphic xlink:href="pone.0171784.e144.jpg" id="pone.0171784.e144g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M144"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>patid</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e145"><alternatives><graphic xlink:href="pone.0171784.e145.jpg" id="pone.0171784.e145g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M145"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e146"><alternatives><graphic xlink:href="pone.0171784.e146.jpg" id="pone.0171784.e146g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M146"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>medcode</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">       <inline-formula id="pone.0171784.e147"><alternatives><graphic xlink:href="pone.0171784.e147.jpg" id="pone.0171784.e147g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M147"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>where</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e148"><alternatives><graphic xlink:href="pone.0171784.e148.jpg" id="pone.0171784.e148g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M148"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e149"><alternatives><graphic xlink:href="pone.0171784.e149.jpg" id="pone.0171784.e149g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M149"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>medcode </mml:mtext><mml:mo>%</mml:mo><mml:mtext>in</mml:mtext><mml:mo>%</mml:mo><mml:mo>.</mml:mo><mml:mo>(</mml:mo><mml:mtext>diabetes</mml:mtext><mml:mo>_</mml:mo><mml:mtext>codes</mml:mtext><mml:mo>$</mml:mo><mml:mtext>medcode</mml:mtext><mml:mo>)</mml:mo><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        <p specific-use="line"><inline-formula id="pone.0171784.e150"><alternatives><graphic xlink:href="pone.0171784.e150.jpg" id="pone.0171784.e150g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M150"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>head</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(first_DM)</p>
      </boxed-text>
      <p specific-use="line">##  patid  eventdate medcode</p>
      <p specific-use="line">## 1  1004 2007-12-25    351</p>
      <p specific-use="line">## 2  1005 2004-08-31    351</p>
      <p specific-use="line">## 3  1008 2002-03-02    351</p>
      <p specific-use="line">## 4  1010 2014-04-11    351</p>
      <p specific-use="line">## 5  1012 2012-05-28    351</p>
      <p specific-use="line">## 6  1015 2008-08-16    351</p>
      <boxed-text id="pone.0171784.box014" position="anchor" orientation="portrait">
        <p specific-use="line"><inline-formula id="pone.0171784.e151"><alternatives><graphic xlink:href="pone.0171784.e151.jpg" id="pone.0171784.e151g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M151"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>head</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(last_DM)</p>
      </boxed-text>
      <p specific-use="line">##  patid  eventdate medcode</p>
      <p specific-use="line">## 1  1004 2007-12-25    351</p>
      <p specific-use="line">## 2  1005 2009-03-09    351</p>
      <p specific-use="line">## 3  1008 2002-03-02    351</p>
      <p specific-use="line">## 4  1010 2014-04-11    351</p>
      <p specific-use="line">## 5  1012 2013-02-14    351</p>
      <p specific-use="line">## 6  1015 2013-08-17    273</p>
    </sec>
    <sec id="sec007">
      <title>3.3 Querying longitudinal data with <monospace>select_by_year()</monospace></title>
      <p>Researchers will often want to extract data over a range of different time-points, for example they may want to calculate the prevalence of a condition and how this changes through time. When working with flat text files, this must be done with a complex nested loop that is both slow and error-prone. The <monospace>select_by_year()</monospace> function provides a simple interface to extract longitudinal data. On posix-compliant computers (Linux, BSD, Mac), this function can make use of parallel processes to select data for different years concurrently, greatly accelerating the extraction process on multicore machines. The function runs a series of selects over a year range and collects in a list of dataframes.</p>
      <p>The function applies a database select over a range of years and outputs as a list or a dataframe. Either a database object or a path to a database file can be supplied. If multiple cores are being used (i.e. cores &gt; 1), a path to a database file must be used because the same database connection cannot be used across threads. In this case, a new database connection is made with every fork. Note that when working with temporary tables, <monospace>cores</monospace> must be set to 1 and the open database connection must be set with <monospace>db</monospace>. This is because the use of <monospace>parallel::mclapply</monospace> means that new database connections need to be started for each fork and temporary files are only available inside the same connection.</p>
      <p>Queries can be made against multiple tables, assuming that the columns being extracted are present in all tables. The <monospace>columns</monospace> argument is a character vector of column names to be selected. The individual elements can be of arbitrary length. This means it is possible to insert SQL clauses e.g. “DISTINCT patid”.</p>
      <p>A numeric vector of years is passed to the <monospace>year_range</monospace> argument to specify the years to select data for. Selection is done according to the function passed to the <monospace>selector_fn</monospace> argument. <monospace>select_events</monospace> is the default but <monospace>first_events</monospace> and <monospace>last_events</monospace> can also be used, as well as custom selection functions. The <monospace>where</monospace> argument works in the same way as in <monospace>select_events</monospace> except that year-start and year-end criteria can be added as ‘STARTDATE’ and ‘ENDDATE’. These are translated to the correct year- start and end dates. Different start and end dates can be specified by supplying a function to the <monospace>year_fn</monospace> argument. This function must accept a single year argument and return a list with two elements—“startdate” and “enddate”, each of which must be date characters in posix format (i.e. “%Y-%m-%d”). Three functions are provided to define years (<monospace>standard_years</monospace> for 1st January to 31st December, <monospace>qof_years</monospace> for UK financial years as used in the UK Quality and Outcomes Framework [<xref rid="pone.0171784.ref020" ref-type="bibr">20</xref>], and <monospace>qof_15_months</monospace> for the period starting 1st January in the year in question and finishing on the 31st March the following year) and a convenience function, <monospace>build_date_fn()</monospace> is provided to which users can supply lists of year offsets, months and days for year- start and end to return a function that can be supplied as the <monospace>year_fn</monospace> argument. Finally the user can set the <monospace>as_list</monospace> argument to determine whether data from each year is returned as a separate list element or as a single data frame.</p>
      <sec id="sec008">
        <title>3.3.1 Selecting prevalent and incident events</title>
        <p>To show the utility of the package we demonstrate how one might extract an incident and prevalent cohort of diabetes patients from the simulated example data. Prevalent events for a chronic condition are selected by the earliest diagnostic event prior to the end of the time period in question. The denominator for the calculation of the prevalence is the total number of patients registered at that time point.</p>
        <boxed-text id="pone.0171784.box015" position="anchor" orientation="portrait">
          <p specific-use="line">
            <inline-formula id="pone.0171784.e152">
              <alternatives>
                <graphic xlink:href="pone.0171784.e152.jpg" id="pone.0171784.e152g" mimetype="image" position="anchor" orientation="portrait"/>
                <mml:math id="M152">
                  <mml:mstyle mathcolor="#8F5903" mathvariant="monospace">
                    <mml:mo>#</mml:mo>
                    <mml:mtext mathvariant="italic"> Select all patients with current registration date </mml:mtext>
                    <mml:mo>(</mml:mo>
                    <mml:mtext mathvariant="italic">crd</mml:mtext>
                    <mml:mo>)</mml:mo>
                    <mml:mo>&lt;</mml:mo>
                    <mml:mtext mathvariant="italic">the start</mml:mtext>
                  </mml:mstyle>
                </mml:math>
              </alternatives>
            </inline-formula>
          </p>
          <p specific-use="line">
            <inline-formula id="pone.0171784.e153">
              <alternatives>
                <graphic xlink:href="pone.0171784.e153.jpg" id="pone.0171784.e153g" mimetype="image" position="anchor" orientation="portrait"/>
                <mml:math id="M153">
                  <mml:mstyle mathcolor="#8F5903" mathvariant="monospace">
                    <mml:mo>#</mml:mo>
                    <mml:mtext mathvariant="italic"> date for each year</mml:mtext>
                    <mml:mo>.</mml:mo>
                  </mml:mstyle>
                </mml:math>
              </alternatives>
            </inline-formula>
          </p>
          <p specific-use="line">registered_patients &lt;- <inline-formula id="pone.0171784.e154"><alternatives><graphic xlink:href="pone.0171784.e154.jpg" id="pone.0171784.e154g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M154"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>select</mml:mtext><mml:mo>_</mml:mo><mml:mtext>by</mml:mtext><mml:mo>_</mml:mo><mml:mtext>year</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e155"><alternatives><graphic xlink:href="pone.0171784.e155.jpg" id="pone.0171784.e155g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M155"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>db</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e156"><alternatives><graphic xlink:href="pone.0171784.e156.jpg" id="pone.0171784.e156g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M156"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> db,</p>
          <p specific-use="line">           <inline-formula id="pone.0171784.e157"><alternatives><graphic xlink:href="pone.0171784.e157.jpg" id="pone.0171784.e157g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M157"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>tables</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e158"><alternatives><graphic xlink:href="pone.0171784.e158.jpg" id="pone.0171784.e158g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M158"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e159"><alternatives><graphic xlink:href="pone.0171784.e159.jpg" id="pone.0171784.e159g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M159"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>patient</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">           <inline-formula id="pone.0171784.e160"><alternatives><graphic xlink:href="pone.0171784.e160.jpg" id="pone.0171784.e160g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M160"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>columns</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e161"><alternatives><graphic xlink:href="pone.0171784.e161.jpg" id="pone.0171784.e161g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M161"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e162"><alternatives><graphic xlink:href="pone.0171784.e162.jpg" id="pone.0171784.e162g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M162"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e163"><alternatives><graphic xlink:href="pone.0171784.e163.jpg" id="pone.0171784.e163g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M163"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>patid</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e164"><alternatives><graphic xlink:href="pone.0171784.e164.jpg" id="pone.0171784.e164g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M164"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>practid</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e165"><alternatives><graphic xlink:href="pone.0171784.e165.jpg" id="pone.0171784.e165g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M165"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>gender</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">                    <inline-formula id="pone.0171784.e166"><alternatives><graphic xlink:href="pone.0171784.e166.jpg" id="pone.0171784.e166g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M166"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>yob</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e167"><alternatives><graphic xlink:href="pone.0171784.e167.jpg" id="pone.0171784.e167g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M167"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>crd</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e168"><alternatives><graphic xlink:href="pone.0171784.e168.jpg" id="pone.0171784.e168g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M168"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>tod</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e169"><alternatives><graphic xlink:href="pone.0171784.e169.jpg" id="pone.0171784.e169g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M169"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>deathdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">           <inline-formula id="pone.0171784.e170"><alternatives><graphic xlink:href="pone.0171784.e170.jpg" id="pone.0171784.e170g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M170"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>where</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e171"><alternatives><graphic xlink:href="pone.0171784.e171.jpg" id="pone.0171784.e171g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M171"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e172"><alternatives><graphic xlink:href="pone.0171784.e172.jpg" id="pone.0171784.e172g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M172"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>crd</mml:mtext><mml:mo>&lt;</mml:mo><mml:mtext>STARTDATE</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">           <inline-formula id="pone.0171784.e173"><alternatives><graphic xlink:href="pone.0171784.e173.jpg" id="pone.0171784.e173g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M173"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>year</mml:mtext><mml:mo>_</mml:mo><mml:mtext>range</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e174"><alternatives><graphic xlink:href="pone.0171784.e174.jpg" id="pone.0171784.e174g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M174"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e175"><alternatives><graphic xlink:href="pone.0171784.e175.jpg" id="pone.0171784.e175g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M175"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e176"><alternatives><graphic xlink:href="pone.0171784.e176.jpg" id="pone.0171784.e176g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M176"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>2008</mml:mn></mml:mstyle><mml:mo>:</mml:mo><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>2012</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">           <inline-formula id="pone.0171784.e177"><alternatives><graphic xlink:href="pone.0171784.e177.jpg" id="pone.0171784.e177g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M177"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>year</mml:mtext><mml:mo>_</mml:mo><mml:mtext>fn</mml:mtext><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> standard_years)</p>
        </boxed-text>
        <p specific-use="line">## Using open database connection</p>
        <boxed-text id="pone.0171784.box016" position="anchor" orientation="portrait">
          <p specific-use="line"><inline-formula id="pone.0171784.e178"><alternatives><graphic xlink:href="pone.0171784.e178.jpg" id="pone.0171784.e178g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M178"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>str</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(registered_patients)</p>
        </boxed-text>
        <p specific-use="line">## Classes 'tbl_df', 'tbl' and 'data.frame': 1005 obs. of 8 variables:</p>
        <p specific-use="line">## $ patid    : int  1001 1002 2002 3002 4002 1003 2003 1004 2004 …</p>
        <p specific-use="line">## $ practid   : int  1 2 2 2 2 3 3 4 4 4 …</p>
        <p specific-use="line">## $ gender   : int  1 1 1 1 0 0 1 0 1 1 …</p>
        <p specific-use="line">## $ yob   : num 1989 1942 1965 1959 1932 …</p>
        <p specific-use="line">## $ crd   : chr   "1998-03-22" "2003-07-10" "1997-10-15" …</p>
        <p specific-use="line">## $ tod   : chr  NA NA NA NA …</p>
        <p specific-use="line">## $ deathdate : chr  NA NA NA NA …</p>
        <p specific-use="line">## $ year    : int  2008 2008 2008 2008 2008 2008 2008 2008 2008 …</p>
        <boxed-text id="pone.0171784.box017" position="anchor" orientation="portrait">
          <p specific-use="line"><inline-formula id="pone.0171784.e179"><alternatives><graphic xlink:href="pone.0171784.e179.jpg" id="pone.0171784.e179g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M179"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>table</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(registered_patients$year)</p>
        </boxed-text>
        <p specific-use="line">##</p>
        <p specific-use="line">## 2008 2009 2010 2011 2012</p>
        <p specific-use="line">##  189  195  201  206   214</p>
        <p>Notice that <monospace>select_by_year</monospace> returns a dataframe in long form, with a year column for the longitudinal component. Next we collect the incident cases, which are those patients with first diagnoses at any point before the end of the year in question, plus the dates for the first diagnoses. In this case we include events matching our list of diabetes clinical codes in either clinical or referral files. Because we only want the first diagnosis dates we set the <monospace>selector_fn</monospace> argument to <monospace>first_events</monospace>:</p>
        <boxed-text id="pone.0171784.box018" position="anchor" orientation="portrait">
          <p specific-use="line">incident_cases &lt;- <inline-formula id="pone.0171784.e180"><alternatives><graphic xlink:href="pone.0171784.e180.jpg" id="pone.0171784.e180g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M180"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>select</mml:mtext><mml:mo>_</mml:mo><mml:mtext>by</mml:mtext><mml:mo>_</mml:mo><mml:mtext>year</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e181"><alternatives><graphic xlink:href="pone.0171784.e181.jpg" id="pone.0171784.e181g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M181"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>db</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e182"><alternatives><graphic xlink:href="pone.0171784.e182.jpg" id="pone.0171784.e182g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M182"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> db,</p>
          <p specific-use="line">                <inline-formula id="pone.0171784.e183"><alternatives><graphic xlink:href="pone.0171784.e183.jpg" id="pone.0171784.e183g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M183"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>tables</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e184"><alternatives><graphic xlink:href="pone.0171784.e184.jpg" id="pone.0171784.e184g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M184"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e185"><alternatives><graphic xlink:href="pone.0171784.e185.jpg" id="pone.0171784.e185g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M185"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e186"><alternatives><graphic xlink:href="pone.0171784.e186.jpg" id="pone.0171784.e186g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M186"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Clinical</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e187"><alternatives><graphic xlink:href="pone.0171784.e187.jpg" id="pone.0171784.e187g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M187"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Referral</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">                <inline-formula id="pone.0171784.e188"><alternatives><graphic xlink:href="pone.0171784.e188.jpg" id="pone.0171784.e188g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M188"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>columns</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e189"><alternatives><graphic xlink:href="pone.0171784.e189.jpg" id="pone.0171784.e189g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M189"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e190"><alternatives><graphic xlink:href="pone.0171784.e190.jpg" id="pone.0171784.e190g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M190"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e191"><alternatives><graphic xlink:href="pone.0171784.e191.jpg" id="pone.0171784.e191g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M191"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>patid</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e192"><alternatives><graphic xlink:href="pone.0171784.e192.jpg" id="pone.0171784.e192g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M192"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">                     <inline-formula id="pone.0171784.e193"><alternatives><graphic xlink:href="pone.0171784.e193.jpg" id="pone.0171784.e193g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M193"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>medcode</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">                <inline-formula id="pone.0171784.e194"><alternatives><graphic xlink:href="pone.0171784.e194.jpg" id="pone.0171784.e194g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M194"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>where</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e195"><alternatives><graphic xlink:href="pone.0171784.e195.jpg" id="pone.0171784.e195g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M195"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e196"><alternatives><graphic xlink:href="pone.0171784.e196.jpg" id="pone.0171784.e196g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M196"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>medcode </mml:mtext><mml:mo>%</mml:mo><mml:mtext>in</mml:mtext><mml:mo>%</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula></p>
          <p specific-use="line">                    <inline-formula id="pone.0171784.e197"><alternatives><graphic xlink:href="pone.0171784.e197.jpg" id="pone.0171784.e197g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M197"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>.</mml:mo><mml:mo>(</mml:mo><mml:mtext>diabetes</mml:mtext><mml:mo>_</mml:mo><mml:mtext>codes</mml:mtext><mml:mo>$</mml:mo><mml:mtext>medcode</mml:mtext><mml:mo>)</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula></p>
          <p specific-use="line">                    <inline-formula id="pone.0171784.e198"><alternatives><graphic xlink:href="pone.0171784.e198.jpg" id="pone.0171784.e198g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M198"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>&amp;</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>&lt;</mml:mo><mml:mo>=</mml:mo><mml:mtext>ENDDATE</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">                <inline-formula id="pone.0171784.e199"><alternatives><graphic xlink:href="pone.0171784.e199.jpg" id="pone.0171784.e199g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M199"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>year</mml:mtext><mml:mo>_</mml:mo><mml:mtext>range</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e200"><alternatives><graphic xlink:href="pone.0171784.e200.jpg" id="pone.0171784.e200g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M200"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e201"><alternatives><graphic xlink:href="pone.0171784.e201.jpg" id="pone.0171784.e201g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M201"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e202"><alternatives><graphic xlink:href="pone.0171784.e202.jpg" id="pone.0171784.e202g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M202"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>2008</mml:mn></mml:mstyle><mml:mo>:</mml:mo><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>2012</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">                <inline-formula id="pone.0171784.e203"><alternatives><graphic xlink:href="pone.0171784.e203.jpg" id="pone.0171784.e203g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M203"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>year</mml:mtext><mml:mo>_</mml:mo><mml:mtext>fn</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e204"><alternatives><graphic xlink:href="pone.0171784.e204.jpg" id="pone.0171784.e204g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M204"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> standard_years,</p>
          <p specific-use="line">                <inline-formula id="pone.0171784.e205"><alternatives><graphic xlink:href="pone.0171784.e205.jpg" id="pone.0171784.e205g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M205"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>selector</mml:mtext><mml:mo>_</mml:mo><mml:mtext>fn</mml:mtext><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> first_events)</p>
        </boxed-text>
        <p specific-use="line">## Using open database connection</p>
        <boxed-text id="pone.0171784.box019" position="anchor" orientation="portrait">
          <p specific-use="line"><inline-formula id="pone.0171784.e206"><alternatives><graphic xlink:href="pone.0171784.e206.jpg" id="pone.0171784.e206g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M206"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>str</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(incident_cases)</p>
        </boxed-text>
        <p specific-use="line">## Classes 'tbl_df', 'tbl' and 'data.frame': 262 obs. of 5 variables:</p>
        <p specific-use="line">## $ patid   : int 1004 1005 1008 1015 1025 1035 1037 1038 1043 …</p>
        <p specific-use="line">## $ eventdate : chr "2007-12-25" "2004-08-31" "2002-03-02" …</p>
        <p specific-use="line">## $ medcode  : int 351 351 351 351 351 293 277 273 351 257 …</p>
        <p specific-use="line">## $ table  : chr "Clinical" "Clinical" "Clinical" "Clinical" …</p>
        <p specific-use="line">## $ year   : int 2008 2008 2008 2008 2008 2008 2008 2008 2008 …</p>
        <p>Note that in this case extra columns have been added for both year and table, to identify the table the event was found in. Because events were taken from more than one table (Clinical and Referrals), the incident_cases dataframe should be sorted and duplicates removed to ensure that only the first events are kept. The two datasets are then merged to give the dataset from which the denominators and numerators can be calculated. The <monospace>dplyr</monospace> package is imported to the namespace when the <monospace>rEHR</monospace> package is loaded. This simplifies and accelerates merging operations, using <monospace>left_join</monospace> from the <monospace>dplyr</monospace> package in the example below, and is an important part of the <monospace>rEHR</monospace> workflow:</p>
        <boxed-text id="pone.0171784.box020" position="anchor" orientation="portrait">
          <p specific-use="line">## All patients are kept (equivalent to merge(all.x = TRUE))</p>
          <p specific-use="line">prevalence_dat &lt;- <inline-formula id="pone.0171784.e207"><alternatives><graphic xlink:href="pone.0171784.e207.jpg" id="pone.0171784.e207g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M207"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>left</mml:mtext><mml:mo>_</mml:mo><mml:mtext>join</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(registered_patients, incident_cases)</p>
          <p specific-use="line">## Remove duplicates across clinical and referral tables:</p>
          <p specific-use="line">incident_cases %&gt;%</p>
          <p specific-use="line">  <inline-formula id="pone.0171784.e208"><alternatives><graphic xlink:href="pone.0171784.e208.jpg" id="pone.0171784.e208g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M208"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>group</mml:mtext><mml:mo>_</mml:mo><mml:mtext>by</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(patid, year) %&gt;%</p>
          <p specific-use="line">  <inline-formula id="pone.0171784.e209"><alternatives><graphic xlink:href="pone.0171784.e209.jpg" id="pone.0171784.e209g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M209"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>arrange</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(eventdate) %&gt;%</p>
          <p specific-use="line">  <inline-formula id="pone.0171784.e210"><alternatives><graphic xlink:href="pone.0171784.e210.jpg" id="pone.0171784.e210g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M210"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>distinct</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>() %&gt;%</p>
          <p specific-use="line">  ungroup -&gt; incident_cases</p>
        </boxed-text>
        <p>Prevalence and incidence can be calculated by the built-in functions <monospace>prev_terms()</monospace> and <monospace>prev_totals()</monospace>. <monospace>prev_terms()</monospace> adds logical columns for membership of incidence and prevalence denominators as well as a column for the contribution of the individual to that year’s followup time. <monospace>prev_totals()</monospace> summarises this information to calculate the denominators and numerators for prevalence and incidence, according to the users’ grouping factors. The criteria for membership of the incidence and prevalence numerators and denominators as well as for followup time are shown in <xref rid="pone.0171784.t001" ref-type="table">Table 1</xref>, where event date is the date the event of interest occurs, transfer out date is the date the patient (may have) exited the practice or the database, and year start date is either 1st of Jan (calendar) or 1st of April (financial).</p>
        <table-wrap id="pone.0171784.t001" orientation="portrait" position="float">
          <object-id pub-id-type="doi">10.1371/journal.pone.0171784.t001</object-id>
          <label>Table 1</label>
          <caption>
            <title>Definitions of incidence and prevalence terms.</title>
          </caption>
          <alternatives>
            <graphic id="pone.0171784.t001g" xlink:href="pone.0171784.t001"/>
            <table frame="box" rules="all" border="0">
              <colgroup span="1">
                <col align="left" valign="middle" span="1"/>
                <col align="left" valign="middle" span="1"/>
              </colgroup>
              <thead>
                <tr>
                  <th align="left" rowspan="1" colspan="1">Term</th>
                  <th align="left" rowspan="1" colspan="1">Definition</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td align="left" rowspan="1" colspan="1">Incident Numerator</td>
                  <td align="left" rowspan="1" colspan="1">event occurs within year AND transfer out date &gt; event date</td>
                </tr>
                <tr>
                  <td align="left" rowspan="1" colspan="1">Incident Denominator</td>
                  <td align="left" rowspan="1" colspan="1">No events in previous years AND transfer out date &gt; year start date</td>
                </tr>
                <tr>
                  <td align="left" rowspan="1" colspan="1">Prevalent Numerator</td>
                  <td align="left" rowspan="1" colspan="1">event occurs within year AND transfer out date &gt; event date</td>
                </tr>
                <tr>
                  <td align="left" rowspan="1" colspan="1">Prevalent Denominator</td>
                  <td align="left" rowspan="1" colspan="1">transfer out date &gt; year start date</td>
                </tr>
                <tr>
                  <td align="left" rowspan="1" colspan="1">Follow-up</td>
                  <td align="left" rowspan="1" colspan="1">minimum of (year end date, transfer out date, death date)—year start date</td>
                </tr>
              </tbody>
            </table>
          </alternatives>
        </table-wrap>
        <p>An example in the use of these functions is provided below:</p>
        <boxed-text id="pone.0171784.box021" position="anchor" orientation="portrait">
          <p specific-use="line">prevalence_dat &lt;- <inline-formula id="pone.0171784.e211"><alternatives><graphic xlink:href="pone.0171784.e211.jpg" id="pone.0171784.e211g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M211"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>prev</mml:mtext><mml:mo>_</mml:mo><mml:mtext>terms</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(prevalence_dat)</p>
          <p specific-use="line">totals &lt;- <inline-formula id="pone.0171784.e212"><alternatives><graphic xlink:href="pone.0171784.e212.jpg" id="pone.0171784.e212g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M212"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>prev</mml:mtext><mml:mo>_</mml:mo><mml:mtext>totals</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(prevalence_dat)</p>
          <p specific-use="line">totals$prevalence$year_counts</p>
        </boxed-text>
        <p specific-use="line">## Source: local data frame [5 x 4]</p>
        <p specific-use="line">##</p>
        <p specific-use="line">##   year numerator denominator prevalence</p>
        <p specific-use="line">## 1 2008     31   174.6721  17.74754</p>
        <p specific-use="line">## 2 2009     35   179.3785  19.51181</p>
        <p specific-use="line">## 3 2010     41   183.1403  22.38721</p>
        <p specific-use="line">## 4 2011     50   185.4182  26.96607</p>
        <p specific-use="line">## 5 2012     55   191.5838  28.70806</p>
        <boxed-text id="pone.0171784.box022" position="anchor" orientation="portrait">
          <p specific-use="line">totals$incidence$year_counts</p>
        </boxed-text>
        <p specific-use="line">## Source: local data frame [5 x 4]</p>
        <p specific-use="line">##</p>
        <p specific-use="line">##   year numerator denominator incidence</p>
        <p specific-use="line">## 1 2008      4   143.9014  2.779680</p>
        <p specific-use="line">## 2 2009      3   144.4983  2.076149</p>
        <p specific-use="line">## 3 2010      4   142.2806  2.811345</p>
        <p specific-use="line">## 4 2011      7   135.5893  5.162648</p>
        <p specific-use="line">## 5 2012      5   137.4675  3.637224</p>
        <p>Here we see that, in our simulated dataset, we have a diabetes prevalence of 17.7% in 2008 raising to 28.7% in 2012 and an incidence of 2.8% in 2008 increasing to 3.6% in 2012.</p>
      </sec>
    </sec>
  </sec>
  <sec id="sec009">
    <title>4 Building cohorts, matching and time-varying covariates</title>
    <p>In this section we demonstrate how to convert the longitudinal data from the previous section to a cohort dataset suitable for survival analysis and also illustrate algorithms to match controls to cases and to cut cohort data by time-varying covariates.</p>
    <p>One of the most common uses of EHR data in research is to build cohorts for survival analyses. The longitudinal data in the previous section is easily converted to survival cohort format using the <monospace>build_cohort()</monospace> function. This returns a dataset with a single row for each patient and includes only patients in the numerator or denominator for whichever cohort type is chosen (either incident or prevalent cohorts). Columns are added for start and end dates and for start and end times as integer differences from the cohort start date. A binary column is added to indicate membership of the case group. All patients with start dates greater than their end dates are removed from the dataset. The diagnosis_start argument is used to include the diagnosis date in the definition of the start dates for the patients. If it is not required for the diagnosis date to be included in the start date definition, this argument can be set to <monospace>NULL</monospace>. Here, we will first merge in practice data (i.e. dates for when practices are deemed to be up to standard) and then construct the cohort:</p>
    <boxed-text id="pone.0171784.box023" position="anchor" orientation="portrait">
      <p specific-use="line">practices &lt;- <inline-formula id="pone.0171784.e213"><alternatives><graphic xlink:href="pone.0171784.e213.jpg" id="pone.0171784.e213g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M213"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>select_events</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e214"><alternatives><graphic xlink:href="pone.0171784.e214.jpg" id="pone.0171784.e214g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M214"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>db</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e215"><alternatives><graphic xlink:href="pone.0171784.e215.jpg" id="pone.0171784.e215g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M215"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> db, <inline-formula id="pone.0171784.e216"><alternatives><graphic xlink:href="pone.0171784.e216.jpg" id="pone.0171784.e216g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M216"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>tab</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e217"><alternatives><graphic xlink:href="pone.0171784.e217.jpg" id="pone.0171784.e217g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M217"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e218"><alternatives><graphic xlink:href="pone.0171784.e218.jpg" id="pone.0171784.e218g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M218"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Practice</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e219"><alternatives><graphic xlink:href="pone.0171784.e219.jpg" id="pone.0171784.e219g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M219"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>convert</mml:mtext><mml:mo>_</mml:mo><mml:mtext>dates</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e220"><alternatives><graphic xlink:href="pone.0171784.e220.jpg" id="pone.0171784.e220g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M220"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e221"><alternatives><graphic xlink:href="pone.0171784.e221.jpg" id="pone.0171784.e221g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M221"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>TRUE</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
      <p specific-use="line">prevalence_dat &lt;- <inline-formula id="pone.0171784.e222"><alternatives><graphic xlink:href="pone.0171784.e222.jpg" id="pone.0171784.e222g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M222"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>left</mml:mtext><mml:mo>_</mml:mo><mml:mtext>join</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(prevalence_dat, practices)</p>
      <p specific-use="line">cohort &lt;- <inline-formula id="pone.0171784.e223"><alternatives><graphic xlink:href="pone.0171784.e223.jpg" id="pone.0171784.e223g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M223"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>build</mml:mtext><mml:mo>_</mml:mo><mml:mtext>cohort</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(prevalence_dat, <inline-formula id="pone.0171784.e224"><alternatives><graphic xlink:href="pone.0171784.e224.jpg" id="pone.0171784.e224g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M224"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cohort</mml:mtext><mml:mo>_</mml:mo><mml:mtext>type</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e225"><alternatives><graphic xlink:href="pone.0171784.e225.jpg" id="pone.0171784.e225g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M225"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e226"><alternatives><graphic xlink:href="pone.0171784.e226.jpg" id="pone.0171784.e226g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M226"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>prev</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
      <p specific-use="line">            <inline-formula id="pone.0171784.e227"><alternatives><graphic xlink:href="pone.0171784.e227.jpg" id="pone.0171784.e227g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M227"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cohort</mml:mtext><mml:mo>_</mml:mo><mml:mtext>start</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e228"><alternatives><graphic xlink:href="pone.0171784.e228.jpg" id="pone.0171784.e228g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M228"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e229"><alternatives><graphic xlink:href="pone.0171784.e229.jpg" id="pone.0171784.e229g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M229"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mn>2006</mml:mn><mml:mo>‐</mml:mo><mml:mn>01</mml:mn><mml:mo>‐</mml:mo><mml:mn>01</mml:mn><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e230"><alternatives><graphic xlink:href="pone.0171784.e230.jpg" id="pone.0171784.e230g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M230"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cohort</mml:mtext><mml:mo>_</mml:mo><mml:mtext>end</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e231"><alternatives><graphic xlink:href="pone.0171784.e231.jpg" id="pone.0171784.e231g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M231"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e232"><alternatives><graphic xlink:href="pone.0171784.e232.jpg" id="pone.0171784.e232g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M232"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mn>2012</mml:mn><mml:mo>‐</mml:mo><mml:mn>12</mml:mn><mml:mo>‐</mml:mo><mml:mn>31</mml:mn><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula></p>
      <p specific-use="line">            , <inline-formula id="pone.0171784.e233"><alternatives><graphic xlink:href="pone.0171784.e233.jpg" id="pone.0171784.e233g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M233"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>diagnosis</mml:mtext><mml:mo>_</mml:mo><mml:mtext>start</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e234"><alternatives><graphic xlink:href="pone.0171784.e234.jpg" id="pone.0171784.e234g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M234"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e235"><alternatives><graphic xlink:href="pone.0171784.e235.jpg" id="pone.0171784.e235g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M235"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
    </boxed-text>
    <p>The cohort is now ready for analysis, e.g. with a relatively simple proportional hazards regression model that only includes gender and exposure as predictors:</p>
    <boxed-text id="pone.0171784.box024" position="anchor" orientation="portrait">
      <p specific-use="line">## Add a logical column for death during cohort</p>
      <p specific-use="line">cohort$death &lt;- <inline-formula id="pone.0171784.e236"><alternatives><graphic xlink:href="pone.0171784.e236.jpg" id="pone.0171784.e236g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M236"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>with</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort,</p>
      <p specific-use="line">         <inline-formula id="pone.0171784.e237"><alternatives><graphic xlink:href="pone.0171784.e237.jpg" id="pone.0171784.e237g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M237"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>ifelse</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(!<inline-formula id="pone.0171784.e238"><alternatives><graphic xlink:href="pone.0171784.e238.jpg" id="pone.0171784.e238g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M238"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>is</mml:mtext><mml:mo>.</mml:mo><mml:mtext>null</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(deathdate) &amp;</p>
      <p specific-use="line">              (deathdate &gt; <inline-formula id="pone.0171784.e239"><alternatives><graphic xlink:href="pone.0171784.e239.jpg" id="pone.0171784.e239g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M239"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>as</mml:mtext><mml:mo>.</mml:mo><mml:mtext>Date</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e240"><alternatives><graphic xlink:href="pone.0171784.e240.jpg" id="pone.0171784.e240g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M240"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mn>2006</mml:mn><mml:mo>‐</mml:mo><mml:mn>01</mml:mn><mml:mo>‐</mml:mo><mml:mn>01</mml:mn><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>) &amp;</p>
      <p specific-use="line">                deathdate &lt; <inline-formula id="pone.0171784.e241"><alternatives><graphic xlink:href="pone.0171784.e241.jpg" id="pone.0171784.e241g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M241"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>as</mml:mtext><mml:mo>.</mml:mo><mml:mtext>Date</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e242"><alternatives><graphic xlink:href="pone.0171784.e242.jpg" id="pone.0171784.e242g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M242"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mn>2012</mml:mn><mml:mo>‐</mml:mo><mml:mn>12</mml:mn><mml:mo>‐</mml:mo><mml:mn>31</mml:mn><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)),</p>
      <p specific-use="line">             <inline-formula id="pone.0171784.e243"><alternatives><graphic xlink:href="pone.0171784.e243.jpg" id="pone.0171784.e243g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M243"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e244"><alternatives><graphic xlink:href="pone.0171784.e244.jpg" id="pone.0171784.e244g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M244"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>0</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>))</p>
      <p specific-use="line">cohort$death[<inline-formula id="pone.0171784.e245"><alternatives><graphic xlink:href="pone.0171784.e245.jpg" id="pone.0171784.e245g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M245"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>is</mml:mtext><mml:mo>.</mml:mo><mml:mtext>na</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort$death)] &lt;- <inline-formula id="pone.0171784.e246"><alternatives><graphic xlink:href="pone.0171784.e246.jpg" id="pone.0171784.e246g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M246"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>0</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula></p>
      <p specific-use="line"><inline-formula id="pone.0171784.e247"><alternatives><graphic xlink:href="pone.0171784.e247.jpg" id="pone.0171784.e247g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M247"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>library</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(survival)</p>
      <p specific-use="line">surv_obj &lt;- <inline-formula id="pone.0171784.e248"><alternatives><graphic xlink:href="pone.0171784.e248.jpg" id="pone.0171784.e248g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M248"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>with</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort, <inline-formula id="pone.0171784.e249"><alternatives><graphic xlink:href="pone.0171784.e249.jpg" id="pone.0171784.e249g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M249"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>Surv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(start, end, death))</p>
      <p specific-use="line"><inline-formula id="pone.0171784.e250"><alternatives><graphic xlink:href="pone.0171784.e250.jpg" id="pone.0171784.e250g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M250"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>coxph</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(surv_obj ~ gender + case, <inline-formula id="pone.0171784.e251"><alternatives><graphic xlink:href="pone.0171784.e251.jpg" id="pone.0171784.e251g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M251"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>data</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e252"><alternatives><graphic xlink:href="pone.0171784.e252.jpg" id="pone.0171784.e252g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M252"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> cohort)</p>
    </boxed-text>
    <p specific-use="line">## Call:</p>
    <p specific-use="line">## coxph(formula = surv_obj ~ gender + case, data = cohort)</p>
    <p specific-use="line">##</p>
    <p specific-use="line">##</p>
    <p specific-use="line">##      coef exp(coef) se(coef)   z   p</p>
    <p specific-use="line">## gender 0.506   1.659  0.837   0.605 0.55</p>
    <p specific-use="line">## case  -0.645   0.524  1.081 -0.597 0.55</p>
    <p specific-use="line">##</p>
    <p specific-use="line">## Likelihood ratio test = 0.81 on 2 df, p = 0.667 n = 199,</p>
    <p specific-use="line">## number of events = 7</p>
    <sec id="sec010">
      <title>4.1 Matching</title>
      <p>Matching cases to controls is an important pre-analysis step. The <monospace>rEHR</monospace> package provides three methods for matching cases to controls:</p>
      <list list-type="order">
        <list-item>
          <p>Incidence density matching (IDM)</p>
        </list-item>
        <list-item>
          <p>Exact matching</p>
        </list-item>
        <list-item>
          <p>Matching on a dummy index date sourced from consultation files</p>
        </list-item>
      </list>
      <sec id="sec011">
        <title>4.1.1 Incidence density matching</title>
        <p>This is performed using the <monospace>get_matches()</monospace> function. With IDM, controls are selected for a particular case at the time of diagnosis (or other event such as death) from other members of the cohort who, at that time, do not have the diagnosis. The IDM sampling procedure allows the same patient to be selected as a control for more than one case, thus providing a full set controls for each case while still producing unbiased estimates of risk [<xref rid="pone.0171784.ref007" ref-type="bibr">7</xref>; <xref rid="pone.0171784.ref021" ref-type="bibr">21</xref>]. This also means that the matching procedure can be parallelised to increase computational efficiency.</p>
        <boxed-text id="pone.0171784.box025" position="anchor" orientation="portrait">
          <p specific-use="line">cohort2 &lt;- <inline-formula id="pone.0171784.e253"><alternatives><graphic xlink:href="pone.0171784.e253.jpg" id="pone.0171784.e253g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M253"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>build</mml:mtext><mml:mo>_</mml:mo><mml:mtext>cohort</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(prevalence_dat, <inline-formula id="pone.0171784.e254"><alternatives><graphic xlink:href="pone.0171784.e254.jpg" id="pone.0171784.e254g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M254"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cohort</mml:mtext><mml:mo>_</mml:mo><mml:mtext>type</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e255"><alternatives><graphic xlink:href="pone.0171784.e255.jpg" id="pone.0171784.e255g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M255"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e256"><alternatives><graphic xlink:href="pone.0171784.e256.jpg" id="pone.0171784.e256g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M256"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>incid</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">            <inline-formula id="pone.0171784.e257"><alternatives><graphic xlink:href="pone.0171784.e257.jpg" id="pone.0171784.e257g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M257"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cohort</mml:mtext><mml:mo>_</mml:mo><mml:mtext>start</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e258"><alternatives><graphic xlink:href="pone.0171784.e258.jpg" id="pone.0171784.e258g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M258"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e259"><alternatives><graphic xlink:href="pone.0171784.e259.jpg" id="pone.0171784.e259g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M259"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mn>2006</mml:mn><mml:mo>‐</mml:mo><mml:mn>01</mml:mn><mml:mo>‐</mml:mo><mml:mn>01</mml:mn><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">            <inline-formula id="pone.0171784.e260"><alternatives><graphic xlink:href="pone.0171784.e260.jpg" id="pone.0171784.e260g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M260"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cohort</mml:mtext><mml:mo>_</mml:mo><mml:mtext>end</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e261"><alternatives><graphic xlink:href="pone.0171784.e261.jpg" id="pone.0171784.e261g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M261"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e262"><alternatives><graphic xlink:href="pone.0171784.e262.jpg" id="pone.0171784.e262g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M262"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mn>2012</mml:mn><mml:mo>‐</mml:mo><mml:mn>12</mml:mn><mml:mo>‐</mml:mo><mml:mn>31</mml:mn><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">            <inline-formula id="pone.0171784.e263"><alternatives><graphic xlink:href="pone.0171784.e263.jpg" id="pone.0171784.e263g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M263"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>diagnosis</mml:mtext><mml:mo>_</mml:mo><mml:mtext>start</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e264"><alternatives><graphic xlink:href="pone.0171784.e264.jpg" id="pone.0171784.e264g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M264"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e265"><alternatives><graphic xlink:href="pone.0171784.e265.jpg" id="pone.0171784.e265g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M265"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
          <p specific-use="line">IDM_controls &lt;- <inline-formula id="pone.0171784.e266"><alternatives><graphic xlink:href="pone.0171784.e266.jpg" id="pone.0171784.e266g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M266"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>get</mml:mtext><mml:mo>_</mml:mo><mml:mtext>matches</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e267"><alternatives><graphic xlink:href="pone.0171784.e267.jpg" id="pone.0171784.e267g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M267"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cases</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e268"><alternatives><graphic xlink:href="pone.0171784.e268.jpg" id="pone.0171784.e268g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M268"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e269"><alternatives><graphic xlink:href="pone.0171784.e269.jpg" id="pone.0171784.e269g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M269"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>filter</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort2, case == <inline-formula id="pone.0171784.e270"><alternatives><graphic xlink:href="pone.0171784.e270.jpg" id="pone.0171784.e270g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M270"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e271"><alternatives><graphic xlink:href="pone.0171784.e271.jpg" id="pone.0171784.e271g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M271"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>control_pool</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e272"><alternatives><graphic xlink:href="pone.0171784.e272.jpg" id="pone.0171784.e272g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M272"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e273"><alternatives><graphic xlink:href="pone.0171784.e273.jpg" id="pone.0171784.e273g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M273"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>filter</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort2, case == <inline-formula id="pone.0171784.e274"><alternatives><graphic xlink:href="pone.0171784.e274.jpg" id="pone.0171784.e274g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M274"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>0</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e275"><alternatives><graphic xlink:href="pone.0171784.e275.jpg" id="pone.0171784.e275g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M275"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>match</mml:mtext><mml:mo>_</mml:mo><mml:mtext>vars</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e276"><alternatives><graphic xlink:href="pone.0171784.e276.jpg" id="pone.0171784.e276g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M276"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e277"><alternatives><graphic xlink:href="pone.0171784.e277.jpg" id="pone.0171784.e277g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M277"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e278"><alternatives><graphic xlink:href="pone.0171784.e278.jpg" id="pone.0171784.e278g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M278"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>gender</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e279"><alternatives><graphic xlink:href="pone.0171784.e279.jpg" id="pone.0171784.e279g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M279"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>region</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e280"><alternatives><graphic xlink:href="pone.0171784.e280.jpg" id="pone.0171784.e280g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M280"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>n</mml:mtext><mml:mo>_</mml:mo><mml:mtext>controls</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e281"><alternatives><graphic xlink:href="pone.0171784.e281.jpg" id="pone.0171784.e281g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M281"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e282"><alternatives><graphic xlink:href="pone.0171784.e282.jpg" id="pone.0171784.e282g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M282"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>4</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e283"><alternatives><graphic xlink:href="pone.0171784.e283.jpg" id="pone.0171784.e283g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M283"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cores</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e284"><alternatives><graphic xlink:href="pone.0171784.e284.jpg" id="pone.0171784.e284g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M284"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e285"><alternatives><graphic xlink:href="pone.0171784.e285.jpg" id="pone.0171784.e285g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M285"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e286"><alternatives><graphic xlink:href="pone.0171784.e286.jpg" id="pone.0171784.e286g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M286"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>method</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e287"><alternatives><graphic xlink:href="pone.0171784.e287.jpg" id="pone.0171784.e287g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M287"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e288"><alternatives><graphic xlink:href="pone.0171784.e288.jpg" id="pone.0171784.e288g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M288"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>incidence</mml:mtext><mml:mo>_</mml:mo><mml:mtext>density</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e289"><alternatives><graphic xlink:href="pone.0171784.e289.jpg" id="pone.0171784.e289g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M289"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>diagnosis</mml:mtext><mml:mo>_</mml:mo><mml:mtext>date</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e290"><alternatives><graphic xlink:href="pone.0171784.e290.jpg" id="pone.0171784.e290g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M290"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e291"><alternatives><graphic xlink:href="pone.0171784.e291.jpg" id="pone.0171784.e291g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M291"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        </boxed-text>
        <p>In this example matching scenario, 92 controls were matched to 23 cases, which is 4 controls matched to each case.</p>
        <p>In all of the matching algorithms, matching is performed by default on categories selected in the <monospace>match_vars</monospace> argument. However, more complex matching strategies can also be employed via the <monospace>extra_conditions</monospace> argument. You can wrap calls to expressions in dotted brackets to automatically expand them. This is particularly useful when you want to find the value for each individual case. Each case is denoted by <monospace>CASE</monospace>, e.g. <monospace>"start_date &lt;.(CASE$start_date)"</monospace> will ensure the start date for controls is prior to the start date for the matched case. The following code also selects controls whose birth year (<monospace>yob</monospace>) is within 2 years either side of their matched case:</p>
        <boxed-text id="pone.0171784.box026" position="anchor" orientation="portrait">
          <p specific-use="line">IDM_controls2 &lt;- <inline-formula id="pone.0171784.e292"><alternatives><graphic xlink:href="pone.0171784.e292.jpg" id="pone.0171784.e292g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M292"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>get</mml:mtext><mml:mo>_</mml:mo><mml:mtext>matches</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e293"><alternatives><graphic xlink:href="pone.0171784.e293.jpg" id="pone.0171784.e293g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M293"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cases</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e294"><alternatives><graphic xlink:href="pone.0171784.e294.jpg" id="pone.0171784.e294g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M294"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e295"><alternatives><graphic xlink:href="pone.0171784.e295.jpg" id="pone.0171784.e295g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M295"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>filter</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort2, case == <inline-formula id="pone.0171784.e296"><alternatives><graphic xlink:href="pone.0171784.e296.jpg" id="pone.0171784.e296g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M296"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">              <inline-formula id="pone.0171784.e297"><alternatives><graphic xlink:href="pone.0171784.e297.jpg" id="pone.0171784.e297g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M297"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>control</mml:mtext><mml:mo>_</mml:mo><mml:mtext>pool</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e298"><alternatives><graphic xlink:href="pone.0171784.e298.jpg" id="pone.0171784.e298g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M298"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e299"><alternatives><graphic xlink:href="pone.0171784.e299.jpg" id="pone.0171784.e299g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M299"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>filter</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort2, case == <inline-formula id="pone.0171784.e300"><alternatives><graphic xlink:href="pone.0171784.e300.jpg" id="pone.0171784.e300g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M300"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>0</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">              <inline-formula id="pone.0171784.e301"><alternatives><graphic xlink:href="pone.0171784.e301.jpg" id="pone.0171784.e301g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M301"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>match</mml:mtext><mml:mo>_</mml:mo><mml:mtext>vars</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e302"><alternatives><graphic xlink:href="pone.0171784.e302.jpg" id="pone.0171784.e302g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M302"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e303"><alternatives><graphic xlink:href="pone.0171784.e303.jpg" id="pone.0171784.e303g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M303"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e304"><alternatives><graphic xlink:href="pone.0171784.e304.jpg" id="pone.0171784.e304g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M304"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>gender</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e305"><alternatives><graphic xlink:href="pone.0171784.e305.jpg" id="pone.0171784.e305g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M305"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>region</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">              <inline-formula id="pone.0171784.e306"><alternatives><graphic xlink:href="pone.0171784.e306.jpg" id="pone.0171784.e306g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M306"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>extra</mml:mtext><mml:mo>_</mml:mo><mml:mtext>conditions</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e307"><alternatives><graphic xlink:href="pone.0171784.e307.jpg" id="pone.0171784.e307g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M307"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e308"><alternatives><graphic xlink:href="pone.0171784.e308.jpg" id="pone.0171784.e308g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M308"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>yob</mml:mtext><mml:mo>&gt;</mml:mo><mml:mo>=</mml:mo><mml:mo>(</mml:mo><mml:mo>.</mml:mo><mml:mo>(</mml:mo><mml:mtext>CASE</mml:mtext><mml:mo>$</mml:mo><mml:mtext>yob</mml:mtext><mml:mo>)</mml:mo><mml:mo>-</mml:mo><mml:mn>2</mml:mn><mml:mo>)</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula></p>
          <p specific-use="line">              <inline-formula id="pone.0171784.e309"><alternatives><graphic xlink:href="pone.0171784.e309.jpg" id="pone.0171784.e309g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M309"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>&amp;</mml:mo><mml:mtext>yob</mml:mtext><mml:mo>&lt;</mml:mo><mml:mo>=</mml:mo><mml:mo>(</mml:mo><mml:mo>.</mml:mo><mml:mo>(</mml:mo><mml:mtext>CASE</mml:mtext><mml:mo>$</mml:mo><mml:mtext>yob</mml:mtext><mml:mo>)</mml:mo><mml:mo>+</mml:mo><mml:mn>2</mml:mn><mml:mo>)</mml:mo><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">              <inline-formula id="pone.0171784.e310"><alternatives><graphic xlink:href="pone.0171784.e310.jpg" id="pone.0171784.e310g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M310"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>n</mml:mtext><mml:mo>_</mml:mo><mml:mtext>controls</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e311"><alternatives><graphic xlink:href="pone.0171784.e311.jpg" id="pone.0171784.e311g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M311"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e312"><alternatives><graphic xlink:href="pone.0171784.e312.jpg" id="pone.0171784.e312g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M312"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>4</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e313"><alternatives><graphic xlink:href="pone.0171784.e313.jpg" id="pone.0171784.e313g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M313"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cores</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e314"><alternatives><graphic xlink:href="pone.0171784.e314.jpg" id="pone.0171784.e314g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M314"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e315"><alternatives><graphic xlink:href="pone.0171784.e315.jpg" id="pone.0171784.e315g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M315"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">              <inline-formula id="pone.0171784.e316"><alternatives><graphic xlink:href="pone.0171784.e316.jpg" id="pone.0171784.e316g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M316"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>method</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e317"><alternatives><graphic xlink:href="pone.0171784.e317.jpg" id="pone.0171784.e317g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M317"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e318"><alternatives><graphic xlink:href="pone.0171784.e318.jpg" id="pone.0171784.e318g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M318"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>incidence</mml:mtext><mml:mo>_</mml:mo><mml:mtext>density</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">              <inline-formula id="pone.0171784.e319"><alternatives><graphic xlink:href="pone.0171784.e319.jpg" id="pone.0171784.e319g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M319"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>diagnosis</mml:mtext><mml:mo>_</mml:mo><mml:mtext>date</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e320"><alternatives><graphic xlink:href="pone.0171784.e320.jpg" id="pone.0171784.e320g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M320"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e321"><alternatives><graphic xlink:href="pone.0171784.e321.jpg" id="pone.0171784.e321g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M321"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        </boxed-text>
      </sec>
      <sec id="sec012">
        <title>4.1.2 Exact matching</title>
        <p>Exact matching only matches controls from the control pool, unlike in IDM matching. Also, matched controls are removed from the control pool after each case has been matched, so each control can be used a maximum of one time. Therefore it is possible to have fewer matched controls for some cases than are requested via the <monospace>n_controls</monospace> argument. Because the control pool is being altered for every case, exact matching is not thread safe and so will only run on a single core. The <monospace>cores</monospace> and <monospace>diagnosis_date</monospace> arguments are ignored when this method is selected.</p>
        <boxed-text id="pone.0171784.box027" position="anchor" orientation="portrait">
          <p specific-use="line">exact_controls3 &lt;- <inline-formula id="pone.0171784.e322"><alternatives><graphic xlink:href="pone.0171784.e322.jpg" id="pone.0171784.e322g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M322"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>get</mml:mtext><mml:mo>_</mml:mo><mml:mtext>matches</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e323"><alternatives><graphic xlink:href="pone.0171784.e323.jpg" id="pone.0171784.e323g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M323"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cases</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e324"><alternatives><graphic xlink:href="pone.0171784.e324.jpg" id="pone.0171784.e324g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M324"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e325"><alternatives><graphic xlink:href="pone.0171784.e325.jpg" id="pone.0171784.e325g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M325"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>filter</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort2, case == <inline-formula id="pone.0171784.e326"><alternatives><graphic xlink:href="pone.0171784.e326.jpg" id="pone.0171784.e326g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M326"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">             <inline-formula id="pone.0171784.e327"><alternatives><graphic xlink:href="pone.0171784.e327.jpg" id="pone.0171784.e327g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M327"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>control</mml:mtext><mml:mo>_</mml:mo><mml:mtext>pool</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e328"><alternatives><graphic xlink:href="pone.0171784.e328.jpg" id="pone.0171784.e328g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M328"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e329"><alternatives><graphic xlink:href="pone.0171784.e329.jpg" id="pone.0171784.e329g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M329"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>filter</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort2, case == <inline-formula id="pone.0171784.e330"><alternatives><graphic xlink:href="pone.0171784.e330.jpg" id="pone.0171784.e330g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M330"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>0</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">             <inline-formula id="pone.0171784.e331"><alternatives><graphic xlink:href="pone.0171784.e331.jpg" id="pone.0171784.e331g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M331"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>match</mml:mtext><mml:mo>_</mml:mo><mml:mtext>vars</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e332"><alternatives><graphic xlink:href="pone.0171784.e332.jpg" id="pone.0171784.e332g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M332"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e333"><alternatives><graphic xlink:href="pone.0171784.e333.jpg" id="pone.0171784.e333g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M333"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e334"><alternatives><graphic xlink:href="pone.0171784.e334.jpg" id="pone.0171784.e334g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M334"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>gender</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e335"><alternatives><graphic xlink:href="pone.0171784.e335.jpg" id="pone.0171784.e335g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M335"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>region</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">             <inline-formula id="pone.0171784.e336"><alternatives><graphic xlink:href="pone.0171784.e336.jpg" id="pone.0171784.e336g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M336"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>n</mml:mtext><mml:mo>_</mml:mo><mml:mtext>controls</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e337"><alternatives><graphic xlink:href="pone.0171784.e337.jpg" id="pone.0171784.e337g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M337"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e338"><alternatives><graphic xlink:href="pone.0171784.e338.jpg" id="pone.0171784.e338g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M338"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>4</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, cores = <inline-formula id="pone.0171784.e339"><alternatives><graphic xlink:href="pone.0171784.e339.jpg" id="pone.0171784.e339g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M339"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">             <inline-formula id="pone.0171784.e340"><alternatives><graphic xlink:href="pone.0171784.e340.jpg" id="pone.0171784.e340g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M340"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>method</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e341"><alternatives><graphic xlink:href="pone.0171784.e341.jpg" id="pone.0171784.e341g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M341"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e342"><alternatives><graphic xlink:href="pone.0171784.e342.jpg" id="pone.0171784.e342g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M342"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>exact</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">             <inline-formula id="pone.0171784.e343"><alternatives><graphic xlink:href="pone.0171784.e343.jpg" id="pone.0171784.e343g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M343"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>diagnosis</mml:mtext><mml:mo>_</mml:mo><mml:mtext>date</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e344"><alternatives><graphic xlink:href="pone.0171784.e344.jpg" id="pone.0171784.e344g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M344"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e345"><alternatives><graphic xlink:href="pone.0171784.e345.jpg" id="pone.0171784.e345g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M345"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        </boxed-text>
        <p>In a small cohort, this can rapidly reduce the control pool, leading to many cases without matches. In this example, 19 out of 23 were matched with mean 3.6 controls matched to every case.</p>
      </sec>
      <sec id="sec013">
        <title>4.1.3 Matching on a dummy index date</title>
        <p>A common matching approach is to match on an index date, for example the diagnosis date of the cases or the date followup starts. There are several reasons to match on index date:</p>
        <list list-type="order">
          <list-item>
            <p>It ensures cases and controls are followed-up, on average, for the same amount of time. Not including an index date for controls may result in them being, on average, in the cohort for longer than the cases because their cohort start date is not constrained by the index date</p>
          </list-item>
          <list-item>
            <p>There is a possible reduction of detection bias, for example if cases are expected to visit their doctors more often because they have more co-morbidities</p>
          </list-item>
          <list-item>
            <p>If controls are known to have attended their practice at around the same time as their matched case, it is likely they will experience similar conditions in terms of practice policy and active GPs</p>
          </list-item>
          <list-item>
            <p>Patients who, though registered, have no records of contact with the medical system (“Ghost patients”) are excluded</p>
          </list-item>
        </list>
        <p>However, the controls will often not have the same index to match on (this is true by definition if the diagnosis date is used). In this situation, it is common to match on a dummy index date which may be a clinical event or interaction in the control’s electronic health record that occurs around the same time as the index date of the case [<xref rid="pone.0171784.ref022" ref-type="bibr">22</xref>; <xref rid="pone.0171784.ref023" ref-type="bibr">23</xref>]. The <monospace>match_on_index()</monospace> function allows for matching on an arbitrary number of categorical <monospace>match_var</monospace> variables and on continuous variables via the <monospace>extra_conditions</monospace> argument in the same way as the <monospace>get_matches()</monospace> function above. In addition, a supplied index date for each case is matched to event dates in a series of consultation files (1 file for each practice), providing a dummy index date for controls of a consultation date within <monospace>index_diff_limit</monospace> days of the matched case’s index date.</p>
        <p>Note that the consultation files must be in flat-file format, i.e. not as part of the database, but as text (or other filetype, e.g stata dta) files. This is the data format provided by CPRD (“Clinical Practice Research Datalink (CPRD) GOLD”). Although in most situations it is more efficient to process EHR data in SQL databases, as in the earlier functions described here, consultation tables are often very large and searching these for every case in a large cohort would be very slow. By processing consultation files that have been split by practice, it is possible to search for matches a practice at a time which is both efficient and allows for parallel processing to speed the process up still further. For convenience, a function <monospace>flat_files()</monospace> is provided that can export a database table to flat files split by practice in a format of their choosing. The <monospace>match_on_index()</monospace> function has an <monospace>import_fn</monospace> argument to use different file formats (e.g. <monospace>foreign::read.dta</monospace> or <monospace>readstata13::read.dta13</monospace> for Stata 12 or Stata 13 file).</p>
        <boxed-text id="pone.0171784.box028" position="anchor" orientation="portrait">
          <p specific-use="line">consultation_dir &lt;- <inline-formula id="pone.0171784.e346"><alternatives><graphic xlink:href="pone.0171784.e346.jpg" id="pone.0171784.e346g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M346"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mo>~</mml:mo><mml:mo>/</mml:mo><mml:mtext>R</mml:mtext><mml:mo>/</mml:mo><mml:mtext>rEHR</mml:mtext><mml:mo>_</mml:mo><mml:mtext>testing</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula></p>
          <p specific-use="line"><inline-formula id="pone.0171784.e347"><alternatives><graphic xlink:href="pone.0171784.e347.jpg" id="pone.0171784.e347g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M347"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>flat</mml:mtext><mml:mo>_</mml:mo><mml:mtext>files</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(db, <inline-formula id="pone.0171784.e348"><alternatives><graphic xlink:href="pone.0171784.e348.jpg" id="pone.0171784.e348g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M348"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>out</mml:mtext><mml:mo>_</mml:mo><mml:mtext>dir</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e349"><alternatives><graphic xlink:href="pone.0171784.e349.jpg" id="pone.0171784.e349g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M349"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> consultation_dir, <inline-formula id="pone.0171784.e350"><alternatives><graphic xlink:href="pone.0171784.e350.jpg" id="pone.0171784.e350g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M350"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>file</mml:mtext><mml:mo>_</mml:mo><mml:mtext>type</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e351"><alternatives><graphic xlink:href="pone.0171784.e351.jpg" id="pone.0171784.e351g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M351"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e352"><alternatives><graphic xlink:href="pone.0171784.e352.jpg" id="pone.0171784.e352g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M352"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>csv</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
          <p specific-use="line">index_controls &lt;- <inline-formula id="pone.0171784.e353"><alternatives><graphic xlink:href="pone.0171784.e353.jpg" id="pone.0171784.e353g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M353"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>match</mml:mtext><mml:mo>_</mml:mo><mml:mtext>on</mml:mtext><mml:mo>_</mml:mo><mml:mtext>index</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e354"><alternatives><graphic xlink:href="pone.0171784.e354.jpg" id="pone.0171784.e354g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M354"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cases</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e355"><alternatives><graphic xlink:href="pone.0171784.e355.jpg" id="pone.0171784.e355g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M355"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e356"><alternatives><graphic xlink:href="pone.0171784.e356.jpg" id="pone.0171784.e356g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M356"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>filter</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort2, case == <inline-formula id="pone.0171784.e357"><alternatives><graphic xlink:href="pone.0171784.e357.jpg" id="pone.0171784.e357g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M357"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e358"><alternatives><graphic xlink:href="pone.0171784.e358.jpg" id="pone.0171784.e358g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M358"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>control</mml:mtext><mml:mo>_</mml:mo><mml:mtext>pool</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e359"><alternatives><graphic xlink:href="pone.0171784.e359.jpg" id="pone.0171784.e359g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M359"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e360"><alternatives><graphic xlink:href="pone.0171784.e360.jpg" id="pone.0171784.e360g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M360"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>filter</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort2, case == <inline-formula id="pone.0171784.e361"><alternatives><graphic xlink:href="pone.0171784.e361.jpg" id="pone.0171784.e361g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M361"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>0</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e362"><alternatives><graphic xlink:href="pone.0171784.e362.jpg" id="pone.0171784.e362g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M362"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>index</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e363"><alternatives><graphic xlink:href="pone.0171784.e363.jpg" id="pone.0171784.e363g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M363"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e364"><alternatives><graphic xlink:href="pone.0171784.e364.jpg" id="pone.0171784.e364g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M364"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>eventdate</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e365"><alternatives><graphic xlink:href="pone.0171784.e365.jpg" id="pone.0171784.e365g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M365"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>match</mml:mtext><mml:mo>_</mml:mo><mml:mtext>vars</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e366"><alternatives><graphic xlink:href="pone.0171784.e366.jpg" id="pone.0171784.e366g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M366"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e367"><alternatives><graphic xlink:href="pone.0171784.e367.jpg" id="pone.0171784.e367g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M367"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e368"><alternatives><graphic xlink:href="pone.0171784.e368.jpg" id="pone.0171784.e368g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M368"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>gender</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e369"><alternatives><graphic xlink:href="pone.0171784.e369.jpg" id="pone.0171784.e369g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M369"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>region</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e370"><alternatives><graphic xlink:href="pone.0171784.e370.jpg" id="pone.0171784.e370g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M370"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>index</mml:mtext><mml:mo>_</mml:mo><mml:mtext>diff</mml:mtext><mml:mo>_</mml:mo><mml:mtext>limit</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e371"><alternatives><graphic xlink:href="pone.0171784.e371.jpg" id="pone.0171784.e371g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M371"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e372"><alternatives><graphic xlink:href="pone.0171784.e372.jpg" id="pone.0171784.e372g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M372"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>90</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e373"><alternatives><graphic xlink:href="pone.0171784.e373.jpg" id="pone.0171784.e373g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M373"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>consult</mml:mtext><mml:mo>_</mml:mo><mml:mtext>path</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e374"><alternatives><graphic xlink:href="pone.0171784.e374.jpg" id="pone.0171784.e374g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M374"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> consultation_dir,</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e375"><alternatives><graphic xlink:href="pone.0171784.e375.jpg" id="pone.0171784.e375g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M375"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>n</mml:mtext><mml:mo>_</mml:mo><mml:mtext>controls</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e376"><alternatives><graphic xlink:href="pone.0171784.e376.jpg" id="pone.0171784.e376g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M376"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e377"><alternatives><graphic xlink:href="pone.0171784.e377.jpg" id="pone.0171784.e377g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M377"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>4</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
          <p specific-use="line">               <inline-formula id="pone.0171784.e378"><alternatives><graphic xlink:href="pone.0171784.e378.jpg" id="pone.0171784.e378g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M378"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>import</mml:mtext><mml:mo>_</mml:mo><mml:mtext>fn</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e379"><alternatives><graphic xlink:href="pone.0171784.e379.jpg" id="pone.0171784.e379g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M379"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> function(x)</p>
          <p specific-use="line">                  <inline-formula id="pone.0171784.e380"><alternatives><graphic xlink:href="pone.0171784.e380.jpg" id="pone.0171784.e380g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M380"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>convert</mml:mtext><mml:mo>_</mml:mo><mml:mtext>dates</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e381"><alternatives><graphic xlink:href="pone.0171784.e381.jpg" id="pone.0171784.e381g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M381"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>read</mml:mtext><mml:mo>.</mml:mo><mml:mtext>csv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(x)))</p>
          <p specific-use="line">
            <inline-formula id="pone.0171784.e382">
              <alternatives>
                <graphic xlink:href="pone.0171784.e382.jpg" id="pone.0171784.e382g" mimetype="image" position="anchor" orientation="portrait"/>
                <mml:math id="M382">
                  <mml:mstyle mathcolor="#8F5903" mathvariant="monospace">
                    <mml:mo>#</mml:mo>
                    <mml:mtext mathvariant="italic"> clean up constructed dirs after analysis</mml:mtext>
                  </mml:mstyle>
                </mml:math>
              </alternatives>
            </inline-formula>
          </p>
          <p specific-use="line"><inline-formula id="pone.0171784.e383"><alternatives><graphic xlink:href="pone.0171784.e383.jpg" id="pone.0171784.e383g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M383"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>unlink</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(consultation_dir, <inline-formula id="pone.0171784.e384"><alternatives><graphic xlink:href="pone.0171784.e384.jpg" id="pone.0171784.e384g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M384"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>recursive</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e385"><alternatives><graphic xlink:href="pone.0171784.e385.jpg" id="pone.0171784.e385g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M385"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e386"><alternatives><graphic xlink:href="pone.0171784.e386.jpg" id="pone.0171784.e386g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M386"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>TRUE</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        </boxed-text>
        <p>This function performs matching that is still more conservative than the previous methods, since it requires matching of patients within the same practice and with consultation dates near the index date. In the test example above, no matched controls were found which is not surprising with a control pool of only 143. In practice this method is only appropriate where there is a control pool of hundreds of thousands or even millions of patients. If too few controls are found, the constraint can be relaxed by setting a higher <monospace>index_diff_limit</monospace>. Setting this to an arbitrarily high value effectively means that matching is not done on index date, but just on practice and the other user-specified matching variables. Users may find that this is a more efficient way to perform exact matching than using the <monospace>get_matches()</monospace> function. We have used this method to accelerate matching runs with several million controls that previously took days or weeks to minutes or a few hours.</p>
      </sec>
    </sec>
    <sec id="sec014">
      <title>4.2 Time-varying covariates</title>
      <p>Often, researchers want to cut a survival cohort by time-varying covariates. In this situation, individual patients may run over more than one row in the cohort dataset. For example, a drug exposure may occur after the entry into the cohort and one might be interested in how this might affect the outcome. In this situation, it is useful to have a pre-exposure and post-exposure time period in the dataset.</p>
      <p>The <monospace>cut_tv()</monospace> function cuts up a dataset based on times supplied for the time-varying covariate. If there is already a variable for the time-varying covariate, you can chose to flip the existing values or increment them. This means the function can be called multiple times to, e.g. deal with drugs starting and stopping and also to model the progression of treatment. Other packages implement similar functions (e.g. the <monospace>cutLexis</monospace> function from the <monospace>Epi</monospace> package [<xref rid="pone.0171784.ref024" ref-type="bibr">24</xref>]). The <monospace>cut_tv()</monospace> function is considerably faster than other cutting methods (particularly on large datasetss), does not require conversion of the dataset to other formats (such as <monospace>Lexis</monospace>), can be parallelised on posix compliant machines and is designed to be chained with <monospace>dplyr</monospace> workflows using the <monospace>%&gt;%</monospace> operator. <monospace>cut_tv()</monospace> can deal with the following scenarios:</p>
      <list list-type="bullet">
        <list-item>
          <p><bold>Binary chronic covariates</bold> e.g. The time of diagnosis for a chronic (unresolvable) condition. This requires a single column variable of times from entry in the dataset</p>
        </list-item>
        <list-item>
          <p><bold>Binary covariates</bold> e.g. times of starting and stopping medication. This requires more than one column variable in the dataset, one for each start or stop event. The state flips with each new change.</p>
        </list-item>
        <list-item>
          <p><bold>Incremental time-varying covariates</bold> e.g. different stages of a condition. This requires a single column variable for each incremental stage</p>
        </list-item>
        <list-item>
          <p><bold>Any combination of the above</bold> This is achieved by chaining multiple calls together</p>
        </list-item>
      </list>
      <p>One must supply a dataframe, variable names for entry and exit times, the time-varying covariate, the patient id and the constructed variable. Also one supplies the number of processor cores to run the function on and the behaviour of the function if the constructed variable already exists (either to flip from 1-0 or to increment by one). Here we demonstrate the different scenarios with a small sample dataset:</p>
      <boxed-text id="pone.0171784.box029" position="anchor" orientation="portrait">
        <p specific-use="line">tv_test &lt;- <inline-formula id="pone.0171784.e387"><alternatives><graphic xlink:href="pone.0171784.e387.jpg" id="pone.0171784.e387g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M387"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>data</mml:mtext><mml:mo>.</mml:mo><mml:mtext>frame</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e388"><alternatives><graphic xlink:href="pone.0171784.e388.jpg" id="pone.0171784.e388g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M388"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e389"><alternatives><graphic xlink:href="pone.0171784.e389.jpg" id="pone.0171784.e389g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M389"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e390"><alternatives><graphic xlink:href="pone.0171784.e390.jpg" id="pone.0171784.e390g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M390"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle><mml:mo>:</mml:mo><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>5</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e391"><alternatives><graphic xlink:href="pone.0171784.e391.jpg" id="pone.0171784.e391g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M391"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>start</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e392"><alternatives><graphic xlink:href="pone.0171784.e392.jpg" id="pone.0171784.e392g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M392"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e393"><alternatives><graphic xlink:href="pone.0171784.e393.jpg" id="pone.0171784.e393g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M393"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>rep</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e394"><alternatives><graphic xlink:href="pone.0171784.e394.jpg" id="pone.0171784.e394g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M394"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>0</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e395"><alternatives><graphic xlink:href="pone.0171784.e395.jpg" id="pone.0171784.e395g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M395"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>5</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e396"><alternatives><graphic xlink:href="pone.0171784.e396.jpg" id="pone.0171784.e396g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M396"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>end</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e397"><alternatives><graphic xlink:href="pone.0171784.e397.jpg" id="pone.0171784.e397g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M397"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e398"><alternatives><graphic xlink:href="pone.0171784.e398.jpg" id="pone.0171784.e398g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M398"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e399"><alternatives><graphic xlink:href="pone.0171784.e399.jpg" id="pone.0171784.e399g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M399"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1000</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e400"><alternatives><graphic xlink:href="pone.0171784.e400.jpg" id="pone.0171784.e400g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M400"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>689</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e401"><alternatives><graphic xlink:href="pone.0171784.e401.jpg" id="pone.0171784.e401g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M401"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1000</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e402"><alternatives><graphic xlink:href="pone.0171784.e402.jpg" id="pone.0171784.e402g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M402"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>874</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e403"><alternatives><graphic xlink:href="pone.0171784.e403.jpg" id="pone.0171784.e403g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M403"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>777</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e404"><alternatives><graphic xlink:href="pone.0171784.e404.jpg" id="pone.0171784.e404g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M404"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>event</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e405"><alternatives><graphic xlink:href="pone.0171784.e405.jpg" id="pone.0171784.e405g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M405"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e406"><alternatives><graphic xlink:href="pone.0171784.e406.jpg" id="pone.0171784.e406g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M406"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e407"><alternatives><graphic xlink:href="pone.0171784.e407.jpg" id="pone.0171784.e407g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M407"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>0</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e408"><alternatives><graphic xlink:href="pone.0171784.e408.jpg" id="pone.0171784.e408g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M408"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e409"><alternatives><graphic xlink:href="pone.0171784.e409.jpg" id="pone.0171784.e409g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M409"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>0</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e410"><alternatives><graphic xlink:href="pone.0171784.e410.jpg" id="pone.0171784.e410g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M410"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e411"><alternatives><graphic xlink:href="pone.0171784.e411.jpg" id="pone.0171784.e411g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M411"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e412"><alternatives><graphic xlink:href="pone.0171784.e412.jpg" id="pone.0171784.e412g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M412"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>drug</mml:mtext><mml:mo>_</mml:mo><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e413"><alternatives><graphic xlink:href="pone.0171784.e413.jpg" id="pone.0171784.e413g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M413"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e414"><alternatives><graphic xlink:href="pone.0171784.e414.jpg" id="pone.0171784.e414g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M414"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e415"><alternatives><graphic xlink:href="pone.0171784.e415.jpg" id="pone.0171784.e415g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M415"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e416"><alternatives><graphic xlink:href="pone.0171784.e416.jpg" id="pone.0171784.e416g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M416"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e417"><alternatives><graphic xlink:href="pone.0171784.e417.jpg" id="pone.0171784.e417g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M417"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e418"><alternatives><graphic xlink:href="pone.0171784.e418.jpg" id="pone.0171784.e418g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M418"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>340</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e419"><alternatives><graphic xlink:href="pone.0171784.e419.jpg" id="pone.0171784.e419g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M419"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>460</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e420"><alternatives><graphic xlink:href="pone.0171784.e420.jpg" id="pone.0171784.e420g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M420"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>drug</mml:mtext><mml:mo>_</mml:mo><mml:mn>2</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e421"><alternatives><graphic xlink:href="pone.0171784.e421.jpg" id="pone.0171784.e421g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M421"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e422"><alternatives><graphic xlink:href="pone.0171784.e422.jpg" id="pone.0171784.e422g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M422"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e423"><alternatives><graphic xlink:href="pone.0171784.e423.jpg" id="pone.0171784.e423g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M423"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e424"><alternatives><graphic xlink:href="pone.0171784.e424.jpg" id="pone.0171784.e424g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M424"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>234</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e425"><alternatives><graphic xlink:href="pone.0171784.e425.jpg" id="pone.0171784.e425g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M425"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>554</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e426"><alternatives><graphic xlink:href="pone.0171784.e426.jpg" id="pone.0171784.e426g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M426"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>123</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e427"><alternatives><graphic xlink:href="pone.0171784.e427.jpg" id="pone.0171784.e427g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M427"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e428"><alternatives><graphic xlink:href="pone.0171784.e428.jpg" id="pone.0171784.e428g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M428"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>drug</mml:mtext><mml:mo>_</mml:mo><mml:mn>3</mml:mn><mml:mo>_</mml:mo><mml:mtext>start</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e429"><alternatives><graphic xlink:href="pone.0171784.e429.jpg" id="pone.0171784.e429g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M429"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e430"><alternatives><graphic xlink:href="pone.0171784.e430.jpg" id="pone.0171784.e430g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M430"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e431"><alternatives><graphic xlink:href="pone.0171784.e431.jpg" id="pone.0171784.e431g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M431"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>110</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e432"><alternatives><graphic xlink:href="pone.0171784.e432.jpg" id="pone.0171784.e432g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M432"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>110</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e433"><alternatives><graphic xlink:href="pone.0171784.e433.jpg" id="pone.0171784.e433g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M433"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>111</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e434"><alternatives><graphic xlink:href="pone.0171784.e434.jpg" id="pone.0171784.e434g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M434"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>109</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e435"><alternatives><graphic xlink:href="pone.0171784.e435.jpg" id="pone.0171784.e435g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M435"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>110</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e436"><alternatives><graphic xlink:href="pone.0171784.e436.jpg" id="pone.0171784.e436g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M436"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>drug</mml:mtext><mml:mo>_</mml:mo><mml:mn>3</mml:mn><mml:mo>_</mml:mo><mml:mtext>stop</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e437"><alternatives><graphic xlink:href="pone.0171784.e437.jpg" id="pone.0171784.e437g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M437"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e438"><alternatives><graphic xlink:href="pone.0171784.e438.jpg" id="pone.0171784.e438g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M438"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e439"><alternatives><graphic xlink:href="pone.0171784.e439.jpg" id="pone.0171784.e439g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M439"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>400</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e440"><alternatives><graphic xlink:href="pone.0171784.e440.jpg" id="pone.0171784.e440g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M440"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>400</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e441"><alternatives><graphic xlink:href="pone.0171784.e441.jpg" id="pone.0171784.e441g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M441"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>400</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e442"><alternatives><graphic xlink:href="pone.0171784.e442.jpg" id="pone.0171784.e442g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M442"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>400</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e443"><alternatives><graphic xlink:href="pone.0171784.e443.jpg" id="pone.0171784.e443g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M443"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>400</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e444"><alternatives><graphic xlink:href="pone.0171784.e444.jpg" id="pone.0171784.e444g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M444"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>stage</mml:mtext><mml:mo>_</mml:mo><mml:mn>1</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e445"><alternatives><graphic xlink:href="pone.0171784.e445.jpg" id="pone.0171784.e445g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M445"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e446"><alternatives><graphic xlink:href="pone.0171784.e446.jpg" id="pone.0171784.e446g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M446"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e447"><alternatives><graphic xlink:href="pone.0171784.e447.jpg" id="pone.0171784.e447g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M447"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>300</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e448"><alternatives><graphic xlink:href="pone.0171784.e448.jpg" id="pone.0171784.e448g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M448"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e449"><alternatives><graphic xlink:href="pone.0171784.e449.jpg" id="pone.0171784.e449g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M449"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e450"><alternatives><graphic xlink:href="pone.0171784.e450.jpg" id="pone.0171784.e450g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M450"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e451"><alternatives><graphic xlink:href="pone.0171784.e451.jpg" id="pone.0171784.e451g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M451"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e452"><alternatives><graphic xlink:href="pone.0171784.e452.jpg" id="pone.0171784.e452g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M452"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>stage</mml:mtext><mml:mo>_</mml:mo><mml:mn>2</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e453"><alternatives><graphic xlink:href="pone.0171784.e453.jpg" id="pone.0171784.e453g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M453"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e454"><alternatives><graphic xlink:href="pone.0171784.e454.jpg" id="pone.0171784.e454g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M454"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e455"><alternatives><graphic xlink:href="pone.0171784.e455.jpg" id="pone.0171784.e455g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M455"><mml:mstyle mathcolor="#0000CF" mathvariant="monospace"><mml:mn>450</mml:mn></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e456"><alternatives><graphic xlink:href="pone.0171784.e456.jpg" id="pone.0171784.e456g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M456"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e457"><alternatives><graphic xlink:href="pone.0171784.e457.jpg" id="pone.0171784.e457g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M457"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e458"><alternatives><graphic xlink:href="pone.0171784.e458.jpg" id="pone.0171784.e458g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M458"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e459"><alternatives><graphic xlink:href="pone.0171784.e459.jpg" id="pone.0171784.e459g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M459"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NA</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>))</p>
        <p specific-use="line">## Multiple binary chronic covariates:</p>
        <p specific-use="line">tv_out1 &lt;- <inline-formula id="pone.0171784.e460"><alternatives><graphic xlink:href="pone.0171784.e460.jpg" id="pone.0171784.e460g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M460"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(tv_test,</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e461"><alternatives><graphic xlink:href="pone.0171784.e461.jpg" id="pone.0171784.e461g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M461"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>entry</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e462"><alternatives><graphic xlink:href="pone.0171784.e462.jpg" id="pone.0171784.e462g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M462"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> start,</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e463"><alternatives><graphic xlink:href="pone.0171784.e463.jpg" id="pone.0171784.e463g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M463"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>exit</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula> = end,</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e464"><alternatives><graphic xlink:href="pone.0171784.e464.jpg" id="pone.0171784.e464g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M464"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e465"><alternatives><graphic xlink:href="pone.0171784.e465.jpg" id="pone.0171784.e465g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M465"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> drug_1,</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e466"><alternatives><graphic xlink:href="pone.0171784.e466.jpg" id="pone.0171784.e466g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M466"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e467"><alternatives><graphic xlink:href="pone.0171784.e467.jpg" id="pone.0171784.e467g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M467"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> id,</p>
        <p specific-use="line">        <inline-formula id="pone.0171784.e468"><alternatives><graphic xlink:href="pone.0171784.e468.jpg" id="pone.0171784.e468g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M468"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>tv</mml:mtext><mml:mo>_</mml:mo><mml:mtext>name</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e469"><alternatives><graphic xlink:href="pone.0171784.e469.jpg" id="pone.0171784.e469g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M469"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> drug_1_state)</p>
        <p specific-use="line">tv_out1 &lt;- <inline-formula id="pone.0171784.e470"><alternatives><graphic xlink:href="pone.0171784.e470.jpg" id="pone.0171784.e470g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M470"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(tv_out1, start, end, drug_2, <inline-formula id="pone.0171784.e471"><alternatives><graphic xlink:href="pone.0171784.e471.jpg" id="pone.0171784.e471g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M471"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e472"><alternatives><graphic xlink:href="pone.0171784.e472.jpg" id="pone.0171784.e472g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M472"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> id, drug_2_state)</p>
        <p specific-use="line"><inline-formula id="pone.0171784.e473"><alternatives><graphic xlink:href="pone.0171784.e473.jpg" id="pone.0171784.e473g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M473"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>head</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(tv_out1)</p>
      </boxed-text>
      <p specific-use="line">## Source: local data frame [6 x 12]</p>
      <p specific-use="line">##</p>
      <p specific-use="line">##  id start  end  event  drug_1 drug_2  drug_3_start drug_3_stop stage_1</p>
      <p specific-use="line">## 1 1   0 1000   0   NA   NA      110     400   300</p>
      <p specific-use="line">## 2 2   0  233   1   NA   234      110     400   NA</p>
      <p specific-use="line">## 3 2  234  689   1   NA   234      110     400   NA</p>
      <p specific-use="line">## 4 3   0  553   0   NA   554      111     400   NA</p>
      <p specific-use="line">## 5 3  554 1000   0   NA   554      111     400   NA</p>
      <p specific-use="line">## 6 4   0  122   1   340   123      109     400   NA</p>
      <p specific-use="line">## Variables not shown: stage_2 (dbl), drug_1_state (dbl),</p>
      <p specific-use="line">## drug_2_state (dbl)</p>
      <boxed-text id="pone.0171784.box030" position="anchor" orientation="portrait">
        <p specific-use="line">## Binary covariates:</p>
        <p specific-use="line">tv_out3 &lt;- <inline-formula id="pone.0171784.e474"><alternatives><graphic xlink:href="pone.0171784.e474.jpg" id="pone.0171784.e474g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M474"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(tv_test, start, end, drug_3_start, <inline-formula id="pone.0171784.e475"><alternatives><graphic xlink:href="pone.0171784.e475.jpg" id="pone.0171784.e475g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M475"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e476"><alternatives><graphic xlink:href="pone.0171784.e476.jpg" id="pone.0171784.e476g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M476"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula></p>
        <p specific-use="line">    id, drug_3_state)</p>
        <p specific-use="line">tv_out3 &lt;- <inline-formula id="pone.0171784.e477"><alternatives><graphic xlink:href="pone.0171784.e477.jpg" id="pone.0171784.e477g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M477"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(tv_out3, start, end, drug_3_stop, <inline-formula id="pone.0171784.e478"><alternatives><graphic xlink:href="pone.0171784.e478.jpg" id="pone.0171784.e478g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M478"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e479"><alternatives><graphic xlink:href="pone.0171784.e479.jpg" id="pone.0171784.e479g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M479"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula></p>
        <p specific-use="line">    id, drug_3_state)</p>
        <p specific-use="line"><inline-formula id="pone.0171784.e480"><alternatives><graphic xlink:href="pone.0171784.e480.jpg" id="pone.0171784.e480g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M480"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>head</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(tv_out3)</p>
      </boxed-text>
      <p specific-use="line">## Source: local data frame [6 x 11]</p>
      <p specific-use="line">##</p>
      <p specific-use="line">##  id start  end event drug_1 drug_2 drug_3_start drug_3_stop stage_1</p>
      <p specific-use="line">## 1 1   0  109   0   NA   NA     110     400  300</p>
      <p specific-use="line">## 2 1  110  399   0   NA   NA     110     400  300</p>
      <p specific-use="line">## 3 1  400  1000   0   NA   NA     110     400  300</p>
      <p specific-use="line">## 4 2   0  109   1   NA   234     110     400  NA</p>
      <p specific-use="line">## 5 2  110  399   1   NA   234     110     400  NA</p>
      <p specific-use="line">## 6 2  400  689   1   NA   234     110     400  NA</p>
      <p specific-use="line">## Variables not shown: stage_2 (dbl), drug_3_state (dbl)</p>
      <boxed-text id="pone.0171784.box031" position="anchor" orientation="portrait">
        <p specific-use="line">## incremental covariates:</p>
        <p specific-use="line">inc_1 &lt;- <inline-formula id="pone.0171784.e481"><alternatives><graphic xlink:href="pone.0171784.e481.jpg" id="pone.0171784.e481g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M481"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(tv_test, start, end, stage_1, <inline-formula id="pone.0171784.e482"><alternatives><graphic xlink:href="pone.0171784.e482.jpg" id="pone.0171784.e482g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M482"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e483"><alternatives><graphic xlink:href="pone.0171784.e483.jpg" id="pone.0171784.e483g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M483"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> id, disease_stage,</p>
        <p specific-use="line">         <inline-formula id="pone.0171784.e583"><alternatives><graphic xlink:href="pone.0171784.e583.jpg" id="pone.0171784.e583g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M583"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>on</mml:mtext><mml:mo>_</mml:mo><mml:mtext>existing</mml:mtext><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e484"><alternatives><graphic xlink:href="pone.0171784.e484.jpg" id="pone.0171784.e484g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M484"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>inc</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        <p specific-use="line">inc_1 &lt;- <inline-formula id="pone.0171784.e485"><alternatives><graphic xlink:href="pone.0171784.e485.jpg" id="pone.0171784.e485g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M485"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(inc_1, start, end, stage_2, <inline-formula id="pone.0171784.e486"><alternatives><graphic xlink:href="pone.0171784.e486.jpg" id="pone.0171784.e486g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M486"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e487"><alternatives><graphic xlink:href="pone.0171784.e487.jpg" id="pone.0171784.e487g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M487"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> id, disease_stage,</p>
        <p specific-use="line">         <inline-formula id="pone.0171784.e584"><alternatives><graphic xlink:href="pone.0171784.e584.jpg" id="pone.0171784.e584g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M584"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>on</mml:mtext><mml:mo>_</mml:mo><mml:mtext>existing</mml:mtext><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e488"><alternatives><graphic xlink:href="pone.0171784.e488.jpg" id="pone.0171784.e488g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M488"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>inc</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        <p specific-use="line"><inline-formula id="pone.0171784.e489"><alternatives><graphic xlink:href="pone.0171784.e489.jpg" id="pone.0171784.e489g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M489"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>head</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(inc_1)</p>
      </boxed-text>
      <p specific-use="line">## Source: local data frame [6 x 11]</p>
      <p specific-use="line">##</p>
      <p specific-use="line">##  id start  end event drug_1 drug_2 drug_3_start drug_3_stop stage_1</p>
      <p specific-use="line">## 1 1   0  299   0   NA   NA     110     400   300</p>
      <p specific-use="line">## 2 1 300  449   0   NA    NA     110     400   300</p>
      <p specific-use="line">## 3 1 450 1000   0   NA   NA     110     400   300</p>
      <p specific-use="line">## 4 2   0  689   1   NA   234     110     400   NA</p>
      <p specific-use="line">## 5 3   0 1000   0   NA   554     111     400   NA</p>
      <p specific-use="line">## 6 4   0  874   1  340   123     109     400   NA</p>
      <p specific-use="line">## Variables not shown: stage_2 (dbl), disease_stage (dbl)</p>
      <boxed-text id="pone.0171784.box032" position="anchor" orientation="portrait">
        <p specific-use="line">## Chaining combinations of the above using %&gt;%</p>
        <p specific-use="line"><inline-formula id="pone.0171784.e490"><alternatives><graphic xlink:href="pone.0171784.e490.jpg" id="pone.0171784.e490g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M490"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>library</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(dplyr)</p>
        <p specific-use="line">tv_test %&gt;%</p>
        <p specific-use="line">  <inline-formula id="pone.0171784.e491"><alternatives><graphic xlink:href="pone.0171784.e491.jpg" id="pone.0171784.e491g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M491"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(start, end, drug_1, <inline-formula id="pone.0171784.e492"><alternatives><graphic xlink:href="pone.0171784.e492.jpg" id="pone.0171784.e492g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M492"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e493"><alternatives><graphic xlink:href="pone.0171784.e493.jpg" id="pone.0171784.e493g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M493"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> id, drug_1_state) %&gt;%</p>
        <p specific-use="line">  <inline-formula id="pone.0171784.e494"><alternatives><graphic xlink:href="pone.0171784.e494.jpg" id="pone.0171784.e494g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M494"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(start, end, drug_2, <inline-formula id="pone.0171784.e495"><alternatives><graphic xlink:href="pone.0171784.e495.jpg" id="pone.0171784.e495g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M495"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e496"><alternatives><graphic xlink:href="pone.0171784.e496.jpg" id="pone.0171784.e496g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M496"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> id, drug_2_state) %&gt;%</p>
        <p specific-use="line">  <inline-formula id="pone.0171784.e497"><alternatives><graphic xlink:href="pone.0171784.e497.jpg" id="pone.0171784.e497g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M497"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(start, end, drug_3_start, <inline-formula id="pone.0171784.e498"><alternatives><graphic xlink:href="pone.0171784.e498.jpg" id="pone.0171784.e498g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M498"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e499"><alternatives><graphic xlink:href="pone.0171784.e499.jpg" id="pone.0171784.e499g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M499"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> id, drug_3_state) %&gt;%</p>
        <p specific-use="line">  <inline-formula id="pone.0171784.e500"><alternatives><graphic xlink:href="pone.0171784.e500.jpg" id="pone.0171784.e500g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M500"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(start, end, drug_3_stop, <inline-formula id="pone.0171784.e501"><alternatives><graphic xlink:href="pone.0171784.e501.jpg" id="pone.0171784.e501g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M501"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e502"><alternatives><graphic xlink:href="pone.0171784.e502.jpg" id="pone.0171784.e502g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M502"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> id, drug_3_state) %&gt;%</p>
        <p specific-use="line">  <inline-formula id="pone.0171784.e503"><alternatives><graphic xlink:href="pone.0171784.e503.jpg" id="pone.0171784.e503g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M503"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(start, end, stage_1, <inline-formula id="pone.0171784.e504"><alternatives><graphic xlink:href="pone.0171784.e504.jpg" id="pone.0171784.e504g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M504"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e505"><alternatives><graphic xlink:href="pone.0171784.e505.jpg" id="pone.0171784.e505g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M505"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> id, disease_stage,</p>
        <p specific-use="line">     <inline-formula id="pone.0171784.e506"><alternatives><graphic xlink:href="pone.0171784.e506.jpg" id="pone.0171784.e506g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M506"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>on</mml:mtext><mml:mo>_</mml:mo><mml:mtext>existing</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e507"><alternatives><graphic xlink:href="pone.0171784.e507.jpg" id="pone.0171784.e507g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M507"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e508"><alternatives><graphic xlink:href="pone.0171784.e508.jpg" id="pone.0171784.e508g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M508"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>inc</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>) %&gt;%</p>
        <p specific-use="line">  <inline-formula id="pone.0171784.e509"><alternatives><graphic xlink:href="pone.0171784.e509.jpg" id="pone.0171784.e509g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M509"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>cut</mml:mtext><mml:mo>_</mml:mo><mml:mtext>tv</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(start, end, stage_2, <inline-formula id="pone.0171784.e510"><alternatives><graphic xlink:href="pone.0171784.e510.jpg" id="pone.0171784.e510g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M510"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>id</mml:mtext><mml:mo>_</mml:mo><mml:mtext>var</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e511"><alternatives><graphic xlink:href="pone.0171784.e511.jpg" id="pone.0171784.e511g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M511"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> id, disease_stage,</p>
        <p specific-use="line">     <inline-formula id="pone.0171784.e512"><alternatives><graphic xlink:href="pone.0171784.e512.jpg" id="pone.0171784.e512g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M512"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>on</mml:mtext><mml:mo>_</mml:mo><mml:mtext>existing</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e513"><alternatives><graphic xlink:href="pone.0171784.e513.jpg" id="pone.0171784.e513g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M513"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e514"><alternatives><graphic xlink:href="pone.0171784.e514.jpg" id="pone.0171784.e514g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M514"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>inc</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>) %&gt;%</p>
        <p specific-use="line">  head</p>
      </boxed-text>
      <p specific-use="line">## Source: local data frame [6 x 14]</p>
      <p specific-use="line">##</p>
      <p specific-use="line">##  id start  end event drug_1 drug_2 drug_3_start  drug_3_stop  stage_1</p>
      <p specific-use="line">## 1 1   0  109   0   NA   NA     110     400   300</p>
      <p specific-use="line">## 2 1  110  299   0   NA   NA     110     400   300</p>
      <p specific-use="line">## 3 1  300  399   0   NA   NA     110     400   300</p>
      <p specific-use="line">## 4 1  400  449   0   NA   NA     110     400   300</p>
      <p specific-use="line">## 5 1  450 1000   0   NA   NA     110     400   300</p>
      <p specific-use="line">## 6 2   0  109   1   NA   234     110     400   NA</p>
      <p specific-use="line">## Variables not shown: stage_2 (dbl), drug_1_state (dbl), drug_2_state</p>
      <p specific-use="line">## (dbl), drug_3_state (dbl), disease_stage (dbl)</p>
    </sec>
  </sec>
  <sec id="sec015">
    <title>5 Accessory functions</title>
    <p>In this section we briefly discuss some miscellaneous functions provided in the package.</p>
    <sec id="sec016">
      <title>5.1 Clinical code list construction</title>
      <p>An important part of EHR analyses is the construction of lists of clinical codes to define conditions, comorbidities and other clinical entities of interest to the study [<xref rid="pone.0171784.ref009" ref-type="bibr">9</xref>]. We have previously described methodologies to construct draft lists of clinical codes from keyword and code searches [<xref rid="pone.0171784.ref019" ref-type="bibr">19</xref>]. The <monospace>R</monospace> implementation of this methodology is now part of the rEHR package.</p>
      <p>Building draft lists of clinical codes is a two-stage process: First, the search is defined by instantiating an object of class <monospace>MedicalDefinition</monospace>, containing the terms to be searched for in the lookup tables. <monospace>MedicalDefinition</monospace> objects can be instantiated from terms defined within <monospace>R</monospace> or imported from a csv file. The constructor function can be provided with lists of: <monospace>terms</monospace>(clinical search terms), <monospace>codes</monospace> (clinical codes), <monospace>tests</monospace> (test search terms), <monospace>drugs</monospace> (drug search terms), <monospace>drugcodes</monospace> (drug product codes). Within the individual argument lists, vectors of length &gt; 1 are searched for together (logical AND), in any order. Different vectors in the same list are searched for separately (logical OR). Placing a “-” character at the start of a character vector element excludes that terms from the search. Providing <monospace>NULL</monospace> to any of the arguments means that this element will not be searched for. Underscores are treated as spaces. When searching for codes, a range of clinical codes can be searched for by providing two codes separated by a hyphen. e.g “E114-E117z”.</p>
      <boxed-text id="pone.0171784.box033" position="anchor" orientation="portrait">
        <p specific-use="line">## Example construction of a clinical code list</p>
        <p specific-use="line">def &lt;- <inline-formula id="pone.0171784.e515"><alternatives><graphic xlink:href="pone.0171784.e515.jpg" id="pone.0171784.e515g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M515"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>MedicalDefinition</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(</p>
        <p specific-use="line">  <inline-formula id="pone.0171784.e516"><alternatives><graphic xlink:href="pone.0171784.e516.jpg" id="pone.0171784.e516g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M516"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>terms</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e517"><alternatives><graphic xlink:href="pone.0171784.e517.jpg" id="pone.0171784.e517g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M517"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e518"><alternatives><graphic xlink:href="pone.0171784.e518.jpg" id="pone.0171784.e518g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M518"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>list</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(</p>
        <p specific-use="line">    <inline-formula id="pone.0171784.e519"><alternatives><graphic xlink:href="pone.0171784.e519.jpg" id="pone.0171784.e519g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M519"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>peripheral vascular disease</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e520"><alternatives><graphic xlink:href="pone.0171784.e520.jpg" id="pone.0171784.e520g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M520"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>peripheral gangrene</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
        <p specific-use="line">    <inline-formula id="pone.0171784.e521"><alternatives><graphic xlink:href="pone.0171784.e521.jpg" id="pone.0171784.e521g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M521"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mo>‐</mml:mo><mml:mtext>wrong answer</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e522"><alternatives><graphic xlink:href="pone.0171784.e522.jpg" id="pone.0171784.e522g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M522"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>intermittent claudication</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
        <p specific-use="line">    <inline-formula id="pone.0171784.e523"><alternatives><graphic xlink:href="pone.0171784.e523.jpg" id="pone.0171784.e523g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M523"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>thromboangiitis obliterans</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e524"><alternatives><graphic xlink:href="pone.0171784.e524.jpg" id="pone.0171784.e524g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M524"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>thromboangiitis obliterans</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
        <p specific-use="line">    <inline-formula id="pone.0171784.e525"><alternatives><graphic xlink:href="pone.0171784.e525.jpg" id="pone.0171784.e525g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M525"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>diabetic peripheral angiopathy</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
        <p specific-use="line">    <inline-formula id="pone.0171784.e526"><alternatives><graphic xlink:href="pone.0171784.e526.jpg" id="pone.0171784.e526g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M526"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e527"><alternatives><graphic xlink:href="pone.0171784.e527.jpg" id="pone.0171784.e527g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M527"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>diabetes</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e528"><alternatives><graphic xlink:href="pone.0171784.e528.jpg" id="pone.0171784.e528g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M528"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>peripheral angiopathy</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>), <inline-formula id="pone.0171784.e529"><alternatives><graphic xlink:href="pone.0171784.e529.jpg" id="pone.0171784.e529g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M529"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mo>#</mml:mo><mml:mtext mathvariant="italic"> single AND expression</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula></p>
        <p specific-use="line">    <inline-formula id="pone.0171784.e530"><alternatives><graphic xlink:href="pone.0171784.e530.jpg" id="pone.0171784.e530g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M530"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>c</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e531"><alternatives><graphic xlink:href="pone.0171784.e531.jpg" id="pone.0171784.e531g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M531"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>buerger</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e532"><alternatives><graphic xlink:href="pone.0171784.e532.jpg" id="pone.0171784.e532g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M532"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>disease presenile</mml:mtext><mml:mo>_</mml:mo><mml:mtext>gangrene</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">      <inline-formula id="pone.0171784.e533"><alternatives><graphic xlink:href="pone.0171784.e533.jpg" id="pone.0171784.e533g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M533"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mo>‐</mml:mo><mml:mtext>excepted</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e534"><alternatives><graphic xlink:href="pone.0171784.e534.jpg" id="pone.0171784.e534g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M534"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mo>#</mml:mo><mml:mtext mathvariant="italic"> exclusion</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula></p>
        <p specific-use="line">  <inline-formula id="pone.0171784.e535"><alternatives><graphic xlink:href="pone.0171784.e535.jpg" id="pone.0171784.e535g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M535"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>codes</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e536"><alternatives><graphic xlink:href="pone.0171784.e536.jpg" id="pone.0171784.e536g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M536"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e537"><alternatives><graphic xlink:href="pone.0171784.e537.jpg" id="pone.0171784.e537g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M537"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>list</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e538"><alternatives><graphic xlink:href="pone.0171784.e538.jpg" id="pone.0171784.e538g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M538"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>G</mml:mtext><mml:mn>73</mml:mn><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>),</p>
        <p specific-use="line">  <inline-formula id="pone.0171784.e539"><alternatives><graphic xlink:href="pone.0171784.e539.jpg" id="pone.0171784.e539g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M539"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>tests</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e540"><alternatives><graphic xlink:href="pone.0171784.e540.jpg" id="pone.0171784.e540g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M540"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e541"><alternatives><graphic xlink:href="pone.0171784.e541.jpg" id="pone.0171784.e541g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M541"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>NULL</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>,</p>
        <p specific-use="line">  <inline-formula id="pone.0171784.e542"><alternatives><graphic xlink:href="pone.0171784.e542.jpg" id="pone.0171784.e542g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M542"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>drugs</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e543"><alternatives><graphic xlink:href="pone.0171784.e543.jpg" id="pone.0171784.e543g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M543"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e544"><alternatives><graphic xlink:href="pone.0171784.e544.jpg" id="pone.0171784.e544g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M544"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>list</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e545"><alternatives><graphic xlink:href="pone.0171784.e545.jpg" id="pone.0171784.e545g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M545"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>insulin</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e546"><alternatives><graphic xlink:href="pone.0171784.e546.jpg" id="pone.0171784.e546g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M546"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>diabet</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e547"><alternatives><graphic xlink:href="pone.0171784.e547.jpg" id="pone.0171784.e547g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M547"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>aspirin</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)))</p>
      </boxed-text>
      <p>Code lists can be defined in a csv file with format as shown in <xref rid="pone.0171784.t002" ref-type="table">Table 2</xref>. These files can then be imported to <monospace>MedicalDefinition</monospace> objects using the <monospace>import_definitions(input_file = "path/to/file.csv")</monospace> function.</p>
      <table-wrap id="pone.0171784.t002" orientation="portrait" position="float">
        <object-id pub-id-type="doi">10.1371/journal.pone.0171784.t002</object-id>
        <label>Table 2</label>
        <caption>
          <title>Example code list definition in csv format.</title>
        </caption>
        <alternatives>
          <graphic id="pone.0171784.t002g" xlink:href="pone.0171784.t002"/>
          <table frame="box" rules="all" border="0">
            <colgroup span="1">
              <col align="left" valign="middle" span="1"/>
              <col align="left" valign="middle" span="1"/>
              <col align="left" valign="middle" span="1"/>
              <col align="left" valign="middle" span="1"/>
            </colgroup>
            <thead>
              <tr>
                <th align="left" rowspan="1" colspan="1">definition</th>
                <th align="left" rowspan="1" colspan="1">status</th>
                <th align="left" rowspan="1" colspan="1">items</th>
                <th align="left" rowspan="1" colspan="1"/>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td align="left" rowspan="1" colspan="1">terms</td>
                <td align="left" rowspan="1" colspan="1">include</td>
                <td align="left" rowspan="1" colspan="1">peripheral vascular disease</td>
                <td align="left" rowspan="12" colspan="1">peripheral angiopathy terms disease presenile_gengrene terms</td>
              </tr>
              <tr>
                <td align="left" rowspan="1" colspan="1">terms</td>
                <td align="left" rowspan="1" colspan="1">include</td>
                <td align="left" rowspan="1" colspan="1">peripheral gangrene</td>
              </tr>
              <tr>
                <td align="left" rowspan="1" colspan="1">terms</td>
                <td align="left" rowspan="1" colspan="1">exclude</td>
                <td align="left" rowspan="1" colspan="1">wrong answer</td>
              </tr>
              <tr>
                <td align="left" rowspan="1" colspan="1">terms</td>
                <td align="left" rowspan="1" colspan="1">include</td>
                <td align="left" rowspan="1" colspan="1">intermittent claudication</td>
              </tr>
              <tr>
                <td align="left" rowspan="1" colspan="1">terms</td>
                <td align="left" rowspan="1" colspan="1">include</td>
                <td align="left" rowspan="1" colspan="1">thromboangiitis obliterans</td>
              </tr>
              <tr>
                <td align="left" rowspan="1" colspan="1">terms</td>
                <td align="left" rowspan="1" colspan="1">include</td>
                <td align="left" rowspan="1" colspan="1">Diabetic peripheral angiopathy</td>
              </tr>
              <tr>
                <td align="left" rowspan="1" colspan="1">terms</td>
                <td align="left" rowspan="1" colspan="1">include</td>
                <td align="left" rowspan="1" colspan="1">diabetes</td>
              </tr>
              <tr>
                <td align="left" rowspan="1" colspan="1">terms</td>
                <td align="left" rowspan="1" colspan="1">include</td>
                <td align="left" rowspan="1" colspan="1">buerger</td>
              </tr>
              <tr>
                <td align="left" rowspan="1" colspan="1">terms</td>
                <td align="left" rowspan="1" colspan="1">exclude</td>
                <td align="left" rowspan="1" colspan="1">excepted</td>
              </tr>
              <tr>
                <td align="left" rowspan="1" colspan="1">codes</td>
                <td align="left" rowspan="1" colspan="1">include</td>
                <td align="left" rowspan="1" colspan="1">G73</td>
              </tr>
              <tr>
                <td align="left" rowspan="1" colspan="1">drugs</td>
                <td align="left" rowspan="1" colspan="1">include</td>
                <td align="left" rowspan="1" colspan="1">insulin</td>
              </tr>
              <tr>
                <td align="left" rowspan="1" colspan="1">drugs</td>
                <td align="left" rowspan="1" colspan="1">include</td>
                <td align="left" rowspan="1" colspan="1">aspirin</td>
              </tr>
            </tbody>
          </table>
        </alternatives>
      </table-wrap>
      <p>The <monospace>MedicalDefinition</monospace> objects are then used to run searches against lookup tables provided with EHRs via the <monospace>build_definition_lists()</monospace> function:</p>
      <boxed-text id="pone.0171784.box034" position="anchor" orientation="portrait">
        <p specific-use="line">## Use fileEncoding = "latin1" to avoid issues with non-ascii characters</p>
        <p specific-use="line">medical_table &lt;- <inline-formula id="pone.0171784.e548"><alternatives><graphic xlink:href="pone.0171784.e548.jpg" id="pone.0171784.e548g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M548"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>read</mml:mtext><mml:mo>.</mml:mo><mml:mtext>delim</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e549"><alternatives><graphic xlink:href="pone.0171784.e549.jpg" id="pone.0171784.e549g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M549"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Lookups</mml:mtext><mml:mo>/</mml:mo><mml:mtext>medical</mml:mtext><mml:mo>.</mml:mo><mml:mtext>txt</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e550"><alternatives><graphic xlink:href="pone.0171784.e550.jpg" id="pone.0171784.e550g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M550"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>fileEncoding</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e551"><alternatives><graphic xlink:href="pone.0171784.e551.jpg" id="pone.0171784.e551g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M551"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e552"><alternatives><graphic xlink:href="pone.0171784.e552.jpg" id="pone.0171784.e552g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M552"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>latin1</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e553"><alternatives><graphic xlink:href="pone.0171784.e553.jpg" id="pone.0171784.e553g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M553"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>stringsAsFactors</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e554"><alternatives><graphic xlink:href="pone.0171784.e554.jpg" id="pone.0171784.e554g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M554"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e555"><alternatives><graphic xlink:href="pone.0171784.e555.jpg" id="pone.0171784.e555g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M555"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>FALSE</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        <p specific-use="line">drug_table &lt;- <inline-formula id="pone.0171784.e556"><alternatives><graphic xlink:href="pone.0171784.e556.jpg" id="pone.0171784.e556g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M556"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>read</mml:mtext><mml:mo>.</mml:mo><mml:mtext>delim</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(<inline-formula id="pone.0171784.e557"><alternatives><graphic xlink:href="pone.0171784.e557.jpg" id="pone.0171784.e557g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M557"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>Lookups</mml:mtext><mml:mo>/</mml:mo><mml:mtext>product</mml:mtext><mml:mo>.</mml:mo><mml:mtext>txt</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e558"><alternatives><graphic xlink:href="pone.0171784.e558.jpg" id="pone.0171784.e558g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M558"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>fileEncoding</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e559"><alternatives><graphic xlink:href="pone.0171784.e559.jpg" id="pone.0171784.e559g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M559"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e560"><alternatives><graphic xlink:href="pone.0171784.e560.jpg" id="pone.0171784.e560g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M560"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>latin1</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>, <inline-formula id="pone.0171784.e561"><alternatives><graphic xlink:href="pone.0171784.e561.jpg" id="pone.0171784.e561g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M561"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>stringsAsFactors</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e562"><alternatives><graphic xlink:href="pone.0171784.e562.jpg" id="pone.0171784.e562g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M562"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e563"><alternatives><graphic xlink:href="pone.0171784.e563.jpg" id="pone.0171784.e563g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M563"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mtext>FALSE</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
        <p specific-use="line">draft_lists &lt;- <inline-formula id="pone.0171784.e564"><alternatives><graphic xlink:href="pone.0171784.e564.jpg" id="pone.0171784.e564g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M564"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>build</mml:mtext><mml:mo>_</mml:mo><mml:mtext>definition</mml:mtext><mml:mo>_</mml:mo><mml:mtext>lists</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(def, <inline-formula id="pone.0171784.e565"><alternatives><graphic xlink:href="pone.0171784.e565.jpg" id="pone.0171784.e565g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M565"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>medical</mml:mtext><mml:mo>_</mml:mo><mml:mtext>table</mml:mtext><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> medical_table, <inline-formula id="pone.0171784.e566"><alternatives><graphic xlink:href="pone.0171784.e566.jpg" id="pone.0171784.e566g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M566"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>drug</mml:mtext><mml:mo>_</mml:mo><mml:mtext>table</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>
<inline-formula id="pone.0171784.e567"><alternatives><graphic xlink:href="pone.0171784.e567.jpg" id="pone.0171784.e567g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M567"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula> drug_table)</p>
      </boxed-text>
    </sec>
    <sec id="sec017">
      <title>5.2 Unit conversion</title>
      <p>HbA1C tests for glycated haemoglobin are one of the best recorded clinical tests in UK primary care databases, to a large extent because of testing being incentivised under the UK Quality and Outcomes Framework pay-for-performance scheme [<xref rid="pone.0171784.ref020" ref-type="bibr">20</xref>; <xref rid="pone.0171784.ref025" ref-type="bibr">25</xref>]. However, HbA1C data is not recorded in CPRD consistently. Measurements may have been made in mmol/mol, mmol/L or mg/dL. Also the closely analogous fructosamine test can also be converted into the same units for direct comparison. The CPRD-specific <monospace>cprd_uniform_hba1c_values()</monospace> function accepts a single argument of a dataframe in the CPRD “Additional” table form containing only entity types for HbA1C and Fructosamine and converts any HbA1C and fructosamine values to a common mmol/mol scale. Once this conversion has taken place, the function also removes obvious mis-coding errors that are far outside the possible range. A dataframe is returned with an extra column <monospace>hba1c_score</monospace>.</p>
    </sec>
    <sec id="sec018">
      <title>5.3 Exporting data to stata format</title>
      <p>Sometimes researchers may need to share data with others in the same group who may not have <monospace>R</monospace> expertise. We have provided the <monospace>to_stata</monospace> function to export dataframes to stata dta format. This function compresses a dataframe to reduce file size in the following ways:</p>
      <list list-type="order">
        <list-item>
          <p>Date variables (as specified by the <monospace>date_fields</monospace> argument) are converted to integer days from 1960-01-01 to avoid compatibility issues between <monospace>R</monospace> and Stata. An alternative origin can be set with the <monospace>origin</monospace> argument.</p>
        </list-item>
        <list-item>
          <p>Fields specified in the <monospace>integer_fields</monospace> are converted from numeric to integer.</p>
        </list-item>
      </list>
      <p>the <monospace>stata13</monospace> boolean argument indicates whether files should be stored in Stata13 format (Using <monospace>readstata13::savedta13</monospace>) or in Stata 12 compatible format (using <monospace>foreign::write.dta</monospace>). The former includes a further compression step, similar to the <monospace>compress</monospace> command in Stata.</p>
    </sec>
    <sec id="sec019">
      <title>5.4 Working with temporary database tables</title>
      <p>The size of EHR databases may require keeping intermediate data extractions as database tables, rather than as in-memory <monospace>R</monospace> dataframes. For example, extractions of clinical events for a common condition such as diabetes or asthma will require the extraction of millions of rows of data. These may be easily stored as temporary database tables. This is also useful if you are working with a protected database that you only have read-only access to. The <monospace>rEHR</monospace> package has a suite of functions to deal with temporary database tables:</p>
      <list list-type="bullet">
        <list-item>
          <p specific-use="line"><monospace>temp_table()</monospace> is used to construct temporary tables and is illustrated in section 3</p>
        </list-item>
        <list-item>
          <p specific-use="line"><monospace>append_to_temp_table()</monospace> appends rows to a temporary table based on a specified select statement</p>
        </list-item>
        <list-item>
          <p specific-use="line"><monospace>to_temp_table()</monospace> exports a dataframe to a temporary database table</p>
        </list-item>
        <list-item>
          <p specific-use="line"><monospace>drop_temp_table()</monospace> checks if a temporary table exists and then deletes if it does</p>
        </list-item>
        <list-item>
          <p specific-use="line"><monospace>drop_all_temp_tables()</monospace> drops all temporary tables from the database</p>
        </list-item>
      </list>
      <p>Note that temporary tables are only associated with the currently open database connection. This means that functions capable of parallel processing (e.g. <monospace>select_by_year()</monospace>) can only be used in the single core mode (i.e. set <monospace>cores = 1</monospace>) since multicore processes open up multiple parallel connections.</p>
    </sec>
  </sec>
  <sec id="sec020">
    <title>6 Setting EHR type</title>
    <p>In the final section we discuss the <monospace>.ehr</monospace> environment used to define the EHR database being used and how this can be set to work with different databases.</p>
    <p>In many of the functions in this package, specific tables and variables in the database need to be accessed. A particular database system, such as CPRD, will have its own schema describing the organisation of the data within it. To simplify the functions in this package, we have opted to include an interface to the database schema in the form of an environment, <monospace>.ehr</monospace>, that is accessed by the various analysis functions in order to extract the correct data from the correct place in the database. This is effectively a list of attributes relating to the EHR system being used. For example there is an attribute specifying the patient id variable in the database. By default, a schema environment for CPRD is loaded when the package is loaded via a call to <monospace>set_CPRD()</monospace>. We have provided accessor functions to get and set attributes in the <monospace>.ehr</monospace> environment. It is preferable to use these accessor functions rather than setting elements directly. A list of all of the attributes is provided by the <monospace>list_EHR_attributes()</monospace> function. For example:</p>
    <boxed-text id="pone.0171784.box035" position="anchor" orientation="portrait">
      <p specific-use="line"><inline-formula id="pone.0171784.e568"><alternatives><graphic xlink:href="pone.0171784.e568.jpg" id="pone.0171784.e568g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M568"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>list</mml:mtext><mml:mo>_</mml:mo><mml:mtext>EHR</mml:mtext><mml:mo>_</mml:mo><mml:mtext>attributes</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>()</p>
    </boxed-text>
    <p specific-use="line">##  [1] "birth_year"     "cohort"     "date_fields"</p>
    <p specific-use="line">##  [4] "ehr_medcode"   "EHR_name"   "event_date"</p>
    <p specific-use="line">##  [7] "lookup"      "patient_id"   "practice_id"</p>
    <p specific-use="line">## [10] "raw_date_format" "tables"     "year_origin"</p>
    <p>The values of individual attributes can be accessed with the <monospace>get_EHR_attribute()</monospace> function:</p>
    <boxed-text id="pone.0171784.box036" position="anchor" orientation="portrait">
      <p specific-use="line"><inline-formula id="pone.0171784.e569"><alternatives><graphic xlink:href="pone.0171784.e569.jpg" id="pone.0171784.e569g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M569"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>get</mml:mtext><mml:mo>_</mml:mo><mml:mtext>EHR</mml:mtext><mml:mo>_</mml:mo><mml:mtext>attribute</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(patient_id) <inline-formula id="pone.0171784.e570"><alternatives><graphic xlink:href="pone.0171784.e570.jpg" id="pone.0171784.e570g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M570"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mo>#</mml:mo><mml:mtext mathvariant="italic"> gives the attribute for patient ids</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula></p>
    </boxed-text>
    <p specific-use="line">## [1] "patid"</p>
    <boxed-text id="pone.0171784.box037" position="anchor" orientation="portrait">
      <p specific-use="line"><inline-formula id="pone.0171784.e571"><alternatives><graphic xlink:href="pone.0171784.e571.jpg" id="pone.0171784.e571g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M571"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>get</mml:mtext><mml:mo>_</mml:mo><mml:mtext>EHR</mml:mtext><mml:mo>_</mml:mo><mml:mtext>attribute</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(date_fields) <inline-formula id="pone.0171784.e572"><alternatives><graphic xlink:href="pone.0171784.e572.jpg" id="pone.0171784.e572g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M572"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mo>#</mml:mo><mml:mtext mathvariant="italic"> fields in the database stored as dates</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula></p>
    </boxed-text>
    <p specific-use="line">##    event    entry   last_coll up_to_std first_reg</p>
    <p specific-use="line">## "eventdate"   "sysdate"    "lcd"   "uts"  "frd"</p>
    <p specific-use="line">## current_reg transfer_out    death</p>
    <p specific-use="line">##    "crd"    "tod" "deathdate"</p>
    <boxed-text id="pone.0171784.box038" position="anchor" orientation="portrait">
      <p specific-use="line"><inline-formula id="pone.0171784.e573"><alternatives><graphic xlink:href="pone.0171784.e573.jpg" id="pone.0171784.e573g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M573"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>get</mml:mtext><mml:mo>_</mml:mo><mml:mtext>EHR</mml:mtext><mml:mo>_</mml:mo><mml:mtext>attribute</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(cohort) <inline-formula id="pone.0171784.e574"><alternatives><graphic xlink:href="pone.0171784.e574.jpg" id="pone.0171784.e574g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M574"><mml:mstyle mathcolor="#8F5903" mathvariant="monospace"><mml:mo>#</mml:mo><mml:mtext mathvariant="italic"> variables used in cohort construction</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula></p>
    </boxed-text>
    <p specific-use="line">## $start_criteria</p>
    <p specific-use="line">## [1] "crd" "uts"</p>
    <p specific-use="line">##</p>
    <p specific-use="line">## $end_criteria</p>
    <p specific-use="line">## [1] "tod"  "deathdate" "lcd"</p>
    <p>Individual attribute values can be set using the <monospace>set_EHR_Attribute()</monospace> function:</p>
    <boxed-text id="pone.0171784.box039" position="anchor" orientation="portrait">
      <p specific-use="line">
        <inline-formula id="pone.0171784.e575">
          <alternatives>
            <graphic xlink:href="pone.0171784.e575.jpg" id="pone.0171784.e575g" mimetype="image" position="anchor" orientation="portrait"/>
            <mml:math id="M575">
              <mml:mstyle mathcolor="#8F5903" mathvariant="monospace">
                <mml:mo>#</mml:mo>
                <mml:mtext mathvariant="italic"> set the patient id attribute</mml:mtext>
              </mml:mstyle>
            </mml:math>
          </alternatives>
        </inline-formula>
      </p>
      <p specific-use="line"><inline-formula id="pone.0171784.e576"><alternatives><graphic xlink:href="pone.0171784.e576.jpg" id="pone.0171784.e576g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M576"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>set</mml:mtext><mml:mo>_</mml:mo><mml:mtext>EHR</mml:mtext><mml:mo>_</mml:mo><mml:mtext>attribute</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(patient_id, <inline-formula id="pone.0171784.e577"><alternatives><graphic xlink:href="pone.0171784.e577.jpg" id="pone.0171784.e577g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M577"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>value</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e578"><alternatives><graphic xlink:href="pone.0171784.e578.jpg" id="pone.0171784.e578g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M578"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mo>=</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula><inline-formula id="pone.0171784.e579"><alternatives><graphic xlink:href="pone.0171784.e579.jpg" id="pone.0171784.e579g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M579"><mml:mstyle mathcolor="#4F9905" mathvariant="monospace"><mml:mo>"</mml:mo><mml:mtext>PATIENT</mml:mtext><mml:mo>"</mml:mo></mml:mstyle></mml:math></alternatives></inline-formula>)</p>
      <p specific-use="line"><inline-formula id="pone.0171784.e580"><alternatives><graphic xlink:href="pone.0171784.e580.jpg" id="pone.0171784.e580g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M580"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>get</mml:mtext><mml:mo>_</mml:mo><mml:mtext>EHR</mml:mtext><mml:mo>_</mml:mo><mml:mtext>attribute</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(patient_id)</p>
    </boxed-text>
    <p specific-use="line">## [1] "PATIENT"</p>
    <p>The default settings can be reverted to using the <monospace>set_CPRD()</monospace> function:</p>
    <boxed-text id="pone.0171784.box040" position="anchor" orientation="portrait">
      <p specific-use="line"><inline-formula id="pone.0171784.e581"><alternatives><graphic xlink:href="pone.0171784.e581.jpg" id="pone.0171784.e581g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M581"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>set</mml:mtext><mml:mo>_</mml:mo><mml:mtext>CPRD</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>()</p>
    </boxed-text>
    <p specific-use="line">## Using CPRD settings</p>
    <boxed-text id="pone.0171784.box041" position="anchor" orientation="portrait">
      <p specific-use="line"><inline-formula id="pone.0171784.e582"><alternatives><graphic xlink:href="pone.0171784.e582.jpg" id="pone.0171784.e582g" mimetype="image" position="anchor" orientation="portrait"/><mml:math id="M582"><mml:mstyle mathcolor="#214A87" mathvariant="monospace"><mml:mtext>get</mml:mtext><mml:mo>_</mml:mo><mml:mtext>EHR</mml:mtext><mml:mo>_</mml:mo><mml:mtext>attribute</mml:mtext></mml:mstyle></mml:math></alternatives></inline-formula>(patient_id)</p>
    </boxed-text>
    <p specific-use="line">## [1] "patid"</p>
    <p>The <monospace>.ehr</monospace> environments will allow for the simple definition of interfaces to other EHR systems, via the construction of new setting functions.</p>
  </sec>
  <sec id="sec021">
    <title>7 Conclusion</title>
    <p>Working with structured EHR data requires a combination of computational and statistical expertise. The <monospace>rEHR</monospace> package greatly simplifies and accelerates the extraction and processing of coded data from EHR databases, enabling researchers to spend more time on their analyses, time that would otherwise be consumed with laborious preparation of research-ready data. The workflow is straightforward, amounting to a flat series of function calls rather than a complex set of nested loops, therefore errors are much more easily spotted and fixed. The available functions are summarised in <xref rid="pone.0171784.t003" ref-type="table">Table 3</xref>. The combination of SQL native databases, optimised data manipulation packages and multicore functionality results in a package that runs many times faster than equivalent code.</p>
    <table-wrap id="pone.0171784.t003" orientation="portrait" position="float">
      <object-id pub-id-type="doi">10.1371/journal.pone.0171784.t003</object-id>
      <label>Table 3</label>
      <caption>
        <title>Available functions in rEHR.</title>
      </caption>
      <alternatives>
        <graphic id="pone.0171784.t003g" xlink:href="pone.0171784.t003"/>
        <table frame="box" rules="all" border="0">
          <colgroup span="1">
            <col align="left" valign="middle" span="1"/>
            <col align="left" valign="middle" span="1"/>
            <col align="left" valign="middle" span="1"/>
          </colgroup>
          <thead>
            <tr>
              <th align="left" rowspan="1" colspan="1">code file</th>
              <th align="left" rowspan="1" colspan="1">function</th>
              <th align="left" rowspan="1" colspan="1">description</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td align="left" rowspan="6" colspan="1">codelists</td>
              <td align="left" rowspan="1" colspan="1">extract_keywords</td>
              <td align="left" rowspan="1" colspan="1">Function to extract rows from a lookup table based on keywords</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">MedicalDefinition</td>
              <td align="left" rowspan="1" colspan="1">Constructor function for MedicalDefinition class</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">import_definitions</td>
              <td align="left" rowspan="1" colspan="1">Imports definitions to be searched from a csv file into a MedicalDefinition object</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">export_definition_search</td>
              <td align="left" rowspan="1" colspan="1">Exports definition searches to an excel file</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">definition_search</td>
              <td align="left" rowspan="1" colspan="1">This function is used to build new definition lists based on medical definitions</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">print.MedicalDefinition</td>
              <td align="left" rowspan="1" colspan="1">Basic print method for medical definition classes</td>
            </tr>
            <tr>
              <td align="left" rowspan="2" colspan="1">cohort</td>
              <td align="left" rowspan="1" colspan="1">build_cohort</td>
              <td align="left" rowspan="1" colspan="1">Converts a longitudinal data set from e.g. ∖<italic>code</italic>{<italic>prev</italic>_<italic>terms</italic>} to a cohort dataset</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">cut_tv</td>
              <td align="left" rowspan="1" colspan="1">Cuts a survival dataset on a time varying variable</td>
            </tr>
            <tr>
              <td align="left" rowspan="4" colspan="1">cprd_import</td>
              <td align="left" rowspan="1" colspan="1">read_zip</td>
              <td align="left" rowspan="1" colspan="1">Reads a zipped data file to a dataframe</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">database</td>
              <td align="left" rowspan="1" colspan="1">Wrapper for dbConnect</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">add_to_database</td>
              <td align="left" rowspan="1" colspan="1">Adds a series of files to a database</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">import_CPRD_data</td>
              <td align="left" rowspan="1" colspan="1">Imports all selected CPRD data into an sqlite database</td>
            </tr>
            <tr>
              <td align="left" rowspan="3" colspan="1">cprd_medcodes</td>
              <td align="left" rowspan="1" colspan="1">patients_per_medcode</td>
              <td align="left" rowspan="1" colspan="1">Produce a dataset of CPRD medcodes with frequencies of patients in the clinical table</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">medcodes_to_read</td>
              <td align="left" rowspan="1" colspan="1">Translate CPRD medcodes to Read/OXMIS</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">read_to_medcodes</td>
              <td align="left" rowspan="1" colspan="1">Translate Read/Oxmis codes to CPRD medcodes</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">cprd_patients</td>
              <td align="left" rowspan="1" colspan="1">patients_in_window</td>
              <td align="left" rowspan="1" colspan="1">Select patients alive and registered between certain dates</td>
            </tr>
            <tr>
              <td align="left" rowspan="5" colspan="1">data</td>
              <td align="left" rowspan="1" colspan="1">clinical_codes</td>
              <td align="left" rowspan="1" colspan="1">Clinical codes for 17 QOF conditions, smoking and HbA1c</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">entity</td>
              <td align="left" rowspan="1" colspan="1">A sample of 6 clinical tests and meaures used in UK primary care</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">product</td>
              <td align="left" rowspan="1" colspan="1">A sample of 500 medicines used in UK primary care</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">repsample_example</td>
              <td align="left" rowspan="1" colspan="1">An example dataset to demonstrate the repsample function. 2474 theoretical UK general practices</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">ehr_def</td>
              <td align="left" rowspan="1" colspan="1">An example EHR_definition object for defining parameters for simulating EHR data</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">db_view</td>
              <td align="left" rowspan="1" colspan="1">head.SQLiteConnection</td>
              <td align="left" rowspan="1" colspan="1">head for SQLiteConnection object</td>
            </tr>
            <tr>
              <td align="left" rowspan="2" colspan="1">EHR_definition</td>
              <td align="left" rowspan="1" colspan="1">define_EHR</td>
              <td align="left" rowspan="1" colspan="1">Construct an EHR_definition object</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">print.EHR_definition</td>
              <td align="left" rowspan="1" colspan="1">Tools for describing EMR_description objects</td>
            </tr>
            <tr>
              <td align="left" rowspan="6" colspan="1">ehr_simulation</td>
              <td align="left" rowspan="1" colspan="1">random_dates</td>
              <td align="left" rowspan="1" colspan="1">Generates random dates between a start and end day</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">surv_sims</td>
              <td align="left" rowspan="1" colspan="1">Function to simulate survival data</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">simulate_ehr_patients</td>
              <td align="left" rowspan="1" colspan="1">Generate a dataframe of simulated patients with exit dates based on presented comorbidities</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">simulate_ehr_practices</td>
              <td align="left" rowspan="1" colspan="1">Generate a simulated dataframe of primary care practices in the same format as is used in the CPRD</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">simulate_ehr_consultations</td>
              <td align="left" rowspan="1" colspan="1">Generates simulated GP consultation tables</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">simulate_ehr_events</td>
              <td align="left" rowspan="1" colspan="1">Generate simulated events tables</td>
            </tr>
            <tr>
              <td align="left" rowspan="4" colspan="1">ehr_system</td>
              <td align="left" rowspan="1" colspan="1">set_CPRD</td>
              <td align="left" rowspan="1" colspan="1">Sets EHR metadata to CPRD format</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">get_EHR_attribute</td>
              <td align="left" rowspan="1" colspan="1">Return the value of an attribute in the .ehr environment</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">set_EHR_attribute</td>
              <td align="left" rowspan="1" colspan="1">Sets the value of an attribute in the .ehr environment</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">list_EHR_attribute</td>
              <td align="left" rowspan="1" colspan="1">Lists all of the EHR attribute names in .ehr</td>
            </tr>
            <tr>
              <td align="left" rowspan="3" colspan="1">matching</td>
              <td align="left" rowspan="1" colspan="1">match_case</td>
              <td align="left" rowspan="1" colspan="1">Selected controls matching a list of variables from a case</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">get_matches</td>
              <td align="left" rowspan="1" colspan="1">Find matched controls for a set of cases</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">match_on_index</td>
              <td align="left" rowspan="1" colspan="1">Function for performing matching of controls to cases using the consultation files to generate a dummy index date for controls</td>
            </tr>
            <tr>
              <td align="left" rowspan="2" colspan="1">prevalence</td>
              <td align="left" rowspan="1" colspan="1">prev_terms</td>
              <td align="left" rowspan="1" colspan="1">Adds columns enabling one to calculate numerators and denominators for prevalence and incidence</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">prev_totals</td>
              <td align="left" rowspan="1" colspan="1">Calculates the prevalence totals for the output of a data frame of events/patients etc</td>
            </tr>
            <tr>
              <td align="left" rowspan="5" colspan="1">select_by_year</td>
              <td align="left" rowspan="1" colspan="1">select_by_year</td>
              <td align="left" rowspan="1" colspan="1">Runs a series of selects over a year range and collects in a list of dataframes</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">build_date_fn</td>
              <td align="left" rowspan="1" colspan="1">Function to build start/enddate helper fuctions</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">qof_years_fn</td>
              <td align="left" rowspan="1" colspan="1">Helper function providing startdate and enddate for QOF years</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">qof_15_month_fn</td>
              <td align="left" rowspan="1" colspan="1">Helper function providing startdate and enddate for QOF 15 month periods</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">standard_years_fn</td>
              <td align="left" rowspan="1" colspan="1">Helper function providing startdate and enddate for calendar years</td>
            </tr>
            <tr>
              <td align="left" rowspan="3" colspan="1">select_events</td>
              <td align="left" rowspan="1" colspan="1">select_events</td>
              <td align="left" rowspan="1" colspan="1">Extracts from the database</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">first_events</td>
              <td align="left" rowspan="1" colspan="1">Selects the earliest event grouped by patient</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">last_events</td>
              <td align="left" rowspan="1" colspan="1">Selects the latest event grouped by patient</td>
            </tr>
            <tr>
              <td align="left" rowspan="6" colspan="1">temp_tables</td>
              <td align="left" rowspan="1" colspan="1">temp_table</td>
              <td align="left" rowspan="1" colspan="1">Creates a temporary table in the database</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">append_to_temp_table</td>
              <td align="left" rowspan="1" colspan="1">Appends rows to a temporary table</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">to_temp_table</td>
              <td align="left" rowspan="1" colspan="1">Send a dataframe to a temporary table in the database</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">drop_temp_table</td>
              <td align="left" rowspan="1" colspan="1">Checks if a temporary table exists and then deletes if it does</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">drop_all_temp_tables</td>
              <td align="left" rowspan="1" colspan="1">Checks if any temporary tables exist and then deletes all</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">temp_location</td>
              <td align="left" rowspan="1" colspan="1">Sets location of the db temporary store for temporary tables</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">uniform_units</td>
              <td align="left" rowspan="1" colspan="1">cprd_uniform_hba1c_values</td>
              <td align="left" rowspan="1" colspan="1">Standardises HbA1C values to mmol/mol</td>
            </tr>
            <tr>
              <td align="left" rowspan="7" colspan="1">utils</td>
              <td align="left" rowspan="1" colspan="1">compress</td>
              <td align="left" rowspan="1" colspan="1">Compresses a dataframe to make more efficient use of resources</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">to_stata</td>
              <td align="left" rowspan="1" colspan="1">Compresses a dataframe and saves in stata format. Options to save as Stata 12 or 13</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">wrap_sql_query</td>
              <td align="left" rowspan="1" colspan="1">Combines strings and vectors in a sensible way for select queries</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">expand_string</td>
              <td align="left" rowspan="1" colspan="1">Reads strings and expands sections wrapped in dotted parentheses</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">convert_dates</td>
              <td align="left" rowspan="1" colspan="1">Converts date fields from ISO character string format to R Date format</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">export_fn</td>
              <td align="left" rowspan="1" colspan="1">Exports to a variety of formats based on the file type argument</td>
            </tr>
            <tr>
              <td align="left" rowspan="1" colspan="1">flat_files</td>
              <td align="left" rowspan="1" colspan="1">Exports flat files from the database. One file per practice</td>
            </tr>
          </tbody>
        </table>
      </alternatives>
    </table-wrap>
    <sec id="sec022">
      <title>7.1 Limitations and future work</title>
      <p>Although rEHR is currently only tested with CPRD data, the <monospace>.ehr</monospace> environment system will allow it to be easily linked to other EHR databases. For future versions of the <monospace>rEHR</monospace> software we will consider:</p>
      <list list-type="bullet">
        <list-item>
          <p>Implementation of the <monospace>repsample</monospace> algorithm for representative sampling of practices [<xref rid="pone.0171784.ref026" ref-type="bibr">26</xref>].</p>
        </list-item>
        <list-item>
          <p>Iterative proportional fitting for matching on population characteristics between different EHR databases [<xref rid="pone.0171784.ref008" ref-type="bibr">8</xref>].</p>
        </list-item>
        <list-item>
          <p>A robust algorithm for determining smoking status.</p>
        </list-item>
        <list-item>
          <p>Interfaces to other EHR systems, in particular UK primary care databases such as THIN, QResearch and Research One.</p>
        </list-item>
        <list-item>
          <p>Uniform units functions for other clinical measurements such as blood pressure, cholesterol and serum creatinine.</p>
        </list-item>
        <list-item>
          <p>Probabilistic or other matching for patient record linkage.</p>
        </list-item>
      </list>
    </sec>
  </sec>
  <sec id="sec023">
    <title>Ethics and consent statement</title>
    <p>This study is based on data from the Clinical Practice Research Datalink (CPRD) obtained under licence from the UK Medicines and Healthcare products Regulatory Agency. However, the interpretation and conclusions contained in this paper are those of the authors alone. The study was approved by the independent scientific advisory committee (ISAC) for CPRD research (reference number: 16_115R). No further ethics approval was required for the analysis of the data.</p>
  </sec>
</body>
<back>
  <ack>
    <p>This study was funded by the National Institute for Health Research (NIHR) School for Primary Care Research (SPCR), under the title ‘An analytical framework for increasing the efficiency and validity of research using primary care databases’ (Project no. 211). This paper presents independent research funded by the National Institute for Health Research (NIHR). The views expressed are those of the authors and not necessarily those of the NHS, the National Institute for Health Research or the Department of Health. In addition, MRC Health eResearch Centre Grant MR/K006665/1 supported the time and facilities of one investigator (EK).</p>
  </ack>
  <ref-list>
    <title>References</title>
    <ref id="pone.0171784.ref001">
      <label>1</label>
      <mixed-citation publication-type="book"><collab>R Core Team</collab>. <source>R: A Language and Environment for Statistical Computing</source>; <year>2014</year> Available from: <ext-link ext-link-type="uri" xlink:href="http://www.R-project.org/">http://www.R-project.org/</ext-link>.</mixed-citation>
    </ref>
    <ref id="pone.0171784.ref002">
      <label>2</label>
      <mixed-citation publication-type="journal"><name><surname>Herrett</surname><given-names>E</given-names></name>, <name><surname>Gallagher</surname><given-names>AM</given-names></name>, <name><surname>Bhaskaran</surname><given-names>K</given-names></name>, <name><surname>Forbes</surname><given-names>H</given-names></name>, <name><surname>Mathur</surname><given-names>R</given-names></name>, <name><surname>van Staa</surname><given-names>T</given-names></name>, <etal>et al</etal><article-title>Data resource profile: clinical practice research datalink (CPRD)</article-title>. <source>International journal of epidemiology</source>. <year>2015</year>;<volume>44</volume>(<issue>3</issue>):<fpage>827</fpage>–<lpage>836</lpage>. <pub-id pub-id-type="doi">10.1093/ije/dyv098</pub-id><?supplied-pmid 26050254?><pub-id pub-id-type="pmid">26050254</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref003">
      <label>3</label>
      <mixed-citation publication-type="journal"><name><surname>Kontopantelis</surname><given-names>E</given-names></name>, <name><surname>Buchan</surname><given-names>I</given-names></name>, <name><surname>Reeves</surname><given-names>D</given-names></name>, <name><surname>Checkland</surname><given-names>K</given-names></name>, <name><surname>Doran</surname><given-names>T</given-names></name>. <article-title>Relationship between quality of care and choice of clinical computing system: retrospective analysis of family practice performance under the UK’s quality and outcomes framework</article-title>. <source>BMJ open</source>. <year>2013</year>;<volume>3</volume>(<issue>8</issue>):<fpage>e003190</fpage><pub-id pub-id-type="doi">10.1136/bmjopen-2013-003190</pub-id><?supplied-pmid 23913774?><pub-id pub-id-type="pmid">23913774</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref004">
      <label>4</label>
      <mixed-citation publication-type="journal"><name><surname>Kontopantelis</surname><given-names>E</given-names></name>, <name><surname>Springate</surname><given-names>D</given-names></name>, <name><surname>Reeves</surname><given-names>D</given-names></name>, <name><surname>Ashcroft</surname><given-names>DM</given-names></name>, <name><surname>Valderas</surname><given-names>JM</given-names></name>, <name><surname>Doran</surname><given-names>T</given-names></name>. <article-title>Withdrawing performance indicators: retrospective analysis of general practice performance under UK Quality and Outcomes Framework</article-title>. <source>Bmj</source>. <year>2014</year>;<volume>348</volume>:<fpage>g330</fpage><pub-id pub-id-type="doi">10.1136/bmj.g330</pub-id><?supplied-pmid 24468469?><pub-id pub-id-type="pmid">24468469</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref005">
      <label>5</label>
      <mixed-citation publication-type="journal"><name><surname>Danaei</surname><given-names>G</given-names></name>, <name><surname>RodrÃguez</surname><given-names>LAG</given-names></name>, <name><surname>Cantero</surname><given-names>OF</given-names></name>, <name><surname>Logan</surname><given-names>R</given-names></name>, <name><surname>HernÃ¡n</surname><given-names>MA</given-names></name>. <article-title>Observational data for comparative effectiveness research: An emulation of randomised trials of statins and primary prevention of coronary heart disease</article-title>. <source>Statistical Methods in Medical Research</source>. <year>2013</year>;<volume>22</volume>(<issue>1</issue>):<fpage>70</fpage>–<lpage>96</lpage>. <pub-id pub-id-type="doi">10.1177/0962280211403603</pub-id><?supplied-pmid 22016461?><pub-id pub-id-type="pmid">22016461</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref006">
      <label>6</label>
      <mixed-citation publication-type="journal"><name><surname>Zorych</surname><given-names>I</given-names></name>, <name><surname>Madigan</surname><given-names>D</given-names></name>, <name><surname>Ryan</surname><given-names>P</given-names></name>, <name><surname>Bate</surname><given-names>A</given-names></name>. <article-title>Disproportionality methods for pharmacovigilance in longitudinal observational databases</article-title>. <source>Statistical Methods in Medical Research</source>. <year>2013</year>;<volume>22</volume>(<issue>1</issue>):<fpage>39</fpage>–<lpage>56</lpage>. <pub-id pub-id-type="doi">10.1177/0962280211403602</pub-id><?supplied-pmid 21878461?><pub-id pub-id-type="pmid">21878461</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref007">
      <label>7</label>
      <mixed-citation publication-type="journal"><name><surname>Reeves</surname><given-names>D</given-names></name>, <name><surname>Springate</surname><given-names>DA</given-names></name>, <name><surname>Ashcroft</surname><given-names>DM</given-names></name>, <name><surname>Ryan</surname><given-names>R</given-names></name>, <name><surname>Doran</surname><given-names>T</given-names></name>, <name><surname>Morris</surname><given-names>R</given-names></name>, <etal>et al</etal><article-title>Can analyses of electronic patient records be independently and externally validated? The effect of statins on the mortality of patients with ischaemic heart disease: a cohort study with nested caseâ€“control analysis</article-title>. <source>BMJ Open</source>. <year>2014</year>;<volume>4</volume>(<issue>4</issue>). <pub-id pub-id-type="doi">10.1136/bmjopen-2014-004952</pub-id><?supplied-pmid 24760353?><pub-id pub-id-type="pmid">24760353</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref008">
      <label>8</label>
      <mixed-citation publication-type="journal"><name><surname>Springate</surname><given-names>DA</given-names></name>, <name><surname>Ashcroft</surname><given-names>DM</given-names></name>, <name><surname>Kontopantelis</surname><given-names>E</given-names></name>, <name><surname>Doran</surname><given-names>T</given-names></name>, <name><surname>Ryan</surname><given-names>R</given-names></name>, <name><surname>Reeves</surname><given-names>D</given-names></name>. <article-title>Can analyses of electronic patient records be independently and externally validated? Study 2â€”the effect of <italic>B</italic>-adrenoceptor blocker therapy on cancer survival: a retrospective cohort study</article-title>. <source>BMJ Open</source>. <year>2015</year>;<volume>5</volume>(<issue>4</issue>). <pub-id pub-id-type="doi">10.1136/bmjopen-2014-007299</pub-id><?supplied-pmid 25869690?><pub-id pub-id-type="pmid">25869690</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref009">
      <label>9</label>
      <mixed-citation publication-type="journal"><name><surname>Springate</surname><given-names>DA</given-names></name>, <name><surname>Kontopantelis</surname><given-names>E</given-names></name>, <name><surname>Ashcroft</surname><given-names>DM</given-names></name>, <name><surname>Olier</surname><given-names>I</given-names></name>, <name><surname>Parisi</surname><given-names>R</given-names></name>, <name><surname>Chamapiwa</surname><given-names>E</given-names></name>, <etal>et al</etal><article-title>ClinicalCodes: An Online Clinical Codes Repository to Improve the Validity and Reproducibility of Research Using Electronic Medical Records</article-title>. <source>PLoS ONE</source>. <year>2014</year>;<volume>9</volume>(<issue>6</issue>):<fpage>e99825</fpage><pub-id pub-id-type="doi">10.1371/journal.pone.0099825</pub-id><?supplied-pmid 24941260?><pub-id pub-id-type="pmid">24941260</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref010">
      <label>10</label>
      <mixed-citation publication-type="journal"><name><surname>Davé</surname><given-names>S</given-names></name>, <name><surname>Petersen</surname><given-names>I</given-names></name>. <article-title>Creating medical and drug code lists to identify cases in primary care databases</article-title>. <source>Pharmacoepidemiology and Drug Safety</source>. <year>2009</year>;<volume>18</volume>(<issue>8</issue>):<fpage>704</fpage>–<lpage>707</lpage>. <pub-id pub-id-type="doi">10.1002/pds.1770</pub-id><?supplied-pmid 19455565?><pub-id pub-id-type="pmid">19455565</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref011">
      <label>11</label>
      <mixed-citation publication-type="journal"><name><surname>Overhage</surname><given-names>JM</given-names></name>, <name><surname>Overhage</surname><given-names>LM</given-names></name>. <article-title>Sensible use of observational clinical data</article-title>. <source>Statistical Methods in Medical Research</source>. <year>2013</year>;<volume>22</volume>(<issue>1</issue>):<fpage>7</fpage>–<lpage>13</lpage>. <pub-id pub-id-type="doi">10.1177/0962280211403598</pub-id><?supplied-pmid 21828172?><pub-id pub-id-type="pmid">21828172</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref012">
      <label>12</label>
      <mixed-citation publication-type="journal"><name><surname>Perlis</surname><given-names>RH</given-names></name>, <name><surname>Iosifescu</surname><given-names>DV</given-names></name>, <name><surname>Castro</surname><given-names>VM</given-names></name>, <name><surname>Murphy</surname><given-names>SN</given-names></name>, <name><surname>Gainer</surname><given-names>VS</given-names></name>, <name><surname>Minnier</surname><given-names>J</given-names></name>, <etal>et al</etal><article-title>Using electronic medical records to enable large-scale studies in psychiatry: treatment resistant depression as a model</article-title>. <source>Psychological Medicine</source>. <year>2012</year>;<volume>42</volume>:<fpage>41</fpage>–<lpage>50</lpage>. <pub-id pub-id-type="doi">10.1017/S0033291711000997</pub-id><?supplied-pmid 21682950?><pub-id pub-id-type="pmid">21682950</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref013">
      <label>13</label>
      <mixed-citation publication-type="journal"><name><surname>Ainsworth</surname><given-names>J</given-names></name>, <name><surname>Cunningham</surname><given-names>J</given-names></name>, <name><surname>Buchan</surname><given-names>I</given-names></name>. <article-title>eLab: Bringing Together People, Data and Methods to Enhance Knowledge Discovery in Healthcare Settings</article-title>. <source>Studies in health technology and informatics</source>. <year>2012</year>;<volume>175</volume>:<fpage>39</fpage>–<lpage>48</lpage>. <?supplied-pmid 22941986?><pub-id pub-id-type="pmid">22941986</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref014">
      <label>14</label>
      <mixed-citation publication-type="journal"><name><surname>Bechhofer</surname><given-names>S</given-names></name>, <name><surname>Buchan</surname><given-names>I</given-names></name>, <name><surname>De Roure</surname><given-names>D</given-names></name>, <name><surname>Missier</surname><given-names>P</given-names></name>, <name><surname>Ainsworth</surname><given-names>J</given-names></name>, <name><surname>Bhagat</surname><given-names>J</given-names></name>, <etal>et al</etal><article-title>Why linked data is not enough for scientists</article-title>. <source>Future Generation Computer Systems</source>. <year>2013</year>;<volume>29</volume>(<issue>2</issue>):<fpage>599</fpage>–<lpage>611</lpage>. <pub-id pub-id-type="doi">10.1016/j.future.2011.08.004</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref015">
      <label>15</label>
      <mixed-citation publication-type="other">Wickham H, Francois R. dplyr: A Grammar of Data Manipulation; 2015. Available from: <ext-link ext-link-type="uri" xlink:href="http://CRAN.R-project.org/package=dplyr">http://CRAN.R-project.org/package=dplyr</ext-link>.</mixed-citation>
    </ref>
    <ref id="pone.0171784.ref016">
      <label>16</label>
      <mixed-citation publication-type="other">Grothendieck G. sqldf: Perform SQL Selects on R Data Frames; 2014. Available from: <ext-link ext-link-type="uri" xlink:href="http://CRAN.R-project.org/package=sqldf">http://CRAN.R-project.org/package=sqldf</ext-link>.</mixed-citation>
    </ref>
    <ref id="pone.0171784.ref017">
      <label>17</label>
      <mixed-citation publication-type="other">Wickham H, Chang W. devtools: Tools to make developing R code easier; 2014. Available from: <ext-link ext-link-type="uri" xlink:href="http://CRAN.R-project.org/package=devtools">http://CRAN.R-project.org/package=devtools</ext-link>.</mixed-citation>
    </ref>
    <ref id="pone.0171784.ref018">
      <label>18</label>
      <mixed-citation publication-type="other">James DA, Falcon S, the authors of SQLite. RSQLite: SQLite interface for R; 2013. Available from: <ext-link ext-link-type="uri" xlink:href="http://CRAN.R-project.org/package=RSQLite">http://CRAN.R-project.org/package=RSQLite</ext-link>.</mixed-citation>
    </ref>
    <ref id="pone.0171784.ref019">
      <label>19</label>
      <mixed-citation publication-type="journal"><name><surname>Olier</surname><given-names>I</given-names></name>, <name><surname>Springate</surname><given-names>DA</given-names></name>, <name><surname>Reeves</surname><given-names>D</given-names></name>, <name><surname>Ashcroft</surname><given-names>DM</given-names></name>, <name><surname>Doran</surname><given-names>T</given-names></name>, <name><surname>Reilly</surname><given-names>S</given-names></name>, <etal>et al</etal><article-title>Modelling Conditions and Health Care Processes in Electronic Health Records: An Application to Severe Mental Illness with the Clinical Practice Research Datalink</article-title>. <source>PLoS ONE</source>. <year>2016</year>;. <pub-id pub-id-type="doi">10.1371/journal.pone.0146715</pub-id><?supplied-pmid 26918439?><pub-id pub-id-type="pmid">26918439</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref020">
      <label>20</label>
      <mixed-citation publication-type="journal"><name><surname>Doran</surname><given-names>T</given-names></name>, <name><surname>Fullwood</surname><given-names>C</given-names></name>, <name><surname>Gravelle</surname><given-names>H</given-names></name>, <name><surname>Reeves</surname><given-names>D</given-names></name>, <name><surname>Kontopantelis</surname><given-names>E</given-names></name>, <name><surname>Hiroeh</surname><given-names>U</given-names></name>, <etal>et al</etal><article-title>Pay-for-performance programs in family practices in the United Kingdom</article-title>. <source>N Engl J Med</source>. <year>2006</year>;<volume>355</volume>(<issue>4</issue>):<fpage>375</fpage>–<lpage>384</lpage>. <pub-id pub-id-type="doi">10.1056/NEJMsa055505</pub-id><?supplied-pmid 16870916?><pub-id pub-id-type="pmid">16870916</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref021">
      <label>21</label>
      <mixed-citation publication-type="journal"><name><surname>Richardson</surname><given-names>DB</given-names></name>. <article-title>An incidence density sampling program for nested case-control analyses</article-title>. <source>Occupational and Environmental Medicine</source>. <year>2004</year>;<volume>61</volume>(<issue>12</issue>):<fpage>e59</fpage><pub-id pub-id-type="doi">10.1136/oem.2004.014472</pub-id><?supplied-pmid 15550597?><pub-id pub-id-type="pmid">15550597</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref022">
      <label>22</label>
      <mixed-citation publication-type="journal"><name><surname>Parisi</surname><given-names>R</given-names></name>, <name><surname>Rutter</surname><given-names>MK</given-names></name>, <name><surname>Lunt</surname><given-names>M</given-names></name>, <name><surname>Young</surname><given-names>HS</given-names></name>, <name><surname>Symmons</surname><given-names>DP</given-names></name>, <name><surname>Griffiths</surname><given-names>CE</given-names></name>, <etal>et al</etal><article-title>Psoriasis and the Risk of Major Cardiovascular Events: Cohort Study Using the Clinical Practice Research Datalink</article-title>. <source>Journal of Investigative Dermatology</source>. <year>2015</year>;. <pub-id pub-id-type="doi">10.1038/jid.2015.87</pub-id><?supplied-pmid 25742120?><pub-id pub-id-type="pmid">25742120</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref023">
      <label>23</label>
      <mixed-citation publication-type="journal"><name><surname>Gelfand</surname><given-names>JM</given-names></name>, <name><surname>Neimann</surname><given-names>AL</given-names></name>, <name><surname>Shin</surname><given-names>DB</given-names></name>, <name><surname>Wang</surname><given-names>X</given-names></name>, <name><surname>Margolis</surname><given-names>DJ</given-names></name>, <name><surname>Troxel</surname><given-names>AB</given-names></name>. <article-title>Risk of myocardial infarction in patients with psoriasis</article-title>. <source>JAMA</source>. <year>2006</year>;<volume>296</volume>(<issue>14</issue>):<fpage>1735</fpage>–<lpage>1741</lpage>. <pub-id pub-id-type="doi">10.1001/jama.296.14.1735</pub-id><?supplied-pmid 17032986?><pub-id pub-id-type="pmid">17032986</pub-id></mixed-citation>
    </ref>
    <ref id="pone.0171784.ref024">
      <label>24</label>
      <mixed-citation publication-type="other">Bendix Carstensen EL Martyn Plummer, Hills M. Epi: A Package for Statistical Analysis in Epidemiology; 2014. Available from: <ext-link ext-link-type="uri" xlink:href="http://CRAN.R-project.org/package=Epi">http://CRAN.R-project.org/package=Epi</ext-link>.</mixed-citation>
    </ref>
    <ref id="pone.0171784.ref025">
      <label>25</label>
      <mixed-citation publication-type="book"><name><surname>Kontopantelis</surname><given-names>E</given-names></name>, <name><surname>Springate</surname><given-names>DA</given-names></name>, <name><surname>Reeves</surname><given-names>D</given-names></name>, <name><surname>Ashcroft</surname><given-names>DM</given-names></name>, <name><surname>Rutter</surname><given-names>M</given-names></name>, <name><surname>Buchan</surname><given-names>I</given-names></name>, <etal>et al</etal><chapter-title>Glucose, blood pressure and cholesterol levels and their relationships to clinical outcomes in type 2 diabetes: a retrospective cohort study</chapter-title><source>Diabetologia</source>. <year>2014</year>; p. <fpage>1</fpage>–<lpage>14</lpage>.</mixed-citation>
    </ref>
    <ref id="pone.0171784.ref026">
      <label>26</label>
      <mixed-citation publication-type="journal"><name><surname>Kontopantelis</surname><given-names>E</given-names></name>. <article-title>A Greedy Algorithm for Representative Sampling: repsample in Stata</article-title>. <source>Journal of Statistical Software</source>. <year>2013</year>;<volume>55</volume>(<issue>1</issue>).</mixed-citation>
    </ref>
  </ref-list>
</back>
