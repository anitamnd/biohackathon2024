<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.1 20151215//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.1?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">Bioinformatics</journal-id>
    <journal-id journal-id-type="publisher-id">bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1367-4803</issn>
    <issn pub-type="epub">1367-4811</issn>
    <publisher>
      <publisher-name>Oxford University Press</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6298046</article-id>
    <article-id pub-id-type="pmid">30010780</article-id>
    <article-id pub-id-type="doi">10.1093/bioinformatics/bty622</article-id>
    <article-id pub-id-type="publisher-id">bty622</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Applications Notes</subject>
        <subj-group subj-group-type="category-toc-heading">
          <subject>Bioimage Informatics</subject>
        </subj-group>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>SPUTNIK: an R package for filtering of spatially related peaks in mass spectrometry imaging data</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Inglese</surname>
          <given-names>Paolo</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
        <xref ref-type="corresp" rid="bty622-cor1"/>
        <!--<email>p.inglese14@imperial.ac.uk</email>-->
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Correia</surname>
          <given-names>Gonçalo</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Takats</surname>
          <given-names>Zoltan</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Nicholson</surname>
          <given-names>Jeremy K</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Glen</surname>
          <given-names>Robert C</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
        <!--<email>r.glen@imperial.ac.uk</email>-->
        <xref ref-type="corresp" rid="bty622-cor1"/>
      </contrib>
    </contrib-group>
    <contrib-group>
      <contrib contrib-type="editor">
        <name>
          <surname>Murphy</surname>
          <given-names>Robert</given-names>
        </name>
        <role>Associate Editor</role>
      </contrib>
    </contrib-group>
    <aff id="aff1">Computational and System Medicine, Department of Surgery and Cancer, Imperial College London, London, UK</aff>
    <author-notes>
      <corresp id="bty622-cor1">To whom correspondence should be addressed. <email>p.inglese14@imperial.ac.uk</email> or <email>r.glen@imperial.ac.uk</email></corresp>
    </author-notes>
    <pub-date pub-type="ppub">
      <day>01</day>
      <month>1</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="epub" iso-8601-date="2018-07-13">
      <day>13</day>
      <month>7</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>13</day>
      <month>7</month>
      <year>2018</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on the <pub-date pub-type="epub"/>. -->
    <volume>35</volume>
    <issue>1</issue>
    <fpage>178</fpage>
    <lpage>180</lpage>
    <history>
      <date date-type="received">
        <day>16</day>
        <month>2</month>
        <year>2018</year>
      </date>
      <date date-type="rev-recd">
        <day>18</day>
        <month>6</month>
        <year>2018</year>
      </date>
      <date date-type="accepted">
        <day>10</day>
        <month>7</month>
        <year>2018</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2018. Published by Oxford University Press.</copyright-statement>
      <copyright-year>2018</copyright-year>
      <license license-type="cc-by" xlink:href="http://creativecommons.org/licenses/by/4.0/">
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted reuse, distribution, and reproduction in any medium, provided the original work is properly cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="bty622.pdf"/>
    <abstract>
      <title>Abstract</title>
      <sec id="s1">
        <title>Summary</title>
        <p><italic>SPUTNIK</italic> is an R package consisting of a series of tools to filter mass spectrometry imaging peaks characterized by a noisy or unlikely spatial distribution. SPUTNIK can produce mass spectrometry imaging datasets characterized by a smaller but more informative set of peaks, reduce the complexity of subsequent multi-variate analysis and increase the interpretability of the statistical results.</p>
      </sec>
      <sec id="s2">
        <title>Availability and implementation</title>
        <p><italic>SPUTNIK</italic> is freely available online from CRAN repository and at <ext-link ext-link-type="uri" xlink:href="https://github.com/paoloinglese/SPUTNIK">https://github.com/paoloinglese/SPUTNIK</ext-link>. The package is distributed under the GNU General Public License version 3 and is accompanied by example files and data.</p>
      </sec>
      <sec id="s3">
        <title>Supplementary information</title>
        <p><xref ref-type="supplementary-material" rid="sup1">Supplementary data</xref> are available at <italic>Bioinformatics</italic> online.</p>
      </sec>
    </abstract>
    <funding-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Cancer Research UK</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000289</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Institute for Health Research</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000272</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Imperial Biomedical Research Centre</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Institute for Health Research</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000272</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Imperial Biomedical Research Centre</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">NHS</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Institute for Health Research</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000272</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Department of Health</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000276</named-content>
        </funding-source>
      </award-group>
    </funding-group>
    <counts>
      <page-count count="3"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec sec-type="intro">
    <title>1 Introduction</title>
    <p>Over the last few years, mass spectrometry imaging (MSI or IMS) has demonstrated great potential in discovering and elucidating chemical processes in a wide variety of research contexts. MSI has been used to determine possible cancer biomarkers (<xref rid="bty622-B6" ref-type="bibr">Franck <italic>et al.</italic>, 2009</xref>), and recent technologies are capable of detecting molecular signals at the cellular level (<xref rid="bty622-B9" ref-type="bibr">Kompauer <italic>et al.</italic>, 2017</xref>). The properties of such data type, such as high ion dimensionality and the presence of noise fluctuations in the spectral profiles, make the pre-processing phase and the extraction of informative features for the subsequent statistical analysis extremely important.</p>
    <p>Software packages, such as <italic>MALDIquant</italic> (<xref rid="bty622-B7" ref-type="bibr">Gibb and Strimmer, 2012</xref>) can filter peaks based on the presence of signals in a minimum fraction of samples, but unfortunately these filters do not to take into account the information contained in the spatial localization of the signals as addressed in recent work (<xref rid="bty622-B1" ref-type="bibr">Alexandrov and Bartels, 2013</xref>; <xref rid="bty622-B5" ref-type="bibr">Fonville <italic>et al.</italic>, 2012</xref>; <xref rid="bty622-B12" ref-type="bibr">Palmer <italic>et al.</italic>, 2017</xref>).</p>
    <p><italic>SPUTNIK (SPatially aUTomatic deNoising for Ims toolKit)</italic> provides a series of filters which aim select meaningful and informative peaks, based on the plausibility of their spatial distributions, given the information about the signal source (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Table S1</xref>). It provides an estimation of split peaks, a correlation-based filter, a pixel count based filter and a series of tests based on complete spatial randomness. Each class of filters is designed to remove uninformative peaks based on specific assumptions. An example of the effects of each filter (with the default parameters) on the final dimensionality of two example datasets (MALDI-MSI and DESI-MSI) is shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Figure S1</xref>. <italic>SPUTNIK</italic> is freely distributed as an R package written using S4 object-oriented programming.</p>
    <p>Two example workflows showing how to apply SPUTNIK to both MALDI-MSI and DESI-MSI datasets are provided together with the package (<xref ref-type="supplementary-material" rid="sup2">Supplementary Materials S2</xref> and <xref ref-type="supplementary-material" rid="sup2">S3</xref>). The original imzML and the associated optical image files for the MALDI-MSI dataset are available at <ext-link ext-link-type="uri" xlink:href="https://www.ebi.ac.uk/pride/archive/projects/PXD001283/">https://www.ebi.ac.uk/pride/archive/projects/PXD001283/</ext-link>.</p>
    <p>An example of the application of the SPUTNIK pipeline to MALDI-MSI from mouse urinary bladder specimen (<xref rid="bty622-B13" ref-type="bibr">Rompp <italic>et al.</italic>, 2010</xref>) is shown in <xref ref-type="fig" rid="bty622-F1">Figure 1</xref> (see complete workflow in <xref ref-type="supplementary-material" rid="sup2">Supplementary Material S2</xref>). The sum of the matched peaks intensities (pre-processed using MALDIquant) was used as a reference for determining the tissue specimen location and ROI detection. The ROI quality was visually evaluated comparing its morphology with an external tissue image (e.g. optical image of H&amp;E stained tissue). The dataset was filtered using a correlation-based filter (reference = binary ROI calculated by k-means, measure = Spearman’s correlation, threshold = 0); followed by a count pixels filter with a minimum number of connected pixels equal to 4. Finally, a complete spatial randomness filter was applied using the Kolmogorov-Smirnov test with the total ion count image as a covariate; Bonferroni corrected <italic>P</italic>-values (α = 0.001) were used to select the peaks. The pipeline was capable of reducing the dimensionality from 1175 peaks to 204 peaks. Visualization of the filtered dataset and analyses based on the reduced number of peaks result in images with enhanced contrast (<xref ref-type="fig" rid="bty622-F1">Fig. 1</xref>B and C). This also provided improved clustering results, with an enhanced contrast due to the removal of signals associated with noise. A complete workflow of the application of SPUTNIK on the example DESI-MSI dataset is available in <xref ref-type="supplementary-material" rid="sup2">Supplementary Material S3</xref>.
</p>
    <fig id="bty622-F1" orientation="portrait" position="float">
      <label>Fig. 1.</label>
      <caption>
        <p>A comparison between the original and the filtered MALDI-MSI dataset (<xref rid="bty622-B13" ref-type="bibr">Rompp <italic>et al.</italic>, 2010</xref>): (A) total ion count (TIC) images, (B) RGB images of the three first principal components scores scaled in [0, 1] and (C) results of k-means clustering with four clusters applied to the PCA scores responsible for 95% of the total variance. The heatmaps (D) show the intensities of five filtered (top row) and five selected peaks (bottom row) with the five largest average intensities (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Fig. S6</xref>). The images of the filtered peaks show that they are mainly localized outside of the tissue region. All the results confirm that the filters reduce the effect of signal noise and allow a clear identification of tissue sub-structures</p>
      </caption>
      <graphic xlink:href="bty622f1"/>
    </fig>
  </sec>
  <sec>
    <title>2 Algorithms details</title>
    <sec>
      <title>2.1 Split peak estimation</title>
      <p>Random peak shifting can generate false multiple peaks during the peak-matching procedure. These peaks signals, which represent the same ion source, are assigned to multiple m/z values. In order to identify the occurrence of this issue, we hypothesized that split peaks are randomly assigned to contiguous m/z values within the limits of instrumental error. Additional conditions to assign multiple peaks to the same m/z value are: (i) their peak intensity signals are localized in small or non-overlapping spatial regions, (ii) at least one of the peaks signal images shows a sufficient level of ‘spatial regularity’, (iii) the combined signal, generated by merging the intensities of the candidate split peaks, is associated with an image with a spatial regularity at least as high as the images associated with the original peaks. Spatial regularity measures available are: (i) ratio of scattered pixels (defined as the number of Otsu’s thresholded (<xref rid="bty622-B11" ref-type="bibr">Otsu, 1975</xref>) disconnected signal pixels divided by the total number of signal pixels), (ii) spatial chaos (<xref rid="bty622-B12" ref-type="bibr">Palmer <italic>et al.</italic>, 2017</xref>), (iii) Gini index (<xref rid="bty622-B8" ref-type="bibr">Hurley and Rickard, 2009</xref>). An example of simulated split peak merging from the DESI-MSI sample is shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Figure S2</xref>. Based on its purpose, the split peak tool should always be applied before any other filtering tool.</p>
    </sec>
    <sec>
      <title>2.2 Reference similarity filter</title>
      <p>Often, signals derived from non-informative peaks (e.g. matrix or solvent related peaks) are characterized by an unrelated spatial distribution compared to the geometrical shape of the expected signal source (e.g. a tissue section). In order to identify and remove these peaks, we designed a filter based on the similarity between the peak intensity images and a reference image. Available measures to estimate the similarity between the peak and the reference signal distributions are: Pearson’s correlation, Spearman’s correlation, structural similarity index measure (<xref rid="bty622-B14" ref-type="bibr">Wang <italic>et al.</italic>, 2004</xref>) and normalized mutual information. Two options are available for calculating the reference signal, a continuous measure among ‘sum’, ‘median’, ‘mean’ or ‘first principal component scores’ of the entire set of peak intensities, and a binary mask, representing the region of interest (ROI), calculated either applying Otsu’s thresholding to the reference signal seen as an image, or applying k-means clustering with two clusters on the entire dataset. Additionally, external reference and ROI images can be used, after opportunely resizing and registering them with the MS image. The command ‘msImage’ allows to easily convert arbitrary images represented as pixel intensity matrices into MS images compatible with SPUTNIK (an example of the filter applied using the ROI generated by the H&amp;E optical image registered with the sum of the ion intensities in the 800–900 m/z range is shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Fig. S3</xref>). By default, a similarity threshold equal to 0 guarantees that ions also localized in small regionswithin the ROI are not filtered. Scaled first three principal components scores image of the filtered peaks data confirm that the filter successfully removes the ions localized outside of the tissue in the DESI-MSI and MALDI-MSI examples (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, Fig. S4). When off-tissue regions are available, the user should run the reference similarity filter before all the other filters. In this way, the dataset dimensionality can be significantly reduced, increasing the global contrast between tissue and off-tissue regions.</p>
    </sec>
    <sec>
      <title>2.3 Pixel count based filter</title>
      <p>The Poisson spatially distributed signals (due to shot-like noise) are characterized by a more scattered spatial distribution than the real signal. Meaningful clusters of pixels should be larger than the expected smallest spatial sub-regions. Under this assumption, we designed a filter that takes into account the number of connected pixels where the peak intensity is higher than the background level. Using a binary ROI mask, calculated similarly to that described in the ‘Reference similarity filter’ section or generated externally (e.g. binarization of the registered optical image of the H&amp;E stained tissue), the connected signal sub-regions are detected from Otsu’s thresholded binary peak image within the ROI. Subsequently, the filter selects those peaks characterized by connected regions larger than the provided number of pixels, which are user-defined based on the expected smallest meaningful image sub-regions. Different levels of ‘aggressiveness’ take into account the clusters size which is also outside of the ROI. When off-tissue regions are not present, pixel count based filter can be used with an ROI consisting of a matrix of all ones (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, Fig. S5).</p>
    </sec>
    <sec>
      <title>2.4 Complete spatial randomness filter</title>
      <p>A further filter is based on the rejection of the null hypothesis of a peak signal following a complete spatial random distribution. The assumption behind these statistical tests is that a non-informative peak signal is spatially distributed as a homogeneous spatial Poisson process (<xref rid="bty622-B10" ref-type="bibr">Maimon and Rokach, 2010</xref>). The tests use Otsu’s thresholded binary pixels associated with the peak signal to define a two-dimensional point pattern process; two tests are currently available: (i) <italic>Clark Evans test</italic> (<xref rid="bty622-B4" ref-type="bibr">Clark and Evans, 1954</xref>), (ii) <italic>Kolmogorov-Smirnov</italic> test against a covariate distribution (<xref rid="bty622-B3" ref-type="bibr">Berman, 1986</xref>), calculated with the same methods used to extract the reference image. The tests are based on the already available <italic>spatstat</italic> R package (<xref rid="bty622-B2" ref-type="bibr">Baddeley and Turner, 2005</xref>). This represents the least aggressive filter, since it does not take into account of the connectivity between pixels and the tissue spatial distribution, but only tests whether ion intensities reflect the overall contrast between the tissue and off-tissue regions. Similarly to the count pixel filter, this filter should be used when off-tissue regions are not available (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, Fig. S5).</p>
      <p>More details about the algorithms are available in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>.</p>
    </sec>
  </sec>
  <sec sec-type="conclusions">
    <title>3 Conclusions</title>
    <p><italic>SPUTNIK</italic> provides a collection of flexible filters for the detection of peaks associated with non-realistic spatial distributions, given the prior information about the signal source localization.</p>
    <p>Two tutorials, distributed with the package, show how to apply the filtering pipeline to MALDI-MSI and DESI-MSI datasets.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="sup1">
      <label>Supplementary Data 1</label>
      <media xlink:href="bty622_supplementary_data_1.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sup2">
      <label>Supplementary Data 2</label>
      <media xlink:href="bty622_supplementary_data_2.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sup3">
      <label>Supplementary Data 3</label>
      <media xlink:href="bty622_supplementary_data_3.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack>
    <title>Acknowledgements</title>
    <p>We would like to thank Dr. Luisa Doria for providing the ovarian cancer DESI MSI dataset included in the package. The ovarian sample was approved by the institutional review board at Imperial College Healthcare National Health Service Trust (Tissue Bank sub-collection number GYN/HG/12/060).</p>
  </ack>
  <sec>
    <title>Funding</title>
    <p>This work was supported by Cancer Research UK Grand Challenge Program (Project title: ‘A Complete Cartography Through Multiscale Molecular Imaging’). The Department of Surgery and Cancer is funded by grants and infrastructure support by the National Institute for Health Research (NIHR) Imperial Biomedical Research Centre (BRC). GC is supported by the National Institute for Health Research (NIHR) Imperial Biomedical Research Centre (BRC). The views expressed in this publication are those of the author(s) and not necessarily those of the NHS, the National Institute for Health Research or the Department of Health.</p>
    <p><bold>Conflict of Interest:</bold> none declared.</p>
  </sec>
  <ref-list>
    <title>References</title>
    <ref id="bty622-B1">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Alexandrov</surname><given-names>T.</given-names></name>, <name name-style="western"><surname>Bartels</surname><given-names>A.</given-names></name></person-group> (<year>2013</year>) 
<article-title>Testing for presence of known and unknown molecules in imaging mass spectrometry</article-title>. <source>Bioinformatics</source><italic>,</italic><volume>29</volume>, <fpage>2335</fpage>–<lpage>2342</lpage>.<pub-id pub-id-type="pmid">23873892</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B2">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Baddeley</surname><given-names>A.</given-names></name>, <name name-style="western"><surname>Turner</surname><given-names>R.</given-names></name></person-group> (<year>2005</year>) 
<article-title>Spatstat: an R package for analyzing spatial point patterns</article-title>. <source>J. Stat. Soft.</source><italic>,</italic><volume>12</volume>, <fpage>1</fpage>–<lpage>42</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B3">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Berman</surname><given-names>M.</given-names></name></person-group> (<year>1986</year>) 
<article-title>Testing for spatial association between a point process and another stochastic-process</article-title>. <source>J. R. Stat. Soc. C Appl.</source><italic>,</italic><volume>35</volume>, <fpage>54</fpage>–<lpage>62</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B4">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Clark</surname><given-names>P.J.</given-names></name>, <name name-style="western"><surname>Evans</surname><given-names>F.C.</given-names></name></person-group> (<year>1954</year>) 
<article-title>Distance to nearest neighbor as a measure of spatial relationships in populations</article-title>. <source>Ecology</source><italic>,</italic><volume>35</volume>, <fpage>445</fpage>–<lpage>453</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B5">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Fonville</surname><given-names>J.M.</given-names></name><etal>et al</etal></person-group> (<year>2012</year>) 
<article-title>Robust data processing and normalization strategy for MALDI mass spectrometric imaging</article-title>. <source>Anal. Chem.</source><italic>,</italic><volume>84</volume>, <fpage>1310</fpage>–<lpage>1319</lpage>.<pub-id pub-id-type="pmid">22148759</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B6">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Franck</surname><given-names>J.</given-names></name><etal>et al</etal></person-group> (<year>2009</year>) 
<article-title>MALDI imaging mass spectrometry: state of the art technology in clinical proteomics</article-title>. <source>Mol. Cell Proteomics</source><italic>,</italic><volume>8</volume>, <fpage>2023</fpage>–<lpage>2033</lpage>.<pub-id pub-id-type="pmid">19451175</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B7">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Gibb</surname><given-names>S.</given-names></name>, <name name-style="western"><surname>Strimmer</surname><given-names>K.</given-names></name></person-group> (<year>2012</year>) 
<article-title>MALDIquant: a versatile R package for the analysis of mass spectrometry data</article-title>. <source>Bioinformatics</source><italic>,</italic><volume>28</volume>, <fpage>2270</fpage>–<lpage>2271</lpage>.<pub-id pub-id-type="pmid">22796955</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B8">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Hurley</surname><given-names>N.</given-names></name>, <name name-style="western"><surname>Rickard</surname><given-names>S.</given-names></name></person-group> (<year>2009</year>) 
<article-title>Comparing measures of sparsity</article-title>. <source>IEEE Trans. Inf. Theory</source><italic>,</italic><volume>55</volume>, <fpage>4723</fpage>–<lpage>4741</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B9">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Kompauer</surname><given-names>M.</given-names></name><etal>et al</etal></person-group> (<year>2017</year>) 
<article-title>Atmospheric pressure MALDI mass spectrometry imaging of tissues and cells at 1.4-mum lateral resolution</article-title>. <source>Nat Methods</source><italic>,</italic><volume>14</volume>, <fpage>90</fpage>–<lpage>96</lpage>.<pub-id pub-id-type="pmid">27842060</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B10">
      <mixed-citation publication-type="book"><person-group person-group-type="author"><name name-style="western"><surname>Maimon</surname><given-names>O.</given-names></name>, <name name-style="western"><surname>Rokach</surname><given-names>L.</given-names></name></person-group> (<year>2010</year>) 
<article-title>Introduction to knowledge discovery and data mining</article-title>. In: <person-group person-group-type="editor"><name name-style="western"><surname>Maimon</surname><given-names>O.</given-names></name>, <name name-style="western"><surname>Rokach</surname><given-names>L.</given-names></name></person-group>, (eds), <source>Data Mining and Knowledge Discovery Handbook</source>. 
<publisher-name>Springer</publisher-name>, 
<publisher-loc>Boston, MA</publisher-loc><fpage>1</fpage>–<lpage>15</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B11">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Otsu</surname><given-names>N.</given-names></name></person-group> (<year>1975</year>) 
<article-title>A threshold selection method from gray-level histograms</article-title>. <source>Automatica</source>, <volume>9</volume>, <fpage>62</fpage>–<lpage> 27</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B12">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Palmer</surname><given-names>A.</given-names></name><etal>et al</etal></person-group> (<year>2017</year>) 
<article-title>FDR-controlled metabolite annotation for high-resolution imaging mass spectrometry</article-title>. <source>Nat. Methods</source><italic>,</italic><volume>14</volume>, <fpage>57</fpage>–<lpage>60</lpage>.<pub-id pub-id-type="pmid">27842059</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B13">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Rompp</surname><given-names>A.</given-names></name><etal>et al</etal></person-group> (<year>2010</year>) 
<article-title>Histology by mass spectrometry: label-free tissue characterization obtained from high-accuracy bioanalytical imaging</article-title>. <source>Angew. Chem. Int. Ed. Engl.</source><italic>,</italic><volume>49</volume>, <fpage>3834</fpage>–<lpage>3838</lpage>.<pub-id pub-id-type="pmid">20397170</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B14">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Wang</surname><given-names>Z.</given-names></name><etal>et al</etal></person-group> (<year>2004</year>) 
<article-title>Image quality assessment: from error visibility to structural similarity</article-title>. <source>IEEE Trans. Image Process.</source><italic>,</italic><volume>13</volume>, <fpage>600</fpage>–<lpage>612</lpage>.<pub-id pub-id-type="pmid">15376593</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.1 20151215//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.1?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">Bioinformatics</journal-id>
    <journal-id journal-id-type="publisher-id">bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1367-4803</issn>
    <issn pub-type="epub">1367-4811</issn>
    <publisher>
      <publisher-name>Oxford University Press</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6298046</article-id>
    <article-id pub-id-type="pmid">30010780</article-id>
    <article-id pub-id-type="doi">10.1093/bioinformatics/bty622</article-id>
    <article-id pub-id-type="publisher-id">bty622</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Applications Notes</subject>
        <subj-group subj-group-type="category-toc-heading">
          <subject>Bioimage Informatics</subject>
        </subj-group>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>SPUTNIK: an R package for filtering of spatially related peaks in mass spectrometry imaging data</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Inglese</surname>
          <given-names>Paolo</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
        <xref ref-type="corresp" rid="bty622-cor1"/>
        <!--<email>p.inglese14@imperial.ac.uk</email>-->
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Correia</surname>
          <given-names>Gonçalo</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Takats</surname>
          <given-names>Zoltan</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Nicholson</surname>
          <given-names>Jeremy K</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Glen</surname>
          <given-names>Robert C</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
        <!--<email>r.glen@imperial.ac.uk</email>-->
        <xref ref-type="corresp" rid="bty622-cor1"/>
      </contrib>
    </contrib-group>
    <contrib-group>
      <contrib contrib-type="editor">
        <name>
          <surname>Murphy</surname>
          <given-names>Robert</given-names>
        </name>
        <role>Associate Editor</role>
      </contrib>
    </contrib-group>
    <aff id="aff1">Computational and System Medicine, Department of Surgery and Cancer, Imperial College London, London, UK</aff>
    <author-notes>
      <corresp id="bty622-cor1">To whom correspondence should be addressed. <email>p.inglese14@imperial.ac.uk</email> or <email>r.glen@imperial.ac.uk</email></corresp>
    </author-notes>
    <pub-date pub-type="ppub">
      <day>01</day>
      <month>1</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="epub" iso-8601-date="2018-07-13">
      <day>13</day>
      <month>7</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>13</day>
      <month>7</month>
      <year>2018</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on the <pub-date pub-type="epub"/>. -->
    <volume>35</volume>
    <issue>1</issue>
    <fpage>178</fpage>
    <lpage>180</lpage>
    <history>
      <date date-type="received">
        <day>16</day>
        <month>2</month>
        <year>2018</year>
      </date>
      <date date-type="rev-recd">
        <day>18</day>
        <month>6</month>
        <year>2018</year>
      </date>
      <date date-type="accepted">
        <day>10</day>
        <month>7</month>
        <year>2018</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2018. Published by Oxford University Press.</copyright-statement>
      <copyright-year>2018</copyright-year>
      <license license-type="cc-by" xlink:href="http://creativecommons.org/licenses/by/4.0/">
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted reuse, distribution, and reproduction in any medium, provided the original work is properly cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="bty622.pdf"/>
    <abstract>
      <title>Abstract</title>
      <sec id="s1">
        <title>Summary</title>
        <p><italic>SPUTNIK</italic> is an R package consisting of a series of tools to filter mass spectrometry imaging peaks characterized by a noisy or unlikely spatial distribution. SPUTNIK can produce mass spectrometry imaging datasets characterized by a smaller but more informative set of peaks, reduce the complexity of subsequent multi-variate analysis and increase the interpretability of the statistical results.</p>
      </sec>
      <sec id="s2">
        <title>Availability and implementation</title>
        <p><italic>SPUTNIK</italic> is freely available online from CRAN repository and at <ext-link ext-link-type="uri" xlink:href="https://github.com/paoloinglese/SPUTNIK">https://github.com/paoloinglese/SPUTNIK</ext-link>. The package is distributed under the GNU General Public License version 3 and is accompanied by example files and data.</p>
      </sec>
      <sec id="s3">
        <title>Supplementary information</title>
        <p><xref ref-type="supplementary-material" rid="sup1">Supplementary data</xref> are available at <italic>Bioinformatics</italic> online.</p>
      </sec>
    </abstract>
    <funding-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Cancer Research UK</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000289</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Institute for Health Research</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000272</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Imperial Biomedical Research Centre</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Institute for Health Research</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000272</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Imperial Biomedical Research Centre</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">NHS</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Institute for Health Research</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000272</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Department of Health</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000276</named-content>
        </funding-source>
      </award-group>
    </funding-group>
    <counts>
      <page-count count="3"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec sec-type="intro">
    <title>1 Introduction</title>
    <p>Over the last few years, mass spectrometry imaging (MSI or IMS) has demonstrated great potential in discovering and elucidating chemical processes in a wide variety of research contexts. MSI has been used to determine possible cancer biomarkers (<xref rid="bty622-B6" ref-type="bibr">Franck <italic>et al.</italic>, 2009</xref>), and recent technologies are capable of detecting molecular signals at the cellular level (<xref rid="bty622-B9" ref-type="bibr">Kompauer <italic>et al.</italic>, 2017</xref>). The properties of such data type, such as high ion dimensionality and the presence of noise fluctuations in the spectral profiles, make the pre-processing phase and the extraction of informative features for the subsequent statistical analysis extremely important.</p>
    <p>Software packages, such as <italic>MALDIquant</italic> (<xref rid="bty622-B7" ref-type="bibr">Gibb and Strimmer, 2012</xref>) can filter peaks based on the presence of signals in a minimum fraction of samples, but unfortunately these filters do not to take into account the information contained in the spatial localization of the signals as addressed in recent work (<xref rid="bty622-B1" ref-type="bibr">Alexandrov and Bartels, 2013</xref>; <xref rid="bty622-B5" ref-type="bibr">Fonville <italic>et al.</italic>, 2012</xref>; <xref rid="bty622-B12" ref-type="bibr">Palmer <italic>et al.</italic>, 2017</xref>).</p>
    <p><italic>SPUTNIK (SPatially aUTomatic deNoising for Ims toolKit)</italic> provides a series of filters which aim select meaningful and informative peaks, based on the plausibility of their spatial distributions, given the information about the signal source (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Table S1</xref>). It provides an estimation of split peaks, a correlation-based filter, a pixel count based filter and a series of tests based on complete spatial randomness. Each class of filters is designed to remove uninformative peaks based on specific assumptions. An example of the effects of each filter (with the default parameters) on the final dimensionality of two example datasets (MALDI-MSI and DESI-MSI) is shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Figure S1</xref>. <italic>SPUTNIK</italic> is freely distributed as an R package written using S4 object-oriented programming.</p>
    <p>Two example workflows showing how to apply SPUTNIK to both MALDI-MSI and DESI-MSI datasets are provided together with the package (<xref ref-type="supplementary-material" rid="sup2">Supplementary Materials S2</xref> and <xref ref-type="supplementary-material" rid="sup2">S3</xref>). The original imzML and the associated optical image files for the MALDI-MSI dataset are available at <ext-link ext-link-type="uri" xlink:href="https://www.ebi.ac.uk/pride/archive/projects/PXD001283/">https://www.ebi.ac.uk/pride/archive/projects/PXD001283/</ext-link>.</p>
    <p>An example of the application of the SPUTNIK pipeline to MALDI-MSI from mouse urinary bladder specimen (<xref rid="bty622-B13" ref-type="bibr">Rompp <italic>et al.</italic>, 2010</xref>) is shown in <xref ref-type="fig" rid="bty622-F1">Figure 1</xref> (see complete workflow in <xref ref-type="supplementary-material" rid="sup2">Supplementary Material S2</xref>). The sum of the matched peaks intensities (pre-processed using MALDIquant) was used as a reference for determining the tissue specimen location and ROI detection. The ROI quality was visually evaluated comparing its morphology with an external tissue image (e.g. optical image of H&amp;E stained tissue). The dataset was filtered using a correlation-based filter (reference = binary ROI calculated by k-means, measure = Spearman’s correlation, threshold = 0); followed by a count pixels filter with a minimum number of connected pixels equal to 4. Finally, a complete spatial randomness filter was applied using the Kolmogorov-Smirnov test with the total ion count image as a covariate; Bonferroni corrected <italic>P</italic>-values (α = 0.001) were used to select the peaks. The pipeline was capable of reducing the dimensionality from 1175 peaks to 204 peaks. Visualization of the filtered dataset and analyses based on the reduced number of peaks result in images with enhanced contrast (<xref ref-type="fig" rid="bty622-F1">Fig. 1</xref>B and C). This also provided improved clustering results, with an enhanced contrast due to the removal of signals associated with noise. A complete workflow of the application of SPUTNIK on the example DESI-MSI dataset is available in <xref ref-type="supplementary-material" rid="sup2">Supplementary Material S3</xref>.
</p>
    <fig id="bty622-F1" orientation="portrait" position="float">
      <label>Fig. 1.</label>
      <caption>
        <p>A comparison between the original and the filtered MALDI-MSI dataset (<xref rid="bty622-B13" ref-type="bibr">Rompp <italic>et al.</italic>, 2010</xref>): (A) total ion count (TIC) images, (B) RGB images of the three first principal components scores scaled in [0, 1] and (C) results of k-means clustering with four clusters applied to the PCA scores responsible for 95% of the total variance. The heatmaps (D) show the intensities of five filtered (top row) and five selected peaks (bottom row) with the five largest average intensities (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Fig. S6</xref>). The images of the filtered peaks show that they are mainly localized outside of the tissue region. All the results confirm that the filters reduce the effect of signal noise and allow a clear identification of tissue sub-structures</p>
      </caption>
      <graphic xlink:href="bty622f1"/>
    </fig>
  </sec>
  <sec>
    <title>2 Algorithms details</title>
    <sec>
      <title>2.1 Split peak estimation</title>
      <p>Random peak shifting can generate false multiple peaks during the peak-matching procedure. These peaks signals, which represent the same ion source, are assigned to multiple m/z values. In order to identify the occurrence of this issue, we hypothesized that split peaks are randomly assigned to contiguous m/z values within the limits of instrumental error. Additional conditions to assign multiple peaks to the same m/z value are: (i) their peak intensity signals are localized in small or non-overlapping spatial regions, (ii) at least one of the peaks signal images shows a sufficient level of ‘spatial regularity’, (iii) the combined signal, generated by merging the intensities of the candidate split peaks, is associated with an image with a spatial regularity at least as high as the images associated with the original peaks. Spatial regularity measures available are: (i) ratio of scattered pixels (defined as the number of Otsu’s thresholded (<xref rid="bty622-B11" ref-type="bibr">Otsu, 1975</xref>) disconnected signal pixels divided by the total number of signal pixels), (ii) spatial chaos (<xref rid="bty622-B12" ref-type="bibr">Palmer <italic>et al.</italic>, 2017</xref>), (iii) Gini index (<xref rid="bty622-B8" ref-type="bibr">Hurley and Rickard, 2009</xref>). An example of simulated split peak merging from the DESI-MSI sample is shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Figure S2</xref>. Based on its purpose, the split peak tool should always be applied before any other filtering tool.</p>
    </sec>
    <sec>
      <title>2.2 Reference similarity filter</title>
      <p>Often, signals derived from non-informative peaks (e.g. matrix or solvent related peaks) are characterized by an unrelated spatial distribution compared to the geometrical shape of the expected signal source (e.g. a tissue section). In order to identify and remove these peaks, we designed a filter based on the similarity between the peak intensity images and a reference image. Available measures to estimate the similarity between the peak and the reference signal distributions are: Pearson’s correlation, Spearman’s correlation, structural similarity index measure (<xref rid="bty622-B14" ref-type="bibr">Wang <italic>et al.</italic>, 2004</xref>) and normalized mutual information. Two options are available for calculating the reference signal, a continuous measure among ‘sum’, ‘median’, ‘mean’ or ‘first principal component scores’ of the entire set of peak intensities, and a binary mask, representing the region of interest (ROI), calculated either applying Otsu’s thresholding to the reference signal seen as an image, or applying k-means clustering with two clusters on the entire dataset. Additionally, external reference and ROI images can be used, after opportunely resizing and registering them with the MS image. The command ‘msImage’ allows to easily convert arbitrary images represented as pixel intensity matrices into MS images compatible with SPUTNIK (an example of the filter applied using the ROI generated by the H&amp;E optical image registered with the sum of the ion intensities in the 800–900 m/z range is shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Fig. S3</xref>). By default, a similarity threshold equal to 0 guarantees that ions also localized in small regionswithin the ROI are not filtered. Scaled first three principal components scores image of the filtered peaks data confirm that the filter successfully removes the ions localized outside of the tissue in the DESI-MSI and MALDI-MSI examples (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, Fig. S4). When off-tissue regions are available, the user should run the reference similarity filter before all the other filters. In this way, the dataset dimensionality can be significantly reduced, increasing the global contrast between tissue and off-tissue regions.</p>
    </sec>
    <sec>
      <title>2.3 Pixel count based filter</title>
      <p>The Poisson spatially distributed signals (due to shot-like noise) are characterized by a more scattered spatial distribution than the real signal. Meaningful clusters of pixels should be larger than the expected smallest spatial sub-regions. Under this assumption, we designed a filter that takes into account the number of connected pixels where the peak intensity is higher than the background level. Using a binary ROI mask, calculated similarly to that described in the ‘Reference similarity filter’ section or generated externally (e.g. binarization of the registered optical image of the H&amp;E stained tissue), the connected signal sub-regions are detected from Otsu’s thresholded binary peak image within the ROI. Subsequently, the filter selects those peaks characterized by connected regions larger than the provided number of pixels, which are user-defined based on the expected smallest meaningful image sub-regions. Different levels of ‘aggressiveness’ take into account the clusters size which is also outside of the ROI. When off-tissue regions are not present, pixel count based filter can be used with an ROI consisting of a matrix of all ones (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, Fig. S5).</p>
    </sec>
    <sec>
      <title>2.4 Complete spatial randomness filter</title>
      <p>A further filter is based on the rejection of the null hypothesis of a peak signal following a complete spatial random distribution. The assumption behind these statistical tests is that a non-informative peak signal is spatially distributed as a homogeneous spatial Poisson process (<xref rid="bty622-B10" ref-type="bibr">Maimon and Rokach, 2010</xref>). The tests use Otsu’s thresholded binary pixels associated with the peak signal to define a two-dimensional point pattern process; two tests are currently available: (i) <italic>Clark Evans test</italic> (<xref rid="bty622-B4" ref-type="bibr">Clark and Evans, 1954</xref>), (ii) <italic>Kolmogorov-Smirnov</italic> test against a covariate distribution (<xref rid="bty622-B3" ref-type="bibr">Berman, 1986</xref>), calculated with the same methods used to extract the reference image. The tests are based on the already available <italic>spatstat</italic> R package (<xref rid="bty622-B2" ref-type="bibr">Baddeley and Turner, 2005</xref>). This represents the least aggressive filter, since it does not take into account of the connectivity between pixels and the tissue spatial distribution, but only tests whether ion intensities reflect the overall contrast between the tissue and off-tissue regions. Similarly to the count pixel filter, this filter should be used when off-tissue regions are not available (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, Fig. S5).</p>
      <p>More details about the algorithms are available in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>.</p>
    </sec>
  </sec>
  <sec sec-type="conclusions">
    <title>3 Conclusions</title>
    <p><italic>SPUTNIK</italic> provides a collection of flexible filters for the detection of peaks associated with non-realistic spatial distributions, given the prior information about the signal source localization.</p>
    <p>Two tutorials, distributed with the package, show how to apply the filtering pipeline to MALDI-MSI and DESI-MSI datasets.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="sup1">
      <label>Supplementary Data 1</label>
      <media xlink:href="bty622_supplementary_data_1.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sup2">
      <label>Supplementary Data 2</label>
      <media xlink:href="bty622_supplementary_data_2.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sup3">
      <label>Supplementary Data 3</label>
      <media xlink:href="bty622_supplementary_data_3.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack>
    <title>Acknowledgements</title>
    <p>We would like to thank Dr. Luisa Doria for providing the ovarian cancer DESI MSI dataset included in the package. The ovarian sample was approved by the institutional review board at Imperial College Healthcare National Health Service Trust (Tissue Bank sub-collection number GYN/HG/12/060).</p>
  </ack>
  <sec>
    <title>Funding</title>
    <p>This work was supported by Cancer Research UK Grand Challenge Program (Project title: ‘A Complete Cartography Through Multiscale Molecular Imaging’). The Department of Surgery and Cancer is funded by grants and infrastructure support by the National Institute for Health Research (NIHR) Imperial Biomedical Research Centre (BRC). GC is supported by the National Institute for Health Research (NIHR) Imperial Biomedical Research Centre (BRC). The views expressed in this publication are those of the author(s) and not necessarily those of the NHS, the National Institute for Health Research or the Department of Health.</p>
    <p><bold>Conflict of Interest:</bold> none declared.</p>
  </sec>
  <ref-list>
    <title>References</title>
    <ref id="bty622-B1">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Alexandrov</surname><given-names>T.</given-names></name>, <name name-style="western"><surname>Bartels</surname><given-names>A.</given-names></name></person-group> (<year>2013</year>) 
<article-title>Testing for presence of known and unknown molecules in imaging mass spectrometry</article-title>. <source>Bioinformatics</source><italic>,</italic><volume>29</volume>, <fpage>2335</fpage>–<lpage>2342</lpage>.<pub-id pub-id-type="pmid">23873892</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B2">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Baddeley</surname><given-names>A.</given-names></name>, <name name-style="western"><surname>Turner</surname><given-names>R.</given-names></name></person-group> (<year>2005</year>) 
<article-title>Spatstat: an R package for analyzing spatial point patterns</article-title>. <source>J. Stat. Soft.</source><italic>,</italic><volume>12</volume>, <fpage>1</fpage>–<lpage>42</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B3">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Berman</surname><given-names>M.</given-names></name></person-group> (<year>1986</year>) 
<article-title>Testing for spatial association between a point process and another stochastic-process</article-title>. <source>J. R. Stat. Soc. C Appl.</source><italic>,</italic><volume>35</volume>, <fpage>54</fpage>–<lpage>62</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B4">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Clark</surname><given-names>P.J.</given-names></name>, <name name-style="western"><surname>Evans</surname><given-names>F.C.</given-names></name></person-group> (<year>1954</year>) 
<article-title>Distance to nearest neighbor as a measure of spatial relationships in populations</article-title>. <source>Ecology</source><italic>,</italic><volume>35</volume>, <fpage>445</fpage>–<lpage>453</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B5">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Fonville</surname><given-names>J.M.</given-names></name><etal>et al</etal></person-group> (<year>2012</year>) 
<article-title>Robust data processing and normalization strategy for MALDI mass spectrometric imaging</article-title>. <source>Anal. Chem.</source><italic>,</italic><volume>84</volume>, <fpage>1310</fpage>–<lpage>1319</lpage>.<pub-id pub-id-type="pmid">22148759</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B6">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Franck</surname><given-names>J.</given-names></name><etal>et al</etal></person-group> (<year>2009</year>) 
<article-title>MALDI imaging mass spectrometry: state of the art technology in clinical proteomics</article-title>. <source>Mol. Cell Proteomics</source><italic>,</italic><volume>8</volume>, <fpage>2023</fpage>–<lpage>2033</lpage>.<pub-id pub-id-type="pmid">19451175</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B7">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Gibb</surname><given-names>S.</given-names></name>, <name name-style="western"><surname>Strimmer</surname><given-names>K.</given-names></name></person-group> (<year>2012</year>) 
<article-title>MALDIquant: a versatile R package for the analysis of mass spectrometry data</article-title>. <source>Bioinformatics</source><italic>,</italic><volume>28</volume>, <fpage>2270</fpage>–<lpage>2271</lpage>.<pub-id pub-id-type="pmid">22796955</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B8">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Hurley</surname><given-names>N.</given-names></name>, <name name-style="western"><surname>Rickard</surname><given-names>S.</given-names></name></person-group> (<year>2009</year>) 
<article-title>Comparing measures of sparsity</article-title>. <source>IEEE Trans. Inf. Theory</source><italic>,</italic><volume>55</volume>, <fpage>4723</fpage>–<lpage>4741</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B9">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Kompauer</surname><given-names>M.</given-names></name><etal>et al</etal></person-group> (<year>2017</year>) 
<article-title>Atmospheric pressure MALDI mass spectrometry imaging of tissues and cells at 1.4-mum lateral resolution</article-title>. <source>Nat Methods</source><italic>,</italic><volume>14</volume>, <fpage>90</fpage>–<lpage>96</lpage>.<pub-id pub-id-type="pmid">27842060</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B10">
      <mixed-citation publication-type="book"><person-group person-group-type="author"><name name-style="western"><surname>Maimon</surname><given-names>O.</given-names></name>, <name name-style="western"><surname>Rokach</surname><given-names>L.</given-names></name></person-group> (<year>2010</year>) 
<article-title>Introduction to knowledge discovery and data mining</article-title>. In: <person-group person-group-type="editor"><name name-style="western"><surname>Maimon</surname><given-names>O.</given-names></name>, <name name-style="western"><surname>Rokach</surname><given-names>L.</given-names></name></person-group>, (eds), <source>Data Mining and Knowledge Discovery Handbook</source>. 
<publisher-name>Springer</publisher-name>, 
<publisher-loc>Boston, MA</publisher-loc><fpage>1</fpage>–<lpage>15</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B11">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Otsu</surname><given-names>N.</given-names></name></person-group> (<year>1975</year>) 
<article-title>A threshold selection method from gray-level histograms</article-title>. <source>Automatica</source>, <volume>9</volume>, <fpage>62</fpage>–<lpage> 27</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B12">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Palmer</surname><given-names>A.</given-names></name><etal>et al</etal></person-group> (<year>2017</year>) 
<article-title>FDR-controlled metabolite annotation for high-resolution imaging mass spectrometry</article-title>. <source>Nat. Methods</source><italic>,</italic><volume>14</volume>, <fpage>57</fpage>–<lpage>60</lpage>.<pub-id pub-id-type="pmid">27842059</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B13">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Rompp</surname><given-names>A.</given-names></name><etal>et al</etal></person-group> (<year>2010</year>) 
<article-title>Histology by mass spectrometry: label-free tissue characterization obtained from high-accuracy bioanalytical imaging</article-title>. <source>Angew. Chem. Int. Ed. Engl.</source><italic>,</italic><volume>49</volume>, <fpage>3834</fpage>–<lpage>3838</lpage>.<pub-id pub-id-type="pmid">20397170</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B14">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Wang</surname><given-names>Z.</given-names></name><etal>et al</etal></person-group> (<year>2004</year>) 
<article-title>Image quality assessment: from error visibility to structural similarity</article-title>. <source>IEEE Trans. Image Process.</source><italic>,</italic><volume>13</volume>, <fpage>600</fpage>–<lpage>612</lpage>.<pub-id pub-id-type="pmid">15376593</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.1 20151215//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.1?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">Bioinformatics</journal-id>
    <journal-id journal-id-type="publisher-id">bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1367-4803</issn>
    <issn pub-type="epub">1367-4811</issn>
    <publisher>
      <publisher-name>Oxford University Press</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6298046</article-id>
    <article-id pub-id-type="pmid">30010780</article-id>
    <article-id pub-id-type="doi">10.1093/bioinformatics/bty622</article-id>
    <article-id pub-id-type="publisher-id">bty622</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Applications Notes</subject>
        <subj-group subj-group-type="category-toc-heading">
          <subject>Bioimage Informatics</subject>
        </subj-group>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>SPUTNIK: an R package for filtering of spatially related peaks in mass spectrometry imaging data</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Inglese</surname>
          <given-names>Paolo</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
        <xref ref-type="corresp" rid="bty622-cor1"/>
        <!--<email>p.inglese14@imperial.ac.uk</email>-->
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Correia</surname>
          <given-names>Gonçalo</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Takats</surname>
          <given-names>Zoltan</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Nicholson</surname>
          <given-names>Jeremy K</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Glen</surname>
          <given-names>Robert C</given-names>
        </name>
        <xref ref-type="aff" rid="aff1"/>
        <!--<email>r.glen@imperial.ac.uk</email>-->
        <xref ref-type="corresp" rid="bty622-cor1"/>
      </contrib>
    </contrib-group>
    <contrib-group>
      <contrib contrib-type="editor">
        <name>
          <surname>Murphy</surname>
          <given-names>Robert</given-names>
        </name>
        <role>Associate Editor</role>
      </contrib>
    </contrib-group>
    <aff id="aff1">Computational and System Medicine, Department of Surgery and Cancer, Imperial College London, London, UK</aff>
    <author-notes>
      <corresp id="bty622-cor1">To whom correspondence should be addressed. <email>p.inglese14@imperial.ac.uk</email> or <email>r.glen@imperial.ac.uk</email></corresp>
    </author-notes>
    <pub-date pub-type="ppub">
      <day>01</day>
      <month>1</month>
      <year>2019</year>
    </pub-date>
    <pub-date pub-type="epub" iso-8601-date="2018-07-13">
      <day>13</day>
      <month>7</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>13</day>
      <month>7</month>
      <year>2018</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on the <pub-date pub-type="epub"/>. -->
    <volume>35</volume>
    <issue>1</issue>
    <fpage>178</fpage>
    <lpage>180</lpage>
    <history>
      <date date-type="received">
        <day>16</day>
        <month>2</month>
        <year>2018</year>
      </date>
      <date date-type="rev-recd">
        <day>18</day>
        <month>6</month>
        <year>2018</year>
      </date>
      <date date-type="accepted">
        <day>10</day>
        <month>7</month>
        <year>2018</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2018. Published by Oxford University Press.</copyright-statement>
      <copyright-year>2018</copyright-year>
      <license license-type="cc-by" xlink:href="http://creativecommons.org/licenses/by/4.0/">
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted reuse, distribution, and reproduction in any medium, provided the original work is properly cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="bty622.pdf"/>
    <abstract>
      <title>Abstract</title>
      <sec id="s1">
        <title>Summary</title>
        <p><italic>SPUTNIK</italic> is an R package consisting of a series of tools to filter mass spectrometry imaging peaks characterized by a noisy or unlikely spatial distribution. SPUTNIK can produce mass spectrometry imaging datasets characterized by a smaller but more informative set of peaks, reduce the complexity of subsequent multi-variate analysis and increase the interpretability of the statistical results.</p>
      </sec>
      <sec id="s2">
        <title>Availability and implementation</title>
        <p><italic>SPUTNIK</italic> is freely available online from CRAN repository and at <ext-link ext-link-type="uri" xlink:href="https://github.com/paoloinglese/SPUTNIK">https://github.com/paoloinglese/SPUTNIK</ext-link>. The package is distributed under the GNU General Public License version 3 and is accompanied by example files and data.</p>
      </sec>
      <sec id="s3">
        <title>Supplementary information</title>
        <p><xref ref-type="supplementary-material" rid="sup1">Supplementary data</xref> are available at <italic>Bioinformatics</italic> online.</p>
      </sec>
    </abstract>
    <funding-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Cancer Research UK</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000289</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Institute for Health Research</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000272</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Imperial Biomedical Research Centre</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Institute for Health Research</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000272</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Imperial Biomedical Research Centre</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">NHS</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">National Institute for Health Research</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000272</named-content>
        </funding-source>
      </award-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Department of Health</named-content>
          <named-content content-type="funder-identifier">10.13039/501100000276</named-content>
        </funding-source>
      </award-group>
    </funding-group>
    <counts>
      <page-count count="3"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec sec-type="intro">
    <title>1 Introduction</title>
    <p>Over the last few years, mass spectrometry imaging (MSI or IMS) has demonstrated great potential in discovering and elucidating chemical processes in a wide variety of research contexts. MSI has been used to determine possible cancer biomarkers (<xref rid="bty622-B6" ref-type="bibr">Franck <italic>et al.</italic>, 2009</xref>), and recent technologies are capable of detecting molecular signals at the cellular level (<xref rid="bty622-B9" ref-type="bibr">Kompauer <italic>et al.</italic>, 2017</xref>). The properties of such data type, such as high ion dimensionality and the presence of noise fluctuations in the spectral profiles, make the pre-processing phase and the extraction of informative features for the subsequent statistical analysis extremely important.</p>
    <p>Software packages, such as <italic>MALDIquant</italic> (<xref rid="bty622-B7" ref-type="bibr">Gibb and Strimmer, 2012</xref>) can filter peaks based on the presence of signals in a minimum fraction of samples, but unfortunately these filters do not to take into account the information contained in the spatial localization of the signals as addressed in recent work (<xref rid="bty622-B1" ref-type="bibr">Alexandrov and Bartels, 2013</xref>; <xref rid="bty622-B5" ref-type="bibr">Fonville <italic>et al.</italic>, 2012</xref>; <xref rid="bty622-B12" ref-type="bibr">Palmer <italic>et al.</italic>, 2017</xref>).</p>
    <p><italic>SPUTNIK (SPatially aUTomatic deNoising for Ims toolKit)</italic> provides a series of filters which aim select meaningful and informative peaks, based on the plausibility of their spatial distributions, given the information about the signal source (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Table S1</xref>). It provides an estimation of split peaks, a correlation-based filter, a pixel count based filter and a series of tests based on complete spatial randomness. Each class of filters is designed to remove uninformative peaks based on specific assumptions. An example of the effects of each filter (with the default parameters) on the final dimensionality of two example datasets (MALDI-MSI and DESI-MSI) is shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Figure S1</xref>. <italic>SPUTNIK</italic> is freely distributed as an R package written using S4 object-oriented programming.</p>
    <p>Two example workflows showing how to apply SPUTNIK to both MALDI-MSI and DESI-MSI datasets are provided together with the package (<xref ref-type="supplementary-material" rid="sup2">Supplementary Materials S2</xref> and <xref ref-type="supplementary-material" rid="sup2">S3</xref>). The original imzML and the associated optical image files for the MALDI-MSI dataset are available at <ext-link ext-link-type="uri" xlink:href="https://www.ebi.ac.uk/pride/archive/projects/PXD001283/">https://www.ebi.ac.uk/pride/archive/projects/PXD001283/</ext-link>.</p>
    <p>An example of the application of the SPUTNIK pipeline to MALDI-MSI from mouse urinary bladder specimen (<xref rid="bty622-B13" ref-type="bibr">Rompp <italic>et al.</italic>, 2010</xref>) is shown in <xref ref-type="fig" rid="bty622-F1">Figure 1</xref> (see complete workflow in <xref ref-type="supplementary-material" rid="sup2">Supplementary Material S2</xref>). The sum of the matched peaks intensities (pre-processed using MALDIquant) was used as a reference for determining the tissue specimen location and ROI detection. The ROI quality was visually evaluated comparing its morphology with an external tissue image (e.g. optical image of H&amp;E stained tissue). The dataset was filtered using a correlation-based filter (reference = binary ROI calculated by k-means, measure = Spearman’s correlation, threshold = 0); followed by a count pixels filter with a minimum number of connected pixels equal to 4. Finally, a complete spatial randomness filter was applied using the Kolmogorov-Smirnov test with the total ion count image as a covariate; Bonferroni corrected <italic>P</italic>-values (α = 0.001) were used to select the peaks. The pipeline was capable of reducing the dimensionality from 1175 peaks to 204 peaks. Visualization of the filtered dataset and analyses based on the reduced number of peaks result in images with enhanced contrast (<xref ref-type="fig" rid="bty622-F1">Fig. 1</xref>B and C). This also provided improved clustering results, with an enhanced contrast due to the removal of signals associated with noise. A complete workflow of the application of SPUTNIK on the example DESI-MSI dataset is available in <xref ref-type="supplementary-material" rid="sup2">Supplementary Material S3</xref>.
</p>
    <fig id="bty622-F1" orientation="portrait" position="float">
      <label>Fig. 1.</label>
      <caption>
        <p>A comparison between the original and the filtered MALDI-MSI dataset (<xref rid="bty622-B13" ref-type="bibr">Rompp <italic>et al.</italic>, 2010</xref>): (A) total ion count (TIC) images, (B) RGB images of the three first principal components scores scaled in [0, 1] and (C) results of k-means clustering with four clusters applied to the PCA scores responsible for 95% of the total variance. The heatmaps (D) show the intensities of five filtered (top row) and five selected peaks (bottom row) with the five largest average intensities (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Fig. S6</xref>). The images of the filtered peaks show that they are mainly localized outside of the tissue region. All the results confirm that the filters reduce the effect of signal noise and allow a clear identification of tissue sub-structures</p>
      </caption>
      <graphic xlink:href="bty622f1"/>
    </fig>
  </sec>
  <sec>
    <title>2 Algorithms details</title>
    <sec>
      <title>2.1 Split peak estimation</title>
      <p>Random peak shifting can generate false multiple peaks during the peak-matching procedure. These peaks signals, which represent the same ion source, are assigned to multiple m/z values. In order to identify the occurrence of this issue, we hypothesized that split peaks are randomly assigned to contiguous m/z values within the limits of instrumental error. Additional conditions to assign multiple peaks to the same m/z value are: (i) their peak intensity signals are localized in small or non-overlapping spatial regions, (ii) at least one of the peaks signal images shows a sufficient level of ‘spatial regularity’, (iii) the combined signal, generated by merging the intensities of the candidate split peaks, is associated with an image with a spatial regularity at least as high as the images associated with the original peaks. Spatial regularity measures available are: (i) ratio of scattered pixels (defined as the number of Otsu’s thresholded (<xref rid="bty622-B11" ref-type="bibr">Otsu, 1975</xref>) disconnected signal pixels divided by the total number of signal pixels), (ii) spatial chaos (<xref rid="bty622-B12" ref-type="bibr">Palmer <italic>et al.</italic>, 2017</xref>), (iii) Gini index (<xref rid="bty622-B8" ref-type="bibr">Hurley and Rickard, 2009</xref>). An example of simulated split peak merging from the DESI-MSI sample is shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Figure S2</xref>. Based on its purpose, the split peak tool should always be applied before any other filtering tool.</p>
    </sec>
    <sec>
      <title>2.2 Reference similarity filter</title>
      <p>Often, signals derived from non-informative peaks (e.g. matrix or solvent related peaks) are characterized by an unrelated spatial distribution compared to the geometrical shape of the expected signal source (e.g. a tissue section). In order to identify and remove these peaks, we designed a filter based on the similarity between the peak intensity images and a reference image. Available measures to estimate the similarity between the peak and the reference signal distributions are: Pearson’s correlation, Spearman’s correlation, structural similarity index measure (<xref rid="bty622-B14" ref-type="bibr">Wang <italic>et al.</italic>, 2004</xref>) and normalized mutual information. Two options are available for calculating the reference signal, a continuous measure among ‘sum’, ‘median’, ‘mean’ or ‘first principal component scores’ of the entire set of peak intensities, and a binary mask, representing the region of interest (ROI), calculated either applying Otsu’s thresholding to the reference signal seen as an image, or applying k-means clustering with two clusters on the entire dataset. Additionally, external reference and ROI images can be used, after opportunely resizing and registering them with the MS image. The command ‘msImage’ allows to easily convert arbitrary images represented as pixel intensity matrices into MS images compatible with SPUTNIK (an example of the filter applied using the ROI generated by the H&amp;E optical image registered with the sum of the ion intensities in the 800–900 m/z range is shown in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, <xref ref-type="supplementary-material" rid="sup1">Fig. S3</xref>). By default, a similarity threshold equal to 0 guarantees that ions also localized in small regionswithin the ROI are not filtered. Scaled first three principal components scores image of the filtered peaks data confirm that the filter successfully removes the ions localized outside of the tissue in the DESI-MSI and MALDI-MSI examples (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, Fig. S4). When off-tissue regions are available, the user should run the reference similarity filter before all the other filters. In this way, the dataset dimensionality can be significantly reduced, increasing the global contrast between tissue and off-tissue regions.</p>
    </sec>
    <sec>
      <title>2.3 Pixel count based filter</title>
      <p>The Poisson spatially distributed signals (due to shot-like noise) are characterized by a more scattered spatial distribution than the real signal. Meaningful clusters of pixels should be larger than the expected smallest spatial sub-regions. Under this assumption, we designed a filter that takes into account the number of connected pixels where the peak intensity is higher than the background level. Using a binary ROI mask, calculated similarly to that described in the ‘Reference similarity filter’ section or generated externally (e.g. binarization of the registered optical image of the H&amp;E stained tissue), the connected signal sub-regions are detected from Otsu’s thresholded binary peak image within the ROI. Subsequently, the filter selects those peaks characterized by connected regions larger than the provided number of pixels, which are user-defined based on the expected smallest meaningful image sub-regions. Different levels of ‘aggressiveness’ take into account the clusters size which is also outside of the ROI. When off-tissue regions are not present, pixel count based filter can be used with an ROI consisting of a matrix of all ones (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, Fig. S5).</p>
    </sec>
    <sec>
      <title>2.4 Complete spatial randomness filter</title>
      <p>A further filter is based on the rejection of the null hypothesis of a peak signal following a complete spatial random distribution. The assumption behind these statistical tests is that a non-informative peak signal is spatially distributed as a homogeneous spatial Poisson process (<xref rid="bty622-B10" ref-type="bibr">Maimon and Rokach, 2010</xref>). The tests use Otsu’s thresholded binary pixels associated with the peak signal to define a two-dimensional point pattern process; two tests are currently available: (i) <italic>Clark Evans test</italic> (<xref rid="bty622-B4" ref-type="bibr">Clark and Evans, 1954</xref>), (ii) <italic>Kolmogorov-Smirnov</italic> test against a covariate distribution (<xref rid="bty622-B3" ref-type="bibr">Berman, 1986</xref>), calculated with the same methods used to extract the reference image. The tests are based on the already available <italic>spatstat</italic> R package (<xref rid="bty622-B2" ref-type="bibr">Baddeley and Turner, 2005</xref>). This represents the least aggressive filter, since it does not take into account of the connectivity between pixels and the tissue spatial distribution, but only tests whether ion intensities reflect the overall contrast between the tissue and off-tissue regions. Similarly to the count pixel filter, this filter should be used when off-tissue regions are not available (<xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>, Fig. S5).</p>
      <p>More details about the algorithms are available in <xref ref-type="supplementary-material" rid="sup1">Supplementary Material S1</xref>.</p>
    </sec>
  </sec>
  <sec sec-type="conclusions">
    <title>3 Conclusions</title>
    <p><italic>SPUTNIK</italic> provides a collection of flexible filters for the detection of peaks associated with non-realistic spatial distributions, given the prior information about the signal source localization.</p>
    <p>Two tutorials, distributed with the package, show how to apply the filtering pipeline to MALDI-MSI and DESI-MSI datasets.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="sup1">
      <label>Supplementary Data 1</label>
      <media xlink:href="bty622_supplementary_data_1.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sup2">
      <label>Supplementary Data 2</label>
      <media xlink:href="bty622_supplementary_data_2.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sup3">
      <label>Supplementary Data 3</label>
      <media xlink:href="bty622_supplementary_data_3.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack>
    <title>Acknowledgements</title>
    <p>We would like to thank Dr. Luisa Doria for providing the ovarian cancer DESI MSI dataset included in the package. The ovarian sample was approved by the institutional review board at Imperial College Healthcare National Health Service Trust (Tissue Bank sub-collection number GYN/HG/12/060).</p>
  </ack>
  <sec>
    <title>Funding</title>
    <p>This work was supported by Cancer Research UK Grand Challenge Program (Project title: ‘A Complete Cartography Through Multiscale Molecular Imaging’). The Department of Surgery and Cancer is funded by grants and infrastructure support by the National Institute for Health Research (NIHR) Imperial Biomedical Research Centre (BRC). GC is supported by the National Institute for Health Research (NIHR) Imperial Biomedical Research Centre (BRC). The views expressed in this publication are those of the author(s) and not necessarily those of the NHS, the National Institute for Health Research or the Department of Health.</p>
    <p><bold>Conflict of Interest:</bold> none declared.</p>
  </sec>
  <ref-list>
    <title>References</title>
    <ref id="bty622-B1">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Alexandrov</surname><given-names>T.</given-names></name>, <name name-style="western"><surname>Bartels</surname><given-names>A.</given-names></name></person-group> (<year>2013</year>) 
<article-title>Testing for presence of known and unknown molecules in imaging mass spectrometry</article-title>. <source>Bioinformatics</source><italic>,</italic><volume>29</volume>, <fpage>2335</fpage>–<lpage>2342</lpage>.<pub-id pub-id-type="pmid">23873892</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B2">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Baddeley</surname><given-names>A.</given-names></name>, <name name-style="western"><surname>Turner</surname><given-names>R.</given-names></name></person-group> (<year>2005</year>) 
<article-title>Spatstat: an R package for analyzing spatial point patterns</article-title>. <source>J. Stat. Soft.</source><italic>,</italic><volume>12</volume>, <fpage>1</fpage>–<lpage>42</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B3">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Berman</surname><given-names>M.</given-names></name></person-group> (<year>1986</year>) 
<article-title>Testing for spatial association between a point process and another stochastic-process</article-title>. <source>J. R. Stat. Soc. C Appl.</source><italic>,</italic><volume>35</volume>, <fpage>54</fpage>–<lpage>62</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B4">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Clark</surname><given-names>P.J.</given-names></name>, <name name-style="western"><surname>Evans</surname><given-names>F.C.</given-names></name></person-group> (<year>1954</year>) 
<article-title>Distance to nearest neighbor as a measure of spatial relationships in populations</article-title>. <source>Ecology</source><italic>,</italic><volume>35</volume>, <fpage>445</fpage>–<lpage>453</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B5">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Fonville</surname><given-names>J.M.</given-names></name><etal>et al</etal></person-group> (<year>2012</year>) 
<article-title>Robust data processing and normalization strategy for MALDI mass spectrometric imaging</article-title>. <source>Anal. Chem.</source><italic>,</italic><volume>84</volume>, <fpage>1310</fpage>–<lpage>1319</lpage>.<pub-id pub-id-type="pmid">22148759</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B6">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Franck</surname><given-names>J.</given-names></name><etal>et al</etal></person-group> (<year>2009</year>) 
<article-title>MALDI imaging mass spectrometry: state of the art technology in clinical proteomics</article-title>. <source>Mol. Cell Proteomics</source><italic>,</italic><volume>8</volume>, <fpage>2023</fpage>–<lpage>2033</lpage>.<pub-id pub-id-type="pmid">19451175</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B7">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Gibb</surname><given-names>S.</given-names></name>, <name name-style="western"><surname>Strimmer</surname><given-names>K.</given-names></name></person-group> (<year>2012</year>) 
<article-title>MALDIquant: a versatile R package for the analysis of mass spectrometry data</article-title>. <source>Bioinformatics</source><italic>,</italic><volume>28</volume>, <fpage>2270</fpage>–<lpage>2271</lpage>.<pub-id pub-id-type="pmid">22796955</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B8">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Hurley</surname><given-names>N.</given-names></name>, <name name-style="western"><surname>Rickard</surname><given-names>S.</given-names></name></person-group> (<year>2009</year>) 
<article-title>Comparing measures of sparsity</article-title>. <source>IEEE Trans. Inf. Theory</source><italic>,</italic><volume>55</volume>, <fpage>4723</fpage>–<lpage>4741</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B9">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Kompauer</surname><given-names>M.</given-names></name><etal>et al</etal></person-group> (<year>2017</year>) 
<article-title>Atmospheric pressure MALDI mass spectrometry imaging of tissues and cells at 1.4-mum lateral resolution</article-title>. <source>Nat Methods</source><italic>,</italic><volume>14</volume>, <fpage>90</fpage>–<lpage>96</lpage>.<pub-id pub-id-type="pmid">27842060</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B10">
      <mixed-citation publication-type="book"><person-group person-group-type="author"><name name-style="western"><surname>Maimon</surname><given-names>O.</given-names></name>, <name name-style="western"><surname>Rokach</surname><given-names>L.</given-names></name></person-group> (<year>2010</year>) 
<article-title>Introduction to knowledge discovery and data mining</article-title>. In: <person-group person-group-type="editor"><name name-style="western"><surname>Maimon</surname><given-names>O.</given-names></name>, <name name-style="western"><surname>Rokach</surname><given-names>L.</given-names></name></person-group>, (eds), <source>Data Mining and Knowledge Discovery Handbook</source>. 
<publisher-name>Springer</publisher-name>, 
<publisher-loc>Boston, MA</publisher-loc><fpage>1</fpage>–<lpage>15</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B11">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Otsu</surname><given-names>N.</given-names></name></person-group> (<year>1975</year>) 
<article-title>A threshold selection method from gray-level histograms</article-title>. <source>Automatica</source>, <volume>9</volume>, <fpage>62</fpage>–<lpage> 27</lpage>.</mixed-citation>
    </ref>
    <ref id="bty622-B12">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Palmer</surname><given-names>A.</given-names></name><etal>et al</etal></person-group> (<year>2017</year>) 
<article-title>FDR-controlled metabolite annotation for high-resolution imaging mass spectrometry</article-title>. <source>Nat. Methods</source><italic>,</italic><volume>14</volume>, <fpage>57</fpage>–<lpage>60</lpage>.<pub-id pub-id-type="pmid">27842059</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B13">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Rompp</surname><given-names>A.</given-names></name><etal>et al</etal></person-group> (<year>2010</year>) 
<article-title>Histology by mass spectrometry: label-free tissue characterization obtained from high-accuracy bioanalytical imaging</article-title>. <source>Angew. Chem. Int. Ed. Engl.</source><italic>,</italic><volume>49</volume>, <fpage>3834</fpage>–<lpage>3838</lpage>.<pub-id pub-id-type="pmid">20397170</pub-id></mixed-citation>
    </ref>
    <ref id="bty622-B14">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Wang</surname><given-names>Z.</given-names></name><etal>et al</etal></person-group> (<year>2004</year>) 
<article-title>Image quality assessment: from error visibility to structural similarity</article-title>. <source>IEEE Trans. Image Process.</source><italic>,</italic><volume>13</volume>, <fpage>600</fpage>–<lpage>612</lpage>.<pub-id pub-id-type="pmid">15376593</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
