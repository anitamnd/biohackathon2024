<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Commun</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Commun</journal-id>
    <journal-title-group>
      <journal-title>Nature Communications</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2041-1723</issn>
    <publisher>
      <publisher-name>Nature Publishing Group UK</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">8497570</article-id>
    <article-id pub-id-type="publisher-id">25957</article-id>
    <article-id pub-id-type="doi">10.1038/s41467-021-25957-x</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Efficient and precise single-cell reference atlas mapping with Symphony</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-1962-1291</contrib-id>
        <name>
          <surname>Kang</surname>
          <given-names>Joyce B.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-5975-2851</contrib-id>
        <name>
          <surname>Nathan</surname>
          <given-names>Aparna</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Weinand</surname>
          <given-names>Kathryn</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-6102-2970</contrib-id>
        <name>
          <surname>Zhang</surname>
          <given-names>Fan</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Millard</surname>
          <given-names>Nghia</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Rumker</surname>
          <given-names>Laurie</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Moody</surname>
          <given-names>D. Branch</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes" equal-contrib="yes">
        <name>
          <surname>Korsunsky</surname>
          <given-names>Ilya</given-names>
        </name>
        <address>
          <email>ikorsunsky@bwh.harvard.edu</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes" equal-contrib="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-1901-8265</contrib-id>
        <name>
          <surname>Raychaudhuri</surname>
          <given-names>Soumya</given-names>
        </name>
        <address>
          <email>soumya@broadinstitute.org</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
        <xref ref-type="aff" rid="Aff6">6</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.62560.37</institution-id><institution-id institution-id-type="ISNI">0000 0004 0378 8294</institution-id><institution>Center for Data Sciences, Brigham and Women’s Hospital, </institution></institution-wrap>Boston, MA USA </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.38142.3c</institution-id><institution-id institution-id-type="ISNI">000000041936754X</institution-id><institution>Division of Genetics, Department of Medicine, </institution><institution>Brigham and Women’s Hospital and Harvard Medical School, </institution></institution-wrap>Boston, MA USA </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="GRID">grid.38142.3c</institution-id><institution-id institution-id-type="ISNI">000000041936754X</institution-id><institution>Division of Rheumatology, Inflammation, and Immunity, Department of Medicine, </institution><institution>Brigham and Women’s Hospital and Harvard Medical School, </institution></institution-wrap>Boston, MA USA </aff>
      <aff id="Aff4"><label>4</label><institution-wrap><institution-id institution-id-type="GRID">grid.38142.3c</institution-id><institution-id institution-id-type="ISNI">000000041936754X</institution-id><institution>Department of Biomedical Informatics, </institution><institution>Harvard Medical School, </institution></institution-wrap>Boston, MA USA </aff>
      <aff id="Aff5"><label>5</label><institution-wrap><institution-id institution-id-type="GRID">grid.66859.34</institution-id><institution>Program in Medical and Population Genetics, Broad Institute of MIT and Harvard, </institution></institution-wrap>Cambridge, MA USA </aff>
      <aff id="Aff6"><label>6</label><institution-wrap><institution-id institution-id-type="GRID">grid.5379.8</institution-id><institution-id institution-id-type="ISNI">0000000121662407</institution-id><institution>Versus Arthritis Centre for Genetics and Genomics, Centre for Musculoskeletal Research, Manchester Academic Health Science Centre, The University of Manchester, </institution></institution-wrap>Manchester, UK </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>7</day>
      <month>10</month>
      <year>2021</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>7</day>
      <month>10</month>
      <year>2021</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2021</year>
    </pub-date>
    <volume>12</volume>
    <elocation-id>5890</elocation-id>
    <history>
      <date date-type="received">
        <day>10</day>
        <month>2</month>
        <year>2021</year>
      </date>
      <date date-type="accepted">
        <day>10</day>
        <month>9</month>
        <year>2021</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2021</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Recent advances in single-cell technologies and integration algorithms make it possible to construct comprehensive reference atlases encompassing many donors, studies, disease states, and sequencing platforms. Much like mapping sequencing reads to a reference genome, it is essential to be able to map query cells onto complex, multimillion-cell reference atlases to rapidly identify relevant cell states and phenotypes. We present Symphony (<ext-link ext-link-type="uri" xlink:href="https://github.com/immunogenomics/symphony">https://github.com/immunogenomics/symphony</ext-link>), an algorithm for building large-scale, integrated reference atlases in a convenient, portable format that enables efficient query mapping within seconds. Symphony localizes query cells within a stable low-dimensional reference embedding, facilitating reproducible downstream transfer of reference-defined annotations to the query. We demonstrate the power of Symphony in multiple real-world datasets, including (1) mapping a multi-donor, multi-species query to predict pancreatic cell types, (2) localizing query cells along a developmental trajectory of fetal liver hematopoiesis, and (3) inferring surface protein expression with a multimodal CITE-seq atlas of memory T cells.</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">The number of single-cell RNA-seq datasets generated is increasing rapidly, making methods that map cell types to well-curated references increasingly important. Here, the authors propose an accurate method for mapping single cells onto a reference atlas in seconds.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Computational models</kwd>
      <kwd>Data integration</kwd>
      <kwd>Software</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100006955</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | Office of Extramural Research, National Institutes of Health (OER)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>T32GM007753</award-id>
        <award-id>1UH2AR067677</award-id>
        <award-id>U19 AI111224</award-id>
        <award-id>U01 HG009379</award-id>
        <award-id>1R01AR073833</award-id>
        <award-id>R01AR063759</award-id>
        <principal-award-recipient>
          <name>
            <surname>Kang</surname>
            <given-names>Joyce B.</given-names>
          </name>
          <name>
            <surname>Raychaudhuri</surname>
            <given-names>Soumya</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>U.S. Department of Health &amp; Human Services | NIH | Office of Extramural Research, National Institutes of Health (OER)</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>U.S. Department of Health &amp; Human Services | NIH | Office of Extramural Research, National Institutes of Health (OER)</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>U.S. Department of Health &amp; Human Services | NIH | Office of Extramural Research, National Institutes of Health (OER)</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>U.S. Department of Health &amp; Human Services | NIH | Office of Extramural Research, National Institutes of Health (OER)</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>U.S. Department of Health &amp; Human Services | NIH | Office of Extramural Research, National Institutes of Health (OER)</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2021</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1" sec-type="introduction">
    <title>Introduction</title>
    <p id="Par3">Advancements in single-cell RNA-sequencing (scRNA-seq) have launched an era in which individual studies can routinely profile 10<sup>4</sup>–10<sup>6</sup> cells<sup><xref ref-type="bibr" rid="CR1">1</xref>–<xref ref-type="bibr" rid="CR3">3</xref></sup>, and multimillion-cell datasets are already emerging<sup><xref ref-type="bibr" rid="CR4">4</xref>,<xref ref-type="bibr" rid="CR5">5</xref></sup>. Single-cell resolution enables the discovery and refinement of cell states across diverse clinical and biological contexts<sup><xref ref-type="bibr" rid="CR6">6</xref>–<xref ref-type="bibr" rid="CR11">11</xref></sup>. To date, most studies redefine cell states from scratch, making it difficult to compare results across studies and thus hampering reproducibility. Coordinated large-scale efforts, exemplified by the Human Cell Atlas (HCA)<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, aim to establish comprehensive and well-annotated reference datasets comprising millions of cells that capture the broad spectrum of cell states. Building these reference atlases requires integrating multiple datasets that may have been collected under different technical and biological conditions. Hence, reference construction requires application of one of many recently developed single-cell integration algorithms<sup><xref ref-type="bibr" rid="CR13">13</xref>–<xref ref-type="bibr" rid="CR19">19</xref></sup>. Our group previously developed Harmony<sup><xref ref-type="bibr" rid="CR15">15</xref></sup>, a fast, accurate, and well-reviewed method<sup><xref ref-type="bibr" rid="CR20">20</xref></sup> that is able to explicitly model complex study design, a property that makes it suitable for integrating complex datasets into reference atlases<sup><xref ref-type="bibr" rid="CR21">21</xref>–<xref ref-type="bibr" rid="CR24">24</xref></sup>. The potential to define common cell states using reference maps has already been demonstrated<sup><xref ref-type="bibr" rid="CR25">25</xref>,<xref ref-type="bibr" rid="CR26">26</xref></sup>. For example, we built an integrated reference of ~80,000 single-cell profiles of fibroblasts from human lung, synovium, salivary gland, and intestine and successfully mapped fibroblasts from human skin and mouse synovium, lung, and intestine to analyze conserved states across tissues and species<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>. Once such reference atlases are painstakingly constructed, interpretation of new datasets requires the ability to quickly map single-cell profiles into these reference atlases. This enables interpretation of new datasets by transferring annotations and metadata of interest from nearby reference cells.</p>
    <p id="Par4">Fast mapping of query cells against a large, stable reference is a well-recognized open problem<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> and active area of research<sup><xref ref-type="bibr" rid="CR28">28</xref>–<xref ref-type="bibr" rid="CR30">30</xref></sup>. One inefficient but accurate approach to project reference and query cells into a joint embedding is to integrate both sets of cells together de novo, resulting in what might be considered a “gold standard” embedding. While this approach is reasonable for relatively small reference datasets, it is intractable for atlas-sized references with millions of cells. It requires users to rebuild the reference for each analysis, which may be computationally challenging and require administratively cumbersome exchanges of large-scale datasets. Furthermore, de novo integration may corrupt the reference embedding once a reference is carefully constructed and annotated. It is instead preferable to freeze the reference when mapping new query cells onto it.</p>
    <p id="Par5">Here, we define reference mapping to mean placing query cells within the same embedding as integrated reference cells without requiring access to the raw data on all individual reference cells. Importantly, this embedding does not take advantage of any particular annotation, such as cell type labels, which may be refined or updated over time. This is in contrast to automated cell type classifiers, such as scmap<sup><xref ref-type="bibr" rid="CR31">31</xref></sup>, which assign rigid annotations based on reference datasets in a supervised manner. Reference mapping approaches introduced so far include Seurat<sup><xref ref-type="bibr" rid="CR30">30</xref></sup>, which is compatible with Seurat anchor-based integration<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>, and scArches, which is compatible with autoencoders such as scANVI<sup><xref ref-type="bibr" rid="CR32">32</xref></sup> and trVAE<sup><xref ref-type="bibr" rid="CR33">33</xref></sup>. These approaches separate reference building, which integrates datasets in the reference into a low-dimensional embedding, from query mapping, which uses a compressed version of the reference to efficiently map cells into the reference embedding. They further contrast with de novo integration methods like BBKNN<sup><xref ref-type="bibr" rid="CR34">34</xref></sup>, Seurat anchor-based integration<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>, and Harmony<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, which enable reference building but are slow and require access to the raw data and batch information on individual reference cells. High-quality reference mapping requires both a framework to efficiently store an integrated reference, and a fast and accurate procedure to map query datasets.</p>
    <p id="Par6">An ideal reference mapping algorithm must meet several key requirements. First, similar to de novo integration algorithms, it must be able to remove confounding signals due to complex study design in both the reference and query. In addition, it must be able to scale to large datasets, map with high accuracy, and enable inference of diverse query cell annotations based on reference cells. We present Symphony, a novel algorithm to compress a large, integrated reference and map query cells to a precise location in the reference embedding within seconds. Through multiple real-world dataset analyses, we show that Symphony can enable accurate downstream inference of cell type, developmental trajectory position, and protein expression, even when the query itself contains complex confounding technical and biological effects.</p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>Symphony compresses an integrated reference for efficient query mapping</title>
      <p id="Par7">Symphony comprises two main algorithms: reference compression and mapping (Methods, Supplementary Fig. <xref rid="MOESM1" ref-type="media">1a</xref>). Symphony <italic>reference compression</italic> captures and structures information from multiple reference datasets into an integrated and concise format that can subsequently be used to map query cells (Fig. <xref rid="Fig1" ref-type="fig">1a, b</xref>). Symphony builds upon the linear mixture model framework first introduced by Harmony<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>. Briefly, in a low-dimensional embedding, such as principal component analysis (PCA), the model represents cell states as soft clusters, in which a cell’s identity is defined by probabilistic assignments across one or more clusters. For de novo integration of the reference datasets (using Harmony), cells are iteratively assigned soft-cluster memberships, which serve as weights in a linear mixture model to remove unwanted covariate-dependent effects. Then, Symphony compresses the reference into a mappable entity, leveraging the reference-learned model parameters to add new query cells to the embedding. It maps cells into the reference without any iterative assignment and keeps reference cells stable.<fig id="Fig1"><label>Fig. 1</label><caption><title>Symphony overview.</title><p>Symphony comprises two algorithms: Symphony compression (<bold>a</bold>, <bold>b</bold>) and Symphony mapping (<bold>c</bold>, <bold>d</bold>). <bold>a</bold> To construct a reference atlas, cells (colored shapes) from multiple datasets are embedded in a lower-dimensional space (e.g., PCA), in which dataset integration (Harmony) is performed to remove dataset-specific effects. Shape indicates distinct cell types, and color indicates finer-grained cell states. <bold>b</bold> Symphony compression represents the information captured within the harmonized reference in a concise, portable format based on computing summary statistics for the reference-dependent components of the linear mixture model. Symphony returns the minimal reference elements needed to efficiently map new query cells to the reference. <bold>c</bold> Given an unseen query dataset (red circles) and compressed reference, Symphony mapping precisely localizes the query cells to their appropriate locations within the integrated reference embedding (<bold>d</bold>). Reference cell locations do not change during mapping. <bold>e</bold> The resulting joint embedding can be used for downstream transfer of reference-defined annotations to the query cells.</p></caption><graphic xlink:href="41467_2021_25957_Fig1_HTML" id="d32e543"/></fig></p>
      <p id="Par8">To store the reference efficiently without saving information on individual reference cells, Symphony computes summary statistics learned in the low-dimensional space (Fig. <xref rid="Fig1" ref-type="fig">1b</xref>, Methods), returning computationally efficient data structures containing the “minimal reference elements” needed to map new cells. These include the means and standard deviations used to scale the genes, the gene loadings from PCA (or another low-dimensional projection, e.g., canonical correlation analysis [CCA]) on the reference cells, soft-cluster centroids from the integrated reference, and two “compression terms” (a <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k\times 1$$\end{document}</tex-math><mml:math id="M2"><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mn>1</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq1.gif"/></alternatives></inline-formula> vector and <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k\times d$$\end{document}</tex-math><mml:math id="M4"><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq2.gif"/></alternatives></inline-formula> matrix, where <inline-formula id="IEq3"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M6"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq3.gif"/></alternatives></inline-formula> is the number of clusters and <inline-formula id="IEq4"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d$$\end{document}</tex-math><mml:math id="M8"><mml:mi>d</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq4.gif"/></alternatives></inline-formula> is the dimensionality of the embedding) (Methods, Supplementary Methods, Supplementary Fig. <xref rid="MOESM1" ref-type="media">1b</xref>).</p>
      <p id="Par9">To map new query cells to the compressed reference, we apply Symphony <italic>mapping</italic>. The algorithm approximates integration of reference and query cells de novo (Methods), but uses only the minimal reference elements to compute the mapping (Supplementary Fig. <xref rid="MOESM1" ref-type="media">1c</xref>). First, Symphony projects query gene expression profiles into the same uncorrected low-dimensional space as the reference cells (e.g., PCs), using the saved scaling parameters and reference gene loadings (Fig. <xref rid="Fig1" ref-type="fig">1c</xref>). Second, Symphony computes soft-cluster assignments for the query cells based on proximity to the reference cluster centroids. Finally, to correct unwanted user-specified technical and biological effects in the query data, Symphony assumes the soft-cluster assignments from the previous step and uses stored mixture model components to estimate and regress out the query batch effects (Fig. <xref rid="Fig1" ref-type="fig">1d</xref>). Importantly, the reference cell embedding remains stable during mapping. Embedding the query within the reference coordinates enables downstream transfer of annotations from reference cells to query cells, including discrete cell type classifications, quantitative cell states (e.g., position along a trajectory), or expression of missing genes or proteins (Fig. <xref rid="Fig1" ref-type="fig">1e</xref>).</p>
    </sec>
    <sec id="Sec4">
      <title>Symphony approximates de novo integration of PBMCs without reintegration of reference datasets</title>
      <p id="Par10">As we demonstrate in the Methods, Symphony is equivalent to running de novo Harmony integration if three conditions are met: (I) all cell states represented in the query dataset are captured by the reference dataset, (II) the number of query cells is much smaller than the number of reference cells, and (III) the query dataset has a design matrix that is independent of reference datasets (i.e., non-overlapping batches in reference and query). As the scope of available single-cell atlases continues to grow, it is reasonable to assume that reference datasets are large and all-inclusive, making conditions (I) and (II) well-supported. Condition (III) is also typically met if the query data was generated in separate experiments from the reference.</p>
      <p id="Par11">To demonstrate that Symphony mapping closely approximates running de novo integration on all cells, we applied Symphony to 20,571 peripheral blood mononuclear cells (PBMCs) assayed with three different 10x technologies: 3’v1, 3’v2, and 5’. We performed three mapping experiments. For each, we built an integrated Symphony reference from two technologies, then mapped the third technology as a query. The resulting Symphony embeddings were compared to a gold standard embedding obtained by running Harmony on all three datasets together. Visually, we found that the Symphony embedding for each mapping experiment (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>) closely reproduced the overall structure and cell type information of the gold standard embedding (Fig. <xref rid="Fig2" ref-type="fig">2b</xref>). To quantitatively assess the degrees of dataset mixing we use the Local Inverse Simpson’s Index (LISI)<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> metric. For a given categorical label assigned to each cell (in this case, technology), LISI indicates the effective number of categories represented in the local neighborhood of each cell; higher LISI scores correspond to better mixing of cells across batches. LISI scores in Symphony embeddings (mean LISI = 2.12, 95% CI [2.12, 2.13]) and de novo integration embeddings (mean LISI = 2.15, 95% CI [2.14, 2.16]) were nearly identical (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>, Methods).<fig id="Fig2"><label>Fig. 2</label><caption><title>Symphony approximates de novo integration without reintegration of the reference cells.</title><p>Three PBMC datasets were sequenced with different 10x protocols: 5’ (yellow, <inline-formula id="IEq5"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M10"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq5.gif"/></alternatives></inline-formula> = 7508 cells), 3’v2 (blue, <inline-formula id="IEq6"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M12"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq6.gif"/></alternatives></inline-formula> = 8305 cells), and 3’v1 (red, <inline-formula id="IEq7"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M14"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq7.gif"/></alternatives></inline-formula> = 4758 cells). We ran Symphony three times, each time mapping one dataset onto a reference built from integrating the other two. <bold>a</bold> Symphony embeddings generated across the three mapping experiments (columns). Top row: cells colored by query (yellow, blue, or red) or reference (gray), with query cells plotted in front. Bottom row: cells colored by cell type: B cells (B), dendritic cells (DC), hematopoietic stem cells (HSC), megakaryocytes (MK), CD14 + or CD16 + monocytes (Mono_CD14, Mono_CD16), natural killer cells (NK), or CD4 + or CD8 + T cells (T_CD4, T_CD8), with query cells plotted in front. <bold>b</bold> For comparison, gold standard de novo Harmony embedding colored by dataset (top) and cell type (bottom). <bold>c</bold> Distribution of technology LISI scores for query cell neighborhoods in the Symphony, gold standard, and a standard PCA embeddings on all cells, colored by query dataset. Boxplot center line represents the median; lower and upper box limits represent the 25% and 75% quantiles, respectively; whiskers extend to box limit ±1.5 × IQR; outlying points plotted individually. <bold>d</bold> Distributions of k-NN-corr (Spearman correlation between the distances between the neighbor-pairs in the gold standard embedding and the distances between the same neighbor-pairs in the Symphony embedding) across query cells for <inline-formula id="IEq8"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M16"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq8.gif"/></alternatives></inline-formula> = 500, colored by query dataset. Dotted vertical lines denote mean k-NN-corr. <bold>e</bold> Classification accuracy as measured by cell type F1-scores for query cell type annotation using 5-NN on the Symphony embedding.</p></caption><graphic xlink:href="41467_2021_25957_Fig2_HTML" id="d32e704"/></fig></p>
      <p id="Par12">To directly assess similarity of the local neighborhood structures, we computed the correlation between the local neighborhood adjacency graphs generated by Symphony and de novo integration. We define a new metric called k-nearest-neighbor correlation (k-NN-corr), which quantifies how well the local neighborhood structure in a given embedding is preserved in an alternative embedding by looking at the correlation of neighbor cells sorted by distance (Supplementary Fig. <xref rid="MOESM1" ref-type="media">2a–e</xref>; Methods). Anchoring on each query cell, we calculate (1) the pairwise distances to its <inline-formula id="IEq9"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M18"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq9.gif"/></alternatives></inline-formula> nearest reference neighbors in the gold standard embedding and (2) the distances between the same query-reference neighbor pairs in the alternate embedding (Methods), then calculate the Spearman correlation between (1) and (2). k-NN-corr ranges from -1 to +1, where +1 indicates a perfectly preserved sorted ordering of neighbors. We find that for <inline-formula id="IEq10"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M20"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq10.gif"/></alternatives></inline-formula> = 500, the Symphony embeddings produce a k-NN-corr &gt; 0.4 for 87.7% of cells (and positive k-NN-corr for 99.9% of cells), demonstrating that Symphony not only maps query cells to the correct broad cluster but also preserves the distance relationships between nearby cells in the same local region (Fig. <xref rid="Fig2" ref-type="fig">2d</xref>). As a comparison, we calculated k-NN-corr for a simple PC projection of the query cells (with no correction step) using the original reference gene loadings prior to integration and observed significantly lower correlations (Wilcoxon signed-rank <inline-formula id="IEq11"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p$$\end{document}</tex-math><mml:math id="M22"><mml:mi>p</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq11.gif"/></alternatives></inline-formula> &lt;2.2e-16), with k-NN-corr &gt;0.4 for 50.2% of cells (Supplementary Fig. <xref rid="MOESM1" ref-type="media">2f</xref>).</p>
    </sec>
    <sec id="Sec5">
      <title>Symphony enables accurate cell type classification of PBMCs across technologies</title>
      <p id="Par13">If Symphony is effective, then cells should be mapped close to cells of the same cell type, enabling accurate cell type classification. To test this, we performed post-mapping query cell type classification in the 10x PBMCs example from above. Once query cells are mapped into the reference low-dimensional feature embedding, users can choose any downstream model to predict query labels from the reference cells using their shared harmonized features as input (Methods). To demonstrate this, we used a simple and intuitive k-NN classifier to annotate query cells across 9 cell types based on the majority vote of each query cell’s 5 nearest reference neighbor cells in the harmonized embedding and compared the predictions to the ground truth labels assigned a priori with lineage-specific marker genes (Methods, Supplementary Tables <xref rid="MOESM1" ref-type="media">2</xref> and <xref rid="MOESM1" ref-type="media">3</xref>). Across all three experiments, predictions using the Symphony embeddings achieved 97.5% accuracy overall, with a median cell type F1-score (harmonic mean of precision and recall, ranging from 0 to 1) of 0.97 (Fig. <xref rid="Fig2" ref-type="fig">2e</xref>, Supplementary Table <xref rid="MOESM1" ref-type="media">4</xref>). This indicates that Symphony appropriately localizes query cells in harmonized space to enable the accurate transfer of cell type labels.</p>
      <p id="Par14">Automatic cell type classification represents an open area of research<sup><xref ref-type="bibr" rid="CR31">31</xref>,<xref ref-type="bibr" rid="CR35">35</xref>–<xref ref-type="bibr" rid="CR38">38</xref></sup>. Existing supervised classifiers assign a limited set of labels to new cells based on training data and/or marker genes. To benchmark Symphony-powered downstream inference against existing classifiers, we followed the same procedure as a benchmarking analysis in Abdelaal et al.<sup><xref ref-type="bibr" rid="CR35">35</xref></sup>. The benchmark compared 22 cell type classifiers on the PbmcBench dataset consisting of two PBMC samples sequenced using 7 different protocols<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>. For each protocol train-test pair (42 experiments) and donor train-test pair (additional 6 experiments; Methods), we built a Symphony reference from the training dataset then mapped the test dataset. We used the resulting harmonized feature embedding to predict query cell types using three downstream models: 5-NN, SVM with radial kernel, and multinomial logistic regression. The Symphony-based classifiers achieve consistently high cell type F1-scores (average median F1 of 0.79–0.87) comparable to the top three supervised classifiers for this benchmark (scmap-cell, singleCellNet, and SCINA, average median F1 of 0.77–0.83; Fig. <xref rid="Fig3" ref-type="fig">3a</xref> and Supplementary Fig. <xref rid="MOESM1" ref-type="media">3</xref>). As discussed in Abdelaal et al.<sup><xref ref-type="bibr" rid="CR35">35</xref></sup>, some classifiers (including SCINA) leave low-confidence cells as “unclassified.” Hence, for the Symphony-based k-NN model, we also enabled the option for Symphony to leave cells as unclassified based on a prediction confidence score (Methods), which measures the proportion of reference neighbors with the winning vote. For this option, we only assigned labels for cells with &gt;60% confidence (which excluded ~14% of cells). Notably, a limitation of this benchmark is that the reference in each experiment consists of a single dataset (no reference integration involved).<fig id="Fig3"><label>Fig. 3</label><caption><title>Symphony matches performance of top supervised classifiers and maps to large references within seconds.</title><p><bold>a</bold> Following the cross-technology PBMC benchmarking from Abdelaal et al.<sup><xref ref-type="bibr" rid="CR35">35</xref></sup>, we ran a total of 48 train-test experiments per Symphony-based classifier. Two different versions of the Symphony feature embeddings were generated depending on variable gene selection method: top 2000 variable genes (vargenes) or top 20 differentially genes (DEGs) expressed per cell type. Symphony embeddings were used to train 3 downstream classifiers: k-NN (<inline-formula id="IEq12"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M24"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq12.gif"/></alternatives></inline-formula> = 5), SVM with radial kernel, and multinomial logistic regression (GLM) with ridge. Symphony (blue) median cell-type F1-scores across 48 train-test experiments compared to supervised methods (white), demonstrating comparability to top supervised methods and stable performance regardless of downstream classification method. For “predconf&gt;0.6” options, only cells with &gt;60% prediction confidence were included (<inline-formula id="IEq13"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\ge$$\end{document}</tex-math><mml:math id="M26"><mml:mo>≥</mml:mo></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq13.gif"/></alternatives></inline-formula>4 out of 5 reference neighbors with winning vote). Boxplot center line represents the median (of median F1-scores); lower and upper box limits represent the 25% and 75% quantiles, respectively; whiskers extend to box limit ±1.5 × IQR; outlying points plotted individually. Red dot indicates mean of median F1-scores across 48 experiments (used for ordering along the <italic>x</italic>-axis). <bold>b</bold> Total elapsed time (in seconds) required to run Symphony reference building starting from gene expression (left), Symphony query mapping starting from query gene expression (middle), or de novo Harmony integration (right) for different-sized reference (<italic>x</italic>-axis) and query (colors) datasets downsampled from the memory T-cell CITE-seq dataset. <bold>c</bold> Runtime comparison between Symphony, Seurat, and scArches (colors), for building different-sized references (measured in mins) and mapping different-sized queries onto a 50,000-cell reference (measured in secs, plotted on log scale). Note: all methods were run on Linux CPUs (allotting 4 cores each for Symphony and Seurat, 48 cores for scArches). All jobs were allocated a maximum of 120 GB of memory and 24 h of runtime.</p></caption><graphic xlink:href="41467_2021_25957_Fig3_HTML" id="d32e844"/></fig></p>
    </sec>
    <sec id="Sec6">
      <title>Symphony maps against a large reference within seconds</title>
      <p id="Par15">To demonstrate scalability to large reference atlases, we evaluated Symphony’s computational speed. We downsampled a large memory T-cell dataset<sup><xref ref-type="bibr" rid="CR40">40</xref></sup> to create benchmark reference datasets with 20,000, 50,000, 100,000, 250,000, and 500,000 cells (from 12, 30, 58, 156, and 259 donors, respectively). Against each reference, we mapped three different-sized queries: 1000, 10,000, and 100,000 cells (from 1, 6, and 64 donors) and measured total elapsed runtime (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>). The speed of the reference building process is comparable to that of running de novo integration since they both start with expression data and require a full pipeline of scaling, PCA, and Harmony integration. However, a reference need only be built and saved once in order to map all subsequent query datasets onto it. For instance, initially building a 500,000-cell reference with Symphony took 5163 s (86.1 min) and mapping a subsequent 10,000-cell query onto it took only 0.99 s, compared to 4806 s (80.1 min) for de novo integration on all cells. Symphony offers a 5000x speedup in this application. Compared to alternative reference mapping approaches Seurat and scArches, Symphony was 1–3 orders of magnitude faster and the only method to scale to large datasets (&gt;100,000 cells) without requiring prohibitive memory (&gt;120 GB) or runtime (&gt;24 h) requirements (Fig. <xref rid="Fig3" ref-type="fig">3c</xref>, Methods, Supplementary Table <xref rid="MOESM1" ref-type="media">5</xref>). To directly test Symphony’s scalability to multimillion cell atlases, we built a reference of 1.39 million cells (270 samples) from a recent COVID-19 dataset<sup><xref ref-type="bibr" rid="CR41">41</xref></sup> in 17.7 h and mapped a held-out query of 72,781 (14 samples) in 11.0 s (Methods, Supplementary Fig. <xref rid="MOESM1" ref-type="media">4</xref>). These results show that Symphony scales efficiently to map against multimillion-cell references, enabling it to power potential web-based queries within seconds.</p>
      <p id="Par16">Importantly, Symphony mapping time does not depend on the number of cells or batches in the reference since the reference cells are modeled post-batch correction (Methods); however, it does depend on the reference complexity (number of centroids <inline-formula id="IEq14"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M28"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq14.gif"/></alternatives></inline-formula> and dimensions <inline-formula id="IEq15"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d$$\end{document}</tex-math><mml:math id="M30"><mml:mi>d</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq15.gif"/></alternatives></inline-formula>) and number of query cells and batches (Supplementary Tables <xref rid="MOESM1" ref-type="media">6</xref> and <xref rid="MOESM1" ref-type="media">7</xref>) since the query mapping algorithm solves for the query batch coefficients for each of the reference-defined clusters.</p>
    </sec>
    <sec id="Sec7">
      <title>Symphony maps multi-donor, multi-species study to reference of human pancreatic islet cells</title>
      <p id="Par17">A query dataset might include data from multiple donors, species, and perturbations that create confounding signals obscuring biological signal of interest. Integration algorithms remove these signals in de novo analysis, and it is essential that reference mapping removes them too. Therefore, we designed Symphony to simultaneously handle both tasks: mapping query to reference cells and integration within the query. To test the ability of Symphony to integrate query datasets during mapping, we analyzed reference and query datasets of pancreatic islet cells in which both the reference and query have complex experimental structure (Fig. <xref rid="Fig4" ref-type="fig">4a</xref>). The reference contained 5,887 pancreatic islet cells from 32 human donors across four independent studies<sup><xref ref-type="bibr" rid="CR42">42</xref>–<xref ref-type="bibr" rid="CR45">45</xref></sup>, each profiled with a different plate-based scRNA-seq technology (CEL-seq, CEL-seq2, Smart-seq2, and Fluidigm C1). Cell types were previously annotated using cluster-specific marker genes within each reference dataset separately (Methods). The query contained 8569 pancreatic islet cells from four human donors and 1866 cells from two mice, all profiled with inDrop, a droplet-based scRNA-seq technology absent in the reference<sup><xref ref-type="bibr" rid="CR46">46</xref></sup> (Fig. <xref rid="Fig4" ref-type="fig">4b</xref>). PCA of the query dataset alone demonstrated the magnitude of the confounding species and donor signals, emphasizing the need for within-query integration (Supplementary Fig. <xref rid="MOESM1" ref-type="media">5a</xref>).<fig id="Fig4"><label>Fig. 4</label><caption><title>Symphony maps multi-donor, multi-species study to human pancreatic islet cell reference.</title><p><bold>a</bold> Schematic of mapping experiment with reference (<inline-formula id="IEq16"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M32"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq16.gif"/></alternatives></inline-formula> = 5887 cells, 32 donors) built from four human pancreas datasets and query dataset (<inline-formula id="IEq17"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M34"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq17.gif"/></alternatives></inline-formula> = 10,455 cells, from four human donors and two mouse donors) sequenced on a new technology (inDrop). <bold>b</bold> Bar plot shows relative proportions of cell types per query donor. We integrated the reference datasets de novo using Harmony, Seurat anchor-based integration, or trVAE, then mapped the query onto the corresponding reference using Symphony, Seurat, or scArches, respectively. UMAP plots of the resulting joint embeddings showing <bold>c</bold> density of integrated reference cells colored by cell type and <bold>d</bold> individual query cells colored by cell type (as defined by Baron et al.<sup><xref ref-type="bibr" rid="CR46">46</xref></sup>) (left) or donor identity (right) with reference densities plotted in the back in gray. Degree of integration for each method was measured by LISI metric between reference and query labels (ref_query) (<bold>e</bold>) and LISI between query donors (<bold>f</bold>) for each query cell neighborhood, faceted by species (human: <inline-formula id="IEq18"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M36"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq18.gif"/></alternatives></inline-formula> = 8569 cells from four donors, mouse: <inline-formula id="IEq19"><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M38"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq19.gif"/></alternatives></inline-formula> = 1866 cells from two donors). Boxplot center line represents the median; lower and upper box limits represent the 25% and 75% quantiles, respectively; whiskers extend to box limit ±1.5 × IQR; outlying points plotted individually. <bold>g</bold> Degree to which the query low-dimensional structure is preserved after mapping, as measured by within-query k-NN correlation (wiq-kNN-corr, with <inline-formula id="IEq20"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M40"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq20.gif"/></alternatives></inline-formula> = 500) calculated across all query cells, within each query donor. Vertical lines indicate the mean wiq-kNN-corr.</p></caption><graphic xlink:href="41467_2021_25957_Fig4_HTML" id="d32e1011"/></fig></p>
      <p id="Par18">Symphony mapped the multi-species, multi-donor, droplet-based query into the reference by effectively and simultaneously removing the effects of species, donor, and technology (Fig. <xref rid="Fig4" ref-type="fig">4c, d</xref>); reference mapping obtained superior integration compared to PCA (mean donor LISI = 2.72 compared to 1.45). We predicted that integrating over three nested sources of variation would make it possible to accurately predict query cell types. Using a simple 5-NN classifier in the harmonized embedding, we observed accurate cell-type prediction. Using ground truth labels defined by the original publication<sup><xref ref-type="bibr" rid="CR46">46</xref></sup>, we obtained a median cell type F1-score of 0.96 (overall accuracy 96%) for human and median cell type F1 of 0.95 (overall accuracy 91%) for mouse cells (Supplementary Fig. <xref rid="MOESM1" ref-type="media">5c, d</xref> and Supplementary Tables <xref rid="MOESM1" ref-type="media">8</xref> and <xref rid="MOESM1" ref-type="media">9</xref>), By mapping against a reference, Symphony is able to overcome strong species effects and simultaneously map analogous cell types between mouse and human.</p>
      <p id="Par19">Next, we evaluated the ability of the other reference mapping algorithms, scArches and Seurat, to integrate the same query dataset. For each mapping method, we built a reference using its compatible de novo integration method (Methods, Fig. <xref rid="Fig4" ref-type="fig">4c</xref> and Supplementary Fig. <xref rid="MOESM1" ref-type="media">5b</xref>). Symphony obtained higher levels of integration than did Seurat and scArches, both between reference and query as well as donors within the query (Fig. <xref rid="Fig4" ref-type="fig">4e, f</xref> and Supplementary Table <xref rid="MOESM1" ref-type="media">10</xref>). Symphony mapping achieves comparable donor mixing to that of Harmony de novo integration of all five datasets (mean mapping LISI = 2.67 vs. de novo LISI = 2.55 in human, 2.91 vs. 2.7 in mouse, Supplementary Fig. <xref rid="MOESM1" ref-type="media">6c, d</xref>). In contrast, the other mapping methods return less integrated embeddings, when compared to their corresponding de novo methods (mean mapping LISI = 2.04 vs. de novo LISI = 2.96 for Seurat in human, 2.46 vs. 3.09 in mouse; 1.12 vs. 2.52 for scArches/trVAE in human, and 1.24 vs. 3.05 in mouse; Supplementary Fig. <xref rid="MOESM1" ref-type="media">6c, d</xref> and Supplementary Table <xref rid="MOESM1" ref-type="media">10</xref>). Reference mapping should place query cells into the reference embedding, but not at the expense of disrupting the query’s original low-dimensional structure. Therefore, we developed a new metric called within-query k-NN correlation (wiq-kNN-corr), which is similar to the k-NN-corr metric but instead measures how well the original query low-dimensional structure is preserved after mapping. Anchoring on each query cell, we calculate it’s (1) distances to the <inline-formula id="IEq21"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M42"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq21.gif"/></alternatives></inline-formula> nearest neighbors in the original query PCA embedding within each query batch (in this case, donor) and (2) the distances to those same <inline-formula id="IEq22"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M44"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq22.gif"/></alternatives></inline-formula> cells after reference mapping. Then, wiq-kNN-corr is the Spearman correlation between (1) and (2), ranging between –1 and 1 where higher values represent better retention of the sorted ordering of original neighbors. We observe that for <inline-formula id="IEq23"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M46"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq23.gif"/></alternatives></inline-formula> = 500, Symphony and Seurat exhibit nearly identical wiq-kNN-corr (mean wiq-kNN-corr = 0.59 in human, 0.55 in mouse for Symphony; 0.6 in human, 0.57 in mouse for Seurat), whereas scArches performs more poorly on this metric (0.19 in human, 0.13 in mouse) (Fig. <xref rid="Fig4" ref-type="fig">4g</xref>). Finally, we evaluated the cell type prediction accuracy of each method (Methods). We observed that Symphony and Seurat performed comparably well, and both outperformed scArches on both human and mouse cell type prediction (Supplementary Fig. <xref rid="MOESM1" ref-type="media">5c, d</xref> and Supplementary Tables <xref rid="MOESM1" ref-type="media">8</xref> and <xref rid="MOESM1" ref-type="media">9</xref>).</p>
    </sec>
    <sec id="Sec8">
      <title>Localizing query cells along a reference-defined trajectory of human fetal liver hematopoiesis</title>
      <p id="Par20">A successful mapping method should position cells not only within cell type clusters but also along smooth transcriptional gradients, commonly used to model differentiation and activation processes over time (Fig. <xref rid="Fig5" ref-type="fig">5a</xref>). To test Symphony in a gradient mapping context, we built a reference atlas profiling human fetal liver hematopoiesis, containing 113,063 liver cells from 14 donors spanning 7–17 post-conceptional weeks of age and 27 author-defined cell types, sequenced with 10x 3’ chemistry (Fig. <xref rid="Fig5" ref-type="fig">5b</xref> and Supplementary Fig. <xref rid="MOESM1" ref-type="media">7a</xref>)<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>. Trajectory analysis of immune populations with the force directed graph (FDG) algorithm<sup><xref ref-type="bibr" rid="CR47">47</xref></sup> highlights relationships among progenitor and differentiated cell types (Fig. <xref rid="Fig5" ref-type="fig">5c</xref>). Notably, the hematopoietic stem cell and multipotent progenitor population (HSC/MPP) branches into three major trajectories, representing the lymphoid, myeloid, and megakaryocyte-erythroid-mast (MEM) lineages. This reference contains two forms of annotation for downstream query inference: discrete cell types and positions along differentiation gradients.<fig id="Fig5"><label>Fig. 5</label><caption><title>Localizing query cells along a trajectory of fetal liver hematopoiesis.</title><p><bold>a</bold> Schematic showing precise placement of query cells along a continuous reference-defined trajectory. In this example (<bold>b</bold>–<bold>e</bold>), the reference (<inline-formula id="IEq24"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M48"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq24.gif"/></alternatives></inline-formula> = 113,063 cells, 14 donors) was sequenced using 10 x 3’ chemistry, and the query (<inline-formula id="IEq25"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M50"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq25.gif"/></alternatives></inline-formula> = 25,367 cells, 5 donors) was sequenced with 10x 5’ chemistry. <bold>b</bold> Symphony reference colored by cell types as defined by Popescu et al.<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>. Contour fill represents density of cells. Black points represent soft-cluster centroids in the Symphony mixture model. <bold>c</bold> Reference developmental trajectory of immune cells (FDG coordinates obtained from original authors). Query cells in the MEM lineages (<inline-formula id="IEq26"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M52"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq26.gif"/></alternatives></inline-formula> = 5141 cells) were mapped against the reference and query coordinates along the trajectory were predicted with 10-NN (<bold>d</bold>). The inferred query trajectory preserves branching within the MEM lineages, placing terminally differentiated states on the ends. <bold>e</bold> Expression of lineage marker genes (<italic>PPBP</italic> for megakaryocytes, <italic>HBB</italic> for erythroid cells, and <italic>KIT</italic> for mast cells). Cells colored by log-normalized expression of gene.</p></caption><graphic xlink:href="41467_2021_25957_Fig5_HTML" id="d32e1198"/></fig></p>
      <p id="Par21">We mapped a query consisting of 21,414 new cells from 5 of the original 14 donors, sequenced with 10x 5’ chemistry (Supplementary Fig. <xref rid="MOESM1" ref-type="media">7c</xref>). We first inferred query cell types with k-NN classification (Methods) and confirmed accurate cell type assignment based on the authors’ independent query annotations<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>, achieving median cell type F1-score of 0.83 and overall accuracy of 85.0% for <inline-formula id="IEq27"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M54"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq27.gif"/></alternatives></inline-formula> = 30 (Supplementary Fig. <xref rid="MOESM1" ref-type="media">8a</xref> and Supplementary Table <xref rid="MOESM1" ref-type="media">11</xref>). Correctly predicted cells generally had a higher proportion of reference neighbors supporting the predicted label (Supplementary Fig. <xref rid="MOESM1" ref-type="media">8b, c</xref>). To assess sensitivity to the parameter of <inline-formula id="IEq28"><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M56"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq28.gif"/></alternatives></inline-formula> for inference, we tested values of <inline-formula id="IEq29"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M58"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq29.gif"/></alternatives></inline-formula> ranging from 5 to 50 and found that median F1 remained highly stable (0.82–0.84) across choices of <inline-formula id="IEq30"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M60"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq30.gif"/></alternatives></inline-formula> (Supplementary Fig. <xref rid="MOESM1" ref-type="media">8d</xref>). To evaluate query trajectory inference, we used the Symphony joint embedding to position query cells from the MEM lineage (<inline-formula id="IEq31"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M62"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq31.gif"/></alternatives></inline-formula> = 5141) in the reference-defined trajectory by averaging the FDG coordinates of the 10 nearest reference cells (Supplementary Fig. <xref rid="MOESM1" ref-type="media">7c</xref>). The inferred query trajectory (Fig. <xref rid="Fig5" ref-type="fig">5d</xref>) recapitulated known branching from MEM progenitors (MEMPs, brown) into distinct megakaryocyte (green), erythroid (blue, pink), and mast cell (yellow) lineages. Moreover, transitions from MEMPs to differentiated types were marked by gradual changes in canonical marker genes (Fig. <xref rid="Fig5" ref-type="fig">5e</xref>): <italic>PPBP</italic> for megakaryocytes, <italic>HBB</italic> for erythrocytes, and <italic>KIT</italic> for mast cells. These gradual expression patterns are consistent with correct placement of query cells along differentiation gradients.</p>
    </sec>
    <sec id="Sec9">
      <title>Symphony helps identify query cell types missing in the reference</title>
      <p id="Par22">Although the first assumption of Symphony is that the reference is comprehensive, users may not always be aware if their query contains new “unseen” cell states prior to mapping. Symphony will typically map missing query states onto their most similar reference state(s) in these situations. To help users flag unseen cell states, we developed two metrics that help users detect and remove poorly mapping cells (Methods): (1) <italic>per-cell</italic> mapping metric and (2) <italic>per-cluster</italic> mapping metric. These metrics are based on Mahalanobis distance, a multivariate distance metric analogous to the univariate <italic>Z</italic>-score. They measure how far away query cells (1) or user-defined query clusters (2) are from the reference cell states in the low-dimensional embedding, where higher metrics indicate worse mapping.</p>
      <p id="Par23">In general, we found that these metrics were potentially useful for flagging novel cell types (Supplementary Note <xref rid="MOESM1" ref-type="media">1</xref>). For example, we tested the metric using the fetal liver hematopoiesis dataset described above and found that the ability to call out a query cell type as novel depends on the cell type as well as what is present in the reference (Supplementary Figs. <xref rid="MOESM1" ref-type="media">9</xref>–<xref rid="MOESM1" ref-type="media">11</xref>). In situations where the missing cell types are very different from the reference (mapping non-immune cell types like fibroblasts, endothelial cells, and hepatocytes onto an immune-only reference), the mapping metrics are able to clearly distinguish the missing cell states as novel (per-cell AUC = 0.997, per-cluster AUC = 1.0, Supplementary Fig. <xref rid="MOESM1" ref-type="media">9</xref>). In situations where the novel cell types are very similar to an existing reference cell state, the metrics may have more difficulty in identifying them. For example, when Kupffer cells (specialized tissue-resident liver macrophages) are missing in the reference (Supplementary Fig. <xref rid="MOESM1" ref-type="media">11</xref>), they map onto the closely related (immediate precursor) “Monocyte-Macrophage” reference cell state (per-cell AUC = 0.633, per-cluster AUC = 0.963). Our metrics are in general comparable to the Seurat mapping score, though different metrics offer the strongest performance under different scenarios (Supplementary Note <xref rid="MOESM1" ref-type="media">1</xref> and Supplementary Figs. <xref rid="MOESM1" ref-type="media">12</xref> and <xref rid="MOESM1" ref-type="media">13</xref>).</p>
    </sec>
    <sec id="Sec10">
      <title>Symphony maps tumor-derived cells onto a healthy atlas</title>
      <p id="Par24">Given that Symphony maps unseen query cells to their most similar reference type, we hypothesized that Symphony may be able to map tumor-derived cells onto an atlas of corresponding healthy tissue. As an exploratory analysis, we built a reference (<inline-formula id="IEq32"><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M64"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq32.gif"/></alternatives></inline-formula> = 27,203 cells) of healthy fetal kidney<sup><xref ref-type="bibr" rid="CR48">48</xref></sup> and mapped a renal cell carcinoma (RCC) dataset (<inline-formula id="IEq33"><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M66"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq33.gif"/></alternatives></inline-formula> = 34,326 cells)<sup><xref ref-type="bibr" rid="CR49">49</xref></sup>, transferring reference cell type labels to the query using 10-NN and comparing the predicted labels to the original annotations from Bi et al. (Methods, Fig. <xref rid="Fig6" ref-type="fig">6</xref>). As a sanity check, we observed excellent correspondence between the original and predicted annotations for immune and stromal cell types (Fig. <xref rid="Fig6" ref-type="fig">6c</xref>). We next examined the mapping results for the cells from the three tumor programs (TP1, TP2, and Cycling Tumor) originally defined by Bi et al. We found that TP1 and TP2 both primarily mapped to the reference “Proximal tubule” cell type and its direct precursor (“Medial S shaped body”); Cycling Tumor primarily mapped to “Medial S shaped body”, “Proximal tubule”, and “Proliferating distal renal vesicle,” concordant with a more actively proliferating phenotype (Fig. <xref rid="Fig6" ref-type="fig">6d</xref>). These results are consistent with prior literature, as RCC has been thought to arise from proximal tubule cells<sup><xref ref-type="bibr" rid="CR50">50</xref></sup>. Compared to the immune/stromal compartments, the tumor cells exhibited higher per-cell mapping metrics, indicating that they are less well-represented by the reference (Fig. <xref rid="Fig6" ref-type="fig">6e</xref>). This example demonstrates how intentionally mapping novel cell types, such as cancer cells onto a healthy atlas, can potentially provide biologically informative results.<fig id="Fig6"><label>Fig. 6</label><caption><title>Mapping tumor cells onto an atlas of healthy tissue.</title><p>We built a reference of healthy fetal kidney<sup><xref ref-type="bibr" rid="CR48">48</xref></sup> and mapped a renal cell carcinoma dataset<sup><xref ref-type="bibr" rid="CR49">49</xref></sup>. <bold>a</bold> UMAP of healthy fetal kidney reference (<inline-formula id="IEq34"><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M68"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq34.gif"/></alternatives></inline-formula> = 27,203 cells), colored by cell type as defined by the original publication. <bold>b</bold> Mapping tumor query dataset (which contains myeloid, lymphoid, stromal, and tumor compartments) onto the reference. Cells colored by reference (gray) or query compartment (as defined by original authors). <bold>c</bold>, <bold>d</bold> Heatmaps comparing original query cell types (rows), as defined by Bi et al., to the predicted reference cell types from Symphony (columns) for <bold>c</bold> immune and stromal compartments and <bold>d</bold> tumor cells. Color bar indicates the proportion of query cells per original cell type that were predicted to be of each reference type (rows sum to 1). Columns sorted by hierarchical clustering on the average gene expression (all genes) for the cell types to order similar types together. <bold>e</bold> Boxplot of per-cell mapping metric per query cell type (higher values indicate less confidence in the mapping), colored by tumor cells (orange) or immune/stromal (green) as defined in Bi et al. Boxplot shows query cells from 8 donors across 17 cell types: Cycling tumor (<inline-formula id="IEq35"><alternatives><tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M70"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq35.gif"/></alternatives></inline-formula> = 117 cells), Tumor program 2 (TP2, <inline-formula id="IEq36"><alternatives><tex-math id="M71">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M72"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq36.gif"/></alternatives></inline-formula> = 4599), Tumor program 1 (TP1, <inline-formula id="IEq37"><alternatives><tex-math id="M73">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M74"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq37.gif"/></alternatives></inline-formula> = 3324), Fibroblast (<inline-formula id="IEq38"><alternatives><tex-math id="M75">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M76"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq38.gif"/></alternatives></inline-formula> = 91), Endothelial (<inline-formula id="IEq39"><alternatives><tex-math id="M77">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M78"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq39.gif"/></alternatives></inline-formula> = 271), Tumor-associated macrophage (TAM, <inline-formula id="IEq40"><alternatives><tex-math id="M79">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M80"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq40.gif"/></alternatives></inline-formula> = 5053), Mitochondrial-High myeloid (<inline-formula id="IEq41"><alternatives><tex-math id="M81">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M82"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq41.gif"/></alternatives></inline-formula> = 1407), Mast cell (<inline-formula id="IEq42"><alternatives><tex-math id="M83">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M84"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq42.gif"/></alternatives></inline-formula> = 39), Monocyte (<inline-formula id="IEq43"><alternatives><tex-math id="M85">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M86"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq43.gif"/></alternatives></inline-formula> = 1157), Dendritic cell (DC, <inline-formula id="IEq44"><alternatives><tex-math id="M87">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M88"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq44.gif"/></alternatives></inline-formula> = 419), Plasma cell (<inline-formula id="IEq45"><alternatives><tex-math id="M89">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M90"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq45.gif"/></alternatives></inline-formula> = 463), T-Helper (<inline-formula id="IEq46"><alternatives><tex-math id="M91">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M92"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq46.gif"/></alternatives></inline-formula> = 3284), CD8 + T cell (<inline-formula id="IEq47"><alternatives><tex-math id="M93">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M94"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq47.gif"/></alternatives></inline-formula> = 9056), Natural killer (NK, <inline-formula id="IEq48"><alternatives><tex-math id="M95">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M96"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq48.gif"/></alternatives></inline-formula> = 2245), B cell (<inline-formula id="IEq49"><alternatives><tex-math id="M97">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M98"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq49.gif"/></alternatives></inline-formula> = 962), T-Regulatory cell (T-Reg, <inline-formula id="IEq50"><alternatives><tex-math id="M99">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M100"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq50.gif"/></alternatives></inline-formula> = 750), and Natural killer T cell (NKT, <inline-formula id="IEq51"><alternatives><tex-math id="M101">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M102"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq51.gif"/></alternatives></inline-formula> = 811). Boxplot center line represents the median for the cell type; lower and upper box limits represent the 25% and 75% quantiles, respectively; whiskers extend to box limit ±1.5 × IQR; outlying points plotted individually.</p></caption><graphic xlink:href="41467_2021_25957_Fig6_HTML" id="d32e1604"/></fig></p>
    </sec>
    <sec id="Sec11">
      <title>Extension of Symphony to scATAC-seq data</title>
      <p id="Par25">We next wondered whether Symphony may be extended to other single-cell modalities, especially scATAC-seq. As a proof-of-concept analysis, we built a reference (<inline-formula id="IEq52"><alternatives><tex-math id="M103">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M104"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq52.gif"/></alternatives></inline-formula> = 1736 cells) using a published scATAC-seq dataset of flow-sorted cells capturing hematopoietic differentiation<sup><xref ref-type="bibr" rid="CR51">51</xref>,<xref ref-type="bibr" rid="CR52">52</xref></sup>, leaving out one donor (<inline-formula id="IEq53"><alternatives><tex-math id="M105">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M106"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq53.gif"/></alternatives></inline-formula> = 298 cells) to map as a query (Supplementary Fig. <xref rid="MOESM1" ref-type="media">14</xref>). We modified Symphony to use the shared open chromatin peaks as input features rather than genes (Methods) and were able to map the query cells such that 84% of cells were assigned their known cell type or the immediate precursor type (Supplementary Fig. <xref rid="MOESM1" ref-type="media">14d, e</xref>).</p>
    </sec>
    <sec id="Sec12">
      <title>Inferring query surface protein marker expression by mapping to a reference assayed with CITE-seq</title>
      <p id="Par26">Recent technological advances in multimodal single-cell technologies (e.g., CITE-seq) make it possible to simultaneously measure mRNA and surface protein expression from the same cells using oligonucleotide-tagged antibodies<sup><xref ref-type="bibr" rid="CR53">53</xref>,<xref ref-type="bibr" rid="CR54">54</xref></sup>. With Symphony, we can construct a reference from these data, map query cells from experiments that measure only mRNA expression, and infer surface protein expression for the query cells to expand possible analyses and interpretations (Fig. <xref rid="Fig7" ref-type="fig">7a</xref>).<fig id="Fig7"><label>Fig. 7</label><caption><title>Mapping onto a multimodal reference to infer query surface protein expression in memory T cells.</title><p><bold>a</bold> Schematic of multimodal mapping experiment. The dataset was divided into training and test sets (80% and 20% of samples, respectively). The training set was used to build a Symphony reference, and the test set was mapped onto the reference to predict surface protein expression in query cells (pink) based on 50-NN reference cells (gray). <bold>b</bold> Symphony reference built from mRNA/protein CCA embedding. Contour fill represents density of reference cells (<inline-formula id="IEq54"><alternatives><tex-math id="M107">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M108"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq54.gif"/></alternatives></inline-formula> = 395,373 cells from 217 samples). Black points represent soft-cluster centroids in the Symphony mixture model. <bold>c</bold> We measured the accuracy of protein expression prediction with the Pearson correlation between predicted and ground truth expression for each surface protein across query cells in each donor (total <inline-formula id="IEq55"><alternatives><tex-math id="M109">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M110"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq55.gif"/></alternatives></inline-formula> = 104,716 cells from 54 samples). Bar height represents the mean per-donor correlation for each protein, error bars represent standard deviation, and individual data points show correlation values per donor. <bold>d</bold> Ground truth and predicted expression of CD4, CCR6, and CD69 based on CCA reference. Ground truth is the 50-NN-smoothed expression measured in the CITE-seq experiment. Colors are scaled independently for each marker from minimum (blue) to maximum (yellow) expression.</p></caption><graphic xlink:href="41467_2021_25957_Fig7_HTML" id="d32e1699"/></fig></p>
      <p id="Par27">To demonstrate this, we used a CITE-seq dataset that measures the expression of whole-transcriptome mRNA and 30 surface proteins on 500,089 peripheral blood memory T cells from 271 samples<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>. We leveraged both mRNA and protein features to build a multimodal reference from 80% of samples (<inline-formula id="IEq56"><alternatives><tex-math id="M111">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M112"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq56.gif"/></alternatives></inline-formula> = 217) and map the remaining 20% of samples (<inline-formula id="IEq57"><alternatives><tex-math id="M113">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M114"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq57.gif"/></alternatives></inline-formula> = 54). Instead of using PCA, which is best for one modality<sup><xref ref-type="bibr" rid="CR55">55</xref></sup>, we used canonical correlation analysis (CCA) to embed reference cells into a space that leverages both. Specifically, CCA constructs a pair of correlated low-dimensional embeddings, one for mRNA and one for protein features, each with a linear projection function akin to gene loadings in PCA. We corrected reference batch effects in CCA space with Harmony and built a Symphony reference (Fig. <xref rid="Fig7" ref-type="fig">7b</xref>), saving the gene loadings for the CCA embedding from mRNA features. Then, we mapped the held-out query using only mRNA expression to mimic a unimodal scRNA-seq experiment, reserving the measured query surface protein expression for validation. To mitigate sparsity and variability in detection, we defined ground truth protein values using 50-NN smoothing of the measured values from CITE-seq (i.e., averaging the expression of 50 nearest neighbors in the embedding, Methods). We accurately predicted the surface protein expression of each query cell using the 50-NN average from the nearest reference cells in the harmonized embedding. For all proteins, we found strong concordance between predicted and ground truth expression (Pearson <inline-formula id="IEq58"><alternatives><tex-math id="M115">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$r$$\end{document}</tex-math><mml:math id="M116"><mml:mi>r</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq58.gif"/></alternatives></inline-formula>: 0.88–0.99, Fig. <xref rid="Fig7" ref-type="fig">7c, d</xref>). For all but three proteins, we achieved comparable results with as few as 5 or 10 nearest neighbors (Supplementary Fig. <xref rid="MOESM1" ref-type="media">15a</xref>).</p>
      <p id="Par28">We note that it is also possible to conduct the same analysis with a unimodal PCA-based reference built from the cells’ mRNA expression only. This approach has slightly worse performance for some proteins (Pearson <inline-formula id="IEq59"><alternatives><tex-math id="M117">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$r$$\end{document}</tex-math><mml:math id="M118"><mml:mi>r</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq59.gif"/></alternatives></inline-formula>: 0.65–0.97, Supplementary Fig. <xref rid="MOESM1" ref-type="media">15b–d</xref>), demonstrating that a reference built jointly on both mRNA and protein permits better inference of protein expression than an mRNA-only reference, which is consistent with previous observations that mRNA expression is not fully representative of protein expression<sup><xref ref-type="bibr" rid="CR53">53</xref>,<xref ref-type="bibr" rid="CR54">54</xref></sup>. This analysis highlights how users can start with a low-dimensional embedding other than PCA, such as CCA, to better capture rich multimodal information in the reference.</p>
    </sec>
  </sec>
  <sec id="Sec13" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par29">Mapping query cells onto large, annotated references in real time and without the need to share sensitive information from the reference datasets is becoming increasingly important for reproducible single-cell analysis. We approached this inherently complex, big-data problem using well-established mathematical methods from integration analysis. We framed reference mapping as a specialized case of integration between one relatively small dataset and a second larger, more comprehensive, and previously integrated dataset. As the reference is already integrated, it is natural to use the same mathematical framework from the integration to perform mapping. For instance, the scArches<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> algorithm uses an autoencoder-based framework to map to references built with autoencoder-based integration algorithms<sup><xref ref-type="bibr" rid="CR32">32</xref>,<xref ref-type="bibr" rid="CR33">33</xref></sup>. Similarly, Symphony uses the mixture modeling framework to map to references built with Harmony mixture modeling integration. Symphony compresses the reference by extracting relevant reference-derived parameters from the mixture model to map query cells in seconds. With this compression, references can be distributed without the need to share raw expression data or donor-level metadata, which enables data privacy<sup><xref ref-type="bibr" rid="CR56">56</xref></sup>. Symphony compression greatly reduces the size of a reference dataset: for the memory T-cell dataset of 500,089 cells, the raw expression matrix is 8.9 GB, whereas the Symphony minimal reference elements are 1.3 MB.</p>
    <p id="Par30">Useful reference atlases contain annotations absent in the query, such as cell type labels (Fig. <xref rid="Fig4" ref-type="fig">4</xref>), trajectory coordinates (Fig. <xref rid="Fig5" ref-type="fig">5</xref>), or multimodal measurements (Fig. <xref rid="Fig7" ref-type="fig">7</xref>). Reference mapping can also be useful to standardize multiple query datasets derived from different sources into a common embedding or set of labels for downstream analysis, such as testing for differential abundance of cell states between groups (e.g., cases vs. controls)<sup><xref ref-type="bibr" rid="CR57">57</xref>–<xref ref-type="bibr" rid="CR59">59</xref></sup>. Transfer of annotations from reference to query is an open area of research that includes algorithms for automated cell type classification<sup><xref ref-type="bibr" rid="CR31">31</xref>,<xref ref-type="bibr" rid="CR35">35</xref>–<xref ref-type="bibr" rid="CR38">38</xref></sup>. We approach annotation transfer in two steps. We first learn a predictive model in the reference embedding, and then map query cells and use their reference coordinates to predict query annotations. In this two-step approach, Symphony mapping provides a feature space but is otherwise independent from the choice of downstream inference model. In PBMC type prediction (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>), we used Symphony embeddings to train multiple competitive classifiers: k-NN, SVM, and logistic regression. In our specific analyses, we found that a simple k-NN classifier can achieve high performance with only 5–10 neighbors, and modestly outperformed SVM and logistic regression (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>). In practice, users can choose more complex inference models if it is warranted for certain annotations. Moreover, we expect prediction results to improve as more standardized annotations emerge, such as pre-defined cell type taxonomies provided by the Cell Ontology<sup><xref ref-type="bibr" rid="CR60">60</xref></sup> project.</p>
    <p id="Par31">Single-cell reference mapping using modalities beyond scRNA-seq poses unique challenges. For example, in scATAC-seq, peaks are not standardized and are typically redefined by peak calling algorithms in each analysis. Hence, it is not immediately clear how to optimally select the best peak features to perform reference mapping when reference and query datasets have been analyzed with different peak sets. One approach may be to remap query reads to the reference open chromatin regions or binning the genome into small (e.g., 500 or 1 kbp) regions. As another example, multimodal single-cell integration is an important area of active research. For the CITE-seq analysis, we used one strategy (CCA) based on finding shared variation between modalities<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>, but alternative approaches have been proposed<sup><xref ref-type="bibr" rid="CR30">30</xref>,<xref ref-type="bibr" rid="CR61">61</xref></sup> that may be optimal for specific applications.</p>
    <p id="Par32">As mapping is a special case of integration, we expected Symphony mapping to recapitulate the results of de novo Harmony integration. To this end, we defined three conditions under which Symphony and de novo integration with Harmony yield equivalent results. In subsequent examples, we showed that Symphony still performs well when the last two conditions are relaxed. The pancreas query contains more cells than its reference (condition II), while the liver hematopoiesis reference and query overlap in donors (condition III). Condition I, which requires comprehensive cell type coverage in the reference, is less flexible. When the query contains a novel cell type, it will be aligned to its most transcriptionally similar reference cluster. In some cases, this may be advantageous. For example, one can intentionally utilize this behavior to find similar reference cell states, such as mapping tumor cells onto healthy tissue (Fig. <xref rid="Fig6" ref-type="fig">6</xref>). Note that condition I only pertains to cell types and not clinical and biological contexts. For instance, we successfully mapped the mouse pancreas query to an entirely human pancreas reference (Fig. <xref rid="Fig4" ref-type="fig">4</xref>), because the same pancreatic cell types are shared in both species.</p>
    <p id="Par33">Identification of novel cell-types that have failed to map is an important future direction for mapping algorithms. To identify potentially novel cell-types, we provide two mapping metrics and a prediction confidence score to aid users in flagging and removing poorly mapping cells. We recognize that these metrics may be less informative in cases where the novel population is very similar to an existing reference population. Hence, Symphony does not entirely supplant the need for users interested in novel cell type discovery to conduct de novo analyses of the query alone.</p>
    <p id="Par34">Choosing which reference(s) to use is a key question in a reference-based analysis. When selecting a reference, one should consider (1) the relevance and comprehensiveness of the reference relative to the biological question of interest, (2) similarity of the cell-types being queried, (3) similarity of the technology used to assay the reference versus the query, (4) quality and resolution of cell-level annotations and any associated metadata, including the availability of additional modalities (e.g., CITE-seq), and (5) reference size (number of cells and samples included). For instance, a cell-type-specific embedding like the memory T-cell reference (Fig. <xref rid="Fig7" ref-type="fig">7</xref>) may be able to capture more variability within a given cell type compared to an unsorted PBMCs reference (Fig. <xref rid="Fig2" ref-type="fig">2</xref>), which may better capture variability across multiple immune populations. Similarly, a reference with only healthy individuals is useful for annotating normal cell types, while a reference with both healthy and diseased individuals is useful for annotating both physiologic and pathologic cell states. It may also be useful to map the query to several references and consider the results in aggregate. For example, one may first map cells to a comprehensive atlas for the tissue or context of interest for coarse-grained annotations, then remap cells from certain cell types onto cell-type-specific references (e.g., T-cell-only) for more fine-grained annotations.</p>
    <p id="Par35">Instead of a single monolithic reference for all cell types across all tissues and disease, we expect the proliferation of multiple, well-annotated specialized references that focus on fine-grained modeling of diverse biological systems. In this initial release of Symphony, we provide eight pre-built reference atlases (Table <xref rid="Tab1" ref-type="table">1</xref>) and an efficient, user-friendly pipeline to facilitate community expansion of high-quality references for the single-cell community. We encourage atlas builders to share their datasets as a mappable reference on open-access data repositories, such as Zenodo. As more large-scale tissue and whole-organism single-cell reference atlases become available in the near future, Symphony will enable investigators to leverage the rich information in these references to perform integrative analyses and transfer reference coordinates and diverse annotations to new datasets in a rapid and reproducible manner.<table-wrap id="Tab1"><label>Table 1</label><caption><p>A compendium of pre-built Symphony reference atlases.</p></caption><table frame="hsides" rules="groups"><thead><tr><th/><th>Name</th><th>Description</th><th>Zenodo Link</th><th>Data source</th></tr></thead><tbody><tr><td>1</td><td>10x PBMCs Atlas</td><td>Healthy human PBMCs (<inline-formula id="IEq60"><alternatives><tex-math id="M119">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M120"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq60.gif"/></alternatives></inline-formula> = 20,571) sequenced using three 10x protocols (3’v1, 3’v2, 5’)</td><td>Link [<ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/5090425">https://zenodo.org/record/5090425</ext-link>]</td><td>10x Genomics</td></tr><tr><td>2</td><td>Pancreatic Islet Cells Atlas</td><td>Pancreatic islet cells (<inline-formula id="IEq61"><alternatives><tex-math id="M121">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M122"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq61.gif"/></alternatives></inline-formula> = 5887) from 32 human donors; from 4 separate studies</td><td>Link [<ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/5090425">https://zenodo.org/record/5090425</ext-link>]</td><td>Segerstolpe et al.<sup><xref ref-type="bibr" rid="CR42">42</xref></sup>; Lawlor et al.<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>; Grun et al.<sup><xref ref-type="bibr" rid="CR44">44</xref></sup>; Muraro et al.<sup><xref ref-type="bibr" rid="CR45">45</xref></sup></td></tr><tr><td>3</td><td>Fetal Liver Hematopoiesis Atlas</td><td>Human fetal liver cells (<inline-formula id="IEq62"><alternatives><tex-math id="M123">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M124"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq62.gif"/></alternatives></inline-formula> = 113,063) from 14 donors, sequenced with 10x (3’)</td><td>Link [<ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/5090425">https://zenodo.org/record/5090425</ext-link>]</td><td>Popescu et al.<sup><xref ref-type="bibr" rid="CR47">47</xref></sup></td></tr><tr><td>4</td><td>Healthy Fetal Kidney Atlas</td><td>Human fetal kidney cells (<inline-formula id="IEq63"><alternatives><tex-math id="M125">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M126"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq63.gif"/></alternatives></inline-formula>= 27,203) from 6 samples</td><td>Link [<ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/5090425">https://zenodo.org/record/5090425</ext-link>]</td><td>Stewart et al.<sup><xref ref-type="bibr" rid="CR48">48</xref></sup></td></tr><tr><td>5</td><td>Memory T Cell (CITE-seq) Atlas</td><td>Human memory T cells (<inline-formula id="IEq64"><alternatives><tex-math id="M127">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M128"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq64.gif"/></alternatives></inline-formula> = 500,089) from a tuberculosis cohort (259 donors) assayed with CITE-seq</td><td>Link [<ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/5090425">https://zenodo.org/record/5090425</ext-link>]</td><td>Nathan et al.<sup><xref ref-type="bibr" rid="CR40">40</xref></sup></td></tr><tr><td>6</td><td>Cross-tissue Fibroblast Atlas</td><td>Human fibroblasts (<inline-formula id="IEq65"><alternatives><tex-math id="M129">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M130"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq65.gif"/></alternatives></inline-formula> = 79,148) from 74 samples spanning 4 inflammatory tissues and corresponding controls</td><td>Link [<ext-link ext-link-type="uri" xlink:href="https://sandbox.zenodo.org/record/772596#.YOdFIhNKjlw">https://sandbox.zenodo.org/record/772596#.YOdFIhNKjlw</ext-link>]</td><td>Korsunsky et al.<sup><xref ref-type="bibr" rid="CR25">25</xref></sup></td></tr><tr><td>7</td><td>Cross-tissue Inflammatory Immune Atlas</td><td>Immune cells (<inline-formula id="IEq66"><alternatives><tex-math id="M131">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M132"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq66.gif"/></alternatives></inline-formula> = 307,084) from 125 healthy or disease-affected donors across 6 inflammatory diseases</td><td>Link [<ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/5090425">https://zenodo.org/record/5090425</ext-link>]</td><td>Zhang et al.<sup><xref ref-type="bibr" rid="CR26">26</xref></sup></td></tr><tr><td>8</td><td>Tabula Muris Senis (FACS) Atlas</td><td>Mouse cells from 23 tissues and organs (<inline-formula id="IEq67"><alternatives><tex-math id="M133">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M134"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq67.gif"/></alternatives></inline-formula> = 110,824 cells) across the lifespan.</td><td>Link [<ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/5090425">https://zenodo.org/record/5090425</ext-link>]</td><td>The Tabula Muris Consortium<sup><xref ref-type="bibr" rid="CR62">62</xref></sup></td></tr></tbody></table></table-wrap></p>
  </sec>
  <sec id="Sec14">
    <title>Methods</title>
    <sec id="Sec15">
      <title>Symphony overview</title>
      <p id="Par36">The goal of single-cell reference mapping is to embed newly assayed query cells into an existing comprehensive reference atlas, facilitating the automated transfer of annotations from the reference to the query. The optimal mapping method needs to be able to operate at various levels of resolution, capture continuous intermediate cell states, and scale to multimillion cells<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. Consider a scenario in which we wish to map a query of <inline-formula id="IEq68"><alternatives><tex-math id="M135">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m$$\end{document}</tex-math><mml:math id="M136"><mml:mi>m</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq68.gif"/></alternatives></inline-formula> cells against reference datasets with <inline-formula id="IEq69"><alternatives><tex-math id="M137">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M138"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq69.gif"/></alternatives></inline-formula> cells, where <inline-formula id="IEq70"><alternatives><tex-math id="M139">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m\ll n$$\end{document}</tex-math><mml:math id="M140"><mml:mi>m</mml:mi><mml:mo>≪</mml:mo><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq70.gif"/></alternatives></inline-formula>. Unsupervised integration of measurements across donors, studies, and technological platforms is the standard way to compare single-cell datasets and identify cell types. Hence, a “gold standard” reference mapping strategy might be to run Harmony integration on all <inline-formula id="IEq71"><alternatives><tex-math id="M141">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m+n$$\end{document}</tex-math><mml:math id="M142"><mml:mi>m</mml:mi><mml:mo>+</mml:mo><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq71.gif"/></alternatives></inline-formula> cells de novo. However, this approach is impractical because it is cumbersome and time-intensive to process all the cell-level data for the reference datasets every time a user wishes to reharmonize it with a query. Instead, we envision a pipeline where a reference atlas need only be carefully constructed and integrated once, and all subsequent queries can be rapidly mapped into the same stable reference embedding.</p>
      <p id="Par37">Symphony is a reference mapping method that efficiently places query cells in their precise location within an integrated low-dimensional embedding of reference cells, approximating de novo harmonization without the need to reintegrate the reference cells. Symphony comprises of two algorithms: reference compression and mapping. Expanding upon the linear mixture model framework introduced in Harmony<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, Symphony compression takes in an integrated reference and faithfully compresses it by capturing the components of the model into efficient data structures. The output of reference compression is the minimal set of elements needed for mapping (Supplementary Fig. <xref rid="MOESM1" ref-type="media">1b</xref>). The Symphony mapping algorithm takes as input a new query dataset as well as minimal reference elements and returns the appropriate locations of the query cells within the integrated embedding (Supplementary Fig. <xref rid="MOESM1" ref-type="media">1c</xref>).</p>
      <p id="Par38">Once a harmonized reference is constructed and compressed using Symphony, subsequent mapping of query cells executes within seconds. Efficient implementations of Symphony are available as part of an R package at <ext-link ext-link-type="uri" xlink:href="https://github.com/immunogenomics/symphony">https://github.com/immunogenomics/symphony</ext-link>, along with several precomputed references constructed from public scRNA-seq datasets. The following sections introduce the Symphony model, then describes Symphony compression and mapping in terms of the underlying data structures and algorithms. We also provide Supplementary Methods containing more detailed derivations for reference compression terms.</p>
    </sec>
    <sec id="Sec16">
      <title>Glossary</title>
      <p id="Par39">We define all symbols for data structures used in the discussion of Symphony below, including their dimensions and possible values. Dimensions are in terms of the following parameters:</p>
      <p id="Par40"><inline-formula id="IEq72"><alternatives><tex-math id="M143">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M144"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq72.gif"/></alternatives></inline-formula> the number of reference cells</p>
      <p id="Par41"><inline-formula id="IEq73"><alternatives><tex-math id="M145">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m$$\end{document}</tex-math><mml:math id="M146"><mml:mi>m</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq73.gif"/></alternatives></inline-formula> the number of query cells</p>
      <p id="Par42"><inline-formula id="IEq74"><alternatives><tex-math id="M147">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N$$\end{document}</tex-math><mml:math id="M148"><mml:mi>N</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq74.gif"/></alternatives></inline-formula> the total number of cells <inline-formula id="IEq75"><alternatives><tex-math id="M149">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$(n+m)$$\end{document}</tex-math><mml:math id="M150"><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>+</mml:mo><mml:mi>m</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq75.gif"/></alternatives></inline-formula></p>
      <p id="Par43"><inline-formula id="IEq76"><alternatives><tex-math id="M151">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$g$$\end{document}</tex-math><mml:math id="M152"><mml:mi>g</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq76.gif"/></alternatives></inline-formula> the number of genes in the reference after any gene selection</p>
      <p id="Par44"><inline-formula id="IEq77"><alternatives><tex-math id="M153">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d$$\end{document}</tex-math><mml:math id="M154"><mml:mi>d</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq77.gif"/></alternatives></inline-formula> the dimensionality of the embedding (e.g., PCs); applies to both reference and query.</p>
      <p id="Par45"><inline-formula id="IEq78"><alternatives><tex-math id="M155">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$b$$\end{document}</tex-math><mml:math id="M156"><mml:mi>b</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq78.gif"/></alternatives></inline-formula> the number of batches in the reference</p>
      <p id="Par46"><inline-formula id="IEq79"><alternatives><tex-math id="M157">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$c$$\end{document}</tex-math><mml:math id="M158"><mml:mi>c</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq79.gif"/></alternatives></inline-formula> the number of batches in the query</p>
      <p id="Par47"><inline-formula id="IEq80"><alternatives><tex-math id="M159">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M160"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq80.gif"/></alternatives></inline-formula> the number of clusters in the mixture model for reference integration (representing latent cell states)</p>
      <p id="Par48">
        <table-wrap id="Taba">
          <table frame="hsides" rules="groups">
            <thead>
              <tr>
                <th colspan="2">Reference-related symbols:</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <inline-formula id="IEq81">
                    <alternatives>
                      <tex-math id="M161">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{r}}}}}}}\in {{\mathbb{R}}}^{g\times n}$$\end{document}</tex-math>
                      <mml:math id="M162">
                        <mml:msub>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">G</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">r</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi mathvariant="double-struck">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>g</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mi>n</mml:mi>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq81.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Input reference gene expression matrix, prior to scaling.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq82">
                    <alternatives>
                      <tex-math id="M163">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{rs}}}}}}}\in {{\mathbb{R}}}^{g\times n}$$\end{document}</tex-math>
                      <mml:math id="M164">
                        <mml:msub>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">G</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">rs</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi mathvariant="double-struck">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>g</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mi>n</mml:mi>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq82.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Scaled reference gene expression matrix.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq83">
                    <alternatives>
                      <tex-math id="M165">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{r}}}}}}}\in {\{0,1\}}^{b\times n}$$\end{document}</tex-math>
                      <mml:math id="M166">
                        <mml:msub>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">X</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">r</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mrow>
                              <mml:mo>{</mml:mo>
                              <mml:mrow>
                                <mml:mn>0</mml:mn>
                                <mml:mo>,</mml:mo>
                                <mml:mn>1</mml:mn>
                              </mml:mrow>
                              <mml:mo>}</mml:mo>
                            </mml:mrow>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>b</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mi>n</mml:mi>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq83.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>One-hot design matrix assigning reference cells (columns) to batches (rows).</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq84">
                    <alternatives>
                      <tex-math id="M167">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{r}}}}}}}^{{{{\prime} }}}\in {\{0\}}^{c\times n}$$\end{document}</tex-math>
                      <mml:math id="M168">
                        <mml:msubsup>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">X</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">r</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mo>′</mml:mo>
                          </mml:mrow>
                        </mml:msubsup>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mrow>
                              <mml:mo>{</mml:mo>
                              <mml:mrow>
                                <mml:mn>0</mml:mn>
                              </mml:mrow>
                              <mml:mo>}</mml:mo>
                            </mml:mrow>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>c</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mi>n</mml:mi>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq84.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Zero matrix assigning reference cells (cols) to <italic>query</italic> batches (rows). All values are 0 because reference cells do not belong to query batches. This term is used in the derivation for the reference compression terms.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq85">
                    <alternatives>
                      <tex-math id="M169">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\mu }}}}}}\in {{\mathbb{R}}}^{g\times 1}$$\end{document}</tex-math>
                      <mml:math id="M170">
                        <mml:mi mathvariant="bold">μ</mml:mi>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi mathvariant="double-struck">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>g</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mn>1</mml:mn>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq85.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Reference gene means used to center each gene for PCA.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq86">
                    <alternatives>
                      <tex-math id="M171">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\sigma }}}}}}\in {{\mathbb{R}}}^{g\times 1}$$\end{document}</tex-math>
                      <mml:math id="M172">
                        <mml:mi mathvariant="bold">σ</mml:mi>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi mathvariant="double-struck">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>g</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mn>1</mml:mn>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq86.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Reference gene standard deviations used to scale each gene for PCA.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq87">
                    <alternatives>
                      <tex-math id="M173">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{U}}}}}}\in {{\mathbb{R}}}^{g\times d}$$\end{document}</tex-math>
                      <mml:math id="M174">
                        <mml:mi mathvariant="bold">U</mml:mi>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi mathvariant="double-struck">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>g</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mi>d</mml:mi>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq87.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Gene loadings from the original PCA (before Harmony integration).</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq88">
                    <alternatives>
                      <tex-math id="M175">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{r}}}}}}}={{{{{{\mathbf{\Sigma }}}}}}}_{{{{{{\bf{r}}}}}}}{{{{{{\bf{V}}}}}}}_{{{{{{\bf{r}}}}}}}^{{{{{{\bf{T}}}}}}}\in {{\mathbb{R}}}^{d\times n}$$\end{document}</tex-math>
                      <mml:math id="M176">
                        <mml:msub>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">Z</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">r</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                        <mml:mo>=</mml:mo>
                        <mml:msub>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">Σ</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">r</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                        <mml:msubsup>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">V</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">r</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">T</mml:mi>
                          </mml:mrow>
                        </mml:msubsup>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi mathvariant="double-struck">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>d</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mi>n</mml:mi>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq88.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Original (pre-harmonized) PC embedding for reference cells.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq89">
                    <alternatives>
                      <tex-math id="M177">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{r}}}}}}}\in {{\mathbb{R}}}^{d\times n}$$\end{document}</tex-math>
                      <mml:math id="M178">
                        <mml:msub>
                          <mml:mrow>
                            <mml:mover accent="true">
                              <mml:mrow>
                                <mml:mi mathvariant="bold">Z</mml:mi>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mo>^</mml:mo>
                              </mml:mrow>
                            </mml:mover>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">r</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi mathvariant="double-struck">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>d</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mi>n</mml:mi>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq89.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Integrated embedding for reference cells in harmonized PC (hPC) space, as output by Harmony.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq90">
                    <alternatives>
                      <tex-math id="M179">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{r}}}}}}}\in {[0,1]}^{k\times n}$$\end{document}</tex-math>
                      <mml:math id="M180">
                        <mml:msub>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">r</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mrow>
                              <mml:mo>[</mml:mo>
                              <mml:mrow>
                                <mml:mn>0</mml:mn>
                                <mml:mo>,</mml:mo>
                                <mml:mn>1</mml:mn>
                              </mml:mrow>
                              <mml:mo>]</mml:mo>
                            </mml:mrow>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>k</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mi>n</mml:mi>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq90.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Soft cluster assignment of reference cells (cols) to clusters (rows), output by Harmony. Each column is a probability distribution that sums to 1.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq91">
                    <alternatives>
                      <tex-math id="M181">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Y}}}}}}}_{{{\cos }}}\in {{\mathbb{R}}}^{d\times k}$$\end{document}</tex-math>
                      <mml:math id="M182">
                        <mml:msub>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">Y</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>cos</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi mathvariant="double-struck">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>d</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mi>k</mml:mi>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq91.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Cluster centroid locations in the harmonized embedding, L2-normalized.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq92">
                    <alternatives>
                      <tex-math id="M183">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{r}}}}}}}\in {{\mathbb{R}}}^{k\times (1+b)\times d}$$\end{document}</tex-math>
                      <mml:math id="M184">
                        <mml:msub>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">B</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">r</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi mathvariant="double-struck">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>k</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mrow>
                              <mml:mo>(</mml:mo>
                              <mml:mrow>
                                <mml:mn>1</mml:mn>
                                <mml:mo>+</mml:mo>
                                <mml:mi>b</mml:mi>
                              </mml:mrow>
                              <mml:mo>)</mml:mo>
                            </mml:mrow>
                            <mml:mo>×</mml:mo>
                            <mml:mi>d</mml:mi>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq92.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>3D tensor of the estimated parameters (betas and intercepts) of the linear mixture model for each of <inline-formula id="IEq93"><alternatives><tex-math id="M185">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M186"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq93.gif"/></alternatives></inline-formula> clusters for the reference cells.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq94">
                    <alternatives>
                      <tex-math id="M187">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{N}}}}}}}_{{{{{{\bf{r}}}}}}}\in {{\mathbb{R}}}^{k\times 1}$$\end{document}</tex-math>
                      <mml:math id="M188">
                        <mml:msub>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">N</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">r</mml:mi>
                          </mml:mrow>
                        </mml:msub>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi mathvariant="double-struck">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>k</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mn>1</mml:mn>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq94.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>First reference compression term. Vector containing the size of each of the <inline-formula id="IEq95"><alternatives><tex-math id="M189">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M190"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq95.gif"/></alternatives></inline-formula> clusters, effectively the number of reference cells contained within them.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq96">
                    <alternatives>
                      <tex-math id="M191">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{C}}}}}}\in {{\mathbb{R}}}^{k\times d}$$\end{document}</tex-math>
                      <mml:math id="M192">
                        <mml:mi mathvariant="bold">C</mml:mi>
                        <mml:mo>∈</mml:mo>
                        <mml:msup>
                          <mml:mrow>
                            <mml:mi mathvariant="double-struck">R</mml:mi>
                          </mml:mrow>
                          <mml:mrow>
                            <mml:mi>k</mml:mi>
                            <mml:mo>×</mml:mo>
                            <mml:mi>d</mml:mi>
                          </mml:mrow>
                        </mml:msup>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq96.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Second reference compression term.</td>
              </tr>
              <tr>
                <td>
                  <inline-formula id="IEq97">
                    <alternatives>
                      <tex-math id="M193">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\rm{Ref}}}}}}=\{{{{{{\mathbf{\mu }}}}}},{{{{{\boldsymbol{\sigma }}}}}},{{{{{\bf{U}}}}}},{{{{{{\bf{Y}}}}}}}_{{{\cos }}},{{{{{{\bf{N}}}}}}}_{{{{{{\bf{r}}}}}}},{{{{{\bf{C}}}}}}\}$$\end{document}</tex-math>
                      <mml:math id="M194">
                        <mml:mi mathvariant="normal">Ref</mml:mi>
                        <mml:mo>=</mml:mo>
                        <mml:mrow>
                          <mml:mo>{</mml:mo>
                          <mml:mrow>
                            <mml:mi mathvariant="bold">μ</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mi mathvariant="bold-italic">σ</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:mi mathvariant="bold">U</mml:mi>
                            <mml:mo>,</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi mathvariant="bold">Y</mml:mi>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mi>cos</mml:mi>
                              </mml:mrow>
                            </mml:msub>
                            <mml:mo>,</mml:mo>
                            <mml:msub>
                              <mml:mrow>
                                <mml:mi mathvariant="bold">N</mml:mi>
                              </mml:mrow>
                              <mml:mrow>
                                <mml:mi mathvariant="bold">r</mml:mi>
                              </mml:mrow>
                            </mml:msub>
                            <mml:mo>,</mml:mo>
                            <mml:mi mathvariant="bold">C</mml:mi>
                          </mml:mrow>
                          <mml:mo>}</mml:mo>
                        </mml:mrow>
                      </mml:math>
                      <inline-graphic xlink:href="41467_2021_25957_Article_IEq97.gif"/>
                    </alternatives>
                  </inline-formula>
                </td>
                <td>Set of Symphony minimal reference elements.</td>
              </tr>
            </tbody>
          </table>
        </table-wrap>
      </p>
      <p id="Par49">Query-related symbols:<table-wrap id="Tabb"><table frame="hsides" rules="groups"><tbody><tr><td><inline-formula id="IEq98"><alternatives><tex-math id="M195">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{q}}}}}}}\in {{\mathbb{R}}}^{g\times m}$$\end{document}</tex-math><mml:math id="M196"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq98.gif"/></alternatives></inline-formula></td><td>Input query gene expression matrix, prior to scaling.</td></tr><tr><td><inline-formula id="IEq99"><alternatives><tex-math id="M197">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{qs}}}}}}}\in {{\mathbb{R}}}^{g\times m}$$\end{document}</tex-math><mml:math id="M198"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qs</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq99.gif"/></alternatives></inline-formula></td><td>Query gene expression matrix, scaled by <italic>reference</italic> gene means <inline-formula id="IEq100"><alternatives><tex-math id="M199">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\mu }}}}}}$$\end{document}</tex-math><mml:math id="M200"><mml:mi mathvariant="bold">μ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq100.gif"/></alternatives></inline-formula> and standard deviations <inline-formula id="IEq101"><alternatives><tex-math id="M201">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\sigma }}}}}}$$\end{document}</tex-math><mml:math id="M202"><mml:mi mathvariant="bold">σ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq101.gif"/></alternatives></inline-formula>.</td></tr><tr><td><inline-formula id="IEq102"><alternatives><tex-math id="M203">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{q}}}}}}}\in {\{0,1\}}^{c\times m}$$\end{document}</tex-math><mml:math id="M204"><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq102.gif"/></alternatives></inline-formula></td><td>Design matrix assigning query cells (cols) to query batches (rows).</td></tr><tr><td><inline-formula id="IEq103"><alternatives><tex-math id="M205">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}}={{{{{{\mathbf{\Sigma }}}}}}}_{{{{{{\bf{q}}}}}}}{{{{{{\bf{V}}}}}}}_{{{{{{\bf{q}}}}}}}^{{{{{{\bf{T}}}}}}}\in {{\mathbb{R}}}^{d\times m}$$\end{document}</tex-math><mml:math id="M206"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">Σ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">V</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq103.gif"/></alternatives></inline-formula></td><td>Query cell locations in original (pre-harmonized) reference PC embedding.</td></tr><tr><td><inline-formula id="IEq104"><alternatives><tex-math id="M207">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{q}}}}}}}\in {{\mathbb{R}}}^{d\times m}$$\end{document}</tex-math><mml:math id="M208"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq104.gif"/></alternatives></inline-formula></td><td>Approximate query cell locations in integrated embedding (hPC space). Output of Symphony reference mapping.</td></tr><tr><td><inline-formula id="IEq105"><alternatives><tex-math id="M209">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{q}}}}}}}\in {[0,1]}^{k\times m}$$\end{document}</tex-math><mml:math id="M210"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq105.gif"/></alternatives></inline-formula></td><td>Soft cluster assignment of query cells (cols) to clusters (rows). Each column is a probability distribution that sums to 1.</td></tr><tr><td><inline-formula id="IEq106"><alternatives><tex-math id="M211">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{q}}}}}}}\in {{\mathbb{R}}}^{k\times (1+c)\times d}$$\end{document}</tex-math><mml:math id="M212"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>c</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq106.gif"/></alternatives></inline-formula></td><td>3D tensor of the estimated parameters (betas and intercepts) of the linear mixture model for each of <inline-formula id="IEq107"><alternatives><tex-math id="M213">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M214"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq107.gif"/></alternatives></inline-formula> clusters.</td></tr></tbody></table></table-wrap></p>
    </sec>
    <sec id="Sec17">
      <title>Symphony model and conditions for equivalence to Harmony integration</title>
      <p id="Par50">Symphony and Harmony both use a linear mixture model framework, but the two methods perform different tasks: Harmony integrates a reference, whereas Symphony compresses the reference and enables efficient query mapping. To motivate the Symphony model, it is helpful to first briefly review the mixture model, which serves as the basis. Harmony integrates scRNA-seq datasets across batches (e.g., multiple donors, technologies, studies) and projects the cells into a harmonized embedding where cells cluster by cell type rather than batch-specific effects. Harmony takes as input a low-dimensional embedding of cells (<inline-formula id="IEq108"><alternatives><tex-math id="M215">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{Z}}}}}}$$\end{document}</tex-math><mml:math id="M216"><mml:mi mathvariant="bold">Z</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq108.gif"/></alternatives></inline-formula>) and design matrix with assignments to batches (<inline-formula id="IEq109"><alternatives><tex-math id="M217">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{X}}}}}}$$\end{document}</tex-math><mml:math id="M218"><mml:mi mathvariant="bold">X</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq109.gif"/></alternatives></inline-formula>) and outputs a harmonized embedding (<inline-formula id="IEq110"><alternatives><tex-math id="M219">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat{{{{{{\bf{Z}}}}}}}$$\end{document}</tex-math><mml:math id="M220"><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq110.gif"/></alternatives></inline-formula>) with batch effects removed. Briefly, Harmony works by iterating between two subroutines—maximum diversity clustering and linear mixture model correction—until convergence. In the clustering step, cells are probabilistically assigned to soft clusters with a variant of soft k<italic>-</italic>means with a diversity penalty favoring clusters represented by multiple datasets rather than single datasets. In the correction step, each cluster learns a cluster-specific linear model that explains cell locations in PC space as a function of a cluster-specific intercept and batch membership. Then, cells are corrected by cell-specific linear factors weighted by cluster membership to remove batch-dependent effects. The full algorithm and implementation are detailed in Korsunsky et al.<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>.</p>
      <p id="Par51">In the scenario of mapping <inline-formula id="IEq111"><alternatives><tex-math id="M221">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m$$\end{document}</tex-math><mml:math id="M222"><mml:mi>m</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq111.gif"/></alternatives></inline-formula> query cells against <inline-formula id="IEq112"><alternatives><tex-math id="M223">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M224"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq112.gif"/></alternatives></inline-formula> reference cells, the de novo integration strategy would model all cells as in Eq. (<xref rid="Equ1" ref-type="">1</xref>), where the <inline-formula id="IEq113"><alternatives><tex-math id="M225">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H$$\end{document}</tex-math><mml:math id="M226"><mml:mi>H</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq113.gif"/></alternatives></inline-formula> subscript denotes the Harmony solution, in contrast to the Symphony model, which is presented in Eq. (<xref rid="Equ2" ref-type="">2</xref>). Let <inline-formula id="IEq114"><alternatives><tex-math id="M227">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{H}}}}}}}\in {\{{{{{\mathrm{0,1}}}}}\}}^{\left(c+b\right)\times (m+n)}$$\end{document}</tex-math><mml:math id="M228"><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mi mathvariant="normal">0, 1</mml:mi></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi>c</mml:mi><mml:mo>+</mml:mo><mml:mi>b</mml:mi></mml:mrow></mml:mfenced><mml:mo>×</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>m</mml:mi><mml:mo>+</mml:mo><mml:mi>n</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq114.gif"/></alternatives></inline-formula> represent the one-hot encoded design matrix assigning all cells across batches. <inline-formula id="IEq115"><alternatives><tex-math id="M229">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{H}}}}}}}^{{{\ast }}}$$\end{document}</tex-math><mml:math id="M230"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq115.gif"/></alternatives></inline-formula> denotes <inline-formula id="IEq116"><alternatives><tex-math id="M231">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{H}}}}}}}$$\end{document}</tex-math><mml:math id="M232"><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq116.gif"/></alternatives></inline-formula> augmented with a row of 1 s for the batch-independent intercept term: <inline-formula id="IEq117"><alternatives><tex-math id="M233">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{H}}}}}}}^{{{\ast }}}{{{{{\boldsymbol{=}}}}}}{{{{{\bf{1}}}}}}{{{{{\boldsymbol{||}}}}}}{{{{{{\bf{X}}}}}}}_{{{{{{\bf{H}}}}}}}$$\end{document}</tex-math><mml:math id="M234"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msubsup><mml:mi mathvariant="bold-italic">=</mml:mi><mml:mi mathvariant="bold">1</mml:mi><mml:mi mathvariant="bold-italic">∣∣</mml:mi><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq117.gif"/></alternatives></inline-formula>. The intercept terms represent cluster centroids (location of “experts” in the mixture of experts model). <inline-formula id="IEq118"><alternatives><tex-math id="M235">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{H}}}}}}}$$\end{document}</tex-math><mml:math id="M236"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq118.gif"/></alternatives></inline-formula> represents the low-dimensional PCA embedding of all cells. <inline-formula id="IEq119"><alternatives><tex-math id="M237">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{H}}}}}}}$$\end{document}</tex-math><mml:math id="M238"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq119.gif"/></alternatives></inline-formula> represents the probabilistic assignment of cells across <inline-formula id="IEq120"><alternatives><tex-math id="M239">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M240"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq120.gif"/></alternatives></inline-formula> clusters, and <inline-formula id="IEq121"><alternatives><tex-math id="M241">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\rm{diag}}}}}}\left({{{{{{\bf{R}}}}}}}_{{{{{{\bf{Hk}}}}}}}\right)\in {{\mathbb{R}}}^{N\times N}$$\end{document}</tex-math><mml:math id="M242"><mml:mi mathvariant="normal">diag</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">Hk</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>N</mml:mi><mml:mo>×</mml:mo><mml:mi>N</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq121.gif"/></alternatives></inline-formula> denotes the diagonalized <inline-formula id="IEq122"><alternatives><tex-math id="M243">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M244"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq122.gif"/></alternatives></inline-formula>th row of <inline-formula id="IEq123"><alternatives><tex-math id="M245">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{H}}}}}}}$$\end{document}</tex-math><mml:math id="M246"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq123.gif"/></alternatives></inline-formula>. For each cluster <inline-formula id="IEq124"><alternatives><tex-math id="M247">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M248"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq124.gif"/></alternatives></inline-formula>, the parameters of the linear mixture model <inline-formula id="IEq125"><alternatives><tex-math id="M249">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{k}}}}}}}{\in {\mathbb{R}}}^{(1+c+b)\times d}$$\end{document}</tex-math><mml:math id="M250"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">k</mml:mi></mml:mrow></mml:msub><mml:msup><mml:mrow><mml:mo>∈</mml:mo><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>c</mml:mi><mml:mo>+</mml:mo><mml:mi>b</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq125.gif"/></alternatives></inline-formula> can therefore be solved for as in Eq. (<xref rid="Equ1" ref-type="">1</xref>), using ridge regression with ridge penalty hyperparameter <inline-formula id="IEq126"><alternatives><tex-math id="M251">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda$$\end{document}</tex-math><mml:math id="M252"><mml:mi>λ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq126.gif"/></alternatives></inline-formula>. Note that we do not penalize the batch-independent intercept term: <inline-formula id="IEq127"><alternatives><tex-math id="M253">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\lambda }_{0}=0$$\end{document}</tex-math><mml:math id="M254"><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq127.gif"/></alternatives></inline-formula>, <inline-formula id="IEq128"><alternatives><tex-math id="M255">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\forall }_{a\in [1:(c+b)]}{\lambda }_{a}=1$$\end{document}</tex-math><mml:math id="M256"><mml:msub><mml:mrow><mml:mo>∀</mml:mo></mml:mrow><mml:mrow><mml:mi>a</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>c</mml:mi><mml:mo>+</mml:mo><mml:mi>b</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq128.gif"/></alternatives></inline-formula>.</p>
      <p id="Par52">De novo Harmony model:<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M257">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{k}}}}}}}={\left({{{{{{\bf{X}}}}}}}_{{{{{{\bf{H}}}}}}}^{\ast }{{{{{\rm{diag}}}}}}\left({{{{{{\bf{R}}}}}}}_{{{{{{\bf{Hk}}}}}}}\right){{{{{{\bf{X}}}}}}}_{{{{{{\bf{H}}}}}}}^{\ast {{{{{\bf{T}}}}}}}+{{{{{\rm{\lambda }}}}}}{{{{{\bf{I}}}}}}\right)}^{-1}{{{{{{\bf{X}}}}}}}_{{{{{{\bf{H}}}}}}}^{\ast }{{{{{\rm{diag}}}}}}\left({{{{{{\bf{R}}}}}}}_{{{{{{\bf{Hk}}}}}}}\right){{{{{{\bf{Z}}}}}}}_{{{{{{\bf{H}}}}}}}^{{{{{{\bf{T}}}}}}}$$\end{document}</tex-math><mml:math id="M258"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">k</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msubsup><mml:mi mathvariant="normal">diag</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">Hk</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup><mml:mo>+</mml:mo><mml:mi mathvariant="normal">λ</mml:mi><mml:mi mathvariant="bold">I</mml:mi></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msubsup><mml:mi mathvariant="normal">diag</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">Hk</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">H</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup></mml:math><graphic xlink:href="41467_2021_25957_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par53">The goal of Symphony mapping is to add new query cells to the model in order to estimate and remove the query batch effects. Symphony mapping approximates de novo Harmony integration on all cells, except the reference cell positions in the harmonized embedding do not change. In order for Symphony mapping to be equivalent to de novo Harmony, several conditions must be met:<list list-type="simple"><list-item><label>I.</label><p id="Par54">All cell states represented in the query dataset are captured by the reference datasets—i.e., there are no completely novel cell types in the query.</p></list-item><list-item><label>II.</label><p id="Par55">The number of reference cells is much larger than the query (<inline-formula id="IEq129"><alternatives><tex-math id="M259">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m\ll n$$\end{document}</tex-math><mml:math id="M260"><mml:mi>m</mml:mi><mml:mo>≪</mml:mo><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq129.gif"/></alternatives></inline-formula>).</p></list-item><list-item><label>III.</label><p id="Par56">The query dataset is obtained independent of the reference datasets—i.e., the reference batch design matrix (<inline-formula id="IEq130"><alternatives><tex-math id="M261">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M262"><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq130.gif"/></alternatives></inline-formula>) has no interaction with the query batch design matrix (<inline-formula id="IEq131"><alternatives><tex-math id="M263">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M264"><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq131.gif"/></alternatives></inline-formula>).</p></list-item></list></p>
      <p id="Par57">We consider these to be fair assumptions for large-scale reference atlases, allowing Symphony to make three key approximations:<list list-type="order"><list-item><p id="Par58">With a large reference, the reference-only PCs approximate the PCs for the combined reference and query datasets. This allows us to project the query cells into the pre-harmonized reference PCA space using the reference gene loadings (<inline-formula id="IEq132"><alternatives><tex-math id="M265">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{U}}}}}}$$\end{document}</tex-math><mml:math id="M266"><mml:mi mathvariant="bold">U</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq132.gif"/></alternatives></inline-formula>).</p></list-item><list-item><p id="Par59">The cluster centroids (<inline-formula id="IEq133"><alternatives><tex-math id="M267">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{Y}}}}}}$$\end{document}</tex-math><mml:math id="M268"><mml:mi mathvariant="bold">Y</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq133.gif"/></alternatives></inline-formula>) for the integrated reference cells approximate the cluster centroids from harmonizing all cells.</p></list-item><list-item><p id="Par60">The reference cell cluster assignments (<inline-formula id="IEq134"><alternatives><tex-math id="M269">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M270"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq134.gif"/></alternatives></inline-formula>) remains approximately stable with the addition of query cells.</p></list-item></list></p>
      <p id="Par61">Given these approximations, we can thereby harmonize the reference cells a priori and save the reference-dependent portions of the Harmony mixture model (Supplementary Methods). In Symphony, we model the reference cells as already harmonized with batch effects removed, so we can thereafter ignore the reference design matrix structure. The Symphony design matrix <inline-formula id="IEq135"><alternatives><tex-math id="M271">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{X}}}}}}\in {[0,1]}^{c\times N}$$\end{document}</tex-math><mml:math id="M272"><mml:mi mathvariant="bold">X</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mo>×</mml:mo><mml:mi>N</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq135.gif"/></alternatives></inline-formula> assigns all cells (reference and query) to <italic>query</italic> batches only. <inline-formula id="IEq136"><alternatives><tex-math id="M273">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}^{{{\ast }}}$$\end{document}</tex-math><mml:math id="M274"><mml:msup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq136.gif"/></alternatives></inline-formula> denotes <inline-formula id="IEq137"><alternatives><tex-math id="M275">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{X}}}}}}$$\end{document}</tex-math><mml:math id="M276"><mml:mi mathvariant="bold">X</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq137.gif"/></alternatives></inline-formula> augmented with a row of 1 s (<inline-formula id="IEq138"><alternatives><tex-math id="M277">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\boldsymbol{[}}}}}}{{{{{\bf{0}}}}}}{{{{{\boldsymbol{,}}}}}}{{{{{\boldsymbol{\cdot }}}}}}{{{{{\boldsymbol{]}}}}}}}^{{{\ast }}}$$\end{document}</tex-math><mml:math id="M278"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold">0</mml:mi><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold-italic">⋅</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq138.gif"/></alternatives></inline-formula>) corresponding to the batch-independent intercepts (we model the intercepts for all cells). The remaining <italic>c</italic> rows <inline-formula id="IEq139"><alternatives><tex-math id="M279">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$({{{{{{\bf{X}}}}}}}_{{{{{{\boldsymbol{[}}}}}}{{{{{\bf{1}}}}}}{{{{{\bf{:c}}}}}}{{{{{\boldsymbol{,}}}}}}{{{{{\boldsymbol{\cdot }}}}}}{{{{{\boldsymbol{]}}}}}}}^{{{\ast }}})$$\end{document}</tex-math><mml:math id="M280"><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold">1</mml:mi><mml:mi mathvariant="bold">:c</mml:mi><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold-italic">⋅</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq139.gif"/></alternatives></inline-formula> represent the one-hot batch assignment of the cells among the <inline-formula id="IEq140"><alternatives><tex-math id="M281">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$c$$\end{document}</tex-math><mml:math id="M282"><mml:mi>c</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq140.gif"/></alternatives></inline-formula> query batches. Note that for the reference cell columns, these values are all 0 since the reference cells do not belong to any <italic>query</italic> batches. The parameters (<inline-formula id="IEq141"><alternatives><tex-math id="M283">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{qk}}}}}}}\in {{\mathbb{R}}}^{(1+c)\times d}$$\end{document}</tex-math><mml:math id="M284"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qk</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>c</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq141.gif"/></alternatives></inline-formula>) of the model for each cluster <inline-formula id="IEq142"><alternatives><tex-math id="M285">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M286"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq142.gif"/></alternatives></inline-formula> can then be solved for as in Eq. (<xref rid="Equ2" ref-type="">2</xref>). Similar to Harmony, we use ridge regression penalizing the non-intercept terms, where <inline-formula id="IEq143"><alternatives><tex-math id="M287">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\lambda }_{0}=0$$\end{document}</tex-math><mml:math id="M288"><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq143.gif"/></alternatives></inline-formula>, <inline-formula id="IEq144"><alternatives><tex-math id="M289">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\forall }_{a\in [1{:c}]}{\lambda }_{a}=1$$\end{document}</tex-math><mml:math id="M290"><mml:msub><mml:mrow><mml:mo>∀</mml:mo></mml:mrow><mml:mrow><mml:mi>a</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>c</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq144.gif"/></alternatives></inline-formula>.</p>
      <p id="Par62">Symphony model:<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M291">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{qk}}}}}}}\approx {\left({{{{{{\bf{X}}}}}}}^{\ast }{{{{{\rm{diag}}}}}}\left({{{{{{\bf{R}}}}}}}_{{{{{{\bf{k}}}}}}}\right){{{{{{\bf{X}}}}}}}^{\ast {{{{{\bf{T}}}}}}}+{{{{{\rm{\lambda }}}}}}{{{{{\bf{I}}}}}}\right)}^{-1}{{{{{{\bf{X}}}}}}}^{\ast }{{{{{\rm{diag}}}}}}\left({{{{{{\bf{R}}}}}}}_{{{{{{\bf{k}}}}}}}\right){{{{{{\bf{Z}}}}}}}^{{{{{{\bf{T}}}}}}}$$\end{document}</tex-math><mml:math id="M292"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qk</mml:mi></mml:mrow></mml:msub><mml:mo>≈</mml:mo><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msup><mml:mi mathvariant="normal">diag</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:msup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msup><mml:mo>+</mml:mo><mml:mi mathvariant="normal">λ</mml:mi><mml:mi mathvariant="bold">I</mml:mi></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msup><mml:mi mathvariant="normal">diag</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">k</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:msup><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msup></mml:math><graphic xlink:href="41467_2021_25957_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par63">The matrix <inline-formula id="IEq145"><alternatives><tex-math id="M293">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{R}}}}}}\in {{\mathbb{R}}}^{k\times N}$$\end{document}</tex-math><mml:math id="M294"><mml:mi mathvariant="bold">R</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>N</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq145.gif"/></alternatives></inline-formula> denotes the assignment of query and reference cells (columns) across the reference clusters (rows). <inline-formula id="IEq146"><alternatives><tex-math id="M295">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{Z}}}}}}$$\end{document}</tex-math><mml:math id="M296"><mml:mi mathvariant="bold">Z</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq146.gif"/></alternatives></inline-formula>
<inline-formula id="IEq147"><alternatives><tex-math id="M297">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\in {{\mathbb{R}}}^{d\times N}$$\end{document}</tex-math><mml:math id="M298"><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mo>×</mml:mo><mml:mi>N</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq147.gif"/></alternatives></inline-formula> denotes the horizontal matrix concatenation of the uncorrected query cells in original PC space (<inline-formula id="IEq148"><alternatives><tex-math id="M299">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M300"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq148.gif"/></alternatives></inline-formula>) and corrected reference cells in harmonized space (<inline-formula id="IEq149"><alternatives><tex-math id="M301">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M302"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq149.gif"/></alternatives></inline-formula>). For each cluster <inline-formula id="IEq150"><alternatives><tex-math id="M303">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M304"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq150.gif"/></alternatives></inline-formula>, let matrix <inline-formula id="IEq151"><alternatives><tex-math id="M305">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{qk}}}}}}}\in {{\mathbb{R}}}^{(1+c)\times d}$$\end{document}</tex-math><mml:math id="M306"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qk</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>c</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq151.gif"/></alternatives></inline-formula> represent the query parameters to be estimated. The first row of <inline-formula id="IEq152"><alternatives><tex-math id="M307">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{qk}}}}}}}$$\end{document}</tex-math><mml:math id="M308"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qk</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq152.gif"/></alternatives></inline-formula> represents the batch-independent intercept terms, and the remaining <inline-formula id="IEq153"><alternatives><tex-math id="M309">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$c$$\end{document}</tex-math><mml:math id="M310"><mml:mi>c</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq153.gif"/></alternatives></inline-formula> rows of <inline-formula id="IEq154"><alternatives><tex-math id="M311">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{qk}}}}}}}$$\end{document}</tex-math><mml:math id="M312"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qk</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq154.gif"/></alternatives></inline-formula> represent the query batch-dependent coefficients, which can be regressed out to harmonize the query cells with the reference. Note that the intercept terms from Symphony mapping should equal the cluster centroid locations from the integrated reference since the harmonized reference cells are modeled only by a weighted average of the centroid locations for the clusters over which it belongs (and a cell-specific residual). Hence, the reference cell positions should not change when removing query batch effects.</p>
      <p id="Par64">The matrices <inline-formula id="IEq155"><alternatives><tex-math id="M313">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}^{{{\ast }}}$$\end{document}</tex-math><mml:math id="M314"><mml:msup><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mo>*</mml:mo></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq155.gif"/></alternatives></inline-formula>, <inline-formula id="IEq156"><alternatives><tex-math id="M315">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{k}}}}}}}$$\end{document}</tex-math><mml:math id="M316"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq156.gif"/></alternatives></inline-formula>, and <inline-formula id="IEq157"><alternatives><tex-math id="M317">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{Z}}}}}}$$\end{document}</tex-math><mml:math id="M318"><mml:mi mathvariant="bold">Z</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq157.gif"/></alternatives></inline-formula> in Eq. (<xref rid="Equ2" ref-type="">2</xref>) can be partitioned into query and reference-dependent portions. In the Supplementary Methods, we show in detail how the reference-dependent portions can be further simplified into a <inline-formula id="IEq158"><alternatives><tex-math id="M319">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k\times 1$$\end{document}</tex-math><mml:math id="M320"><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mn>1</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq158.gif"/></alternatives></inline-formula> vector and <inline-formula id="IEq159"><alternatives><tex-math id="M321">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k\times d$$\end{document}</tex-math><mml:math id="M322"><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq159.gif"/></alternatives></inline-formula> matrix (<inline-formula id="IEq160"><alternatives><tex-math id="M323">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{N}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M324"><mml:msub><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq160.gif"/></alternatives></inline-formula> and <inline-formula id="IEq161"><alternatives><tex-math id="M325">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{C}}}}}}$$\end{document}</tex-math><mml:math id="M326"><mml:mi mathvariant="bold">C</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq161.gif"/></alternatives></inline-formula>), which we call the reference compression terms. Intuitively, the vector <inline-formula id="IEq162"><alternatives><tex-math id="M327">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{N}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M328"><mml:msub><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq162.gif"/></alternatives></inline-formula> contains the size (in cells) of each reference cluster. The matrix <inline-formula id="IEq163"><alternatives><tex-math id="M329">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{C}}}}}}={{{{{{\bf{R}}}}}}}_{{{{{{\boldsymbol{r}}}}}}}{\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{r}}}}}}}^{{{{{{\bf{T}}}}}}}$$\end{document}</tex-math><mml:math id="M330"><mml:mi mathvariant="bold">C</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">r</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq163.gif"/></alternatives></inline-formula> does not have as intuitive an explanation but follows from the derivation (Supplementary Methods). These terms can be computed at the time of reference building and saved as part of the minimal reference elements to reduce the necessary computations during mapping.</p>
    </sec>
    <sec id="Sec18">
      <title>Reference building and compression</title>
      <p id="Par65">Reference compression is the key idea that allows for the efficient mapping of new query cells into the harmonized reference embedding without the need to reintegrate all cells. To construct a Symphony reference with minimal elements needed for mapping, reference cells are first harmonized in a low-dimensional space (e.g., PCs) to remove batch-dependent effects. Symphony then compresses the Harmony mixture model components to be saved for subsequent query mapping.</p>
      <p id="Par66">Symphony takes as input a gene expression matrix for reference cells (<inline-formula id="IEq164"><alternatives><tex-math id="M331">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M332"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq164.gif"/></alternatives></inline-formula>) and corresponding one-hot-encoded design matrix (<inline-formula id="IEq165"><alternatives><tex-math id="M333">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M334"><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq165.gif"/></alternatives></inline-formula>) containing metadata about assignment of cells to batches. It outputs a set of data structures, referred to as the Symphony “minimal reference elements”, that captures key information about the reference embedding that can be subsequently used to efficiently map previously unseen query cells (Algorithm 1). These components include the gene means (<inline-formula id="IEq166"><alternatives><tex-math id="M335">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\mu }}}}}}$$\end{document}</tex-math><mml:math id="M336"><mml:mi mathvariant="bold">μ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq166.gif"/></alternatives></inline-formula>) and standard deviations (<inline-formula id="IEq167"><alternatives><tex-math id="M337">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\sigma }}}}}}$$\end{document}</tex-math><mml:math id="M338"><mml:mi mathvariant="bold">σ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq167.gif"/></alternatives></inline-formula>) used to scale the genes, the PCA gene loadings (<inline-formula id="IEq168"><alternatives><tex-math id="M339">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{U}}}}}}$$\end{document}</tex-math><mml:math id="M340"><mml:mi mathvariant="bold">U</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq168.gif"/></alternatives></inline-formula>), the final L2-normalized cluster centroid locations (<inline-formula id="IEq169"><alternatives><tex-math id="M341">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Y}}}}}}}_{{{\cos }}}$$\end{document}</tex-math><mml:math id="M342"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi>cos</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq169.gif"/></alternatives></inline-formula>), and precomputed values which we call the “reference compression terms” (<inline-formula id="IEq170"><alternatives><tex-math id="M343">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{N}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M344"><mml:msub><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq170.gif"/></alternatives></inline-formula> and <inline-formula id="IEq171"><alternatives><tex-math id="M345">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{C}}}}}}$$\end{document}</tex-math><mml:math id="M346"><mml:mi mathvariant="bold">C</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq171.gif"/></alternatives></inline-formula>) that expedite the correction step of query mapping (Supplementary Methods). These elements are a subset of the components available once Harmony integration is applied to the reference cells. Note that other input embeddings, such as canonical correlation analysis (CCA), may be used in place of PCA as long as the gene loadings to perform query projection into those coordinates are saved.</p>
      <p id="Par67">Table <xref rid="Tab2" ref-type="table">2</xref> lists the Symphony minimal reference elements required to perform mapping. Table <xref rid="Tab2" ref-type="table">2</xref> also shows which additional components of a full Harmony reference are not included in the Symphony minimal reference elements. Importantly, the dimensions of the Symphony data structures do not require information on the <inline-formula id="IEq172"><alternatives><tex-math id="M347">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M348"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq172.gif"/></alternatives></inline-formula> individual reference cells and hence do not scale with the raw number of reference cells. Rather the components scale with the biological complexity captured (i.e., number of clusters <inline-formula id="IEq173"><alternatives><tex-math id="M349">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M350"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq173.gif"/></alternatives></inline-formula> and dimensionality of embedding <inline-formula id="IEq174"><alternatives><tex-math id="M351">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d$$\end{document}</tex-math><mml:math id="M352"><mml:mi>d</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq174.gif"/></alternatives></inline-formula>). Conversely, the Harmony data structures store information on a per-cell basis (<inline-formula id="IEq175"><alternatives><tex-math id="M353">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M354"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq175.gif"/></alternatives></inline-formula>). Note that in practice the integrated embedding of reference cells (<inline-formula id="IEq176"><alternatives><tex-math id="M355">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M356"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq176.gif"/></alternatives></inline-formula>) is saved to the reference because it is needed to perform downstream transfer of annotations from reference to query cells (e.g., k-NN), but it is not required during any computations of the mapping step.<table-wrap id="Tab2"><label>Table 2</label><caption><p>Symphony minimal reference elements vs. additional components of Harmony reference.</p></caption><table frame="hsides" rules="groups"><tbody><tr><td colspan="2"><bold>Symphony minimal reference elements</bold></td></tr><tr><td><inline-formula id="IEq177"><alternatives><tex-math id="M357">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\mu }}}}}}\in {{\mathbb{R}}}^{g\times 1}$$\end{document}</tex-math><mml:math id="M358"><mml:mi mathvariant="bold">μ</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mo>×</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq177.gif"/></alternatives></inline-formula></td><td>Reference gene means used to center each gene for PCA.</td></tr><tr><td><inline-formula id="IEq178"><alternatives><tex-math id="M359">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\sigma }}}}}}\in {{\mathbb{R}}}^{g\times 1}$$\end{document}</tex-math><mml:math id="M360"><mml:mi mathvariant="bold">σ</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mo>×</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq178.gif"/></alternatives></inline-formula></td><td>Reference gene standard deviations used to scale each gene for PCA.</td></tr><tr><td><inline-formula id="IEq179"><alternatives><tex-math id="M361">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{U}}}}}}\in {{\mathbb{R}}}^{g\times d}$$\end{document}</tex-math><mml:math id="M362"><mml:mi mathvariant="bold">U</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq179.gif"/></alternatives></inline-formula></td><td>Gene loadings to project from expression to PCA (or CCA) space.</td></tr><tr><td><inline-formula id="IEq180"><alternatives><tex-math id="M363">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Y}}}}}}}_{{{\cos }}}\in {{\mathbb{R}}}^{d\times k}$$\end{document}</tex-math><mml:math id="M364"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi>cos</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mo>×</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq180.gif"/></alternatives></inline-formula></td><td>Cluster centroid locations in harmonized PC space, L2-normalized.</td></tr><tr><td><inline-formula id="IEq181"><alternatives><tex-math id="M365">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{N}}}}}}}_{{{{{{\bf{r}}}}}}}\in {{\mathbb{R}}}^{k\times 1}$$\end{document}</tex-math><mml:math id="M366"><mml:msub><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq181.gif"/></alternatives></inline-formula></td><td>First reference compression term. Vector containing the size of each of the <inline-formula id="IEq182"><alternatives><tex-math id="M367">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M368"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq182.gif"/></alternatives></inline-formula> clusters, effectively the number of reference cells contained within them.</td></tr><tr><td><inline-formula id="IEq183"><alternatives><tex-math id="M369">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{C}}}}}}\in {{\mathbb{R}}}^{k\times d}$$\end{document}</tex-math><mml:math id="M370"><mml:mi mathvariant="bold">C</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq183.gif"/></alternatives></inline-formula></td><td>Second reference compression term.</td></tr><tr><td colspan="2"><bold>Additional components of a full Harmony reference</bold></td></tr><tr><td><inline-formula id="IEq184"><alternatives><tex-math id="M371">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{r}}}}}}}\in {{\mathbb{R}}}^{g\times n}$$\end{document}</tex-math><mml:math id="M372"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq184.gif"/></alternatives></inline-formula></td><td>Input reference gene expression matrix, prior to scaling.</td></tr><tr><td><inline-formula id="IEq185"><alternatives><tex-math id="M373">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{r}}}}}}}\in {\{0,1\}}^{b\times n}$$\end{document}</tex-math><mml:math id="M374"><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>b</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq185.gif"/></alternatives></inline-formula></td><td>Design matrix assigning reference cells (cols) to reference batches (rows).</td></tr><tr><td><inline-formula id="IEq186"><alternatives><tex-math id="M375">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{r}}}}}}}\in {{\mathbb{R}}}^{k\times (1+b)\times d}$$\end{document}</tex-math><mml:math id="M376"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>b</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq186.gif"/></alternatives></inline-formula></td><td>3D tensor of the estimated parameters (betas and intercepts) of the linear mixture model for each of <inline-formula id="IEq187"><alternatives><tex-math id="M377">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M378"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq187.gif"/></alternatives></inline-formula> clusters for the reference cells.</td></tr><tr><td><inline-formula id="IEq188"><alternatives><tex-math id="M379">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{r}}}}}}}\in {{\mathbb{R}}}^{d\times n}$$\end{document}</tex-math><mml:math id="M380"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq188.gif"/></alternatives></inline-formula></td><td>Integrated embedding for reference cells in harmonized PC (hPC) space, as output by Harmony.</td></tr><tr><td><inline-formula id="IEq189"><alternatives><tex-math id="M381">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{r}}}}}}}\in {[0,1]}^{k\times n}$$\end{document}</tex-math><mml:math id="M382"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq189.gif"/></alternatives></inline-formula></td><td>Soft cluster assignment of reference cells (cols) to clusters (rows), as output by Harmony. Each column is a probability distribution that sums to 1.</td></tr></tbody></table></table-wrap></p>
      <p id="Par68">Starting from reference cell gene expression, we first perform within-cell library size normalization (if not already done) and variable gene selection to obtain <inline-formula id="IEq190"><alternatives><tex-math id="M383">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M384"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq190.gif"/></alternatives></inline-formula>, scaling of the genes to have mean 0 and variance 1 (saving <inline-formula id="IEq191"><alternatives><tex-math id="M385">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mu$$\end{document}</tex-math><mml:math id="M386"><mml:mi>μ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq191.gif"/></alternatives></inline-formula> and <inline-formula id="IEq192"><alternatives><tex-math id="M387">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma$$\end{document}</tex-math><mml:math id="M388"><mml:mi>σ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq192.gif"/></alternatives></inline-formula> for each gene), and PCA to embed the reference cells in a low-dimensional space, saving the gene loadings (<inline-formula id="IEq193"><alternatives><tex-math id="M389">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{U}}}}}}$$\end{document}</tex-math><mml:math id="M390"><mml:mi mathvariant="bold">U</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq193.gif"/></alternatives></inline-formula>) (Implementation Details). Then, the PCA embedding (<inline-formula id="IEq194"><alternatives><tex-math id="M391">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M392"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq194.gif"/></alternatives></inline-formula>) and batch design matrix (<inline-formula id="IEq195"><alternatives><tex-math id="M393">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M394"><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq195.gif"/></alternatives></inline-formula>) are used as input to Harmony integration to harmonize over batch-dependent sources of variation. Given the resulting harmonized embedding (<inline-formula id="IEq196"><alternatives><tex-math id="M395">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M396"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq196.gif"/></alternatives></inline-formula>) and final soft assignment of reference cells to clusters (<inline-formula id="IEq197"><alternatives><tex-math id="M397">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M398"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq197.gif"/></alternatives></inline-formula>), the locations of the final reference cluster centroids <inline-formula id="IEq198"><alternatives><tex-math id="M399">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{Y}}}}}}\in {{\mathbb{R}}}^{d\times k}$$\end{document}</tex-math><mml:math id="M400"><mml:mi mathvariant="bold">Y</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mo>×</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq198.gif"/></alternatives></inline-formula> can be calculated as in Eq. (<xref rid="Equ3" ref-type="">3</xref>) and saved.<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M401">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{Y}}}}}}={\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{r}}}}}}}{{{{{{\bf{R}}}}}}}_{{{{{{\bf{r}}}}}}}^{{{{{{\bf{T}}}}}}}$$\end{document}</tex-math><mml:math id="M402"><mml:mi mathvariant="bold">Y</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup></mml:math><graphic xlink:href="41467_2021_25957_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par69">Symphony then computes the reference compression terms <inline-formula id="IEq199"><alternatives><tex-math id="M403">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{N}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M404"><mml:msub><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq199.gif"/></alternatives></inline-formula> (intuitively, the number of cells per cluster) and <inline-formula id="IEq200"><alternatives><tex-math id="M405">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{C}}}}}}$$\end{document}</tex-math><mml:math id="M406"><mml:mi mathvariant="bold">C</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq200.gif"/></alternatives></inline-formula>, which does not have an intuitive explanation but can be directly computed as <inline-formula id="IEq201"><alternatives><tex-math id="M407">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{C}}}}}}={{{{{{\bf{R}}}}}}}_{{{{{{\boldsymbol{r}}}}}}}{\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{r}}}}}}}^{{{{{{\bf{T}}}}}}}$$\end{document}</tex-math><mml:math id="M408"><mml:mi mathvariant="bold">C</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">r</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq201.gif"/></alternatives></inline-formula>. Refer to the Supplementary Methods for a complete mathematical derivation of the compression terms. Symphony reference building ultimately returns the minimal reference elements: <inline-formula id="IEq202"><alternatives><tex-math id="M409">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\mu }}}}}},{{{{{\mathbf{\sigma }}}}}},{{{{{\bf{U}}}}}},{{{{{{\bf{Y}}}}}}}_{{{\cos }}},{{{{{{\bf{N}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M410"><mml:mi mathvariant="bold">μ</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">σ</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">U</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi>cos</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq202.gif"/></alternatives></inline-formula>, and <inline-formula id="IEq203"><alternatives><tex-math id="M411">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{C}}}}}}$$\end{document}</tex-math><mml:math id="M412"><mml:mi mathvariant="bold">C</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq203.gif"/></alternatives></inline-formula> (Supplementary Fig. <xref rid="MOESM1" ref-type="media">1a</xref>).</p>
      <sec id="FPar1">
        <title>Algorithm 1</title>
        <p id="Par70">Build Symphony reference.</p>
        <p>
          <graphic position="anchor" xlink:href="41467_2021_25957_Figa_HTML" id="d32e5543"/>
        </p>
      </sec>
    </sec>
    <sec id="Sec19">
      <title>Query mapping</title>
      <p id="Par72">The Symphony mapping algorithm localizes new query cells to their appropriate locations in the harmonized embedding without the need to run integration on the reference and query cells altogether. The joint embedding of reference and query cells can be used for downstream analyses, such as transferring cell type annotations from the reference cells to the query cells.</p>
      <p id="Par73">Symphony mapping takes as input the gene expression matrix for query cells (<inline-formula id="IEq204"><alternatives><tex-math id="M413">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M414"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq204.gif"/></alternatives></inline-formula>), query design matrix assigning query cells to batches (<inline-formula id="IEq205"><alternatives><tex-math id="M415">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M416"><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq205.gif"/></alternatives></inline-formula>), and the precomputed minimal elements for a reference (<inline-formula id="IEq206"><alternatives><tex-math id="M417">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\rm{Ref}}}}}}$$\end{document}</tex-math><mml:math id="M418"><mml:mi mathvariant="normal">Ref</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq206.gif"/></alternatives></inline-formula>). It outputs a query object containing the locations of query cells in the integrated reference embedding (<inline-formula id="IEq207"><alternatives><tex-math id="M419">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M420"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq207.gif"/></alternatives></inline-formula>; Algorithm 2). Table <xref rid="Tab3" ref-type="table">3</xref> lists the components of the query object that is returned by Symphony.<table-wrap id="Tab3"><label>Table 3</label><caption><p>Components of Symphony query.</p></caption><table frame="hsides" rules="groups"><tbody><tr><td><inline-formula id="IEq208"><alternatives><tex-math id="M421">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{q}}}}}}}\in {{\mathbb{R}}}^{g\times m}$$\end{document}</tex-math><mml:math id="M422"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq208.gif"/></alternatives></inline-formula></td><td>Input query gene expression matrix, prior to scaling.</td></tr><tr><td><inline-formula id="IEq209"><alternatives><tex-math id="M423">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{q}}}}}}}\in {\{0,1\}}^{c\times m}$$\end{document}</tex-math><mml:math id="M424"><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>c</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq209.gif"/></alternatives></inline-formula></td><td>Design matrix assigning query cells (cols) to query batches (rows).</td></tr><tr><td><inline-formula id="IEq210"><alternatives><tex-math id="M425">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}}\in {{\mathbb{R}}}^{d\times m}$$\end{document}</tex-math><mml:math id="M426"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq210.gif"/></alternatives></inline-formula></td><td>Query cell locations in original (pre-harmonized) PC embedding.</td></tr><tr><td><inline-formula id="IEq211"><alternatives><tex-math id="M427">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{q}}}}}}}\in {{\mathbb{R}}}^{d\times m}$$\end{document}</tex-math><mml:math id="M428"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq211.gif"/></alternatives></inline-formula></td><td>Approximate query cell locations in integrated embedding (hPC space).</td></tr><tr><td><inline-formula id="IEq212"><alternatives><tex-math id="M429">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{q}}}}}}}\in {[0,1]}^{k\times m}$$\end{document}</tex-math><mml:math id="M430"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq212.gif"/></alternatives></inline-formula></td><td>Soft cluster assignment of query cells (cols) to clusters (rows). Each column is a probability distribution that sums to 1.</td></tr><tr><td><inline-formula id="IEq213"><alternatives><tex-math id="M431">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{q}}}}}}}\in {{\mathbb{R}}}^{k\times (1+c)\times d}$$\end{document}</tex-math><mml:math id="M432"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>×</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>c</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq213.gif"/></alternatives></inline-formula></td><td>3D tensor of the estimated parameters (betas and intercepts) of the linear mixture model for each of <italic>k</italic> clusters.</td></tr></tbody></table></table-wrap></p>
      <p id="Par74">The input to the query mapping procedure is a gene expression matrix (<inline-formula id="IEq214"><alternatives><tex-math id="M433">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M434"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq214.gif"/></alternatives></inline-formula>) and design matrix (<inline-formula id="IEq215"><alternatives><tex-math id="M435">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{X}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M436"><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq215.gif"/></alternatives></inline-formula>) for query cells, and the output is the locations of the cells in the harmonized embedding (<inline-formula id="IEq216"><alternatives><tex-math id="M437">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M438"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq216.gif"/></alternatives></inline-formula>). At a high level, the mapping algorithm first projects the query cells into the original, pre-harmonized PC space as the reference cells using the reference gene loadings (<inline-formula id="IEq217"><alternatives><tex-math id="M439">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{U}}}}}}$$\end{document}</tex-math><mml:math id="M440"><mml:mi mathvariant="bold">U</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq217.gif"/></alternatives></inline-formula>) and assigns probabilistic cluster membership across the reference cluster centroid locations. Then, the query cells are modeled using the Symphony mixture model and corrected to their approximate locations in the integrated embedding by regressing out the query batch-dependent effects (Algorithm 2).</p>
      <sec id="Sec20">
        <title>Projection of query cells into pre-harmonized PC space</title>
        <p id="Par75">Symphony projects the query cells into the same original PCs (<inline-formula id="IEq218"><alternatives><tex-math id="M441">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M442"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq218.gif"/></alternatives></inline-formula>) as the reference. Symphony assumes that, given a much smaller query compared to the reference (<inline-formula id="IEq219"><alternatives><tex-math id="M443">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$m\ll n$$\end{document}</tex-math><mml:math id="M444"><mml:mi>m</mml:mi><mml:mo>≪</mml:mo><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq219.gif"/></alternatives></inline-formula>), the PCs will remain approximately stable with the addition of query cells. To project the query cells, we first subset the query expression data by the same variable genes used in reference building and scale the normalized expression of the genes by the same means (<inline-formula id="IEq220"><alternatives><tex-math id="M445">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\mu }}}}}}$$\end{document}</tex-math><mml:math id="M446"><mml:mi mathvariant="bold">μ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq220.gif"/></alternatives></inline-formula>) and standard deviations (<inline-formula id="IEq221"><alternatives><tex-math id="M447">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\boldsymbol{\sigma }}}}}}$$\end{document}</tex-math><mml:math id="M448"><mml:mi mathvariant="bold-italic">σ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq221.gif"/></alternatives></inline-formula>) used to scale the reference cells. Let <inline-formula id="IEq222"><alternatives><tex-math id="M449">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{qs}}}}}}}$$\end{document}</tex-math><mml:math id="M450"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qs</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq222.gif"/></alternatives></inline-formula> denote the query gene expression matrix scaled by the reference gene means and standard deviations. We can then use the reference gene loadings (<inline-formula id="IEq223"><alternatives><tex-math id="M451">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{U}}}}}}$$\end{document}</tex-math><mml:math id="M452"><mml:mi mathvariant="bold">U</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq223.gif"/></alternatives></inline-formula>) to project <inline-formula id="IEq224"><alternatives><tex-math id="M453">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{qs}}}}}}}$$\end{document}</tex-math><mml:math id="M454"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qs</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq224.gif"/></alternatives></inline-formula> into reference PC space. In Eq. (<xref rid="Equ4" ref-type="">4</xref>), <inline-formula id="IEq225"><alternatives><tex-math id="M455">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}}\in {{\mathbb{R}}}^{d\times m}$$\end{document}</tex-math><mml:math id="M456"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq225.gif"/></alternatives></inline-formula> denotes the PC embedding for the query cells. Note that if an alternate starting embedding (e.g., CCA) is used instead of PCA, the gene loadings must be saved to enable this query projection step.<disp-formula id="Equ4"><label>4</label><alternatives><tex-math id="M457">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}}={{{{{{\bf{U}}}}}}}^{{{{{{\bf{T}}}}}}}{{{{{{\bf{G}}}}}}}_{{{{{{\bf{qs}}}}}}}={{{{{{\mathbf{\Sigma }}}}}}}_{{{{{{\bf{q}}}}}}}{{{{{{\bf{V}}}}}}}_{{{{{{\bf{q}}}}}}}^{{{{{{\bf{T}}}}}}}$$\end{document}</tex-math><mml:math id="M458"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qs</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">Σ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">V</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup></mml:math><graphic xlink:href="41467_2021_25957_Article_Equ4.gif" position="anchor"/></alternatives></disp-formula></p>
      </sec>
      <sec id="Sec21">
        <title>Soft assignment across reference clusters</title>
        <p id="Par76">Once the query cells are projected into PC space, we soft assign the cells to the reference clusters using the saved reference centroid locations (<inline-formula id="IEq226"><alternatives><tex-math id="M459">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Y}}}}}}}_{{{\cos }}}$$\end{document}</tex-math><mml:math id="M460"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi>cos</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq226.gif"/></alternatives></inline-formula>). Symphony assumes that the reference cluster centroid locations remain approximately stable with the addition of a much smaller query dataset since the query contains no novel cell types. Under these conditions, we use a previously published objective function for soft k-means clustering in Eq. (<xref rid="Equ5" ref-type="">5</xref>), which includes a distance term and an entropy regularization term over <inline-formula id="IEq227"><alternatives><tex-math id="M461">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{R}}}}}}$$\end{document}</tex-math><mml:math id="M462"><mml:mi mathvariant="bold">R</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq227.gif"/></alternatives></inline-formula> weighted by hyperparameter <inline-formula id="IEq228"><alternatives><tex-math id="M463">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$s$$\end{document}</tex-math><mml:math id="M464"><mml:mi>s</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq228.gif"/></alternatives></inline-formula>. This is the same objective function as the clustering step of Harmony, except it does not include the diversity penalty term. In Harmony, the purpose of the diversity term is to penalize clusters that are only represented by one or a few datasets (suggesting they do not represent true cell types). In contrast, Symphony does not require the use of a diversity penalty because the reference centroids have already been established. Furthermore, the query cell types can comprise a subset of a larger set of reference cell types, and therefore not all clusters are necessarily expected to be represented in the query. We can solve for <inline-formula id="IEq229"><alternatives><tex-math id="M465">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M466"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq229.gif"/></alternatives></inline-formula>, the optimal probabilistic assignment for query cells across each of the <inline-formula id="IEq230"><alternatives><tex-math id="M467">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M468"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq230.gif"/></alternatives></inline-formula> reference clusters (see Query mapping implementation details).<disp-formula id="Equ5"><label>5</label><alternatives><tex-math id="M469">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{array}{c}\mathop{\min }\limits_{{{{{{\bf{R}}}}}},{{{{{\bf{Y}}}}}}} \mathop {\sum }\limits_{i,k}{{{{{\bf{R}}}}}}_{[{{{{{\bf{k}}}}}},{{{{{\bf{i}}}}}}]}{\Vert {{{{{{\bf{Z}}}}}}}_{[\cdot ,{{{{{\bf{i}}}}}}]}-{{{{{{\bf{Y}}}}}}}_{[\cdot ,{{{{{\bf{k}}}}}}]}\Vert }^{2}+s{{{{{{\bf{R}}}}}}}_{[{{{{{\bf{k}}}}}},{{{{{\bf{i}}}}}}]}\,\log ({{{{{{\bf{R}}}}}}}_{[{{{{{\bf{k}}}}}},{{{{{\bf{i}}}}}}]})\\ {{{{{\rm{s}}}}}}{{{{{\rm{.t}}}}}}.\,{\forall }_{i}{\forall }_{k}{{{{{{\bf{R}}}}}}}_{[{{{{{\bf{k}}}}}},{{{{{\bf{i}}}}}}]} \, &gt; \, 0,\,{\forall }_{i}\,\mathop{\sum}\limits _{k}{{{{{{\bf{R}}}}}}}_{[{{{{{\bf{k}}}}}},{{{{{\bf{i}}}}}}]}=1\end{array}$$\end{document}</tex-math><mml:math id="M470"><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:munder><mml:mrow><mml:mi>min</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">R</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow></mml:munder><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:msup><mml:mrow><mml:mo>∥</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mo>⋅</mml:mo><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mo>⋅</mml:mo><mml:mo>,</mml:mo><mml:mi mathvariant="bold">k</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mo>∥</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>+</mml:mo><mml:mi>s</mml:mi><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mspace width="0.25em"/><mml:mi>log</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">.t</mml:mi><mml:mo>.</mml:mo><mml:mspace width="0.25em"/><mml:msub><mml:mrow><mml:mo>∀</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mo>∀</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mspace width="0.25em"/><mml:mo>&gt;</mml:mo><mml:mspace width="0.25em"/><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mspace width="0.25em"/><mml:msub><mml:mrow><mml:mo>∀</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mspace width="0.25em"/><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mtd></mml:mtr></mml:mtable></mml:math><graphic xlink:href="41467_2021_25957_Article_Equ5.gif" position="anchor"/></alternatives></disp-formula></p>
      </sec>
      <sec id="Sec22">
        <title>Mixture of experts correction</title>
        <p id="Par77">The final step in Symphony mapping is to model then remove the query batch effects to obtain <inline-formula id="IEq231"><alternatives><tex-math id="M471">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M472"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq231.gif"/></alternatives></inline-formula>, the approximate location of query cells in the harmonized reference embedding. In Eq. (<xref rid="Equ2" ref-type="">2</xref>), we modeled the reference and query cells together and wish to solve for the query parameters <inline-formula id="IEq232"><alternatives><tex-math id="M473">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\bf{B}}}}}}}_{{{{{{\bf{qk}}}}}}}\in {\mathbb{R}}}^{(1+c)\times {d}}$$\end{document}</tex-math><mml:math id="M474"><mml:msup><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qk</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>c</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq232.gif"/></alternatives></inline-formula> for each cluster <inline-formula id="IEq233"><alternatives><tex-math id="M475">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M476"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq233.gif"/></alternatives></inline-formula>. The reference-dependent terms in Eq. (<xref rid="Equ2" ref-type="">2</xref>) were previously computed and saved in compressed form (<inline-formula id="IEq234"><alternatives><tex-math id="M477">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{N}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M478"><mml:msub><mml:mrow><mml:mi mathvariant="bold">N</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq234.gif"/></alternatives></inline-formula> and <inline-formula id="IEq235"><alternatives><tex-math id="M479">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{C}}}}}}$$\end{document}</tex-math><mml:math id="M480"><mml:mi mathvariant="bold">C</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq235.gif"/></alternatives></inline-formula>). With <inline-formula id="IEq236"><alternatives><tex-math id="M481">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M482"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq236.gif"/></alternatives></inline-formula> and <inline-formula id="IEq237"><alternatives><tex-math id="M483">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M484"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq237.gif"/></alternatives></inline-formula> calculated from query cell projection and clustering, we can finally solve for <inline-formula id="IEq238"><alternatives><tex-math id="M485">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{qk}}}}}}}$$\end{document}</tex-math><mml:math id="M486"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qk</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq238.gif"/></alternatives></inline-formula>. Similar to the correction step of Harmony, we obtain cell-specific correction values for the query cells by removing the batch-dependent terms captured in <inline-formula id="IEq239"><alternatives><tex-math id="M487">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{B}}}}}}}_{{{{{{\bf{qk}}}}}}{{{{{\boldsymbol{[}}}}}}{{{{{\bf{1}}}}}}{{{{{\bf{:c}}}}}}{{{{{\boldsymbol{,}}}}}}{{{{{\boldsymbol{\cdot }}}}}}{{{{{\boldsymbol{]}}}}}}}$$\end{document}</tex-math><mml:math id="M488"><mml:msub><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">qk</mml:mi><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold">1</mml:mi><mml:mi mathvariant="bold">:c</mml:mi><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold-italic">⋅</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq239.gif"/></alternatives></inline-formula>. Note that the reference batch terms are neither modeled nor corrected during reference mapping, so the harmonized reference cells do not move.</p>
        <p id="Par78">The final locations of the query cells in the harmonized embedding are estimated by iterating over all <inline-formula id="IEq240"><alternatives><tex-math id="M489">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M490"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq240.gif"/></alternatives></inline-formula> clusters and subtracting out the non-intercept batch terms for each cell weighted by cluster membership, as in Eq. (<xref rid="Equ6" ref-type="">6</xref>). Intuitively, the query centroids are moved so that they overlap perfectly with the reference centroids in the harmonized embedding. The vector <inline-formula id="IEq241"><alternatives><tex-math id="M491">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{q}}}}}}{{{{{\boldsymbol{[}}}}}}{{{{{\bf{i}}}}}}{{{{{\boldsymbol{]}}}}}}}$$\end{document}</tex-math><mml:math id="M492"><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold">i</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq241.gif"/></alternatives></inline-formula> denotes the approximate location in harmonized PC space for query cell <inline-formula id="IEq242"><alternatives><tex-math id="M493">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$i$$\end{document}</tex-math><mml:math id="M494"><mml:mi>i</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq242.gif"/></alternatives></inline-formula>. Note that mapping results may slightly differ based on whether one maps query cells all together (correcting for query batches) or maps each query batch separately. As all query cells play a role in parameter estimation if mapped altogether, the batches are technically not independent.<disp-formula id="Equ6"><label>6</label><alternatives><tex-math id="M495">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}}[{{{{{\bf{i}}}}}}]\,=\,	 \mathop {\sum}\limits _{k} {{{{{{\bf{R}}}}}}}_{{{{{{\bf{q}}}}}}[{{{{{\bf{k}}}}}},{{{{{\bf{i}}}}}}]}[{{{{{{\bf{B}}}}}}}_{{{{{{\bf{q}}}}}}{{{{{\bf{k}}}}}}[0,\cdot ]}^{{{{{{\bf{T}}}}}}}+\,{{{{{{\bf{B}}}}}}}_{{{{{{\bf{q}}}}}}{{{{{\bf{k}}}}}}[1:{{{{{\bf{c}}}}}},{{{{{\bf{i}}}}}}]}^{{{{{{\bf{T}}}}}}}{{{{{{\bf{X}}}}}}}_{{{{{{\bf{q}}}}}}}]+\varepsilon \\ {\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{q}}}}}}[{{{{{\bf{i}}}}}}]}\,=\,	 {{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}[{{{{{\bf{i}}}}}}]}-\mathop{\sum}\limits _{{{{{{\bf{k}}}}}}}{{{{{{\bf{R}}}}}}}_{{{{{{\bf{q}}}}}}[{{{{{\bf{k}}}}}},{{{{{\bf{i}}}}}}]}{{{{{{\bf{B}}}}}}}_{{{{{{\bf{q}}}}}}{{{{{\bf{k}}}}}}[1:{{{{{\bf{c}}}}}},\cdot ]}^{{{{{{\bf{T}}}}}}}{{{{{{\bf{X}}}}}}}_{{{{{{\bf{q}}}}}}}\\ {\hat{{{{{{\bf{Z}}}}}}}}_{{{{{{\bf{q}}}}}}[{{{{{\bf{i}}}}}}]}\,=\,	 \mathop{\sum}\limits _{k}{{{{{{\bf{R}}}}}}}_{{{{{{\bf{q}}}}}}[{{{{{\bf{k}}}}}},{{{{{\bf{i}}}}}}]}{{{{{{\bf{B}}}}}}}_{{{{{{\bf{q}}}}}}{{{{{\bf{k}}}}}}[0,\cdot ]}^{{{{{{\bf{T}}}}}}}+\varepsilon$$\end{document}</tex-math><mml:math id="M496"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mspace width="0.25em"/><mml:mo>=</mml:mo><mml:mspace width="0.25em"/><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mi mathvariant="bold">k</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mo>⋅</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup><mml:mo>+</mml:mo><mml:mspace width="0.25em"/><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mi mathvariant="bold">k</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi mathvariant="bold">c</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mi>ε</mml:mi><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mspace width="0.25em"/><mml:mo>=</mml:mo><mml:mspace width="0.25em"/><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="bold">k</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mi mathvariant="bold">k</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi mathvariant="bold">c</mml:mi><mml:mo>,</mml:mo><mml:mo>⋅</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi mathvariant="bold">X</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mspace width="0.25em"/><mml:mo>=</mml:mo><mml:mspace width="0.25em"/><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">B</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mi mathvariant="bold">k</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mo>⋅</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup><mml:mo>+</mml:mo><mml:mi>ε</mml:mi></mml:math><graphic xlink:href="41467_2021_25957_Article_Equ6.gif" position="anchor"/></alternatives></disp-formula></p>
        <sec id="FPar2">
          <title>Algorithm 2</title>
          <p id="Par79">Map query cells onto reference</p>
          <p>
            <graphic position="anchor" xlink:href="41467_2021_25957_Figb_HTML" id="d32e6949"/>
          </p>
        </sec>
      </sec>
    </sec>
    <sec id="Sec23">
      <title>Reference building implementation details</title>
      <sec id="Sec24">
        <title>Normalization</title>
        <p id="Par81">Starting with the gene expression matrix for reference cells, we perform log(CP10K + 1) library size normalization of the cells (if not already done). Log-normalization is recommended and performed by default (and used in all scRNA-seq analyses in the manuscript). However, Symphony can be used with other normalization methods, such as SCTransform<sup><xref ref-type="bibr" rid="CR63">63</xref></sup> or TF-IDF (see scATAC-seq analysis). The only requirement is that reference and query datasets are normalized in the same manner.</p>
      </sec>
      <sec id="Sec25">
        <title>Variable gene selection and scaling</title>
        <p id="Par82">We subset by the top <inline-formula id="IEq243"><alternatives><tex-math id="M497">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$g$$\end{document}</tex-math><mml:math id="M498"><mml:mi>g</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq243.gif"/></alternatives></inline-formula> variable genes by the variance stabilizing transform (VST) method (as provided in Seurat<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>), which fits a line to the log(variance) and log(mean) relationship using local polynomial regression, then standardizes the features by observed mean and expected variance, calculating gene variance on the standardized values, which is re-implemented as a standalone function at <ext-link ext-link-type="uri" xlink:href="https://github.com/immunogenomics/singlecellmethods">https://github.com/immunogenomics/singlecellmethods</ext-link>. The data is scaled such that the expression of each gene has a mean expression of 0 and variance of 1 across all cells.</p>
      </sec>
      <sec id="Sec26">
        <title>Principal component analysis (PCA)</title>
        <p id="Par83">We perform dimensionality reduction on the scaled gene expression <inline-formula id="IEq244"><alternatives><tex-math id="M499">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{rs}}}}}}}$$\end{document}</tex-math><mml:math id="M500"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">rs</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq244.gif"/></alternatives></inline-formula> using principal component analysis (PCA). PCA projects the data a low-dimensional, orthonormal embedding that retains most of the variation of gene expression in the dataset. Singular value decomposition (SVD) is a matrix factorization method that can calculate the PCs for a dataset. Here, we use SVD (“irlba” R package<sup><xref ref-type="bibr" rid="CR64">64</xref></sup>) to perform PCA. SVD states that matrix <inline-formula id="IEq245"><alternatives><tex-math id="M501">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{rs}}}}}}}\,$$\end{document}</tex-math><mml:math id="M502"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">rs</mml:mi></mml:mrow></mml:msub><mml:mspace width="0.25em"/></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq245.gif"/></alternatives></inline-formula>with dimensions <inline-formula id="IEq246"><alternatives><tex-math id="M503">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$g\times n$$\end{document}</tex-math><mml:math id="M504"><mml:mi>g</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq246.gif"/></alternatives></inline-formula> can be factorized as:<disp-formula id="Equ7"><label>7</label><alternatives><tex-math id="M505">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{G}}}}}}}_{{{{{{\bf{rs}}}}}}}={{{{{\bf{U}}}}}}{{{{{\mathbf{\Sigma }}}}}}{{{{{{\bf{V}}}}}}}^{{{{{{\bf{T}}}}}}}$$\end{document}</tex-math><mml:math id="M506"><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">rs</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi mathvariant="bold">U</mml:mi><mml:mi mathvariant="bold">Σ</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">V</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msup></mml:math><graphic xlink:href="41467_2021_25957_Article_Equ7.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par84">In Eq. (<xref rid="Equ7" ref-type="">7</xref>), <inline-formula id="IEq247"><alternatives><tex-math id="M507">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\Sigma }}}}}}{{{{{{\bf{V}}}}}}}^{{{{{{\bf{T}}}}}}}={{{{{{\bf{Z}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M508"><mml:mi mathvariant="bold">Σ</mml:mi><mml:msup><mml:mrow><mml:mi mathvariant="bold">V</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq247.gif"/></alternatives></inline-formula> (dimensions <inline-formula id="IEq248"><alternatives><tex-math id="M509">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d\times n$$\end{document}</tex-math><mml:math id="M510"><mml:mi>d</mml:mi><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq248.gif"/></alternatives></inline-formula>) represents the embedding of reference cells in PC space, after truncating the matrix on the first <inline-formula id="IEq249"><alternatives><tex-math id="M511">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d$$\end{document}</tex-math><mml:math id="M512"><mml:mi>d</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq249.gif"/></alternatives></inline-formula> (by default, <inline-formula id="IEq250"><alternatives><tex-math id="M513">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d=20$$\end{document}</tex-math><mml:math id="M514"><mml:mi>d</mml:mi><mml:mo>=</mml:mo><mml:mn>20</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq250.gif"/></alternatives></inline-formula>) PCs. The gene loadings (<inline-formula id="IEq251"><alternatives><tex-math id="M515">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{U}}}}}}\in {{\mathbb{R}}}^{g\times d}$$\end{document}</tex-math><mml:math id="M516"><mml:mi mathvariant="bold">U</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>g</mml:mi><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq251.gif"/></alternatives></inline-formula>) are saved. Note that an alternative embedding, such as canonical correlation analysis (CCA) may be used in place of PCA, as long as the gene loadings are saved.</p>
      </sec>
      <sec id="Sec27">
        <title>Harmony integration</title>
        <p id="Par85">The PCA embedding (<inline-formula id="IEq252"><alternatives><tex-math id="M517">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M518"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq252.gif"/></alternatives></inline-formula>) is then input to Harmony for dataset integration. By default, Symphony uses the default parameters for the cluster diversity enforcement (<inline-formula id="IEq253"><alternatives><tex-math id="M519">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\theta =2$$\end{document}</tex-math><mml:math id="M520"><mml:mi>θ</mml:mi><mml:mo>=</mml:mo><mml:mn>2</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq253.gif"/></alternatives></inline-formula>), the entropy regularization hyperparameter for soft k-means (<inline-formula id="IEq254"><alternatives><tex-math id="M521">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$s=0.1$$\end{document}</tex-math><mml:math id="M522"><mml:mi>s</mml:mi><mml:mo>=</mml:mo><mml:mn>0.1</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq254.gif"/></alternatives></inline-formula>), and the number of clusters <inline-formula id="IEq255"><alternatives><tex-math id="M523">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k={\min }\left(100,\frac{n}{30}\right).$$\end{document}</tex-math><mml:math id="M524"><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mi>min</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>100</mml:mn><mml:mo>,</mml:mo><mml:mfrac><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mn>30</mml:mn></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq255.gif"/></alternatives></inline-formula> We save the L2-normalized cluster centroid locations <inline-formula id="IEq256"><alternatives><tex-math id="M525">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Y}}}}}}}_{{{\cos }}}$$\end{document}</tex-math><mml:math id="M526"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi>cos</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq256.gif"/></alternatives></inline-formula> to the reference object since query mapping employs a cosine distance metric. If the reference has a single-level batch structure, no integration is performed, and the clusters are defined using soft k-means.</p>
      </sec>
    </sec>
    <sec id="Sec28">
      <title>Query mapping implementation details</title>
      <sec id="Sec29">
        <title>Normalization and scaling</title>
        <p id="Par86">The gene expression for query cells are assumed to be library size normalized in the same manner that was used to normalize the reference cells, e.g., log(CP10K + 1). During scaling, the query data is subset by the same variable genes from the reference datasets, and query gene expression is scaled by the <italic>reference</italic> gene means and standard deviations. Any genes present in the query but not the reference are ignored, and any genes present in the reference but not the query have scaled expression set to 0.</p>
      </sec>
      <sec id="Sec30">
        <title>Clustering step uses cosine distance</title>
        <p id="Par87">As in Harmony, in practice we use cosine distance rather than Euclidean distance in the clustering step. For the computation of the distance term, we L2-normalize the columns (cells) of <bold>Z</bold> and columns (centroids) of <bold>Y</bold><sub><bold>k</bold></sub> such that the squared values sum to 1 across each column. Let the terms <inline-formula id="IEq257"><alternatives><tex-math id="M527">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}\_{{\cos }}{{{{{\boldsymbol{[}}}}}}{{{{{\boldsymbol{\cdot }}}}}}{{{{{\boldsymbol{,}}}}}}{{{{{\bf{i}}}}}}{{{{{\boldsymbol{]}}}}}}}$$\end{document}</tex-math><mml:math id="M528"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mo>_</mml:mo><mml:mi>cos</mml:mi><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold-italic">⋅</mml:mi><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold">i</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq257.gif"/></alternatives></inline-formula> and <inline-formula id="IEq258"><alternatives><tex-math id="M529">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Y}}}}}}}_{{{\cos }}{{{{{\boldsymbol{[}}}}}}{{{{{\boldsymbol{\cdot }}}}}}{{{{{\boldsymbol{,}}}}}}{{{{{\bf{k}}}}}}{{{{{\boldsymbol{]}}}}}}}$$\end{document}</tex-math><mml:math id="M530"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi>cos</mml:mi><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold-italic">⋅</mml:mi><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold">k</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq258.gif"/></alternatives></inline-formula> represent the L2-normalized locations of query cell <inline-formula id="IEq259"><alternatives><tex-math id="M531">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$i$$\end{document}</tex-math><mml:math id="M532"><mml:mi>i</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq259.gif"/></alternatives></inline-formula> and the reference centroid for cluster <inline-formula id="IEq260"><alternatives><tex-math id="M533">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M534"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq260.gif"/></alternatives></inline-formula> in PC space, respectively. We compute the cosine distance between the cells and centroids. Since all <inline-formula id="IEq261"><alternatives><tex-math id="M535">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}\_{{\cos }}{{{{{\boldsymbol{[}}}}}}{{{{{\boldsymbol{\cdot }}}}}}{{{{{\boldsymbol{,}}}}}}{{{{{\bf{i}}}}}}{{{{{\boldsymbol{]}}}}}}}$$\end{document}</tex-math><mml:math id="M536"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mo>_</mml:mo><mml:mi>cos</mml:mi><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold-italic">⋅</mml:mi><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold">i</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq261.gif"/></alternatives></inline-formula> and <inline-formula id="IEq262"><alternatives><tex-math id="M537">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Y}}}}}}}_{{{\cos }}{{{{{\boldsymbol{[}}}}}}{{\cdot}}{{{{{\boldsymbol{,}}}}}}{{{{{\bf{k}}}}}}{{{{{\boldsymbol{]}}}}}}}$$\end{document}</tex-math><mml:math id="M538"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi>cos</mml:mi><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mo>⋅</mml:mo><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold">k</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq262.gif"/></alternatives></inline-formula> each have unity norm, the squared Euclidean distance <inline-formula id="IEq263"><alternatives><tex-math id="M539">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\Vert {{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}\_{{{{{\bf{c}}}}}}{{{{{\bf{o}}}}}}{{{{{\bf{s}}}}}}[\cdot ,{{{{{\bf{i}}}}}}]}-{{{{{{\bf{Y}}}}}}}_{{{{{{\bf{c}}}}}}{{{{{\bf{o}}}}}}{{{{{\bf{s}}}}}}[\cdot ,{{{{{\bf{k}}}}}}]}\Vert }^{2}$$\end{document}</tex-math><mml:math id="M540"><mml:msup><mml:mrow><mml:mo>∥</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mo>_</mml:mo><mml:mi mathvariant="bold">c</mml:mi><mml:mi mathvariant="bold">o</mml:mi><mml:mi mathvariant="bold">s</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mo>⋅</mml:mo><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">c</mml:mi><mml:mi mathvariant="bold">o</mml:mi><mml:mi mathvariant="bold">s</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mo>⋅</mml:mo><mml:mo>,</mml:mo><mml:mi mathvariant="bold">k</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mo>∥</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq263.gif"/></alternatives></inline-formula> is equivalent to the cosine distance <inline-formula id="IEq264"><alternatives><tex-math id="M541">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2\left(1-{{\cos }}({{{{{{\boldsymbol{Y}}}}}}}_{{{\cos }}{{{{{\boldsymbol{[}}}}}}{{{{{\boldsymbol{\cdot }}}}}}{{{{{\boldsymbol{,}}}}}}{{{{{\bf{k}}}}}}{{{{{\boldsymbol{]}}}}}}},{{{{{{\boldsymbol{Z}}}}}}}_{{{{{{\boldsymbol{q}}}}}}\_{{\cos }}{{{{{\boldsymbol{[}}}}}}{{{{{\boldsymbol{\cdot }}}}}}{{{{{\boldsymbol{,}}}}}}{{{{{\boldsymbol{i}}}}}}{{{{{\boldsymbol{]}}}}}}})\right)=2(1-{{{{{{\bf{Y}}}}}}}_{{{\cos }}{{{{{\boldsymbol{[}}}}}}{{{{{\bf{k}}}}}}{{{{{\boldsymbol{,}}}}}}{{{{{\boldsymbol{\cdot }}}}}}{{{{{\boldsymbol{]}}}}}}}^{{{{{{\bf{T}}}}}}}{{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}\_{{\cos }}{{{{{\boldsymbol{[}}}}}}{{{{{\boldsymbol{\cdot }}}}}}{{{{{\boldsymbol{,}}}}}}{{{{{\bf{i}}}}}}{{{{{\boldsymbol{]}}}}}}})$$\end{document}</tex-math><mml:math id="M542"><mml:mn>2</mml:mn><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mi>cos</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">Y</mml:mi></mml:mrow><mml:mrow><mml:mi>cos</mml:mi><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold-italic">⋅</mml:mi><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold">k</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">q</mml:mi><mml:mo>_</mml:mo><mml:mi>cos</mml:mi><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold-italic">⋅</mml:mi><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold-italic">i</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mn>2</mml:mn><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi>cos</mml:mi><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold">k</mml:mi><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold-italic">⋅</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mo>_</mml:mo><mml:mi>cos</mml:mi><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold-italic">⋅</mml:mi><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold">i</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq264.gif"/></alternatives></inline-formula>. Therefore, the objective function for query assignment to centroids becomes:<disp-formula id="Equ8"><label>8</label><alternatives><tex-math id="M543">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathop{\min }\limits_{{{{\bf{R}}}},{{{\bf{Y}}}}}\mathop{\sum}\limits_{i,k}2	{{{{\bf{R}}}}}_{{{{\bf{q}}}}[{{{\bf{k}}}},{{{\bf{i}}}}]}(1-{{{{\bf{Y}}}}}_{{{{\bf{c}}}}{{{\bf{o}}}}{{{\bf{s}}}}[{{{\bf{k}}}},\cdot ]}^{{{{\bf{T}}}}}{{{{\bf{Z}}}}}_{{{{\bf{q}}}}\_{{{\bf{c}}}}{{{\bf{o}}}}{{{\bf{s}}}}[\cdot ,{{{\bf{i}}}}]})+s{{{{\bf{R}}}}}_{{{{\bf{q}}}}[{{{\bf{k}}}},{{{\bf{i}}}}]}\, \log ({{{{\bf{R}}}}}_{{{{\bf{q}}}}[{{{\bf{k}}}},{{{\bf{i}}}}]})\\ 	{{{\rm{s}}}}{{{\rm{.t}}}}.\, {\forall }_{i}{\forall }_{k}{{{{\bf{R}}}}}_{[{{{\bf{k}}}},{{{\bf{i}}}}]} \, &gt; \, 0, \, {\forall }_{i}\,\mathop{\sum} _{k}{{{{\bf{R}}}}}_{[{{{\bf{k}}}},{{{\bf{i}}}}]}=1$$\end{document}</tex-math><mml:math id="M544"><mml:munder><mml:mrow><mml:mi>min</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">R</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow></mml:munder><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:munder><mml:mn>2</mml:mn><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">c</mml:mi><mml:mi mathvariant="bold">o</mml:mi><mml:mi mathvariant="bold">s</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mo>⋅</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mo>_</mml:mo><mml:mi mathvariant="bold">c</mml:mi><mml:mi mathvariant="bold">o</mml:mi><mml:mi mathvariant="bold">s</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mo>⋅</mml:mo><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mi>s</mml:mi><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mspace width="0.25em"/><mml:mi>log</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">.t</mml:mi><mml:mo>.</mml:mo><mml:mspace width="0.25em"/><mml:msub><mml:mrow><mml:mo>∀</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mo>∀</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mspace width="0.25em"/><mml:mo>&gt;</mml:mo><mml:mspace width="0.25em"/><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mspace width="0.25em"/><mml:msub><mml:mrow><mml:mo>∀</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mspace width="0.25em"/><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:math><graphic xlink:href="41467_2021_25957_Article_Equ8.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par88">We can solve the optimization problem using an expectation-maximization framework. Following the same strategy as Korsunsky et al.<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, we calculate <inline-formula id="IEq265"><alternatives><tex-math id="M545">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M546"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq265.gif"/></alternatives></inline-formula>, the optimal probabilistic assignments for each query cell <inline-formula id="IEq266"><alternatives><tex-math id="M547">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$i$$\end{document}</tex-math><mml:math id="M548"><mml:mi>i</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq266.gif"/></alternatives></inline-formula> across each of the <inline-formula id="IEq267"><alternatives><tex-math id="M549">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M550"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq267.gif"/></alternatives></inline-formula> reference clusters. In Eq. (<xref rid="Equ9" ref-type="">9</xref>), we can interpret <inline-formula id="IEq268"><alternatives><tex-math id="M551">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{q}}}}}}{{{{{\boldsymbol{[}}}}}}{{{{{\bf{k}}}}}}{{{{{\boldsymbol{,}}}}}}{{{{{\bf{i}}}}}}{{{{{\boldsymbol{]}}}}}}}$$\end{document}</tex-math><mml:math id="M552"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mi mathvariant="bold-italic">[</mml:mi><mml:mi mathvariant="bold">k</mml:mi><mml:mi mathvariant="bold-italic">,</mml:mi><mml:mi mathvariant="bold">i</mml:mi><mml:mi mathvariant="bold-italic">]</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq268.gif"/></alternatives></inline-formula> as the probability that query cell <inline-formula id="IEq269"><alternatives><tex-math id="M553">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$i$$\end{document}</tex-math><mml:math id="M554"><mml:mi>i</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq269.gif"/></alternatives></inline-formula> belongs to cluster <inline-formula id="IEq270"><alternatives><tex-math id="M555">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M556"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq270.gif"/></alternatives></inline-formula>. The denominator term simply ensures that for any given cell <inline-formula id="IEq271"><alternatives><tex-math id="M557">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$i$$\end{document}</tex-math><mml:math id="M558"><mml:mi>i</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq271.gif"/></alternatives></inline-formula>, the probabilities across all <inline-formula id="IEq272"><alternatives><tex-math id="M559">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M560"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq272.gif"/></alternatives></inline-formula> clusters sum to one. By default, <inline-formula id="IEq273"><alternatives><tex-math id="M561">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$s=0.1$$\end{document}</tex-math><mml:math id="M562"><mml:mi>s</mml:mi><mml:mo>=</mml:mo><mml:mn>0.1</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq273.gif"/></alternatives></inline-formula>.<disp-formula id="Equ9"><label>9</label><alternatives><tex-math id="M563">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{q}}}}}}({{{{{\bf{k}}}}}},{{{{{\bf{i}}}}}})}=\,\frac{{\exp }\left(-\frac{2}{{{{{{\rm{s}}}}}}}(1-{{{{{{\bf{Y}}}}}}}_{{{{{{\bf{cos }}}}}}[{{{{{\bf{k}}}}}},\bullet ]}^{{{{{{\bf{T}}}}}}}{{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}\_{{{{{\bf{cos }}}}}}[\bullet ,{{{{{\bf{i}}}}}}]})\right)}{\mathop{\sum}\limits_{{{{{{\rm{k}}}}}}}{{{{{\rm{exp }}}}}}\left(-\frac{2}{{{{{{\rm{s}}}}}}}(1-{{{{{{\bf{Y}}}}}}}_{{{{{{\bf{cos }}}}}}[{{{{{\bf{k}}}}}},\bullet ]}^{{{{{{\bf{T}}}}}}}{{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}\_{{{{{\bf{cos }}}}}}[\bullet ,{{{{{\bf{i}}}}}}]})\right)}$$\end{document}</tex-math><mml:math id="M564"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mspace width="0.25em"/><mml:mfrac><mml:mrow><mml:mi>exp</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">s</mml:mi></mml:mrow></mml:mfrac><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">cos</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mo>∙</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mo>_</mml:mo><mml:mi mathvariant="bold">cos</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mo>∙</mml:mo><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="normal">k</mml:mi></mml:mrow></mml:munder><mml:mi mathvariant="normal">exp</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mi mathvariant="normal">s</mml:mi></mml:mrow></mml:mfrac><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">Y</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">cos</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mi mathvariant="bold">k</mml:mi><mml:mo>,</mml:mo><mml:mo>∙</mml:mo></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msubsup><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi><mml:mo>_</mml:mo><mml:mi mathvariant="bold">cos</mml:mi><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mo>∙</mml:mo><mml:mo>,</mml:mo><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mo>]</mml:mo></mml:mrow></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfenced></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="41467_2021_25957_Article_Equ9.gif" position="anchor"/></alternatives></disp-formula></p>
      </sec>
      <sec id="Sec31">
        <title>Query label prediction and prediction confidence score</title>
        <p id="Par89">Once query cells are embedded in the same low-dimensional feature space as the reference, reference labels can be transferred to the query using any downstream model (e.g., k-NN, SVM, logistic regression) using the harmonized PCs as input. See the analysis of benchmarking against automatic cell type classifiers for examples of using different downstream inference methods with Symphony.</p>
        <p id="Par90">For most analyses presented, we use a simple and intuitive k-NN classifier (as implemented in the “class” R package), which uses majority vote with ties broken randomly. We provide a convenient wrapper function in the Symphony package to do this (knnPredict), which optionally returns the prediction confidence, measuring the proportion of reference neighbors contributing to the winning vote. For k-NN prediction, we would recommend that users alter the <inline-formula id="IEq274"><alternatives><tex-math id="M565">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M566"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq274.gif"/></alternatives></inline-formula> parameter so that it is ideally no larger than the number of cells in the rarest cell type of the reference. For example, if the reference contains only 10 cells of a rare cell type, then we recommend the user set <inline-formula id="IEq275"><alternatives><tex-math id="M567">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M568"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq275.gif"/></alternatives></inline-formula> no higher than 10, to ensure that rare cell types in the reference have the chance of being predicted given a majority vote k-NN classifier.</p>
      </sec>
    </sec>
    <sec id="Sec32">
      <title>Mapping confidence metrics</title>
      <p id="Par91">Symphony offers two scores that measure the confidence in query mapping and helps to identify query cell states missing in the reference. We recommend that users try both metrics and further investigate any query cells/clusters that appear to map poorly.</p>
      <sec id="Sec33">
        <title>Background: Mahalanobis distance</title>
        <p id="Par92">Mahalanobis distance is a multivariate metric that measures the distance from a point to a distribution. It can be thought of as analogous to the univariate <italic>Z</italic>-score. We use Mahalanobis distance rather than Euclidean distance since Euclidean distance assumes uncorrelated features, whereas Mahalanobis distance accounts for potentially correlated features. PCA technically returns uncorrelated variables (which would have a covariance matrix containing zeros in all non-diagonal positions); however, when considering the distribution of cells surrounding each soft-cluster individually (rather than all cells altogether), the covariance matrices have non-zero values. Mahalanobis distance (<inline-formula id="IEq276"><alternatives><tex-math id="M569">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$D$$\end{document}</tex-math><mml:math id="M570"><mml:mi>D</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq276.gif"/></alternatives></inline-formula>) from a point <inline-formula id="IEq277"><alternatives><tex-math id="M571">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{x}}}}}}$$\end{document}</tex-math><mml:math id="M572"><mml:mi mathvariant="bold">x</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq277.gif"/></alternatives></inline-formula> to a distribution with mean <inline-formula id="IEq278"><alternatives><tex-math id="M573">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\mu }}}}}}$$\end{document}</tex-math><mml:math id="M574"><mml:mi mathvariant="bold">μ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq278.gif"/></alternatives></inline-formula> and covariance matrix <inline-formula id="IEq279"><alternatives><tex-math id="M575">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\Sigma }}}}}}$$\end{document}</tex-math><mml:math id="M576"><mml:mi mathvariant="bold">Σ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq279.gif"/></alternatives></inline-formula> in <inline-formula id="IEq280"><alternatives><tex-math id="M577">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d$$\end{document}</tex-math><mml:math id="M578"><mml:mi>d</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq280.gif"/></alternatives></inline-formula>-dimensional space is defined as:<disp-formula id="Equ10"><label>10</label><alternatives><tex-math id="M579">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${D}^{2}={\left({{{{{\bf{x}}}}}}-{{{{{\mathbf{\mu }}}}}}\right)}^{{{{{{\rm{T}}}}}}}\,{{{{{{\mathbf{\Sigma }}}}}}}^{-1}({{{{{\bf{x}}}}}}-{{{{{\mathbf{\mu }}}}}})$$\end{document}</tex-math><mml:math id="M580"><mml:msup><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="bold">x</mml:mi><mml:mo>−</mml:mo><mml:mi mathvariant="bold">μ</mml:mi></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msup><mml:mspace width="0.25em"/><mml:msup><mml:mrow><mml:mi mathvariant="bold">Σ</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">x</mml:mi><mml:mo>−</mml:mo><mml:mi mathvariant="bold">μ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><graphic xlink:href="41467_2021_25957_Article_Equ10.gif" position="anchor"/></alternatives></disp-formula></p>
      </sec>
      <sec id="Sec34">
        <title>Per-cell mapping metric</title>
        <p id="Par93">The per-cell mapping metric measures the weighted Mahalanobis distance between each query cell and the distribution of reference cells they map nearest to, weighted by soft-cluster membership. In Eq. (<xref rid="Equ9" ref-type="">9</xref>), <inline-formula id="IEq281"><alternatives><tex-math id="M581">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{x}}}}}}$$\end{document}</tex-math><mml:math id="M582"><mml:mi mathvariant="bold">x</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq281.gif"/></alternatives></inline-formula> is the query cell position (<inline-formula id="IEq282"><alternatives><tex-math id="M583">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d$$\end{document}</tex-math><mml:math id="M584"><mml:mi>d</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq282.gif"/></alternatives></inline-formula>-dimensional vector), and <inline-formula id="IEq283"><alternatives><tex-math id="M585">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\mu }}}}}}$$\end{document}</tex-math><mml:math id="M586"><mml:mi mathvariant="bold">μ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq283.gif"/></alternatives></inline-formula> and <inline-formula id="IEq284"><alternatives><tex-math id="M587">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\Sigma }}}}}}$$\end{document}</tex-math><mml:math id="M588"><mml:mi mathvariant="bold">Σ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq284.gif"/></alternatives></inline-formula> are the weighted mean (<inline-formula id="IEq285"><alternatives><tex-math id="M589">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\mu }}}}}}$$\end{document}</tex-math><mml:math id="M590"><mml:mi mathvariant="bold">μ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq285.gif"/></alternatives></inline-formula>) and covariance matrix (<inline-formula id="IEq286"><alternatives><tex-math id="M591">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\mathbf{\Sigma }}}}}}$$\end{document}</tex-math><mml:math id="M592"><mml:mi mathvariant="bold">Σ</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq286.gif"/></alternatives></inline-formula>) for each reference Harmony soft-cluster centroid in pre-Harmonized PC space, weighted according to the reference cells belonging to that cluster (<inline-formula id="IEq287"><alternatives><tex-math id="M593">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{r}}}}}}}$$\end{document}</tex-math><mml:math id="M594"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">r</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq287.gif"/></alternatives></inline-formula>). For each query cell, we calculate its Mahalanobis distance (<inline-formula id="IEq288"><alternatives><tex-math id="M595">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$D$$\end{document}</tex-math><mml:math id="M596"><mml:mi>D</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq288.gif"/></alternatives></inline-formula>) to each reference centroid then take the weighted average across all centroids the query cell belongs to (defined using <inline-formula id="IEq289"><alternatives><tex-math id="M597">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{R}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M598"><mml:msub><mml:mrow><mml:mi mathvariant="bold">R</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq289.gif"/></alternatives></inline-formula>). As the metric is a distance measure, it ranges from 0 to infinity. In practice, we have noticed that cell states well-represented in the reference tend to have values &lt;10.</p>
      </sec>
      <sec id="Sec35">
        <title>Per-cluster mapping metric</title>
        <p id="Par94">The per-cluster mapping metric takes in a user-defined set of query cluster labels, e.g., putative cell types from running a de novo PCA pipeline on the query followed by graph-based clustering. User-defined clusters are likely to represent unique cell types within the query data. The intuition behind this metric is that if a query cell type is well-represented by the reference PC structure, then it should map closely to a reference centroid. We first project the query into reference pre-Harmony PCs, then calculate the Mahalanobis distance between the query cluster and its nearest reference centroid, where the covariance is defined using the query cluster in reference PC space. All cells in a given cluster receive the same score. By aggregating signal using multiple query cells per cluster rather than each cell individually, this metric potentially offers greater discriminatory ability than the per-cell metric. A disadvantage of the metric is that it is sometimes difficult to anticipate what the covariance of the query will be upon projection into reference PCs. Additionally, if a query cluster has very few cells, the estimation of its covariance matrix becomes numerically unstable; in practice, we return NAs for clusters smaller than <inline-formula id="IEq290"><alternatives><tex-math id="M599">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$2d$$\end{document}</tex-math><mml:math id="M600"><mml:mn>2</mml:mn><mml:mi>d</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq290.gif"/></alternatives></inline-formula>, where <inline-formula id="IEq291"><alternatives><tex-math id="M601">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$d$$\end{document}</tex-math><mml:math id="M602"><mml:mi>d</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq291.gif"/></alternatives></inline-formula> is the dimensionality of the embedding.</p>
      </sec>
    </sec>
    <sec id="Sec36">
      <title>Analysis of 10x PBMCs</title>
      <sec id="Sec37">
        <title>Preprocessing scRNA-seq data</title>
        <p id="Par95">The three 10x PBMCs datasets were previously preprocessed by our group as part of the Harmony publication. We used the same log(CP10K + 1) normalized expression data, filtered as described in Korsunsky et al.<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>. The datasets consist of PBMCs sequenced using three technologies: 3’v1 (<inline-formula id="IEq292"><alternatives><tex-math id="M603">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M604"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq292.gif"/></alternatives></inline-formula> = 4809 cells), 3’v2 (8380 cells), and 5’ (7697 cells).</p>
      </sec>
      <sec id="Sec38">
        <title>Symphony mapping experiments</title>
        <p id="Par96">To construct each of three references for subsequent mapping, we aggregated two reference datasets into a single normalized expression matrix and identified the top 1000 reference variable genes across each technology batch (then pooled them) using the variance stabilizing transformation (VST) procedure<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>. We ran Harmony on the top 20 PCs, harmonizing over “technology” with default parameters. For Symphony mapping, we specified query “technology” covariate.</p>
      </sec>
      <sec id="Sec39">
        <title>Constructing gold standard embedding</title>
        <p id="Par97">To construct the gold standard de novo Harmony embedding, we concatenated all three datasets together into a single expression matrix, subset by the top 1000 variable genes calculated within each of three batches in the dataset then pooled, and ran Harmony integration on the top 20 PCs, harmonizing over “technology” with default parameters.</p>
      </sec>
      <sec id="Sec40">
        <title>Assigning ground truth cell types</title>
        <p id="Par98">We clustered the cells in the gold standard embedding using the Louvain algorithm as implemented in the singlecellmethods:::buildSNN_fromFeatures function and Seurat:::RunModularityClustering function<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>. For PBMCs, we used nn_k = 5 (to capture rare HSCs), nn_eps = 0.5, and resolution = 0.8. We labeled clusters with ground truth cell types according to expression of canonical lineage marker genes (Supplementary Table <xref rid="MOESM1" ref-type="media">2</xref>). PBMCs were assigned across 9 types: T (CD4: <italic>CD3D, IL7R, CD4</italic>; CD8: <italic>CD3D, CD8A</italic>), NK (<italic>GNLY</italic>), B (<italic>MS4A1</italic>), Monocytes (CD14: <italic>CD14</italic>, <italic>LYZ</italic>; CD16: <italic>FCGR3A, MS4A7</italic>), DCs (<italic>FCER1A</italic>), Megakaryocytes (<italic>PPBP</italic>), and HSCs (<italic>CD59</italic>). Clusters were labeled if the AUC (calculated using presto<sup><xref ref-type="bibr" rid="CR65">65</xref></sup>) for the corresponding lineage marker was &gt;0.7. For clusters that did not express specific lineage markers or were ambiguous between multiple lineages, we manually assigned a cell type based on the top differentially expressed genes (Supplementary Table <xref rid="MOESM1" ref-type="media">3</xref>) and comparing to the cluster annotation from Korsunsky et al. (2019). PBMCs cluster 14 was identified as low-quality cells (high in mitochondrial genes). We removed all cells in this cluster (<inline-formula id="IEq293"><alternatives><tex-math id="M605">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M606"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq293.gif"/></alternatives></inline-formula> = 315) from further analyses, leaving 20,571 cells total. The final ground truth labels were used in downstream analyses and cell type classification accuracy evaluation.</p>
      </sec>
      <sec id="Sec41">
        <title>Evaluation of mixing and cell type classification accuracy</title>
        <p id="Par99">To compare dataset mixing between de novo integration and mapping, we calculated Local Inverse Simpson Index (LISI) using the compute_lisi function from <ext-link ext-link-type="uri" xlink:href="https://github.com/immunogenomics/LISI">https://github.com/immunogenomics/LISI</ext-link> with default parameters (perplexity = 30). Perplexity represents the effective number of each cell’s neighbors. For each mapping experiment, we calculated dataset LISI on all cells, then subset the results for query cell neighborhoods only to measure the effective number of datasets in the local neighborhood of each query cell.</p>
        <p id="Par100">We predicted query cell types by transferring reference cell type annotations using the knn function in the “class” R package (<italic>k</italic> = 5). We calculated overall accuracy across all query cells and cell type F1-scores (the harmonic mean of precision and recall, ranging from 0–1). Precision = TP/(TP+FP), recall = TP/(TP + FN), F1 = (2*precision*recall)/(precision+recall). Cell type F1 was the metric Abdelaal et al. used to benchmark automated cell type classifiers<sup><xref ref-type="bibr" rid="CR35">35</xref></sup>. We used their provided evaluate.R script (<ext-link ext-link-type="uri" xlink:href="https://github.com/tabdelaal/scRNAseq_Benchmark/blob/master/evaluate.R">https://github.com/tabdelaal/scRNAseq_Benchmark/blob/master/evaluate.R</ext-link>) to calculate confusion matrices and F1-scores by cell type.</p>
      </sec>
      <sec id="Sec42">
        <title>Quantifying local similarity between two embeddings</title>
        <p id="Par101">k-NN-correlation (k-NN-corr) is a new metric that quantifies how well a given alternative embedding preserves the local neighborhood structure with respect to a gold standard embedding. Anchoring on each query cell, we calculate (1) the pairwise distances to its <inline-formula id="IEq294"><alternatives><tex-math id="M607">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M608"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq294.gif"/></alternatives></inline-formula> nearest reference neighbors in the gold standard embedding and (2) the distances between the same query-reference neighbor pairs in an alternate embedding (Methods), then calculate the Spearman (rank-based) correlation between (1) and (2). For each query cell, we obtain a single k-NN-corr value capturing how well the relative distances to its <inline-formula id="IEq295"><alternatives><tex-math id="M609">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M610"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq295.gif"/></alternatives></inline-formula> nearest reference neighbors are preserved. Note that k-NN-corr is asymmetric with respect to which embedding is selected as the gold standard and which is selected as the alternative because the nearest neighbor pairs are fixed based on how they were defined in the gold standard. The distribution of k-NN-corr scores for all query cells can measure the embedding quality, where higher k-NN-corr indicates greater recapitulation of the gold standard. Lower values for <inline-formula id="IEq296"><alternatives><tex-math id="M611">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M612"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq296.gif"/></alternatives></inline-formula> assess more local neighborhoods, whereas higher <inline-formula id="IEq297"><alternatives><tex-math id="M613">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M614"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq297.gif"/></alternatives></inline-formula> assesses more global structure.</p>
        <p id="Par102">We calculated k-NN-corr between the gold standard Harmony embedding and two alternative embeddings: (1) the full Symphony mapping algorithm (projection, clustering, and correction) and (2) PCA-projection only as a comparison to a batch-naïve mapping. PCA-projection refers to the first step of Symphony mapping, where query cells are projected from gene expression to pre-harmonized PC space: <inline-formula id="IEq298"><alternatives><tex-math id="M615">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{Z}}}}}}}_{{{{{{\bf{q}}}}}}}={{{{{{\bf{U}}}}}}}^{{{{{{\bf{T}}}}}}}{{{{{{\bf{G}}}}}}}_{{{{{{\bf{q}}}}}}}$$\end{document}</tex-math><mml:math id="M616"><mml:msub><mml:mrow><mml:mi mathvariant="bold">Z</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="bold">U</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">T</mml:mi></mml:mrow></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="bold">G</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">q</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq298.gif"/></alternatives></inline-formula>.</p>
      </sec>
    </sec>
    <sec id="Sec43">
      <title>Benchmarking against automatic cell type classifiers</title>
      <p id="Par103">We downloaded the PbmcBench benchmarking dataset used by a recent comparison of automatic cell type identification methods<sup><xref ref-type="bibr" rid="CR35">35</xref>,<xref ref-type="bibr" rid="CR39">39</xref></sup>. For each of 48 train-test experiments described in Abdelaal et al.<sup><xref ref-type="bibr" rid="CR35">35</xref></sup> (see below for details), we used the same evaluation metrics (median cell type F1-score) to evaluate Symphony in comparison to the 22 other classifiers. We obtained the numerical F1-score results for the other classifiers for all 48 experiments directly from the authors in order to determine Symphony’s place within the rank ordering of classifier performance.</p>
      <p id="Par104">During reference building, we explored two different gene selection methods: (1) unsupervised (top 2000 variable genes) and (2) supervised based on identifying the top 20 differentially expressed (DE) genes per cell type. Option (2) was included to give Symphony the same information as prior-knowledge classifiers (e.g., SCINA with 20 marker genes per cell type). We used the “presto” package<sup><xref ref-type="bibr" rid="CR65">65</xref></sup> for DE analysis. No integration was performed because the reference had a single-level batch structure (clusters were simply assigned using soft k<italic>-</italic>means). Onto each of seven references (each representing one protocol for donor pbmc1), we mapped either a second protocol for donor pbmc1 (six experiments) or the same protocol for donor pbmc2 (six experiment). Given the resulting Symphony joint feature embeddings, we used three downstream classifiers to predict query cell types: 5-NN, SVM with a radial kernel, and multinomial logistic regression with ridge (“glmnet” package in R)<sup><xref ref-type="bibr" rid="CR66">66</xref></sup>. We note that other methods in the original benchmark were permitted to have a “rejection option” (leave uncertain cells as “unclassified” and not included in F1-score calculation). Hence, we also added a version for each of the two Symphony 5-NN versions that only assigned a label if the cell had &gt;0.6 prediction confidence (<inline-formula id="IEq299"><alternatives><tex-math id="M617">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\ge$$\end{document}</tex-math><mml:math id="M618"><mml:mo>≥</mml:mo></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq299.gif"/></alternatives></inline-formula>4 out of 5 neighbors with the winning vote). A total of 8 Symphony-based classifiers were tested (2 gene selection methods * 3 downstream classifiers + 2 rejection option versions).</p>
    </sec>
    <sec id="Sec44">
      <title>Pancreas benchmark</title>
      <sec id="Sec45">
        <title>Constructing the pancreas query with mouse and human cells</title>
        <p id="Par105">The pancreas query dataset (Baron et al.<sup><xref ref-type="bibr" rid="CR46">46</xref></sup>; inDrop, <inline-formula id="IEq300"><alternatives><tex-math id="M619">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M620"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq300.gif"/></alternatives></inline-formula> = 8569 human, 1886 mouse cells) along with author-defined cell type labels were downloaded from <ext-link ext-link-type="uri" xlink:href="https://hemberg-lab.github.io/scRNA.seq.datasets/human/pancreas/">https://hemberg-lab.github.io/scRNA.seq.datasets/human/pancreas/</ext-link>. In order to combine the human and mouse matrices into a single aggregated query, we “humanized” the mouse expression matrix by mapping mouse genes to their orthologous human genes. This mapping was computed using the “biomaRt” R package<sup><xref ref-type="bibr" rid="CR67">67</xref></sup>, mapping “mgi_symbol” from the “mmusculus_gene_ensembl” database to “hgnc_symbol” from the “hsapien_gene_ensembl” database. We added additional ortholog pairs from HomoloGene (<ext-link ext-link-type="uri" xlink:href="https://ftp.ncbi.nih.gov/pub/HomoloGene/build37.2/homologene.data">https://ftp.ncbi.nih.gov/pub/HomoloGene/build37.2/homologene.data</ext-link>) to obtain a total of 22,578 human to mouse gene ortholog pairs. We represented this map as a matrix, with mouse genes as rows, human genes as columns, and values in <inline-formula id="IEq301"><alternatives><tex-math id="M621">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\{{{{{\mathrm{0,1}}}}}\}$$\end{document}</tex-math><mml:math id="M622"><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mi mathvariant="normal">0, 1</mml:mi></mml:mrow><mml:mo>}</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq301.gif"/></alternatives></inline-formula> assigned to denote whether a mouse gene maps to a human gene. We then normalized the matrix to have each column sum to one, effectively creating a count-preserving probabilistic map from <inline-formula id="IEq302"><alternatives><tex-math id="M623">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$h$$\end{document}</tex-math><mml:math id="M624"><mml:mi>h</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq302.gif"/></alternatives></inline-formula> mouse to <inline-formula id="IEq303"><alternatives><tex-math id="M625">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$H$$\end{document}</tex-math><mml:math id="M626"><mml:mi>H</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq303.gif"/></alternatives></inline-formula> human genes <inline-formula id="IEq304"><alternatives><tex-math id="M627">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\bf{M}}}}}}\in {{\mathbb{R}}}^{H\times h}$$\end{document}</tex-math><mml:math id="M628"><mml:mi mathvariant="bold">M</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>H</mml:mi><mml:mo>×</mml:mo><mml:mi>h</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq304.gif"/></alternatives></inline-formula>. Mapping from mouse to human genes is then performed with matrix multiplication: <inline-formula id="IEq305"><alternatives><tex-math id="M629">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{E}}}}}}}_{{{{{{\bf{human}}}}}}}={{{{{\bf{M}}}}}}{{{{{{\bf{E}}}}}}}_{{{{{{\bf{mouse}}}}}}}$$\end{document}</tex-math><mml:math id="M630"><mml:msub><mml:mrow><mml:mi mathvariant="bold">E</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">human</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi mathvariant="bold">M</mml:mi><mml:msub><mml:mrow><mml:mi mathvariant="bold">E</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">mouse</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq305.gif"/></alternatives></inline-formula>. Note that while the mouse gene expression matrix <inline-formula id="IEq306"><alternatives><tex-math id="M631">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{E}}}}}}}_{{{{{{\bf{mouse}}}}}}}$$\end{document}</tex-math><mml:math id="M632"><mml:msub><mml:mrow><mml:mi mathvariant="bold">E</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">mouse</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq306.gif"/></alternatives></inline-formula> contains only integers (<inline-formula id="IEq307"><alternatives><tex-math id="M633">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{E}}}}}}}_{{{{{{\bf{mouse}}}}}}}\in {{\mathbb{Z}}}^{h\times N}$$\end{document}</tex-math><mml:math id="M634"><mml:msub><mml:mrow><mml:mi mathvariant="bold">E</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">mouse</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">Z</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>×</mml:mo><mml:mi>N</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq307.gif"/></alternatives></inline-formula>), the many-to-many mapping means that the mapped human gene expression matrix <inline-formula id="IEq308"><alternatives><tex-math id="M635">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{E}}}}}}}_{{{{{{\bf{human}}}}}}}$$\end{document}</tex-math><mml:math id="M636"><mml:msub><mml:mrow><mml:mi mathvariant="bold">E</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">human</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq308.gif"/></alternatives></inline-formula> may contain non-integers (<inline-formula id="IEq309"><alternatives><tex-math id="M637">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{\bf{E}}}}}}}_{{{{{{\bf{human}}}}}}}\in {{\mathbb{R}}}^{H\times N}$$\end{document}</tex-math><mml:math id="M638"><mml:msub><mml:mrow><mml:mi mathvariant="bold">E</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">human</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>H</mml:mi><mml:mo>×</mml:mo><mml:mi>N</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq309.gif"/></alternatives></inline-formula>). For any human orthologs that were missing in the mouse expression data, we filled in the expression with zeroes. We then log(CP10K + 1) normalized the query cells.</p>
      </sec>
      <sec id="Sec46">
        <title>Preprocessing reference scRNA-seq data</title>
        <p id="Par106">The pancreas reference datasets were each sequenced with a different technology: Fluidigm C1 (<inline-formula id="IEq310"><alternatives><tex-math id="M639">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M640"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq310.gif"/></alternatives></inline-formula> = 638 cells), CEL-seq (946 cells), CEL-seq2 (2238 cells), Smart-seq2 (2355 cells). We obtained the log(CP10K + 1) normalized data from the Harmony publication<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>. The pancreas cell type labels were obtained from Korsunsky et al.<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, which assigned cells across 9 types within each dataset individually according to cluster-specific expression of marker genes: alpha (<italic>GCG</italic>), beta (<italic>MAFA</italic>), gamma (<italic>PPY</italic>), delta (<italic>SST</italic>), acinar (<italic>PRSS1</italic>), ductal (<italic>KRT19</italic>), endothelial (<italic>CDH5</italic>), stellate (<italic>COL1A2</italic>), and immune (<italic>PTPRC</italic>). We removed 290 cells that were left unassigned as part of ambiguous or outlier clusters during within-dataset annotation, leaving 5887 reference cells.</p>
        <p id="Par107">We benchmarked three reference mapping methods as follows:</p>
      </sec>
      <sec id="Sec47">
        <title>Symphony mapping onto a Harmony reference</title>
        <p id="Par108">We calculated the top 1000 variable genes within each of the four reference dataset separately using VST then pooled them (total 2,236 variable genes) for PCA. For reference integration, we ran Harmony on the top 20 PCs, harmonizing over “donor” (theta = 2) and “technology” (theta = 4), with tau = 5. For Symphony mapping, we specified query “donor”, “species”, and “technology” covariates.</p>
        <p id="Par109">As a comparison with de novo integration, we ran Harmony integration on all five datasets together. We pooled the top 1000 variable genes within each dataset (total 2650 genes), calculated the top 20 PCs, and harmonized over “species” (theta = 2), “donor” (theta = 2), and “technology” (theta = 2), with tau = 5.</p>
      </sec>
      <sec id="Sec48">
        <title>Seurat mapping onto a Seurat reference</title>
        <p id="Par110">We ran Seurat version 4<sup><xref ref-type="bibr" rid="CR30">30</xref></sup> (Seurat_4.0.2) and followed the steps from the author’s tutorial (<ext-link ext-link-type="uri" xlink:href="https://satijalab.org/seurat/v3.2/integration.html">https://satijalab.org/seurat/v3.2/integration.html</ext-link>) to integrate the reference datasets, given that the FindIntegrationAnchors and IntegrateData functions for de novo integration are equivalent between Seurat v3 and v4. We used the same 2,236 variable genes as above and 20 PCs. We followed the tutorial (<ext-link ext-link-type="uri" xlink:href="https://satijalab.org/seurat/v4.0/reference_mapping.html">https://satijalab.org/seurat/v4.0/reference_mapping.html</ext-link>) to map each donor dataset from the query individually. We used the FindTransferAnchors function with reduction = “pcaproject” and MapQuery function with reference.reduction = “pca” (as the documentation recommends for unimodal analysis).</p>
        <p id="Par111">As a comparison with de novo integration, we ran Seurat integration (FindIntegrationAnchors and IntegrateData) on all five datasets (integrating over plate-based technologies and Baron donors as batches) with the same 2650 variable genes as above and 20 PCs.</p>
      </sec>
      <sec id="Sec49">
        <title>scArches mapping onto a trVAE reference</title>
        <p id="Par112">We ran scArches<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> version 0.3 with trVAE<sup><xref ref-type="bibr" rid="CR33">33</xref></sup> using default parameters provided in the authors’ notebooks (<ext-link ext-link-type="uri" xlink:href="https://github.com/theislab/scarches/tree/master/notebooks">https://github.com/theislab/scarches/tree/master/notebooks</ext-link>). For the pancreas analysis, we only had access to normalized expression data and therefore ran scArches with trVAE using the “mse” reconstruction loss function. We included query batch information in the condition_key parameter.</p>
        <p id="Par113">As a comparison with de novo integration, we ran trVAE on all 5 datasets with default parameters, specifying batch as “dataset” for the 4 plate-based datasets and “donor” for the Baron et al. dataset.</p>
      </sec>
      <sec id="Sec50">
        <title>Evaluation metrics</title>
        <p id="Par114">We used the resulting joint (reference and query) cell embedding to predict query cell types from reference cells using a 5-NN classifier and calculated cell type prediction F1-scores, as described above. For Seurat, we additionally compared another set of predicted labels using Seurat’s TransferData function. Note that for the cell type prediction and cell type F1-score calculation, we excluded query Schwann cells from the accuracy metrics because that cell type is not present in the reference.</p>
        <p id="Par115">To assess degree of mixing, we calculated ref_query LISI and query_donors LISI on query cell neighborhoods using the <italic>compute_lisi</italic> function as above. ref_query LISI measures how well the reference and query datasets are mixed (max ref_query LISI of 2), whereas query_donors LISI measures how well the individual donors within the query dataset are mixed (max of 6).</p>
        <p id="Par116">To assess how well the query low-dimensional structure is preserved in the mapped embedding, we developed a new metric called within-query k-NN-correlation (wiq-kNN-corr). For each query batch (here, donor), we run a standard PCA pipeline on the cells (using 20 dimensions and selecting 2000 variable genes per batch using VST). Then, anchoring on each query cell, we calculate it’s (1) distances to the <inline-formula id="IEq311"><alternatives><tex-math id="M641">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M642"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq311.gif"/></alternatives></inline-formula> nearest neighbors in the query PCA embedding and (2) the distances to those same <inline-formula id="IEq312"><alternatives><tex-math id="M643">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M644"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq312.gif"/></alternatives></inline-formula> cells after reference mapping. Then, wiq-kNN-corr is the Spearman correlation between (1) and (2), ranging between –1 and 1, where higher values represent better retention of the sorted original neighbor ordering. The calculation is similar to k-NN correlation described above, except instead of measuring the sorted ordering of <italic>reference</italic> neighbors in a de novo integration embedding, we measure the sorted ordering of <italic>query</italic> neighbors in the query PCA embedding.</p>
      </sec>
    </sec>
    <sec id="Sec51">
      <title>Fetal liver hematopoiesis trajectory inference example</title>
      <p id="Par117">We obtained post-filtered, post-doublet removal data directly from the authors<sup><xref ref-type="bibr" rid="CR47">47</xref></sup> along with author-defined cell type annotations for 113,063 cells (14 donors) sequenced with 10x 3’ end bias (reference) and a separate 25,367 cells sequenced with 10x 5’ end bias (query). For building the harmonized reference from all reference (3’) cells, we followed the same variable gene selection procedures as the original authors, using the Seurat variance/mean ratio (VMR) method with parameters min_expr = 0.0125, max_expr  = 3, and min_dispersion = 0.625 (resulting in 1917 variable genes). We integrated the reference with Harmony over “donor” (theta = 3). To map query (5’) cells against the reference, we removed two donors (F2 and F5, <inline-formula id="IEq313"><alternatives><tex-math id="M645">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M646"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq313.gif"/></alternatives></inline-formula> = 3953) from the query based on low library complexity (Supplementary Fig. <xref rid="MOESM1" ref-type="media">5b</xref>), leaving <inline-formula id="IEq314"><alternatives><tex-math id="M647">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M648"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq314.gif"/></alternatives></inline-formula> = 21,414 cells from 5 donors. During mapping, we specified both “donor” and “technology” as covariates. We predicted query cell types by transferring reference cell type annotations using the knn function in the “class” R package (<inline-formula id="IEq315"><alternatives><tex-math id="M649">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$k$$\end{document}</tex-math><mml:math id="M650"><mml:mi>k</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq315.gif"/></alternatives></inline-formula> = 30). We visualized the confusion matrix for the query (5’)-to-reference (3’) experiment using the “ComplexHeatmap” R package<sup><xref ref-type="bibr" rid="CR68">68</xref></sup>.</p>
      <p id="Par118">For the trajectory inference analysis, we obtained trajectory coordinates from the force directed graph (FDG) embedding of all reference cells from the original authors<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>, forming a reference trajectory. We restricted the trajectory to immune cell types only (excluding hepatocytes, fibroblasts, and endothelial). We then mapped a subset of the query cells belonging to the MEM lineage (MEMPs, megakaryocytes, mast cells, early-late erythroid; <inline-formula id="IEq316"><alternatives><tex-math id="M651">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M652"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq316.gif"/></alternatives></inline-formula> = 5141) to the reference-defined trajectory by averaging the FDG coordinates of the 10 reference immune cell neighbors in the Symphony embedding.</p>
    </sec>
    <sec id="Sec52">
      <title>Evaluating performance of Symphony mapping metrics</title>
      <sec id="Sec53">
        <title>Simulating missing cell type scenarios in fetal liver hematopoiesis dataset</title>
        <p id="Par119">Using the 3’ fetal liver dataset described above (<inline-formula id="IEq317"><alternatives><tex-math id="M653">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M654"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq317.gif"/></alternatives></inline-formula> = 113,063 cells), we held out one random donor (F8, 16,945 cells) as the query and used the remaining 13 donors as the reference dataset. We constructed 3 increasingly difficult scenarios where the reference is missing cell types present in the query by artificially removing cell types from the reference:<list list-type="order"><list-item><p id="Par120">Removing all non-immune cell types: endothelial cells (<inline-formula id="IEq318"><alternatives><tex-math id="M655">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M656"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq318.gif"/></alternatives></inline-formula> = 321 cells), fibroblasts (<inline-formula id="IEq319"><alternatives><tex-math id="M657">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M658"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq319.gif"/></alternatives></inline-formula> = 361), hepatocytes (<inline-formula id="IEq320"><alternatives><tex-math id="M659">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M660"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq320.gif"/></alternatives></inline-formula> = 306)</p></list-item><list-item><p id="Par121">Removing all myeloid cells: Kupffer cells (<inline-formula id="IEq321"><alternatives><tex-math id="M661">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M662"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq321.gif"/></alternatives></inline-formula> = 6022 cells), Mono-Mac (<inline-formula id="IEq322"><alternatives><tex-math id="M663">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M664"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq322.gif"/></alternatives></inline-formula> = 1035), Monocyte (<inline-formula id="IEq323"><alternatives><tex-math id="M665">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M666"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq323.gif"/></alternatives></inline-formula> = 375), Monocyte precursor (<inline-formula id="IEq324"><alternatives><tex-math id="M667">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M668"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq324.gif"/></alternatives></inline-formula> = 44), DC1 (<inline-formula id="IEq325"><alternatives><tex-math id="M669">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M670"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq325.gif"/></alternatives></inline-formula> = 56), DC2 (<inline-formula id="IEq326"><alternatives><tex-math id="M671">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M672"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq326.gif"/></alternatives></inline-formula> = 292), VCAM1+ EI Macro. (<inline-formula id="IEq327"><alternatives><tex-math id="M673">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M674"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq327.gif"/></alternatives></inline-formula> = 52), Neut-myeloid prog. (<inline-formula id="IEq328"><alternatives><tex-math id="M675">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M676"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq328.gif"/></alternatives></inline-formula> = 91), DC precursor (<inline-formula id="IEq329"><alternatives><tex-math id="M677">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M678"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq329.gif"/></alternatives></inline-formula> = 14), pDC precursor (<inline-formula id="IEq330"><alternatives><tex-math id="M679">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M680"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq330.gif"/></alternatives></inline-formula> = 9)</p></list-item><list-item><p id="Par122">Removing Kupffer cells (<inline-formula id="IEq331"><alternatives><tex-math id="M681">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M682"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq331.gif"/></alternatives></inline-formula> = 6022 cells)</p></list-item></list></p>
        <p id="Par123">For each of the three scenarios, we built a Symphony reference using the same variable gene selection and reference building parameters as in the fetal liver hematopoiesis example, then mapped the query containing all 27 cell types onto the reference. We calculated both per-cell mapping and per-cluster mapping metrics for the query cells. To plot ROC curves and calculate AUC values for each metric, we used the “pROC” R package (roc and auc functions), using a binary label of missing vs. present in the reference as the ground truth for prediction. Note that for the per-cluster metric, the pDC precursor (<inline-formula id="IEq332"><alternatives><tex-math id="M683">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M684"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq332.gif"/></alternatives></inline-formula> = 9 cells), DC precursor (<inline-formula id="IEq333"><alternatives><tex-math id="M685">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M686"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq333.gif"/></alternatives></inline-formula> = 14), and Pre-pro B cell (<inline-formula id="IEq334"><alternatives><tex-math id="M687">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M688"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq334.gif"/></alternatives></inline-formula> = 12) clusters were too small to calculate a per-cluster score and were assigned a value of 0 for the per-cluster metric in all scenarios (unable to be flagged as novel) for inclusion in AUC calculations.</p>
      </sec>
      <sec id="Sec54">
        <title>Comparison of Symphony mapping metrics to Seurat mapping score</title>
        <p id="Par124">Using the 10x PBMCs dataset described above, we designated the 3’v2 and 5’ data as the reference and held out the 3’v1 data as a query. For each of the major cell types (B, DC, HSC, MK, Mono, NK, or T), we artificially removed all reference cells of that type and built a Symphony reference with that type missing (total 7 references/scenarios). We used the same reference building parameters as the original 10x PBMCs analysis. We then mapped all query cells onto each reference, simulating seven scenarios where the query contains a different novel unseen population, and calculated Symphony per-cell and per-cluster mapping metrics for the query cells in each scenario.</p>
        <p id="Par125">For each scenario, we also built a reference using Seurat (v4.0.2), integrating the reference dataset with FindIntegrationAnchors with 20 dimensions and mapping the query with FindTransferAnchors and MapQuery. We calculated query mapping scores with the MappingScore function. The Seurat mapping score is based on projecting the query into the reference space, then projecting back into the query and finding cells whose local neighborhoods are most altered by the transformation (see <ext-link ext-link-type="uri" xlink:href="https://rdrr.io/cran/Seurat/man/MappingScore.html">https://rdrr.io/cran/Seurat/man/MappingScore.html</ext-link>).</p>
        <p id="Par126">We generated ROC curves and calculated AUCs across all query cells, using a binary label of missing vs. present in the reference as the ground truth for prediction. For the Symphony per-cell metric and Seurat mapping score, each query cell was assigned its own value for the mapping metric, whereas for the Symphony per-cluster metric, all cells from the same cluster were assigned the same value. The HSC cluster (<inline-formula id="IEq335"><alternatives><tex-math id="M689">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M690"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq335.gif"/></alternatives></inline-formula> = 21 cells) was too small to calculate a per-cluster score and all HSCs were assigned a value of 0 for the per-cluster metric in all scenarios (unable to be flagged as novel) for inclusion in AUC calculations. We calculated AUCs for each metric in two ways: (1) considering each scenario separately (threshold values independent across scenarios) and (2) aggregating cells across all 7 scenarios together into a single AUC calculation.</p>
      </sec>
    </sec>
    <sec id="Sec55">
      <title>Mapping tumor cells against healthy reference</title>
      <p id="Par127">We mapped a renal cell carcinoma dataset onto a reference of healthy fetal kidney cells (datasets in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>).</p>
    </sec>
    <sec id="Sec56">
      <title>Building the healthy kidney reference</title>
      <p id="Par128">We found that the reference dataset gene names were previously assigned by the original authors using Gencode v24, whereas the query dataset gene names were assigned by the original authors using Gencode v30 liftover37 (query dataset.gtf file was provided by Bi et al.). Gencode.gtf files for versions 4-38 were downloaded from: <ext-link ext-link-type="uri" xlink:href="http://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human">http://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human</ext-link>. For many genes, the names were mismatched between the reference and query Gencode versions (different synonyms for the same gene). Therefore, to sync the two datasets, we used the Ensembl IDs of the reference genes to convert them to Gencode v30 gene names. We used the top 2000 variable genes across all cells to build the reference with 15 PCs, integrating over “Experiment” with theta = 0.5. Note that this reference building procedure is different from the original study<sup><xref ref-type="bibr" rid="CR48">48</xref></sup>, which did not use Harmony. For improved readability, we collapsed cell type labels for immune and stromal cells (e.g., “Proliferating monocyte” and “Monocyte” were collapsed into “Monocyte”).</p>
    </sec>
    <sec id="Sec57">
      <title>Mapping the renal cell carcinoma dataset</title>
      <p id="Par129">We mapped the query dataset (<inline-formula id="IEq336"><alternatives><tex-math id="M691">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M692"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq336.gif"/></alternatives></inline-formula> = 34,326 cells from eight donors) starting from expression using default Symphony parameters, correcting for query “donor_id”. As some gene names remained discordant between reference and query datasets, the mapping was based on the 1723 (out of 2000) reference variable genes shared. We used 10-NN to transfer reference cell type labels to the query. We calculated the per-cell mapping confidence (excluding the “Misc/Undetermined” cells, <inline-formula id="IEq337"><alternatives><tex-math id="M693">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M694"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq337.gif"/></alternatives></inline-formula> = 278).</p>
    </sec>
    <sec id="Sec58">
      <title>Extending Symphony to scATAC-seq</title>
      <p id="Par130">scATAC-seq is different from scRNA-seq in that open chromatin peaks are typically defined in a dataset-specific manner (i.e., rather than a pre-specified list of genes that apply to all datasets). Hence, this proof-of-concept analysis was run on peaks called on all cells as defined by the benchmarking paper by Chen et al.<sup><xref ref-type="bibr" rid="CR52">52</xref></sup>, obtained from the Pinello Lab GitHub: <ext-link ext-link-type="uri" xlink:href="https://github.com/pinellolab/scATAC-benchmarking/blob/master/Real_Data/Buenrostro_2018/input/combined.sorted.merged.bed">https://github.com/pinellolab/scATAC-benchmarking/blob/master/Real_Data/Buenrostro_2018/input/combined.sorted.merged.bed</ext-link>. In this dataset, peaks were called on each cell type aggregated separately then merged. The full peaks by cells matrix was calculated using chromVAR’s getCounts function as demonstrated in their notebook (<ext-link ext-link-type="uri" xlink:href="https://github.com/pinellolab/scATAC-benchmarking/blob/master/Real_Data/Buenrostro_2018/run_methods/chromVAR/chromVAR_buenrostro2018_kmers.ipynb">https://github.com/pinellolab/scATAC-benchmarking/blob/master/Real_Data/Buenrostro_2018/run_methods/chromVAR/chromVAR_buenrostro2018_kmers.ipynb</ext-link>), and subsequently binarized. The cell type information was also gathered from the Pinello Lab GitHub (<ext-link ext-link-type="uri" xlink:href="https://github.com/pinellolab/scATAC-benchmarking/blob/master/Real_Data/Buenrostro_2018/input/metadata.tsv">https://github.com/pinellolab/scATAC-benchmarking/blob/master/Real_Data/Buenrostro_2018/input/metadata.tsv</ext-link>) while the donor information was inferred from the cell name.</p>
      <p id="Par131">We defined the query cells (<inline-formula id="IEq338"><alternatives><tex-math id="M695">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M696"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq338.gif"/></alternatives></inline-formula> = 298) as those that belong to donor BM1214 while the remaining cells (<inline-formula id="IEq339"><alternatives><tex-math id="M697">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M698"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq339.gif"/></alternatives></inline-formula> = 1736) were assigned as reference. BM1214 had cells corresponding to CMPs, GMPs, and pDCs, whose cell types all had cells from other donors also in the reference set. Since scATAC-seq is sparse and zero-inflated, the mean-scaling approach used for genes was changed to TF-IDF normalization on the binarized peaks by cells matrices. Seurat’s TF-IDF function was modified to allow for an IDF vector as input and outputted the TF matrix, IDF vector, and normalized peaks by cells matrix. Following the TF-IDF implementation in Stuart &amp; Butler et al.<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>, we computed log(TFxIDF). The inverse-document frequency (IDF) vector was calculated on the reference cells only and then used in the query cell normalization to get all the cells in the same space before mapping. With only this change to the Symphony methods, scATAC-seq query cells were mapped to a comparable reference. Feature selection, SVD, and Harmony were done as in the 10x PBMC analysis. Predicted query cell types were calculated using 5-NN. For plotting, we used the same cell type colors primarily defined from the Supplemental Data Table <xref rid="MOESM1" ref-type="media">1</xref> of the original Buenrostro et al. (2018) paper with GMPs changed to a darker orange to better distinguish them visually from the CMPs and the “unknown” cells changed from gray to black, allowing gray to be used as the null color to better emphasize the other cell type colors.</p>
    </sec>
    <sec id="Sec59">
      <title>Memory T-cell surface protein inference example</title>
      <p id="Par132">We used a memory T-cell CITE-seq dataset collected from a tuberculosis disease progression cohort of 259 individuals of admixed Peruvian ancestry<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>. The dataset includes expression of the whole-transcriptome (33,538 genes) and 30 surface protein markers from 500,089 memory T cells isolated from PBMCs. Including technical replicates, 271 samples were processed across 46 batches.</p>
      <p id="Par133">To assess protein prediction accuracy using Symphony embeddings, we randomly selected 217 samples (411,004 cells), normalized the expression of each gene (log2(CP10K+1)) and built a Symphony reference based on mRNA expression, correcting for donor and batch. The held-out 54 samples (<inline-formula id="IEq340"><alternatives><tex-math id="M699">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M700"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq340.gif"/></alternatives></inline-formula> = 89,085 cells) comprised the query that we mapped onto the reference. We predicted the expression of each of the 30 surface proteins in each of the query cells by averaging the protein’s expression across the cell’s 50 nearest reference neighbors. Nearest neighbors were defined based on Euclidean distance in the batch-corrected low-dimensional embedding. As a ground truth for each protein in each query cell, we computed a smoothed estimate of the cells’ measured protein expression by averaging the protein’s expression across the cell’s 50 nearest neighbors in the batch-corrected complete PCA embedding of all 259 donors. We did not use the cells’ raw measured protein expression due to dropout. We computed the Pearson correlation coefficient between our predicted expression and the ground truth expression across all cells per donor for each marker.</p>
      <p id="Par134">To assess protein prediction accuracy based on mapping to a joint mRNA and protein-based Symphony reference, we first built an integrated reference by using canonical correlation analysis (CCA) to project cells into a low-dimensional embedding maximizing correlation between mRNA and protein features. We randomly selected 217 samples (395,373 cells) to comprise this reference, and normalized the expression of each gene (log2(CP10K + 1)), selected the top 2865 most variable genes, and scaled (mean = 0, variance = 1) all mRNA and protein features. We computed 20 canonical variates (CVs) with the cc function in the “CCA” R package<sup><xref ref-type="bibr" rid="CR69">69</xref></sup> and corrected the mRNA CVs for donor and batch effects with Harmony. Then, we used Symphony to construct a reference based on the batch-corrected CVs, gene loadings on each CV, and mean and standard deviation used to scale each gene prior to CCA. The held-out 54 samples (<inline-formula id="IEq341"><alternatives><tex-math id="M701">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$n$$\end{document}</tex-math><mml:math id="M702"><mml:mi>n</mml:mi></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq341.gif"/></alternatives></inline-formula> = 104,716 cells) comprised the query that we mapped onto the reference. As described above, we predicted the expression of each of the 30 surface proteins in each of the query cells based on the cell’s 5, 10, or 50 nearest neighbors in the reference, estimated the smoothed ground truth expression of each protein in each query cell (now based on the batch-corrected CCA embedding of all 259 donors) and computed the per-donor Pearson correlation coefficient for each protein marker.</p>
    </sec>
    <sec id="Sec60">
      <title>Visualization</title>
      <p id="Par135">For visualizing the embeddings using UMAP<sup><xref ref-type="bibr" rid="CR70">70</xref></sup> (and included as the default in Symphony), we used the “uwot” R package with the following parameters: n_neighbors = 30, learning_rate = 0.5, init = “laplacian”, metric = “cosine”, and min_dist = 0.1 or 0.3. For each Symphony reference, we saved the uwot model at the time of UMAP using the uwot::save_uwot function and saved the path to the model file as part of the Symphony reference object. Saving the reference UMAP model allows for the fast projection of new query cells into reference UMAP space from the query embedding from Symphony mapping using the uwot::transform function.</p>
      <p id="Par136">For the pancreas benchmarking, we computed a de novo UMAP embedding on the joint reference and query embedding because a UMAP projection can potentially obscure differences between the projected data and dataset used to construct the UMAP model. For general purposes, we recommend UMAP projection when the reference cell UMAP coordinates are desired to remain stable.</p>
      <p id="Par137">To distinguish the reference plots from query plots, we visually present the reference embedding as a contour density instead of individual cells. The density plots were generated using “ggplot2” function stat_density_2d with geom = “polygon” and contour_var = “ndensity”. We provide a custom function to generate these plots as part of the Symphony package (plotReference function).</p>
    </sec>
    <sec id="Sec61">
      <title>Runtime scalability analysis</title>
      <p id="Par138">We downsampled a large memory T-cell dataset<sup><xref ref-type="bibr" rid="CR40">40</xref></sup> to create benchmark reference datasets with 20,000, 50,000, 100,000, 250,000, and 500,000 cells. For each, we built a Symphony reference (20 PCs, 100 centroids) integrating over “donor” and mapped three different-sized queries: 1000, 10,000, and 100,000 cells. To isolate the separate effects of number of query cells and number of query batches on mapping time, we mapped against the 50,000-cell reference: (1) varying the number of query cells (from 1000 to 10,000 cells) while keeping the number of donors constant and (2) varying the number of query donors (6 to 120 donors) while keeping the number of cells constant (randomly sampling 10,000 cells). We also performed separate experiments varying the number of reference centroids (25 to 400) and number of dimensions (10 to 320 PCs) while keeping all other parameters constant. We ran all jobs on Linux servers allotted 4 cores and 64 GB of memory (Intel Xeon E5-2690 v.3 processors) and used the system.time R function to measure elapsed time.</p>
      <p id="Par139">To compare runtime against Seurat and scArches, we used the same different-sized benchmark datasets and ran reference building and mapping or the corresponding de novo integration method (anchor-based integration for Seurat or trVAE for scArches). All jobs were allocated a maximum of 120 GB of memory and 24 h of runtime (and automatically terminated if memory or runtime were exceeded). We measured reference building and mapping runtime and corresponding de novo integration runtime for each method as elapsed time starting from gene expression. All jobs were run on a Linux server: Symphony and Seurat were allotted 4 CPU cores each, whereas scArches/trVAE was allotted 48 CPU cores to speed up runtime as it is a neural-net-based method.</p>
    </sec>
    <sec id="Sec62">
      <title>Constructing and mapping to multimillion cell atlas</title>
      <p id="Par140">We obtained the AnnData file for the dataset (GSE158055_covid19.h5ad) from <ext-link ext-link-type="uri" xlink:href="https://drive.google.com/file/d/1TXDJqOvFkJxbcm2u2-_bM5RBdTOqv56w/view">https://drive.google.com/file/d/1TXDJqOvFkJxbcm2u2-_bM5RBdTOqv56w/view</ext-link>. The link to the AnnData object was obtained from the following GitHub issue (response from user saketkc): <ext-link ext-link-type="uri" xlink:href="https://github.com/satijalab/seurat/issues/4030">https://github.com/satijalab/seurat/issues/4030</ext-link>. Owing to a limitation on the 32-bit sparse matrices in R (the maximum number of non-zero values in a sparse matrix currently cannot exceed <inline-formula id="IEq342"><alternatives><tex-math id="M703">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ &gt; {2}^{31}-1$$\end{document}</tex-math><mml:math id="M704"><mml:mo>&gt;</mml:mo><mml:msup><mml:mrow><mml:mn>2</mml:mn></mml:mrow><mml:mrow><mml:mn>31</mml:mn></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:math><inline-graphic xlink:href="41467_2021_25957_Article_IEq342.gif"/></alternatives></inline-formula> for the “Matrix” R package), the gene expression matrix (1,462,702 cells by 27,943 genes) was preprocessed using the Python “scanpy” package. We log(CP10k + 1) normalized the data and subset to 1301 variable genes (list of variable genes was obtained from contacting the original authors). The remainder of the analysis was performed in R (v4.0). We held out a random 5% of samples (14 samples, 72,781 cells) as the query and built a Symphony reference using the other 95% of samples (270 samples, 1,389,921 cells), integrating over “Sample.name” and “dataset” with theta = 2.5 and 1.5, respectively, following the original publication. Reference building and mapping procedures were run on a Linux cluster with 4 cores and timed using the system.time function in R. UMAP steps were excluded from runtime as these are not inherent to the Symphony algorithm.</p>
    </sec>
    <sec id="Sec63">
      <title>Building Tabula Muris Senis (FACS) Symphony reference</title>
      <p id="Par141">As a comprehensive mouse atlas, we built a Symphony reference using the Tabula Muris Senis dataset (not directly featured in the paper but included as a pre-built reference on Zenodo). We downloaded the FACS.h5ad file provided by the original authors on Figshare (see Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>). We extracted the expression matrix (counts), metadata, and highly variable genes using Python then read the data into R. For reference building, we used log(CP10k + 1) normalization, subset by the same variable genes as the original authors, then ran PCA and Harmony with 50 dimensions, nclust = 300, integrating over “mouse.id” with theta = 2.</p>
    </sec>
    <sec id="Sec64">
      <title>Reporting summary</title>
      <p id="Par142">Further information on research design is available in the <xref rid="MOESM3" ref-type="media">Nature Research Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec65">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41467_2021_25957_MOESM1_ESM.pdf">
            <caption>
              <p>Supplementary Information</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="41467_2021_25957_MOESM2_ESM.pdf">
            <caption>
              <p>Peer Review File</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="41467_2021_25957_MOESM3_ESM.pdf">
            <caption>
              <p>Reporting Summary</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p><bold>Peer review information</bold><italic>Nature Communications</italic> thanks Tim Stuart and the other, anonymous, reviewer(s) for their contribution to the peer review of this work. Peer reviewer reports are available.</p>
    </fn>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
    <fn>
      <p>These authors contributed equally: Ilya Korsunsky, Soumya Raychaudhuri.</p>
    </fn>
  </fn-group>
  <sec>
    <title>Supplementary information</title>
    <p>The online version contains supplementary material available at 10.1038/s41467-021-25957-x.</p>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank members of the Raychaudhuri Lab, in particular Yang Luo, for helpful feedback, comments, and fruitful discussion. We thank members of the Tuberculosis Research Unit (TBRU) LIMAA and Socios En Salud, in particular Megan Murray, Jessica Beynor, Yuriy Baglaenko, Sara Suliman, Ildiko van Rhijn, and Leonid Lecca, for their contributions to generating the memory T-cell dataset. We would also like to thank Issac Goh, Muzlifah Haniffa, and other members of the Haniffa Lab for graciously providing preprocessed datasets from their fetal liver hematopoiesis study. Additionally, we would like thank Ahmed Mahfouz, Kevin Bi and colleagues of the Van Allen Lab, Wenhong Hou, and Zemin Zhang for their kind assistance regarding their published datasets. We thank Jason Ku Wang for technical assistance. This work is supported in part by funding from the National Institutes of Health (1UH2AR067677, U19 AI111224, U01 HG009379, 1R01AR073833, and R01AR063759). The project described was supported by award Numbers T32GM007753 from the National Institute of General Medical Sciences (J.B.K.), T32AR007530 from the National Institute of Arthritis and Musculoskeletal and Skin Diseases (A.N.), and 5T32HG002295-17 from the National Human Genome Research Institute (K.W.). The content is solely the responsibility of the authors and does not necessarily represent the official views of the National Institutes of Health.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>J.B.K., I.K., and S.R. conceived the project. J.B.K. and I.K. designed and implemented the method under the guidance of S.R. J.B.K, I.K., K.W., F.Z., and A.N. contributed to the analysis of real datasets. S.R., N.M., and L.R. helped interpret data and analyses. S.R., A.N., and D.B.M. contributed to generating the memory T-cell CITE-seq dataset. I.K. and S.R. jointly supervised the work. J.B.K., I.K., and S.R. composed the initial manuscript draft. All authors provided critical intellectual feedback and participated in interpreting the data and revising the manuscript.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>Datasets for all analyses were obtained from publicly available sources, for which the specific links are listed in Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>. Additionally, we provide a compendium of 8 pre-built Symphony references available for download on Zenodo (see Table <xref rid="Tab1" ref-type="table">1</xref> for links). The 10x PBMCs data matrices were obtained from Korsunsky et al.<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>: <ext-link ext-link-type="uri" xlink:href="https://github.com/immunogenomics/harmony2019/tree/master/data/figure4">https://github.com/immunogenomics/harmony2019/tree/master/data/figure4</ext-link>; original files from 10x Genomics: <ext-link ext-link-type="uri" xlink:href="https://support.10xgenomics.com/single-cell-gene-expression/datasets">https://support.10xgenomics.com/single-cell-gene-expression/datasets</ext-link>. The pancreas reference data matrices were obtained from Korsunsky et al.<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>: <ext-link ext-link-type="uri" xlink:href="https://github.com/immunogenomics/harmony2019/tree/master/data/figure5">https://github.com/immunogenomics/harmony2019/tree/master/data/figure5</ext-link>; original data is located on GEO (GSE81076<sup><xref ref-type="bibr" rid="CR44">44</xref></sup>, GSE85241<sup><xref ref-type="bibr" rid="CR45">45</xref></sup>, GSE86469<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>) and EMBL-EBI (E-MTAB-5061<sup><xref ref-type="bibr" rid="CR42">42</xref></sup>). The human and mouse pancreas query data (Baron et al., 2016)<sup><xref ref-type="bibr" rid="CR46">46</xref></sup> was downloaded from <ext-link ext-link-type="uri" xlink:href="https://hemberg-lab.github.io/scRNA.seq.datasets/human/pancreas">https://hemberg-lab.github.io/scRNA.seq.datasets/human/pancreas</ext-link>. The fetal liver hematopoiesis data from Popescu et al. (2019) is located on EMBL-EBI (E-MTAB-7407<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>), and post-doublet removal data was kindly provided by the authors. The PbmcBench data were obtained from the Zenodo repository for Abdelaal et al.<sup><xref ref-type="bibr" rid="CR35">35</xref></sup>: <ext-link ext-link-type="uri" xlink:href="https://zenodo.org/record/3357167#.YSL8p9NKhTY">https://zenodo.org/record/3357167#.YSL8p9NKhTY</ext-link>. The memory T-cell CITE-seq dataset from Nathan et al.<sup><xref ref-type="bibr" rid="CR40">40</xref></sup> is available on GEO (GSE158769). The healthy fetal kidney data (Stewart et al., 2019)<sup><xref ref-type="bibr" rid="CR48">48</xref></sup> was obtained from <ext-link ext-link-type="uri" xlink:href="https://www.kidneycellatlas.org/">https://www.kidneycellatlas.org/</ext-link>. The renal cell carcinoma data (Bi et al.)<sup><xref ref-type="bibr" rid="CR49">49</xref></sup> was obtained from the Broad Institute Single-Cell Portal (SCP1288). The 1.46 million cell COVID-19 dataset (Ren et al.)<sup><xref ref-type="bibr" rid="CR41">41</xref></sup> is available on GEO (GSE158055), and.h5ad file was obtained from <ext-link ext-link-type="uri" xlink:href="https://drive.google.com/file/d/1TXDJqOvFkJxbcm2u2-_bM5RBdTOqv56w/view">https://drive.google.com/file/d/1TXDJqOvFkJxbcm2u2-_bM5RBdTOqv56w/view</ext-link>. The scATAC-seq hematopoiesis dataset (Buenrostro et al.)<sup><xref ref-type="bibr" rid="CR51">51</xref></sup> was downloaded from the Pinello Lab GitHub: <ext-link ext-link-type="uri" xlink:href="https://github.com/pinellolab/scATAC-benchmarking/blob/master/Real_Data/Buenrostro_2018/input/combined.sorted.merged.bed">https://github.com/pinellolab/scATAC-benchmarking/blob/master/Real_Data/Buenrostro_2018/input/combined.sorted.merged.bed</ext-link>. Gencode.gtf files for versions 4-38 (used for determining gene name synonyms in cancer analysis) were downloaded from: <ext-link ext-link-type="uri" xlink:href="http://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human">http://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human</ext-link>.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>We provide an efficient implementation of Symphony at <ext-link ext-link-type="uri" xlink:href="https://github.com/immunogenomics/symphony">https://github.com/immunogenomics/symphony</ext-link> along with documentation, tutorials, and pre-built references. Symphony is also available for download as an R package on CRAN: <ext-link ext-link-type="uri" xlink:href="https://cran.r-project.org/web/packages/symphony/index.html">https://cran.r-project.org/web/packages/symphony/index.html</ext-link>. The version of Symphony code used for the study is CRAN version 0.1.0. Jupyter notebooks and scripts to reproduce figures for the analyses in the manuscript are available at <ext-link ext-link-type="uri" xlink:href="https://github.com/immunogenomics/symphony_reproducibility">https://github.com/immunogenomics/symphony_reproducibility</ext-link>.</p>
  </notes>
  <notes id="FPar3" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par143">S.R. receives research support from Biogen. I.K. does bioinformatics consulting for Brilyant Inc. No other authors have competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <mixed-citation publication-type="other">Klein, A. M. &amp; Treutlein, B. Single cell analyses of development in the modern era. <italic>Development</italic><bold>146</bold>, dev181396 (2019).</mixed-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <mixed-citation publication-type="other">Han, X. et al. Construction of a human cell landscape at single-cell level. <italic>Nature</italic>10.1038/s41586-020-2157-4 (2020).</mixed-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <mixed-citation publication-type="other">Svensson, V., da Veiga Beltrame, E. &amp; Pachter, L. A curated database reveals trends in single-cell transcriptomics. <italic>Database</italic><bold>2020</bold>, baaa073 (2020).</mixed-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cao</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The single-cell transcriptional landscape of mammalian organogenesis</article-title>
        <source>Nature</source>
        <year>2019</year>
        <volume>566</volume>
        <fpage>496</fpage>
        <lpage>502</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-019-0969-x</pub-id>
        <?supplied-pmid 30787437?>
        <pub-id pub-id-type="pmid">30787437</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <mixed-citation publication-type="other">Jerber, J. et al. Population-scale single-cell RNA-seq profiling across dopaminergic neuron differentiation. <italic>Nat. Genetics</italic>. <bold>53</bold>, 304–312 (2021).</mixed-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhang</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Defining inflammatory cell states in rheumatoid arthritis joint synovial tissues by integrating single-cell transcriptomics and mass cytometry</article-title>
        <source>Nat. Immunol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>928</fpage>
        <lpage>942</lpage>
        <pub-id pub-id-type="doi">10.1038/s41590-019-0378-1</pub-id>
        <?supplied-pmid 31061532?>
        <pub-id pub-id-type="pmid">31061532</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Reyes</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>An immune-cell signature of bacterial sepsis</article-title>
        <source>Nat. Med.</source>
        <year>2020</year>
        <volume>26</volume>
        <fpage>333</fpage>
        <lpage>340</lpage>
        <pub-id pub-id-type="doi">10.1038/s41591-020-0752-4</pub-id>
        <?supplied-pmid 32066974?>
        <pub-id pub-id-type="pmid">32066974</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kotliarov</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Broad immune activation underlies shared set point signatures for vaccine responsiveness in healthy individuals and disease activity in patients with lupus</article-title>
        <source>Nat. Med.</source>
        <year>2020</year>
        <volume>26</volume>
        <fpage>618</fpage>
        <lpage>629</lpage>
        <pub-id pub-id-type="doi">10.1038/s41591-020-0769-8</pub-id>
        <?supplied-pmid 32094927?>
        <pub-id pub-id-type="pmid">32094927</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schafflick</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Integrated single cell analysis of blood and cerebrospinal fluid leukocytes in multiple sclerosis</article-title>
        <source>Nat. Commun.</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>247</fpage>
        <pub-id pub-id-type="doi">10.1038/s41467-019-14118-w</pub-id>
        <?supplied-pmid 31937773?>
        <pub-id pub-id-type="pmid">31937773</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Smillie</surname>
            <given-names>CS</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Intra- and inter-cellular rewiring of the human colon during ulcerative colitis</article-title>
        <source>Cell</source>
        <year>2019</year>
        <volume>178</volume>
        <fpage>714</fpage>
        <lpage>730.e22</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2019.06.029</pub-id>
        <?supplied-pmid 31348891?>
        <pub-id pub-id-type="pmid">31348891</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <mixed-citation publication-type="other">Litviňuková, M. et al. Cells of the adult human heart. <italic>Nature</italic>10.1038/s41586-020-2797-4 (2020).</mixed-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rozenblatt-Rosen</surname>
            <given-names>O</given-names>
          </name>
          <name>
            <surname>Stubbington</surname>
            <given-names>MJT</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Teichmann</surname>
            <given-names>SA</given-names>
          </name>
        </person-group>
        <article-title>The Human Cell Atlas: from vision to reality</article-title>
        <source>Nature</source>
        <year>2017</year>
        <volume>550</volume>
        <fpage>451</fpage>
        <lpage>453</lpage>
        <pub-id pub-id-type="doi">10.1038/550451a</pub-id>
        <?supplied-pmid 29072289?>
        <pub-id pub-id-type="pmid">29072289</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Haghverdi</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Lun</surname>
            <given-names>ATL</given-names>
          </name>
          <name>
            <surname>Morgan</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>Marioni</surname>
            <given-names>JC</given-names>
          </name>
        </person-group>
        <article-title>Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2018</year>
        <volume>36</volume>
        <fpage>421</fpage>
        <lpage>427</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.4091</pub-id>
        <?supplied-pmid 29608177?>
        <pub-id pub-id-type="pmid">29608177</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hie</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Bryson</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Berger</surname>
            <given-names>B</given-names>
          </name>
        </person-group>
        <article-title>Efficient integration of heterogeneous single-cell transcriptomes using Scanorama</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2019</year>
        <volume>37</volume>
        <fpage>685</fpage>
        <lpage>691</lpage>
        <pub-id pub-id-type="doi">10.1038/s41587-019-0113-3</pub-id>
        <?supplied-pmid 31061482?>
        <pub-id pub-id-type="pmid">31061482</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Welch</surname>
            <given-names>JD</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell multi-omic integration compares and contrasts features of brain cell identity</article-title>
        <source>Cell</source>
        <year>2019</year>
        <volume>177</volume>
        <fpage>1873</fpage>
        <lpage>1887.e17</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2019.05.006</pub-id>
        <?supplied-pmid 31178122?>
        <pub-id pub-id-type="pmid">31178122</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lopez</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Regier</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Cole</surname>
            <given-names>MB</given-names>
          </name>
          <name>
            <surname>Jordan</surname>
            <given-names>MI</given-names>
          </name>
          <name>
            <surname>Yosef</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Deep generative modeling for single-cell transcriptomics</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>1053</fpage>
        <lpage>1058</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-018-0229-2</pub-id>
        <?supplied-pmid 30504886?>
        <pub-id pub-id-type="pmid">30504886</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Korsunsky</surname>
            <given-names>I</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Fast, sensitive and accurate integration of single-cell data with Harmony</article-title>
        <source>Nat. Methods</source>
        <year>2019</year>
        <volume>16</volume>
        <fpage>1289</fpage>
        <lpage>1296</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0619-0</pub-id>
        <?supplied-pmid 31740819?>
        <pub-id pub-id-type="pmid">31740819</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stuart</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Comprehensive integration of single-cell data</article-title>
        <source>Cell Data. Cell</source>
        <year>2019</year>
        <volume>177</volume>
        <fpage>1888</fpage>
        <lpage>1902.e21</lpage>
        <?supplied-pmid 31178118?>
        <pub-id pub-id-type="pmid">31178118</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>He</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Brazovskaja</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Ebert</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Camp</surname>
            <given-names>JG</given-names>
          </name>
          <name>
            <surname>Treutlein</surname>
            <given-names>B</given-names>
          </name>
        </person-group>
        <article-title>CSS: cluster similarity spectrum integration of single-cell genomics data</article-title>
        <source>Genome Biol.</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>224</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-020-02147-4</pub-id>
        <?supplied-pmid 32867824?>
        <pub-id pub-id-type="pmid">32867824</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tran</surname>
            <given-names>HTN</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A benchmark of batch-effect correction methods for single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>12</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1850-9</pub-id>
        <?supplied-pmid 31948481?>
        <pub-id pub-id-type="pmid">31948481</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhang</surname>
            <given-names>Q</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Landscape and dynamics of single immune cells in hepatocellular carcinoma</article-title>
        <source>Cell</source>
        <year>2019</year>
        <volume>179</volume>
        <fpage>829</fpage>
        <lpage>845.e20</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2019.10.003</pub-id>
        <?supplied-pmid 31675496?>
        <pub-id pub-id-type="pmid">31675496</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wei</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Notch signalling drives synovial fibroblast identity and arthritis pathology</article-title>
        <source>Nature</source>
        <year>2020</year>
        <volume>582</volume>
        <fpage>259</fpage>
        <lpage>264</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-020-2222-z</pub-id>
        <?supplied-pmid 32499639?>
        <pub-id pub-id-type="pmid">32499639</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kirita</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Wu</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Uchimura</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Wilson</surname>
            <given-names>PC</given-names>
          </name>
          <name>
            <surname>Humphreys</surname>
            <given-names>BD</given-names>
          </name>
        </person-group>
        <article-title>Cell profiling of mouse acute kidney injury reveals conserved cellular responses to injury</article-title>
        <source>Proc. Natl Acad. Sci. U.S.A.</source>
        <year>2020</year>
        <volume>117</volume>
        <fpage>15874</fpage>
        <lpage>15883</lpage>
        <pub-id pub-id-type="doi">10.1073/pnas.2005477117</pub-id>
        <?supplied-pmid 32571916?>
        <pub-id pub-id-type="pmid">32571916</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sandu</surname>
            <given-names>I</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Landscape of exhausted virus-specific CD8 T cells in chronic LCMV infection</article-title>
        <source>Cell Rep.</source>
        <year>2020</year>
        <volume>32</volume>
        <fpage>108078</fpage>
        <pub-id pub-id-type="doi">10.1016/j.celrep.2020.108078</pub-id>
        <?supplied-pmid 32846135?>
        <pub-id pub-id-type="pmid">32846135</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <mixed-citation publication-type="other">Korsunsky, I. et al. Cross-tissue, single-cell stromal atlas identifies shared pathological fibroblast phenotypes in four chronic inflammatory diseases. Preprint at <italic>bioRxiv</italic>10.1101/2021.01.11.426253 (2021).</mixed-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhang</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>IFN-γ and TNF-α drive a CXCL10+ CCL2+ macrophage phenotype expanded in severe COVID-19 lungs and inflammatory diseases with tissue inflammation</article-title>
        <source>Genome Med.</source>
        <year>2021</year>
        <volume>13</volume>
        <fpage>64</fpage>
        <pub-id pub-id-type="doi">10.1186/s13073-021-00881-3</pub-id>
        <?supplied-pmid 33879239?>
        <pub-id pub-id-type="pmid">33879239</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lähnemann</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Eleven grand challenges in single-cell data science</article-title>
        <source>Genome Biol.</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>31</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-020-1926-6</pub-id>
        <?supplied-pmid 32033589?>
        <pub-id pub-id-type="pmid">32033589</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <mixed-citation publication-type="other">Lotfollahi, M. et al. Mapping single-cell data to reference atlases by transfer learning. <italic>Nat Biotechnol</italic> (2021).</mixed-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cao</surname>
            <given-names>Z-J</given-names>
          </name>
          <name>
            <surname>Wei</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Lu</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>D-C</given-names>
          </name>
          <name>
            <surname>Gao</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Searching large-scale scRNA-seq databases via unbiased cell embedding with Cell BLAST</article-title>
        <source>Nat. Commun.</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>3458</fpage>
        <pub-id pub-id-type="doi">10.1038/s41467-020-17281-7</pub-id>
        <?supplied-pmid 32651388?>
        <pub-id pub-id-type="pmid">32651388</pub-id>
      </element-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <mixed-citation publication-type="other">Hao, Y. et al. Integrated analysis of multimodal single-cell data. <italic>Cell</italic><bold>2020</bold>, 10.12.335331 (2021).</mixed-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kiselev</surname>
            <given-names>VY</given-names>
          </name>
          <name>
            <surname>Yiu</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Hemberg</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>scmap: projection of single-cell RNA-seq data across data sets</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>359</fpage>
        <lpage>362</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4644</pub-id>
        <?supplied-pmid 29608555?>
        <pub-id pub-id-type="pmid">29608555</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Xu</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Probabilistic harmonization and annotation of single-cell transcriptomics data with deep generative models</article-title>
        <source>Mol. Syst. Biol.</source>
        <year>2021</year>
        <volume>17</volume>
        <fpage>e9620</fpage>
        <pub-id pub-id-type="doi">10.15252/msb.20209620</pub-id>
        <?supplied-pmid 33491336?>
        <pub-id pub-id-type="pmid">33491336</pub-id>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lotfollahi</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Naghipourfar</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
        </person-group>
        <article-title>Conditional out-of-distribution generation for unpaired data using transfer VAE</article-title>
        <source>Bioinformatics</source>
        <year>2020</year>
        <volume>36</volume>
        <fpage>i610</fpage>
        <lpage>i617</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btaa800</pub-id>
        <?supplied-pmid 33381839?>
        <pub-id pub-id-type="pmid">33381839</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Polański</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>BBKNN: fast batch alignment of single cell transcriptomes</article-title>
        <source>Bioinformatics</source>
        <year>2020</year>
        <volume>36</volume>
        <fpage>964</fpage>
        <lpage>965</lpage>
        <?supplied-pmid 31400197?>
        <pub-id pub-id-type="pmid">31400197</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Abdelaal</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A comparison of automatic cell identification methods for single-cell RNA sequencing data</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>194</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1795-z</pub-id>
        <?supplied-pmid 31500660?>
        <pub-id pub-id-type="pmid">31500660</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <mixed-citation publication-type="other">Zhang, Z. et al. SCINA: a semi-supervised subtyping algorithm of single cells and bulk samples. <italic>Genes</italic><bold>10</bold>, 531 (2019).</mixed-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Alquicira-Hernandez</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Sathe</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Ji</surname>
            <given-names>HP</given-names>
          </name>
          <name>
            <surname>Nguyen</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Powell</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>E. scPred: accurate supervised method for cell-type classification from single-cell RNA-seq data</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>264</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1862-5</pub-id>
        <?supplied-pmid 31829268?>
        <pub-id pub-id-type="pmid">31829268</pub-id>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tan</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Cahan</surname>
            <given-names>P</given-names>
          </name>
        </person-group>
        <article-title>SingleCellNet: a computational tool to classify single cell RNA-seq data across platforms and across species</article-title>
        <source>Cell Syst.</source>
        <year>2019</year>
        <volume>9</volume>
        <fpage>207</fpage>
        <lpage>213.e2</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2019.06.004</pub-id>
        <?supplied-pmid 31377170?>
        <pub-id pub-id-type="pmid">31377170</pub-id>
      </element-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <mixed-citation publication-type="other">Ding, J. et al. Systematic comparative analysis of single cell RNA-sequencing methods. <italic>Nat. Biotechnol</italic>. <bold>38</bold>, 737–746 (2020).</mixed-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Nathan</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Multimodally profiling memory T cells from a tuberculosis cohort identifies cell state associations with demographics, environment and disease</article-title>
        <source>Nat. Immunol.</source>
        <year>2021</year>
        <volume>22</volume>
        <fpage>781</fpage>
        <lpage>793</lpage>
        <pub-id pub-id-type="doi">10.1038/s41590-021-00933-1</pub-id>
        <?supplied-pmid 34031617?>
        <pub-id pub-id-type="pmid">34031617</pub-id>
      </element-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ren</surname>
            <given-names>X</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>COVID-19 immune features revealed by a large-scale single-cell transcriptome atlas</article-title>
        <source>Cell</source>
        <year>2021</year>
        <volume>184</volume>
        <fpage>1895</fpage>
        <lpage>1913.e19</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2021.01.053</pub-id>
        <?supplied-pmid 33657410?>
        <pub-id pub-id-type="pmid">33657410</pub-id>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Segerstolpe</surname>
            <given-names>Å</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell transcriptome profiling of human pancreatic islets in health and Type 2 diabetes</article-title>
        <source>Cell Metab.</source>
        <year>2016</year>
        <volume>24</volume>
        <fpage>593</fpage>
        <lpage>607</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cmet.2016.08.020</pub-id>
        <?supplied-pmid 27667667?>
        <pub-id pub-id-type="pmid">27667667</pub-id>
      </element-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lawlor</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell transcriptomes identify human islet cell signatures and reveal cell-type-specific expression changes in type 2 diabetes</article-title>
        <source>Genome Res.</source>
        <year>2017</year>
        <volume>27</volume>
        <fpage>208</fpage>
        <lpage>222</lpage>
        <pub-id pub-id-type="doi">10.1101/gr.212720.116</pub-id>
        <?supplied-pmid 27864352?>
        <pub-id pub-id-type="pmid">27864352</pub-id>
      </element-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Grün</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>De novo prediction of stem cell identity using single-cell transcriptome data</article-title>
        <source>Cell Stem Cell</source>
        <year>2016</year>
        <volume>19</volume>
        <fpage>266</fpage>
        <lpage>277</lpage>
        <pub-id pub-id-type="doi">10.1016/j.stem.2016.05.010</pub-id>
        <?supplied-pmid 27345837?>
        <pub-id pub-id-type="pmid">27345837</pub-id>
      </element-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Muraro</surname>
            <given-names>MJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A single-cell transcriptome atlas of the human pancreas</article-title>
        <source>Cell Syst.</source>
        <year>2016</year>
        <volume>3</volume>
        <fpage>385</fpage>
        <lpage>394.e3</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2016.09.002</pub-id>
        <?supplied-pmid 27693023?>
        <pub-id pub-id-type="pmid">27693023</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Baron</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A single-cell transcriptomic map of the human and mouse pancreas reveals inter- and intra-cell population structure</article-title>
        <source>Cell Syst.</source>
        <year>2016</year>
        <volume>3</volume>
        <fpage>346</fpage>
        <lpage>360.e4</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2016.08.011</pub-id>
        <?supplied-pmid 27667365?>
        <pub-id pub-id-type="pmid">27667365</pub-id>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Popescu</surname>
            <given-names>D-M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Decoding human fetal liver haematopoiesis</article-title>
        <source>Nature</source>
        <year>2019</year>
        <volume>574</volume>
        <fpage>365</fpage>
        <lpage>371</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-019-1652-y</pub-id>
        <?supplied-pmid 31597962?>
        <pub-id pub-id-type="pmid">31597962</pub-id>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stewart</surname>
            <given-names>BJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Spatiotemporal immune zonation of the human kidney</article-title>
        <source>Science</source>
        <year>2019</year>
        <volume>365</volume>
        <fpage>1461</fpage>
        <lpage>1466</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aat5031</pub-id>
        <?supplied-pmid 31604275?>
        <pub-id pub-id-type="pmid">31604275</pub-id>
      </element-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bi</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Tumor and immune reprogramming during immunotherapy in advanced renal cell carcinoma</article-title>
        <source>Cancer Cell</source>
        <year>2021</year>
        <volume>39</volume>
        <fpage>649</fpage>
        <lpage>661.e5</lpage>
        <pub-id pub-id-type="doi">10.1016/j.ccell.2021.02.015</pub-id>
        <?supplied-pmid 33711272?>
        <pub-id pub-id-type="pmid">33711272</pub-id>
      </element-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cairns</surname>
            <given-names>P</given-names>
          </name>
        </person-group>
        <article-title>Renal cell carcinoma</article-title>
        <source>Cancer Biomark.</source>
        <year>2010</year>
        <volume>9</volume>
        <fpage>461</fpage>
        <lpage>473</lpage>
        <pub-id pub-id-type="doi">10.3233/CBM-2011-0176</pub-id>
        <?supplied-pmid 22112490?>
        <pub-id pub-id-type="pmid">22112490</pub-id>
      </element-citation>
    </ref>
    <ref id="CR51">
      <label>51.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Buenrostro</surname>
            <given-names>JD</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Integrated single-cell analysis maps the continuous regulatory landscape of human hematopoietic differentiation</article-title>
        <source>Cell</source>
        <year>2018</year>
        <volume>173</volume>
        <fpage>1535</fpage>
        <lpage>1548.e16</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2018.03.074</pub-id>
        <?supplied-pmid 29706549?>
        <pub-id pub-id-type="pmid">29706549</pub-id>
      </element-citation>
    </ref>
    <ref id="CR52">
      <label>52.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Chen</surname>
            <given-names>H</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Assessment of computational methods for the analysis of single-cell ATAC-seq data</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>241</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1854-5</pub-id>
        <?supplied-pmid 31739806?>
        <pub-id pub-id-type="pmid">31739806</pub-id>
      </element-citation>
    </ref>
    <ref id="CR53">
      <label>53.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stoeckius</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Simultaneous epitope and transcriptome measurement in single cells</article-title>
        <source>Nat. Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>865</fpage>
        <lpage>868</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4380</pub-id>
        <?supplied-pmid 28759029?>
        <pub-id pub-id-type="pmid">28759029</pub-id>
      </element-citation>
    </ref>
    <ref id="CR54">
      <label>54.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Peterson</surname>
            <given-names>VM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Multiplexed quantification of proteins and transcripts in single cells</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2017</year>
        <volume>35</volume>
        <fpage>936</fpage>
        <lpage>939</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.3973</pub-id>
        <?supplied-pmid 28854175?>
        <pub-id pub-id-type="pmid">28854175</pub-id>
      </element-citation>
    </ref>
    <ref id="CR55">
      <label>55.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Luecken</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>Current best practices in single-cell RNA-seq analysis: a tutorial</article-title>
        <source>Mol. Syst. Biol.</source>
        <year>2019</year>
        <volume>15</volume>
        <fpage>e8746</fpage>
        <pub-id pub-id-type="doi">10.15252/msb.20188746</pub-id>
        <?supplied-pmid 31217225?>
        <pub-id pub-id-type="pmid">31217225</pub-id>
      </element-citation>
    </ref>
    <ref id="CR56">
      <label>56.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Berger</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Cho</surname>
            <given-names>H</given-names>
          </name>
        </person-group>
        <article-title>Emerging technologies towards enhancing privacy in genomic data sharing</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>128</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1741-0</pub-id>
        <?supplied-pmid 31262363?>
        <pub-id pub-id-type="pmid">31262363</pub-id>
      </element-citation>
    </ref>
    <ref id="CR57">
      <label>57.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Andreatta</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Interpretation of T cell states from single-cell transcriptomics data using reference atlases</article-title>
        <source>Nat. Commun.</source>
        <year>2021</year>
        <volume>12</volume>
        <fpage>2965</fpage>
        <pub-id pub-id-type="doi">10.1038/s41467-021-23324-4</pub-id>
        <?supplied-pmid 34017005?>
        <pub-id pub-id-type="pmid">34017005</pub-id>
      </element-citation>
    </ref>
    <ref id="CR58">
      <label>58.</label>
      <mixed-citation publication-type="other">Lagattuta, K. A., Kang, J. B., Nathan, A. &amp; Pauken, K. E. Repertoire analyses reveal TCR sequence features that influence T cell fate. Preprint at <italic>bioRxiv</italic>10.1101/2021.06.23.449653 (2021).</mixed-citation>
    </ref>
    <ref id="CR59">
      <label>59.</label>
      <mixed-citation publication-type="other">Reshef, Y., Rumker, L., Kang, J. B., Nathan, A. &amp; Murray, M. B. Axes of inter-sample variability among transcriptional neighborhoods reveal disease-associated cell states in single-cell data. Preprint at <italic>bioRxiv</italic>10.1101/2021.04.19.440534 (2021).</mixed-citation>
    </ref>
    <ref id="CR60">
      <label>60.</label>
      <mixed-citation publication-type="other">Wang, S., Pisco, A. O., Karkanias, J. &amp; Altman, R. B. Unifying single-cell annotations based on the Cell Ontology. Preprint at <italic>bioRxiv</italic>10.1101/810234 (2019).</mixed-citation>
    </ref>
    <ref id="CR61">
      <label>61.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Gayoso</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Joint probabilistic modeling of single-cell multi-omic data with totalVI</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>272</fpage>
        <lpage>282</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-020-01050-x</pub-id>
        <?supplied-pmid 33589839?>
        <pub-id pub-id-type="pmid">33589839</pub-id>
      </element-citation>
    </ref>
    <ref id="CR62">
      <label>62.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <collab>Tabula Muris Consortium.</collab>
        </person-group>
        <article-title>A single-cell transcriptomic atlas characterizes ageing tissues in the mouse</article-title>
        <source>Nature</source>
        <year>2020</year>
        <volume>583</volume>
        <fpage>590</fpage>
        <lpage>595</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-020-2496-1</pub-id>
        <pub-id pub-id-type="pmid">32669714</pub-id>
      </element-citation>
    </ref>
    <ref id="CR63">
      <label>63.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hafemeister</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Normalization and variance stabilization of single-cell RNA-seq data using regularized negative binomial regression</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>296</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1874-1</pub-id>
        <?supplied-pmid 31870423?>
        <pub-id pub-id-type="pmid">31870423</pub-id>
      </element-citation>
    </ref>
    <ref id="CR64">
      <label>64.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Baglama</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Reichel</surname>
            <given-names>L</given-names>
          </name>
        </person-group>
        <article-title>Augmented implicitly restarted lanczos bidiagonalization methods</article-title>
        <source>SIAM J. Sci. Comput.</source>
        <year>2005</year>
        <volume>27</volume>
        <fpage>19</fpage>
        <lpage>42</lpage>
        <pub-id pub-id-type="doi">10.1137/04060593X</pub-id>
      </element-citation>
    </ref>
    <ref id="CR65">
      <label>65.</label>
      <mixed-citation publication-type="other">Korsunsky, I., Nathan, A., Millard, N. &amp; Raychaudhuri, S. Presto scales Wilcoxon and auROC analyses to millions of observations. Preprint at <italic>bioRxiv</italic>10.1101/653253 (2019).</mixed-citation>
    </ref>
    <ref id="CR66">
      <label>66.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Friedman</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Hastie</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Tibshirani</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Regularization paths for generalized linear models via coordinate descent</article-title>
        <source>J. Stat. Softw.</source>
        <year>2010</year>
        <volume>33</volume>
        <fpage>1</fpage>
        <lpage>22</lpage>
        <pub-id pub-id-type="doi">10.18637/jss.v033.i01</pub-id>
        <?supplied-pmid 20808728?>
        <pub-id pub-id-type="pmid">20808728</pub-id>
      </element-citation>
    </ref>
    <ref id="CR67">
      <label>67.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Durinck</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Spellman</surname>
            <given-names>PT</given-names>
          </name>
          <name>
            <surname>Birney</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Huber</surname>
            <given-names>W</given-names>
          </name>
        </person-group>
        <article-title>Mapping identifiers for the integration of genomic datasets with the R/Bioconductor package biomaRt</article-title>
        <source>Nat. Protoc.</source>
        <year>2009</year>
        <volume>4</volume>
        <fpage>1184</fpage>
        <lpage>1191</lpage>
        <pub-id pub-id-type="doi">10.1038/nprot.2009.97</pub-id>
        <?supplied-pmid 19617889?>
        <pub-id pub-id-type="pmid">19617889</pub-id>
      </element-citation>
    </ref>
    <ref id="CR68">
      <label>68.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Gu</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Eils</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Schlesner</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Complex heatmaps reveal patterns and correlations in multidimensional genomic data</article-title>
        <source>Bioinformatics</source>
        <year>2016</year>
        <volume>32</volume>
        <fpage>2847</fpage>
        <lpage>2849</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btw313</pub-id>
        <?supplied-pmid 27207943?>
        <pub-id pub-id-type="pmid">27207943</pub-id>
      </element-citation>
    </ref>
    <ref id="CR69">
      <label>69.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Leurgans</surname>
            <given-names>SE</given-names>
          </name>
          <name>
            <surname>Moyeed</surname>
            <given-names>RA</given-names>
          </name>
          <name>
            <surname>Silverman</surname>
            <given-names>BW</given-names>
          </name>
        </person-group>
        <article-title>Canonical correlation analysis when the data are curves</article-title>
        <source>J. R. Stat. Soc. Ser. B Stat. Methodol.</source>
        <year>1993</year>
        <volume>55</volume>
        <fpage>725</fpage>
        <lpage>740</lpage>
      </element-citation>
    </ref>
    <ref id="CR70">
      <label>70.</label>
      <mixed-citation publication-type="other">McInnes, L., Healy, J. &amp; Melville, J. UMAP: Uniform manifold approximation and projection for dimension reduction. Preprint at <ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1802.03426">https://arxiv.org/abs/1802.03426</ext-link> (2018).</mixed-citation>
    </ref>
  </ref-list>
</back>
