<?all-math-mml yes?>
<?use-mml?>
<?properties open_access?>
<?properties manuscript?>
<?origin nihpa?>
<?iso-abbr Nat. Methods?>
<?submitter-system nihms?>
<?submitter-canonical-name Nature Publishing Group?>
<?submitter-canonical-id NATURE-STRUCTUR?>
<?submitter-userid 8068858?>
<?submitter-authority myNCBI?>
<?submitter-login nature-structure?>
<?submitter-name Nature Publishing Group?>
<?domain nihpa?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-journal-id">101215604</journal-id>
    <journal-id journal-id-type="pubmed-jr-id">32338</journal-id>
    <journal-id journal-id-type="nlm-ta">Nat Methods</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat. Methods</journal-id>
    <journal-title-group>
      <journal-title>Nature methods</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1548-7091</issn>
    <issn pub-type="epub">1548-7105</issn>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">6235447</article-id>
    <article-id pub-id-type="pmid">30377376</article-id>
    <article-id pub-id-type="doi">10.1038/s41592-018-0176-y</article-id>
    <article-id pub-id-type="manuscript">nihpa1507068</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Species-level functional profiling of metagenomes and metatranscriptomes</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" equal-contrib="yes">
        <name>
          <surname>Franzosa</surname>
          <given-names>Eric A.</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A2">2</xref>
      </contrib>
      <contrib contrib-type="author" equal-contrib="yes">
        <name>
          <surname>McIver</surname>
          <given-names>Lauren J.</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Rahnavard</surname>
          <given-names>Gholamali</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Thompson</surname>
          <given-names>Luke R.</given-names>
        </name>
        <xref ref-type="aff" rid="A4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Schirmer</surname>
          <given-names>Melanie</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Weingart</surname>
          <given-names>George</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Lipson</surname>
          <given-names>Karen Schwarzberg</given-names>
        </name>
        <xref ref-type="aff" rid="A3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Knight</surname>
          <given-names>Rob</given-names>
        </name>
        <xref ref-type="aff" rid="A4">4</xref>
        <xref ref-type="aff" rid="A5">5</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Caporaso</surname>
          <given-names>J. Gregory</given-names>
        </name>
        <xref ref-type="aff" rid="A3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Segata</surname>
          <given-names>Nicola</given-names>
        </name>
        <xref ref-type="aff" rid="A6">6</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Huttenhower</surname>
          <given-names>Curtis</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A2">2</xref>
        <xref rid="CR1" ref-type="corresp">†</xref>
      </contrib>
    </contrib-group>
    <aff id="A1"><label>1</label>Dept. of Biostatistics, Harvard T. H. Chan School of Public Health, Boston, MA, USA</aff>
    <aff id="A2"><label>2</label>The Broad Institute of MIT and Harvard, Cambridge, MA, USA</aff>
    <aff id="A3"><label>3</label>Pathogen and Microbiome Institute, Northern Arizona University, Flagstaff, AZ, USA</aff>
    <aff id="A4"><label>4</label>Dept. of Pediatrics, University of California San Diego, San Diego, CA, USA</aff>
    <aff id="A5"><label>5</label>Dept. of Computer Science &amp; Engineering, University of California San Diego, San Diego, CA, USA</aff>
    <aff id="A6"><label>6</label>Centre for Integrative Biology, University of Trento, Trento, Italy</aff>
    <author-notes>
      <fn fn-type="con" id="FN1">
        <p id="P1">AUTHOR CONTRIBUTIONS</p>
        <p id="P2">E.A.F., L.J.M., and C.H. designed the methods. L.J.M. developed the software implementation. G.R., G.W., and N.S. produced datasets to support the software. E.A.F., L.J.M., G.R., L.R.T., M.S., and K.S.L. designed and carried out the evaluations and applications; all authors participated in interpretation of the resulting data. E.A.F., L.J.M., L.R.T., M.S., K.S.L., and C.H. wrote the paper with feedback from the other authors.</p>
      </fn>
      <corresp id="CR1"><label>†</label>Corresponding author: <email>chuttenh@hsph.harvard.edu</email></corresp>
    </author-notes>
    <pub-date pub-type="nihms-submitted">
      <day>1</day>
      <month>10</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>30</day>
      <month>10</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <month>11</month>
      <year>2018</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>30</day>
      <month>4</month>
      <year>2019</year>
    </pub-date>
    <volume>15</volume>
    <issue>11</issue>
    <fpage>962</fpage>
    <lpage>968</lpage>
    <!--elocation-id from pubmed: 10.1038/s41592-018-0176-y-->
    <permissions>
      <license>
        <license-p>Users may view, print, copy, and download text and data-mine the content in such documents, for the purposes of academic research, subject always to the full Conditions of use:<ext-link ext-link-type="uri" xlink:href="http://www.nature.com/authors/editorial_policies/license.html#terms">http://www.nature.com/authors/editorial_policies/license.html#terms</ext-link></license-p>
      </license>
    </permissions>
    <abstract id="ABS1">
      <p id="P3">Functional profiling from metagenomic or metatranscriptomic (“meta’omic”) sequencing provides insight into the molecular activities of microbial communities. These analyses are typically carried out using comprehensive search of sequencing reads, which is time-consuming, prone to spurious mapping, and often limited to community-level quantification. We developed a tiered meta’omic search strategy (HUMAnN2) which enables fast, accurate, and species-resolved functional profiling of host-associated and environmental communities. HUMAnN2 identifies a community’s known species, aligns reads to their pangenomes, performs translated search on unclassified reads, and finally quantifies gene families and pathways. Relative to pure translated search, HUMAnN2 is 3x faster and produces more accurate gene family profiles (89% vs. 67%). We apply HUMAnN2 to clinal variation in marine metabolism, ecological contribution patterns among human microbiome pathways, variation in species’ genomic vs. transcriptional contributions, and strain profiling. Finally, we introduce “contributional diversity” to explain patterns of ecological assembly across different microbial community types.</p>
    </abstract>
  </article-meta>
</front>
<body>
  <sec id="S1">
    <title>INTRODUCTION</title>
    <p id="P4">Profiling microbial community function from metagenomic and metatranscriptomic (“meta’omic”) sequencing is a critically important challenge in culture-independent microbial ecology. It has the potential to characterize the extensive biochemical “dark matter” observed in many communities<sup><xref rid="R1" ref-type="bibr">1</xref></sup>, as well as to link specific molecular activities to environmental<sup><xref rid="R2" ref-type="bibr">2</xref></sup> and health-associated<sup><xref rid="R3" ref-type="bibr">3</xref></sup> phenotypes. In contrast with taxonomic profiling, functional profiling aims to quantify the gene and metabolic pathway content contributed by known and uncharacterized community members<sup><xref rid="R4" ref-type="bibr">4</xref></sup>. While taxonomic profiling can be performed on a maximally informative subset of meta’omic sequencing reads<sup><xref rid="R5" ref-type="bibr">5</xref>, <xref rid="R6" ref-type="bibr">6</xref></sup>, comprehensive functional profiling must consider all reads and the vast space of genes from which they may derive, thus adding considerable analytical complexity.</p>
    <p id="P5">Several previous methods exist for functional profiling of metagenomes<sup><xref rid="R7" ref-type="bibr">7</xref>–<xref rid="R9" ref-type="bibr">9</xref></sup>, a subset of which have been applied to metatranscriptomes<sup><xref rid="R10" ref-type="bibr">10</xref>–<xref rid="R13" ref-type="bibr">13</xref></sup>. These include HUMAnN<sup><xref rid="R14" ref-type="bibr">14</xref></sup>, which we developed during the Human Microbiome Project (HMP)<sup><xref rid="R15" ref-type="bibr">15</xref></sup> for host- and environmentally-associated meta’omic functional profiling. Like later methods, HUMAnN interprets translated search of meta’omic sequencing reads to reconstruct metabolic functions. While existing methods benefit from recent methodological advances in translated search<sup><xref rid="R16" ref-type="bibr">16</xref>–<xref rid="R18" ref-type="bibr">18</xref></sup>, they remain considerably slower than nucleotide-level analyses. In addition, while some functional profiling methods incorporate taxonomic concepts for database refinement<sup><xref rid="R7" ref-type="bibr">7</xref></sup> or targeted quantification<sup><xref rid="R9" ref-type="bibr">9</xref></sup>, most are limited to reporting community-level abundances (not per-organism contributions). Similarly, functional profiling lags behind efforts in strain-level analysis of microbial communities<sup><xref rid="R19" ref-type="bibr">19</xref>–<xref rid="R21" ref-type="bibr">21</xref></sup>, despite a growing appreciation for strain-variable functions within species.</p>
    <p id="P6">To integrate taxonomic information with microbial community functional profiles, and to limit the bottleneck imposed by translated search, we developed HUMAnN2 as a next-generation meta’omic functional profiling method. HUMAnN2 represents both a completely new methodology and implementation: incorporating a tiered approach with accelerated nucleotide-level, translated search, and pathway reconstruction components. With these, HUMAnN2 exceeds the accuracy and performance of current pure translated search strategies. Moreover, gene and pathway abundances quantified by HUMAnN2 are automatically stratified into contributions from known and uncharacterized species. This provides previously inaccessible detail in interpreting host-associated and environmental community meta’omes.</p>
  </sec>
  <sec id="S2">
    <title>RESULTS</title>
    <sec id="S3">
      <title>Algorithm overview</title>
      <p id="P7">HUMAnN2 implements a “tiered search” strategy to quickly and accurately profile the functional content of a meta’ome at species-level resolution (<xref rid="F1" ref-type="fig">Fig. 1a</xref>, <xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 1</xref>, <xref rid="S12" ref-type="sec">Online Methods</xref>), the results of which can also be used later for strain profiling. In the first tier, HUMAnN2 rapidly identifies known microbial species in a sample by screening DNA or RNA reads with MetaPhlAn2<sup><xref rid="R22" ref-type="bibr">22</xref></sup>. HUMAnN2 then constructs a sample-specific database by merging preconstructed, functionally annotated pangenomes of the identified species<sup><xref rid="R23" ref-type="bibr">23</xref></sup>. In the second tier, HUMAnN2 performs nucleotide-level mapping of all sample reads against the sample’s pangenome database. Relative to comprehensive translated search, nucleotide-level mapping against relevant pangenomes quickly explains a large fraction of reads with fewer opportunities for spurious alignment. In the third and final tier, reads that did not align to identified species’ pangenomes are subjected to accelerated translated search against a comprehensive protein database (by default, UniRef90 or UniRef50<sup><xref rid="R24" ref-type="bibr">24</xref></sup>).</p>
      <p id="P8">The tiered search generates mappings of meta’omic reads to gene sequences with known or ambiguous taxonomy. These mappings are weighted by quality and sequence length to estimate per-organism and community-total gene family abundance, which can be regrouped to other functional systems (e.g. COGs<sup><xref rid="R25" ref-type="bibr">25</xref></sup>, KOs<sup><xref rid="R26" ref-type="bibr">26</xref></sup>, Pfam domains<sup><xref rid="R27" ref-type="bibr">27</xref></sup>, and GO terms<sup><xref rid="R28" ref-type="bibr">28</xref></sup>). Finally, gene families annotated to metabolic enzymes are further analyzed to reconstruct and quantify complete metabolic pathways (by default, MetaCyc<sup><xref rid="R29" ref-type="bibr">29</xref></sup>) in the community and per-organism.</p>
    </sec>
    <sec id="S4">
      <title>HUMAnN2’s tiered search produces more accurate functional profiles 3x faster than pure translated search</title>
      <p id="P9">We assessed HUMAnN2’s accuracy by profiling synthetic metagenomes of known taxonomic and functional composition (<xref rid="S12" ref-type="sec">Online Methods</xref>). We first simulated a human gut metagenome containing 10 million 100-nt DNA reads (1 Gnt) drawn from the 20 most abundant bacterial species detected in HMP stool samples<sup><xref rid="R15" ref-type="bibr">15</xref></sup>. Species’ abundances were geometrically staggered from ~0.1x to ~70x genomic coverage (<xref rid="F1" ref-type="fig">Fig. 1b</xref>) and included nine members of genus <italic>Bacteroides</italic>: both challenges for accurate per-species profiling. We analyzed this synthetic metagenome using HUMAnN2’s tiered search and a pure translated search strategy (see also <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 1</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 2</xref> for a parallel analysis of a 100-member, non-human-associated community).</p>
      <p id="P10">Focusing first on community-level gene family (UniRef90) abundances, the sensitivity, precision, and overall accuracy (1 - Bray-Curtis dissimilarity) of HUMAnN2’s tiered search were high at 86%, 90%, and 89%, respectively (<xref rid="F1" ref-type="fig">Fig. 1c</xref>). Hence, HUMAnN2 i) detected most expected gene families in the community, ii) reported only a small proportion of spuriously detected families, and iii) correctly assigned the vast majority of reads to their source families. Gene families profiled by pure translated search were less accurate (overall accuracy 67%), due in part to the greater potential for spurious alignment when aligning all sample reads against a comprehensive protein database.</p>
      <p id="P11">The per-species accuracy of HUMAnN2’s tiered search remained high for the 14 species present at 1x genomic coverage or greater, including the nine <italic>Bacteroides</italic> species. Below 1x coverage, sensitivity and overall accuracy dropped off with coverage, as greater numbers of gene families were under-sampled in that domain. However, precision remained consistently high for low-coverage species, indicating that their pangenomes did not recruit substantial unrelated reads. The small subset of reads (1.4%) that passed into the translated search tier and mapped to proteins produced an “unclassified” stratification with a minority contribution to overall error (<xref rid="SD1" ref-type="supplementary-material">Supplementary Note 2</xref>).</p>
      <p id="P12">Accuracy trends for HUMAnN2’s tiered search were similar at the pathway level, with pathway precision generally exceeding gene family precision (<xref rid="F1" ref-type="fig">Fig. 1d</xref>). This is due to the greater difficulty of spuriously matching a complete pathway, which requires multiple distinct reactions (gene families) to spuriously recruit reads. Simultaneously, HUMAnN2’s requirement of detecting complete (or nearly-complete) pathways causes sensitivity and overall accuracy to decay more rapidly with decreasing coverage. Notable for less-well characterized samples, gene-level error inherent to the pure translated search strategy tended to be “smoothed out” during pathway quantification, though pathway profiles from pure translated search were still less accurate than those from HUMAnN2’s tiered search (87% vs. 98%).</p>
      <p id="P13">In addition to being more accurate, HUMAnN2’s tiered search was 3x faster than pure translated search in the synthetic evaluation (runtime &lt;1 hr; <xref rid="F1" ref-type="fig">Fig. 1e</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Notes 1 and 3</xref>). We further benchmarked the performance of tiered search on 397 HMP metagenomes spanning six body sites (<xref rid="SD1" ref-type="supplementary-material">Supplementary Note 4</xref>). In a typical sample, ~60% of reads mapped during the pangenome search, and an additional ~20% mapped during translated search (<xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 3</xref>). Thus, for well-characterized, real-world metagenomes, HUMAnN2 explains the majority of sample reads during the fast pangenome search, thus making it considerably more efficient than a pure translated search strategy.</p>
    </sec>
    <sec id="S5">
      <title>HUMAnN2 is more sensitive, precise, and efficient than existing methods</title>
      <p id="P14">We compared HUMAnN2 with existing functional profiling methods built upon pure translated search: HUMAnN1<sup><xref rid="R14" ref-type="bibr">14</xref></sup>, COGNIZER<sup><xref rid="R10" ref-type="bibr">10</xref></sup>, MEGAN<sup><xref rid="R12" ref-type="bibr">12</xref></sup>, and ShotMAP<sup><xref rid="R13" ref-type="bibr">13</xref></sup> (<xref rid="F1" ref-type="fig">Fig. 1e</xref>). This comparison was based on estimating community-level COG (Clusters of Orthologous Groups) abundances: an output format common to all methods (<xref rid="S12" ref-type="sec">Online Methods</xref>). We constructed a custom search database for ShotMAP based on UniRef90, and used the other three methods’ recommended databases. We note that these three methods may differ in their systems of COG definition relative to our UniProt-based gold standard, which could influence their accuracy relative to HUMAnN2 and ShotMAP. However, the isolate genomes sampled in these evaluations predate all methods except HUMAnN1, which limits potential bias due to database coverage.</p>
      <p id="P15">Overall accuracy was strongest for HUMAnN2’s tiered search (97%), followed by HUMAnN2’s pure translated search (83%), ShotMAP (72%), HUMAnN1 (59%), MEGAN (56%), and COGNIZER (43%). This result further emphasizes the power of tiered search to improve accuracy. The increased accuracy of HUMAnN2’s pure translated search may be attributed to our <italic>post hoc</italic> alignment filtering and weighting aimed at maximizing specificity (<xref rid="S12" ref-type="sec">Online Methods</xref>; <xref rid="SD1" ref-type="supplementary-material">Supplementary Figures 4 and 5</xref>). HUMAnN2’s tiered search profiled the 10M-read synthetic metagenome in 45 minutes. This was similar to HUMAnN1 using accelerated translated search<sup><xref rid="R16" ref-type="bibr">16</xref></sup> (42 minutes), yet HUMAnN2 provides considerably more detailed output and considers a ~20x larger sequence space. HUMAnN2 was &gt;3x faster than all other methods.</p>
    </sec>
    <sec id="S6">
      <title>HUMAnN2 is accurate for metatranscriptomes and robust to community species lacking reference genomes</title>
      <p id="P16">We performed extensive additional evaluations of HUMAnN2 during development (summarized here and expanded in the <xref rid="SD2" ref-type="supplementary-material">supplement</xref>). We demonstrated that HUMAnN2 remains accurate and efficient when profiling broadly defined gene families (UniRef50; <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 3</xref>). We further demonstrated that HUMAnN2 continued to perform optimally among other methods in profiling a synthetic gut <italic>metatranscriptome</italic> (<xref rid="SD1" ref-type="supplementary-material">Supplementary Note 5</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 6</xref>). Most critically, we demonstrated that HUMAnN2 performed ably on metagenomes containing new isolates of known species as well as novel species (with the latter profiled by the translated search tier). This was accomplished by profiling a complex (100-member) synthetic community while holding out fractions of HUMAnN2’s pangenome database to simulate novel species (<xref rid="SD1" ref-type="supplementary-material">Supplementary Note 1</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 2</xref>), and by applying HUMAnN2 and other methods to communities of isolate genomes that post-date the methods’ databases (<xref rid="SD1" ref-type="supplementary-material">Supplementary Note 6</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Figures 7–10</xref>).</p>
      <p id="P17">We additionally compared HUMAnN2 with metagenomic assembly of synthetic metagenomes (<xref rid="SD1" ref-type="supplementary-material">Supplementary Note 7</xref>). This evaluation expands previous comparisons of the approaches on real-world human metagenomes<sup><xref rid="R30" ref-type="bibr">30</xref></sup>, where they produced very similar rankings of domain-level functional diversity. While assembly was advantageous for uncovering novel sequence diversity in deeply sequenced human metagenomes, HUMAnN2 identified more known domains in metagenomes with modest sequencing depths. This advantage follows from the known challenge of detecting low-coverage metagenomic sequences by assembly<sup><xref rid="R31" ref-type="bibr">31</xref></sup>, which was also observed in our synthetic evaluations.</p>
    </sec>
    <sec id="S7">
      <title>Contributional diversity of core human microbiome pathways</title>
      <p id="P18">HUMAnN2’s tiered search quantifies community-encoded functions and stratifies their abundances according to who performs them. These data can be explored in additional detail by applying traditional within-sample (alpha) and between-sample (beta) community diversity measures<sup><xref rid="R32" ref-type="bibr">32</xref></sup> to species’ contributions to a specific function: defined here as the function’s “contributional diversity” (<xref rid="S12" ref-type="sec">Online Methods</xref>). A function contributed by a single species has low within-sample (“simple”) contributional diversity, while a function with many equal contributors has high within-sample (“complex”) contributional diversity. If a function is contributed by the same assemblage of species across samples, it has low between-sample (“conserved”) contributional diversity, while a function contributed by different assemblages has high between-sample (“variable”) contributional diversity.</p>
      <p id="P19">We explored the contributional diversity of human microbiome pathways that were core to a body site (non-zero in &gt;75% of individuals) and largely explained by known species (&lt;25% unclassified in &gt;75% of individuals) among the 397 HMP metagenomes introduced above. (Note that functions with extensive “unclassified” abundance could be contributed by one or many different species within and across samples—hence their exclusion from this analysis.) Within- and between-sample contributional diversities were intuitively bounded above by their community-level analogs (<xref rid="F2" ref-type="fig">Fig. 2a</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 11</xref>; examples in <xref rid="F2" ref-type="fig">Fig. 2b–e</xref>). Contributional diversity rivals community diversity for functions that are broadly distributed in a given ecology. For example, phosphopantothenate biosynthesis in the gut had complex, variable contributors across subjects (mirroring gut ecology; <xref rid="F2" ref-type="fig">Fig. 2b</xref>). Conversely, human microbiomes often contained pathways contributed by the same dominant organism across subjects, resulting in low within- and between-sample contributional diversity (<xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 12</xref>). For example, glutaryl-CoA biosynthesis in the gut was contributed principally by <italic>Faecalibacterium prausnitzii</italic> (<xref rid="F2" ref-type="fig">Fig. 2e</xref>).</p>
      <p id="P20">Oral sites were the most enriched for pathways with high within-subject but low between-subject contributional diversities, suggesting that they were encoded by complex yet similar mixtures of species across individuals (<xref rid="F2" ref-type="fig">Fig. 2c</xref>). Core pathways at the vaginal site exhibited low within-sample but high between-sample contributional diversity, consistent with vaginal ecologies dominated by single, differing <italic>Lactobacillus</italic> species among subjects<sup><xref rid="R33" ref-type="bibr">33</xref></sup> (<xref rid="F2" ref-type="fig">Fig. 2d</xref>). That said, a subset of core pathways in non-vaginal sites also exhibited the same “simple but variable” contributions, which is further evidence for potential discordance between per-function and community-level diversities (<xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 13</xref>).</p>
    </sec>
    <sec id="S8">
      <title>Clinal variation in marine microbial community function</title>
      <p id="P21">To demonstrate HUMAnN2’s applicability to environmental microbial communities, we applied the tiered search to quantify KEGG Orthogroup (KO) abundance in a dataset of 45 marine metagenomes from the epipelagic and mesopelagic zones of the Red Sea (<xref rid="F3" ref-type="fig">Fig. 3</xref> and <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 4</xref>). We identified a number of high-variance KOs that were not detected in a previous analysis of the same samples with HUMAnN1<sup><xref rid="R34" ref-type="bibr">34</xref></sup> (examples in <xref rid="F3" ref-type="fig">Fig. 3 a–e</xref>). Notably, KOs detected by both HUMAnN1 and HUMAnN2 were in the majority and their abundances were well correlated between the two methods (<xref rid="F3" ref-type="fig">Fig. 3f</xref>).</p>
      <p id="P22">Variation in KO abundance was often associated with sample temperature: the primary predictor of genetic diversity in the marine water column<sup><xref rid="R34" ref-type="bibr">34</xref>, <xref rid="R35" ref-type="bibr">35</xref></sup>. Many high-variance KOs were maximally abundant in deep/cool waters and sharply less abundant at warmer temperatures. Three such KOs, among the six most variable overall, were implicated in fatty acid biosynthesis, particularly in archaea (see <xref rid="F3" ref-type="fig">Fig. 3a–c</xref>). Indeed, HUMAnN2’s taxonomic stratifications revealed that the community abundances of these KOs were dominated by contributions from a single-cell genome<sup><xref rid="R36" ref-type="bibr">36</xref></sup> of Marine Group I Thaumarchaeota (47–89% of copies).</p>
      <p id="P23">Conversely, D-glycerate 3-kinase was more abundant in warmer, surface waters (see <xref rid="F3" ref-type="fig">Fig. 3d</xref>), and largely attributed to <italic>Prochlorococcus marinus</italic> (25%) and <italic>Candidatus</italic> Pelagibacter ubique (21%): the two most abundant bacterial species in the surface ocean. These two species may use this enzyme to salvage glycerate in different aspects of central carbon metabolism (<italic>Prochlorococcus</italic> in photorespiration and <italic>Candidatus</italic> Pelagibacter as an entry point to glycolysis). Cob(I)alamin adenosyltransferase was notable for being enriched at low and high depths and depleted at intermediate depths (<xref rid="F3" ref-type="fig">Fig. 3e</xref>). Cobalamin is a required cofactor for ribonucleotide reductase in certain marine bacteria, including <italic>Prochlorococcus</italic><sup><xref rid="R37" ref-type="bibr">37</xref></sup>. Indeed, <italic>Prochlorococcus</italic> was the enzyme’s dominant contributor in surface samples (71–96%), whereas <italic>Verrucomicrobia</italic> was dominant in the deepest samples (36–41%).</p>
    </sec>
    <sec id="S9">
      <title>Profiling strain-level functional variation</title>
      <p id="P24">HUMAnN2’s accurate gene presence/absence calls (see <xref rid="F1" ref-type="fig">Fig. 1c</xref>) can be applied to track strain-level<sup><xref rid="R20" ref-type="bibr">20</xref></sup> functional variation in well-covered community species (<xref rid="SD1" ref-type="supplementary-material">Supplementary Note 4</xref>). While HUMAnN2 cannot assign new functions to a species, it identifies (potentially novel) subspecies-level clades from metagenomes based on presence/absence of functions observed across the species’ sequenced isolate genomes. For example, HUMAnN2’s gene family profiles of the HMP metagenomes introduced above revealed putative subspecies-level clades of <italic>Lactobacillus jensenii</italic> and <italic>Eubacterium eligens</italic> in the posterior fornix and gut, respectively (<xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 14</xref>).</p>
      <p id="P25">Critically, HUMAnN2’s strain profiles provide a means of functionally explaining subspecies-level variation based on enrichments in “variable” gene families<sup><xref rid="R20" ref-type="bibr">20</xref></sup>. For example, strain-variable genes in HMP species were intuitively enriched for mobile-element processes such as DNA-mediated transposition (Wilcoxon enrichment test; FDR-corrected <italic>q</italic>&lt;0.2 in 42 species) and DNA integration (<italic>q</italic>&lt;0.2 in 105 species). In some cases, gene presence/absence was strongly correlated with body site, indicative of possible niche-adapted subspecies. For example, <italic>Haemophilus haemolyticus</italic> strains from tongue metagenomes were enriched for genes involved in outer cell membrane assembly relative to plaque and buccal strains (<italic>q</italic>=0.03; <xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 15</xref>).</p>
    </sec>
    <sec id="S10">
      <title>Analyzing paired metatranscriptomes and metagenomes</title>
      <p id="P26">HUMAnN2 can profile paired metagenomes (DNA reads) and metatranscriptomes (RNA reads) to compare and contrast microbial community functional potential and activity<sup><xref rid="R4" ref-type="bibr">4</xref></sup>, as well as their respective contributional diversities. To illustrate this, we profiled core pathways (as defined above) from 78 paired meta’omes from the Inflammatory Bowel Disease Multi’omics Database (IBDMDB)<sup><xref rid="R38" ref-type="bibr">38</xref></sup> (<xref rid="SD1" ref-type="supplementary-material">Supplementary Note 4</xref>). Within-sample contributional diversity at the DNA and RNA levels were well-correlated across 181 pathways, suggesting that more diverse pathway encoding tends to result in more diverse transcription (Spearman’s <italic>r</italic>=0.91; <xref rid="F4" ref-type="fig">Fig. 4a</xref>). Simultaneously, DNA diversity tended to exceed RNA diversity, suggesting that pathways are not proportionally transcribed by the community species that encode them. Sucrose degradation was one such striking example: while encoded by many species, the pathway’s transcript pool was dominated by <italic>Faecalibacterium prausnitzii</italic> (<xref rid="F4" ref-type="fig">Fig. 4b</xref>).</p>
      <p id="P27">To differentiate changes in community gene expression from changes in gene copy number, it is critical to normalize functions’ RNA abundances against their DNA abundances. For example, within these profiles of the IBD gut, 71% of pathways’ RNA abundances fell within an order of magnitude of their DNA abundances. Methanogenesis pathways were among the largest outliers, with RNA:DNA ratios indicative of strong expression<sup><xref rid="R39" ref-type="bibr">39</xref></sup>. HUMAnN2’s stratified profiles confirmed <italic>Methanobrevibacter smithii</italic> as a consistent, dominant contributor to these pathways, resulting in low within- and between-subject contributional diversity.</p>
    </sec>
  </sec>
  <sec id="S11">
    <title>DISCUSSION</title>
    <p id="P28">HUMAnN2 is a new approach for functional profiling of meta’omically sequenced microbial communities. The method introduces a novel tiered search algorithm that provides exceptionally accurate profiles for characterized members of microbial communities, with fallback to translated search for uncharacterized members. These tiers operate jointly in far less time than traditional pure translated search. Moreover, tiered search provides taxonomic stratification of microbial functions at the species-level, thus quantifying the community abundance of functions while simultaneously assigning them to specific contributors. The utility of tiered search will only improve as reference catalogs continue to rapidly expand. In addition, tiered search facilitates this expansion by identifying unclassified meta’omic sequencing reads for external assembly of novel genes.</p>
    <p id="P29">HUMAnN2’s functional stratifications enable discussion of “contributional diversity”: an analog of community-level diversity for individual microbial functions. Community-level function is often more conserved than community composition<sup><xref rid="R15" ref-type="bibr">15</xref>, <xref rid="R39" ref-type="bibr">39</xref>–<xref rid="R41" ref-type="bibr">41</xref></sup>, consistent with a functional repertoire “defining” a niche and satisfied by different microbial assemblages. Contributional diversity adds another means by which this feature of functional ecology may be understood<sup><xref rid="R1" ref-type="bibr">1</xref></sup>, in that, while some functions do appear to be distributed evenly across community members, others are more restricted. Similarly, modern “multi’omic” analyses of microbial communities distinguish between community functional potential (encoding by genomes) and functional activity (gene or protein expression)<sup><xref rid="R39" ref-type="bibr">39</xref>, <xref rid="R42" ref-type="bibr">42</xref>, <xref rid="R43" ref-type="bibr">43</xref></sup>. Contributional diversity reveals another way in which these measurements can differ: for example, broadly encoded functions that are expressed dominantly by one or a few species.</p>
    <p id="P30">Functional meta-analysis<sup><xref rid="R44" ref-type="bibr">44</xref></sup> of diverse, new and existing meta’omic profiles are among the future biological areas opened up by the HUMAnN2 methodology, with the potential to reveal i) novel microbial community biochemistry and signaling, ii) determination of these functions’ source species and contributional diversity patterns and, in multi’omic datasets, iii) species-resolved deviations between functional potential and activity. In the human microbiome, HUMAnN2 provides the opportunity to generate testable hypotheses regarding specific species- (or strain-) level functions associated with health-related differences in community-level function. To support these future discoveries, the method is implemented as open source, fully documented software, packaged with demonstration data and training materials, and supports an active user community, accessible via <ext-link ext-link-type="uri" xlink:href="http://huttenhower.sph.harvard.edu/humann2">http://huttenhower.sph.harvard.edu/humann2</ext-link>.</p>
  </sec>
  <sec id="S12">
    <title>ONLINE METHODS</title>
    <p id="P31">These methods detail the HUMAnN2 algorithm, the construction of its databases, our evaluations on synthetic metagenomes, and contributional diversity calculations. Methods related to our HUMAnN2 applications (i.e. the analyses of HMP metagenomes, Red Sea metagenomes, and paired IBDMDB meta’omes) are provided in <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 4</xref>. Methods related to our evaluations on synthetic metatranscriptomes, novel isolate genomes, and assembled metagenomes are provided in <xref rid="SD1" ref-type="supplementary-material">Supplementary Notes 5, 6, and 7</xref>, respectively. Methods details can also be found in the online Life Sciences Reporting Summary.</p>
    <sec id="S13">
      <title>Algorithm overview</title>
      <p id="P32">HUMAnN2 is a system for accelerated functional profiling of shotgun metagenomic and metatranscriptomic (“meta’omic”) sequencing from host- and environmentally-associated microbial communities. HUMAnN2 implements a tiered search strategy comprised of three search phases (tiers). In the first search tier, the meta’omic sample is rapidly screened to identify known species in the underlying community. This information is then used to construct a custom gene sequence database for the sample by concatenating precomputied, functionally annotated pangenomes of detected species. In the second search tier, the entire sample is aligned against this database, yielding i) per-species, per-gene alignment statistics and ii) a collection of unmapped reads. In the final search tier, unmapped reads are aligned against a user-specified (typically comprehensive and nonredundant) protein database by translated search, yielding i) taxonomically unclassified per-gene alignment statistics and ii) a collection of novel reads. Per-gene alignment statistics are weighted based on alignment quality, coverage, and sequence length to yield gene abundance values i) for the community and ii) stratified according to per-species and “unclassified” contributions. Gene abundance values are finally applied to metabolic network reconstruction to identity and quantify pathways in the community (also stratified according to per-species and “unclassified” contributions). These processes, including the underlying databases and search parameters, are expanded in detail below.</p>
    </sec>
    <sec id="S14">
      <title>Gene and pathway reference data as fixed inputs to HUMAnN2</title>
      <sec id="S15">
        <title>Comprehensive protein databases</title>
        <p id="P33">HUMAnN2 uses UniRef90 and UniRef50<sup><xref rid="R24" ref-type="bibr">24</xref></sup> as comprehensive, non-redundant protein sequence databases. Briefly, UniRef90 represents a clustering of all non-redundant protein sequences in UniProt<sup><xref rid="R45" ref-type="bibr">45</xref></sup> such that each sequence in a cluster aligns with 90% identity and 80% coverage of the longest sequence in the cluster (the cluster seed). Each resulting cluster is represented by a single sequence (usually the best-annotated member of the cluster, which is not necessarily the seed). UniRef50 is constructed by clustering all UniRef90 representative sequences to make clusters aligning with 50% amino acid sequence identity and 80% coverage of the cluster seeds. We use UniRef90 and UniRef50 clusters i) as a basis for describing gene family structure in microbial genomes and ii) as a comprehensive database for translated meta’omic search (see below). Protein annotations used by HUMAnN2 [e.g. Enzyme Commission (EC) number, COG<sup><xref rid="R25" ref-type="bibr">25</xref></sup>, KO<sup><xref rid="R26" ref-type="bibr">26</xref></sup>, Pfam domain<sup><xref rid="R27" ref-type="bibr">27</xref></sup>, and GO term<sup><xref rid="R28" ref-type="bibr">28</xref></sup> assignments] are inferred from the annotations of representative UniProt sequences.</p>
      </sec>
      <sec id="S16">
        <title>ChocoPhlAn pangenomes</title>
        <p id="P34">Nucleotide-level search in HUMAnN2 is performed using collections of species pangenomes. We refer to this collection in HUMAnN2 as “ChocoPhlAn.” (An earlier version of ChocoPhlAn was published as MetaRef<sup><xref rid="R46" ref-type="bibr">46</xref></sup>; the version of ChocoPhlAn incorporated in HUMAnN2 is identical to that underlying MetaPhlAn2 and its marker database<sup><xref rid="R22" ref-type="bibr">22</xref></sup>.) A species’ pangenome is a nonredundant representation of the species’ protein-coding potential. To construct a pangenome for a given species, we download all available isolate genomes for that species from NCBI GenBank and/or RefSeq, along with associated coding sequence (CDS) annotations. Each isolate genome is analyzed with PhyloPhlAn<sup><xref rid="R47" ref-type="bibr">47</xref></sup> to confirm correct taxonomic placement. Using UCLUST<sup><xref rid="R48" ref-type="bibr">48</xref></sup>, we then cluster all CDSs from high-quality isolate genomes of a given species at 97% nucleotide identity. One representative (centroid) sequence from each cluster is saved. These centroid sequences constitute the species’ pangenome. These steps were conducted in the course of MetaPhlAn2 development.</p>
        <p id="P35">To use ChocoPhlAn for functional profiling, we annotated each pangenome centroid sequence to UniRef90 and UniRef50 by i) translating the centroid to produce an amino acid sequence and then ii) performing protein-level search against UniRef90. If the centroid’s best hit in UniRef90 met the criteria for inclusion in the corresponding UniRef90 cluster (&gt;90% amino acid identity and &gt;80% coverage), then the centroid was annotated to the UniRef90 cluster and inherited its corresponding UniRef50 annotation. If not, the centroid was labeled as “UniRef90_unknown” and a similar search was carried out against UniRef50 (requiring &gt;50% identity to a UniRef50 sequence). If this search also failed, then the centroid was labeled as “UniRef50_unknown.” ChocoPhlAn includes pangenomes for &gt;4K cellular microbes (bacteria, archaea, and fungi) which include &gt;18M gene clusters. HUMAnN2 v0.9.6 adds support for &gt;3K viral pangenomes which include &gt;100K gene clusters.</p>
      </sec>
      <sec id="S17">
        <title>Associating UniRef90/50 gene families with MetaCyc reactions</title>
        <p id="P36">All alignments generated by HUMAnN2 are collapsed to UniRef90 or UniRef50 gene families, which constitute the method’s most highly-resolved main output. Gene families must be further collapsed to enzyme/reaction abundances prior to metabolic pathway reconstruction. This required generating a map linking UniRef90 and UniRef50 identifiers to MetaCyc reactions. These links were established in two ways. First, MetaCyc reactions are associated with a subset of proteins in UniProt, which are identified by UniProt accession numbers (ACs). As each protein in UniProt is associated with a UniRef90 cluster (and by extension, a UniRef50 cluster), Reaction-AC associations were converted to Reaction-UniRef90 and Reaction-UniRef50 associations for use in HUMAnN2. Second, MetaCyc reactions are associated with entries in the Enzyme Commission (EC) catalog: a four-level hierarchical description of enzymatic activities. UniProt entries (and, by extension, UniRef entries) are also associated with EC numbers. This relationship enabled additional transitive association of MetaCyc reactions and UniRef90/50 identifiers using EC annotations as a bridge. To maintain specificity, only EC annotations of the highest level of specificity were used in this process (for example, a UniRef90 entry associated with EC 1.1.1 would <italic>not</italic> be linked to a MetaCyc RXN associated with EC 1.1.1.1, nor would the reverse mapping be allowed). MetaCyc RXNs with at least one UniRef90 (or UniRef50) association are said to be “quantifiable” in HUMAnN2.</p>
      </sec>
      <sec id="S18">
        <title>MetaCyc reaction to pathway mapping</title>
        <p id="P37">HUMAnN1<sup><xref rid="R14" ref-type="bibr">14</xref></sup> incorporated KEGG’s structured pathway syntax<sup><xref rid="R26" ref-type="bibr">26</xref></sup> to improve the accuracy of pathway reconstruction and quantification. This syntax i) specifies the reactions that must be satisfied to complete a pathway, as well as ii) possible alternative paths through the pathway (satisfiable by different combinations of reactions). We generated a corresponding structure for MetaCyc pathways by parsing MetaCyc’s pathway definition files. More specifically, each pathway was resolved to a directed acyclic graph connecting initial reactants with final products. (MetaCyc’s “superpathways” were resolved to their respective sub-pathways and recursive paths were removed.)</p>
        <p id="P38">Each reaction node in a pathway was annotated to describe whether it connects with other nodes via “AND” or “OR” relationships (indicating, for example, that reactions 1 and 2 are both required to convert A to B, or that either 1 or 2 can perform the conversion). A pathway is said to be “satisfied” when there exists a path from initial reactants to final products that only passes through reaction nodes that were detected (non-zero abundance) in a given meta’omic sample (see below). Pathways were excluded if i) they contained less than four quantifiable reactions (i.e. reactions associated with level-4 EC numbers, which are in turn associated with UniRef90 and UniRef50 families) or ii) if they included &gt;10% unquantifiable reactions. (Unquantifiable reactions in otherwise acceptable pathways were flagged as “optional” in the structured pathway syntax.)</p>
      </sec>
    </sec>
    <sec id="S19">
      <title>Quantifying gene families by tiered search</title>
      <sec id="S20">
        <title>Taxonomic Prescreen</title>
        <p id="P39">HUMAnN2 takes as input a quality-controlled (including host-read-depleted) metagenome or metatranscriptome (“meta’ome”) provided as a FASTA or FASTQ file (with optional GZIP compression). DNA/RNA reads are initially screened using MetaPhlAn2 with default parameters. (The resulting MetaPhlAn2 outputs are saved as temp output in HUMAnN2.) Microbial species detected by MetaPhlAn2 above a target relative abundance threshold are passed to the next search tier (pangenome search). A lenient detection threshold of 0.0001 (0.01%) relative abundance is used as a default, which is equivalent to 0.1x fold-coverage of a 5 Mbp microbial genome in a 10 Gnt metagenome in which 50% of reads map to sequenced isolate genomes.</p>
      </sec>
      <sec id="S21">
        <title>Pangenome search</title>
        <p id="P40">HUMAnN2 next concatenates the pangenomes of species detected in the prescreen as a single FASTA file, which it then provides as input for building a Bowtie 2 index<sup><xref rid="R49" ref-type="bibr">49</xref></sup>. All sample reads (as introduced above) are then profiled against this index using Bowtie 2 in “very sensitive” mode. Because HUMAnN2 is aligning to isolated coding sequences, it does not consider read end-pairing relationships when evaluating Bowtie 2 alignment quality.</p>
      </sec>
      <sec id="S22">
        <title>Translated search</title>
        <p id="P41">Reads that failed to align against the pangenome database are mapped by translated search against a user-specified protein database. Four options are available: full versions of UniRef90 and UniRef50, as well as reduced versions of UniRef90 and UniRef50 containing only proteins associated with a MetaCyc reaction (discussed further in <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 3</xref>). HUMAnN2 can call three translated search binaries to complete this task: DIAMOND<sup><xref rid="R16" ref-type="bibr">16</xref></sup>, RAPSearch2<sup><xref rid="R17" ref-type="bibr">17</xref></sup>, and USEARCH<sup><xref rid="R48" ref-type="bibr">48</xref></sup>. DIAMOND is the recommended default. HUMAnN2 tunes the parameters of the translated search depending on whether the user is mapping against UniRef90 clusters versus the broader (more inclusive) UniRef50 clusters. For example, when using DIAMOND for translated search against UniRef50, the “--sensitive” search flag is invoked. The final output of the translated search is a tabular report of read-vs-protein alignment statistics (tabular BLAST format).</p>
      </sec>
      <sec id="S23">
        <title>Alignment post-processing</title>
        <p id="P42">Alignments in HUMAnN2 are post-processed to account for mapping quality and database sequence length. If a read has two or more high-quality alignments to distinct database sequences, the read’s single count is divided across the corresponding sequences in proportion to squared alignment identity. This serves as a more generic version of the default alignment weighting procedure implemented in HUMAnN1, which was based on alignment <italic>E</italic>-value (a statistic that lacks strict equivalents in some alignment software, e.g. Bowtie 2). Notably, a variety of similar weighting schemes were found to be equivalently good during HUMAnN1 evaluation, and all markedly better than naïve best-hit mapping<sup><xref rid="R14" ref-type="bibr">14</xref></sup>.</p>
        <p id="P43">A weighted count to a sequence is further normalized by the <italic>alignable length</italic> of the database sequence (in kilobases) to produce a count in reads per kilobase (RPK) units. (Alignable length is the total length of the database sequence minus the aligned length of the read plus 1: the number of positions where an equivalent alignment to the database sequence could have begun.) These procedures are applied to nucleotide-level alignments against ChocoPhlAn pangenomes and to translated alignments against UniRef90/UniRef50. Weighted hits to sequences in the ChocoPhlAn pangenomes are summed within-species according to UniRef90/UniRef50 annotations (or UniRef90_unknown/UniRef50_unknown if no annotation exists). Weighted direct hits to UniRef90/UniRef50 families during translated search are summed and assigned to an “unclassified” species bin. These gene family abundances, along with a community total abundance (all species totals plus “unclassified”), are reported as HUMAnN2’s stratified gene family abundance table.</p>
        <p id="P44">HUMAnN2’s translated search uses a comprehensive (rather than sample-specific) sequence database, which results in more opportunities for spurious alignments to occur. To compensate for this, HUMAnN2 filters translated alignment results in two additional ways before applying the general weighting procedures outlined above. First, we say that a read is “well aligned” to a protein if the majority of the read is used in the alignment (tunable default: 90% query coverage). This forces translated alignment of reads to more closely resemble the non-local alignment modes of Bowtie 2 (as used in pangenome search). Next, a read’s weight is only distributed over proteins whose sequences were “well covered” by well-aligned reads (tunable default: 50% of positions covered). Without such a filter, it is possible for small, frequently occurring peptide motifs to spuriously recruit compatible reads across a wide range of database proteins (most of which are not present in the underlying community; <xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 5</xref>). Reads that were never “well aligned” or which only aligned to poorly-covered proteins are exported alongside unaligned reads for downstream analyses (e.g. assembly of novel gene sequences) external to HUMAnN2.</p>
      </sec>
    </sec>
    <sec id="S24">
      <title>Quantifying pathway abundance and coverage</title>
      <p id="P45">Using the UniRef50/UniRef90 to MetaCyc reaction mapping described above, a reaction’s abundance is computed as the sum of the abundances for all gene families that map to the reaction. These sums are computed for each species, the “unclassified” stratum, and the community as a whole, consistent with HUMAnN2’s gene-level abundance reporting.</p>
      <p id="P46">HUMAnN2’s procedures for computing pathway abundance (copy number) and coverage (detection confidence) are computed largely as described and benchmarked in HUMAnN1<sup><xref rid="R14" ref-type="bibr">14</xref></sup>, with modifications added to account for i) the move from KEGG- to MetaCyc-based pathway definitions and ii) the need to compute the values in a stratified (per-species) manner as well as community-wide. Starting from a set of reaction abundances, HUMAnN2 first performs an (optional) gap-filling step to account for conspicuously depleted reactions or under-annotation. The default gap-filling in HUMAnN2 replaces the least-abundant reaction in the pathway with the abundance of the next-least-abundant reaction. Optional reactions are not considered in the gap-filling computations. Next, MinPath<sup><xref rid="R50" ref-type="bibr">50</xref></sup> is applied to identify a parsimonious set of pathways to explain the observed reactions. Abundance and coverage are then computed for each pathway following HUMAnN1’s methods for structured (default) or unstructured pathway definitions. For structured pathways, abundance is computed as the harmonic mean of reaction abundances (after optimizing over alternative subpathways and optional reactions); for unstructured pathways, abundance is computed as the average of the top 50% most-abundant reactions in the pathway. Coverage is calculated similarly after converting reaction abundances to measures of reaction detection confidence. These procedures are carried out for the reactions detected in each species, “unclassified” reaction abundance values, and community total abundance values.</p>
    </sec>
    <sec id="S25">
      <title>Evaluation details</title>
      <sec id="S26">
        <title>Simulating metagenomes</title>
        <p id="P47">We defined synthetic metagenome “templates” consisting of lists of species and target relative abundance values. For each species in a template, we selected a random isolate genome of that species from among those represented in ChocoPhlAn. We induced 3% artificial nucleotide sequence mutations in the isolate genomes to approximate the properties of previously unseen isolate genomes of the same species; genomic loci and nucleotide states were sampled randomly during the mutation process. Next, we randomly pulled 5 million 250-nucleotide fragments (substrings) from among those genomes. To guarantee that genome copies in the synthetic metagenome followed the target relative abundance distribution, fragments were pulled from each genome with probability proportional to the product of the genome’s size and corresponding species’ target relative abundance. We converted each fragment to a pair of 100-nucleotide sequencing reads in FASTQ format using ART<sup><xref rid="R51" ref-type="bibr">51</xref></sup> with its Illumina HiSeq 2500 error model (resulting in 10 million total synthetic reads or 1 Gnt).</p>
        <p id="P48">We produced a gene family abundance gold standard by incrementing the abundance of each gene family found in a genome by the product of the genome’s coverage [in reads per kilobase (RPK) units] and the gene family’s copy number. Note that this procedure does not account for random per-gene variation in fragment sampling, which will thus contribute to deviations from the gold standard (and be more marked for low-coverage species). This issue is discussed further in <xref rid="SD1" ref-type="supplementary-material">Supplementary Note 1</xref>. Gold standards for other functional categories (e.g. COGs) were generated by regrouping (summing) the gene family gold standard according to gene family functional annotations in UniProt. Gold standards for pathway coverage and abundance were generated by providing the gene family gold standard as an input file for HUMAnN2. Hence, our pathway-level accuracy assessment measures the influence of gene-level error on pathway quantification, and not the accuracy of assigning pathways to isolate genomes based on their annotated genes.</p>
      </sec>
      <sec id="S27">
        <title>Comparing expected and observed profiles</title>
        <p id="P49">We compared expected and observed gene and pathway abundance profiles at the community level as well as for each contributing species. Comparisons were made after sum-normalizing expected and observed profiles to relative abundance units. Four statistics were used for comparison: <italic>sensitivity</italic>, i.e. the fraction of expected features that were detected by HUMAnN2 (with “detected” defined as non-zero measured abundance); <italic>precision</italic>, the fraction of features detected by HUMAnN2 that were in the expected (gold standard) profile; <italic>overall accuracy</italic>, the fraction of feature abundance that was shared between the expected and observed datasets (1 - Bray-Curtis dissimilarity); and <italic>error mass</italic>, the proportion of total absolute error between the observed and expected profiles attributable to a particular stratification (individual species or “unclassified”).</p>
      </sec>
      <sec id="S28">
        <title>Comparing HUMAnN2 with other methods</title>
        <p id="P50">We profiled the 20-species, synthetic human gut metagenome with HUMAnN2, HUMAnN1<sup><xref rid="R14" ref-type="bibr">14</xref></sup>, COGNIZER<sup><xref rid="R10" ref-type="bibr">10</xref></sup>, ShotMAP<sup><xref rid="R13" ref-type="bibr">13</xref></sup>, and MEGAN<sup><xref rid="R12" ref-type="bibr">12</xref></sup> to generate profiles of COG abundance. HUMAnN2 was run in the default (tiered) mode and also in pure translated search mode against the full UniRef90 protein database. The resulting UniRef90 abundance profiles were converted to COG abundance profiles using the “humann2_regroup_table” script with the UniRef90-to-eggNOG option (which is inclusive of COGs).</p>
        <p id="P51">To analyze the synthetic gut metagenome with HUMAnN1 (updated to use DIAMOND<sup><xref rid="R16" ref-type="bibr">16</xref></sup> for translated search) we constructed a database from HUMAnN1’s default protein sequence collection: the last public release of KEGG (v56)<sup><xref rid="R26" ref-type="bibr">26</xref></sup>. We then aligned the synthetic reads against this database using HUMAnN1’s recommended search parameters (top-20 hits with <italic>E</italic>-value&lt;1.0) while invoking DIAMOND’s “sensitive” mode. The resulting tabular alignment output was provided as input to HUMAnN1. HUMAnN1’s default KEGG Orthogroup (KO) output was converted to COG abundance using a KO-to-COG mapping derived from KEGG v56 (“data/cogc” in the HUMAnN1 installation).</p>
        <p id="P52">We analyzed the synthetic metagenome in COGNIZER using the “-p 4” option, which defines a workflow in which RAPSearch2<sup><xref rid="R17" ref-type="bibr">17</xref></sup> profiles the metagenome against a reduced (non-redundant) COG sequence collection. This workflow was selected to be maximally time-efficient based on evaluations from the COGNIZER publication<sup><xref rid="R10" ref-type="bibr">10</xref></sup>. COGNIZER directly output a COG abundance table for downstream analysis.</p>
        <p id="P53">We created a custom COG database for ShotMAP by supplying “build_shotmap_searchdb.pl” with individual FASTA files containing all UniRef90 sequences annotated to each COG. We used the option “--searchdb-split-size 30000” to split the database into subsets to improve memory efficiency. We then ran ShotMAP with the option “--class-score 31.3” which sets the minimum bit score for an alignment to be included in a family.</p>
        <p id="P54">A DAA file was created for MEGAN by running DIAMOND to align the synthetic metagenome against the full NCBI NR database (downloaded Nov 2, 2016). Using the MEGAN GUI, the DAA file was “meganized” to COG abundance based on MEGAN’s included EggNOG mapping file (June 2016 version). Using the MEGAN GUI EggNOG viewer, we exported COG abundances to a text file for downstream analysis.</p>
        <p id="P55">All runs were carried out in Google Cloud instances of machine type n1-standard-8 (which have 8 cores and 30 GB of memory). To benchmark the runs we captured the elapsed time along with the maximum RSS (resident set size) memory for the main process and all of its subprocesses, including all subprocesses in the process tree which have the main process as the top-most parent. These values were captured and recorded with the “humann2_benchmark” script. For workflows with separate mapping and post-processing steps (HUMAnN1 and MEGAN), elapsed time values encapsulate both steps, while maximum RSS values reflect the maximum across the two steps. Community-level COG abundances were sum-normalized and compared to the synthetic gold standard using the statistics described above.</p>
      </sec>
    </sec>
    <sec id="S29">
      <title>Contributional diversity</title>
      <p id="P56">We calculated contributional diversity for functions by applying traditional ecological similarity measures to the functions’ stratified abundance values. Here, the stratified values were renormalized after excluding “unclassified” abundance prior to computing diversity statistics. Functions with a non-trivial proportion of “unclassified” (&gt;25%) in a non-trivial fraction of samples (&gt;25%) were completely excluded from analysis. We used Gini-Simpson alpha diversity to measure within-sample contributional diversity of a function. This measure can be interpreted as the probability of selecting two “copies” of a function derived from different species, and varies from 0 (single contributor) to 1 (infinite contributors). We used Bray-Curtis beta diversity to measure between-subject contributional diversity of a function. This measure can be interpreted as the fraction of shared contributions between two samples, and varies from 0 (identical contributions) to 1 (no contributors in common). Diversity values for a pathway computed over samples (or sample pairs) were summarized by averaging.</p>
    </sec>
    <sec id="S30">
      <title>Code availability</title>
      <p id="P57">HUMAnN2 is a Python2/3 compatible package. The latest version can be installed via pip or HomeBrew (or installed from source via <ext-link ext-link-type="uri" xlink:href="http://huttenhower.sph.harvard.edu/humann2">http://huttenhower.sph.harvard.edu/humann2</ext-link>). HUMAnN2 is also bundled as part of the bioBakery virtual machine, which is available as a Vagrant Box, a Google Cloud image, and an Amazon Web Services AMI (via <ext-link ext-link-type="uri" xlink:href="http://huttenhower.sph.harvard.edu/biobakery">http://huttenhower.sph.harvard.edu/biobakery</ext-link>). An archive of HUMAnN2 version 0.11.0 of the software (used in the evaluations reported here) is bundled with the publication.</p>
      <p id="P58">The HUMAnN2 package includes 223 unit and functional tests, which run in ~20 minutes to verify successful installation and operation. Once installed, the complete HUMAnN2 workflow can be run with a single command by providing i) an input meta’omic sequencing dataset (fasta/fastq format) and ii) output folder. Four protein databases are available for use with HUMAnN2 (UniRef50 full, UniRef90 full, UniRef50 EC-filtered, UniRef90 EC-filtered). These databases, along with ChocoPhlAn and a collection of useful “utility” mapping files, are downloaded independently of the HUMAnN2 installation using the included “humann2_databases” script. Alternatively, the user can build and run HUMAnN2 with their own custom databases.</p>
      <p id="P59">HUMAnN2 features four “bypass” modes to allow the user to tailor his or her workflow, e.g. including/excluding tiers in the tiered search. A “resume” feature allows the user to bypass compute-intensive sections of the workflow that have already completed while fine-tuning downstream analyses. HUMAnN2 includes 43 command-line arguments to customize runs for a user’s compute environment and to allow for parameter tuning (though a typical user will only interact with the two required “input” and “output” parameters). HUMAnN2 is bundled with a (growing) library of support scripts to facilitate downstream analyses, such as merging and normalizing profiles, regrouping default gene family abundances to other functional categories, combining RNA and DNA profiles to generate “relative expression” measurements, inferring approximate taxonomic assignment for proteins in the “unclassified” stratum, generating strain profiles, and plotting stratified abundances. These and other topics are expanded in detail in HUMAnN2’s user manual: <ext-link ext-link-type="uri" xlink:href="http://huttenhower.sph.harvard.edu/humann2/manual">http://huttenhower.sph.harvard.edu/humann2/manual</ext-link>.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material" id="SM1">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="SD1">
      <label>1</label>
      <media xlink:href="NIHMS1507068-supplement-1.pdf" orientation="portrait" xlink:type="simple" id="d36e1017" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD2">
      <label>2</label>
      <media xlink:href="NIHMS1507068-supplement-2.pdf" orientation="portrait" xlink:type="simple" id="d36e1021" position="anchor"/>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack id="S31">
    <title>ACKNOWLEDGMENTS</title>
    <p id="P60">The authors thank M. Wong, T. Sharpton, and the members of the HUMAnN user group for their feedback on the development and evaluation of HUMAnN2. Funding for this work was provided by NSF 1565100 (to JGC); People Programme (Marie Curie Actions) of the European Union’s Seventh Framework Programme (FP7/2007–2013) under REA grant agreement PCIG13-GA-2013–618833 and by MIUR “Futuro in Ricerca” RBFR13EWWI_001 (to NS); and NIH NIDDK U54DE023798, NSF MCB-1453942, NIH NIDDK P30DK043351, and NSF DBI-1053486 (to CH).</p>
  </ack>
  <fn-group>
    <fn fn-type="COI-statement" id="FN2">
      <p id="P61">COMPETING FINANCIAL INTERESTS</p>
      <p id="P62">None declared.</p>
    </fn>
    <fn id="FN3">
      <p id="P63">DATA AVAILABILITY STATEMENT</p>
      <p id="P64">The Human Microbiome Project (HMP) metagenomes analyzed in this work are available via <ext-link ext-link-type="uri" xlink:href="http://hmpdacc.org">http://hmpdacc.org</ext-link>. The IBDMDB metagenomes and metatranscriptomes analyzed in this work are available via <ext-link ext-link-type="uri" xlink:href="http://ibdmdb.org">http://ibdmdb.org</ext-link>. The Red Sea metagenomes analyzed in this work were previously deposited as NCBI BioProject PRJNA289734. The synthetic metagenomes and metatranscriptomes used in the evaluation of HUMAnN2 and other methods are available from the authors and at <ext-link ext-link-type="uri" xlink:href="http://huttenhower.sph.harvard.edu/humann2">http://huttenhower.sph.harvard.edu/humann2</ext-link>.</p>
    </fn>
  </fn-group>
  <ref-list>
    <title>REFERENCES</title>
    <ref id="R1">
      <label>1.</label>
      <mixed-citation publication-type="journal"><name><surname>Shafquat</surname><given-names>A</given-names></name>, <name><surname>Joice</surname><given-names>R</given-names></name>, <name><surname>Simmons</surname><given-names>SL</given-names></name> &amp; <name><surname>Huttenhower</surname><given-names>C</given-names></name>
<article-title>Functional and phylogenetic assembly of microbial communities in the human microbiome</article-title>. <source>Trends in microbiology</source>
<volume>22</volume>, <fpage>261</fpage>–<lpage>266</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24618403</pub-id></mixed-citation>
    </ref>
    <ref id="R2">
      <label>2.</label>
      <mixed-citation publication-type="journal"><name><surname>Fuhrman</surname><given-names>JA</given-names></name><article-title>Microbial community structure and its functional implications</article-title>. <source>Nature</source><volume>459</volume>, <fpage>193</fpage>–<lpage>199</lpage> (<year>2009</year>).<pub-id pub-id-type="pmid">19444205</pub-id></mixed-citation>
    </ref>
    <ref id="R3">
      <label>3.</label>
      <mixed-citation publication-type="journal"><name><surname>Lloyd-Price</surname><given-names>J</given-names></name>, <name><surname>Abu-Ali</surname><given-names>G</given-names></name> &amp; <name><surname>Huttenhower</surname><given-names>C</given-names></name>
<article-title>The healthy human microbiome</article-title>. <source>Genome medicine</source>
<volume>8</volume>, <fpage>51</fpage> (<year>2016</year>).<pub-id pub-id-type="pmid">27122046</pub-id></mixed-citation>
    </ref>
    <ref id="R4">
      <label>4.</label>
      <mixed-citation publication-type="journal"><name><surname>Franzosa</surname><given-names>EA</given-names></name><etal/><article-title>Sequencing and beyond: integrating molecular ‘omics’ for microbial community profiling</article-title>. <source>Nature reviews. Microbiology</source><volume>13</volume>, <fpage>360</fpage>–<lpage>372</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">25915636</pub-id></mixed-citation>
    </ref>
    <ref id="R5">
      <label>5.</label>
      <mixed-citation publication-type="journal"><name><surname>Segata</surname><given-names>N</given-names></name><etal/><article-title>Metagenomic microbial community profiling using unique clade-specific marker genes</article-title>. <source>Nature methods</source><volume>9</volume>, <fpage>811</fpage>–<lpage>814</lpage> (<year>2012</year>).<pub-id pub-id-type="pmid">22688413</pub-id></mixed-citation>
    </ref>
    <ref id="R6">
      <label>6.</label>
      <mixed-citation publication-type="journal"><name><surname>Sunagawa</surname><given-names>S</given-names></name><etal/><article-title>Metagenomic species profiling using universal phylogenetic marker genes</article-title>. <source>Nature methods</source><volume>10</volume>, <fpage>1196</fpage>–<lpage>1199</lpage> (<year>2013</year>).<pub-id pub-id-type="pmid">24141494</pub-id></mixed-citation>
    </ref>
    <ref id="R7">
      <label>7.</label>
      <mixed-citation publication-type="journal"><name><surname>Silva</surname><given-names>GG</given-names></name>, <name><surname>Green</surname><given-names>KT</given-names></name>, <name><surname>Dutilh</surname><given-names>BE</given-names></name> &amp; <name><surname>Edwards</surname><given-names>RA</given-names></name>
<article-title>SUPER-FOCUS: a tool for agile functional analysis of shotgun metagenomic data</article-title>. <source>Bioinformatics (Oxford, England)</source>
<volume>32</volume>, <fpage>354</fpage>–<lpage>361</lpage> (<year>2016</year>).</mixed-citation>
    </ref>
    <ref id="R8">
      <label>8.</label>
      <mixed-citation publication-type="journal"><name><surname>Sharma</surname><given-names>AK</given-names></name>, <name><surname>Gupta</surname><given-names>A</given-names></name>, <name><surname>Kumar</surname><given-names>S</given-names></name>, <name><surname>Dhakan</surname><given-names>DB</given-names></name> &amp; <name><surname>Sharma</surname><given-names>VK</given-names></name>
<article-title>Woods: A fast and accurate functional annotator and classifier of genomic and metagenomic sequences</article-title>. <source>Genomics</source>
<volume>106</volume>, <fpage>1</fpage>–<lpage>6</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">25863333</pub-id></mixed-citation>
    </ref>
    <ref id="R9">
      <label>9.</label>
      <mixed-citation publication-type="journal"><name><surname>Petrenko</surname><given-names>P</given-names></name>, <name><surname>Lobb</surname><given-names>B</given-names></name>, <name><surname>Kurtz</surname><given-names>DA</given-names></name>, <name><surname>Neufeld</surname><given-names>JD</given-names></name> &amp; <name><surname>Doxey</surname><given-names>AC</given-names></name>
<article-title>MetAnnotate: function-specific taxonomic profiling and comparison of metagenomes</article-title>. <source>BMC biology</source>
<volume>13</volume>, <fpage>92</fpage> (<year>2015</year>).<pub-id pub-id-type="pmid">26541816</pub-id></mixed-citation>
    </ref>
    <ref id="R10">
      <label>10.</label>
      <mixed-citation publication-type="journal"><name><surname>Bose</surname><given-names>T</given-names></name>, <name><surname>Haque</surname><given-names>MM</given-names></name>, <name><surname>Reddy</surname><given-names>C</given-names></name> &amp; <name><surname>Mande</surname><given-names>SS</given-names></name>
<article-title>COGNIZER: A Framework for Functional Annotation of Metagenomic Datasets</article-title>. <source>PloS one</source>
<volume>10</volume>, <fpage>e0142102</fpage> (<year>2015</year>).<pub-id pub-id-type="pmid">26561344</pub-id></mixed-citation>
    </ref>
    <ref id="R11">
      <label>11.</label>
      <mixed-citation publication-type="journal"><name><surname>Kim</surname><given-names>J</given-names></name>, <name><surname>Kim</surname><given-names>MS</given-names></name>, <name><surname>Koh</surname><given-names>AY</given-names></name>, <name><surname>Xie</surname><given-names>Y</given-names></name> &amp; <name><surname>Zhan</surname><given-names>X</given-names></name>
<article-title>FMAP: Functional Mapping and Analysis Pipeline for metagenomics and metatranscriptomics studies</article-title>. <source>BMC bioinformatics</source>
<volume>17</volume>, <fpage>420</fpage> (<year>2016</year>).<pub-id pub-id-type="pmid">27724866</pub-id></mixed-citation>
    </ref>
    <ref id="R12">
      <label>12.</label>
      <mixed-citation publication-type="journal"><name><surname>Huson</surname><given-names>DH</given-names></name><etal/><article-title>MEGAN Community Edition - Interactive Exploration and Analysis of Large-Scale Microbiome Sequencing Data</article-title>. <source>PLoS computational biology</source><volume>12</volume>, <fpage>e1004957</fpage> (<year>2016</year>).<pub-id pub-id-type="pmid">27327495</pub-id></mixed-citation>
    </ref>
    <ref id="R13">
      <label>13.</label>
      <mixed-citation publication-type="journal"><name><surname>Nayfach</surname><given-names>S</given-names></name><etal/><article-title>Automated and Accurate Estimation of Gene Family Abundance from Shotgun Metagenomes</article-title>. <source>PLoS computational biology</source><volume>11</volume>, <fpage>e1004573</fpage> (<year>2015</year>).<pub-id pub-id-type="pmid">26565399</pub-id></mixed-citation>
    </ref>
    <ref id="R14">
      <label>14.</label>
      <mixed-citation publication-type="journal"><name><surname>Abubucker</surname><given-names>S</given-names></name><etal/><article-title>Metabolic reconstruction for metagenomic data and its application to the human microbiome</article-title>. <source>PLoS computational biology</source><volume>8</volume>, <fpage>e1002358</fpage> (<year>2012</year>).<pub-id pub-id-type="pmid">22719234</pub-id></mixed-citation>
    </ref>
    <ref id="R15">
      <label>15.</label>
      <mixed-citation publication-type="journal"><collab>Human Microbiome Project Consortium</collab>. <article-title>Structure, function and diversity of the healthy human microbiome</article-title>. <source>Nature</source><volume>486</volume>, <fpage>207</fpage>–<lpage>214</lpage> (<year>2012</year>).<pub-id pub-id-type="pmid">22699609</pub-id></mixed-citation>
    </ref>
    <ref id="R16">
      <label>16.</label>
      <mixed-citation publication-type="journal"><name><surname>Buchfink</surname><given-names>B</given-names></name>, <name><surname>Xie</surname><given-names>C</given-names></name> &amp; <name><surname>Huson</surname><given-names>DH</given-names></name>
<article-title>Fast and sensitive protein alignment using DIAMOND</article-title>. <source>Nature methods</source>
<volume>12</volume>, <fpage>59</fpage>–<lpage>60</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">25402007</pub-id></mixed-citation>
    </ref>
    <ref id="R17">
      <label>17.</label>
      <mixed-citation publication-type="journal"><name><surname>Zhao</surname><given-names>Y</given-names></name>, <name><surname>Tang</surname><given-names>H</given-names></name> &amp; <name><surname>Ye</surname><given-names>Y</given-names></name>
<article-title>RAPSearch2: a fast and memory-efficient protein similarity search tool for next-generation sequencing data</article-title>. <source>Bioinformatics (Oxford, England)</source>
<volume>28</volume>, <fpage>125</fpage>–<lpage>126</lpage> (<year>2012</year>).</mixed-citation>
    </ref>
    <ref id="R18">
      <label>18.</label>
      <mixed-citation publication-type="journal"><name><surname>Hauswedell</surname><given-names>H</given-names></name>, <name><surname>Singer</surname><given-names>J</given-names></name> &amp; <name><surname>Reinert</surname><given-names>K</given-names></name>
<article-title>Lambda: the local aligner for massive biological data</article-title>. <source>Bioinformatics (Oxford, England)</source>
<volume>30</volume>, <fpage>i349</fpage>–<lpage>355</lpage> (<year>2014</year>).</mixed-citation>
    </ref>
    <ref id="R19">
      <label>19.</label>
      <mixed-citation publication-type="journal"><name><surname>Truong</surname><given-names>DT</given-names></name>, <name><surname>Tett</surname><given-names>A</given-names></name>, <name><surname>Pasolli</surname><given-names>E</given-names></name>, <name><surname>Huttenhower</surname><given-names>C</given-names></name> &amp; <name><surname>Segata</surname><given-names>N</given-names></name>
<article-title>Microbial strain-level population structure and genetic diversity from metagenomes</article-title>. <source>Genome research</source>. <volume>27</volume>, <fpage>626</fpage>–<lpage>638</lpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28167665</pub-id></mixed-citation>
    </ref>
    <ref id="R20">
      <label>20.</label>
      <mixed-citation publication-type="journal"><name><surname>Scholz</surname><given-names>M</given-names></name><etal/><article-title>Strain-level microbial epidemiology and population genomics from shotgun metagenomics</article-title>. <source>Nature methods</source><volume>13</volume>, <fpage>435</fpage>–<lpage>438</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">26999001</pub-id></mixed-citation>
    </ref>
    <ref id="R21">
      <label>21.</label>
      <mixed-citation publication-type="journal"><name><surname>Luo</surname><given-names>C</given-names></name><etal/><article-title>ConStrains identifies microbial strains in metagenomic datasets</article-title>. <source>Nature biotechnology</source><volume>33</volume>, <fpage>1045</fpage>–<lpage>1052</lpage> (<year>2015</year>).</mixed-citation>
    </ref>
    <ref id="R22">
      <label>22.</label>
      <mixed-citation publication-type="journal"><name><surname>Truong</surname><given-names>DT</given-names></name><etal/><article-title>MetaPhlAn2 for enhanced metagenomic taxonomic profiling</article-title>. <source>Nature methods</source><volume>12</volume>, <fpage>902</fpage>–<lpage>903</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">26418763</pub-id></mixed-citation>
    </ref>
    <ref id="R23">
      <label>23.</label>
      <mixed-citation publication-type="journal"><name><surname>Medini</surname><given-names>D</given-names></name>, <name><surname>Donati</surname><given-names>C</given-names></name>, <name><surname>Tettelin</surname><given-names>H</given-names></name>, <name><surname>Masignani</surname><given-names>V</given-names></name> &amp; <name><surname>Rappuoli</surname><given-names>R</given-names></name>
<article-title>The microbial pan-genome</article-title>. <source>Current opinion in genetics &amp; development</source>
<volume>15</volume>, <fpage>589</fpage>–<lpage>594</lpage> (<year>2005</year>).<pub-id pub-id-type="pmid">16185861</pub-id></mixed-citation>
    </ref>
    <ref id="R24">
      <label>24.</label>
      <mixed-citation publication-type="journal"><name><surname>Suzek</surname><given-names>BE</given-names></name>, <name><surname>Wang</surname><given-names>Y</given-names></name>, <name><surname>Huang</surname><given-names>H</given-names></name>, <name><surname>McGarvey</surname><given-names>PB</given-names></name> &amp; <name><surname>Wu</surname><given-names>CH</given-names></name>
<article-title>UniRef clusters: a comprehensive and scalable alternative for improving sequence similarity searches</article-title>. <source>Bioinformatics (Oxford, England)</source>
<volume>31</volume>, <fpage>926</fpage>–<lpage>932</lpage> (<year>2015</year>).</mixed-citation>
    </ref>
    <ref id="R25">
      <label>25.</label>
      <mixed-citation publication-type="journal"><name><surname>Galperin</surname><given-names>MY</given-names></name>, <name><surname>Makarova</surname><given-names>KS</given-names></name>, <name><surname>Wolf</surname><given-names>YI</given-names></name> &amp; <name><surname>Koonin</surname><given-names>EV</given-names></name>
<article-title>Expanded microbial genome coverage and improved protein family annotation in the COG database</article-title>. <source>Nucleic acids research</source>
<volume>43</volume>, <fpage>D261</fpage>–<lpage>269</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">25428365</pub-id></mixed-citation>
    </ref>
    <ref id="R26">
      <label>26.</label>
      <mixed-citation publication-type="journal"><name><surname>Kanehisa</surname><given-names>M</given-names></name>, <name><surname>Sato</surname><given-names>Y</given-names></name>, <name><surname>Kawashima</surname><given-names>M</given-names></name>, <name><surname>Furumichi</surname><given-names>M</given-names></name> &amp; <name><surname>Tanabe</surname><given-names>M</given-names></name>
<article-title>KEGG as a reference resource for gene and protein annotation</article-title>. <source>Nucleic acids research</source>
<volume>44</volume>, <fpage>D457</fpage>–<lpage>462</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">26476454</pub-id></mixed-citation>
    </ref>
    <ref id="R27">
      <label>27.</label>
      <mixed-citation publication-type="journal"><name><surname>Finn</surname><given-names>RD</given-names></name><etal/><article-title>The Pfam protein families database: towards a more sustainable future</article-title>. <source>Nucleic acids research</source><volume>44</volume>, <fpage>D279</fpage>–<lpage>285</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">26673716</pub-id></mixed-citation>
    </ref>
    <ref id="R28">
      <label>28.</label>
      <mixed-citation publication-type="journal"><collab>Gene Ontology Consortium</collab>. <article-title>Gene Ontology Consortium: going forward</article-title>. <source>Nucleic acids research</source><volume>43</volume>, <fpage>D1049</fpage>–<lpage>1056</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">25428369</pub-id></mixed-citation>
    </ref>
    <ref id="R29">
      <label>29.</label>
      <mixed-citation publication-type="journal"><name><surname>Caspi</surname><given-names>R</given-names></name><etal/><article-title>The MetaCyc database of metabolic pathways and enzymes and the BioCyc collection of pathway/genome databases</article-title>. <source>Nucleic acids research</source><volume>44</volume>, <fpage>D471</fpage>–<lpage>480</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">26527732</pub-id></mixed-citation>
    </ref>
    <ref id="R30">
      <label>30.</label>
      <mixed-citation publication-type="journal"><name><surname>Lloyd-Price</surname><given-names>J</given-names></name><etal/><article-title>Strains, functions and dynamics in the expanded Human Microbiome Project</article-title>. <source>Nature</source><volume>550</volume>, <fpage>61</fpage>–<lpage>66</lpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28953883</pub-id></mixed-citation>
    </ref>
    <ref id="R31">
      <label>31.</label>
      <mixed-citation publication-type="journal"><name><surname>Sczyrba</surname><given-names>A</given-names></name><etal/><article-title>Critical Assessment of Metagenome Interpretation-a benchmark of metagenomics software</article-title>. <source>Nature methods</source><volume>14</volume>, <fpage>1063</fpage>–<lpage>1071</lpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28967888</pub-id></mixed-citation>
    </ref>
    <ref id="R32">
      <label>32.</label>
      <mixed-citation publication-type="journal"><name><surname>Hamady</surname><given-names>M</given-names></name> &amp; <name><surname>Knight</surname><given-names>R</given-names></name>
<article-title>Microbial community profiling for human microbiome projects: Tools, techniques, and challenges</article-title>. <source>Genome research</source>
<volume>19</volume>, <fpage>1141</fpage>–<lpage>1152</lpage> (<year>2009</year>).<pub-id pub-id-type="pmid">19383763</pub-id></mixed-citation>
    </ref>
    <ref id="R33">
      <label>33.</label>
      <mixed-citation publication-type="journal"><name><surname>Ravel</surname><given-names>J</given-names></name><etal/><article-title>Vaginal microbiome of reproductive-age women</article-title>. <source>Proceedings of the National Academy of Sciences of the United States of America</source><volume>108</volume><issue>Suppl 1</issue>, <fpage>4680</fpage>–<lpage>4687</lpage> (<year>2011</year>).<pub-id pub-id-type="pmid">20534435</pub-id></mixed-citation>
    </ref>
    <ref id="R34">
      <label>34.</label>
      <mixed-citation publication-type="journal"><name><surname>Thompson</surname><given-names>LR</given-names></name><etal/><article-title>Metagenomic covariation along densely sampled environmental gradients in the Red Sea</article-title>. <source>The ISME journal</source> (<year>2016</year>).</mixed-citation>
    </ref>
    <ref id="R35">
      <label>35.</label>
      <mixed-citation publication-type="journal"><name><surname>Sunagawa</surname><given-names>S</given-names></name><etal/><article-title>Ocean plankton. Structure and function of the global ocean microbiome</article-title>. <source>Science (New York, N.Y.)</source><volume>348</volume>, <fpage>1261359</fpage> (<year>2015</year>).</mixed-citation>
    </ref>
    <ref id="R36">
      <label>36.</label>
      <mixed-citation publication-type="journal"><name><surname>Swan</surname><given-names>BK</given-names></name><etal/><article-title>Genomic and metabolic diversity of Marine Group I Thaumarchaeota in the mesopelagic of two subtropical gyres</article-title>. <source>PloS one</source><volume>9</volume>, <fpage>e95380</fpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24743558</pub-id></mixed-citation>
    </ref>
    <ref id="R37">
      <label>37.</label>
      <mixed-citation publication-type="journal"><name><surname>Thompson</surname><given-names>LR</given-names></name><etal/><article-title>Phage auxiliary metabolic genes and the redirection of cyanobacterial host carbon metabolism</article-title>. <source>Proceedings of the National Academy of Sciences of the United States of America</source><volume>108</volume>, <fpage>E757</fpage>–<lpage>764</lpage> (<year>2011</year>).<pub-id pub-id-type="pmid">21844365</pub-id></mixed-citation>
    </ref>
    <ref id="R38">
      <label>38.</label>
      <mixed-citation publication-type="journal"><name><surname>Integrative</surname><given-names>HMP</given-names></name><article-title>(iHMP) Research Network Consortium. The Integrative Human Microbiome Project: dynamic analysis of microbiome-host omics profiles during periods of human health and disease</article-title>. <source>Cell host &amp; microbe</source><volume>16</volume>, <fpage>276</fpage>–<lpage>289</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">25211071</pub-id></mixed-citation>
    </ref>
    <ref id="R39">
      <label>39.</label>
      <mixed-citation publication-type="journal"><name><surname>Franzosa</surname><given-names>EA</given-names></name><etal/><article-title>Relating the metatranscriptome and metagenome of the human gut</article-title>. <source>Proceedings of the National Academy of Sciences of the United States of America</source><volume>111</volume>, <fpage>E2329</fpage>–<lpage>2338</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24843156</pub-id></mixed-citation>
    </ref>
    <ref id="R40">
      <label>40.</label>
      <mixed-citation publication-type="journal"><name><surname>Turnbaugh</surname><given-names>PJ</given-names></name><etal/><article-title>A core gut microbiome in obese and lean twins</article-title>. <source>Nature</source><volume>457</volume>, <fpage>480</fpage>–<lpage>484</lpage> (<year>2009</year>).<pub-id pub-id-type="pmid">19043404</pub-id></mixed-citation>
    </ref>
    <ref id="R41">
      <label>41.</label>
      <mixed-citation publication-type="journal"><name><surname>Burke</surname><given-names>C</given-names></name>, <name><surname>Steinberg</surname><given-names>P</given-names></name>, <name><surname>Rusch</surname><given-names>D</given-names></name>, <name><surname>Kjelleberg</surname><given-names>S</given-names></name> &amp; <name><surname>Thomas</surname><given-names>T</given-names></name>
<article-title>Bacterial community assembly based on functional genes rather than species</article-title>. <source>Proceedings of the National Academy of Sciences of the United States of America</source>
<volume>108</volume>, <fpage>14288</fpage>–<lpage>14293</lpage> (<year>2011</year>).<pub-id pub-id-type="pmid">21825123</pub-id></mixed-citation>
    </ref>
    <ref id="R42">
      <label>42.</label>
      <mixed-citation publication-type="journal"><name><surname>Duran-Pinedo</surname><given-names>AE</given-names></name><etal/><article-title>Community-wide transcriptome of the oral microbiome in subjects with and without periodontitis</article-title>. <source>The ISME journal</source><volume>8</volume>, <fpage>1659</fpage>–<lpage>1672</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24599074</pub-id></mixed-citation>
    </ref>
    <ref id="R43">
      <label>43.</label>
      <mixed-citation publication-type="journal"><name><surname>Mason</surname><given-names>OU</given-names></name><etal/><article-title>Metagenome, metatranscriptome and single-cell sequencing reveal microbial response to Deepwater Horizon oil spill</article-title>. <source>The ISME journal</source><volume>6</volume>, <fpage>1715</fpage>–<lpage>1727</lpage> (<year>2012</year>).<pub-id pub-id-type="pmid">22717885</pub-id></mixed-citation>
    </ref>
    <ref id="R44">
      <label>44.</label>
      <mixed-citation publication-type="journal"><name><surname>Pasolli</surname><given-names>E</given-names></name>, <name><surname>Truong</surname><given-names>DT</given-names></name>, <name><surname>Malik</surname><given-names>F</given-names></name>, <name><surname>Waldron</surname><given-names>L</given-names></name> &amp; <name><surname>Segata</surname><given-names>N</given-names></name>
<article-title>Machine Learning Meta-analysis of Large Metagenomic Datasets: Tools and Biological Insights</article-title>. <source>PLoS computational biology</source>
<volume>12</volume>, <fpage>e1004977</fpage> (<year>2016</year>).<pub-id pub-id-type="pmid">27400279</pub-id></mixed-citation>
    </ref>
    <ref id="R45">
      <label>45.</label>
      <mixed-citation publication-type="journal"><collab>Consortium UniProt</collab>. <article-title>UniProt: a hub for protein information</article-title>. <source>Nucleic acids research</source><volume>43</volume>, <fpage>D204</fpage>–<lpage>212</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">25348405</pub-id></mixed-citation>
    </ref>
    <ref id="R46">
      <label>46.</label>
      <mixed-citation publication-type="journal"><name><surname>Huang</surname><given-names>K</given-names></name><etal/><article-title>MetaRef: a pan-genomic database for comparative and community microbial genomics</article-title>. <source>Nucleic acids research</source><volume>42</volume>, <fpage>D617</fpage>–<lpage>624</lpage> (<year>2014</year>).<pub-id pub-id-type="pmid">24203705</pub-id></mixed-citation>
    </ref>
    <ref id="R47">
      <label>47.</label>
      <mixed-citation publication-type="journal"><name><surname>Segata</surname><given-names>N</given-names></name>, <name><surname>Bornigen</surname><given-names>D</given-names></name>, <name><surname>Morgan</surname><given-names>XC</given-names></name> &amp; <name><surname>Huttenhower</surname><given-names>C</given-names></name>
<article-title>PhyloPhlAn is a new method for improved phylogenetic and taxonomic placement of microbes</article-title>. <source>Nature communications</source>
<volume>4</volume>, <fpage>2304</fpage> (<year>2013</year>).</mixed-citation>
    </ref>
    <ref id="R48">
      <label>48.</label>
      <mixed-citation publication-type="journal"><name><surname>Edgar</surname><given-names>RC</given-names></name><article-title>Search and clustering orders of magnitude faster than BLAST</article-title>. <source>Bioinformatics (Oxford, England)</source><volume>26</volume>, <fpage>2460</fpage>–<lpage>2461</lpage> (<year>2010</year>).</mixed-citation>
    </ref>
    <ref id="R49">
      <label>49.</label>
      <mixed-citation publication-type="journal"><name><surname>Langmead</surname><given-names>B</given-names></name> &amp; <name><surname>Salzberg</surname><given-names>SL</given-names></name>
<article-title>Fast gapped-read alignment with Bowtie 2</article-title>. <source>Nature methods</source>
<volume>9</volume>, <fpage>357</fpage>–<lpage>359</lpage> (<year>2012</year>).<pub-id pub-id-type="pmid">22388286</pub-id></mixed-citation>
    </ref>
    <ref id="R50">
      <label>50.</label>
      <mixed-citation publication-type="journal"><name><surname>Ye</surname><given-names>Y</given-names></name> &amp; <name><surname>Doak</surname><given-names>TG</given-names></name>
<article-title>A parsimony approach to biological pathway reconstruction/inference for genomes and metagenomes</article-title>. <source>PLoS computational biology</source>
<volume>5</volume>, <fpage>e1000465</fpage> (<year>2009</year>).<pub-id pub-id-type="pmid">19680427</pub-id></mixed-citation>
    </ref>
    <ref id="R51">
      <label>51.</label>
      <mixed-citation publication-type="journal"><name><surname>Huang</surname><given-names>W</given-names></name>, <name><surname>Li</surname><given-names>L</given-names></name>, <name><surname>Myers</surname><given-names>JR</given-names></name> &amp; <name><surname>Marth</surname><given-names>GT</given-names></name>
<article-title>ART: a next-generation sequencing read simulator</article-title>. <source>Bioinformatics (Oxford, England)</source>
<volume>28</volume>, <fpage>593</fpage>–<lpage>594</lpage> (<year>2012</year>).</mixed-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig id="F1" orientation="portrait" position="float">
    <label>Figure 1:</label>
    <caption>
      <title>HUMAnN2 functionally profiles microbial communities with high accuracy using tiered search.</title>
      <p id="P65">(<bold>a</bold>) Overview of HUMAnN2’s tiered search algorithm for meta’omic functional profiling (expanded in <xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 1</xref>). (<bold>b</bold>) HUMAnN2’s tiered search vs. pure translated search evaluated on a synthetic gut metagenome. Sensitivity, precision, and overall accuracy (1 - Bray-Curtis dissimilarity) were computed for (<bold>c</bold>) gene family and (<bold>d</bold>) pathway abundance profiles relative to gold standards at the whole-community level (“overall”) and for each stratification. (<bold>e</bold>) HUMAnN2 compared with other methods in the task of quantifying community-total COG abundances. Runtimes reflect multi-threaded execution on 8 CPU cores.</p>
    </caption>
    <graphic xlink:href="nihms-1507068-f0001"/>
  </fig>
  <fig id="F2" orientation="portrait" position="float">
    <label>Figure 2:</label>
    <caption>
      <title>Contributional diversity of core human microbiome pathways.</title>
      <p id="P66">(<bold>a</bold>) Within- and between- sample contributional diversity for core metabolic pathways (individual points) from HMP metagenomes. Stars indicate background species-level whole-community diversity. (<bold>b</bold>-<bold>e</bold>) Examples of pathways with “extreme” diversity patterns. The top of each set of stacked bars indicates the total stratified abundance of the pathway within a single sample (log-scaled). Species and “unclassified” stratifications are linearly (proportionally) scaled within the total bar height.</p>
    </caption>
    <graphic xlink:href="nihms-1507068-f0002"/>
  </fig>
  <fig id="F3" orientation="portrait" position="float">
    <label>Figure 3:</label>
    <caption>
      <title>Thermocline-associated microbial enzymes in the marine pelagic zone.</title>
      <p id="P67">(<bold>a</bold>-<bold>e</bold>) Examples of KEGG Orthogroups (KOs) demonstrating strong temperature associations across 45 Red Sea metagenomes; all were newly quantified by HUMAnN2 relative to the samples’ initial publication. (<bold>f</bold>) Pearson correlations for 4,609 KOs that were quantified by both HUMAnN2 and HUMAnN1. “GAIW” indicates “Gulf of Aden Intermediate Water”: a cool nutrient-rich water mass within the Red Sea. The <italic>n</italic>=45 total samples in (f) are subdivided by depth layers (the sample from 258 m was grouped with the 500-m samples) and colored by latitude. From smallest to largest, box plot elements represent the lower inner fence, first quartile, median, third quartile, and upper inner fence.</p>
    </caption>
    <graphic xlink:href="nihms-1507068-f0003"/>
  </fig>
  <fig id="F4" orientation="portrait" position="float">
    <label>Figure 4:</label>
    <caption>
      <title>Metatranscriptomic functional profiling and multi’omic data integration with HUMAnN2.</title>
      <p id="P68">(<bold>a</bold>) Average within-sample metagenomic (DNA) versus metatranscriptomic (RNA) contributional diversities for <italic>n</italic>=181 core pathways profiled from 78 paired inflammatory bowel disease (IBD) meta’omes from the IBDMDB cohort. Pathways are colored by “relative expression” (RNA:DNA ratio). (<bold>b</bold>) Sucrose degradation (outlined in ‘a’) is a prevalent pathway with high within-subject contributional diversity at the DNA level but low within-subject contributional diversity at the RNA level. This pattern was conserved across three IBD phenotypes: Crohn’s disease (CD), ulcerative colitis (UC), and non-IBD controls. Species’ contributions were rescaled to sum to 1 within each sample (set of stacked bars).</p>
    </caption>
    <graphic xlink:href="nihms-1507068-f0004"/>
  </fig>
</floats-group>
