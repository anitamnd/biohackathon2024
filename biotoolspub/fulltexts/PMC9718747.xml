<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Commun</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Commun</journal-id>
    <journal-title-group>
      <journal-title>Nature Communications</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2041-1723</issn>
    <publisher>
      <publisher-name>Nature Publishing Group UK</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">9718747</article-id>
    <article-id pub-id-type="publisher-id">35231</article-id>
    <article-id pub-id-type="doi">10.1038/s41467-022-35231-3</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Reference panel guided topological structure annotation of Hi-C data</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Zhang</surname>
          <given-names>Yanlin</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1"/>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-9555-860X</contrib-id>
        <name>
          <surname>Blanchette</surname>
          <given-names>Mathieu</given-names>
        </name>
        <address>
          <email>blanchem@cs.mcgill.ca</email>
        </address>
        <xref ref-type="aff" rid="Aff1"/>
      </contrib>
      <aff id="Aff1"><institution-wrap><institution-id institution-id-type="GRID">grid.14709.3b</institution-id><institution-id institution-id-type="ISNI">0000 0004 1936 8649</institution-id><institution>School of Computer Science, </institution><institution>McGill University, </institution></institution-wrap>Montréal, Québec H3A 0E9 Canada </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>2</day>
      <month>12</month>
      <year>2022</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>2</day>
      <month>12</month>
      <year>2022</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2022</year>
    </pub-date>
    <volume>13</volume>
    <elocation-id>7426</elocation-id>
    <history>
      <date date-type="received">
        <day>10</day>
        <month>8</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>22</day>
        <month>11</month>
        <year>2022</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2022</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Accurately annotating topological structures (e.g., loops and topologically associating domains) from Hi-C data is critical for understanding the role of 3D genome organization in gene regulation. This is a challenging task, especially at high resolution, in part due to the limited sequencing coverage of Hi-C data. Current approaches focus on the analysis of individual Hi-C data sets of interest, without taking advantage of the facts that (i) several hundred Hi-C contact maps are publicly available, and (ii) the vast majority of topological structures are conserved across multiple cell types. Here, we present RefHiC, an attention-based deep learning framework that uses a reference panel of Hi-C datasets to facilitate topological structure annotation from a given study sample. We compare RefHiC against tools that do not use reference samples and find that RefHiC outperforms other programs at both topological associating domain and loop annotation across different cell types, species, and sequencing depths.</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">Predicting topological structures from Hi-C data provides insight into comprehending gene expression and regulation. Here, the authors present RefHiC, an attention-based deep learning framework that leverages a reference panel of Hi-C datasets to assist topological structure annotation from a given study sample.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Chromatin structure</kwd>
      <kwd>Genome informatics</kwd>
      <kwd>Machine learning</kwd>
      <kwd>Data integration</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/501100003151</institution-id>
            <institution>Fonds de Recherche du Québec - Nature et Technologies (Quebec Fund for Research in Nature and Technology)</institution>
          </institution-wrap>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Genome Quebec, Oncopole, IVADO</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2022</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1" sec-type="introduction">
    <title>Introduction</title>
    <p id="Par3">Chromosome conformation capture assays such as Hi-C<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, and micro-C<sup><xref ref-type="bibr" rid="CR2">2</xref></sup> have been developed to measure the spatial proximity between DNA fragments in genomes as average pairwise contact frequency in cell populations. These approaches have revealed a hierarchical spatial organization of topological structures of the genome inside nuclei. Among them, topological associating domains (TADs) are kilo- to mega-scale regions with strong interactions between DNA fragments within the same domain and weaker interactions across domains<sup><xref ref-type="bibr" rid="CR3">3</xref></sup>. Loops bring into contact distant loci such as promoters and enhancers<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>. These topological structures are dynamic both within cells<sup><xref ref-type="bibr" rid="CR5">5</xref></sup> and during cellular differentiation<sup><xref ref-type="bibr" rid="CR6">6</xref></sup>. They are essential components of gene regulation.</p>
    <p id="Par4">While Hi-C and its variants remain the most popular approaches to map chromatin contacts on a genome-wide scale, the analysis of the data they produce is challenging, in large part due to the moderate sequencing depth (typically 200–500 Million valid read pairs) compared to the size of the contact frequency matrices that need to be estimated. Numerous TAD annotation tools exist that rely on various statistical significance tests<sup><xref ref-type="bibr" rid="CR7">7</xref>–<xref ref-type="bibr" rid="CR9">9</xref></sup>. This includes the popular Insulation score (IS)<sup><xref ref-type="bibr" rid="CR10">10</xref></sup>, a widely used approach for TAD boundary detection, and more robust variants such as RobusTAD<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>. Still, the performance of all of these approaches is relatively poor, especially at low coverage, due to stochastic noise and biases<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>. Loop detection is even more challenging<sup><xref ref-type="bibr" rid="CR4">4</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup> due to their small size in contact maps. Fit-Hi-C<sup><xref ref-type="bibr" rid="CR13">13</xref></sup> and HiC-DC<sup><xref ref-type="bibr" rid="CR14">14</xref></sup> fit a global model to estimate the background distribution of the contact frequency and identify statistically significant contact pairs by comparing observed values to expected values from the fitted model. These global enrichment approaches evaluate each contact pair independently without modeling neighboring patterns and identify loop clusters instead of discrete loops. In contrast, HiCCUPS<sup><xref ref-type="bibr" rid="CR4">4</xref></sup> compares each contact pair to surrounding regions and identifies locally enriched contact pairs as loops. It requires users to set several sequencing depth sensitive parameters and can only detect loops that satisfy the user defined filtering criteria. Both loop and TAD predictions have been shown to benefit from prior smoothing of Hi-C matrices, e.g., using HIFI<sup><xref ref-type="bibr" rid="CR15">15</xref></sup>.</p>
    <p id="Par5">Recent approaches tackle topological structure annotations using computer vision and machine learning techniques. For instance, Mustache<sup><xref ref-type="bibr" rid="CR16">16</xref></sup> treats chromatin loop recognition as a blob-shaped object detection problem. Chromosight<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> employs expert-designed templates to represent each type of topological structures. These generic pattern-based approaches work well on data with sufficient contact pairs but underperform at low sequencing depth. In contrast, Peakachu<sup><xref ref-type="bibr" rid="CR12">12</xref></sup> is a supervised learning approach trained to recognize loops using data from orthogonal experiments as target values.</p>
    <p id="Par6">Many approaches have been introduced to address the issue of insufficient sequencing depth. Grinch<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> proposed a graph-regularized non-negative matrix factorization algorithm to smooth sparse Hi-C contact map while detecting TADs. DeepLoop<sup><xref ref-type="bibr" rid="CR19">19</xref></sup> identifies significant interactions from sparse Hi-C contact maps by denoising and enhancing loop signals with a neural network. Higashi<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>, a single-cell Hi-C data analysis tool, represents a cohort of scHi-C data as a hypergraph, learns to predict missing hyperedge to impute missing interaction, and then performs structural annotation on imputation.</p>
    <p id="Par7">A common strategy in analyzing biological data is to complement data about the sample of interest with data of the same type obtained previously for other samples. This strategy has proven effective for genotype imputation<sup><xref ref-type="bibr" rid="CR21">21</xref></sup> and phasing<sup><xref ref-type="bibr" rid="CR22">22</xref></sup>, as well as protein structure prediction<sup><xref ref-type="bibr" rid="CR23">23</xref></sup>, among others. Even though hundreds of Hi-C experiments have been conducted, they have never been analyzed jointly for topological structure annotation. Here we introduce RefHiC, a reference panel informed deep learning approach for topological structure (loop and TAD) annotation from Hi-C data. RefHiC uses a reference panel that contains high-quality Hi-C data of different cell types. For each potential contact in the study sample, it uses an attention mechanism<sup><xref ref-type="bibr" rid="CR24">24</xref></sup> that determines which of the reference samples are most relevant, and then makes a prediction based on the combined study sample and attention-weighted reference samples. We demonstrate that RefHiC enables significant accuracy and robustness gains, across cell types, species, and coverage levels.</p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>Overview of RefHiC</title>
      <p id="Par8">RefHiC takes as input a Hi-C contact map for a study sample and a reference panel of Hi-C contact maps (provided with the tool). It produces highly reliable loop or TAD boundary annotations for the study sample. RefHiC is based on two components (Fig. <xref rid="Fig1" ref-type="fig">1</xref> and “Methods”): (i) a neural network predicts loop (resp. TAD boundary) scores for every candidate pair (resp. locus) based on the local contact sub-matrix, combining information from the study sample and the reference panel; (ii) a task-specific component selects one representative loop/TAD boundary from each high-scoring cluster. For human, the reference panel contains 30 uniformly processed Hi-C contact maps, each with at least 350 million contact pairs (Supplementary Table <xref rid="MOESM1" ref-type="media">1)</xref>. For mouse, it consists of 20 such maps (Supplementary Table <xref rid="MOESM1" ref-type="media">2)</xref>. Normalization of reference Hi-C samples is unnecessary as the network automatically learns to handle batch effect and coverage differences from the training data.<fig id="Fig1"><label>Fig. 1</label><caption><title>RefHiC architecture.</title><p>Overview of the RefHiC neural network for loop and TAD boundary scoring, followed by clustering or peak finding algorithm for discrete loop and TAD predictions (shown as blue circles).</p></caption><graphic xlink:href="41467_2022_35231_Fig1_HTML" id="d32e354"/></fig></p>
      <p id="Par9">To obtain a loop or TAD boundary score for bin pair (<italic>i</italic>, <italic>j</italic>) (with <italic>i</italic> ≠ <italic>j</italic> for loops and <italic>i</italic> = <italic>j</italic> for TAD boundaries), an encoder projects the sub-matrices centered at (<italic>i</italic>, <italic>j</italic>) in both the study sample and reference panel to low-dimensional embeddings. An attention module<sup><xref ref-type="bibr" rid="CR24">24</xref></sup> computes a combined representation of all reference samples as a weighted sum of their embeddings, with weights based on their local similarity to the study sample’s embedding. Finally, a multi-layer perceptron predictor computes loop or TAD boundary score from the concatenation of the study sample’s embedding and the attention output. The process is repeated for every pair (<italic>i</italic>, <italic>j</italic>) to obtain a scoring matrix (resp. vector), from which discrete loop (resp. TAD boundary) predictions are extracted.</p>
      <p id="Par10">Training RefHiC (i.e., choosing the weights of the encoder, fully connected layers in attention module, and head) is achieved using a variety of downsampled versions of a high-coverage Hi-C data set for GM12878<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>. Following Salameh et al.<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, we used as prediction targets a set of long-range loops identified at 5 kb resolution by either ChIA-PET on CTCF<sup><xref ref-type="bibr" rid="CR25">25</xref></sup> or RAD21<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>, as well as by HiCHIP on SMC1<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> or H3K27ac<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>. Using multiple experimental data sets ensures a broad coverage of various types of loops.</p>
      <p id="Par11">Importantly, although RefHiC is trained on GM12878 data, the model learned is not cell-type specific, and we will demonstrate in later sections that the same model can be used to annotate structures in many other cell types without retraining and with similar accuracy. The same trained model can also be used to make predictions on mouse Hi-C data, based on our reference panel for that species.</p>
      <p id="Par12">In our experiments, we used human chromosomes 11 and 12 for validation, chromosomes 15–17 for testing, and the rest of the autosomes for training. To prevent potential data leakage, all results reported here pertain only to the three test chromosomes.</p>
    </sec>
    <sec id="Sec4">
      <title>RefHiC accurately detects chromatin loops from Hi-C contact maps</title>
      <p id="Par13">We first assessed the loop prediction accuracy of RefHiC on a downsampled Hi-C data set (500M valid read pairs) for human GM12878 cells<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>. We then applied Chromosight<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, Peakachu<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, Mustache<sup><xref ref-type="bibr" rid="CR16">16</xref></sup>, and HiCCUPS<sup><xref ref-type="bibr" rid="CR4">4</xref></sup> to annotate loops from the same data with default parameters. For all tools, we set the same 5% FDR cutoff whenever possible.</p>
      <p id="Par14">The sets of predicted loops are quite different among tools, with RefHiC making the largest number of unique predictions Fig. <xref rid="Fig2" ref-type="fig">2</xref>a and Supplementary Fig. <xref rid="MOESM1" ref-type="media">1</xref>. Aggregate peak analysis (Fig. <xref rid="Fig2" ref-type="fig">2</xref>b) shows that loops detected by Chromosight, RefHiC, and Mustache had a more diffuse loop center compared to those identified by Peakachu and HiCCUPS. Finally, the distribution of distances between loop anchors predicted by RefHiC and Mustache most closely resembled that of ChIA-PET/HiCHIP-supported loops (Fig. <xref rid="Fig2" ref-type="fig">2</xref>c), whereas Peakachu, HiCCUPS, and Chromosight predicted more short-range interactions.<fig id="Fig2"><label>Fig. 2</label><caption><title>Comparison of RefHiC, Chromosight, Peakachu, HiCCUPS, and Mustache on GM12878 Hi-C data (500M valid read pairs).</title><p><bold>a</bold> Venn diagram of loops predicted by different tools. <bold>b</bold> Aggregate peak analysis profiles for target (ChIA-PET and HiCHIP identified) and annotated loops. <bold>c</bold> Cumulative distance distributions of predicted loops. RefHiC’s predicted loop distance distribution closely resembles that of ChIA-PET/HiCHIP-supported loops (target). <bold>d</bold>–<bold>f</bold> Number of ChIA-PET/HiCHIP-supported loop predictions, among the top 1700 predictions made by RefHiC and other tools, for test chromosomes chr15, chr16, and chr17, compared against CTCF ChIA-PET (<bold>d</bold>), RAD21 ChIA-PET (<bold>e</bold>), and SMC1 HiCHIP (<bold>f</bold>). RefHiC’s loop predictions matches those experimental data better than predictions made by other tools on test chromosomes. <bold>g</bold> Occupancy of ChIP-seq identified CTCF binding site as a function of distance to predicted loop anchors. <bold>h</bold> Orientation of CTCF motifs at predicted loops. <bold>i</bold> Transcription factor (TF) occupancy at predicted loops (RefHiC and Chromosight only). Each dot is a TF or histone modification (based on 133 ENCODE ChIP-seq data sets for GM12878), whose x-coordinate is the fraction of loop anchors containing a binding/modification site and the y-axis is the fold enrichment against genome-wide frequency. Most TFs are more strongly enriched at RefHiC loop predictions than at Chromosight loop predictions.</p></caption><graphic xlink:href="41467_2022_35231_Fig2_HTML" id="d32e505"/></fig></p>
      <p id="Par15">We then evaluated predicted loops by comparing them to loops revealed by loop-targeting experimental data, allowing up to 5 kb shift. To facilitate interpretation, we considered the top 1700 predictions from each tool by adjusting the FDR or loop score cutoff. Figure <xref rid="Fig2" ref-type="fig">2</xref>d–f and Supplementary Fig. <xref rid="MOESM1" ref-type="media">2</xref>a show that RefHiC produced 1250 CTCF-supported loops, 784 RAD21-supported loops, 588 SMC1-supported loops, and 213 H3K27ac-supported loops. In contrast, other tools yielded 20–52% fewer validated loops. Comparison against DeepLoop<sup><xref ref-type="bibr" rid="CR19">19</xref></sup> reveal similar numbers (Supplementary Note <xref rid="MOESM1" ref-type="media">1</xref> and Supplementary Fig. <xref rid="MOESM1" ref-type="media">3)</xref>. Finally, to delineate the impact of using a reference panel, we evaluated a version of RefHiC that operates exclusively based on the study sample (Supplementary Note <xref rid="MOESM1" ref-type="media">2)</xref>; while this reference-free predictor obtains state-of-the-art performance (or better), it is far from the reference panel based RefHiC (Supplementary Fig. <xref rid="MOESM1" ref-type="media">4)</xref>. As shown in Fig. <xref rid="Fig2" ref-type="fig">2</xref>g, predicted loop anchors detected by RefHiC were strongly enriched with the CTCF binding motifs. TAD-forming loops have been previously shown to be associated with the presence of convergent CTCF binding sites at loop anchors<sup><xref ref-type="bibr" rid="CR5">5</xref></sup>. Indeed, 50% of RefHiC’s loop predictions are associated with such pairs of sites; significantly more than for other tools (Fig. <xref rid="Fig2" ref-type="fig">2</xref>h).</p>
      <p id="Par16">Among loops detected by each tool, 46% of RefHiC, 39% of Chromosight, 50% of Peakachu, and 9% of Mustache were not detected by other tools (Fig. <xref rid="Fig2" ref-type="fig">2</xref>a). Supplementary Fig. <xref rid="MOESM1" ref-type="media">5</xref> shows that RefHiC-specific predictions are not only more numerous but also more accurate when evaluated against CTCF/RAD21 ChIA-PET, and SMC1 HiCHIP data, though slightly less accurate than Chromosight and Peakachu on H3K27ac HiCHiP data. Chromosight and Peakachu were slightly better than RefHiC when being evaluated against H3K27ac HiCHiP data. A deeper analysis of the properties of loops predicted by each tool is presented in Supplementary Note <xref rid="MOESM1" ref-type="media">3</xref> and Supplementary Figs. <xref rid="MOESM1" ref-type="media">6</xref>–<xref rid="MOESM1" ref-type="media">8</xref>.</p>
      <p id="Par17">To further study the properties of loops predicted by each tool, we performed transcription factor (TF) and histone modification enrichment analysis around loop anchors. Figure <xref rid="Fig2" ref-type="fig">2</xref>i and Supplementary Fig. <xref rid="MOESM1" ref-type="media">2</xref>b, c show enrichment for known loop-mediating proteins (SMC3, RAD21, YY1, TRIM22, CTCF, and ZNF143) was strongest for RefHiC compared to Chromosight and Peakachu, and comparable to Mustache.</p>
      <p id="Par18">Combined, these results demonstrate the overall superior prediction accuracy of RefHiC on GM12878 data (500M read pairs) compared to other approaches.</p>
    </sec>
    <sec id="Sec5">
      <title>RefHiC performs well across cell types and species</title>
      <p id="Par19">Although RefHiC is trained on human GM12878 data, we demonstrate here that the same trained model performs well across other human and mouse cell types. We applied RefHiC and other tools (5% FDR) to Hi-C data from human K562, IMR90<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>, and cohesin-depleted HCT-116<sup><xref ref-type="bibr" rid="CR29">29</xref></sup> cell lines (test chromosomes 15–17 only), as well as mouse embryonic stem cells (mESC)<sup><xref ref-type="bibr" rid="CR30">30</xref></sup> (all chromosomes). Since the IMR90 data set has twice the sequencing coverage of the K562 data set, all tools identified more loops in the former, with Chromosight and RefHiC making the largest number of predictions (Fig. <xref rid="Fig3" ref-type="fig">3</xref>a). However, RefHiC is notably more robust to sequencing depth, with a decrease of only 22% from IMR90 to K562, compared to 34–66% for other tools.<fig id="Fig3"><label>Fig. 3</label><caption><title>Loop detection in Hi-C data from human K562, IMR90, and cohesin-depleted HCT-116 cells, as well as mouse ESC.</title><p><bold>a</bold> Number of loops identified in Hi-C datasets obtained in each data set (human data: test chromosomes 15–17 only; mouse data: all autosomes). Note that in HCT-116, one would not expect any cohesin-mediated loops. <bold>b</bold>, <bold>c</bold> Number of ChIA-PET/HiCHIP-supported loop predictions, among the top predictions made by RefHiC and other tools on K562 Hi-C data, for test chromosomes chr15-17, compared against CTCF (<bold>b</bold>) and RAD21 ChIA-PET (<bold>c</bold>) data. <bold>d</bold> Occupancy of ChIP-seq identified CTCF binding sites in K562 cells as a function of distance to predicted loop anchors. <bold>e</bold>, <bold>f</bold> Same as (<bold>b</bold>, <bold>d</bold>), but for data obtained in IMR90 cells. <bold>g</bold>, <bold>h</bold> Same as (<bold>b</bold>, <bold>d</bold>), but for data obtained in mESC (all autosomes).</p></caption><graphic xlink:href="41467_2022_35231_Fig3_HTML" id="d32e641"/></fig></p>
      <p id="Par20">Cohesin-depleted HCT-116 cells are expected not to contain any loop. Indeed, RefHiC, Peakachu, and Mustache made fewer than 24 loop predictions on this data, whereas Chromosight and HiCCUPS had many more likely false positives.</p>
      <p id="Par21">For the mESC data, which contains only 124M valid read pairs, we used the same RefHiC model trained from human GM12878, but with a mouse reference panel made of 20 mouse Hi-C data sets (Supplementary Table <xref rid="MOESM1" ref-type="media">2)</xref>. Applied to the complete set of autosomes, RefHiC identified more than twice as many loops as any other tool, indicating that it is much more sensitive than other tools on low-coverage data.</p>
      <p id="Par22">We then assessed these tools’ accuracy using loops revealed by orthogonal experiments. As before, we included the top 1700 predictions on test chromosomes from each tool by adjusting FDR or loop score cutoff. For K562 data, as shown in Fig. <xref rid="Fig3" ref-type="fig">3</xref>b, c, RefHiC outperformed other tools as it identified more CTCF- and RAD21-supported loops. The pileup analysis of CTCF binding sites around predicted loop anchors (Fig. <xref rid="Fig3" ref-type="fig">3</xref>d) shows occupancy 25% higher for RefHiC than for Peakachu and Mustache, and 51% higher than for Chromosight and HiCCUPS. Similar results are obtained on IMR90 data (Fig. <xref rid="Fig3" ref-type="fig">3</xref>e, f), although its very high coverage enables competing approaches to get somewhat closer to RefHiC’s performance. For the mESC data, Fig. <xref rid="Fig3" ref-type="fig">3</xref>g, h indicates that RefHiC outperformed alternative tools significantly as it detected as twice as many CTCF-supported loops as alternative tools and its loop anchor predictions are more strongly enriched for CTCF binding sites than other tools. To further study the ability of RefHiC to identify loops in samples that are very different from those present in its reference panel, we generated reference panels excluding samples that are closely related to study sample GM12878, or even entirely unrelated (e.g., from the incorrect chromosome). Supplementary Note <xref rid="MOESM1" ref-type="media">4</xref> and Supplementary Fig. <xref rid="MOESM1" ref-type="media">14</xref> show that RefHiC performs comparably or better than other tools even under this less favorable scenario. Together, the results show that RefHiC achieves superior performance across both human and mouse cell types.</p>
    </sec>
    <sec id="Sec6">
      <title>RefHiC is robust to sequencing depths</title>
      <p id="Par23">To benchmark RefHiC’s ability to detect loops from Hi-C data at different sequencing depths, we produced downsampled versions a high-coverage GM12878 Hi-C combined contact map<sup><xref ref-type="bibr" rid="CR4">4</xref></sup> and applied different loop prediction tools (default parameters; FDR cutoff 0.05 when possible). Although lower sequencing depths led to fewer loop predictions for all tools (Fig. <xref rid="Fig4" ref-type="fig">4</xref>a), RefHiC was most robust to sequencing depths. For example, RefHiC identified 731 loops from low coverage Hi-C data (62.5M contact pairs)—32% of the results obtained from 2000M contact pairs. In contrast, other tools are largely unable to make sensitive loop predictions at this low sequence depth. Figure <xref rid="Fig4" ref-type="fig">4</xref>b shows that RefHiC detected highly concordant sets of loops across sequencing depths: ~85% of loops annotated from Hi-C data containing 1000M, 500M, and 250M contact pairs overlapped those annotated from the 2000M contact pairs data set. This percentage was even higher (90%) on low-depth Hi-C data (i.e., 125M, and 62.5M contact pairs). This shows that not only is RefHiC capable of detecting a good number of loops in low-coverage data, but it also does not introduce significantly more false positives. Figure <xref rid="Fig4" ref-type="fig">4</xref>c–f confirm that RefHiC predictions on low-depth data sets maintain a very high level of accuracy when evaluated against loops mediated by CTCF, RAD21, SMC1, and H3K27ac. In short, this means that predictions made on low-coverage data are nearly as specific as those made on the full data, but are simply less sensitive. At all sequencing depths, RefHiC achieved higher accuracy than alternative tools (Supplementary Fig. <xref rid="MOESM1" ref-type="media">4)</xref>. This superior robustness, accuracy, and reliability is attributable to the use of reference panel.<fig id="Fig4"><label>Fig. 4</label><caption><title>Detection of loops at lower sequencing depths.</title><p><bold>a</bold> Number of loops predicted by different tools at 5% FDR, for decreasing number of valid intra-chromosomal read pairs. <bold>b</bold> Venn diagram of loops predicted from Hi-C data of different sequencing depths by RefHiC. <bold>c</bold>–<bold>f</bold> Number of RefHiC loop predictions supported by experimental GM12878 ChIA-PET/HiCHIP data (test chromosomes chr15-17) at different levels of sequencing coverage: CTCF ChIA-PET (<bold>c</bold>), RAD21 ChIA-PET (<bold>d</bold>), SMC1 HiCHIP (<bold>e</bold>), H3K27ac HiCHIP (<bold>f</bold>).</p></caption><graphic xlink:href="41467_2022_35231_Fig4_HTML" id="d32e726"/></fig></p>
    </sec>
    <sec id="Sec7">
      <title>RefHiC identifies both rare and common loops</title>
      <p id="Par24">Since RefHiC uses a reference panel to complement data from the study sample, one may expect that it performs best on common loops (i.e., those present in a large number of cell types from our reference panel). To determine the prevalence of each loop, we ran Mustache and Chromosight on our reference samples and merged their predictions (allowing a 2-bin shift; the two tools failed on 10 of the 29 samples as one or both detected less than 10 loops, leaving a total of 19 samples annotated). We then assessed the frequency at which loops predicted by RefHiC on GM12878 were found in the 19 reference samples. The distribution of reference panel frequencies among loops predicted by RefHiC resembled that of Peakachu, Mustache, and Chromosight (Fig. <xref rid="Fig5" ref-type="fig">5</xref>). For all these tools, the majority of highest-scoring loops were found to be present across nearly all samples, suggesting that constitutive, non-cell-type specific loops have features that make them easily predictable. Still, more than 20% of loops predicted by RefHiC are rare (found in at most 5 of the panel data sets), and 4% are specific to GM12878, demonstrating that the use of a reference panel does not strongly bias the results in favor of common loops. Still, those proportions are slightly lower than those obtained with the three other tools, which could be explained by a combination of a weak bias toward common loops for RefHiC, and an increased false-positive rate (which usually will appear as cell-type specific loops) for the other tools. Indeed, the number of GM12878-specific loop predictions that are supported by experimental data is actually comparable across tools (Supplementary Fig. <xref rid="MOESM1" ref-type="media">9)</xref>. Peakachu identified more cell-type specific validated loops than other tools, but with a lower specificity than RefHiC. Among loops found to occur at least once in the panel, RefHiC gets more ChIA-PET/HiCHIP-supported predictions than alternative tools (Supplementary Fig. <xref rid="MOESM1" ref-type="media">9</xref>e, g–t), except that Peakachu identified more H3K27ac HiCHIP-supported loops (Supplementary Fig. <xref rid="MOESM1" ref-type="media">9</xref>f). Finally, loops predicted by HiCCUPS were very different, containing more of what looks like GM12878-specific loops (i.e., loops absent from the reference panel), many of which are likely false-positives.<fig id="Fig5"><label>Fig. 5</label><caption><title>Comparison of tools’ ability to identify rare and common loops.</title><p>Loop frequency within the reference panel is assessed based on Mustache and Chromosight’s predictions on individual reference Hi-C data sets.</p></caption><graphic xlink:href="41467_2022_35231_Fig5_HTML" id="d32e754"/></fig></p>
    </sec>
    <sec id="Sec8">
      <title>RefHiC accurately detects TADs</title>
      <p id="Par25">RefHiC is a versatile framework for topological structure annotation. Here we show that RefHiC can detect TADs once trained using as target values RobusTAD TAD boundary scores obtained on a high-coverage HiC data set (see “Methods”). We first compared RefHiC’s performance on downsampled versions of a GM12878 Hi-C contact map to that of two established TAD boundary predictors (RobusTAD<sup><xref ref-type="bibr" rid="CR11">11</xref></sup> and insulation score<sup><xref ref-type="bibr" rid="CR10">10</xref></sup>). Figure <xref rid="Fig6" ref-type="fig">6</xref>a, b and Supplementary Fig. <xref rid="MOESM1" ref-type="media">15</xref> show that at 500M valid read pairs, RefHiC and RobusTAD succeed at identifying a similar total number of CTCF-supported TAD boundaries, although RefHiC’s specificity is much higher considering that its total number of predictions (at 5% FDR) is approximately 40% less than with RobusTAD. Supplementary Figs. <xref rid="MOESM1" ref-type="media">10</xref> and <xref rid="MOESM1" ref-type="media">11</xref> show that at very low coverage (125M and 62.5M valid read pairs), RefHiC achieves both higher sensitivity and specificity. In all cases, both RefHiC and RobusTAD outperform Insulation score.<fig id="Fig6"><label>Fig. 6</label><caption><title>Detection of TAD boundaries and TADs on GM12878 Hi-C data.</title><p><bold>a</bold> TAD boundary pileups for left boundaries predicted by RefHiC. <bold>b</bold> Number of predicted left TAD boundaries supported by ChIP-seq identified CTCF binding sites (positive strand only), for RefHiC, RobusTAD, and Insulation score. <bold>c</bold>–<bold>i</bold> Benchmarking RefHiC against 13 other TAD callers on TAD annotation. <bold>c</bold> Number of TADs predicted by different tools, and proportion of predicted TAD boundary pairs that are supported by CTCF ChIA-PET data. Size (<bold>d</bold>), and mean interaction frequency (observed/expected) (<bold>e</bold>) of TAD predictions. The number of TADs used to generated box plots are provided in (<bold>c</bold>). In each box, the upper edge, central line, and lower edge represent the 75th, 50th, and 25th percentile, respectively. Upper whiskers represent 75th percentile + 1.5 × interquartile range (IQR), lower whiskers represent minimum values, and dots represent samples above the 75th percentile + 1.5 × IQR. <bold>f</bold> Enrichment of CTCF, RAD21, and SMC3 peak signals at TAD boundaries. <bold>g</bold> Fraction of TADs predicted by each caller with a significant (high or low) H3K27me3/H3K36me3 log10-ratio (FDR &lt; 0.1). Jaccard index of predicted TAD boundaries (<bold>h</bold>) and Concordance between TADs (<bold>i</bold>) predicted on high-coverage GM12878 data (2B valid read pairs) compared to those predicted on downsampled Hi-C data. Note: <bold>a</bold>–<bold>g</bold> are based on a downsampled GM12878 Hi-C data set that containing 500M valid read pairs).</p></caption><graphic xlink:href="41467_2022_35231_Fig6_HTML" id="d32e834"/></fig></p>
      <p id="Par26">We then benchmarked RefHiC against 13 TAD callers (TopDom<sup><xref ref-type="bibr" rid="CR31">31</xref></sup>, Armatus<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>, deDoc<sup><xref ref-type="bibr" rid="CR33">33</xref></sup>, Arrowhead<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>, HiTAD<sup><xref ref-type="bibr" rid="CR34">34</xref></sup>, EAST<sup><xref ref-type="bibr" rid="CR35">35</xref></sup>, OnTAD<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>, CaTCH<sup><xref ref-type="bibr" rid="CR37">37</xref></sup>, Grinch<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>, Domaincall<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>, GMAP<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>, HiCSeg<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>, and IC-Finder<sup><xref ref-type="bibr" rid="CR41">41</xref></sup>) on test chromosomes 15–17. Because there is no universally accepted gold-standard TAD annotation to compared against, we evaluated various aspects of the predictions made by the different tools. We first compared the number and size of TADs identified by each tool (Fig. <xref rid="Fig6" ref-type="fig">6</xref>c, d). Although the number varies from 347 to 3499, most tools (including RefHiC) identified 1000–1500 TADs, with median TAD size around 130 kb for RefHiC. TADs are domains with high levels of internal interaction, so one measure of TAD annotation quality is the average observed/expected ratio within TADs (Fig. <xref rid="Fig6" ref-type="fig">6</xref>e). RefHiC’s TAD predictions are among the densest in interaction frequencies. We then calculated the enrichment for ChIP-Seq signals of structural proteins known to be associated with TAD boundaries (i.e., CTCF, RAD21, and SMC3)<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> at predicted TAD boundaries and nearby (Fig. <xref rid="Fig6" ref-type="fig">6</xref>f and Supplementary Fig. <xref rid="MOESM1" ref-type="media">16)</xref>. Based on this metric, RefHiC is only outperformed by Arrowhead, which identifies 3 times fewer TADs. Histone marks usually correlate with regulatory activity, and most TADs are typically enriched for either activation (H3K36me3) or repression (H3K27me3) marks, but rarely both. We calculated the ratio between H3K27me3 and H3K36me3 within each TAD prediction and counted the fraction of TAD predictions where this ratio was particularly large or small (see “Methods”). RefHiC is among the top three TAD callers under this metric (Fig. <xref rid="Fig6" ref-type="fig">6</xref>g), only bested by tools that predict a much smaller number of TADs (Arrowhead and CaTCH). Many TADs in mammalian genomes exhibit a strong contact between their left and right boundary loci, forming a visible TAD corner; they are often referred to as loop domains. We compared predicted TAD corners against CTCF ChIA-PET data (Fig. <xref rid="Fig6" ref-type="fig">6</xref>c). RefHiC is the best-performing tool, with 556 (36.5%) TADs corners supported by CTCF ChIA-PET data (allowing 1-bin mismatch). Finally, we evaluated the prediction reproducibility at both the boundary and full TAD levels when TAD callers are applied to Hi-C data containing different numbers of valid read pairs. RefHiC proved much more robust than other tools at the TAD boundary prediction task (Fig. <xref rid="Fig6" ref-type="fig">6</xref>h) and better than most (but slightly worse than GMAP and HiCSeg) at the full TAD prediction task (Fig. <xref rid="Fig6" ref-type="fig">6</xref>i). This last observation is likely is due to the fact that pairing predicted TAD boundaries to obtain full TAD predictions is a step that does not currently take advantage of RefHiC’s reference panel.</p>
    </sec>
  </sec>
  <sec id="Sec9" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par27">Here we present RefHiC, a deep learning framework that utilizes a reference panel to guide the annotation of topological structure from a given study sample. In contrast, existing topological structure detection algorithms are study-sample based (i.e., reference-free) detectors and hence their ability to reliably detect topological structures from typical sequencing depth Hi-C data is limited. Our extensive evaluation demonstrated that RefHiC outperforms existing tools for both TAD and loop annotations, in data sets ranging from very high to very low sequencing coverage, with the most striking improvements observed in the latter case. This benefit comes at little cost in terms of RefHiC’s ability to identify cell-type specific loops.</p>
    <p id="Par28">Importantly, although RefHiC is a machine-learning-based model trained primarily on GM12878 Hi-C data, the same trained model is effective on different cell types, at different levels of coverage, and across human and mouse. Indeed, all results reported here for loop prediction were obtained with the same trained model, which is available in our GitHub repository. This model can be used for mammalian Hi-C data analyses without retraining. Retraining would only be needed if other types of structures are sought, or if the experimental protocol used to generate the study sampled differed significantly from the standard in situ Hi-C protocol. In such cases, RefHiC would require retraining but would still be able to take advantage of our Hi-C reference panel, i.e., the reference panel does not need to be of the same type as the study sample. However, applying RefHiC to Hi-C data obtained from other species might be more challenging, due to the lacking of reference samples, than reference-free alternative tools.</p>
    <p id="Par29">Our method has several methodological contributions. The key innovation of RefHiC is the introduction of a Hi-C reference panel. Our attention-based framework enables RefHiC to identify and take advantage of the reference samples that exhibit similar local structures as the study sample at the locus pair of interest. This approach based on local similarity significantly outperformed an analogous approach based on global similarity (Supplementary Note <xref rid="MOESM1" ref-type="media">5</xref>). Besides, we introduced contrastive pretraining<sup><xref ref-type="bibr" rid="CR42">42</xref></sup> and data augmentation by downsampling Hi-C contact map techniques to train a single model capable of handling Hi-C data of different sequencing depths. We believe this training procedure can improve many machine learning applications for Hi-C data analysis<sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR43">43</xref>–<xref ref-type="bibr" rid="CR45">45</xref></sup>.</p>
    <p id="Par30">In principle, reference-based approaches such as RefHiC have the potential of becoming increasingly accurate as larger compendia of high-quality Hi-C data sets obtained from diverse cell types become available and get included in the panel. However, our analyses (Supplementary Fig. <xref rid="MOESM1" ref-type="media">12</xref>) suggest that limited benefits for the analysis of GM12878 data are obtained beyond a panel consisting of 10 high-coverage data sets. However, we expect that this observation is dependent on the origin of the study sample of interest, and RefHiC’s performance on study samples that are divergent from the cell types represented in the panel would certainly benefit from additional, closer reference samples.</p>
    <p id="Par31">RefHiC could potentially be improved in several directions. Expanding the reference panel could improve prediction accuracy, but this is challenging memory-wise with our current implementation. In addition to further software optimization, we will develop high-diversity panels that will aim to capture most of the structural diversity through a moderate number of Hi-C data sets. In addition, we can potentially extend RefHiC to analyze data at an even higher resolution (e.g., 1 kb), although this too would require optimizing data handling to limit the memory footprint and IO time.</p>
    <p id="Par32">Across the different sub-fields of data-driven biology, major leaps forward have taken place when researchers have developed approaches that enabled the analysis of one data set to benefit from the availability of other published data sets. RefHiC is an approach to enable this type of reference-panel-based analysis of 3D genomics data. It enables high-accuracy annotation of Hi-C data sets even at moderate sequencing coverage, and boosts the accuracy of the analysis of even the most deeply sequenced data sets. RefHiC and other approaches of its kind have the potential to become an essential method for topological structure annotation from Hi-C contact maps, paving the way to further our understanding of 3D genome organization and functional implications. With the increasing availability of high-quality Hi-C data sets from diverse cell types, we anticipate that the power of RefHiC will further develop.</p>
  </sec>
  <sec id="Sec10">
    <title>Methods</title>
    <sec id="Sec11">
      <title>RefHiC model architecture</title>
      <p id="Par33">The RefHiC network consists of three parts (see Fig. <xref rid="Fig1" ref-type="fig">1</xref> and Supplementary Fig. <xref rid="MOESM1" ref-type="media">13</xref>): (i) an encoder, (ii) an attention module, and (iii) a task-specific head. The encoder takes an input of dimension (2 × <italic>w</italic> + 1) × (2 × <italic>w</italic> + 1) × 2, where <italic>w</italic> is the window size (<italic>w</italic> = 10 in loop annotation, <italic>w</italic> = 20 in TAD boundary annotation) and projects the input to a <italic>d</italic>-dimensional embedding (<italic>d</italic> = 64). It is built with one ReLU-activated convolution layer with kernel size three and two ReLU-activated fully connected layers with <italic>d</italic> hidden units in each layer. In forward pass, the encoder computes an embedding <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{{\bf{e}}}}}}}}}_{{{{{{{{\bf{s}}}}}}}}}\in {{\Bbb{R}}}^{1\times d}$$\end{document}</tex-math><mml:math id="M2"><mml:msub><mml:mrow><mml:mi mathvariant="bold">e</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow></mml:msub><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq1.gif"/></alternatives></inline-formula> for the study sample and <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$[{{{\bf{e}}}}_{{{\bf{1}}}},{{{\bf{e}}}}_{{{\bf{2}}}},\; \ldots,\; {{{\bf{e}}}}_{{{\bf{n}}}}] \in {{\Bbb{R}}}^{n\times d}$$\end{document}</tex-math><mml:math id="M4"><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">e</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">1</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">e</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">2</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mspace width="0.16em"/><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mspace width="0.16em"/><mml:msub><mml:mrow><mml:mi mathvariant="bold">e</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">n</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq2.gif"/></alternatives></inline-formula> for the <italic>n</italic> reference samples. The attention module takes as input the embeddings for both the study and reference samples and outputs <inline-formula id="IEq3"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\bf{a}}}}}}}}\in {{\Bbb{R}}}^{1\times d}$$\end{document}</tex-math><mml:math id="M6"><mml:mi mathvariant="bold">a</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq3.gif"/></alternatives></inline-formula> that contains topological structural information learned from the reference panel. The layer-normalized study sample’s embedding is used as query (<inline-formula id="IEq4"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\bf{Q}}}}}}}}\in {{\Bbb{R}}}^{1\times d}$$\end{document}</tex-math><mml:math id="M8"><mml:mi mathvariant="bold">Q</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq4.gif"/></alternatives></inline-formula>) against the layer-normalized reference samples’ embeddings, which are used as both keys (<inline-formula id="IEq5"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\bf{K}}}}}}}}\in {{\Bbb{R}}}^{n\times d}$$\end{document}</tex-math><mml:math id="M10"><mml:mi mathvariant="bold">K</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq5.gif"/></alternatives></inline-formula>) and values (<inline-formula id="IEq6"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\bf{V}}}}}}}}\in {{\Bbb{R}}}^{n\times d}$$\end{document}</tex-math><mml:math id="M12"><mml:mi mathvariant="bold">V</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>×</mml:mo><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq6.gif"/></alternatives></inline-formula>). We define the attention weights <bold>α</bold> = softmax<inline-formula id="IEq7"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$({{{{{{{{\bf{QK}}}}}}}}}^{T})\in {{\Bbb{R}}}^{1\times n}$$\end{document}</tex-math><mml:math id="M14"><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">QK</mml:mi></mml:mrow><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>×</mml:mo><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq7.gif"/></alternatives></inline-formula>, where <italic>α</italic><sub><italic>j</italic></sub> represents the relative amount of attention paid to sample <italic>j</italic> in our reference panel when analyzing the study sample. The attention output <bold>a</bold> is computed as,<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\bf{a}}}}}}}}=\,{{\mbox{softmax}}}\,({{{{{{{{\bf{QK}}}}}}}}}^{T}){{{{{{{\bf{V}}}}}}}}+{{{\mbox{MLP}}}}_{{{\mbox{attn}}}}({{\mbox{softmax}}}\,({{{{{{{{\bf{QK}}}}}}}}}^{T}){{{{{{{\bf{V}}}}}}}})$$\end{document}</tex-math><mml:math id="M16"><mml:mi mathvariant="bold">a</mml:mi><mml:mo>=</mml:mo><mml:mspace width="0.25em"/><mml:mstyle><mml:mtext>softmax</mml:mtext></mml:mstyle><mml:mspace width="0.25em"/><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">QK</mml:mi></mml:mrow><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi mathvariant="bold">V</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mstyle><mml:mtext>MLP</mml:mtext></mml:mstyle></mml:mrow><mml:mrow><mml:mstyle><mml:mtext>attn</mml:mtext></mml:mstyle></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mstyle><mml:mtext>softmax</mml:mtext></mml:mstyle><mml:mspace width="0.25em"/><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="bold">QK</mml:mi></mml:mrow><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi mathvariant="bold">V</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><graphic xlink:href="41467_2022_35231_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula>where MLP<sub>attn</sub> has ReLU-activated fully connected layers with two hidden layers, and each layer contains <italic>d</italic> hidden units. Finally, the head is a task-specific predictor (either for loop or for TAD boundary prediction) with 2 hidden layers containing 2<italic>d</italic> and <italic>d</italic> hidden units. It has one sigmoid-activated output unit for loop prediction and two tanh-activated output units for TAD boundary prediction. Both tasks use the concatenation of the study sample’s embedding <bold>e</bold><sub><bold>s</bold></sub> and attention output <bold>a</bold> as input. For loop prediction, it outputs a value indicating loop probability. For TAD boundary prediction, it outputs two values corresponding to left and right boundary scores. To make predictions, we apply RefHiC to each entry in the upper triangular contact matrix to compute loop probabilities, and each entry on the main diagonal to compute TAD boundary scores.</p>
    </sec>
    <sec id="Sec12">
      <title>Detecting loops by density-based clustering</title>
      <p id="Par34">Applied to the window centered around each bin pair (<italic>i</italic>, <italic>j</italic>) (a.k.a pixel), RefHiC produces a loop probability score <italic>L</italic>(<italic>i</italic>, <italic>j</italic>). Pixels where <italic>L</italic>(<italic>i</italic>, <italic>j</italic>) &gt; 0.5 are called <italic>loop candidates</italic>. Candidate (<italic>i</italic>, <italic>j</italic>) is called an <italic>isolated</italic> prediction if there are less than six candidates within a 5-bin by 5-bin square centered at (<italic>i</italic>, <italic>j</italic>). We excluded all isolated predictions as they are likely to be false positives. We then grouped the remaining candidates into clusters using a density-based clustering algorithm<sup><xref ref-type="bibr" rid="CR46">46</xref></sup>. We first computed local density <italic>ρ</italic>(<italic>i</italic>, <italic>j</italic>) for candidate (<italic>i</italic>, <italic>j</italic>) by convolving scores with a Gaussian kernel over candidates <inline-formula id="IEq8"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$(i^{\prime},j^{\prime} )$$\end{document}</tex-math><mml:math id="M18"><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq8.gif"/></alternatives></inline-formula> where <inline-formula id="IEq9"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{\rm{min}}}}}}\,\{|i^{\prime} -i|,|\,j^{\prime} -j|\} \le 5$$\end{document}</tex-math><mml:math id="M20"><mml:mi mathvariant="normal">min</mml:mi><mml:mspace width="0.25em"/><mml:mrow><mml:mo>{</mml:mo><mml:mrow><mml:mo>∣</mml:mo><mml:msup><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mi>i</mml:mi><mml:mo>∣</mml:mo><mml:mo>,</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:msup><mml:mrow><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mi>j</mml:mi><mml:mo>∣</mml:mo></mml:mrow><mml:mo>}</mml:mo></mml:mrow><mml:mo>≤</mml:mo><mml:mn>5</mml:mn></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq9.gif"/></alternatives></inline-formula>. We then calculated <italic>δ</italic>(<italic>i</italic>, <italic>j</italic>) as the minimum Chebyshev distance between candidate (<italic>i</italic>, <italic>j</italic>) and any candidate <inline-formula id="IEq10"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$(i^{\prime},j^{\prime} )$$\end{document}</tex-math><mml:math id="M22"><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq10.gif"/></alternatives></inline-formula> with higher density. For candidates (<italic>i</italic>, <italic>j</italic>) with the highest local density, we defined it as <italic>δ</italic>(<italic>i</italic>, <italic>j</italic>) = <italic>δ</italic><sub>max</sub>, where <italic>δ</italic><sub>max</sub> is a large constant. We used a KD-tree data structure to facilitate the fast computation of <italic>δ</italic>(<italic>i</italic>, <italic>j</italic>). We discarded candidates with <italic>δ</italic> smaller than five since they were more likely to be redundant annotations. Among the remaining candidates, we then used a target-decoy search approach to find cluster centroids by identifying candidates with high local density. Given a study sample Hi-C contact map, we created a decoy contact map by permuting interaction frequencies diagonal-wise, applied RefHiC to detect loop candidates in the decoy contact map, and calculated <italic>ρ</italic> and <italic>δ</italic> for loop candidates in the decoy contact map. We then sorted candidates predicted from the study and decoy samples based on local density (<italic>ρ</italic>) and selected the top candidates while keeping the false discovery rate (FDR) at <italic>α</italic> = 0.05. Last, we assigned the remaining candidates to their nearest clusters and chose as a loop the highest local density candidate in each cluster.</p>
    </sec>
    <sec id="Sec13">
      <title>Detecting TAD boundary by peak finding</title>
      <p id="Par35">RefHiC annotates right and left TAD boundaries separately. To annotate discrete right boundaries, we represented right boundary scores produced by RefHiC as sequential data and annotated boundaries by finding peaks using the find_peak function in SciPy<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>. When selecting TADs, we used the target-decoy search approach to find the height (i.e., score cutoff) parameter in find_peak. We also set the minimum distance between peaks to 5 to exclude locally redundant TAD boundaries. We applied the same steps to annotate left boundaries from left boundary scores. Like TopDom and GMAP, we annotate a region starting from a left boundary <italic>l</italic><sub><italic>i</italic></sub> and ending at a downstream right boundary <italic>r</italic><sub><italic>j</italic></sub> (<italic>r</italic><sub><italic>j</italic></sub> is on the left of or identical to <italic>l</italic><sub><italic>i</italic>+1</sub>) as a TAD. We allow a left boundary pairs with multiple right boundaries. This produces nested TADs.</p>
    </sec>
    <sec id="Sec14">
      <title>Feature vector and training data</title>
      <p id="Par36">RefHiC’s feature vector is defined as a tensor with two channels (observed interaction frequency and observed/expected ratio) in the shape of 2 × (2 × <italic>w</italic> + 1) × (2 × <italic>w</italic> + 1), corresponding to the window of size 2<italic>w</italic> + 1 centered at the pixel of interest. <italic>w</italic> is a hyperparameter set to <italic>w</italic> = 10 for loop annotation and <italic>w</italic> = 20 for TAD boundary annotation at 5 kb resolution. We trained RefHiC with Hi-C contact maps downsampled from the combined GM12878 Hi-C contact map<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>.</p>
      <p id="Par37">For loop annotation, following Salameh et al.<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, we used as gold-standard (i.e., positive training cases) a set of long-range loops identified by either ChIA-PET on CTCF<sup><xref ref-type="bibr" rid="CR25">25</xref></sup> or RAD21<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>, as well as by HiCHIP on SMC1<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> or H3K27ac<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>. Using multiple experimental data sets ensures a broad coverage of various types of loops. We binned interactions at 5 kb resolution and removed duplicates and any contact pairs with a distance shorter than 50 kb or longer than 3 Mb, resulting in 74,855 interactions used as positive cases for loop annotation. We created the negative set by selecting non-loop pairs of different types: (i) We randomly drew 50,000 contact pairs, excluding contact pairs with Chromosight scores greater than 0, while preserving the distance distribution between positive loop anchors, (ii) to increase the representation of long range negative examples, we randomly selected 10,000 long range (1 ~ 3 Mb) pairs, most cases of (i) and (ii) are non-loop pairs in all samples. The negative set does not contain enough data representing pairs of loci that do not form a loop in the study sample, but do in some of the reference samples. Thus, we select examples (iii) from pairs identified as loops in one or more reference samples: we applied Chromosight and Mustache with default parameters on all samples in the reference panel to annotate loops, merging annotations while excluding duplicates (allowing 1-bin mismatch). Last, we merged the loop annotations of all reference panel samples (allowing 2-bin mismatches) and kept only annotations that (i) were present in at least 5 reference samples, but (ii) were absent (Chromosight score less than 0) in GM12878, obtaining 170,283 negative pairs. Overall, the entire set contains 74,855 unique positive and 256,609 unique negative examples.</p>
      <p id="Par38">For TAD boundary annotations, we first applied RobusTAD on the combined GM12878 Hi-C contact map and reference samples to obtain TAD boundary scores and identified boundaries. By merging TAD boundaries that were identified from all samples while excluding duplicates (allowing a 2-bin shift), we collected 48,945 loci. We then selected another 54,464 loci by picking one locus every five bins along every autosome. We define the targets for the 103,409 examples as RobusTAD scores from the combined GM12878 Hi-C data. In addition, we created another 103,409 examples at the same loci by using features from a shuffled GM12878 Hi-C contact map and the corresponding RobusTAD scores as targets. In total, there are 206,818 examples.</p>
    </sec>
    <sec id="Sec15">
      <title>Model training and evaluation</title>
      <p id="Par39">The model was trained, evaluated, and tested on contact maps downsampled from the combined GM12878 Hi-C data. During model development, we used chr11 and chr12 for validation, chromosome 15–17 for testing, and the rest of autosomes for training. For loop prediction, the dataset contains 260,940 training, 34,174 validation, and 36,350 test examples. For TAD prediction, the dataset contains 164,458 training, 22,449 validation, and 19,911 test examples. RefHiC takes feature vectors from the study and reference samples as input in the forward pass. To reduce training computation, we sampled 10 reference samples for each example in each epoch independently. During evaluation, we used all samples in the reference panel. For both TAD and loop models, we trained models with a batch size of 1024 for 1000 epochs on an RTX6000 GPU and used AdamW optimizer<sup><xref ref-type="bibr" rid="CR48">48</xref></sup> (weight_decay = 0.1; learning rate = 1<italic>e</italic>−3). We selected the learning rate that yields the highest validation accuracy in our grid search and used early stopping to prevent overfitting. In the first 5 training epochs, we warmed up the learning rate from 0 to the initial learning rate (i.e., 1<italic>e</italic>−3) and then reduced the learning rate to 1<italic>e</italic>−6 in the first 95% epochs using the cosine annealing learning rate scheduler. In addition, we used dropout (rate = 0.25), batch normalization, and layer normalization to regularize network training. We trained the TAD boundary model with MSE loss, and the loop model with focal loss <inline-formula id="IEq11"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$-{(1-{p}_{t})}^{\gamma }\,{{\mbox{log}}}\,({p}_{t})$$\end{document}</tex-math><mml:math id="M24"><mml:mo>−</mml:mo><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>γ</mml:mi></mml:mrow></mml:msup><mml:mspace width="0.25em"/><mml:mstyle><mml:mtext>log</mml:mtext></mml:mstyle><mml:mspace width="0.25em"/><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq11.gif"/></alternatives></inline-formula> (<italic>γ</italic> = 2)<sup><xref ref-type="bibr" rid="CR49">49</xref></sup>. To handle various sequencing depths in a single model, which many existing machine learning applications in Hi-C data analysis are unable to do<sup><xref ref-type="bibr" rid="CR43">43</xref>,<xref ref-type="bibr" rid="CR44">44</xref></sup>, we performed data augmentation by downsampling Hi-C contact maps during training. This transformation preserves topological structures in Hi-C data. However, a Hi-C contact map is too large, and downsampling on the fly is infeasible. We downsampled Hi-C training data and stored them on disk in advance. During training, we randomly selected one contact map from these downsampled contact maps for each training example in each epoch independently. This operation seamlessly worked as a data augmentation by downsampling Hi-C contact map operator during training.</p>
    </sec>
    <sec id="Sec16">
      <title>Contrastive pretraining</title>
      <p id="Par40">We pre-trained the encoder by supervised contrastive learning<sup><xref ref-type="bibr" rid="CR42">42</xref></sup> using Hi-C contact maps downsampled from the combined GM12878 Hi-C data. For each training example, we defined items extracted from the downsampled contact maps at the sample locus as similar items and all Hi-C contact map submatrices in the same batch with different labels as negative items. We aimed to train the encoder such that the distances of embeddings for a training example and its similar items are as close as possible while of embeddings between a training example and its negative items are as far as possible. Following ref. <xref ref-type="bibr" rid="CR42">42</xref>, we defined the loss for training instance <italic>i</italic> as cross-entropy with in-batch negatives<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${l}_{i}=-\,{{\mbox{log}}}\frac{{e}^{{{\mbox{sim}}}({{{{{{{{\bf{h}}}}}}}}}_{{{{{{{{\bf{i}}}}}}}}},{{{{{{{{\bf{h}}}}}}}}}_{{{{{{{{\bf{{i}}}}}}}}}}^{{{\bf{+}}}})/\tau }}{{\sum }_{j\ne i}{e}^{{{\mbox{sim}}}({{{{{{{{\bf{h}}}}}}}}}_{{{{{{{{\bf{i}}}}}}}}},{{{{{{{{\bf{h}}}}}}}}}_{{{{{{{{\bf{{j}}}}}}}}}}^{{{\bf{-}}}})/\tau }}$$\end{document}</tex-math><mml:math id="M26"><mml:msub><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:mspace width="0.25em"/><mml:mstyle><mml:mtext>log</mml:mtext></mml:mstyle><mml:mfrac><mml:mrow><mml:msup><mml:mrow><mml:mi>e</mml:mi></mml:mrow><mml:mrow><mml:mstyle><mml:mtext>sim</mml:mtext></mml:mstyle><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">h</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">h</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">+</mml:mi></mml:mrow></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>/</mml:mo><mml:mi>τ</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mo mathsize="big">∑</mml:mo></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mo>≠</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msup><mml:mrow><mml:mi>e</mml:mi></mml:mrow><mml:mrow><mml:mstyle><mml:mtext>sim</mml:mtext></mml:mstyle><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">h</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">h</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">-</mml:mi></mml:mrow></mml:msubsup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>/</mml:mo><mml:mi>τ</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="41467_2022_35231_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula>where <bold>h</bold><sub><bold>i</bold></sub>, <inline-formula id="IEq12"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{{\bf{h}}}}}}}}}_{{{{{{{{\bf{{i}}}}}}}}}}^{{{\bf{+}}}}$$\end{document}</tex-math><mml:math id="M28"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">h</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">+</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq12.gif"/></alternatives></inline-formula>, and <inline-formula id="IEq13"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{{\bf{h}}}}}}}}}_{{{{{{{{\bf{{j}}}}}}}}}}^{{{\bf{-}}}}$$\end{document}</tex-math><mml:math id="M30"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">h</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">-</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq13.gif"/></alternatives></inline-formula> are embeddings: <bold>h</bold><sub><bold>i</bold></sub> represents item <italic>i</italic>, <inline-formula id="IEq14"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{{\bf{h}}}}}}}}}_{{{{{{{{\bf{{i}}}}}}}}}}^{{{\bf{+}}}}$$\end{document}</tex-math><mml:math id="M32"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">h</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">+</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq14.gif"/></alternatives></inline-formula> represents one of item <italic>i</italic>’s similar items, <inline-formula id="IEq15"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{{\bf{h}}}}}}}}}_{{{{{{{{\bf{{j}}}}}}}}}}^{{{\bf{-}}}}$$\end{document}</tex-math><mml:math id="M34"><mml:msubsup><mml:mrow><mml:mi mathvariant="bold">h</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">-</mml:mi></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41467_2022_35231_Article_IEq15.gif"/></alternatives></inline-formula> represents an item with a label different from <italic>i</italic> (i.e., negative item). <italic>τ</italic> is a temperature that controls training, and we set it as 1. We pre-trained the encoder for 20 epochs with the LARS algorithm<sup><xref ref-type="bibr" rid="CR50">50</xref></sup> using Adam as a base optimizer. We set batch size to 512 and learning rate to 0.1 during training.</p>
    </sec>
    <sec id="Sec17">
      <title>Hi-C data downsampling</title>
      <p id="Par41">We downloaded the combined Hi-C contact map (.mcool file) for GM12878 cells from 4DN Data Portal (<ext-link ext-link-type="uri" xlink:href="https://data.4dnucleome.org">https://data.4dnucleome.org</ext-link>). We downsampled the combined Hi-C contact map to train RefHiC and evaluate sequencing depths’ impact on annotating topological structures. We did bilinear downsampling with the downsample function provided in FAN-C<sup><xref ref-type="bibr" rid="CR51">51</xref></sup> from the combined Hi-C contact map to get a series of downsampled data until reaching at ~62M valid read pairs.</p>
    </sec>
    <sec id="Sec18">
      <title>Loop detection with Chromosight, Peakachu, Mustache, and HiCCUPS</title>
      <p id="Par42">We used a variety of loop prediction tools to benchmark against RefHiC. They are executed as follows. Chromosight: We applied the program to each Hi-C contact map with parameters ‘detect -p 0.2’ to detect loops, sorted detected loops according to scores, and selected the top loops from our test chromosomes. Peakachu: We trained different models for different sequencing depths on GM12878 Hi-C data using our training and validation examples. To match RefHiC, we set the width parameter to 10 and other parameters as default values. We applied the trained models to Hi-C contact maps, adjusted the probability threshold in its pool function to identify loops, sorted loop annotations, and included top loops from test chromosomes as its predictions. Mustache: We used the program by adjusting ‘-pt’ and ‘-st’ to detect at least 1700 loops on our test chromosomes, sorted and selected top loops according to FDR. HiCCUPS: We converted .mcool to .hic files at 5 kb resolution using the ‘pre’ function provided in Juicer<sup><xref ref-type="bibr" rid="CR52">52</xref></sup>. We applied HiCCUPS by adjusting the ‘-f’ parameter to detect at least 1700 loops on our test chromosomes, sorted and selected top loops according to FDR (obtained as the product of FDR for different filters) as HiCCUPS’ prediction. To evaluate the performance of the recommended setting of each tool, we also applied them to annotate loops with their recommended parameters and set FDR as 5% whenever possible.</p>
    </sec>
    <sec id="Sec19">
      <title>TAD detection with alternative tools</title>
      <p id="Par43">We used a variety of TAD callers to benchmark against RefHiC. All tools take .mcool file or files coverted from .mcool file as input. We ran TopDom, Armatus, Arrowhead, EAST, CaTCH, Domaincall (DI), GMAP, ICFinder, and HiCSeg as suggested in ref. <xref ref-type="bibr" rid="CR8">8</xref>. We have updated parameters to reflect that we were analyzing data at 5 kb resolution, as needed. We ran HiTAD and deDoc with their default settings. OnTAD: We set maxsz = 600 to allow OnTAD to detect TADs as large as 3 Mb. Grinch: following Lee and Roy<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>, we detected TADs by setting the expected TAD length as 2 Mb, 1 Mb, and 500 kb in three runs and combined all results. Supplementary Table <xref rid="MOESM1" ref-type="media">4</xref> contains parameters that we used to execute each TAD caller.</p>
      <p id="Par44">We also compared RefHiC’s boundary prediction to two boundary prediction tools. We reimplemented RobusTAD in Python (<ext-link ext-link-type="uri" xlink:href="https://github.com/zhyanlin/RobusTAD">https://github.com/zhyanlin/RobusTAD</ext-link>)<sup><xref ref-type="bibr" rid="CR53">53</xref></sup> and used Insulation score (IS) function in cooltools<sup><xref ref-type="bibr" rid="CR54">54</xref></sup> in our study. Both take a .mcool file as input. We used RobusTAD to calculate TAD boundary scores and identified boundaries with default parameters. We ran IS with win = 10 to detect TAD boundaries. As IS only detected insulating bins, to assign boundary orientation (i.e., left vs right), we used RobusTAD’s left and right boundary scores to classify IS annotations.</p>
    </sec>
    <sec id="Sec20">
      <title>Enrichment analysis of structural proteins and Histone-3 marks at predicted TADs</title>
      <p id="Par45">To compare the performance of TAD callers, we used an established TAD caller benchmarking scripts<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> to study Histone-3 marks and structural proteins enrichment inside TADs or at TAD boundaries. Briefly, we downloaded ChIP-Seq peak files for CTCF (ENCFF796WRU), RAD21 (ENCFF662DRZ), SMC3 (ENCFF887CRE), H3K36me3 (ENCFF171MDW), and H3K27me3 (ENCFF039JOT) from ENCODE<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>. For structural protein enrichment, we counted the average number of peaks per 5-kb intervals within the regions flanking predicted TAD boundaries (±500 kb). Next, we computed the fold-change as the average peaks in a narrow interval surrounding a boundary (±10 kb) over the average peaks coverage at distant flanks (±400–500 kb). For Histone-3 marks enrichment analysis, we split TADs into 20 kb intervals, summed ChIP-Seq signals inside each interval, computed the log10-ratio of H3K27me3 and H3K36me3 signals (LR), and obtained the average LR for each TAD. We then shuffled the LR values ten times to compute an empirical <italic>p</italic>-value for within-TAD LRs and corrected the <italic>p</italic>-value with the Benjamini–Hochberg procedure to select TADs with significant preference for high or low ratios (FDR ≤ 0.1). To compare TAD partitions, following Zufferey et al.<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, we used the Measure of Concordance (MoC), which ranges from 0 (absence of concordance) to 1 (full concordance) and is defined as follows,<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mbox{MoC}}}\,({{{{{{{\bf{P}}}}}}}},{{{{{{{\bf{Q}}}}}}}})=\left\{\begin{array}{ll}1\hfill &amp;{{{{{{{\rm{if}}}}}}}}\,{N}_{P}={N}_{Q}=1\\ \frac{1}{\sqrt{{N}_{P}{N}_{Q}}-1}\left(\mathop{\sum }\nolimits_{i=1}^{{N}_{P}}{\mathop{\sum }\nolimits_{j=1}^{{N}_{Q}}}\frac{|{{{{{{{{\bf{F}}}}}}}}}_{{{{{{{{\bf{i,j}}}}}}}}}{|}^{2}}{|{{{{{{{{\bf{P}}}}}}}}}_{{{{{{{{\bf{i}}}}}}}}}||{{{{{{{{\bf{Q}}}}}}}}}_{{{{{{{{\bf{j}}}}}}}}}|}-1\right) &amp;\,{{\mbox{otherwise}}}\hfill\end{array}\right.$$\end{document}</tex-math><mml:math id="M36"><mml:mstyle><mml:mtext>MoC</mml:mtext></mml:mstyle><mml:mspace width="0.25em"/><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">P</mml:mi><mml:mo>,</mml:mo><mml:mi mathvariant="bold">Q</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfenced open="{"><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="left"><mml:mn>1</mml:mn></mml:mtd><mml:mtd columnalign="left"><mml:mi mathvariant="normal">if</mml:mi><mml:mspace width="0.25em"/><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>P</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>Q</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msqrt><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>P</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>Q</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msqrt><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfrac><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>P</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msubsup><mml:msubsup><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mi>Q</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:msubsup><mml:mfrac><mml:mrow><mml:mo>∣</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">F</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i,j</mml:mi></mml:mrow></mml:msub><mml:msup><mml:mrow><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:mo>∣</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">P</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">Q</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub><mml:mo>∣</mml:mo></mml:mrow></mml:mfrac><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfenced></mml:mtd><mml:mtd columnalign="left"><mml:mspace width="0.25em"/><mml:mstyle><mml:mtext>otherwise</mml:mtext></mml:mstyle></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="41467_2022_35231_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula>where <bold>P</bold> = {<bold>P</bold><sub><bold>i</bold></sub>}, and <bold>Q</bold> = {<bold>Q</bold><sub><bold>i</bold></sub>} are sets of TADs including <italic>N</italic><sub><italic>P</italic></sub> and <italic>N</italic><sub><italic>Q</italic></sub> TADs, <bold>F</bold><sub><bold>i,j</bold></sub> is the overlap region between <bold>P</bold><sub><bold>i</bold></sub> and <bold>Q</bold><sub><bold>j</bold></sub>, and ∣ ⋅ ∣ represents cardinality. MoC does not handle nested TADs, thus we only included TADs without any smaller TAD in this analysis.</p>
    </sec>
    <sec id="Sec21">
      <title>Enrichment analysis of transcription factors and histone modifications at loop anchors</title>
      <p id="Par46">We downloaded ENCODE ChIP-Seq peak files for 122 TFs and 11 histone modifications in the GM12878 from the UCSC genome browser<sup><xref ref-type="bibr" rid="CR26">26</xref>,<xref ref-type="bibr" rid="CR55">55</xref></sup> and calculated occupancy fold changes for each TF at loop anchors. We first created a list of unique loop anchors inferred by each tool. For each TF, we counted the number of anchors that overlapped with at least one binding site. We denoted this value as the target. For each chromosome, we randomly created 100 control sets of anchors from the whole genome excluding blacklisted regions<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>. The number of anchors in each control set equals the number of loop anchors in the target set. We then computed the expected overlaps as the mean of overlaps between each control set and the TF’s binding sites. Last, we computed fold change as the ratio between the target and the expectation calculated based on control sets.</p>
    </sec>
    <sec id="Sec22">
      <title>Hi-C reference panel</title>
      <p id="Par47">Human reference panel: We downloaded Hi-C sequencing data from the GEO repository and processed them with distiller (<ext-link ext-link-type="uri" xlink:href="https://github.com/open2c/distiller-nf">https://github.com/open2c/distiller-nf</ext-link>). Briefly, we used bwa mem<sup><xref ref-type="bibr" rid="CR56">56</xref></sup> to map reads to hg38 with option ‘-SP’ and processed the aligned reads with pairtools (<ext-link ext-link-type="uri" xlink:href="https://github.com/open2c/pairtools">https://github.com/open2c/pairtools</ext-link>) to remove duplicates and low-quality read pairs (MAPQ &lt; 10). We then created and normalized contact matrices at 5 kb resolutions using cooler<sup><xref ref-type="bibr" rid="CR57">57</xref></sup> and saved contact maps in .mcool files. Last, we converted these .mcool files into the .bcool file format using cool2bcool function provided in RefHiC. The .bcool format represents a Hi-C contact map as a band matrix and enables fast random access to square submatrices. Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref> lists all Hi-C data sets included in the human reference panel. Mouse reference panel: We downloaded 20 Hi-C contact maps from 4DN Data Portal (<ext-link ext-link-type="uri" xlink:href="https://data.4dnucleome.org">https://data.4dnucleome.org</ext-link>) and processed them as for human. Supplementary Table <xref rid="MOESM1" ref-type="media">2</xref> lists all Hi-C data sets included in the mouse reference panel. Our distributed reference panels contain the aforementioned reference samples. In our experiments, we excluded samples that belong to the study sample’s cell type from the reference panel to prevent potential data leakage.</p>
    </sec>
    <sec id="Sec23">
      <title>RefHiC implementation</title>
      <p id="Par48">RefHiC is a Python program available at <ext-link ext-link-type="uri" xlink:href="https://github.com/BlanchetteLab/RefHiC">https://github.com/BlanchetteLab/RefHiC</ext-link>. We implemented the neural network with the PyTorch library<sup><xref ref-type="bibr" rid="CR58">58</xref></sup>, and the filtering components for TAD and loop selection with libraries including Pandas<sup><xref ref-type="bibr" rid="CR59">59</xref></sup>, SciPy, and NumPy<sup><xref ref-type="bibr" rid="CR60">60</xref></sup>. Using RefHiC to predict loops or TAD boundary scores requires loading data from the study and reference Hi-C contact maps. To reduce memory usage, we extended the Cooler<sup><xref ref-type="bibr" rid="CR57">57</xref></sup> library by implementing a band matrix representation for a contact map and a square function to fetch contact pairs in a given square region and used it to read Hi-C contact maps. ReHiC can make predictions on both CPU and GPU, but is much faster on the latter. RefHiC requires at least 3GB free space for saving reference panel data and at least 12GB RAM for loading reference samples during prediction. We tested RefHiC to annotate TAD boundaries and loops using 20 CPU threads and an RTX6000 GPU. RefHiC calculated TAD boundary scores for whole genome annotation at 5 kb resolution in 30 min. It is impractical and unnecessary to calculate loop scores for all pairs of loci. RefHiC only computes loop scores at bin pairs located within 3 Mb and for which at least one read pair is observed. Thus, the loop annotation running time depends on the study contact map. For instance, it annotates Hi-C data containing 500M valid read pairs in 275 min and Hi-C data containing 250M valid read pairs in 180 min.</p>
    </sec>
    <sec id="Sec24">
      <title>Reporting summary</title>
      <p id="Par49">Further information on research design is available in the <xref rid="MOESM3" ref-type="media">Nature Portfolio Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec25">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41467_2022_35231_MOESM1_ESM.pdf">
            <caption>
              <p>Supplementary Information</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="41467_2022_35231_MOESM2_ESM.pdf">
            <caption>
              <p>Peer Review File</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="41467_2022_35231_MOESM3_ESM.pdf">
            <caption>
              <p>Reporting Summary</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <sec>
    <title>Supplementary information</title>
    <p>The online version contains supplementary material available at 10.1038/s41467-022-35231-3.</p>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>The authors thank Dr. Yue Li, Dr. Jacek Majewski and members of M.B.’s laboratory Audrey Baguette, Zichao Yan, and Elliot Layne for useful discussions in this project, and Audrey Baguette for testing RefHiC. This work was funded by Genome Quebec/Canada and a Genome Quebec/Oncopole/IVADO grants to M.B., and FRQNT Doctoral (B2X) Research Scholarships to Y.Z.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>Y.Z. and M.B. conceived the study and designed models. Y.Z. implemented models, performed data analysis, and wrote the manuscript. M.B. supervised the project and wrote the manuscript. All authors read and approved the final paper.</p>
  </notes>
  <notes notes-type="peer-review">
    <title>Peer review</title>
    <sec id="FPar1">
      <title>Peer review information</title>
      <p id="Par50"><italic>Nature Communications</italic> thanks Maxwell Libbrecht, and the other, anonymous, reviewer(s) for their contribution to the peer review of this work. <xref rid="MOESM2" ref-type="media">Peer reviewer reports</xref> are available.</p>
    </sec>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>The data that support this study are available from the corresponding author upon reasonable request. All data used in this study are publicly available and their reference numbers are listed in Supplementary Tables <xref rid="MOESM1" ref-type="media">1</xref>, <xref rid="MOESM1" ref-type="media">2</xref>, and <xref rid="MOESM1" ref-type="media">3</xref>. Hi-C contact maps were obtained from 4DN data portal with the following accession code: <ext-link ext-link-type="uri" xlink:href="https://data.4dnucleome.org/files-processed/4DNFIXP4QG5B/">4DNFIXP4QG5B</ext-link> (GM12878), <ext-link ext-link-type="uri" xlink:href="https://data.4dnucleome.org/files-processed/4DNFI4DGNY7J/">4DNFI4DGNY7J</ext-link> (K562), <ext-link ext-link-type="uri" xlink:href="https://data.4dnucleome.org/files-processed/4DNFIJTOIGOI/">4DNFIJTOIGOI</ext-link> (IMR90), <ext-link ext-link-type="uri" xlink:href="https://data.4dnucleome.org/files-processed/4DNFILP99QJS/">4DNFILP99QJS</ext-link> (HCT-116), and <ext-link ext-link-type="uri" xlink:href="https://data.4dnucleome.org/files-processed/4DNFIDA2WGV8/">4DNFIDA2WGV8</ext-link> (mESC). ChIP-Seq data were obtained from the ENCODE portal with the following accession code: <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/files/ENCFF796WRU/">ENCFF796WRU</ext-link> (GM12878 CTCF), <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/files/ENCFF039JOT/">ENCFF039JOT</ext-link> (GM12878 H3K27me3), <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/files/ENCFF662DRZ/">ENCFF662DRZ</ext-link> (GM12878 RAD21), <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/files/ENCFF171MDW/">ENCFF171MDW</ext-link> (GM12878 H3K36me3), <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/files/ENCFF887CRE/">ENCFF887CRE</ext-link> (M12878 SMC3), <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/files/ENCFF508CKL/">ENCFF508CKL</ext-link> (mESC CTCF), <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/files/ENCFF203SRF/">ENCFF203SRF</ext-link> (IMR-90 CTCF), <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/files/ENCFF119XFJ/">ENCFF119XFJ</ext-link> (K562 CTCF). The CTCF ChIA-PET for IMR-90 were obtained from ENCODE with accession code <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/files/ENCFF682YFU/">ENCFF682YFU</ext-link>. The CTCF ChIA-PET for mESC were obtained from ENCODE with accession code <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/files/ENCFF550QMW/">ENCFF550QMW</ext-link>. The RAD21 ChIA-PET for GM12878 were obtained from ENCODE with accession code <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/experiments/ENCSR981FNA/">ENCLB784HEF</ext-link>. The CTCF ChIA-PET for K562 were obtained from ENCODE with accession code <ext-link ext-link-type="uri" xlink:href="https://www.encodeproject.org/files/ENCFF001THV/">ENCFF001THV</ext-link>. The RAD21 ChIA-PET for K562 were downloaded from the GEO repository with accession code <ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSM1436264">GSM1436264</ext-link>. The H3k27ac HiChIP data for GM12878 were obtained from ref. <xref ref-type="bibr" rid="CR28">28</xref>. The SMC1 HiCHIP data for GM12878 were obtained from ref. <xref ref-type="bibr" rid="CR27">27</xref>. The CTCF ChIA-PET data for GM12878 were obtained from ref. <xref ref-type="bibr" rid="CR25">25</xref>. Experiment results and intermediate data generated in this study have been deposited in the zenodo repository with 10.5281/zenodo.7133194<sup><xref ref-type="bibr" rid="CR61">61</xref></sup>.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>Software and documentation available at <ext-link ext-link-type="uri" xlink:href="https://github.com/BlanchetteLab/RefHiC">https://github.com/BlanchetteLab/RefHiC</ext-link> or at this 10.5281/zenodo.7324669<sup><xref ref-type="bibr" rid="CR62">62</xref></sup>. All scripts required to reproduce figures and analyses are available at 10.5281/zenodo.7133194<sup><xref ref-type="bibr" rid="CR61">61</xref></sup>.</p>
  </notes>
  <notes id="FPar2" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par51">The authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lieberman-Aiden</surname>
            <given-names>E</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Comprehensive mapping of long-range interactions reveals folding principles of the human genome</article-title>
        <source>Science</source>
        <year>2009</year>
        <volume>326</volume>
        <fpage>289</fpage>
        <lpage>293</lpage>
        <pub-id pub-id-type="doi">10.1126/science.1181369</pub-id>
        <?supplied-pmid 19815776?>
        <pub-id pub-id-type="pmid">19815776</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Krietenstein</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Ultrastructural details of mammalian chromosome architecture</article-title>
        <source>Mol. Cell</source>
        <year>2020</year>
        <volume>78</volume>
        <fpage>554</fpage>
        <lpage>565</lpage>
        <pub-id pub-id-type="doi">10.1016/j.molcel.2020.03.003</pub-id>
        <?supplied-pmid 32213324?>
        <pub-id pub-id-type="pmid">32213324</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Beagan</surname>
            <given-names>JA</given-names>
          </name>
          <name>
            <surname>Phillips-Cremins</surname>
            <given-names>JE</given-names>
          </name>
        </person-group>
        <article-title>On the existence and functionality of topologically associating domains</article-title>
        <source>Nat. Genet.</source>
        <year>2020</year>
        <volume>52</volume>
        <fpage>8</fpage>
        <lpage>16</lpage>
        <pub-id pub-id-type="doi">10.1038/s41588-019-0561-1</pub-id>
        <?supplied-pmid 31925403?>
        <pub-id pub-id-type="pmid">31925403</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rao</surname>
            <given-names>SSP</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A 3D map of the human genome at kilobase resolution reveals principles of chromatin looping</article-title>
        <source>Cell</source>
        <year>2014</year>
        <volume>159</volume>
        <fpage>1665</fpage>
        <lpage>1680</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2014.11.021</pub-id>
        <?supplied-pmid 25497547?>
        <pub-id pub-id-type="pmid">25497547</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sanborn</surname>
            <given-names>AL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Chromatin extrusion explains key features of loop and domain formation in wild-type and engineered genomes</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2015</year>
        <volume>112</volume>
        <fpage>E6456</fpage>
        <lpage>E6465</lpage>
        <pub-id pub-id-type="doi">10.1073/pnas.1518552112</pub-id>
        <?supplied-pmid 26499245?>
        <pub-id pub-id-type="pmid">26499245</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bonev</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Cavalli</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Organization and function of the 3D genome</article-title>
        <source>Nat. Rev. Genet.</source>
        <year>2016</year>
        <volume>17</volume>
        <fpage>661</fpage>
        <lpage>678</lpage>
        <pub-id pub-id-type="doi">10.1038/nrg.2016.112</pub-id>
        <?supplied-pmid 27739532?>
        <pub-id pub-id-type="pmid">27739532</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dali</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Blanchette</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>A critical assessment of topologically associating domain prediction tools</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2017</year>
        <volume>45</volume>
        <fpage>2994</fpage>
        <lpage>3005</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkx145</pub-id>
        <?supplied-pmid 28334773?>
        <pub-id pub-id-type="pmid">28334773</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zufferey</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Tavernari</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Oricchio</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Ciriello</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Comparison of computational methods for the identification of topologically associating domains</article-title>
        <source>Genome Biol.</source>
        <year>2018</year>
        <volume>19</volume>
        <fpage>1</fpage>
        <lpage>18</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-018-1596-9</pub-id>
        <pub-id pub-id-type="pmid">29301551</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Forcato</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Comparison of computational methods for Hi-C data analysis</article-title>
        <source>Nat. Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>679</fpage>
        <lpage>685</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4325</pub-id>
        <?supplied-pmid 28604721?>
        <pub-id pub-id-type="pmid">28604721</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Crane</surname>
            <given-names>E</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Condensin-driven remodelling of X chromosome topology during dosage compensation</article-title>
        <source>Nature</source>
        <year>2015</year>
        <volume>523</volume>
        <fpage>240</fpage>
        <lpage>244</lpage>
        <pub-id pub-id-type="doi">10.1038/nature14450</pub-id>
        <?supplied-pmid 26030525?>
        <pub-id pub-id-type="pmid">26030525</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <mixed-citation publication-type="other">Dali, R., Bourque, G. &amp; Blanchette, M. RobusTAD: a tool for robust annotation of topologically associating domain boundaries. <italic>bioRxiv</italic> 293175 (2018).</mixed-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Salameh</surname>
            <given-names>TJ</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A supervised learning framework for chromatin loop detection in genome-wide contact maps</article-title>
        <source>Nat. Commun.</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>1</fpage>
        <lpage>12</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-020-17239-9</pub-id>
        <pub-id pub-id-type="pmid">31911652</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ay</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Bailey</surname>
            <given-names>TL</given-names>
          </name>
          <name>
            <surname>Noble</surname>
            <given-names>WS</given-names>
          </name>
        </person-group>
        <article-title>Statistical confidence estimation for Hi-C data reveals regulatory chromatin contacts</article-title>
        <source>Genome Res.</source>
        <year>2014</year>
        <volume>24</volume>
        <fpage>999</fpage>
        <lpage>1011</lpage>
        <pub-id pub-id-type="doi">10.1101/gr.160374.113</pub-id>
        <?supplied-pmid 24501021?>
        <pub-id pub-id-type="pmid">24501021</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Carty</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>An integrated model for detecting significant chromatin interactions from high-resolution Hi-C data</article-title>
        <source>Nat. Commun.</source>
        <year>2017</year>
        <volume>8</volume>
        <fpage>15454</fpage>
        <pub-id pub-id-type="doi">10.1038/ncomms15454</pub-id>
        <?supplied-pmid 28513628?>
        <pub-id pub-id-type="pmid">28513628</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <mixed-citation publication-type="other">Cameron, C. J., Dostie, J. &amp; Blanchette, M. Estimating DNA-DNA interaction frequency from Hi-C data at restriction-fragment resolution. <italic>bioRxiv</italic> 377523 (2018).</mixed-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Roayaei Ardakany</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Gezer</surname>
            <given-names>HT</given-names>
          </name>
          <name>
            <surname>Lonardi</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Ay</surname>
            <given-names>F</given-names>
          </name>
        </person-group>
        <article-title>Mustache: multi-scale detection of chromatin loops from Hi-C and Micro-C maps using scale-space representation</article-title>
        <source>Genome Biol.</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>1</fpage>
        <lpage>17</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-020-02167-0</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Matthey-Doret</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Computer vision for pattern detection in chromosome contact maps</article-title>
        <source>Nat. Commun.</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>1</fpage>
        <lpage>11</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-020-19562-7</pub-id>
        <pub-id pub-id-type="pmid">31911652</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lee</surname>
            <given-names>D-I</given-names>
          </name>
          <name>
            <surname>Roy</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Grinch: simultaneous smoothing and detection of topological units of genome organization from sparse chromatin contact count matrices with matrix factorization</article-title>
        <source>Genome Biol.</source>
        <year>2021</year>
        <volume>22</volume>
        <fpage>1</fpage>
        <lpage>31</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-021-02378-z</pub-id>
        <pub-id pub-id-type="pmid">33397451</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <mixed-citation publication-type="other">Zhang, S. et al. Deeploop robustly maps chromatin interactions from sparse allele-resolved or single-cell Hi-C data at kilobase resolution. <italic>Nat. Genet.</italic><bold>54</bold>, 1013–1025 (2022).</mixed-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhang</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Zhou</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Ma</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Multiscale and integrative single-cell Hi-C analysis with higashi</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2022</year>
        <volume>40</volume>
        <fpage>254</fpage>
        <lpage>261</lpage>
        <pub-id pub-id-type="doi">10.1038/s41587-021-01034-y</pub-id>
        <?supplied-pmid 34635838?>
        <pub-id pub-id-type="pmid">34635838</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Howie</surname>
            <given-names>BN</given-names>
          </name>
          <name>
            <surname>Donnelly</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Marchini</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>A flexible and accurate genotype imputation method for the next generation of genome-wide association studies</article-title>
        <source>PLoS Genet.</source>
        <year>2009</year>
        <volume>5</volume>
        <fpage>e1000529</fpage>
        <pub-id pub-id-type="doi">10.1371/journal.pgen.1000529</pub-id>
        <?supplied-pmid 19543373?>
        <pub-id pub-id-type="pmid">19543373</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Delaneau</surname>
            <given-names>O</given-names>
          </name>
          <name>
            <surname>Marchini</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Zagury</surname>
            <given-names>J-F</given-names>
          </name>
        </person-group>
        <article-title>A linear complexity phasing method for thousands of genomes</article-title>
        <source>Nat. Methods</source>
        <year>2012</year>
        <volume>9</volume>
        <fpage>179</fpage>
        <lpage>181</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.1785</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Peng</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Xu</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>RaptorX: exploiting structure information for protein alignment by statistical inference</article-title>
        <source>Proteins: Struct. Funct. Bioinform.</source>
        <year>2011</year>
        <volume>79</volume>
        <fpage>161</fpage>
        <lpage>171</lpage>
        <pub-id pub-id-type="doi">10.1002/prot.23175</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <mixed-citation publication-type="other">Thang L., Hieu P. &amp; Christopher D. M. Effective Approaches to Attention-based Neural Machine Translation. In <italic>Proceedings of the 2015 Conference on Empirical Methods in Natural Language Processing,</italic> 1412–1421, Lisbon, Portugal, (Association for Computational Linguistics, 2015)</mixed-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tang</surname>
            <given-names>Z</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>CTCF-mediated human 3D genome architecture reveals chromatin topology for transcription</article-title>
        <source>Cell</source>
        <year>2015</year>
        <volume>163</volume>
        <fpage>1611</fpage>
        <lpage>1627</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2015.11.024</pub-id>
        <?supplied-pmid 26686651?>
        <pub-id pub-id-type="pmid">26686651</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <collab>ENCODE Project Consortium.</collab>
          <etal/>
        </person-group>
        <article-title>An integrated encyclopedia of DNA elements in the human genome</article-title>
        <source>Nature</source>
        <year>2012</year>
        <volume>489</volume>
        <fpage>57</fpage>
        <pub-id pub-id-type="doi">10.1038/nature11247</pub-id>
        <pub-id pub-id-type="pmid">22955616</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Mumbach</surname>
            <given-names>MR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Hichip: efficient and sensitive analysis of protein-directed genome architecture</article-title>
        <source>Nat. Methods</source>
        <year>2016</year>
        <volume>13</volume>
        <fpage>919</fpage>
        <lpage>922</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.3999</pub-id>
        <?supplied-pmid 27643841?>
        <pub-id pub-id-type="pmid">27643841</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Mumbach</surname>
            <given-names>MR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Enhancer connectome in primary human cells identifies target genes of disease-associated DNA elements</article-title>
        <source>Nat. Genet.</source>
        <year>2017</year>
        <volume>49</volume>
        <fpage>1602</fpage>
        <lpage>1612</lpage>
        <pub-id pub-id-type="doi">10.1038/ng.3963</pub-id>
        <?supplied-pmid 28945252?>
        <pub-id pub-id-type="pmid">28945252</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rao</surname>
            <given-names>SSP</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cohesin loss eliminates all loop domains</article-title>
        <source>Cell</source>
        <year>2017</year>
        <volume>171</volume>
        <fpage>305</fpage>
        <lpage>320</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2017.09.026</pub-id>
        <?supplied-pmid 28985562?>
        <pub-id pub-id-type="pmid">28985562</pub-id>
      </element-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bonev</surname>
            <given-names>B</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Multiscale 3D genome rewiring during mouse neural development</article-title>
        <source>Cell</source>
        <year>2017</year>
        <volume>171</volume>
        <fpage>557</fpage>
        <lpage>572</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2017.09.043</pub-id>
        <?supplied-pmid 29053968?>
        <pub-id pub-id-type="pmid">29053968</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Shin</surname>
            <given-names>H</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>TopDom: an efficient and deterministic method for identifying topological domains in genomes</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2016</year>
        <volume>44</volume>
        <fpage>e70</fpage>
        <lpage>e70</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkv1505</pub-id>
        <?supplied-pmid 26704975?>
        <pub-id pub-id-type="pmid">26704975</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Filippova</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Patro</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Duggal</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Kingsford</surname>
            <given-names>C</given-names>
          </name>
        </person-group>
        <article-title>Identification of alternative topological domains in chromatin</article-title>
        <source>Algorithms Mol. Biol.</source>
        <year>2014</year>
        <volume>9</volume>
        <fpage>1</fpage>
        <lpage>11</lpage>
        <pub-id pub-id-type="doi">10.1186/1748-7188-9-14</pub-id>
        <pub-id pub-id-type="pmid">24507724</pub-id>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Decoding topologically associating domains with ultra-low resolution Hi-C data by graph structural entropy</article-title>
        <source>Nat. Commun.</source>
        <year>2018</year>
        <volume>9</volume>
        <fpage>1</fpage>
        <lpage>12</lpage>
        <pub-id pub-id-type="pmid">29317637</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>XT</given-names>
          </name>
          <name>
            <surname>Cui</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Peng</surname>
            <given-names>C</given-names>
          </name>
        </person-group>
        <article-title>HiTAD: detecting the structural and functional hierarchies of topologically associating domains from chromatin interactions</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2017</year>
        <volume>45</volume>
        <fpage>e163</fpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkx735</pub-id>
        <?supplied-pmid 28977529?>
        <pub-id pub-id-type="pmid">28977529</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <mixed-citation publication-type="other">Roayaei Ardakany, A. &amp; Lonardi, S. Efficient and accurate detection of topologically associating domains from contact maps. in <italic>17th International Workshop on Algorithms in Bioinformatics (WABI 2017)</italic> (Schloss Dagstuhl-Leibniz-Zentrum fuer Informatik, 2017).</mixed-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>An</surname>
            <given-names>L</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>OnTAD: hierarchical domain structure reveals the divergence of activity among TADs and boundaries</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>20</volume>
        <fpage>1</fpage>
        <lpage>16</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1893-y</pub-id>
        <pub-id pub-id-type="pmid">30606230</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhan</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Reciprocal insulation analysis of Hi-C data shows that TADs represent a functionally but not structurally privileged scale in the hierarchical folding of chromosomes</article-title>
        <source>Genome Res.</source>
        <year>2017</year>
        <volume>27</volume>
        <fpage>479</fpage>
        <lpage>490</lpage>
        <pub-id pub-id-type="doi">10.1101/gr.212803.116</pub-id>
        <?supplied-pmid 28057745?>
        <pub-id pub-id-type="pmid">28057745</pub-id>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dixon</surname>
            <given-names>JR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Topological domains in mammalian genomes identified by analysis of chromatin interactions</article-title>
        <source>Nature</source>
        <year>2012</year>
        <volume>485</volume>
        <fpage>376</fpage>
        <lpage>380</lpage>
        <pub-id pub-id-type="doi">10.1038/nature11082</pub-id>
        <?supplied-pmid 22495300?>
        <pub-id pub-id-type="pmid">22495300</pub-id>
      </element-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Yu</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>He</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Tan</surname>
            <given-names>K</given-names>
          </name>
        </person-group>
        <article-title>Identifying topologically associating domains and subdomains by gaussian mixture model and proportion test</article-title>
        <source>Nat. Commun.</source>
        <year>2017</year>
        <volume>8</volume>
        <fpage>1</fpage>
        <lpage>9</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-017-00478-8</pub-id>
        <pub-id pub-id-type="pmid">28232747</pub-id>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lévy-Leduc</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Delattre</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Mary-Huard</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Robin</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Two-dimensional segmentation for analyzing Hi-C data</article-title>
        <source>Bioinformatics</source>
        <year>2014</year>
        <volume>30</volume>
        <fpage>i386</fpage>
        <lpage>i392</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btu443</pub-id>
        <?supplied-pmid 25161224?>
        <pub-id pub-id-type="pmid">25161224</pub-id>
      </element-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Haddad</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Vaillant</surname>
            <given-names>Cédric</given-names>
          </name>
          <name>
            <surname>Jost</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>Ic-finder: inferring robustly the hierarchical organization of chromatin folding</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2017</year>
        <volume>45</volume>
        <fpage>e81</fpage>
        <lpage>e81</lpage>
        <?supplied-pmid 28130423?>
        <pub-id pub-id-type="pmid">28130423</pub-id>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <mixed-citation publication-type="other">Gao, T., Yao, X. &amp; Chen, D. SimCSE: Simple Contrastive Learning of Sentence Embeddings. In <italic>Proceedings of the 2021 Conference on Empirical Methods in Natural Language Processing</italic>, 6894–6910, Online and Punta Cana, Dominican Republic (Association for Computational Linguistics, 2021).</mixed-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhang</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Enhancing Hi-C data resolution with deep convolutional neural network HiCPlus</article-title>
        <source>Nat. Commun.</source>
        <year>2018</year>
        <volume>9</volume>
        <fpage>750</fpage>
        <pub-id pub-id-type="doi">10.1038/s41467-018-03113-2</pub-id>
        <?supplied-pmid 29467363?>
        <pub-id pub-id-type="pmid">29467363</pub-id>
      </element-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <mixed-citation publication-type="other">Liu, T. &amp; Wang, Z. HiCNN: a very deep convolutional neural network to better enhance the resolution of Hi-C data. <italic>Bioinformatics</italic><bold>35</bold>, 4222–4228 (2019).</mixed-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dsouza</surname>
            <given-names>KB</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Learning representations of chromatin contacts using a recurrent neural network identifies genomic drivers of conformation</article-title>
        <source>Nat. Commun.</source>
        <year>2022</year>
        <volume>13</volume>
        <fpage>1</fpage>
        <lpage>19</lpage>
        <pub-id pub-id-type="doi">10.1038/s41467-022-31337-w</pub-id>
        <pub-id pub-id-type="pmid">34983933</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rodriguez</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Laio</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Clustering by fast search and find of density peaks</article-title>
        <source>Science</source>
        <year>2014</year>
        <volume>344</volume>
        <fpage>1492</fpage>
        <lpage>1496</lpage>
        <pub-id pub-id-type="doi">10.1126/science.1242072</pub-id>
        <?supplied-pmid 24970081?>
        <pub-id pub-id-type="pmid">24970081</pub-id>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Virtanen</surname>
            <given-names>P</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>SciPy 1.0: fundamental algorithms for scientific computing in python</article-title>
        <source>Nat. Methods</source>
        <year>2020</year>
        <volume>17</volume>
        <fpage>261</fpage>
        <lpage>272</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0686-2</pub-id>
        <?supplied-pmid 32015543?>
        <pub-id pub-id-type="pmid">32015543</pub-id>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <mixed-citation publication-type="other">Loshchilov, I., &amp; Hutter, F. Decoupled Weight Decay Regularization. In <italic>Seventh Int Conf Learn Represent ICLR</italic>. Ernest N. Morial Convention Center, New Orleans, USA (2019).</mixed-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <mixed-citation publication-type="other">Lin, T. Y., Goyal, P., Girshick, R., He, K. &amp; Dollár, P. Focal loss for dense object detection. in <italic>Proceedings of the IEEE International Conference on Computer Vision</italic> 2980–2988 (2017).</mixed-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <mixed-citation publication-type="other">You, Y., Gitman, I. &amp; Ginsburg, B. Large batch training of convolutional networks. Preprint at <ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1708.03888">https://arxiv.org/abs/1708.03888</ext-link> (2017).</mixed-citation>
    </ref>
    <ref id="CR51">
      <label>51.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kruse</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Hug</surname>
            <given-names>CB</given-names>
          </name>
          <name>
            <surname>Vaquerizas</surname>
            <given-names>JM</given-names>
          </name>
        </person-group>
        <article-title>FAN-C: a feature-rich framework for the analysis and visualisation of chromosome conformation capture data</article-title>
        <source>Genome Biol.</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>1</fpage>
        <lpage>19</lpage>
        <pub-id pub-id-type="doi">10.1186/s13059-020-02215-9</pub-id>
      </element-citation>
    </ref>
    <ref id="CR52">
      <label>52.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Durand</surname>
            <given-names>NC</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Juicer provides a one-click system for analyzing loop-resolution Hi-C experiments</article-title>
        <source>Cell Syst.</source>
        <year>2016</year>
        <volume>3</volume>
        <fpage>95</fpage>
        <lpage>98</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2016.07.002</pub-id>
        <?supplied-pmid 27467249?>
        <pub-id pub-id-type="pmid">27467249</pub-id>
      </element-citation>
    </ref>
    <ref id="CR53">
      <label>53.</label>
      <mixed-citation publication-type="other">Dali, R., Bourque, G. &amp; Blanchette, M. RobusTAD: a tool for robust annotation of topologically associating domain boundaries Y. zhyanlin/RobusTAD (python version). <italic>Zenodo</italic>10.5281/zenodo.7323564 (2022).</mixed-citation>
    </ref>
    <ref id="CR54">
      <label>54.</label>
      <mixed-citation publication-type="other">Venev, S. et al. open2c/cooltools: v0.4.1, August (2021).</mixed-citation>
    </ref>
    <ref id="CR55">
      <label>55.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Karolchik</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The UCSC table browser data retrieval tool</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2004</year>
        <volume>32</volume>
        <fpage>D493</fpage>
        <lpage>D496</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkh103</pub-id>
        <?supplied-pmid 14681465?>
        <pub-id pub-id-type="pmid">14681465</pub-id>
      </element-citation>
    </ref>
    <ref id="CR56">
      <label>56.</label>
      <mixed-citation publication-type="other">Li, H. Aligning sequence reads, clone sequences and assembly contigs with BWA-MEM. Preprint at <ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1303.3997">https://arxiv.org/abs/1303.3997</ext-link> (2013).</mixed-citation>
    </ref>
    <ref id="CR57">
      <label>57.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Abdennur</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Mirny</surname>
            <given-names>LA</given-names>
          </name>
        </person-group>
        <article-title>Cooler: scalable storage for Hi-C data and other genomically labeled arrays</article-title>
        <source>Bioinformatics</source>
        <year>2020</year>
        <volume>36</volume>
        <fpage>311</fpage>
        <lpage>316</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btz540</pub-id>
        <?supplied-pmid 31290943?>
        <pub-id pub-id-type="pmid">31290943</pub-id>
      </element-citation>
    </ref>
    <ref id="CR58">
      <label>58.</label>
      <mixed-citation publication-type="other">Paszke, A. et al. In <italic>Advances in Neural Information Processing Systems</italic> (eds Wallach, H. et al.) 32, 8024–8035 (Curran Associates, Inc., 2019).</mixed-citation>
    </ref>
    <ref id="CR59">
      <label>59.</label>
      <mixed-citation publication-type="other">McKinney, W. Data structures for statistical computing in python. <italic>Proc. of the 9th Python Sci. Conf.</italic><bold>445</bold>, 56–61 (2010).</mixed-citation>
    </ref>
    <ref id="CR60">
      <label>60.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Harris</surname>
            <given-names>CR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Array programming with NumPy</article-title>
        <source>Nature</source>
        <year>2020</year>
        <volume>585</volume>
        <fpage>357</fpage>
        <lpage>362</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-020-2649-2</pub-id>
        <?supplied-pmid 32939066?>
        <pub-id pub-id-type="pmid">32939066</pub-id>
      </element-citation>
    </ref>
    <ref id="CR61">
      <label>61.</label>
      <mixed-citation publication-type="other">Zhang, Y. &amp; Blanchette, M. Reference panel guided topological structure annotation of Hi-C data, RefHiC reproducibility. <italic>Zenodo</italic>10.5281/zenodo.7133194 (2022)</mixed-citation>
    </ref>
    <ref id="CR62">
      <label>62.</label>
      <mixed-citation publication-type="other">Zhang, Y. &amp; Blanchette, M. Reference panel guided topological structure annotation of Hi-C data, RefHiC. <italic>Zenodo</italic>10.5281/zenodo.7324669 (2022).</mixed-citation>
    </ref>
  </ref-list>
</back>
