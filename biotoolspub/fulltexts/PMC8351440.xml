<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">BMC Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">BMC Bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>BMC Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="epub">1471-2105</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">8351440</article-id>
    <article-id pub-id-type="publisher-id">4314</article-id>
    <article-id pub-id-type="doi">10.1186/s12859-021-04314-1</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Research Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>CoSTA: unsupervised convolutional neural network learning for spatial transcriptomics analysis</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Xu</surname>
          <given-names>Yang</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-0010-5323</contrib-id>
        <name>
          <surname>McCord</surname>
          <given-names>Rachel Patton</given-names>
        </name>
        <address>
          <email>rmccord@utk.edu</email>
        </address>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.411461.7</institution-id><institution-id institution-id-type="ISNI">0000 0001 2315 1184</institution-id><institution>UT-ORNL Graduate School of Genome Science and Technology, </institution><institution>University of Tennessee, </institution></institution-wrap>Knoxville, TN USA </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.411461.7</institution-id><institution-id institution-id-type="ISNI">0000 0001 2315 1184</institution-id><institution>Department of Biochemistry &amp; Cellular and Molecular Biology, </institution><institution>University of Tennessee, </institution></institution-wrap>Knoxville, TN USA </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>9</day>
      <month>8</month>
      <year>2021</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>9</day>
      <month>8</month>
      <year>2021</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2021</year>
    </pub-date>
    <volume>22</volume>
    <elocation-id>397</elocation-id>
    <history>
      <date date-type="received">
        <day>14</day>
        <month>6</month>
        <year>2021</year>
      </date>
      <date date-type="accepted">
        <day>2</day>
        <month>8</month>
        <year>2021</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2021</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold>This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons licence, and indicate if changes were made. The images or other third party material in this article are included in the article's Creative Commons licence, unless indicated otherwise in a credit line to the material. If material is not included in the article's Creative Commons licence and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this licence, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>. The Creative Commons Public Domain Dedication waiver (<ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/publicdomain/zero/1.0/">http://creativecommons.org/publicdomain/zero/1.0/</ext-link>) applies to the data made available in this article, unless otherwise stated in a credit line to the data.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <sec>
        <title>Background</title>
        <p id="Par1">The rise of spatial transcriptomics technologies is leading to new insights about how gene regulation happens in a spatial context. Determining which genes are expressed in similar spatial patterns can reveal gene regulatory relationships across cell types in a tissue. However, many current analysis methods do not take full advantage of the spatial organization of the data, instead treating pixels as independent features. Here, we present CoSTA: a novel approach to learn spatial similarities between gene expression matrices via convolutional neural network (ConvNet) clustering.</p>
      </sec>
      <sec>
        <title>Results</title>
        <p id="Par2">By analyzing simulated and previously published spatial transcriptomics data, we demonstrate that CoSTA learns spatial relationships between genes in a way that emphasizes broader spatial patterns rather than pixel-level correlation. CoSTA provides a quantitative measure of expression pattern similarity between each pair of genes rather than only classifying genes into categories. We find that CoSTA identifies narrower, but biologically relevant, sets of significantly related genes as compared to other approaches.</p>
      </sec>
      <sec>
        <title>Conclusions</title>
        <p id="Par3">The deep learning CoSTA approach provides a different angle to spatial transcriptomics analysis by focusing on the shape of expression patterns, using more information about the positions of neighboring pixels than would an overlap or pixel correlation approach. CoSTA can be applied to any spatial transcriptomics data represented in matrix form and may have future applications to datasets such as histology in which images of different genes are from similar but not identical biological sections.</p>
      </sec>
      <sec>
        <title>Supplementary Information</title>
        <p>The online version contains supplementary material available at 10.1186/s12859-021-04314-1.</p>
      </sec>
    </abstract>
    <kwd-group xml:lang="en">
      <title>Keywords</title>
      <kwd>Spatial transcriptomics</kwd>
      <kwd>Gene clustering</kwd>
      <kwd>Convolutional neural network</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000057</institution-id>
            <institution>National Institute of General Medical Sciences</institution>
          </institution-wrap>
        </funding-source>
        <award-id>R35GM133557</award-id>
        <principal-award-recipient>
          <name>
            <surname>McCord</surname>
            <given-names>Rachel Patton</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2021</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Background</title>
    <p id="Par7">Spatial transcriptomics has recently gained extensive attention from the scientific community. Different technologies have enabled high resolution measurements of how gene regulation is spatially organized across a tissue or thousands of single cells [<xref ref-type="bibr" rid="CR1">1</xref>]. Analyses of these data have the potential to reveal spatial regulatory relationships between genes. However, current analysis pipelines often treat each pixel in an expression matrix as an independent feature, thus losing spatial information. For example, the seqFISH+ technique can fluorescently detect 10,000 mRNAs in situ at single cell resolution, and there are often groups of cells that have correlated gene expression with their neighbors to make up larger structures. However, the original report analyzed these expression patterns using PCA and hierarchical clustering, treating each cell as an independent feature, rather than preserving spatial positions of cell neighbors [<xref ref-type="bibr" rid="CR2">2</xref>]. Slide-seq similarly produces high-throughput spatially resolved transcription information, using sequencing rather than fluorescence. Previous analyses of Slide-seq data first identified spatially non-random gene expression, but then looked for genes expressed in similar patterns using pixel-level overlap analysis rather than according to spatial features [<xref ref-type="bibr" rid="CR3">3</xref>]. Existing algorithms for analysis of spatial transcriptomics are based on statistical modeling and primarily propose to distinguish spatially expressing or variable (SE or SV) genes from random spatial expression noise. For example, both SpatialDE and SPARK analysis approaches estimate how significant the spatial pattern of a gene is [<xref ref-type="bibr" rid="CR4">4</xref>, <xref ref-type="bibr" rid="CR5">5</xref>]. SpatialDE further builds in an unsupervised pattern detection algorithm to cluster significant SE genes into different groups which have certain spatial patterns in collective. SPARK, in contrast, was designed only for finding SE genes. To examine spatial relationships between genes, this method still relies on hierarchical clustering that uses individual pixels as features. Therefore, even though SPARK can identify genes with significant spatial patterns, the latter part of the SPARK analysis decouples the expression from its original spatial context. Thus far, existing spatial transcriptomics analyses involve either multi-step complex feature engineering for spatial quantification or human-imposed rigid or statistical modeling-based screening of candidate SE genes. In the existing methods, the similarity of expression pattern between two genes is either binary- whether or not the genes cluster together- or is quantified based on pixel-level correlation.</p>
    <p id="Par8">In this work, we propose an approach inspired by computer vision and image classification to find relationships between spatial expression patterns of different genes while preserving the full spatial context (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a). Our goal is to find quantitative comparisons between gene expression patterns in a way that preserves spatial relationships between neighboring cells and tissue regions. We aim for a method that will recognize an overall similar shape of expression, even if certain sets of pixels are not exactly overlapping. This is conceptually similar to image recognition in computer vision tasks. The use of convolutional neural networks brought a success of deep learning in computer vision and have demonstrated a wide range of applications, including image classification and object recognition. A few groups have proposed different approaches to use convolutional neural networks (ConvNet) in unsupervised learning [<xref ref-type="bibr" rid="CR6">6</xref>–<xref ref-type="bibr" rid="CR8">8</xref>]. Thus, here, we adopt an unsupervised <bold>Co</bold>nvNet learning strategy for <bold>S</bold>patial <bold>T</bold>ranscriptomics <bold>A</bold>nalysis (CoSTA). With simulated data, we show that CoSTA can correctly classify a variety of different spatial patterns and that the patterns CoSTA is detecting depend on spatial groupings rather than individual pixels. Then, we apply CoSTA to published MERFISH and Slide-seq data and show that CoSTA sometimes identifies smaller sets of genes with significant spatial relationships, but these identified relationships are biologically relevant.<fig id="Fig1"><label>Fig. 1</label><caption><p>CoSTA model approach and motivation. <bold>A</bold> Overall CoSTA pipeline. Inputs are gene matrices from spatial transcriptomic experiments. ConvNet stage forwards images through 3 convolutional layers and then flattens the output into a spatial representation vector. UMAP reduces dimensionality of the spatial representations from the ConvNet stage before these gene representations are used to cluster genes with GMM. Each gene is then assigned cluster probabilities based on distances to cluster centroids, which are transformed to an auxiliary target distribution that can be minimized by reducing bi-tempered logistic loss and/or center loss. Gradients are backpropagated through a fully connected layer to ConvNet. The process is repeated until the model converges, at which point the output from the ConvNet is used as the final spatial representation (red arrow). <bold>B</bold> Biologically-inspired example in which overlap does not capture all aspects of spatial pattern similarity. Rectangles represent an epithelial cell layer while ovals represent stromal cells. By overlap comparison, Gene 1 has the same similarity to both Gene 2 and Gene 3 (40% overlap). However, the biologically relevant expression along the epithelial layer is only shared between Gene 1 and Gene 2. Detecting this shape similarity requires learning a spatial representation. <bold>C</bold> Performance of CoSTA in synthetic datasets. Left panel: 5 real expression patterns in mouse olfactory bulb data replicate 11. We generated 2,000 simulated gene expression matrices for each pattern with different levels of noise. Right panel: learning curves of CoSTA classifying simulated genes belonging to these 5 patterns with different noise levels. Normalized Mutual Information (NMI) values quantify the similarity between clustering labels assigned by CoSTA and the true class label across all 5 patterns</p></caption><graphic xlink:href="12859_2021_4314_Fig1_HTML" id="MO1"/></fig></p>
  </sec>
  <sec id="Sec2">
    <title>Results</title>
    <sec id="Sec3">
      <title>CoSTA architecture: training a ConvNet with pseudo-labels generated by GMM clustering</title>
      <p id="Par9">Though there are many unsupervised learning strategies, we chose to apply the workflow of DeepCluster, because it is straightforward and easy to implement [<xref ref-type="bibr" rid="CR6">6</xref>]. Our CoSTA approach consists of two main parts: clustering by Gaussian mixture model (GMM) and weight updating as commonly performed in training neural networks (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a and see <xref rid="Sec13" ref-type="sec">Methods</xref> for detailed description). Our inputs are sets of gene expression images, where each image is the matrix recording the expression levels of one gene at each position in space and all images belong to the same biological space. We first initialize a ConvNet randomly and then forward these gene expression matrices through the ConvNet. Our ConvNet consists of three convolutional layers, and each convolutional layer is followed by a batch normalization layer and a max pooling layer. We flatten the matrix output from the last max pooling layer into a vector that captures the spatial features of the gene expression data. The size of this vector will vary depending on the image size from a given spatial transcriptomics technique. We then apply L2-normalization across features and reduce dimensionality by UMAP before we perform GMM clustering of genes. UMAP can preserve global and local structures during dimension reduction and previously showed better performance in image clustering than other dimension-reduction methods such as Isomap and t-SNE [<xref ref-type="bibr" rid="CR7">7</xref>, <xref ref-type="bibr" rid="CR9">9</xref>]. The purpose of this clustering is to generate labels so that we can update the ConvNet as in other common supervised neural network training approaches. When the ConvNet is randomly initialized, features extracted by this ConvNet are weak. However, using them to generate labels can still guide the ConvNet to learn more discriminative features. Indeed, Caron et al. showed DeepCluster can learn from weak signal to bootstrap the discriminative power of a ConvNet [<xref ref-type="bibr" rid="CR6">6</xref>]. Instead of giving each gene a single cluster label, we assign an auxiliary target distribution as a soft assignment. This approach emphasizes genes with high confidence in the clustering task and discounts noisy labels persisting from the random initialization of ConvNet. Doing this can also lead to more stable target values for training the neural network [<xref ref-type="bibr" rid="CR8">8</xref>]. Finally, we use these soft assignments to train the ConvNet. We add a fully connected layer after the ConvNet that produces probabilities for each gene being assigned to each label. Thus, we can optimize the model by minimizing bi-tempered logistic loss based on Bregman Divergences between the soft assignments from GMM clustering and the probabilities from the fully connected layer [<xref ref-type="bibr" rid="CR10">10</xref>]. In summary, the CoSTA approach uses a ConvNet clustering architecture which repeats (1) generating features by ConvNet, (2) generating soft assignments by GMM clustering, and (3) using soft assignments to update ConvNet. Once we finish training, we only retain the trained ConvNet for the purpose of feature extraction. Since the ConvNet mainly consists of convolutional layers, the final vector for each gene extracted by ConvNet should be a spatial representation. Using this spatial representation, we can then quantify the relationship between any two genes within one spatial transcriptomics dataset, visualize all SE genes in this dataset by UMAP, and assign patterns through common clustering algorithms. Further details about the rationale of this learning architecture can be found in <xref rid="Sec13" ref-type="sec">Methods</xref>.</p>
    </sec>
    <sec id="Sec4">
      <title>Rationale for using spatial patterns rather than exact pixel overlap</title>
      <p id="Par10">To demonstrate the spatial information lost by overlap analysis and why a spatial representation approach such as CoSTA is useful, we present a simplified biologically-inspired conceptual example (Fig. <xref rid="Fig1" ref-type="fig">1</xref>b). In biological tissue sections, we commonly observe structures such as a tightly connected epithelial layer of cells (rectangles in the cartoon) adjacent to a collection of stromal cells (circles). In this example, the spatial expression patterns of three genes are shown. Comparing gene expression patterns by overlap only, we observe that Gene 1 and 2 have the same amount of overlap as Gene 1 and 3 (40%). Thus, an overlap approach to measure gene pattern similarity, like the one used in previous Slide-seq analysis, would report that Gene 1 is equally similar to both Gene 2 and Gene 3 [<xref ref-type="bibr" rid="CR3">3</xref>]. However, biologically, it is relevant that Gene 1 and Gene 2 are expressed primarily in the epithelial layer while Gene 3 is expressed in the stroma. This biological difference is not detected by strict overlap, but instead requires a spatial representation that would detect the vertical stripe of epithelial layer expression as a salient pattern. In computer vision, filters are commonly used to find this kind of local correlation, and the success of ConvNet in pattern recognition also relies in the use of filters for identifying local correlations. Using signals of how these 3 genes respond to the same filters, a ConvNet approach will identify Gene 1 and 2 as more similar and Gene 3 as less similar. Therefore, we are motivated to use our ConvNet clustering based CoSTA approach to prioritize similar shape more than overlap for biological cases where layers of cells and the overall patterns of groups of cells matter more than independent individual cell identities [<xref ref-type="bibr" rid="CR11">11</xref>].</p>
    </sec>
    <sec id="Sec5">
      <title>Tests on synthetic data show CoSTA’s high specificity, reliance on spatial relationships, and ability to distinguish signal from noise</title>
      <p id="Par11">As a first test of CoSTA’s ability to detect correlated spatial patterns in the absence of exact overlap, we use the MNIST handwritten digit image data [<xref ref-type="bibr" rid="CR12">12</xref>]. When the aim is to find which digits have correlated handwritten patterns to the digit 3, CoSTA identifies only other instances of digit 3 as correlated (100% specificity). In contrast, overlap analysis finds some samples of all other digits as correlated digits of 3 (58% specificity) (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1). Meanwhile, CoSTA identifies a smaller subset of the digit 3 s as correlated (35% sensitivity) while overlap analysis captures more correlated digits overall (65% sensitivity) in its less specific set (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1). As shown below, this increased specificity but possibly decreased sensitivity of CoSTA compared to other techniques appears to hold true in biological data as well.</p>
      <p id="Par12">Before applying CoSTA to real spatial transcriptomics data, we next tested its performance on 5 synthetic datasets, simulated based on real expression patterns from mouse olfactory bulb, following the simulation method in SPARK (Fig. <xref rid="Fig1" ref-type="fig">1</xref>c left panel) [<xref ref-type="bibr" rid="CR5">5</xref>, <xref ref-type="bibr" rid="CR13">13</xref>]. We generated 2000 fake gene expression matrices for each pattern, to mimic data for 10,000 total genes. To simulate noise and variability for each gene, we added residual errors onto each spatial coordinate independently based on a normal distribution with mean of zero and variance ranging from 0.2 to 0.6. We then evaluated whether CoSTA could assign each simulated noisy gene to the correct pattern. To compare the CoSTA-derived cluster assignments to the true labels, we use the well-established cluster comparison metric Normalized Mutual Information (NMI) [<xref ref-type="bibr" rid="CR14">14</xref>]. The NMI approaches a value of 1 as the assignment of genes to the 5 patterns becomes more and more accurate. When CoSTA was initialized, the NMI ranged from 0.27 to 0.57 (Fig. <xref rid="Fig1" ref-type="fig">1</xref>c right panel). As training proceeded, CoSTA learned discriminative features to distinguish the 5 patterns, eventually achieving NMIs from 0.85 to 0.98 against the true class label (Fig. <xref rid="Fig1" ref-type="fig">1</xref>c right panel, Additional file <xref rid="MOESM13" ref-type="media">13</xref>: Table S1). For the highest noise level (0.6) we found that combining both center loss (CL) and bi-tempered logistic loss during CoSTA training substantially improved CoSTA’s accuracy (NMI increased from 0.52 to 0.91). However, CL pushes samples toward the 5 centroids and is only applicable when the final number of patterns is known. Thus, we do not include CL for true biological situations.</p>
      <p id="Par13">To demonstrate that CoSTA learns spatial rather than pixel-level patterns from these synthetic datasets, we shuffled the pixel positions in these synthetic datasets. Shuffling all the gene matrices exactly the same way keeps the pixelwise overlap information identical while disrupting correlations between neighboring pixels, thus destroying the spatial pattern (see <xref rid="Sec13" ref-type="sec">Methods</xref> for details). If a pattern detection method is successfully using spatial relationships between neighboring pixels, its ability to classify patterns should be disrupted by this kind of shuffling. Indeed, we found that CoSTA cannot distinguish the genes into correct pattern labels as well with shuffled data (NMI ranges from 0.32 to 0.89), demonstrating that CoSTA is detecting spatial features that depend on the positions of neighboring pixels, rather than features that can be captured by a set of single pixels (Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Fig. S2 and Additional file <xref rid="MOESM13" ref-type="media">13</xref>: Table S1). When we applied the CoSTA model trained at 0.4 noise level to progressively more shuffled images, we found that the ability to classify genes into groups declined proportional to the amount of shuffling (Additional file <xref rid="MOESM3" ref-type="media">3</xref>: Figure S3A). We also tested SpatialDE on these true and shuffled synthetic datasets. SpatialDE performed very well on the true datasets, as expected. However, shuffling the data did not usually change the performance of SpatialDE (Additional file <xref rid="MOESM13" ref-type="media">13</xref>: Table S1), indicating an important difference between CoSTA and SpatialDE: SpatialDE is more likely to detect patterns of individual pixels while CoSTA emphasizes the spatial positions of these pixels relative to each other and overall shapes of patterns.</p>
      <p id="Par14">Using this same synthetic data, we next performed a disruption test to demonstrate a disadvantage of using individual pixels as features to analyze spatial transcriptomics data. For half of the simulated gene matrices, we masked a certain region of the pattern, and the masked region doesn’t change expression pattern visually (Additional file <xref rid="MOESM3" ref-type="media">3</xref>: Fig. S3b). This mimics a situation in which a certain region is obscured or not sampled well for technical reasons experimentally. Using pixel overlap to identify patterns, in this case, assigns masked and unmasked genes into separate groups, even though they otherwise belong to the same pattern. In contrast, CoSTA is resistant to this disruption (Additional file <xref rid="MOESM3" ref-type="media">3</xref>: Fig. S3b).</p>
      <p id="Par15">In real spatial transcriptomics data, not all genes will belong to a clear spatial pattern—some genes that are not relevant to the given tissue or condition may only yield random noise or be fairly uniformly expressed. To mimic this situation, we further followed the simulation approach in SPARK to generate synthetic datasets that have 5 spatial patterns and have mixed SE (spatially expressed) and non-SE genes (Additional file <xref rid="MOESM4" ref-type="media">4</xref>: Fig. S4). We trained CoSTA on these data with different ratios of SE and non-SE genes, from 90:10 to 10:90. We found that the representation of SE genes by CoSTA is distinct from non-SE genes, even when CoSTA was trained with a high percentage of non-SE genes. Meanwhile, CoSTA demonstrates the capacity to distinguish different patterns of SE genes even when non-SE genes exist (Additional file <xref rid="MOESM4" ref-type="media">4</xref>: Fig. S4). Further, CoSTA does not separate even a large number of non-SE genes into separate categories, showing that it does not create false signal out of noise. Here, we also note that a strength of CoSTA compared to methods like SpatialDE is that the output feature vector enables visualization, as is presented throughout these simulation results. While Spatial DE can classify genes into categories, it does not produce a result that can visualize how SE and non-SE genes are separated as we did here for CoSTA. Overall, the performance of CoSTA with synthetic data demonstrates that CoSTA can learn discriminating spatial features.</p>
    </sec>
    <sec id="Sec6">
      <title>CoSTA classifies genes by cell type and identifies quantitative relationships between genes in MERFISH data</title>
      <p id="Par16">To extend the application of CoSTA to real spatial transcriptomics data, we first applied it to reanalyze a MERFISH dataset (see MERFISH Analysis in <xref rid="Sec13" ref-type="sec">Methods</xref> for complete details) [<xref ref-type="bibr" rid="CR15">15</xref>]. In order to compare with published analyses using the SPARK approach, we focused on the same slice of the mouse hypothalamus (Bregma + 0.11 mm from animal 18) [<xref ref-type="bibr" rid="CR5">5</xref>]. The expression patterns of a set of 155 genes expected to be spatially variable were measured with MERFISH for this slice, along with 5 blank control genes. We first initialized a ConvNet and forwarded the MERFISH spatial gene expression matrices through it to obtain gene feature vectors. Then we clustered the 155 spatially variable genes with the 5 blank genes and with 9 cell type-specific expression patterns defined by the original publication through a combination of MERFISH and scRNA-seq data. We clustered these genes, controls, and cell type patterns into 10 groups and visualized them by UMAP. Without training, SE genes, control genes, and cell types are spread across the 2-dimensional UMAP space and boundaries between groups are not distinctively defined (Fig. <xref rid="Fig2" ref-type="fig">2</xref>a). Next, we trained the CoSTA model to obtain refined feature vectors. After training, SE genes, control genes and cell types formed distinct groups that have clearer boundaries in the 2D visualization (Fig. <xref rid="Fig2" ref-type="fig">2</xref>b) and refined cluster memberships that reproducibly and quantitatively form tighter clusters according to a linear intrinsic dimensionality (LID) estimator (Fig. <xref rid="Fig2" ref-type="fig">2</xref>c) [<xref ref-type="bibr" rid="CR16">16</xref>].<fig id="Fig2"><label>Fig. 2</label><caption><p>Analyzing MERFISH data with the CoSTA approach. <bold>A</bold> and <bold>B</bold> Visualization of the spatial feature vectors obtained for each gene, blank controls, and reference cell type patterns from MERFISH data in a 2D UMAP layout. Filled circles represent true genes, filled triangles represent cell-types, and filled squares are blank controls. <bold>A</bold> features extracted from a randomly initialized ConvNet with no training. Each dot is a gene, blank control, or cell type pattern. Colors indicate cluster labels obtained from clustering on the full CoSTA-derived feature vectors; <bold>B</bold> features extracted by trained ConvNet. Each dot is colored with the original clustering labels from <italic>a</italic> to show how some cluster memberships rearrange. <bold>C</bold> Local intrinsic dimensionalities of spatial representations by CoSTA without and after training (10 independent runs of CoSTA). <bold>D</bold> CoSTA-detected spatial correlations of genes identified as SE uniquely by SPARK. Top row displays known cell type specific expression patterns for 3 cell types. Lower rows display expression patterns of particular genes. Dotted lines indicate the CoSTA-identified similarity between a pair of genes or a gene with a cell type pattern. Raw count values for each image are scaled from 0 to 1 to normalize the visual comparison. <bold>E</bold> Euclidean distances between each gene shown in D and Ependymal or Mature OD patterns. Euclidean distances are measured using the CoSTA spatial representation</p></caption><graphic xlink:href="12859_2021_4314_Fig2_HTML" id="MO2"/></fig></p>
      <p id="Par17">From this MERFISH data, SPARK identified 145 SE genes including one blank control, and SpatialDE found 139 SE genes with one blank control [<xref ref-type="bibr" rid="CR5">5</xref>]. CoSTA is designed primarily to detect similarities between spatial gene expression patterns, rather than to estimate spatial relevance (identify SE genes). So, to define which genes are called SE by CoSTA, we examined which genes CoSTA identified as highly correlated to one of the 9 pre-defined cell type specific expression patterns. We found a correlation threshold at which CoSTA identified 133 SE genes associated with one of the different cell type patterns, while none of the blank controls were called associated with a pattern (Additional file <xref rid="MOESM14" ref-type="media">14</xref>: Table S2). Thus, CoSTA’s sensitivity is slightly lower than SPARK and SpatialDE, but with higher specificity (no blank controls detected). However, CoSTA’s result is both more sensitive and more specific than the Trensceek approach, which only identified 108 SE genes and one blank control [<xref ref-type="bibr" rid="CR17">17</xref>].</p>
      <p id="Par18">Three genes in this MERFISH dataset, <italic>Avpr1a</italic>, <italic>Chat</italic>, and <italic>Nup62cl</italic>, were highlighted by Sun et al., because they were only identified as SE by SPARK [<xref ref-type="bibr" rid="CR5">5</xref>]. CoSTA is able to identify the spatial expression patterns of these genes, but also reveals by quantitative similarity that these genes are more distantly related to cell type expression patterns than other genes. We examined both the significantly similar groups determined by CoSTA and used the spatial representation learned by CoSTA to measure Euclidean distances of these genes to each other and to cell type expression patterns (Fig. <xref rid="Fig2" ref-type="fig">2</xref>D, E and Additional file <xref rid="MOESM14" ref-type="media">14</xref>: Table S2). For example, CoSTA identifies genes such as <italic>Nnat</italic> and <italic>Cd24a</italic> as significantly similar to the Ependymal cell type pattern (Dotted lines, Fig. <xref rid="Fig2" ref-type="fig">2</xref>D). <italic>Avpr1a</italic> is quantified as more distant from this Ependymal pattern (Fig. <xref rid="Fig2" ref-type="fig">2</xref>E), though it does show some similarity to <italic>Nnat</italic> and <italic>Cd24a</italic> (Fig. <xref rid="Fig2" ref-type="fig">2</xref>D). Similarly, <italic>Mbp</italic> and <italic>Opalin</italic> are significantly correlated to the Mature OD cell type pattern (Fig. <xref rid="Fig2" ref-type="fig">2</xref>D, E and Additional file <xref rid="MOESM14" ref-type="media">14</xref>: Table S2). <italic>Nup62cl</italic> is more distant from the Mature OD than <italic>Opalin</italic> and <italic>Mbp</italic>, but is related to the expression patterns of <italic>Mbp</italic> and <italic>Opalin</italic>. Visual inspection of <italic>Avpr1a</italic> and <italic>Nup62cl</italic> confirms that these patterns are quite noisy and less similar to the key cell type pattern (Fig. <xref rid="Fig2" ref-type="fig">2</xref>d). Thus, by quantifying relationships between patterns rather than reporting uniform sets of SE genes, CoSTA clarifies that these genes are likely identified by SPARK and no other method because they are in fact less spatially similar to key cell type patterns. CoSTA’s ability to quantify relationships between genes, rather than only categorizing genes, is important in biological situations, where there is often going to be a range of relative similarity that would be oversimplified by strict categorization.</p>
    </sec>
    <sec id="Sec7">
      <title>CoSTA learns spatial pattern-dependent representations of Slide-seq data</title>
      <p id="Par19">We next expand our application of CoSTA to Slide-seq data. Slide-seq takes advantage of high-throughput single cell RNA sequencing and barcoding. Therefore, it enables spatial gene expression measurement for all genes in the genome [<xref ref-type="bibr" rid="CR3">3</xref>]. As a first demonstration that CoSTA can be applied to this type of high-throughput spatial transcriptomics data, we performed an experiment-mixing test to evaluate whether CoSTA can separate different spatial patterns. Due to the unavailability of a “gold standard” for positive and negative spatial similarity of gene expression, we mixed gene matrices from four different spatial transcriptomics experiments by Slide-seq and tested the ability of CoSTA to deconvolve them [<xref ref-type="bibr" rid="CR3">3</xref>]. Each overall experiment is performed on an independent brain slice of a different mouse, so the shapes and spatial features of each experimental sample overall constitute a large difference between experiments. Each gene within each experiment will have a somewhat different pattern (and it will be our next goal to distinguish those differences and similarities), but we first tested whether genes within the same experiment could be classified together based on their overall spatial features. We implemented training as above and then clustered the mixed experiment gene matrices into 4 clusters. The confusion matrix shows clustering labels are largely consistent with true experimental labels (Additional file <xref rid="MOESM15" ref-type="media">15</xref>: Table S3).</p>
      <p id="Par20">We next performed a shuffling test on gene matrices from one Slide-seq experiment, to break correlated patterns of neighboring regions in the way described for the shuffling of synthetic data above (see <xref rid="Sec13" ref-type="sec">Methods</xref> for shuffling details). We trained a new model and examined model-reported similarity among expression patterns of ten random genes. If CoSTA successfully learned spatial features that distinguish the expression of these genes, the distances between two genes should change when spatial patterns and relationships between neighboring pixels are disrupted. We randomly selected <italic>Prdx5</italic> as the reference gene and calculated Euclidean distances of 9 other genes with it. We order these ten genes based on their distances to <italic>Prdx5</italic>. Then, we shuffled gene matrices 100 times, passed the shuffled matrices through the trained ConvNet, and recalculate paired distances with <italic>Prdx5</italic> (Fig. <xref rid="Fig3" ref-type="fig">3</xref>a). We find that in 5 of 9 comparisons, distances decreased upon shuffling, as the distinctive patterns captured by CoSTA were removed by shuffling, converting the matrices into generic, more similar patterns. In 4 of 9 comparisons, distances increased with shuffling, likely indicating that key similarities between the spatial patterns became disrupted during shuffling (Fig. <xref rid="Fig3" ref-type="fig">3</xref>b). In contrast, the similarity measured by overlap analysis would not change after shuffling since individual pixels were shuffled identically. This result again suggests, this time using real biological data, that the learned features by CoSTA are strongly tied to the spatial expression pattern.<fig id="Fig3"><label>Fig. 3</label><caption><p>CoSTA Analysis of Slide-seq data. <bold>A</bold> Shuffling test to disrupt spatial patterns. Left panel: The first row shows the three original spatial expression patterns of three example genes. Images in the second row are spatial patterns after shuffling (all images shuffled in the same way so that pixel-level overlap is preserved while spatial neighbor relationships are broken- see <xref rid="Sec13" ref-type="sec">Methods</xref> and Additional file <xref rid="MOESM12" ref-type="media">12</xref>: Fig. S12 for shuffling approach details). Right panel: CoSTA-derived distances between 9 randomly selected genes and <italic>Prdx5</italic>. Genes are ordered based on how close they are to <italic>Prdx5</italic> using spatial features extracted by CoSTA from true gene matrices (left to right: closest to farthest). Shuffled gene matrices are forwarded through CoSTA, and distances between gene pairs are subtracted from the unshuffled distances. Each point represents distance change for one shuffling (100 shufflings total). Red line at 0 indicates no change in distance would be observed using overlap calculations. <bold>B</bold> The number of overlapped gene neighbors of <italic>Vim</italic>, <italic>Ctsd</italic>, and <italic>Gfap</italic> before and after each weight updating across all training epochs (30 nearest neighbors considered, see Additional file <xref rid="MOESM5" ref-type="media">5</xref>: Fig. S5 for different size neighbor sets). Results shown for two experiments: 3 days (blue) or 2 weeks (red) after brain injury. <bold>C</bold> Overlap of CoSTA, Spatial DE and SPARK genes called SE and correlated with <italic>Vim</italic>, <italic>Ctsd</italic>, and <italic>Gfap</italic> in the 2 weeks after injury dataset<italic>.</italic> Yellow = SPARK correlated genes also SE by CoSTA. Blue = SPARK correlated genes not SE by CoSTA. Red cross-hatching = Proportion of each category also identified by SpatialDE. Below, Gene Ontology enrichment (Panther) of genes that overlap between SPARK, SpatialDE AND CoSTA (left) and those that overlap between SPARK and Spatial DE but NOT CoSTA (Right). <bold>D</bold> GO term enrichment in the 2 weeks after injury <italic>Vim</italic>, <italic>Ctsd</italic>, and <italic>Gfap</italic> correlated gene sets from different approaches for biologically relevant functions identified by the original Slide-seq analysis. Quantified along the axis is the fraction of genes in each method’s correlated gene list that are annotated with the given GO term</p></caption><graphic xlink:href="12859_2021_4314_Fig3_HTML" id="MO3"/></fig></p>
    </sec>
    <sec id="Sec8">
      <title>Ensemble learning identifies stable relationships between spatial gene expression patterns</title>
      <p id="Par21">We next applied CoSTA to reanalyze two spatial transcriptomics datasets measured by Slide-seq [<xref ref-type="bibr" rid="CR3">3</xref>]. These datasets are derived from two biological conditions: 3 days after brain injury (“3 days”) and 2 weeks after brain injury (“2 weeks”). In the first investigation of these two datasets in Slide-seq, Rodriques et al. primarily focused on genes that were spatially correlated with <italic>Vim</italic>, <italic>Ctsd</italic> and <italic>Gfap</italic> at both 3 days and 2 weeks after brain injury [<xref ref-type="bibr" rid="CR3">3</xref>]. For comparison, we also examined genes correlated with <italic>Vim</italic>, <italic>Ctsd</italic> and <italic>Gfap</italic> from our CoSTA results. One property of our approach is that features of each gene change every epoch when weights are updated. This may result in changes to the nearest neighbors of a gene during model training and can be used to infer how strong and stable the inferred spatial relationships are in a given condition. We measured the overlap between detected <italic>Vim, Ctsd, and Gfap</italic> neighbor genes before and after weight updating across training epochs, and we found neighbors tend to be more stable for the 2 weeks dataset than for the 3 days dataset (Fig. <xref rid="Fig3" ref-type="fig">3</xref>b and Additional file <xref rid="MOESM5" ref-type="media">5</xref>: Fig. S5). This may indicate that in the acute phase after injury, genes related to <italic>Vim</italic>, <italic>Ctsd</italic> and <italic>Gfap</italic> are more variable and less spatially patterned, but these patterns become stronger at 2-week time point after injury.</p>
      <p id="Par22">To screen significantly spatially patterned genes out from noise, we use ensemble learning. Briefly, we initialized 5 ConvNets and trained them separately. We then calculated the nearest neighbors for every gene in the same dataset, at neighbor set sizes of 5, 10, 15, 20, 25, 30, 40, 50, and 100. We use a broad range of neighboring levels because different genes may form different sizes of communities. Next, we calculated Jaccard similarities across the 5 CoSTA models and keep genes that have an averaged Jaccard similarity larger than 0.2 at least in one level. We call genes that pass the threshold “stable”, and genes that are filtered out as “unstable”. We propose that the percentage of stable vs. unstable genes represents the degree of spatial patterning in the experiment set. Overall, a smaller proportion of genes were considered stable at 3 days, consistent with the more variable gene neighbors observed for the 3-day condition above. These ‘stable’ genes can also be considered a CoSTA-derived set of ‘spatially expressed’ (SE) genes for comparison to SE genes identified by SPARK. The majority of CoSTA-SE genes are also called SE by SPARK (86% at 3 days and 78% at 2 weeks, Additional file <xref rid="MOESM6" ref-type="media">6</xref>: Fig. S6a). <italic>Vim</italic>, <italic>Ctsd</italic>, and <italic>Gfap</italic> are considered SE by CoSTA in the 2-week data but not in the 3-day dataset. Notably, <italic>Vim</italic>, <italic>Ctsd</italic>, and <italic>Gfap</italic> are also not present in the 3 days SE gene list identified by SPARK, and only <italic>Ctsd</italic> and <italic>Gfap</italic> were identified as SE genes by SPARK in the 2 weeks data. We note that less strongly patterned genes could reflect actively variable biological regulation (such as might happen during acute response to injury), not only technique noise. We are unable to definitively distinguish a weak spatial pattern from inherent noise, because of lack of “ground truth” for pattern matching. However, we can, as above, disrupt spatial patterns by shuffling the true datasets, maintaining pixelwise correlations between genes but removing spatial information (see <xref rid="Sec13" ref-type="sec">Methods</xref> for shuffling approach details). We shuffled a whole set of gene matrices from 3 days and 2 weeks and applied CoSTA to these datasets. As when we shuffled simulated data in Additional file <xref rid="MOESM2" ref-type="media">2</xref>: Figure S2, we find that this shuffled dataset has overall lower NMI than its original dataset during training (Additional file <xref rid="MOESM6" ref-type="media">6</xref>: Fig. S6b; see <xref rid="Sec13" ref-type="sec">Methods</xref> for details of NMI use). Further, substantially fewer SE genes are identified in the 2 week randomized data as compared to the real data (Additional file <xref rid="MOESM6" ref-type="media">6</xref>: Fig. S6c). This again demonstrates that CoSTA captures spatial features that are distinct from individual pixel information. For true 3-day and shuffled 3-day data, there is not a clear difference in the number of identified SE genes (Additional file <xref rid="MOESM6" ref-type="media">6</xref>: Fig. S6c). This again suggests that the spatial patterns are much less strong within the 3-day dataset. Indeed, few patterns are visually obvious for example gene matrices from 3 days (Additional file <xref rid="MOESM7" ref-type="media">7</xref>: Fig. S7a).</p>
    </sec>
    <sec id="Sec9">
      <title>CoSTA identifies smaller, but specific and biologically relevant, sets of spatially correlated genes compared to SPARK and SpatialDE</title>
      <p id="Par23">We focused our further analysis on the 2-week data. We applied SpatialDE and SPARK to this dataset for comparison to CoSTA. The original Slide-seq publication previously identified 843 genes that are correlated with <italic>Vim</italic>, <italic>Ctsd</italic>, and <italic>Gfap</italic> via overlap analysis [<xref ref-type="bibr" rid="CR3">3</xref>]. However, CoSTA, with a rigid neighbor similarity stability threshold, identified many fewer correlated genes (63 with z-scores &lt;  − 2.325), and only 19 genes matched the original Slide-seq set (Additional file <xref rid="MOESM8" ref-type="media">8</xref>: Fig. S8a). SPARK first identified 1294 significantly SE genes and then clustered them into 10 groups by hierarchical clustering with individual pixels as features. Our CoSTA correlated gene list only has 5 gene overlaps with genes that are grouped with <italic>Vim</italic>, <italic>Ctsd</italic>, and <italic>Gfap</italic> by SPARK. We also used SpatialDE to find significant SE genes. Surprisingly, the whole dataset passed the SpatialDE test for significant spatial expression. Then, we applied the unsupervised pattern detection algorithm built in SpatialDE to cluster genes into 10 groups. This resulted in a large number of genes grouped with <italic>Vim</italic>, <italic>Ctsd</italic>, and <italic>Gfap</italic>. A majority of our CoSTA set (41 genes) overlaps with genes identified by SpatialDE (Additional file <xref rid="MOESM8" ref-type="media">8</xref>: Fig. S8a). The set of correlated genes identified by CoSTA is much smaller than sets identified by the other 3 methods. This is in part because CoSTA requires stable relationships between neighboring genes to be classified as an SE gene at all, and only SE genes can then be identified as highly similar to the genes of interest. Indeed, out of 350 genes identified by SPARK as correlated with <italic>Vim, Ctsd, and Gfap</italic>, only 28 are even classified as SE genes by CoSTA. However, we observe evidence that this CoSTA-identified SE subset is reliable and meaningful. First, 75% of these CoSTA-SE genes identified by SPARK are also identified as correlated by SpatialDE, while in the remaining non CoSTA-SE set, there is only a 15% overlap between SPARK and SpatialDE (Fig. <xref rid="Fig3" ref-type="fig">3</xref>c). Further, the genes overlapping between SPARK, SpatialDE, and CoSTA have biologically relevant function enrichment (such as ion transport and exocytosis) while the genes overlapping between SPARK and SpatialDE but not identified as SE by CoSTA show no function enrichment at all (Fig. <xref rid="Fig3" ref-type="fig">3</xref>c). We also observe visible evidence of spatial pattern similarity to the 3 genes of interest among genes considered SE and highly correlated by CoSTA and less evidence of similarity for genes identified only by SPARK (Additional file <xref rid="MOESM8" ref-type="media">8</xref>: Fig. S8b).</p>
      <p id="Par24">Further, we find that the 63 genes identified by CoSTA as significantly correlated to <italic>Vim, Gfap,</italic> and <italic>Ctsd</italic> are highly enriched for meaningful biological function. In the original study, Rodriques et al. highlighted that genes correlated with <italic>Vim</italic>, <italic>Ctsd</italic>, and <italic>Gfap</italic> are enriched for functions in immune response, gliogenesis and oligodendrocyte development—all functions that are biologically expected in response to injury [<xref ref-type="bibr" rid="CR3">3</xref>]. We found that the correlated genes identified by CoSTA have higher enrichment in immune response and gliogenesis than the genes identified by SpatialDE, SPARK and this original Slide-seq report (Fig. <xref rid="Fig3" ref-type="fig">3</xref>d). However, none of genes fall into category of oligodendrocyte development. When we visually inspected expression patterns of genes in the category of oligodendrocyte development, their individual and collective patterns do not have similarities to expression patterns of <italic>Vim, Ctsd, and Gfap</italic>. They are either noisy or expressed globally (Additional file <xref rid="MOESM7" ref-type="media">7</xref>: Fig. S7b). From results above, we conclude that CoSTA returns a reduced, stringent set of correlated genes that are more enriched for biological significance than the larger sets returned by other methods.</p>
      <p id="Par25">As noted earlier, one key difference between CoSTA and these other methods is that CoSTA provides not only sets of similar genes, but also quantitative pairwise comparisons between all genes. Thus, we can extract from CoSTA a ranked list of how similar each CoSTA-SE gene is to <italic>Vim, Ctsd,</italic> and <italic>Gfap</italic> (Additional file <xref rid="MOESM16" ref-type="media">16</xref>: Table S4). This enables us to search for enriched biological functions using similarity rankings rather than an arbitrary cutoff using the GOrilla enrichment tool [<xref ref-type="bibr" rid="CR18">18</xref>]. Using the whole ranked list, we find novel enriched functions such as collagen metabolism, astrocyte differentiation, and vascular endothelial growth factor signaling that may be relevant to damage repair (Additional file <xref rid="MOESM8" ref-type="media">8</xref>: Fig. S8c). Pixelwise correlation can also be used to create a ranked similarity list. When these two approaches are compared, we observe some highly ranked genes shared by both approaches with clear pattern overlap to the query genes. Where the two approaches differ widely in gene ranking, CoSTA-specific genes tend to have the key patterns of expression as contiguous patterns superimposed on a generic weak background while pixel-specific genes tend to have isolated pixels overlapping the key areas (Additional file <xref rid="MOESM8" ref-type="media">8</xref>: Fig. S8d).</p>
      <p id="Par26">To avoid observation bias by only looking at a few example genes that are classified differently by different approaches, we next globally compared the types of spatial patterns detected uniquely by CoSTA and other previous methods. For each method (CoSTA, SpatialDE, SPARK, and the original Slide-seq overlap approach), we consider the list of genes classified as spatially correlated with <italic>Vim, Ctsd, and Gfap</italic> as described above<italic>.</italic> The average expression pattern of genes detected as correlated to these query genes varies somewhat according to approach. Notably, the average CoSTA pattern is more localized to the upper right region, where the damage was induced (Fig. <xref rid="Fig4" ref-type="fig">4</xref>a). In contrast, SPARK, SpatialDE, and Slide-seq each identify so many correlated genes that their average pattern looks very much like the average pattern of all genes in the dataset (compare Fig. <xref rid="Fig4" ref-type="fig">4</xref>a with Additional file <xref rid="MOESM9" ref-type="media">9</xref>: Fig. S9) rather than distinctive. This again emphasizes the smaller, but perhaps more specific, set of genes identified as correlated by CoSTA. When we compare genes identified as correlated by CoSTA and not certain other techniques, we can see that CoSTA-unique genes have certain local patterns that were not captured as much by other methods (Fig. <xref rid="Fig4" ref-type="fig">4</xref>b). In contrast, again, genes detected by other methods and not CoSTA look more similar on average to the average gene expression of the entire gene set (Fig. <xref rid="Fig4" ref-type="fig">4</xref>c).<fig id="Fig4"><label>Fig. 4</label><caption><p>Collective expression patterns detected by different methods in Slide-seq data. <bold>A</bold> Average expression patterns of <italic>Vim</italic>, <italic>Gfap</italic>, <italic>Ctsd</italic> and their correlated genes after 2 weeks brain injury defined by different methods. <bold>B</bold> Average expression patterns of <italic>Vim, Gfap, Ctsd</italic> correlated genes detected by CoSTA and not by the indicated methods. <bold>C</bold> Average expression patterns of <italic>Vim, Gfap, Ctsd</italic> correlated genes detected by other methods and not CoSTA. <bold>D</bold> Gene clusters of CoSTA SE genes at 2-week time point on 2 UMAP dimensions. Mean expression patterns are presented for selected clusters. Visualization with raw count values that are scaled from 0 to 1</p></caption><graphic xlink:href="12859_2021_4314_Fig4_HTML" id="MO4"/></fig></p>
      <p id="Par27">Finally, rather than using a significant correlation threshold, we clustered all CoSTA-determined SE genes at the 2-week time point into 6 groups using the learned spatial representation. The cluster that contains <italic>Vim</italic>, <italic>Ctsd</italic>, and <italic>Gfap</italic> (cluster 3) is composed of 89 genes expressed in a distinct pattern (Fig. <xref rid="Fig4" ref-type="fig">4</xref>d and Additional file <xref rid="MOESM17" ref-type="media">17</xref>: Table S5). Other clusters also successfully identify distinctive spatial patterns of expression (Fig. <xref rid="Fig4" ref-type="fig">4</xref>d and Additional file <xref rid="MOESM9" ref-type="media">9</xref>: Fig. S9). We also used SpatialDE to cluster SE genes identified by CoSTA into 6 clusters. We found that the two methods share many commonalities in detecting patterns, with some disagreements (Additional file <xref rid="MOESM9" ref-type="media">9</xref>: Fig. S9). Notably, when only the narrower set of SE genes identified by CoSTA is used, the cluster of genes identified by SpatialDE containing <italic>Vim, Gfap,</italic> and <italic>Ctsd</italic> (cluster 2, Additional file <xref rid="MOESM9" ref-type="media">9</xref>: Fig. S9) has a much more specific, localized pattern than when SpatialDE default settings are used to classify all genes. This again suggests that CoSTA provides a meaningful increase in specificity by identifying genes with stable spatial relationships.</p>
    </sec>
  </sec>
  <sec id="Sec10">
    <title>Discussion</title>
    <p id="Par28">We have shown that our CoSTA approach can successfully implement deep learning ideas from computer vision to infer spatial gene expression relationships. This approach can be applied to any technology that outputs an image-type matrix of gene expression information for each gene, including not only Slide-seq [<xref ref-type="bibr" rid="CR3">3</xref>, <xref ref-type="bibr" rid="CR19">19</xref>] and MERFISH [<xref ref-type="bibr" rid="CR20">20</xref>] explored here, but also STARmap [<xref ref-type="bibr" rid="CR21">21</xref>], 10 × Visium (10 × Genomics), and HDST [<xref ref-type="bibr" rid="CR22">22</xref>] approaches. Identifying spatial patterns from high-throughput spatial transcriptomics data is still challenging, however. We often do not have a clear ground truth answer for what should be detected as a pattern vs. noise and what similarities in patterns are most biologically relevant. Different approaches will have different strengths and weaknesses depending on the types of patterns and relationships to be detected. The very first step in any approach to analyzing spatial transcriptomics data is estimating significant SE genes. To identify SE genes, SpatialDE relies on the assumption that spatial expression of a given gene follows a multivariate normal distribution across spatial coordinates [<xref ref-type="bibr" rid="CR4">4</xref>]. However, this assumption leads all genes in a Slide-seq dataset to be identified as SE genes by SpatialDE. This may occur because noisy signals generated by the Slide-seq experiment may also follow or are confounded within the multivariate normal distribution. Therefore, a multivariate normal model will not be able to distinguish spatial patterns from noise in certain types of experimental data. Different from SpatialDE, both SPARK and CoSTA make use of kernels to identify SE genes. SPARK defined 5 periodic and 5 gaussian kernels to cover a range of possible spatial patterns that the authors believe are observed in common biological datasets [<xref ref-type="bibr" rid="CR5">5</xref>]. Therefore, identifying SE genes involves a statistical evaluation of how well kernels match spatial patterns of interest. This SPARK approach is very valuable if an experimental dataset is accompanied by prior knowledge about relevant spatial patterns. Kernels in CoSTA also serve a similar purpose but are not predefined. Instead, kernels in CoSTA are learned through training a neural network. To identify SE genes, we rely on the idea that a true spatial pattern should be collective, which means a group of genes should share a spatial pattern. Therefore, when we apply kernels learned independently from 5 ConvNets, genes in the same group should have similar responses to these kernels. Conversely, a noisy gene expression pattern would respond to the 5 sets of ConvNet kernels differently, clustered with different groups of genes each time. Indeed, we showed that this kernel approach helps identify a more focused set SE genes in Slide-seq data without requiring an a priori definition of relevant patterns that SPARK requires. We have shown by various measures that the SE genes identified by CoSTA are a much smaller set, but with high enrichment for meaningful biological function, and more likely to be also detected by multiple other methods, increasing confidence in this set.</p>
    <p id="Par29">Identification of SE genes is just the beginning of extracting biological meaning from spatial gene expression. Careful analysis of the spatial relationships between genes is also necessary. Often, as in overlap analysis, studying gene relationships is based on vectorizing gene expression patterns and measuring their similarities in a latent space without considering spatial information such as the position of neighboring datapoints. One key motivation for CoSTA, therefore, is to preserve a spatial and shape representation of gene expression patterns. In comparison, SPARK does not have a pattern detection function, but can be combined with hierarchical clustering with pixels as features to assign each gene a pattern label. SpatialDE implements a clustering model based on a spatial Gaussian-process-based (GP) prior [<xref ref-type="bibr" rid="CR4">4</xref>]. This clustering model is an extension of GMM with the addition of a spatial prior on cluster centroids. Therefore, pattern detection by SpatialDE goes beyond the pixel level. In our method, we define the key goal as learning a spatial representation for each gene. We have demonstrated that features learned by CoSTA are not isolated to individual pixels, while SpatialDE responds more to individual pixel information in our simulations. Because of use of convolutional layers, spatial features learned by our method represent local patterns and multiple local patterns together form the global pattern for the gene matrix. Finally, vectorizing gene matrices allows us not only to find different spatial patterns within a dataset by clustering but also to study spatial relationships of pairs of genes. Such a pairwise examination, in contrast, is not implemented in SpatialDE.</p>
    <p id="Par30">Not only in detection of a narrower set of SE genes, but also in identifying relationships between genes, our results consistently suggest that CoSTA provides more specific though less sensitive results than other methods. Throughout our analyses, we find that overlap approaches, as well as SPARK and SpatialDE tend to group together larger sets of genes that are more distant in their spatial pattern relationships, while CoSTA captures a narrower and more specific set of genes. This was observed in our analysis of digit image data as well as in applications to Slide-Seq and, to a lesser extent, MERFISH. This difference in outcomes again demonstrates the different advantages and disadvantages of different approaches. CoSTA would likely be more useful in a case where users want to narrow their set of candidate related genes for future experiments. We also note throughout the Methods section alterations to parameters of CoSTA that could allow for detection of more general patterns.</p>
    <p id="Par31">Again, depending on the biological reality underlying the data, different approaches will have different advantages. The CoSTA approach will have advantages in cases where overall pattern shape is important, while direct overlap calculations may perform better when exact cell to cell correlation is more biologically relevant. The CoSTA approach may also have future applications to datasets in which images of different genes are not from the identical biological section, but instead from neighboring tissue slices, as is common in traditional histology. If a pattern or shape of expression is maintained while exact overlap is lost, as we demonstrated with our simulated masking approach, CoSTA could still detect such a pattern similarity where an overlap approach would not.</p>
  </sec>
  <sec id="Sec11">
    <title>Conclusions</title>
    <p id="Par32">In this study, we demonstrated that our deep learning CoSTA approach provides a different angle to spatial transcriptomics analysis by focusing on the shape of expression patterns. CoSTA includes more information about the positions of neighboring pixels than does an overlap or individual pixel correlation approach. CoSTA can be applied to any form of spatial transcriptomics data that are represented in matrix form to find genes expressed in similar patterns as well as to evaluate the strength of the spatial patterning of each gene. We find that CoSTA captures more focused groups of spatially related genes while still detecting the biological function information found by other approaches that report larger sets of related genes.</p>
  </sec>
  <sec id="Sec12">
    <title>Methods</title>
    <sec id="Sec13">
      <title>Resizing gene images and normalization</title>
      <p id="Par33">The Slide-seq data was obtained from: <ext-link ext-link-type="uri" xlink:href="https://portals.broadinstitute.org/single_cell/study/slide-seq-study">https://portals.broadinstitute.org/single_cell/study/slide-seq-study</ext-link>. The raw images of Slide-seq consist of over 1,000,000 pixels, which makes computation difficult. Therefore, we first binned 100 pixels into one pixel and resized matrices from different experiments into the same 48X48 image size. This results in a lower resolution, which may obscure small-scale fine details, but large scale global features of expression patterns of genes are preserved. CoSTA can be applied to any spatial transcriptomics dataset at any resolution, as long as the user has sufficient computational resources available. To avoid extreme computational burden, we recommend that users interested in high resolution features zoom into regions of interest and crop images in that region to efficiently apply CoSTA to their data. After binning, we normalized gene matrices as described in Svensson et al. [<xref ref-type="bibr" rid="CR4">4</xref>]. This normalization involves finding the total gene expression counts for each pixel across all gene matrices and then normalizing each pixel of each matrix by the log total counts across all matrices for this pixel. If this normalization is not performed, the expression of a gene could be over or undercounted at certain spatial locations where expression levels were systematically high or low for all genes. Normalization by total counts at each pixel ensures that our approach captures the spatial covariance for each gene beyond this potential artifactual effect. For visualization of expression patterns, we instead use averaged raw count values, and scale values from 0 to 1 divided by the maximum value. Thus, expression images in all figures are in 0 to 1 scale. This allows a more direct visual inspection of the raw data.</p>
    </sec>
    <sec id="Sec14">
      <title>CoSTA architecture</title>
      <p id="Par34">
        <list list-type="order">
          <list-item>
            <p id="Par35">
              <bold>ConvNet</bold>
            </p>
          </list-item>
        </list>
      </p>
      <p id="Par36">The ConvNet stage of CoSTA consists of 3 convolutional layers for Slide-seq and MERFISH analysis. Inputs are sets of spatial gene expression images (matrices) as described above. We first initialize a ConvNet randomly and then forward these gene expression matrices through the ConvNet. All weights in convolutional layers are initialized on a Xavier uniform distribution. Each convolutional layer is activated by a rectified linear unit function and is followed by a batch normalization layer and a max pooling layer to reduce the size of the output. To produce a feature vector for each gene, we flatten the matrix output from the last max pooling layer by concatenating all matrix columns into a single column. One fully connected layer is added to the model after the last max pooling layer with a customized softmax activation to produce outputs as probabilities (See <bold>4. Loss Function</bold>). The fully connected layer is only used during training, when we need gradients to pass backwards through the model. Once trained, this fully connected layer will be discarded, and we use L2-normalized outputs as the spatial representations. Specific parameters used in ConvNet, such as the number and size of filters in each convolutional layer, can be found in python code. We note that different numbers of convolutional layers have been used for different image classification tasks. We recommend that users start with a 3-convolutional-layer network for initial data exploration. However, if a dataset has a larger size of gene matrices, outputs from the 3-convolutional-layer network will be very long vectors. Therefore, users can increase the number of convolutional layers to decrease the dimensions of outputs if needed.</p>
      <p id="Par37">
        <list list-type="simple">
          <list-item>
            <label>2.</label>
            <p id="Par38">
              <bold>UMAP and clustering</bold>
            </p>
          </list-item>
        </list>
      </p>
      <p id="Par39">The flattened spatial representation vector output from the three convolutional layers is reduced by UMAP before GMM clustering. We implemented UMAP using the original python source code [<xref ref-type="bibr" rid="CR9">9</xref>]. We set up “n_neighbors = 20” and “min_dist = 0”, while using UMAP for dimension reduction. To cluster samples into N clusters, a user can reduce dimensions to N UMAP-dimensions. In this study, we reduce all samples to 30 UMAP-dimensions and cluster all samples into 30 clusters by GMM. While 30 clusters are used here for the model training purpose, once the model is trained, the user can use the final output vector of spatial features to cluster genes into any number of groups desired. To test the influence of the initial choice of number of clusters, we tested 10, 20, and 30, 50, 75, and 100 clusters in 2-week Slide-seq data. Using larger numbers of clusters leads to the identification of fewer SE genes (Additional file <xref rid="MOESM10" ref-type="media">10</xref>: Fig. S10a). Our model can converge no matter how many clusters are used for training (Additional file <xref rid="MOESM10" ref-type="media">10</xref>: Fig. S10b). For a purpose of comparison, we called the 15 nearest genes of <italic>Vim</italic>, <italic>Ctsd</italic>, and <italic>Gfap</italic> individually, and total 45 genes in one test as correlated genes were used for comparing effects of the number of clusters. The choice of the number of clusters will influence the scale of correlated expression pattern detected (Additional file <xref rid="MOESM10" ref-type="media">10</xref>: Fig. S10c). More global pattern differences will be detected using smaller numbers of clusters while finer scale pattern distinctions are detected with larger numbers of clusters (Additional file <xref rid="MOESM10" ref-type="media">10</xref>: Fig. S10c). Increasing the number of clusters will also bring a disadvantage of larger computational cost and longer training time (Additional file <xref rid="MOESM18" ref-type="media">18</xref>: Table S6). In this case, 30 clusters show good specificity, and the detected spatial pattern is not further refined with increasing cluster numbers (Additional file <xref rid="MOESM10" ref-type="media">10</xref>: Fig. S10c). Without ground truth for a dataset, the number of clusters must be chosen based on the scale of patterns desired to be detected for a particular biological application and the results inspected visually.</p>
      <p id="Par40">
        <list list-type="simple">
          <list-item>
            <label>3.</label>
            <p id="Par41">
              <bold>Auxiliary target distribution as soft assignment</bold>
            </p>
          </list-item>
        </list>
      </p>
      <p id="Par42">After clustering, we calculate centroids by averaging samples in the same cluster (Eq. <xref rid="Equ1" ref-type="">1</xref>).<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$c_{i} = \frac{1}{{M_{i} }}\mathop \sum \limits_{j = 1}^{{M_{i} }} x_{ij}$$\end{document}</tex-math><mml:math id="M2" display="block"><mml:mrow><mml:msub><mml:mi>c</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:msub><mml:mi>M</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mfrac><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>M</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:munderover><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:mi mathvariant="italic">ij</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><graphic xlink:href="12859_2021_4314_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq1"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$c_{i}$$\end{document}</tex-math><mml:math id="M4"><mml:msub><mml:mi>c</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq1.gif"/></alternatives></inline-formula> is the centroid for the <italic>i</italic>th cluster, <inline-formula id="IEq2"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$M_{i}$$\end{document}</tex-math><mml:math id="M6"><mml:msub><mml:mi>M</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq2.gif"/></alternatives></inline-formula> is the total number of samples in this cluster, and <inline-formula id="IEq3"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$x_{i,j}$$\end{document}</tex-math><mml:math id="M8"><mml:msub><mml:mi>x</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq3.gif"/></alternatives></inline-formula> is a reduced UMAP vector for the <italic>j</italic>th sample in the <italic>i</italic>th cluster.</p>
      <p id="Par43">Then, each sample is assigned probabilities based on Euclidean distances to cluster centroids (Eq. <xref rid="Equ2" ref-type="">2</xref>).<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p(y = i| x) = \frac{{{\text{e}}^{{1/{\text{d}}_{i} }} }}{{\mathop \sum \nolimits_{i = 1}^{N} {\text{e}}^{{1/{\text{d}}_{i} }} }}$$\end{document}</tex-math><mml:math id="M10" display="block"><mml:mrow><mml:mi>p</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>y</mml:mi><mml:mo>=</mml:mo><mml:mi>i</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:msup><mml:mrow><mml:mtext>e</mml:mtext></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mtext>d</mml:mtext><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msup><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>N</mml:mi></mml:msubsup><mml:msup><mml:mrow><mml:mtext>e</mml:mtext></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mtext>d</mml:mtext><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:math><graphic xlink:href="12859_2021_4314_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq4"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\text{d}}_{i}$$\end{document}</tex-math><mml:math id="M12"><mml:msub><mml:mtext>d</mml:mtext><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq4.gif"/></alternatives></inline-formula> is the Euclidean distance of sample <inline-formula id="IEq5"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$x$$\end{document}</tex-math><mml:math id="M14"><mml:mi>x</mml:mi></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq5.gif"/></alternatives></inline-formula> to the centroid <inline-formula id="IEq6"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$c_{i}$$\end{document}</tex-math><mml:math id="M16"><mml:msub><mml:mi>c</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq6.gif"/></alternatives></inline-formula>, and <inline-formula id="IEq7"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$N$$\end{document}</tex-math><mml:math id="M18"><mml:mi>N</mml:mi></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq7.gif"/></alternatives></inline-formula> is the total number of clusters.</p>
      <p id="Par44">Next, we transform probabilities of each sample to an auxiliary target distribution using Eq. (<xref rid="Equ3" ref-type="">3</xref>).<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$q_{ij} = \frac{{p_{ij}^{2} /f_{i}}}{{\mathop \sum \nolimits_{i = 1}^{N} (p_{ij}^{2} /f_{i})}}$$\end{document}</tex-math><mml:math id="M20" display="block"><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mrow><mml:mi mathvariant="italic">ij</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msubsup><mml:mi>p</mml:mi><mml:mrow><mml:mi mathvariant="italic">ij</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msubsup><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mi>f</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow><mml:mrow><mml:msubsup><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>N</mml:mi></mml:msubsup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msubsup><mml:mi>p</mml:mi><mml:mrow><mml:mi mathvariant="italic">ij</mml:mi></mml:mrow><mml:mn>2</mml:mn></mml:msubsup><mml:mo stretchy="false">/</mml:mo><mml:msub><mml:mi>f</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:math><graphic xlink:href="12859_2021_4314_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq8"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f_i = \mathop \sum \limits_{j = 1}^{M} p_{ij}$$\end{document}</tex-math><mml:math id="M22"><mml:mrow><mml:msub><mml:mi>f</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>M</mml:mi></mml:munderover><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi mathvariant="italic">ij</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq8.gif"/></alternatives></inline-formula>. <inline-formula id="IEq9"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$i$$\end{document}</tex-math><mml:math id="M24"><mml:mi>i</mml:mi></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq9.gif"/></alternatives></inline-formula> denotes the <italic>i</italic>th cluster and <inline-formula id="IEq10"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$j$$\end{document}</tex-math><mml:math id="M26"><mml:mi>j</mml:mi></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq10.gif"/></alternatives></inline-formula> denotes the <italic>j</italic>th sample, <inline-formula id="IEq11"><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p_{ij}$$\end{document}</tex-math><mml:math id="M28"><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi mathvariant="italic">ij</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq11.gif"/></alternatives></inline-formula> is probability that the <italic>j</italic>th sample belongs to the <italic>i</italic>th that we get through Eq. (<xref rid="Equ2" ref-type="">2</xref>). <inline-formula id="IEq12"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$q_{ij}$$\end{document}</tex-math><mml:math id="M30"><mml:msub><mml:mi>q</mml:mi><mml:mrow><mml:mi mathvariant="italic">ij</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq12.gif"/></alternatives></inline-formula> is the auxiliary target probability that the <italic>j</italic>th sample belongs to the <italic>i</italic>th cluster. This transformation was proposed by Xie et al., which is raising <inline-formula id="IEq13"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$p_{ij}$$\end{document}</tex-math><mml:math id="M32"><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi mathvariant="italic">ij</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq13.gif"/></alternatives></inline-formula> to the second power and then normalizing by frequency per cluster [<xref ref-type="bibr" rid="CR23">23</xref>]. The use of power 2 is to highlight samples that have high confidence in the clustering task and discount samples for which the model is uncertain about cluster assignment.</p>
      <p id="Par45">
        <list list-type="simple">
          <list-item>
            <label>4.</label>
            <p id="Par46">
              <bold>Loss function</bold>
            </p>
          </list-item>
        </list>
      </p>
      <p id="Par47">To optimize the neural network, we use bi-tempered logistic loss based on Bregman Divergences as the primary loss function. Bi-tempered logistic loss was proposed by Amid et al. and showed advantage of making supervised learning robust to noise [<xref ref-type="bibr" rid="CR10">10</xref>]. To achieve the robustness, they devised tempered softmax function and tempered logistic loss and gave detailed mathematical reasons behind (Eq. <xref rid="Equ4" ref-type="">4</xref>, <xref rid="Equ5" ref-type="">5</xref>). We reason that training CoSTA also faces the problem of unknown noise within the data, because clustering will assign wrong labels to samples. This is even true when clustering is based on the ConvNet that is randomly initialized. Therefore, use of bi-tempered logistic loss is to deal with wrong or uncertain labels generated by clustering. In the equation below, <inline-formula id="IEq14"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$t_{1}$$\end{document}</tex-math><mml:math id="M34"><mml:msub><mml:mi>t</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq14.gif"/></alternatives></inline-formula> and <inline-formula id="IEq15"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$t_{2}$$\end{document}</tex-math><mml:math id="M36"><mml:msub><mml:mi>t</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq15.gif"/></alternatives></inline-formula> are two temperature parameters proposed in the original work. <inline-formula id="IEq16"><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$t_{1}$$\end{document}</tex-math><mml:math id="M38"><mml:msub><mml:mi>t</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq16.gif"/></alternatives></inline-formula> controls the log-transformation of input values, while <inline-formula id="IEq17"><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$t_{2}$$\end{document}</tex-math><mml:math id="M40"><mml:msub><mml:mi>t</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq17.gif"/></alternatives></inline-formula> controls the exponential function of activated input values. When both <inline-formula id="IEq18"><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$t_{1}$$\end{document}</tex-math><mml:math id="M42"><mml:msub><mml:mi>t</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq18.gif"/></alternatives></inline-formula> and <inline-formula id="IEq19"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$t_{2}$$\end{document}</tex-math><mml:math id="M44"><mml:msub><mml:mi>t</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq19.gif"/></alternatives></inline-formula> are equal to 1, bi-tempered logistic loss is the common KL-divergence loss with softmax activation.<disp-formula id="Equ4"><label>4</label><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$L = y_{i} \left( {\log_{{t_{1} }} y_{i} - \log_{{t_{1} }} \hat{y}_{i} } \right) - \frac{1}{{2 - t_{1} }}\left( {y_{i}^{{2 - t_{1} }} - \hat{y}_{i}^{{2 - t_{1} }} } \right)$$\end{document}</tex-math><mml:math id="M46" display="block"><mml:mrow><mml:mi>L</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>y</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mo>log</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:msub><mml:msub><mml:mi>y</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mo>log</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:msub><mml:msub><mml:mover accent="true"><mml:mi>y</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfenced><mml:mo>-</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mn>2</mml:mn><mml:mo>-</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:mfrac><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mi>y</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mo>-</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msubsup><mml:mo>-</mml:mo><mml:msubsup><mml:mover accent="true"><mml:mi>y</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn><mml:mo>-</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:mrow></mml:math><graphic xlink:href="12859_2021_4314_Article_Equ4.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq20"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$log_{{t_{1} }} \left( x \right)$$\end{document}</tex-math><mml:math id="M48"><mml:mrow><mml:mi>l</mml:mi><mml:mi>o</mml:mi><mml:msub><mml:mi>g</mml:mi><mml:msub><mml:mi>t</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:msub><mml:mfenced close=")" open="("><mml:mi>x</mml:mi></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq20.gif"/></alternatives></inline-formula> can approximate to <inline-formula id="IEq21"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\frac{1}{{1 - t_{1} }}\left( {x^{{1 - t_{1} }} - 1} \right)$$\end{document}</tex-math><mml:math id="M50"><mml:mrow><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:mfrac><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mi>x</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>-</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msup><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq21.gif"/></alternatives></inline-formula>. <inline-formula id="IEq22"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$y_{i}$$\end{document}</tex-math><mml:math id="M52"><mml:msub><mml:mi>y</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq22.gif"/></alternatives></inline-formula> is the target value and <inline-formula id="IEq23"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat{y}_{i}$$\end{document}</tex-math><mml:math id="M54"><mml:msub><mml:mover accent="true"><mml:mi>y</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq23.gif"/></alternatives></inline-formula> is the predicted value out of the fully connected layer.<disp-formula id="Equ5"><label>5</label><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat{y}_{i} = exp_{{t_{2} }} \left( {\hat{\alpha }_{i} - \lambda_{{t_{2} }} \left( {\hat{\user2{\alpha }}} \right)} \right)$$\end{document}</tex-math><mml:math id="M56" display="block"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>y</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mi>e</mml:mi><mml:mi>x</mml:mi><mml:msub><mml:mi>p</mml:mi><mml:msub><mml:mi>t</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>α</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:msub><mml:mi>t</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:msub><mml:mfenced close=")" open="("><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">α</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mfenced></mml:mrow></mml:mfenced></mml:mrow></mml:math><graphic xlink:href="12859_2021_4314_Article_Equ5.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq24"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat{\alpha }_{i}$$\end{document}</tex-math><mml:math id="M58"><mml:msub><mml:mover accent="true"><mml:mi>α</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq24.gif"/></alternatives></inline-formula> is linear activation of output of the fully connected layer for the <italic>i</italic>th cluster, and <inline-formula id="IEq25"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\lambda_{{t_{2} }} \left( {\hat{\user2{\alpha }}} \right) \in {\mathbb{R}}$$\end{document}</tex-math><mml:math id="M60"><mml:mrow><mml:msub><mml:mi>λ</mml:mi><mml:msub><mml:mi>t</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:msub><mml:mfenced close=")" open="("><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">α</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq25.gif"/></alternatives></inline-formula> is s.t. <inline-formula id="IEq26"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\mathop \sum \limits_{j = 1}^{k} exp_{{t_{2} }} \left( {\hat{\alpha }_{j} - \lambda_{{t_{2} }} \left( {\hat{\user2{\alpha }}} \right)} \right) = 1$$\end{document}</tex-math><mml:math id="M62"><mml:mrow><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>k</mml:mi></mml:munderover><mml:mi>e</mml:mi><mml:mi>x</mml:mi><mml:msub><mml:mi>p</mml:mi><mml:msub><mml:mi>t</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi>α</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>j</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:msub><mml:mi>t</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:msub><mml:mfenced close=")" open="("><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">α</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq26.gif"/></alternatives></inline-formula>.</p>
      <p id="Par48">Center loss is an optional setting in our model. Center loss was first proposed to assist models to learn discriminative representations in supervised learning [<xref ref-type="bibr" rid="CR24">24</xref>]. Optimizing models with center loss is equal to minimizing intra-class variation defined by Eq. (<xref rid="Equ6" ref-type="">6</xref>).<disp-formula id="Equ6"><label>6</label><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$L_{c} = \frac{1}{2} \mathop \sum \limits_{j = 1}^{{M_{i} }} \| x_{i} - c_{j} \| ^{2}$$\end{document}</tex-math><mml:math id="M64" display="block"><mml:mrow><mml:msub><mml:mi>L</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mn>2</mml:mn></mml:mfrac><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:msub><mml:mi>M</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:munderover><mml:msup><mml:mrow><mml:mo stretchy="false">‖</mml:mo><mml:msub><mml:mi>x</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mi>c</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">‖</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:math><graphic xlink:href="12859_2021_4314_Article_Equ6.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq27"><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$c_{i}$$\end{document}</tex-math><mml:math id="M66"><mml:msub><mml:mi>c</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq27.gif"/></alternatives></inline-formula> is the centroid of <italic>i</italic>th cluster, and <inline-formula id="IEq28"><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$x_{j}$$\end{document}</tex-math><mml:math id="M68"><mml:msub><mml:mi>x</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:math><inline-graphic xlink:href="12859_2021_4314_Article_IEq28.gif"/></alternatives></inline-formula> is the hidden features of <italic>j</italic>th sample in this cluster.</p>
      <p id="Par49">Because lowering center loss will push samples closer to the cluster center, the learned representations will be more discriminative in the hidden space. Though we did not use center loss to train models for Slide-seq data, we found that adding center loss during training can substantially improve accuracy in Fashion image data (Additional file <xref rid="MOESM11" ref-type="media">11</xref>: Fig. S11) and the synthetic data with variance as 0.6. If a user has a biological dataset with some degree of known ground truth for comparison, initial data exploration should explore whether combining center loss and bi-tempered logistic loss is more appropriate to capture the known spatial features of the data.</p>
      <p id="Par50">
        <list list-type="simple">
          <list-item>
            <label>5.</label>
            <p id="Par51">
              <bold>Normalized mutual information</bold>
            </p>
          </list-item>
        </list>
      </p>
      <p id="Par52">Unlike supervised learning, we do not have ground truth for training in the CoSTA approach. To monitor how well training proceeds, we use normalized mutual information (NMI) to compare clustering labels before and after weight updating across training epochs. Increase of NMI during training indicates a decreased changing of clustering labels and thus suggests convergence of model. We cannot hold aside a validation set during CoSTA training. Therefore, NMI also serves as a metric of overfitting. Once we do not observe a large jump of NMI in consecutive epochs, we consider that the model has converged. For tests with synthetic data, we also use NMI to quantify how well the CoSTA-assigned labels match the true labels.</p>
      <p id="Par53">
        <list list-type="simple">
          <list-item>
            <label>6.</label>
            <p id="Par54">
              <bold>Experiments with common image datasets</bold>
            </p>
          </list-item>
        </list>
      </p>
      <p id="Par55">MNIST handwritten, USPS-digit, and Fashion image datasets were downloaded from: <ext-link ext-link-type="uri" xlink:href="http://yann.lecun.com/exdb/mnist/">http://yann.lecun.com/exdb/mnist/</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://www.kaggle.com/bistaumanga/usps-dataset">https://www.kaggle.com/bistaumanga/usps-dataset</ext-link> and <ext-link ext-link-type="uri" xlink:href="https://www.kaggle.com/zalando-research/fashionmnist">https://www.kaggle.com/zalando-research/fashionmnist</ext-link>. These datasets come with true labels, and we noticed that the CoSTA approach can learn to predict more true labels than the model that is just initialized and exceeds UMAP + GMM with pixel values as features (Additional file <xref rid="MOESM11" ref-type="media">11</xref>: Fig. S11). For the Fashion image dataset, CoSTA was greatly improved after we add center loss with bi-tempered logistic loss as a whole loss function. However, the learning ability of CoSTA with these datasets is less than with supervised learning approaches (typically &gt; 95% accuracy). The highest accuracy we got is 0.961 (MNIST handwritten), 0.931 (USPS-digit) and 0.686 (Fashion), as measured by NMI between the clustering label and true class label. NMIs achieved with CoSTA applied to the MNIST and Fashion datasets are higher than for all other deep learning clustering methods, and the CoSTA NMI for USPS scores second in the ranking of deep learning approach performance [<xref ref-type="bibr" rid="CR7">7</xref>]. We also tested whether SpatialDE can identify patterns in these three image datasets. We used the automatic histology pattern detection implemented in SpatialDE to cluster images in MNIST handwritten, USPS-digit, and Fashion into 10 groups, and SpatialDE achieved 0.532 (MNIST handwritten), 0.658 (USPS-digit), and 0.568 (Fashion) NMIs, which are even lower than UMAP + GMM clustering with pixels (Additional file <xref rid="MOESM11" ref-type="media">11</xref>: Fig. S11).</p>
    </sec>
    <sec id="Sec15">
      <title>Simulation datasets</title>
      <p id="Par56">
        <list list-type="order">
          <list-item>
            <p id="Par57">
              <bold>Simulation of synthetic data with 5 patterns</bold>
            </p>
          </list-item>
        </list>
      </p>
      <p id="Par58">We followed the simulation approach in SPARK to generate 10,000 fake genes that can be assigned into 5 distinct patterns [<xref ref-type="bibr" rid="CR5">5</xref>]. We added residual errors onto each spatial coordinate independently based on a normal distribution with mean of zero and variance ranging from 0.2 to 0.6, resulting in 5 synthetic datasets with different noise levels. The simulation code can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/xzhoulab/SPARK">https://github.com/xzhoulab/SPARK</ext-link>.</p>
      <p id="Par59">
        <list list-type="simple">
          <list-item>
            <label>2.</label>
            <p id="Par60">
              <bold>Synthetic data with mask</bold>
            </p>
          </list-item>
        </list>
      </p>
      <p id="Par61">We selected synthetic data with variance as 0.4 for this test. We arbitrarily selected a region to mask, a region in the blue circle of Additional file <xref rid="MOESM3" ref-type="media">3</xref>: Fig. S3b. Though it is an arbitrary selection, we intentionally avoid any region that is crucial for each expression pattern. Therefore, the mask region will not disrupt spatial patterns visually. For each pattern, we randomly chose half of the simulated genes and added the mask by suppressing expression in that region to zero. The other half of the simulated genes remain intact. Thus, we have 5,000 genes each with and without masks.</p>
      <p id="Par62">
        <list list-type="simple">
          <list-item>
            <label>3.</label>
            <p id="Par63">
              <bold>Mimic real spatial transcriptomic data by mixing SE and non-SE genes</bold>
            </p>
          </list-item>
        </list>
      </p>
      <p id="Par64">We still focus on synthetic data with variance of 0.4. We further introduced non-SE genes to build more synthetic datasets that have different ratios of SE and non-SE genes. Code to generate non-SE genes can also be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/xzhoulab/SPARK">https://github.com/xzhoulab/SPARK</ext-link>. In this test, we generated 5 synthetic datasets with SE and non-SE ratios ranging from 90:10 to 10:90.</p>
    </sec>
    <sec id="Sec16">
      <title>Shuffling approach to disrupt spatial information but not pixel correlation</title>
      <p id="Par65">To evaluate the degree to which CoSTA and other methods detect patterns in space vs. pixelwise information, we used a data shuffling approach that would preserve the pixel-by-pixel correlation between different gene image matrices but disrupt the neighboring pixel spatial pattern (Additional file <xref rid="MOESM12" ref-type="media">12</xref>: Fig. S12). Each gene matrix (expression image) was flattened into a single vector by concatenating all rows of the matrix into a single row. Then, the positions of individual elements in these vectors were shuffled identically for all gene expression images. That is, for all images, the data at position 2 might now be at position 10, while position 10 would now be at position 3, etc. Then, the vectors were reformed into a matrix and these identically shuffled gene matrices were passed through a given analysis tool. Thus, any methods (such as pixel overlap or correlation) that depend only on the one-to-one relationship between pixels between two gene images will perform exactly the same on the shuffled and original data. In contrast, methods that capture information about shared patterns between neighboring pixels (such as a broader patch of high gene expression) would perform differently on the shuffled data when this previously existing broader pattern is disrupted.</p>
    </sec>
    <sec id="Sec17">
      <title>SE gene calling</title>
      <p id="Par66">To call out SE genes, we use an approach of ensemble learning. Simply put, we train 5 CoSTA models independently. We then calculate a set of nearest neighbors for every gene in the same dataset, using neighbor set sizes of 5, 10, 15, 20, 25, 30, 40, 50, and 100. This is because different genes with their neighbors may form a community with different sizes. Using a broad range of neighboring set sizes can enable us to include SE genes that only form a small community with a few genes as well as SE genes that fall into a large gene group. Next, we calculated Jaccard similarities across the 5 ConvNets and keep genes that have averaged Jaccard similarity larger than 0.2 at least in one level of neighbor set sizes: 5, 10, 15, 20, 25, 30, 40, 50, or 100.</p>
    </sec>
    <sec id="Sec18">
      <title>Correlated gene calling</title>
      <p id="Par67">To find significant correlated genes, we use the learned features from one of 5 CoSTA models to calculate Euclidean distance pairwise between all genes. For example, to get significant correlated genes with <italic>Vim</italic>, we calculated distances of all other SE genes to <italic>Vim</italic> based on the learned features. Then, we used these distances to create a null distribution. Distances that have Z-scores lower than − 2.323 (<italic>p</italic> &lt; 0.01) are considered significant, and genes that have significant distances would be called out as correlated genes to <italic>Vim</italic>. Because we trained 5 independent models, we obtain 5 sets of correlated genes for each SE gene in the data. Then, we keep correlated genes that show up in at least in 3 models.</p>
    </sec>
    <sec id="Sec19">
      <title>MERFISH analysis</title>
      <p id="Par68">We obtained the MERFISH dataset collected on the mouse preoptic region of the hypothalamus from Dryad [<xref ref-type="bibr" rid="CR15">15</xref>] (<ext-link ext-link-type="uri" xlink:href="https://datadryad.org/stash/dataset/doi:10.5061/dryad.8t8s248">https://datadryad.org/stash/dataset/doi:10.5061/dryad.8t8s248</ext-link>), and we used the slice at Bregma + 0.11 mm from animal 18 for analysis as used for SPARK analysis [<xref ref-type="bibr" rid="CR5">5</xref>]. We reduced the image resolution tenfold and resized images to 85X85 matrices. Next, we directly applied a customized CoSTA model to the MERFISH dataset. This customized approach has the same general architecture that defines CoSTA, as described above. The customized ConvNet also has three convolutional layers but each convolutional layer has a larger filter, to reduce the overall size of the output. To compare with results from SPARK, we created null distributions for correlated gene calling by permuting images 100 times. Permuted images are forwarded through CoSTA to get permuted spatial features. Then we calculated their Euclidean distances with the spatial features of the true image, and these distances serve as the null distribution. Because the 9 defined cell type expression patterns are known, significantly correlated genes to these 9 expression patterns were called SE genes. For each gene in this MERFISH dataset, including the 5 blank controls, we calculated its Euclidean distances and its 100-time shuffled distances to the 9 expression patterns. If the true Euclidean distance of one gene to one cell type pattern are lower than Z-score − 2.323, we call this gene an SE gene that is correlated to the expression pattern typical of this particular cell type. To visualize the training process, we project the feature vectors of each gene onto the first two UMAP dimensions and label each gene according to clusters defined using the whole feature vector. We use a linear intrinsic dimensionality (LID) estimator to quantify the change in cluster distinctness before and after training. This estimator mainly measures a ratio between distance of each datapoint to its the second closest datapoint and distance to its closest datapoint. Ratios are ordered from low to high and it fits a line that crosses the origin. The slope of this line represents the LID of this data in the latent space. Simply put, the lower LID, the more clustered datapoints are in the latent space. Indeed, among 10 different runs, spatial representations after training show lower LIDs than without training.</p>
    </sec>
    <sec id="Sec20">
      <title>Analysis of slide-seq with SPARK and SpatialDE</title>
      <p id="Par69">Analysis of Slide-seq with SPARK and SpatialDE follows the standard analysis pipelines proposed by these two methods, with default parameters. Code of analysis can be found at the GitHub repository (<ext-link ext-link-type="uri" xlink:href="https://github.com/rpmccordlab/CoSTA">https://github.com/rpmccordlab/CoSTA</ext-link>).</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Information</title>
    <sec id="Sec21">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="12859_2021_4314_MOESM1_ESM.pdf">
            <caption>
              <p><bold>Additional file 1. Supplementary Fig. 1:</bold> Comparison of CoSTA and overlap analysis performance in finding correlated digits to digit 3. 1000 images are sampled from the full MNIST dataset, and each digit contains 100 samples. CoSTA (red bars) uniquely calls samples of digit 3 as correlated to digit 3. However, overlap analysis (blue bars) identifies some instances of all digits as showing some overlap with digit 3. CoSTA is more specific, but less sensitive: CoSTA reports a smaller number of correlated digit 3 images (bottom right) while overlap analysis reports a greater number of correlated digits overall.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="12859_2021_4314_MOESM2_ESM.pdf">
            <caption>
              <p><bold>Additional file 2. Supplementary Fig. 2:</bold> Learning curves of CoSTA using true and shuffled synthetic datasets. 2,000 simulated gene matrices were used for each pattern, as in Fig. 1, with different levels of noise added (“variance”). Shuffling for each pattern and each simulated gene was performed identically so that pixelwise correlations were preserved but spatial relationships between neighbors were disrupted. (see Methods and Fig. S12 for shuffling approach details) NMI compares the clustering labels generated by CoSTA against the true class label.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="12859_2021_4314_MOESM3_ESM.pdf">
            <caption>
              <p><bold>Additional file 3. Supplementary Fig. 3:</bold> Performance of CoSTA using synthetic datasets with perturbations. A) Left: the same initial spatial patterns as in Fig. 1 were used. CoSTA was applied to classify 2,000 simulated genes for each pattern from the original patterns (top), half shuffled (middle), and fully shuffled (bottom) patterns. Applying trained CoSTA representations of simulated genes are visualized by using spatial representation in 2D UMAP. Genes are colored based on the true synthetic pattern from which they are derived. Silhouette scores quantify how well the representation distinguishes different patterns. (Closer to 1 = more distinguishable patterns are recovered). B) Disruption test through masking. Half of the simulated genes from each pattern have a masked region, simulating experimental missing data. The masked region is circled in blue in the upper panel. Representation of simulated genes based on pixelwise values (left) and features extracted by CoSTA (right) are visualized in 2D UMAP, and genes are colored based on pattern type from which they were generated (upper panel) or according to whether they belonged to the masked or unmasked set (lower panel).</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM4">
          <media xlink:href="12859_2021_4314_MOESM4_ESM.pdf">
            <caption>
              <p><bold>Additional file 4. Supplementary Fig. 4:</bold> Training CoSTA with different ratios of SE and non-SE genes. (A) To simulate non-SE genes, five patterns without clear spatial features were used. (B) Simulated non-SE genes were mixed with SE genes simulated from the 5 patterns in Figure 1 in different ratios from 90:10 to 10:90. CoSTA representations of these gene mixtures are visualized in 2D UMAP. Genes are colored based on pattern membership (top) or SE type (bottom). (C) Silhouette scores quantify how well the representation distinguishes different patterns for SE and non-SE genes across different mixture ratios.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM5">
          <media xlink:href="12859_2021_4314_MOESM5_ESM.pdf">
            <caption>
              <p><bold>Additional file 5. Supplementary Fig. 5:</bold> The number of overlapped neighbors of Vim, Ctsd, and Gfap before and after each weight updating across all epochs, considering either 10 nearest neighbors (left), 20 nearest neighbors (center), or 50 nearest neighbors (right).</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM6">
          <media xlink:href="12859_2021_4314_MOESM6_ESM.pdf">
            <caption>
              <p><bold>Additional file 6. Supplementary Fig. 6:</bold> The number of SE genes after 3 days and 2 weeks brain injury. (A) Overlap of SE genes identified by SPARK or CoSTA. (B) Learning curve of CoSTA with original and shuffled data. (see Methods and Fig. S12 for shuffling approach details) Y-axis shows NMI calculated between cluster labels at training epoch t and cluster labels at previous epoch t-1. X-axis shows training epoch t. (C) Percent of all measured genes that are called SE genes by the 3 approaches.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM7">
          <media xlink:href="12859_2021_4314_MOESM7_ESM.pdf">
            <caption>
              <p><bold>Additional file 7. Supplementary Fig. 7:</bold> Expression patterns of Vim, Ctsd, and Gfap 3 days and 2 weeks after brain injury. (A) Expression patterns of Vim, Ctsd, and Gfap 3 days after brain injury. (B) Expression patterns of Vim, Ctsd, Gfap and genes involved in oligodendrocyte development (bottom row) 2 weeks after brain injury. Patterns that are visibly similar between Vim, Gfap, and Ctsd (small red boxes) are not strikingly visible in oligodendrocyte development genes.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM8">
          <media xlink:href="12859_2021_4314_MOESM8_ESM.pdf">
            <caption>
              <p><bold>Additional file 8. Supplementary Fig. 8:</bold> Comparison of SPARK, SpatialDE, CoSTA, and pixel overlap results. (A) Overlap of gene lists correlated with Vim, Ctsd, and Gfap at 2 weeks after injury identified by CoSTA, SPARK, SpatialDE, and overlap analysis (“Slide-seq”). (B) Examples of gene expression images for genes detected as similar to Vim, Gfap, and Ctsd by SPARK and also by CoSTA (left) or SPARK and not CoSTA (right). Numbers below images indicate the rank of the given gene in the list of correlated genes. See Figure S7 for expression patterns of the query genes. All images are scaled between 0 and 1 for visualization purposes. Key visible regions of high expression in Vim, Gfap, and Ctsd are circled in red for cross comparison of all images. (C) Gene Ontology term enrichment evaluated by Gorilla using the ranked correlated gene list produced by CoSTA (see Table S4). (D) Examples of gene expression images for genes highly ranked by CoSTA only (left), pixel only (middle), and both (right) as similar to Vim, Gfap, and Ctsd. Annotations next to gene names indicate rankings in CoSTA “C” and Pixel “P”.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM9">
          <media xlink:href="12859_2021_4314_MOESM9_ESM.pdf">
            <caption>
              <p><bold>Additional file 9. Supplementary Fig. 9:</bold> Expression patterns of SE genes identified by CoSTA 2 weeks after brain injury. SE genes were clustered into 6 groups by SpatialDE and CoSTA. CoSTA cluster numbers correspond to Figure 4d and the most similar SpatialDE cluster is placed below the most closely corresponding CoSTA cluster when possible. The SpatialDE cluster containing Vim, Gfap, and Ctsd is cluster 2. Average expression pattern in 3rd row shows the overall pattern of all genes combined in the 2-week dataset.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM10">
          <media xlink:href="12859_2021_4314_MOESM10_ESM.pdf">
            <caption>
              <p><bold>Additional file 10. Supplementary Fig. 10:</bold> Effect of cluster number on CoSTA results with 2-week post injury Slide-seq data. a, SE genes identified by CoSTA with 10-100 clusters. b, CoSTA learning curve with 10-100 clusters. Y-axis shows NMI calculated between cluster labels at training epoch t and cluster labels at previous epoch t-1. X-axis shows training epoch t. c, Mean expression pattern of genes found to be correlated with Vim, Gfap and Ctsd identified by CoSTA with cluster numbers ranging from 10-100. Raw count values are scaled from 0 to 1 for these visualizations.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM11">
          <media xlink:href="12859_2021_4314_MOESM11_ESM.pdf">
            <caption>
              <p><bold>Additional file 11. Supplementary Fig. 11:</bold> CoSTA approach applied to clustering USPS, MNIST and Fashion datasets. Left panels: Models were trained for 10 epochs. After each weight updating, we clustered images into 10 clusters and directly compared them to true class labels through NMI. The grey line indicates clustering by UMAP+GMM with pixel values as features. The black line indicates clustering by SpatialDE. The orange line represents learning with combined center loss and bi-tempered logistic loss in Fashion dataset. Right panels: NMIs between clustering at the <italic>t</italic>th updating and the previous (t-1)th updating.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM12">
          <media xlink:href="12859_2021_4314_MOESM12_ESM.pdf">
            <caption>
              <p><bold>Additional file 12. Supplementary Fig. 12:</bold> Shuffling approach to preserve pixel correlation but disrupt spatial information. (A) Cartoon representing shuffling approach. Right: two initial 4x4 gene matrices (dimensions are small for example purposes). Each matrix shows a certain pattern of expression where a cluster of neighboring pixels show similar gene expression. Pixels are numbered so their positions can be tracked through the shuffling process. Middle: the 4x4 matrix is flattened into a single vector and then the positions of pixels are shuffled in the same way for Gene1 and Gene2 (orange arrows show a few example pixel rearrangements). The pixel ordering within each image is disrupted but each gene shares the same pixel ordering with other genes. This preserves individual pixel correlations across images from different genes but disrupts the spatial ordering and relationships between neighboring pixels. Right: shuffled vectors are reformed into a 4x4 matrix. (B) Example of shuffling result for 2 example Slide-seq gene matrices. Left: original gene expression image matrices. Shuffling is applied identically to the two genes as shown in A. Right: Resulting shuffled matrices. Visible spatial patterns are gone, but the pixel correlation of the two images would remain the same.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM13">
          <media xlink:href="12859_2021_4314_MOESM13_ESM.pdf">
            <caption>
              <p><bold>Additional file 13. Supplementary Table 1:</bold>. Comparison of CoSTA and SpatialDE classification of 10,000 simulated genes belonging to 5 spatial patterns (see Fig. 1). Normalized Mutual Information is used to measure the similarity between CoSTA or SpatialDE-derived cluster assignments and true cluster assignments (values closer to 1 indicate a higher concordance between true and predicted cluster memberships). At noise level 0.6, CoSTA performs better with the addition of center loss (0.91 vs. 0.52). For shuffled data, each gene matrix was identically shuffled as described in Fig. S12 and in the Methods. This shuffling preserves pixel correlations between genes but disrupts overall spatial patterns, allowing an evaluation of whether the tested analysis detects pixelwise or spatial information.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM14">
          <media xlink:href="12859_2021_4314_MOESM14_ESM.pdf">
            <caption>
              <p><bold>Additional file 14. Supplementary Table 2:</bold> Clusters of SE genes identified by CoSTA in the MERFISH dataset (cell type patterns are included in clusters).</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM15">
          <media xlink:href="12859_2021_4314_MOESM15_ESM.pdf">
            <caption>
              <p><bold>Additional file 15. Supplementary Table 3:</bold> CoSTA was applied to gene images from 4 different Slide-seq experiments and evaluated for whether it could separate gene images correctly into which original tissue slice (overall pattern) they came from. The table shows the confusion matrix of clustering labels derived from CoSTA results compared to the original known experimental label.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM16">
          <media xlink:href="12859_2021_4314_MOESM16_ESM.xlsx">
            <caption>
              <p><bold>Additional file 16. Supplementary Table 4:</bold> All CoSTA SE genes in Slide-seq data 2 days after injury ranked according to their similarity to query genes Vim, Ctsd, and Gfap. Ranking according to CoSTA feature vectors as well as by pixel correlation are shown. Columns 4 and 5 indicate whether each gene was found to be correlated to these query genes by SPARK or SpatialDE.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM17">
          <media xlink:href="12859_2021_4314_MOESM17_ESM.xlsx">
            <caption>
              <p><bold>Additional file 17. Supplementary Table 5:</bold> List of genes in each cluster derived by CoSTA from the 2-week Slide-seq data, as shown in Figure 4D.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM18">
          <media xlink:href="12859_2021_4314_MOESM18_ESM.pdf">
            <caption>
              <p><bold>Additional file 18. Supplementary Table 6:</bold> Runtime of CoSTA for 3-day and 2-week Slide-seq data. Runtimes are measured in minutes and under different numbers of clusters being assigned during training.</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <glossary>
    <title>Abbreviations</title>
    <def-list>
      <def-item>
        <term>ConvNet</term>
        <def>
          <p id="Par4">Convolutional neural network</p>
        </def>
      </def-item>
      <def-item>
        <term>SE or SV gene</term>
        <def>
          <p id="Par5">Spatially expressed or spatially variable gene</p>
        </def>
      </def-item>
      <def-item>
        <term>CoSTA</term>
        <def>
          <p id="Par6">Unsupervised ConvNet learning strategy for spatial transcriptomics analysis</p>
        </def>
      </def-item>
    </def-list>
  </glossary>
  <fn-group>
    <fn>
      <p>
        <bold>Publisher's Note</bold>
      </p>
      <p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank Tian Hong, Tongye Shen, and Amir Sadovnik for insightful discussion.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Authors' contributions</title>
    <p>YX conceived the project, developed the computational approach, and performed analyses. RPM supervised the project, performed some analyses and prepared some figures, and YX and RPM wrote the manuscript. All authors have read and approved the final manuscript.</p>
  </notes>
  <notes notes-type="funding-information">
    <title>Funding</title>
    <p>This research was supported in part by NIH NIGMS grant R35GM133557 to R.P.M. The funding body played no role in the design of the study nor in the collection, analysis, and interpretation of data, nor in writing the manuscript.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Availability of data and materials</title>
    <p>The processed Slide-seq datasets were retrieved from <ext-link ext-link-type="uri" xlink:href="https://singlecell.broadinstitute.org/single_cell/study/SCP354/slide-seq-study">https://singlecell.broadinstitute.org/single_cell/study/SCP354/slide-seq-study</ext-link>. We also deposited processed MERFISH and Slide-seq data and scripts for all analyses in this study at the GitHub repository (<ext-link ext-link-type="uri" xlink:href="https://github.com/rpmccordlab/CoSTA">https://github.com/rpmccordlab/CoSTA</ext-link>) under an Open Source Initiative compliant MIT license. The version of the code used in the manuscript is available at <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.5281/zenodo.3948711">https://doi.org/10.5281/zenodo.3948711</ext-link>.</p>
  </notes>
  <notes>
    <title>Declarations</title>
    <notes id="FPar1">
      <title>Ethics approval and consent to participate</title>
      <p id="Par70">Not applicable.</p>
    </notes>
    <notes id="FPar2">
      <title>Consent to publish</title>
      <p id="Par71">Not applicable.</p>
    </notes>
    <notes id="FPar3" notes-type="COI-statement">
      <title>Competing interests</title>
      <p id="Par72">The authors declare that they have no competing interests.</p>
    </notes>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Burgess</surname>
            <given-names>DJ</given-names>
          </name>
        </person-group>
        <article-title>Spatial transcriptomics coming of age</article-title>
        <source>Nat Rev Genet</source>
        <year>2019</year>
        <volume>20</volume>
        <issue>6</issue>
        <fpage>317</fpage>
        <pub-id pub-id-type="doi">10.1038/s41576-019-0129-z</pub-id>
        <pub-id pub-id-type="pmid">30980030</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Eng</surname>
            <given-names>CHL</given-names>
          </name>
          <name>
            <surname>Lawson</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Zhu</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Dries</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Koulena</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Takei</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Yun</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Cronin</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Karp</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Yuan</surname>
            <given-names>G-C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Transcriptome-scale super-resolved imaging in tissues by RNA seqFISH</article-title>
        <source>Nature</source>
        <year>2019</year>
        <volume>568</volume>
        <issue>7751</issue>
        <fpage>235</fpage>
        <pub-id pub-id-type="doi">10.1038/s41586-019-1049-y</pub-id>
        <pub-id pub-id-type="pmid">30911168</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rodriques</surname>
            <given-names>SG</given-names>
          </name>
          <name>
            <surname>Stickels</surname>
            <given-names>RR</given-names>
          </name>
          <name>
            <surname>Goeva</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Martin</surname>
            <given-names>CA</given-names>
          </name>
          <name>
            <surname>Murray</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Vanderburg</surname>
            <given-names>CR</given-names>
          </name>
          <name>
            <surname>Welch</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>LM</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Macosko</surname>
            <given-names>EZ</given-names>
          </name>
        </person-group>
        <article-title>Slide-seq: a scalable technology for measuring genome-wide expression at high spatial resolution</article-title>
        <source>Science</source>
        <year>2019</year>
        <volume>363</volume>
        <issue>6434</issue>
        <fpage>1463</fpage>
        <lpage>1467</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aaw1219</pub-id>
        <pub-id pub-id-type="pmid">30923225</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Valentine</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Sarah</surname>
            <given-names>AT</given-names>
          </name>
          <name>
            <surname>Oliver</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>SpatialDE: identification of spatially variable genes</article-title>
        <source>Nat Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <issue>5</issue>
        <fpage>343</fpage>
        <lpage>346</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4636</pub-id>
        <pub-id pub-id-type="pmid">29553579</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sun</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Zhu</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Zhou</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Statistical analysis of spatial expression patterns for spatially resolved transcriptomic studies</article-title>
        <source>Nat Methods</source>
        <year>2020</year>
        <volume>17</volume>
        <issue>2</issue>
        <fpage>193</fpage>
        <lpage>200</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0701-7</pub-id>
        <pub-id pub-id-type="pmid">31988518</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <mixed-citation publication-type="other">Caron M, Bojanowski P, Joulin A, Douze M. Deep clustering for unsupervised learning of visual features. 2018. <ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1807.05520v2">arXiv:1807.05520v2</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <mixed-citation publication-type="other">McConville R, Santos-Rodriguez R, Piechocki RJ, Craddock I. N2D: (Not Too) deep clustering via clustering the local manifold of an autoencoded embedding. 2019. <ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1908.05968v6">arxiv:1908.05968v6</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <mixed-citation publication-type="other">Xie J, Girshick R, Farhadi A. Unsupervised deep embedding for clustering analysis. In: Proceedings of the 33rd International Conference on International Conference on Machine Learning. Vol 48, 2016; pp. 478–87. New York, NY, USA.</mixed-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <mixed-citation publication-type="other">McInnes L, Healy J, Melville J. UMAP: uniform manifold approximation and projection for dimension reduction. 2018. <ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1802.03426v2">arxiv:1802.03426v2</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <mixed-citation publication-type="other">Amid E, Warmuth MK, Anil R, Koren T. Robust bi-tempered logistic loss based on bregman divergences. 2019. <ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1906.03361v3">arxiv:1906.03361v3</ext-link></mixed-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Addison</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Xu</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Cayuso</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Wilkinson</surname>
            <given-names>DG</given-names>
          </name>
        </person-group>
        <article-title>Cell identity switching regulated by retinoic acid signaling maintains homogeneous segments in the hindbrain</article-title>
        <source>Dev Cell</source>
        <year>2018</year>
        <volume>45</volume>
        <issue>5</issue>
        <fpage>606</fpage>
        <lpage>620.e603</lpage>
        <pub-id pub-id-type="doi">10.1016/j.devcel.2018.04.003</pub-id>
        <pub-id pub-id-type="pmid">29731343</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>D</given-names>
          </name>
        </person-group>
        <article-title>The MNIST database of handwritten digit images for machine learning research [best of the web]</article-title>
        <source>IEEE Signal Process Mag</source>
        <year>2012</year>
        <volume>29</volume>
        <issue>6</issue>
        <fpage>141</fpage>
        <lpage>142</lpage>
        <pub-id pub-id-type="doi">10.1109/MSP.2012.2211477</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ståhl</surname>
            <given-names>PL</given-names>
          </name>
          <name>
            <surname>Salmén</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Vickovic</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Lundmark</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Navarro</surname>
            <given-names>JF</given-names>
          </name>
          <name>
            <surname>Magnusson</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Giacomello</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Asp</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Westholm</surname>
            <given-names>JO</given-names>
          </name>
          <name>
            <surname>Huss</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Visualization and analysis of gene expression in tissue sections by spatial transcriptomics</article-title>
        <source>Science (Am Assoc Adv Sci)</source>
        <year>2016</year>
        <volume>353</volume>
        <issue>6294</issue>
        <fpage>78</fpage>
        <lpage>82</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aaf2403</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Vinh</surname>
            <given-names>NX</given-names>
          </name>
          <name>
            <surname>Epps</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Bailey</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Information theoretic measures for clusterings comparison: variants, properties, normalization and correction for chance</article-title>
        <source>J Mach Learn Res</source>
        <year>2010</year>
        <volume>11</volume>
        <fpage>2837</fpage>
        <lpage>2854</lpage>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Moffitt</surname>
            <given-names>JR</given-names>
          </name>
          <name>
            <surname>Bambah-Mukku</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Eichhorn</surname>
            <given-names>SW</given-names>
          </name>
          <name>
            <surname>Vaughn</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Shekhar</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Perez</surname>
            <given-names>JD</given-names>
          </name>
          <name>
            <surname>Rubinstein</surname>
            <given-names>ND</given-names>
          </name>
          <name>
            <surname>Hao</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Dulac</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Molecular, spatial, and functional single-cell profiling of the hypothalamic preoptic region</article-title>
        <source>Science</source>
        <year>2018</year>
        <volume>362</volume>
        <issue>6414</issue>
        <fpage>eaau5324</fpage>
        <pub-id pub-id-type="doi">10.1126/science.aau5324</pub-id>
        <pub-id pub-id-type="pmid">30385464</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Facco</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>d’Errico</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Rodriguez</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Laio</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Estimating the intrinsic dimension of datasets by a minimal neighborhood information</article-title>
        <source>Sci Rep</source>
        <year>2017</year>
        <volume>7</volume>
        <issue>1</issue>
        <fpage>12140</fpage>
        <lpage>12148</lpage>
        <pub-id pub-id-type="doi">10.1038/s41598-017-11873-y</pub-id>
        <pub-id pub-id-type="pmid">28939866</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Edsgärd</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Johnsson</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Sandberg</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Identification of spatial expression trends in single-cell gene expression data</article-title>
        <source>Nat Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <issue>5</issue>
        <fpage>339</fpage>
        <lpage>342</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4634</pub-id>
        <pub-id pub-id-type="pmid">29553578</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Eden</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Navon</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Steinfeld</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Lipson</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Yakhini</surname>
            <given-names>Z</given-names>
          </name>
        </person-group>
        <article-title>GOrilla: a tool for discovery and visualization of enriched GO terms in ranked gene lists</article-title>
        <source>BMC Bioinform</source>
        <year>2009</year>
        <volume>10</volume>
        <issue>1</issue>
        <fpage>48</fpage>
        <lpage>48</lpage>
        <pub-id pub-id-type="doi">10.1186/1471-2105-10-48</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stickels</surname>
            <given-names>RR</given-names>
          </name>
          <name>
            <surname>Murray</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Kumar</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Marshall</surname>
            <given-names>JL</given-names>
          </name>
          <name>
            <surname>Di Bella</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Arlotta</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Macosko</surname>
            <given-names>EZ</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>F</given-names>
          </name>
        </person-group>
        <article-title>Highly sensitive spatial transcriptomics at near-cellular resolution with Slide-seqV2</article-title>
        <source>Nat Biotechnol</source>
        <year>2021</year>
        <volume>39</volume>
        <issue>3</issue>
        <fpage>313</fpage>
        <lpage>319</lpage>
        <pub-id pub-id-type="doi">10.1038/s41587-020-0739-1</pub-id>
        <pub-id pub-id-type="pmid">33288904</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Chen</surname>
            <given-names>KH</given-names>
          </name>
          <name>
            <surname>Boettiger</surname>
            <given-names>AN</given-names>
          </name>
          <name>
            <surname>Moffitt</surname>
            <given-names>JR</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Zhuang</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Spatially resolved, highly multiplexed RNA profiling in single cells</article-title>
        <source>Science</source>
        <year>2015</year>
        <volume>348</volume>
        <issue>6233</issue>
        <fpage>aaa6090</fpage>
        <pub-id pub-id-type="doi">10.1126/science.aaa6090</pub-id>
        <pub-id pub-id-type="pmid">25858977</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Allen</surname>
            <given-names>WE</given-names>
          </name>
          <name>
            <surname>Wright</surname>
            <given-names>MA</given-names>
          </name>
          <name>
            <surname>Sylwestrak</surname>
            <given-names>EL</given-names>
          </name>
          <name>
            <surname>Samusik</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Vesuna</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Evans</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Liu</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Ramakrishnan</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Liu</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Three-dimensional intact-tissue sequencing of single-cell transcriptional states</article-title>
        <source>Science</source>
        <year>2018</year>
        <volume>361</volume>
        <issue>6400</issue>
        <fpage>eaat5691</fpage>
        <pub-id pub-id-type="doi">10.1126/science.aat5691</pub-id>
        <pub-id pub-id-type="pmid">29930089</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Vickovic</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Eraslan</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Salmén</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Klughammer</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Stenbeck</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Schapiro</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Äijö</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Bonneau</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Bergenstråhle</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Navarro</surname>
            <given-names>JF</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>High-definition spatial transcriptomics for in situ tissue profiling</article-title>
        <source>Nat Methods</source>
        <year>2019</year>
        <volume>16</volume>
        <issue>10</issue>
        <fpage>987</fpage>
        <lpage>990</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0548-y</pub-id>
        <pub-id pub-id-type="pmid">31501547</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <mixed-citation publication-type="other">Yang J, Parikh D, Batra D. Joint unsupervised learning of deep representations and image clusters. 2016. <ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1604.03628v3">arxiv:1604.03628v3</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Wen</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Qiao</surname>
            <given-names>Y</given-names>
          </name>
        </person-group>
        <article-title>A discriminative feature learning approach for deep face recognition</article-title>
        <source>Computer vision—ECCV 2016</source>
        <year>2016</year>
        <publisher-loc>Cham</publisher-loc>
        <publisher-name>Springer</publisher-name>
        <fpage>499</fpage>
        <lpage>515</lpage>
      </element-citation>
    </ref>
  </ref-list>
</back>
