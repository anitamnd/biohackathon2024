<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.1 20151215//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.1?>
<?ConverterInfo.XSLTName jats2jats3.xsl?>
<?ConverterInfo.Version 1?>
<?properties open_access?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">J Synchrotron Radiat</journal-id>
    <journal-id journal-id-type="iso-abbrev">J Synchrotron Radiat</journal-id>
    <journal-id journal-id-type="publisher-id">J. Synchrotron Rad.</journal-id>
    <journal-title-group>
      <journal-title>Journal of Synchrotron Radiation</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">0909-0495</issn>
    <issn pub-type="epub">1600-5775</issn>
    <publisher>
      <publisher-name>International Union of Crystallography</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10161887</article-id>
    <article-id pub-id-type="pmid">37000183</article-id>
    <article-id pub-id-type="publisher-id">gy5041</article-id>
    <article-id pub-id-type="doi">10.1107/S1600577523001674</article-id>
    <article-id pub-id-type="coden">JSYRES</article-id>
    <article-id pub-id-type="pii">S1600577523001674</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Research Papers</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title><italic toggle="yes">darfix</italic> – data analysis for dark-field X-ray microscopy</article-title>
      <alt-title>
        <italic toggle="yes">darfix</italic>
      </alt-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Garriga Ferrer</surname>
          <given-names>Júlia</given-names>
        </name>
        <xref rid="a" ref-type="aff">a</xref>
        <xref rid="cor" ref-type="corresp">*</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-0137-8174</contrib-id>
        <name>
          <surname>Rodríguez-Lamas</surname>
          <given-names>Raquel</given-names>
        </name>
        <xref rid="a" ref-type="aff">a</xref>
        <xref rid="cor" ref-type="corresp">*</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Payno</surname>
          <given-names>Henri</given-names>
        </name>
        <xref rid="a" ref-type="aff">a</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0003-2258-9402</contrib-id>
        <name>
          <surname>De Nolf</surname>
          <given-names>Wout</given-names>
        </name>
        <xref rid="a" ref-type="aff">a</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0001-5714-4257</contrib-id>
        <name>
          <surname>Cook</surname>
          <given-names>Phil</given-names>
        </name>
        <xref rid="a" ref-type="aff">a</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Solé Jover</surname>
          <given-names>Vicente Armando</given-names>
        </name>
        <xref rid="a" ref-type="aff">a</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-4969-0685</contrib-id>
        <name>
          <surname>Yildirim</surname>
          <given-names>Can</given-names>
        </name>
        <xref rid="a" ref-type="aff">a</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0003-2573-2286</contrib-id>
        <name>
          <surname>Detlefs</surname>
          <given-names>Carsten</given-names>
        </name>
        <xref rid="a" ref-type="aff">a</xref>
      </contrib>
      <aff id="a"><label>a</label><institution>ESRF– The European Synchrotron</institution>, 71 Avenue des Martyrs, CS40220, 38043 Grenoble Cedex 9, <country>France</country></aff>
    </contrib-group>
    <contrib-group>
      <contrib contrib-type="editor">
        <name>
          <surname>Bergamaschi</surname>
          <given-names>A.</given-names>
        </name>
        <role>Editor</role>
      </contrib>
      <aff>Paul Scherrer Institut, <country>Switzerland</country>
</aff>
    </contrib-group>
    <author-notes>
      <corresp id="cor">Correspondence e-mail: <email>julia.garriga@esrf.fr</email>, <email>raquel.rodriguez-lamas@esrf.fr</email>
</corresp>
    </author-notes>
    <pub-date pub-type="collection">
      <day>01</day>
      <month>5</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>31</day>
      <month>3</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>31</day>
      <month>3</month>
      <year>2023</year>
    </pub-date>
    <!--PMC Release delay is 0 months and 0 days and was based on the <pub-date pub-type="epub"/>.-->
    <volume>30</volume>
    <issue>Pt 3</issue>
    <issue-id pub-id-type="publisher-id">s230300</issue-id>
    <fpage>527</fpage>
    <lpage>537</lpage>
    <history>
      <date date-type="received">
        <day>08</day>
        <month>6</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>23</day>
        <month>2</month>
        <year>2023</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© Júlia Garriga Ferrer et al. 2023</copyright-statement>
      <copyright-year>2023</copyright-year>
      <license>
        <ali:license_ref xmlns:ali="http://www.niso.org/schemas/ali/1.0/" specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p>This is an open-access article distributed under the terms of the Creative Commons Attribution (CC-BY) Licence, which permits unrestricted use, distribution, and reproduction in any medium, provided the original authors and source are cited.</license-p>
      </license>
      <ali:free_to_read xmlns:ali="http://www.niso.org/schemas/ali/1.0/"/>
    </permissions>
    <self-uri xlink:href="https://doi.org/10.1107/S1600577523001674">A full version of this article is available from Crystallography Journals Online.</self-uri>
    <abstract abstract-type="toc">
      <p><italic toggle="yes">darfix</italic>, a Python package for dark-field X-ray microscopy, is presented as a set of tools for data processing, treatment and analysis.</p>
    </abstract>
    <abstract>
      <p>A Python package for the analysis of dark-field X-ray microscopy (DFXM) and rocking curve imaging (RCI) data is presented. DFXM is a non-destructive diffraction imaging technique that provides three-dimensional maps of lattice strain and orientation. The <italic toggle="yes">darfix</italic> package enables fast processing and visualization of these data, providing the user with the essential tools to extract information from the acquired images in a fast and intuitive manner. These data processing and visualization tools can be either imported as library components or accessed through a graphical user interface as an Orange add-on. In the latter case, the different analysis modules can be easily chained to define computational workflows. Operations on larger-than-memory image sets are supported through the implementation of online versions of the data processing algorithms, effectively trading performance for feasibility when the computing resources are limited. The software can automatically extract the relevant instrument angle settings from the input files’ metadata. The currently available input file format is EDF and in future releases HDF5 will be incorporated.</p>
    </abstract>
    <kwd-group>
      <kwd>X-ray optics</kwd>
      <kwd>software</kwd>
      <kwd>data analysis</kwd>
    </kwd-group>
    <counts>
      <page-count count="11"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec sec-type="introduction" id="sec1">
    <label>1.</label>
    <title>Introduction</title>
    <p>Dark-field X-ray microscopy (DFXM) is a novel full-field imaging technique that non-destructively maps the 3D structure, orientation and strain of deeply embedded crystalline elements, such as grains or domains (Simons <italic toggle="yes">et al.</italic>, 2015<xref rid="bb44" ref-type="bibr"> ▸</xref>; Poulsen <italic toggle="yes">et al.</italic>, 2017<xref rid="bb38" ref-type="bibr"> ▸</xref>; Poulsen, 2020<xref rid="bb36" ref-type="bibr"> ▸</xref>; Yildirim <italic toggle="yes">et al.</italic>, 2020<xref rid="bb53" ref-type="bibr"> ▸</xref>). Direct-space images are formed by placing an X-ray objective lens along the diffracted beam, affording a spatial resolution of the order of 100 nm, while maintaining a working distance between the sample and X-ray objective lens that is in the centimetre-range.</p>
    <p>The first implementation of a dedicated dark-field X-ray microscope was recently installed on beamline ID06-HXM of the European Synchrotron Radiation Facility (Kutsal <italic toggle="yes">et al.</italic>, 2019<xref rid="bb25" ref-type="bibr"> ▸</xref>). Since its installation, this instrument has been used to investigate a variety of scientific subjects, including the domain evolution in ferroelectrics (Simons <italic toggle="yes">et al.</italic>, 2018<xref rid="bb42" ref-type="bibr"> ▸</xref>), the austenitic transformation in shape memory alloys (Bucsek <italic toggle="yes">et al.</italic>, 2019<xref rid="bb8" ref-type="bibr"> ▸</xref>), recovery in metals (Mavrikakis <italic toggle="yes">et al.</italic>, 2019<xref rid="bb30" ref-type="bibr"> ▸</xref>; Ahl <italic toggle="yes">et al.</italic>, 2020<xref rid="bb1" ref-type="bibr"> ▸</xref>), embedded particles in steel (Hlushko <italic toggle="yes">et al.</italic>, 2020<xref rid="bb19" ref-type="bibr"> ▸</xref>), visualization of dislocation structures (Jakobsen <italic toggle="yes">et al.</italic>, 2019<xref rid="bb22" ref-type="bibr"> ▸</xref>; Dresselhaus-Marais <italic toggle="yes">et al.</italic>, 2021<italic toggle="yes">a</italic>
<xref rid="bb14" ref-type="bibr"> ▸</xref>) and the structure of biominerals (Cook <italic toggle="yes">et al.</italic>, 2018<xref rid="bb10" ref-type="bibr"> ▸</xref>; Schoeppler <italic toggle="yes">et al.</italic>, 2022<xref rid="bb41" ref-type="bibr"> ▸</xref>).</p>
    <p>DFXM is conceptually similar to dark-field electron microscopy in transmission electron microscopy, which is used to selectively image strain and orientation across materials science, physics, geoscience and numerous other fields (Williams &amp; Carter, 1996<xref rid="bb52" ref-type="bibr"> ▸</xref>; Nellist &amp; Pennycook, 2000<xref rid="bb31" ref-type="bibr"> ▸</xref>; Morones <italic toggle="yes">et al.</italic>, 2005<xref rid="bb40" ref-type="bibr"> ▸</xref>).</p>
    <p>While the <italic toggle="yes">darfix</italic> Python package has been specifically designed as a tool to facilitate the data treatment of DFXM data in particular, it can be used in a larger scope for imaging and diffraction data obtained from other techniques. So far, <italic toggle="yes">darfix</italic> fully supports the EDF file format. Data treatment of files in HDF5 format is enabled for datasets containing a stack of images as a function of one external parameter. Full support for HDF5 is planned for a future release.</p>
  </sec>
  <sec id="sec2">
    <label>2.</label>
    <title>Dark-field X-ray microscopy</title>
    <p>The geometry of DFXM is illustrated in Fig. 1<xref rid="fig1" ref-type="fig"> ▸</xref>; further details are given by Poulsen <italic toggle="yes">et al.</italic> (2017<xref rid="bb38" ref-type="bibr"> ▸</xref>) and Kutsal <italic toggle="yes">et al.</italic> (2019<xref rid="bb25" ref-type="bibr"> ▸</xref>). A nearly monochromatic and nearly collimated X-ray beam illuminates the sample. This beam may be condensed in the vertical and horizontal directions to increase the beam intensity in the field of view, or to selectively illuminate a thin layer within the sample. The energy bandwidth is of the order Δ<italic toggle="yes">E</italic>/<italic toggle="yes">E</italic> ≃ 1.4 × 10<sup>−4</sup>.</p>
    <p>The goniometer is designed to access diffraction angles in the vertical scattering plane (where <bold>k</bold>
<sub>0</sub> and <bold>k</bold>
<sub>d</sub> lie in the <italic toggle="yes">x</italic>–
<italic toggle="yes">z</italic>
plane) and probe reciprocal space only in the immediate vicinity of a given Bragg reflection (<italic toggle="yes">h</italic>, <italic toggle="yes">k</italic>, <italic toggle="yes">l</italic>). The current implementation of DFXM at ID06-HXM, ESRF, achieves this by moving the sample along a combination of μ, ω, χ and ϕ rotation stages, see Fig. 1<xref rid="fig1" ref-type="fig"> ▸</xref>. A detailed description of the stacking order of the motors in the goniometer is given by Poulsen <italic toggle="yes">et al.</italic> (2017<xref rid="bb38" ref-type="bibr"> ▸</xref>). The direction of the diffracted beam is characterized by the scattering angle, 2θ, and the azimuthal angle, η. In most experiments the sample is aligned such that η ≃ 0.</p>
    <p>The optical axis of an X-ray objective is aligned to the diffracted beam to produce a magnified image (inverted in both directions) on the 2D detector. The magnification can be calculated from the distances <italic toggle="yes">d</italic>
<sub>1</sub> (sample to objective) and <italic toggle="yes">d</italic>
<sub>2</sub> (objective to detector), and experimentally verified by observing the displacement of the image upon small calibrated translations of the sample.</p>
    <p>In addition to the magnified DFXM images, there are further 2D detectors to record non-magnified images, <italic toggle="yes">e.g.</italic> a ‘near-field camera’ positioned directly downstream of the sample (Kutsal <italic toggle="yes">et al.</italic>, 2019<xref rid="bb25" ref-type="bibr"> ▸</xref>). This can be used for classical diffraction topography and its extension, rocking curve imaging (Tran Thi <italic toggle="yes">et al.</italic>, 2017<xref rid="bb48" ref-type="bibr"> ▸</xref>).</p>
    <sec id="sec2.1">
      <label>2.1.</label>
      <title>Scan types</title>
      <p>The 2D images recorded as a function of the different rotation angles form the main data sets of DFXM. <italic toggle="yes">darfix</italic> facilitates the treatment of the individual raw images and the systematic analysis of scans.</p>
      <p>The following recurring scan types are commonly used in DFXM:</p>
      <sec id="sec2.1.1">
        <label>2.1.1.</label>
        <title>Rocking curve imaging</title>
        <p>Rocking curve imaging is an extension of classical diffraction topography. The diffraction topograph is measured as a function of the ‘rocking’ angle, μ (see Fig. 1<xref rid="fig1" ref-type="fig"> ▸</xref>). Rocking curve imaging is typically performed without the magnifying objective lens, using the near-field camera. In this case the resolution in the 2θ and transverse (χ) directions is relatively low (Tran Thi <italic toggle="yes">et al.</italic>, 2017<xref rid="bb48" ref-type="bibr"> ▸</xref>). It can, however, also be carried out in DFXM mode.</p>
      </sec>
      <sec id="sec2.1.2">
        <label>2.1.2.</label>
        <title>Mosaicity scans</title>
        <p>Mosaicity scans can be seen as a generalization of rocking curve imaging, taking advantage of the improved resolution in the transverse (χ) direction due to the limited angular acceptance of the objective lens (Poulsen <italic toggle="yes">et al.</italic>, 2017<xref rid="bb38" ref-type="bibr"> ▸</xref>).</p>
      </sec>
      <sec id="sec2.1.3">
        <label>2.1.3.</label>
        <title>Strain scans</title>
        <p>In strain scans, the scattering angle 2θ is varied in order to probe spatial variations in the <italic toggle="yes">d</italic>-spacing of selected Bragg reflections (Poulsen <italic toggle="yes">et al.</italic>, 2017<xref rid="bb38" ref-type="bibr"> ▸</xref>, 2021<xref rid="bb37" ref-type="bibr"> ▸</xref>). Typically, strain maps are constructed from a series of rocking scans performed consecutively over a given range of scattering angles.</p>
      </sec>
      <sec id="sec2.1.4">
        <label>2.1.4.</label>
        <title>Combined mosaicity-strain scans</title>
        <p>By recording a (2D) mosaicity map instead of a (1D) rocking curve scan at each 2θ position, all three directions in reciprocal space are probed. This is the most complete type of DFXM scan. However, as a 3D mesh of motor positions must be scanned, this scan type also requires the longest data acquisition time and yields the largest raw data volumes.</p>
      </sec>
      <sec id="sec2.1.5">
        <label>2.1.5.</label>
        <title>Reciprocal space mapping</title>
        <p>This type of scan is similar to rocking curve imaging, without the objective lens. The images are recorded on a large-field-of-view camera positioned in the far-field [<italic toggle="yes">i.e.</italic> ∼5 m from the sample (Kutsal <italic toggle="yes">et al.</italic>, 2019<xref rid="bb25" ref-type="bibr"> ▸</xref>)]. This type of scan provides angular information in three dimensions, μ (scan axis), η and 2θ [derived from the pixel position, see Fig. 1<xref rid="fig1" ref-type="fig"> ▸</xref> and Poulsen <italic toggle="yes">et al.</italic> (2017<xref rid="bb38" ref-type="bibr"> ▸</xref>)]. Similar to rocking curve real-space imaging, the analysis includes integrated intensity and center-of-mass visualization. Reciprocal space mapping can be used, for example, to determine twin relationships between domains in ferroelastic materials (Gorfman <italic toggle="yes">et al.</italic>, 2022<xref rid="bb17" ref-type="bibr"> ▸</xref>).</p>
      </sec>
      <sec id="sec2.1.6">
        <label>2.1.6.</label>
        <title>Layer scans</title>
        <p>All of the scans listed above can be performed with a line-focused beam illuminating a single ∼150 nm-thick layer within the sample. Layers recorded at a series of heights within the sample can then be combined into 3D volume maps.</p>
      </sec>
    </sec>
  </sec>
  <sec id="sec3">
    <label>3.</label>
    <title>The <italic toggle="yes">darfix</italic> codebase</title>
    <p><italic toggle="yes">darfix</italic> is a Python library that provides a set of computer vision techniques for the analysis of dark-field X-ray microscopy data. It is split into two modules: (1) a back-end that contains the core processing utilities, algorithm implementations and abstractions, and (2) a graphical user interface (GUI). The typical user would interact with the core module through the GUI, but it is possible and straightforward to access the core methods directly by importing that part of the library. The central code object is <inline-formula><inline-graphic xlink:href="s-30-00527-efi1.jpg"/></inline-formula>, which encapsulates the properties of a stack of images (multiple rotation angles can vary within a single stack of images, each axis adds a dimension to the image stack). Operations on <italic toggle="yes">darfix</italic> (<italic toggle="yes">e.g.</italic> blind source separation, hot pixel removal, shift correction) are implemented as isolated tasks acting on a dataset and returning a dataset. This allows computational workflows to be defined by chaining several operations together. Furthermore, as datasets are commonly of the order of several hundred gigabytes, the software provides online versions for many of the data processing algorithms: the output is built incrementally as more data are brought in. The modules can then be processed sequentially in chunks if memory usage is limited. This is particularly relevant for dataset sizes larger than the available memory. If the option ‘use data from disk’ is selected when loading the data, these online versions will be automatically used throughout the workflow.</p>
    <p><italic toggle="yes">darfix</italic> is not offered as a stand-alone application, but includes an Orange (Demšar &amp; Zupan, 2013<xref rid="bb13" ref-type="bibr"> ▸</xref>) add-on for the definition of workflows. Orange is a platform for performing data analysis and visualization, which allows for the creation of workflows using the <italic toggle="yes">darfix</italic> GUI. A typical workflow comprises tasks such as raw data selection, background removal, region-of-interest selection, scan variable identification, scan processing (<italic toggle="yes">e.g.</italic> rocking curve fitting), display of the results, <italic toggle="yes">etc</italic>. (see Fig. 3). All the tasks in <italic toggle="yes">darfix</italic> are independent (in the GUI as well as in the back-end part), so that for every task there is a different dedicated widget. These widgets are based on <italic toggle="yes">Qt</italic> (The Qt Company, 2021<xref rid="bb46" ref-type="bibr"> ▸</xref>) and <italic toggle="yes">silx</italic> (Vincent <italic toggle="yes">et al.</italic>, 2021<xref rid="bb49" ref-type="bibr"> ▸</xref>). They can be linked through the workflow created in Orange. In addition, workflows in Orange can be called from the command line with different input datasets. The algorithms that were used in the original workflow will be then reproduced without the need of the GUI. Moreover, a workflow defined from the GUI can be saved with its settings and reused using <italic toggle="yes">ewoks</italic> (De Nolf <italic toggle="yes">et al.</italic>, 2022<xref rid="bb12" ref-type="bibr"> ▸</xref>). This allows users to launch the same workflow (algorithms and settings) but with a different input data set. This is particularly useful when the same workflow has to be carried out for a series of datasets, <italic toggle="yes">e.g.</italic> the same analysis has to be applied to every layer in a 3D volume map.</p>
    <p><italic toggle="yes">darfix</italic> contains a series of image processing methods for the analysis of DFXM scans. These methods can be organized into three groups: the selection of the data, the pre-processing algorithms, and the analysis and visualization of the results. To provide a complete overview of the current modules and their functionalities, a workflow exported from the GUI is represented in Fig. 2<xref rid="fig2" ref-type="fig"> ▸</xref>.</p>
    <p>The following sections provide an overview of the used techniques. A simplified version of a <italic toggle="yes">darfix</italic> workflow, focused on data pre-processing, is presented in Fig. 3<xref rid="fig3" ref-type="fig"> ▸</xref>(<italic toggle="yes">a</italic>).</p>
    <sec id="sec3.1">
      <label>3.1.</label>
      <title>File inputs: data selection</title>
      <p>Currently, <italic toggle="yes">darfix</italic> accepts the ESRF data format (.edf) of the ID06 detectors, and is able to automatically characterize the relevant instrument angle settings by analyzing the input files’ metadata. HDF5 (The HDF Group, 1997–2022<xref rid="bb45" ref-type="bibr"> ▸</xref>; Collette, 2013<xref rid="bb9" ref-type="bibr"> ▸</xref>) is accepted, but only without dimension definition as the analysis of metadata is still under development.</p>
      <p>Output data can be saved from the GUI in different formats: EDF, HDF5 [NeXus data format (Könnecke <italic toggle="yes">et al.</italic>, 2015<xref rid="bb24" ref-type="bibr"> ▸</xref>)], CSV, TIFF, NumPy, ASCII and PNG. In the analysis there is usually the possibility to export specific data in a HDF5 file, which can then be used for any required post-processing. Alternatively, when working without the GUI, NumPy arrays can be extracted from the <inline-formula><inline-graphic xlink:href="s-30-00527-efi1.jpg"/></inline-formula> object for further processing.</p>
      <p>Modified data are automatically saved onto disk under a folder chosen by the user. By default, only the output dataset of the most recent task of the workflow is saved, but there exists the possibility to copy the output of every task by appending a <italic toggle="yes">Data copy</italic> widget to it.</p>
      <p>Exporting data in a format compatible with 3D visualization and processing software, <italic toggle="yes">e.g.</italic>
<italic toggle="yes">Paraview</italic> (Ahrens <italic toggle="yes">et al.</italic>, 2005<xref rid="bb3" ref-type="bibr"> ▸</xref>; Ayachit, 2015<xref rid="bb5" ref-type="bibr"> ▸</xref>), is planned for a future release.</p>
    </sec>
    <sec id="sec3.2">
      <label>3.2.</label>
      <title>Pre-processing</title>
      <sec id="sec3.2.1">
        <label>3.2.1.</label>
        <title>Noise removal</title>
        <p>Noise in the data is practically unavoidable, and it can either come from the lens, the environment or the diffraction of the sample. The first step of the pre-analysis, after defining the dimensions of a dataset (or second if we apply a region of interest to the data) is to detect and remove this noise from the sequence of images. <italic toggle="yes">darfix</italic> provides the following tools for noise removal.</p>
        <p><italic toggle="yes">Background subtraction.</italic> This is a widely used approach that calculates the foreground mask of an image by subtracting it from a background model containing the static part of an image sequence. In <italic toggle="yes">darfix</italic>, the background is an image that can either be calculated using the pixel-wise mean or the median of a set of data images (for example, dark images from the scan). This background image is then subtracted from each of the original images to obtain the foreground mask. While both mean and median subtractions can be used depending on the input dataset, the pixel-wise mean is less robust to outliers. On the other hand, the pixel-wise median is more computationally expensive when data are not in memory. In that last case, the user has two options:</p>
        <p>(i) Select chunks of a certain shape so that the median is computed consecutively in all of them. Although this method obtains a median of all the images, it is still time consuming as the input/output operations slow the process considerably.</p>
        <p>(ii) Only use a subgroup of the stack of images to calculate the median: the user inputs a step <italic toggle="yes">k</italic> value so that the algorithm selects the images with index <italic toggle="yes">i</italic>, <italic toggle="yes">i</italic> + <italic toggle="yes">k</italic>, <italic toggle="yes">i</italic> + 2<italic toggle="yes">k</italic>,….</p>
        <p><italic toggle="yes">Hot pixel removal.</italic> Sometimes, after performing background subtraction on the images, isolated groups of pixels appear at some or all of the images in the stack. These pixels are called ‘hot’ because they have higher intensity than the other pixels around them, and they are usually not part of the object we want to analyze but noise that needs to be treated. As the hot pixels are independent from one image to the other, this technique can be applied sequentially to the stack:</p>
        <p>(i) Apply a median filter to every image of the stack and subtract it from the original image.</p>
        <p>(ii) The hot pixels are identified as the ones with higher value than the standard deviation of this subtraction.</p>
        <p>(iii) The hot pixels intensity values are replaced by the values of their corresponding pixels in the image with the median filter applied.</p>
        <p><italic toggle="yes">Threshold removal.</italic> Pixels with values lower than specified will be set to 0.</p>
        <p>The use of any of these noise removal tools is optional.</p>
      </sec>
      <sec id="sec3.2.2">
        <label>3.2.2.</label>
        <title>Image registration</title>
        <p>Alignment errors in the experimental hardware frequently cause a shift of the image as a function of rotation angle. <italic toggle="yes">darfix</italic> contains a module for the detection and correction of such shifts. We assume that the shift is a linear function of rotation angle, <italic toggle="yes">i.e.</italic>
<bold>v</bold>(α) = α<bold>v</bold>
<sub>0</sub>, where α is the rotation angle relative to the scan center, and <bold>v</bold>
<sub>0</sub> is the displacement vector in pixels/degree. The algorithm used to find the shift, which has proven to give acceptable results in a considerably fast manner, is the following:</p>
        <p>(i) Two images are obtained from the sum over the images taken at the motor positions of the first and second half of the dataset, respectively.</p>
        <p>(ii) The shift vector <bold>v</bold>′ between the two resulting images is determined using the <italic toggle="yes">scikit-image</italic> (van der Walt <italic toggle="yes">et al.</italic>, 2014<xref rid="bb50" ref-type="bibr"> ▸</xref>) function ‘registration.phase_cross_correlation’.</p>
        <p>(iii) The linear shift is in the direction of the normalized shift: <bold>v</bold>
<sub>0</sub> = <italic toggle="yes">h</italic> 
<bold>v</bold>′/|<bold>v</bold>′|.</p>
        <p>(iv) The scaling factor <italic toggle="yes">h</italic> remains to be determined – it depends on how the intensity of the images varies as function of α:<disp-formula id="fdu1"><graphic xlink:href="s-30-00527-efd1.jpg" position="float"/></disp-formula>Once <bold>v</bold> has been determined, the images are shifted with subpixel accuracy using the Discrete Fourier Transform (DFT) algorithm. The library OpenCV (Bradski, 2000<xref rid="bb6" ref-type="bibr"> ▸</xref>) is used both for the affine transformations and for the DFT algorithm.</p>
        <p>One could use other strategies, <italic toggle="yes">e.g.</italic> a non-linear fit, to optimize <italic toggle="yes">h</italic>. In some cases, for example when summing the uncorrected images leads to blurring, better results are obtained when the shift correction is run several times.</p>
        <p>It is possible to find and apply the shift along a chosen dimension. In this case, a different shift is detected for every value of the chosen dimension. These shifts can then be applied to their corresponding images.</p>
      </sec>
    </sec>
    <sec id="sec3.3">
      <label>3.3.</label>
      <title>Scan analysis</title>
      <p>After pre-processing, data can be further analyzed according to the type of scan performed during the experiment, see above in Section 2.1<xref rid="sec2.1" ref-type="sec"/>.</p>
      <sec id="sec3.3.1">
        <label>3.3.1.</label>
        <title>Rocking curves fitting</title>
        <p>As described in Section 2.1.1<xref rid="sec2.1.1" ref-type="sec"/>, <italic toggle="yes">darfix</italic> provides a rocking curve analysis.</p>
        <p>The rocking curve imaging module provides functions similar to the <italic toggle="yes">RCIA</italic> code (Tran Thi <italic toggle="yes">et al.</italic>, 2017<xref rid="bb48" ref-type="bibr"> ▸</xref>) within the workflow of <italic toggle="yes">darfix</italic>. Its main function is to analyze the rocking curve of each pixel by fitting to a peak shape, <italic toggle="yes">e.g.</italic> a Gaussian.</p>
        <p>After the fit, maps of the fit parameters (constant background, integrated intensity, peak position and peak width) as a function of pixel position are generated (Tran Thi <italic toggle="yes">et al.</italic>, 2017<xref rid="bb48" ref-type="bibr"> ▸</xref>), as shown in Fig. 4<xref rid="fig4" ref-type="fig"> ▸</xref>.</p>
        <p>As a computationally less intensive alternative to fitting, moments of the intensity as a function of the angle can be computed. For an ideal Gaussian distribution, the zeroth-order moment corresponds to the integrated intensity, the first-order moment (center of mass) to the peak position, and the second-order moment (variance) to the square of the r.m.s. peak width. These can be used as starting values for the Gaussian fit. <italic toggle="yes">darfix</italic> also provides the third (skewness) and fourth (kurtosis) moments. The moments can also be presented as color maps.</p>
        <p>The intensity of a pixel, <italic toggle="yes">I</italic>
<sub>meas,<italic toggle="yes">xy</italic>
</sub> (where <italic toggle="yes">xy</italic> indicates pixel position), as a function of motor position, typically the rocking angle μ, is fitted to a Gaussian, <disp-formula id="fd1"><graphic xlink:href="s-30-00527-efd2.jpg" position="float"/></disp-formula>Fitting all pixels in this way results in maps of the background (<italic toggle="yes">b</italic>
<sub><italic toggle="yes">xy</italic></sub>), amplitude (<italic toggle="yes">A</italic>
<sub><italic toggle="yes">xy</italic></sub>), peak position (<italic toggle="yes">p</italic>
<sub><italic toggle="yes">xy</italic></sub>) and peak width [σ<sub><italic toggle="yes">xy</italic></sub>, full width at half-maximum (FWHM) = 2.355σ<sub><italic toggle="yes">xy</italic></sub>]. Furthermore, the fit generates a map of the χ<sup>2</sup> values, <disp-formula id="fd2"><graphic xlink:href="s-30-00527-efd3.jpg" position="float"/></disp-formula>that can be used to assess deviations from a simple Gaussian profile. Note that <inline-formula><inline-graphic xlink:href="s-30-00527-efi3.jpg"/></inline-formula> in this context <italic toggle="yes">is not</italic> the goniometer motor χ.</p>
        <p>For faster results, pixels with low intensities can be omitted from the fit.</p>
        <p>Two-dimensional scans, where, for example, two motors μ and χ are varied, can be fitted to a bivariate Gaussian, <disp-formula id="fd3"><graphic xlink:href="s-30-00527-efd4.jpg" position="float"/></disp-formula>Here, <italic toggle="yes">p</italic>
<sub>μ,<italic toggle="yes">xy</italic>
</sub> and σ<sub>μ,<italic toggle="yes">xy</italic>
</sub> are maps of the peak position and peak width of motor μ, <italic toggle="yes">p</italic>
<sub>χ,<italic toggle="yes">xy</italic>
</sub> and σ<sub>χ,<italic toggle="yes">xy</italic>
</sub> are maps of the peak position and peak width of motor χ, and ρ<sub><italic toggle="yes">xy</italic></sub> is the map of the Pearson correlation coefficient.</p>
        <p>Additional line shapes are planned for a future release.</p>
      </sec>
      <sec id="sec3.3.2">
        <label>3.3.2.</label>
        <title>Grainplot</title>
        <p>For scans where more than one motor varies, such as mosaicity (μ–χ scans), the <italic toggle="yes">Grainplot</italic> tool can calculate moments, <italic toggle="yes">e.g.</italic> the integrated intensity, center-of-mass and standard deviation. This analysis works similarly to rocking curve imaging; the dependence of the intensity on two rotation angles, the ‘rocking’ and ‘rolling’ angles, μ and χ, respectively, is analyzed for each pixel. In particular, for mosaicity scans, the center of mass (COM) of the two scan motors are interpreted as components of a 2D vector in the color plane. Both components can then be displayed in a single graph. Intensity contours in the corresponding color map represent a local pole figure of the volume of interest. The first-order moments (COM) correspond to the local orientation of the diffracting planes. Due to the narrow acceptance of the objective lens in the 2θ direction, the magnitude of the scattering vector remains constant (Poulsen <italic toggle="yes">et al.</italic>, 2017<xref rid="bb38" ref-type="bibr"> ▸</xref>) such that only shear strains and lattice rotations are measured (Poulsen <italic toggle="yes">et al.</italic>, 2021<xref rid="bb37" ref-type="bibr"> ▸</xref>). Again, the results can be represented in a color map, using a 2D color plane that encodes both rotation angles. Some examples are shown in Fig. 5<xref rid="fig5" ref-type="fig"> ▸</xref> (Section 4.4<xref rid="sec4.4" ref-type="sec"/>), where the COM color maps for μ [Fig. 5<xref rid="fig5" ref-type="fig"> ▸</xref>(<italic toggle="yes">a</italic>)] and χ [Fig. 5<xref rid="fig5" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>)] are shown.</p>
      </sec>
      <sec id="sec3.3.3">
        <label>3.3.3.</label>
        <title>Blind source separation</title>
        <p>Blind source separation (BSS) comprises all techniques that try to decouple a set of source signals from a set of mixed signals with unknown (or very little) information (Herault <italic toggle="yes">et al.</italic>, 1985<xref rid="bb18" ref-type="bibr"> ▸</xref>). Depending on the assumptions on the data, different BSS techniques can be used.</p>
        <p>In DFXM, diffracting elements such as (sub)grains or ferroelastic domains can be interpreted as source signals that contribute to the images. BSS can then be used to identify these elements and extract the corresponding rocking curves, reciprocal space maps, <italic toggle="yes">etc</italic>. in a given dataset.</p>
        <p>Specifically, we wish to reconstruct a matrix of observed signals (<bold>X</bold>) from a linear combination of unknown sources, encoded as rows in a matrix <bold>H</bold>, so that <bold>X</bold> ≃ <bold>WH</bold>. <bold>W</bold> is the so-called mixing matrix, and, in our case, we stack the flattened dataset images in rows to form the matrix <bold>X</bold>. These matrices are obtained by optimizing a distance given by a matrix norm (<italic toggle="yes">e.g.</italic> the Frobenius norm).</p>
        <p>The BSS techniques implemented in <italic toggle="yes">darfix</italic> are:</p>
        <p>(i) Principal Component Analysis (PCA). PCA is a BSS technique to recover a collection of orthogonal vectors <bold>H</bold>, called principal components, and perform a change of basis on the data which usually only uses the principal components that better reconstruct the data (in the <italic toggle="yes">L</italic>
<sub>2</sub>-norm sense).</p>
        <p>If the data are in memory, a PCA implementation based on Martinsson <italic toggle="yes">et al.</italic> (2011<xref rid="bb29" ref-type="bibr"> ▸</xref>) and Tipping &amp; Bishop (1999<xref rid="bb47" ref-type="bibr"> ▸</xref>) is included. Otherwise we use the incremental PCA model from Ross <italic toggle="yes">et al.</italic> (2008<xref rid="bb39" ref-type="bibr"> ▸</xref>). In both cases the <italic toggle="yes">scikit-learn</italic> implementation (Pedregosa <italic toggle="yes">et al.</italic>, 2011<xref rid="bb35" ref-type="bibr"> ▸</xref>) is used.</p>
        <p>As the principal components are orthogonal, they do not satisfy the non-negativity criterion for image intensity. Therefore, they cannot be interpreted as diffracting crystal elements.</p>
        <p>Nevertheless, the eigenvalues of the principal components are very useful to guess the number of true components present in the data. This number can then be used as input parameter for the other BSS methods described below.</p>
        <p>(ii) Non-negative Independent Component Analysis (NICA). Since the data are images of an intensity pattern we can impose the non-negativity of the sources as a constraint. NICA finds the components by assuming that they are non-Gaussian and statistically independent from each other [a technique known as independent component analysis, ICA (Hyvärinen <italic toggle="yes">et al.</italic>, 2001<xref rid="bb21" ref-type="bibr"> ▸</xref>)], while restricting <bold>H</bold> to be non-negative. The solution to this problem can be approached with several methods such as described by Yuan &amp; Oja (2004<xref rid="bb55" ref-type="bibr"> ▸</xref>) and Ouedraogo <italic toggle="yes">et al.</italic> (2010<xref rid="bb33" ref-type="bibr"> ▸</xref>). <italic toggle="yes">darfix</italic> implements the method described by Oja &amp; Plumbley (2004<xref rid="bb32" ref-type="bibr"> ▸</xref>). However, NICA does not require the mixing coefficients to be non-negative. Negative contributions of diffracting elements to the image intensity are non-physical.</p>
        <p>(iii) Non-negative Matrix Factorization (NMF). We can constrain both the sources and the mixing elements (<bold>H</bold> and <bold>W</bold>) to be non-negative. This constraint is called non-negative matrix factorization and is another widely used technique for solving BSS (Lee &amp; Seung, 1999<xref rid="bb26" ref-type="bibr"> ▸</xref>). <italic toggle="yes">darfix</italic> uses the implementation in <italic toggle="yes">scikit-learn</italic> to compute NMF when the data are in memory. Otherwise our own implementation is used based on the multiplicative update rule (Lee &amp; Seung, 2001<xref rid="bb27" ref-type="bibr"> ▸</xref>). This method is applied in chunks to avoid having all the data in memory.</p>
        <p>(iv) NICA–NMF. The non-uniqueness (non-convexity) property of NMF implies that the solution depends on the initial factor matrices. To solve this problem we implement the idea presented by Kitamura &amp; Ono (2016<xref rid="bb23" ref-type="bibr"> ▸</xref>) which suggests that a good initialization is based on the factorization given by non-negative ICA.</p>
        <p>A detailed example of the blind source separation techniques implemented in <italic toggle="yes">darfix</italic> is presented in Appendix <italic toggle="yes">A</italic>
<xref rid="appa" ref-type="app"/>.</p>
      </sec>
    </sec>
    <sec id="sec3.4">
      <label>3.4.</label>
      <title>GUI</title>
      <p>The GUI is programmed in <italic toggle="yes">Qt</italic> (The Qt Company, 2021<xref rid="bb46" ref-type="bibr"> ▸</xref>) and <italic toggle="yes">silx</italic> (Vincent <italic toggle="yes">et al.</italic>, 2021<xref rid="bb49" ref-type="bibr"> ▸</xref>) and it is structured to have a different widget for each step in the data processing workflow. Orange (Demšar &amp; Zupan, 2013<xref rid="bb13" ref-type="bibr"> ▸</xref>) is used to link all these widgets into a single workflow and to pass information between them. Every widget returns a new <inline-formula><inline-graphic xlink:href="s-30-00527-efi1.jpg"/></inline-formula> object which is the input to the next step of the workflow. Fig. 3<xref rid="fig3" ref-type="fig"> ▸</xref>(<italic toggle="yes">a</italic>) shows an example of a typical workflow comprising data selection, different pre-processing steps and shift correction. Figs. 3<xref rid="fig3" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>), 3(<italic toggle="yes">c</italic>) and 3(<italic toggle="yes">d</italic>) show examples of <italic toggle="yes">Grainplot</italic> of the intermediate and final results of the workflow (see below for details).</p>
    </sec>
    <sec id="sec3.5">
      <label>3.5.</label>
      <title>Open source, documentation and tutorials</title>
      <p><italic toggle="yes">darfix</italic> is open source under MIT license. The software can be installed using pip, see <ext-link xlink:href="https://pypi.org/project/darfix/" ext-link-type="uri">https://pypi.org/project/darfix/</ext-link>. User documentation can be found at <ext-link xlink:href="https://gitlab.esrf.fr/XRD/darfix/-/blob/main/doc/tutorials/darfix_guide.pdfhttps://gitlab.esrf.fr/XRD/darfix/-/blob/main/doc/tutorials/darfix_guide.pdf" ext-link-type="uri">https://gitlab.esrf.fr/XRD/darfix/-/blob/main/doc/tutorials/darfix_guide.pdfhttps://gitlab.esrf.fr/XRD/darfix/-/blob/main/doc/tutorials/darfix_guide.pdf</ext-link>.</p>
    </sec>
  </sec>
  <sec id="sec4">
    <label>4.</label>
    <title>Examples</title>
    <p>Fig. 3<xref rid="fig3" ref-type="fig"> ▸</xref>(<italic toggle="yes">a</italic>) shows an example of a typical workflow comprising data selection, different pre-processing steps, and shift correction. Figs. 3<xref rid="fig3" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>), 3(<italic toggle="yes">c</italic>) and 3(<italic toggle="yes">d</italic>) show examples, plotted as a <italic toggle="yes">Grainplot</italic> COM, of the intermediate and final results of the workflow (see below for details). The represented data correspond to a (200) reflection of a grain in an Fe–3%Si sample that was produced as explained by Mavrikakis <italic toggle="yes">et al.</italic> (2019<xref rid="bb30" ref-type="bibr"> ▸</xref>).</p>
    <sec id="sec4.1">
      <label>4.1.</label>
      <title>Data selection and dimension definition</title>
      <p>The first step of the workflow is to select the input data. Next, the dimensions are defined, <italic toggle="yes">i.e.</italic> the motor(s) varying during the scan and the number of points along each scan axis is determined (see Fig. 3<xref rid="fig3" ref-type="fig"> ▸</xref>). <italic toggle="yes">darfix</italic> will attempt an automatic dimension definition. This will result in the automatic identification of the scan motors, the angular ranges, the step size and the number of steps of a scan. In the current version, dimension definition is only available for data in EDF format, where motor positions are automatically extracted from the metadata. Data in HDF5 can be analyzed, but at present the metadata are not used. Afterwards, a region of interest can be defined in order to reduce the data volume and speed up processing.</p>
    </sec>
    <sec id="sec4.2">
      <label>4.2.</label>
      <title>Noise removal and shift correction</title>
      <p>Next, noise removal and shift correction, as detailed above, are applied. The effect of these steps on the data is illustrated in Fig. 3<xref rid="fig3" ref-type="fig"> ▸</xref>. Fig. 3<xref rid="fig3" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>) shows the raw data, followed by Fig. 3<xref rid="fig3" ref-type="fig"> ▸</xref>(<italic toggle="yes">c</italic>) where a threshold removal had been executed and Fig. 3<xref rid="fig3" ref-type="fig"> ▸</xref>(<italic toggle="yes">d</italic>) where hot pixel removal was also applied.</p>
    </sec>
    <sec id="sec4.3">
      <label>4.3.</label>
      <title>Rocking curve imaging</title>
      <p>The rocking curve widget performs the fit as described in Sections 2.1.1<xref rid="sec2.1.1" ref-type="sec"/> and 3.3.1<xref rid="sec3.3.1" ref-type="sec"/> at each pixel of the data obtained from a rocking scan. Moreover, <italic toggle="yes">darfix</italic> allows to input a 2D scan into the rocking curve widget and performs a 2D fit of the mosaicity data (where the moving motors correspond to angular motions in μ and χ).</p>
      <p>Fig. 4<xref rid="fig4" ref-type="fig"> ▸</xref> shows an example of the maps obtained from the rocking curve analysis of the (200) reflection of an Al sample (Dresselhaus-Marais <italic toggle="yes">et al.</italic>, 2021<italic toggle="yes">b</italic>
<xref rid="bb15" ref-type="bibr"> ▸</xref>), as well as the local rocking curve of a selected pixel. While Fig. 4<xref rid="fig4" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>) presents the image obtained at a certain μ, the fit maps Figs. 4<xref rid="fig4" ref-type="fig"> ▸</xref>(<italic toggle="yes">c</italic>)–4(<italic toggle="yes">g</italic>) provide information extracted from the fit of each pixel over the whole rocking curve. In this example it can be seen that the ‘boundaries’ between two regions that diffract at different μ angle are the hardest to fit, as shown by the residual (χ<sup>2</sup>) maps. These boundaries show larger FWHM possibly related to a slightly gradual change in orientation. The peak position map shows a constant gradient, that can be related to a homogeneous deformation of the crystal.</p>
    </sec>
    <sec id="sec4.4">
      <label>4.4.</label>
      <title>Mosaicity and strain scan</title>
      <p>Figure 5<xref rid="fig5" ref-type="fig"> ▸</xref> shows a mosaicity map obtained from the projection of a ferrite grain from an Fe–3%Si alloy (Mavrikakis <italic toggle="yes">et al.</italic>, 2019<xref rid="bb30" ref-type="bibr"> ▸</xref>), in this case the (200) reflection. Fig. 5<xref rid="fig5" ref-type="fig"> ▸</xref>(<italic toggle="yes">a</italic>) shows the peak position map of the pitch (rocking angle μ), whereas Fig. 5<xref rid="fig5" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>) shows the peak position in roll (angle χ). The two COM angles can be combined into a color vector [Fig. 5<xref rid="fig5" ref-type="fig"> ▸</xref>(<italic toggle="yes">c</italic>)]. This type of map represents the local crystallographic orientation around the chosen Bragg reflection. The contours in the color key [Fig. 5<xref rid="fig5" ref-type="fig"> ▸</xref>(<italic toggle="yes">d</italic>)] thus represent a local pole figure of the (200) reflection.</p>
      <p>Strain scans (varying μ and 2θ) can be analyzed in the same way. The interpretation, however, is different, as these scans measure the relative axial strain along a given crystallographic plane. In contrast to mosaicity scans where the lattice distortion and orientation are measured, strain scans provide information about the variation of the <italic toggle="yes">d</italic>-spacing of a given <italic toggle="yes">hkl</italic> plane of a crystal.</p>
    </sec>
    <sec id="sec4.5">
      <label>4.5.</label>
      <title>Blind source separation</title>
      <p>In Fig. 6<xref rid="fig6" ref-type="fig"> ▸</xref> the result of the blind source separation is shown for the rocking curve (μ) obtained for a single crystal of Al in a range of 0.2° for a (200) reflection. In Fig. 6<xref rid="fig6" ref-type="fig"> ▸</xref>(<italic toggle="yes">a</italic>) the components resulting from the separation are identified by different colors. Fig. 6<xref rid="fig6" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>) follows the same color code to show the rocking curves corresponding to each component. The blind source separation operation can be performed on 2D maps; the output can in that case also be plotted as a reciprocal space map for each component. Once the components are obtained they can be exported as HDF5 files.</p>
      <p><italic toggle="yes">darfix</italic> offers the possibility to link components from two different datasets. This allows tracing features from one layer to the next in multilayer scans or the evolution of features under different external conditions.</p>
    </sec>
  </sec>
  <sec id="sec5">
    <label>5.</label>
    <title>Future evolution</title>
    <p>Due to its modular structure, it is easy to extend <italic toggle="yes">darfix</italic> with additional functionalities and widgets, for example additional pre-processing tools such as gradient-based threshold removal for the detection of low-intensity features (Gonzalez <italic toggle="yes">et al.</italic>, 2020<xref rid="bb16" ref-type="bibr"> ▸</xref>).</p>
    <p>The functionalities implemented so far are relatively low-level. They mostly implement statistical methods and do not include analysis of the diffraction physics. This is an obvious field for future developments. In particular, we envisage implementing the transformation from angle-space to reciprocal-space, including the transformation of peak shifts in mosaicity and strain scans to strain components (Poulsen <italic toggle="yes">et al.</italic>, 2021<xref rid="bb37" ref-type="bibr"> ▸</xref>).</p>
    <p>Furthermore, modules could be developed for the identification of characteristic features in the sample, <italic toggle="yes">e.g.</italic> isolated dislocations (Jakobsen <italic toggle="yes">et al.</italic>, 2019<xref rid="bb22" ref-type="bibr"> ▸</xref>). Development is in progress for the automatic tracking of mobile dislocations in time sequences (Gonzalez <italic toggle="yes">et al.</italic>, 2020<xref rid="bb16" ref-type="bibr"> ▸</xref>). Bayesian inference methods can be used to improve the accuracy of the dislocation core position to ∼5 nm (Brennan <italic toggle="yes">et al.</italic>, 2022<xref rid="bb7" ref-type="bibr"> ▸</xref>). Due to the long range of strain fields from dislocations, these techniques are directly applicable to classical diffraction topography and rocking curve imaging.</p>
    <p>Fine intra-granular defect features of dislocation arrangements can be highlighted by plotting the local orientation gradient of the tilt angles μ and χ for neighboring voxels within each layer using the following relation: Δγ = [(Δμ)<sup>2</sup> + (Δχ)<sup>2</sup>]<sup>1/2</sup> (Mavrikakis <italic toggle="yes">et al.</italic>, 2019<xref rid="bb30" ref-type="bibr"> ▸</xref>; Ahl <italic toggle="yes">et al.</italic>, 2017<xref rid="bb2" ref-type="bibr"> ▸</xref>). Here, Δμ and Δχ are the differences between the local sample tilt COM and their grain averages. This is achieved by taking the spatial derivatives of the COM maps, providing information on the dislocation density (Pantleon, 2008<xref rid="bb34" ref-type="bibr"> ▸</xref>; Simons <italic toggle="yes">et al.</italic>, 2019<xref rid="bb43" ref-type="bibr"> ▸</xref>).</p>
    <p>Another field for future development is the transformation of a series of 2D scans into a 3D volume model of the sample. At present this is done manually for layer scans (Yildirim <italic toggle="yes">et al.</italic>, 2022<xref rid="bb54" ref-type="bibr"> ▸</xref>), but stacking and registration could be automated. An alternative measurement strategy would be topo-tomo scans (Ludwig <italic toggle="yes">et al.</italic>, 2009<xref rid="bb28" ref-type="bibr"> ▸</xref>), where projections are recorded while the sample is rotated about the scattering vector. Results should be saved in a format compatible with dedicated 3D analysis software such as <italic toggle="yes">Paraview</italic> (Ahrens <italic toggle="yes">et al.</italic>, 2005<xref rid="bb3" ref-type="bibr"> ▸</xref>; Ayachit, 2015<xref rid="bb5" ref-type="bibr"> ▸</xref>). Work for the 3D segmentation of dislocation networks is ongoing (Huang <italic toggle="yes">et al.</italic>, 2022<xref rid="bb20" ref-type="bibr"> ▸</xref>).</p>
  </sec>
  <sec sec-type="conclusions" id="sec6">
    <label>6.</label>
    <title>Conclusions</title>
    <p><italic toggle="yes">darfix</italic> is a Python package for the analysis of dark-field X-ray microscopy and diffraction topography data. It provides data processing and visualization tools that can be used either as library components or via a graphical user interface as an add-on to an Orange workflow. <italic toggle="yes">darfix</italic> includes analysis functions specific to common scan types used in DFXM, such as rocking curve imaging, mosaicity and strain scans.</p>
    <p>Through blind source separation, different diffracting elements present on the same map or rocking curve can be identified as distinct sources of diffraction, associating each separated unit with their corresponding rocking curve and reciprocal space map.</p>
  </sec>
</body>
<back>
  <ack>
    <p>We acknowledge the European Synchrotron Radiation Facility for provision of synchrotron radiation facilities and we would like to thank Thomas Dufrane for assistance in using beamline ID06-HXM. We thank Melanie Gauvin for providing the sample shown in Fig. 6<xref rid="fig6" ref-type="fig"> ▸</xref>. Leora Dresselhaus-Marais is acknowledged for providing the unpublished data shown in Fig. 4<xref rid="fig4" ref-type="fig"> ▸</xref> and critical reading of the manuscript. We thank Thu Nhi Tran Caliste for stimulating discussions on rocking curve imaging. Sonja R. Ahl and Hugh Simons contributed the original data analysis scripts for mosaicity maps that are now implemented in <italic toggle="yes">darfix</italic>.</p>
  </ack>
  <app-group>
    <app id="appa">
      <label>Appendix A </label>
      <title>Example for blind source separation</title>
      <p>In the framework of X-ray science, blind source separation has been used, for example, to identify and quantify the contribution of different elements to fluorescence spectra (Anitha <italic toggle="yes">et al.</italic>, 2013<xref rid="bb4" ref-type="bibr"> ▸</xref>), the components to account for variance in FTIR spectra (Cotte <italic toggle="yes">et al.</italic>, 2016<xref rid="bb11" ref-type="bibr"> ▸</xref>), and the contribution of different shells in EXAFS spectra (Wasserman <italic toggle="yes">et al.</italic>, 1999<xref rid="bb51" ref-type="bibr"> ▸</xref>). For dark-field X-ray microscopy, we assume that different crystalline domains such as grains of ferroelastic domains form independent sources with overlapping diffraction signals. They can be distinguished by their orientation, which will lead to different rocking curves that are shifted in mosaicity maps.</p>
      <p>As a simple example with known ground truth, we have simulated the rocking curve images of simple geometric forms as shown in Fig. 7<xref rid="fig7" ref-type="fig"> ▸</xref>. The resulting stack of images was then analyzed using the blind source separation functionality of <italic toggle="yes">darfix</italic>.</p>
      <p>The blind source separation methods available in <italic toggle="yes">darfix</italic> are, as explained in Section 3.3.3<xref rid="sec3.3.3" ref-type="sec"/>: PCA, NICA, NMF and a combined method NICA–NMF. While PCA provides an indication of how many sources to expect, it does not properly identify the sources (geometric shapes) as the PCA components are orthogonal (therefore necessarily include negative intensities), whereas the intensity contributions of the components are semi-definite positive (non-negative). The same property is true for fluorescent intensities. The attribution of negative values can be seen in the example figure (Fig. 7<xref rid="fig7" ref-type="fig"> ▸</xref>) as the negative values (white) that are found in three of the four components.</p>
      <p>Hence the non-negative independent component analysis (NICA) can be implemented, where the constraint for the sources (<bold>H</bold>) to be non-negative (as defined in Section 3.3.3<xref rid="sec3.3.3" ref-type="sec"/>) is imposed. (N)ICA identifies the sources by imposing the constraint that they are statistically independent (Hyvärinen <italic toggle="yes">et al.</italic>, 2001<xref rid="bb21" ref-type="bibr"> ▸</xref>).</p>
      <p>Alternatively, the non-negative matrix factorization (NMF) method, a parts-based representation, imposes the constraint of both the sources and the mixing coefficients (<italic toggle="yes">i.e.</italic> the contributions of the corresponding source to the final image intensities) to be non-negative. But this method yields non-unique solutions dependent on the initialization of the matrices. The combination of NICA–NMF solves the non-uniqueness issue for the NMF approach. The choice of BSS separation method is left to the user according to the goodness of the source identification for a given dataset.</p>
    </app>
  </app-group>
  <ref-list>
    <title>References</title>
    <ref id="bb1">
      <mixed-citation publication-type="other">Ahl, S., Simons, H., Detlefs, C., Jensen, D. J. &amp; Poulsen, H. F. (2020). <italic toggle="yes">Acta Mater.</italic>
<bold>185</bold>, 142–148.</mixed-citation>
    </ref>
    <ref id="bb2">
      <mixed-citation publication-type="other">Ahl, S., Simons, H., Zhang, Y., Detlefs, C., Stöhr, F., Jakobsen, A., Juul Jensen, D. &amp; Poulsen, H. (2017). <italic toggle="yes">Scr. Mater.</italic>
<bold>139</bold>, 87–91.</mixed-citation>
    </ref>
    <ref id="bb3">
      <mixed-citation publication-type="other">Ahrens, J., Geveci, B. &amp; Law, C. (2005). <italic toggle="yes">ParaView: An End-User Tool for Large Data Visualization, Visualization Handbook.</italic> Elsevier.</mixed-citation>
    </ref>
    <ref id="bb4">
      <mixed-citation publication-type="other">Anitha, A., Brasoveanu, A., Duarte, M., Hughes, S., Daubechies, I., Dik, J., Janssens, K. &amp; Alfeld, M. (2013). <italic toggle="yes">Signal Process.</italic>
<bold>93</bold>, 592–604.</mixed-citation>
    </ref>
    <ref id="bb5">
      <mixed-citation publication-type="other">Ayachit, U. (2015). <italic toggle="yes">The ParaView Guide: A Parallel Visualization Application.</italic> Kitware.</mixed-citation>
    </ref>
    <ref id="bb6">
      <mixed-citation publication-type="other">Bradski, G. (2000). <italic toggle="yes">Dr Dobb’s J.Software Tools</italic>, <bold>120</bold>, 122–125.</mixed-citation>
    </ref>
    <ref id="bb7">
      <mixed-citation publication-type="other">Brennan, M. C., Howard, M., Marzouk, Y. &amp; Dresselhaus-Marais, L. E. (2022). <italic toggle="yes">J. Mater. Sci.</italic>, <bold>57</bold>, 14890–14904.</mixed-citation>
    </ref>
    <ref id="bb8">
      <mixed-citation publication-type="other">Bucsek, A., Seiner, H., Simons, H., Yildirim, C., Cook, P., Chumlyakov, Y., Detlefs, C. &amp; Stebner, A. P. (2019). <italic toggle="yes">Acta Mater.</italic>
<bold>179</bold>, 273–286.</mixed-citation>
    </ref>
    <ref id="bb9">
      <mixed-citation publication-type="other">Collette, A. (2013). <italic toggle="yes">Python and HDF5.</italic> O’Reilly.</mixed-citation>
    </ref>
    <ref id="bb10">
      <mixed-citation publication-type="other">Cook, P. K., Simons, H., Jakobsen, A. C., Yildirim, C., Poulsen, H. F. &amp; Detlefs, C. (2018). <italic toggle="yes">Microsc. Microanal.</italic>
<bold>24</bold>, 88–89.</mixed-citation>
    </ref>
    <ref id="bb11">
      <mixed-citation publication-type="other">Cotte, M., Fabris, T., Agostini, G., Motta Meira, D., De Viguerie, L. &amp; Solé, V. A. (2016). <italic toggle="yes">Anal. Chem.</italic>
<bold>88</bold>, 6154–6160.</mixed-citation>
    </ref>
    <ref id="bb13">
      <mixed-citation publication-type="other">Demšar, J. &amp; Zupan, B. (2013). <italic toggle="yes">Informatica</italic>, <bold>37</bold>, 55–60.</mixed-citation>
    </ref>
    <ref id="bb12">
      <mixed-citation publication-type="other">De Nolf, W., Payno, H., Svensson, O. &amp; Koumoutsos, G. (2022). <italic toggle="yes">ewoks</italic>, https://doi.org/10.5281/zenodo.6075053.</mixed-citation>
    </ref>
    <ref id="bb15">
      <mixed-citation publication-type="other">Dresselhaus-Marais, L. E. <italic toggle="yes">et al.</italic> (2021<italic toggle="yes">b</italic>). Private communication.</mixed-citation>
    </ref>
    <ref id="bb14">
      <mixed-citation publication-type="other">Dresselhaus-Marais, L. E., Winther, G., Howard, M., Gonzalez, A., Breckling, S. R., Yildirim, C., Cook, P. K., Kutsal, M., Simons, H., Detlefs, C., Eggert, J. H. &amp; Poulsen, H. F. (2021<italic toggle="yes">a</italic>). <italic toggle="yes">Sci. Adv.</italic>
<bold>7</bold>, eabe8311.</mixed-citation>
    </ref>
    <ref id="bb16">
      <mixed-citation publication-type="other">Gonzalez, A., Howard, M., Breckling, S. &amp; Dresselhaus-Marais, L. E. (2020). <italic toggle="yes">arXiv</italic>: 2008.04972.</mixed-citation>
    </ref>
    <ref id="bb17">
      <mixed-citation publication-type="other">Gorfman, S., Spirito, D., Zhang, G., Detlefs, C. &amp; Zhang, N. (2022). <italic toggle="yes">Acta Cryst.</italic> A<bold>78</bold>, 158–171.</mixed-citation>
    </ref>
    <ref id="bb18">
      <mixed-citation publication-type="other">Herault, J., Jutten, C. &amp; Ans, B. (1985). <italic toggle="yes">10eme Colloque sur le traitement du signal et des images</italic>, 20–24 May 1985, Nice, France, pp. 1017–1022.</mixed-citation>
    </ref>
    <ref id="bb19">
      <mixed-citation publication-type="other">Hlushko, K., Keckes, J., Ressel, G., Pörnbacher, J., Ecker, W., Kutsal, M., Cook, P. K., Detlefs, C. &amp; Yildirim, C. (2020). <italic toggle="yes">Scr. Mater.</italic>
<bold>187</bold>, 402–406.</mixed-citation>
    </ref>
    <ref id="bb20">
      <mixed-citation publication-type="other">Huang, P.-H., Coffee, R. &amp; Dresselhaus-Marais, L. (2022). <italic toggle="yes">arXiv</italic>:2211.05247.</mixed-citation>
    </ref>
    <ref id="bb21">
      <mixed-citation publication-type="other">Hyvärinen, A., Karhunen, J. &amp; Oja, E. (2001). <italic toggle="yes">Independent Component Analysis.</italic> Wiley.</mixed-citation>
    </ref>
    <ref id="bb22">
      <mixed-citation publication-type="other">Jakobsen, A. C., Simons, H., Ludwig, W., Yildirim, C., Leemreize, H., Porz, L., Detlefs, C. &amp; Poulsen, H. F. (2019). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>52</bold>, 122–132.</mixed-citation>
    </ref>
    <ref id="bb23">
      <mixed-citation publication-type="other">Kitamura, D. &amp; Ono, N. (2016). <italic toggle="yes">2016 IEEE International Workshop on Acoustic Signal Enhancement (IWAENC)</italic>, 13–16 September 2016, Xi’am, China, pp. 1–5.</mixed-citation>
    </ref>
    <ref id="bb24">
      <mixed-citation publication-type="other">Könnecke, M., Akeroyd, F. A., Bernstein, H. J., Brewster, A. S., Campbell, S. I., Clausen, B., Cottrell, S., Hoffmann, J. U., Jemian, P. R., Männicke, D., Osborn, R., Peterson, P. F., Richter, T., Suzuki, J., Watts, B., Wintersberger, E. &amp; Wuttke, J. (2015). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>48</bold>, 301–305.</mixed-citation>
    </ref>
    <ref id="bb25">
      <mixed-citation publication-type="other">Kutsal, M., Bernard, P., Berruyer, G., Cook, P. K., Hino, R., Jakobsen, A. C., Ludwig, W., Ormstrup, J., Roth, T., Simons, H., Smets, K., Sierra, J. X., Wade, J., Wattecamps, P., Yildirim, C., Poulsen, H. F. &amp; Detlefs, C. (2019). <italic toggle="yes">Mater. Sci. Eng.</italic>
<bold>580</bold>, 012007.</mixed-citation>
    </ref>
    <ref id="bb26">
      <mixed-citation publication-type="other">Lee, D. &amp; Seung, H. (1999). <italic toggle="yes">Nature</italic>, <bold>401</bold>, 788–791.</mixed-citation>
    </ref>
    <ref id="bb27">
      <mixed-citation publication-type="other">Lee, D. &amp; Seung, H. S. (2001). In <italic toggle="yes">Advances in Neural Information Processing Systems</italic>, edited by T. Leen, T. Dietterich &amp; V. Tresp, Vol. 13. MIT Press.</mixed-citation>
    </ref>
    <ref id="bb28">
      <mixed-citation publication-type="other">Ludwig, W., King, A., Reischig, P., Herbig, M., Lauridsen, E., Schmidt, S., Proudhon, H., Forest, S., Cloetens, P., Roscoat, S. R., Buffière, J., Marrow, T. &amp; Poulsen, H. (2009). <italic toggle="yes">Mater. Sci. Eng. A</italic>, <bold>524</bold>, 69–76.</mixed-citation>
    </ref>
    <ref id="bb29">
      <mixed-citation publication-type="other">Martinsson, P.-G., Rokhlin, V. &amp; Tygert, M. (2011). <italic toggle="yes">Appl. Comput. Harmon. Anal.</italic>
<bold>30</bold>, 47–68.</mixed-citation>
    </ref>
    <ref id="bb30">
      <mixed-citation publication-type="other">Mavrikakis, N., Detlefs, C., Cook, P., Kutsal, M., Campos, A., Gauvin, M., Calvillo, P., Saikaly, W., Hubert, R., Poulsen, H., Vaugeois, A., Zapolsky, H., Mangelinck, D., Dumont, M. &amp; Yildirim, C. (2019). <italic toggle="yes">Acta Mater.</italic>
<bold>174</bold>, 92–104.</mixed-citation>
    </ref>
    <ref id="bb40">
      <mixed-citation publication-type="other">Morones, J. R., Elechiguerra, J. L., Camacho, A., Holt, K., Kouri, J. B., Ramírez, J. T. &amp; Yacaman, M. J. (2005). <italic toggle="yes">Nanotechnology</italic>, <bold>16</bold>, 2346–2353.</mixed-citation>
    </ref>
    <ref id="bb31">
      <mixed-citation publication-type="other">Nellist, P. D. <bold>&amp;</bold> and Pennycook, S. (2000). <italic toggle="yes">Advances in Imaging and Electron Physics.</italic> Springer.</mixed-citation>
    </ref>
    <ref id="bb32">
      <mixed-citation publication-type="other">Oja, E. &amp; Plumbley, M. (2004). <italic toggle="yes">Neural Comput.</italic>
<bold>16</bold>, 1811–1825.</mixed-citation>
    </ref>
    <ref id="bb33">
      <mixed-citation publication-type="other">Ouedraogo, W. S. B., Souloumiac, A. &amp; Jutten, C. (2010). <italic toggle="yes">Latent Variable Analysis and Signal Separation</italic>, edited by V. Vigneron, V. Zarzoso, E. Moreau, R. Gribonval &amp; E. Vincent, pp. 522–529. Berlin, Heidelberg: Springer.</mixed-citation>
    </ref>
    <ref id="bb34">
      <mixed-citation publication-type="other">Pantleon, W. (2008). <italic toggle="yes">Scr. Mater.</italic>
<bold>58</bold>, 994–997.</mixed-citation>
    </ref>
    <ref id="bb35">
      <mixed-citation publication-type="other">Pedregosa, F., Varoquaux, G., Gramfort, A., Michel, V., Thirion, B., Grisel, O., Blondel, M., Prettenhofer, P., Weiss, R., Dubourg, V., Vanderplas, J., Passos, A., Cournapeau, D., Brucher, M., Perrot, M. &amp; Duchesnay, E. (2011). <italic toggle="yes">J. Mach. Learn. Res.</italic>
<bold>12</bold>, 2825–2830.</mixed-citation>
    </ref>
    <ref id="bb36">
      <mixed-citation publication-type="other">Poulsen, H. F. (2020). <italic toggle="yes">Curr. Opin. Solid State Mater. Sci.</italic>
<bold>24</bold>, 100820.</mixed-citation>
    </ref>
    <ref id="bb37">
      <mixed-citation publication-type="other">Poulsen, H. F., Dresselhaus-Marais, L. E., Carlsen, M. A., Detlefs, C. &amp; Winther, G. (2021). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>54</bold>, 1555–1571.</mixed-citation>
    </ref>
    <ref id="bb38">
      <mixed-citation publication-type="other">Poulsen, H. F., Jakobsen, A. C., Simons, H., Ahl, S. R., Cook, P. K. &amp; Detlefs, C. (2017). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>50</bold>, 1441–1456.</mixed-citation>
    </ref>
    <ref id="bb39">
      <mixed-citation publication-type="other">Ross, D., Lim, J., Lin, R.-S. &amp; Yang, M.-H. (2008). <italic toggle="yes">Int. J. Comput. Vis.</italic>
<bold>77</bold>, 125–141.</mixed-citation>
    </ref>
    <ref id="bb41">
      <mixed-citation publication-type="other">Schoeppler, V., Cook, P. K., Detlefs, C., Demichelis, R. &amp; Zlotnikov, I. (2022). <italic toggle="yes">Adv. Mater.</italic>
<bold>34</bold>, 2200690.</mixed-citation>
    </ref>
    <ref id="bb42">
      <mixed-citation publication-type="other">Simons, H., Haugen, A. B., Jakobsen, A. C., Schmidt, S., Stöhr, F., Majkut, M., Detlefs, C., Daniels, J. E., Damjanovic, D. &amp; Poulsen, H. F. (2018). <italic toggle="yes">Nat. Mater.</italic>
<bold>17</bold>, 814–819.</mixed-citation>
    </ref>
    <ref id="bb43">
      <mixed-citation publication-type="other">Simons, H., Jakobsen, A. C., Ahl, S. R., Poulsen, H. F., Pantleon, W., Chu, Y.-H., Detlefs, C. &amp; Valanoor, N. (2019). <italic toggle="yes">Nano Lett.</italic>
<bold>19</bold>, 1445–1450.</mixed-citation>
    </ref>
    <ref id="bb44">
      <mixed-citation publication-type="other">Simons, H., King, A., Ludwig, W., Detlefs, C., Pantleon, W., Schmidt, S., Stöhr, F., Snigireva, I., Snigirev, A. &amp; Poulsen, H. F. (2015). <italic toggle="yes">Nat. Commun.</italic>
<bold>6</bold>, 6098.</mixed-citation>
    </ref>
    <ref id="bb45">
      <mixed-citation publication-type="other">The HDF Group, (1997–2022). <italic toggle="yes">Hierarchical Data Format</italic>, version 5, https://www.hdfgroup.org/HDF5/.</mixed-citation>
    </ref>
    <ref id="bb46">
      <mixed-citation publication-type="other">The Qt Company, (2021). <italic toggle="yes">Qt</italic>, https://www.qt.io.</mixed-citation>
    </ref>
    <ref id="bb47">
      <mixed-citation publication-type="other">Tipping, M. E. &amp; Bishop, C. M. (1999). <italic toggle="yes">Neural Comput.</italic>
<bold>11</bold>, 443–482.</mixed-citation>
    </ref>
    <ref id="bb48">
      <mixed-citation publication-type="other">Tran Thi, T. N., Morse, J., Caliste, D., Fernandez, B., Eon, D., Härtwig, J., Barbay, C., Mer-Calfati, C., Tranchant, N., Arnault, J. C., Lafford, T. A. &amp; Baruchel, J. (2017). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>50</bold>, 561–569.</mixed-citation>
    </ref>
    <ref id="bb49">
      <mixed-citation publication-type="other">Vincent, T., Valls, V., Payno, H., Kieffer, J., Solé, V. A., Paleo, P., De Nolf, W., Knobel, P. &amp; Garriga, J. (2021). <italic toggle="yes">silx-kit/silx: 1.0.0</italic>, https://www.silx.org/. (Accessed 2021/12/06).</mixed-citation>
    </ref>
    <ref id="bb50">
      <mixed-citation publication-type="other">Walt, S. van der, Schönberger, J. L., Nunez-Iglesias, J., Boulogne, F., Warner, J. D., Yager, N., Gouillart, E., Yu, T. &amp; the scikit-image contributors (2014). <italic toggle="yes">PeerJ</italic>, <bold> 2</bold>, e453.</mixed-citation>
    </ref>
    <ref id="bb51">
      <mixed-citation publication-type="other">Wasserman, S. R., Allen, P. G., Shuh, D. K., Bucher, J. J. &amp; Edelstein, N. M. (1999). <italic toggle="yes">J. Synchrotron Rad.</italic>
<bold>6</bold>, 284–286.</mixed-citation>
    </ref>
    <ref id="bb52">
      <mixed-citation publication-type="other">Williams, D. &amp; Carter, C. (1996). <italic toggle="yes">Transmission Electron Microscopy.</italic> Plenum Press.</mixed-citation>
    </ref>
    <ref id="bb53">
      <mixed-citation publication-type="other">Yildirim, C., Cook, P., Detlefs, C., Simons, H. &amp; Poulsen, H. F. (2020). <italic toggle="yes">MRS Bull.</italic>
<bold>45</bold>, 277–282.</mixed-citation>
    </ref>
    <ref id="bb54">
      <mixed-citation publication-type="other">Yildirim, C., Poulsen, H., Winther, G., Detlefs, C., Huang, P.-H. &amp; Dresselhaus-Marais, L. E. (2022). <italic toggle="yes">Sci. Rep.</italic>
<bold>13</bold>, 3834.</mixed-citation>
    </ref>
    <ref id="bb55">
      <mixed-citation publication-type="other">Yuan, Z. &amp; Oja, E. (2004). <italic toggle="yes">International Conference on Independent Component Analysis and Signal Separation ICA 2004: Independent Component Analysis and Blind Signal Separation</italic>, Vol. 3195 of <italic toggle="yes">Lecture Notes in Computer Science</italic>, pp. 1–8. Berlin, Heidelberg: Springer.</mixed-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig position="float" id="fig1">
    <label>Figure 1</label>
    <caption>
      <p>Geometry of the dark-field X-ray microscope at ID06-HXM at the ESRF. The incident beam <bold>k</bold>
<sub>0</sub> travels along the laboratory <italic toggle="yes">x</italic>
<sub><italic toggle="yes">l</italic></sub> axis. The optical axis of the objective lens is aligned to the direction of the diffracted beam <bold>k</bold>
<sub>d</sub>. The pivot point of the goniometer and sample is coincident with the intersection of these two optical axes. Vector <bold>Q</bold> defines the local scattering vector at a given point <bold>r</bold>(<italic toggle="yes">x</italic>, <italic toggle="yes">y</italic>, <italic toggle="yes">z</italic>) within the sample, and may be parameterized by the scattering angle 2θ, the azimuthal angle η and the length of the vector |<bold>Q</bold>|. The value of |<bold>Q</bold>| is related to the spacing of the lattice plane being measured, <italic toggle="yes">d</italic>
<sub><italic toggle="yes">hkl</italic></sub>, and the X-ray wavelength, λ, by Bragg’s law. The goniometer is associated with a base tilt, μ, an ω-rotation around <bold>Q</bold> and two tilts, χ and ϕ. <italic toggle="yes">d</italic>
<sub>1</sub> is the distance from the sample to the entry point of the objective and <italic toggle="yes">d</italic>
<sub>2</sub> is the distance from the exit point of the objective to the detector. The positive directions of the angles are indicated. This figure is adapted from Poulsen <italic toggle="yes">et al.</italic> (2021<xref rid="bb37" ref-type="bibr"> ▸</xref>).</p>
    </caption>
    <graphic xlink:href="s-30-00527-fig1" position="float"/>
  </fig>
  <fig position="float" id="fig2">
    <label>Figure 2</label>
    <caption>
      <p><italic toggle="yes">darfix</italic> GUI where a full workflow is shown. The three main modules – selection of data, pre-processing, and analysis and visualization – are indicated by brackets. A description of each widget’s functionalities is given in the lablels.</p>
    </caption>
    <graphic xlink:href="s-30-00527-fig2" position="float"/>
  </fig>
  <fig position="float" id="fig3">
    <label>Figure 3</label>
    <caption>
      <p>(<italic toggle="yes">a</italic>) <italic toggle="yes">darfix</italic> GUI where a data preprocessing thread is shown, finalized by the <italic toggle="yes">Grainplot</italic> widget. (<italic toggle="yes">b</italic>) Raw data plotted as COM. (<italic toggle="yes">c</italic>) After background removal and threshold removal. (<italic toggle="yes">d</italic>) After hot pixel removal and shift correction. The color bars represent scattering angles (2θ).</p>
    </caption>
    <graphic xlink:href="s-30-00527-fig3" position="float"/>
  </fig>
  <fig position="float" id="fig4">
    <label>Figure 4</label>
    <caption>
      <p>Example of 1D rocking curve analysis. (<italic toggle="yes">a</italic>) Fit of the curve corresponding to the pixel indicated in (<italic toggle="yes">b</italic>). (<italic toggle="yes">b</italic>) Image at μ = −0.005° with a cross marking the pixel of interest. Maps of the full stack of images composing the rocking scan, generated by the pixel by pixel fit, of (<italic toggle="yes">c</italic>) amplitude, (<italic toggle="yes">d</italic>) background, (<italic toggle="yes">e</italic>) full width at half-maximum, (<italic toggle="yes">f</italic>) peak position and (<italic toggle="yes">g</italic>) residuals.</p>
    </caption>
    <graphic xlink:href="s-30-00527-fig4" position="float"/>
  </fig>
  <fig position="float" id="fig5">
    <label>Figure 5</label>
    <caption>
      <p>Center of mass maps for (<italic toggle="yes">a</italic>) μ and (<italic toggle="yes">b</italic>) χ, showing the relative motor values in angles. (<italic toggle="yes">c</italic>) Mosaicity map and (<italic toggle="yes">d</italic>) orientation distribution color key of the mosaicity map with an overlaid contour map of the integrated intensity, portraying the centered orientation distribution, indicating the angular spread for μ and χ.</p>
    </caption>
    <graphic xlink:href="s-30-00527-fig5" position="float"/>
  </fig>
  <fig position="float" id="fig6">
    <label>Figure 6</label>
    <caption>
      <p>Example of blind source separation obtained from a 1D rocking scan of a (200) reflection of an Al single crystal (Dresselhaus-Marais <italic toggle="yes">et al.</italic>, 2021<italic toggle="yes">b</italic>
<xref rid="bb15" ref-type="bibr"> ▸</xref>). (<italic toggle="yes">a</italic>) Rocking curve image of 0.2° in μ. Colored regions correspond to blind source separated components as shown in the rocking curves (<italic toggle="yes">b</italic>) for each independent component.</p>
    </caption>
    <graphic xlink:href="s-30-00527-fig6" position="float"/>
  </fig>
  <fig position="float" id="fig7">
    <label>Figure 7</label>
    <caption>
      <p>Example of blind source separation. Each column corresponds to a BSS method: PCA, NICA, NMF, NICA–NMF. The found components are shown for each method.</p>
    </caption>
    <graphic xlink:href="s-30-00527-fig7" position="float"/>
  </fig>
</floats-group>
