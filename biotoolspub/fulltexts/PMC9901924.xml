<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.1 20151215//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.1?>
<?ConverterInfo.XSLTName jats2jats3.xsl?>
<?ConverterInfo.Version 1?>
<?properties open_access?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">J Appl Crystallogr</journal-id>
    <journal-id journal-id-type="iso-abbrev">J Appl Crystallogr</journal-id>
    <journal-id journal-id-type="publisher-id">J. Appl. Cryst.</journal-id>
    <journal-title-group>
      <journal-title>Journal of Applied Crystallography</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">0021-8898</issn>
    <issn pub-type="epub">1600-5767</issn>
    <publisher>
      <publisher-name>International Union of Crystallography</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">9901924</article-id>
    <article-id pub-id-type="publisher-id">nb5332</article-id>
    <article-id pub-id-type="doi">10.1107/S1600576722011001</article-id>
    <article-id pub-id-type="coden">JACGAR</article-id>
    <article-id pub-id-type="pii">S1600576722011001</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Computer Programs</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title><italic toggle="yes">xrd_simulator</italic>: 3D X-ray diffraction simulation software supporting 3D polycrystalline microstructure morphology descriptions</article-title>
      <alt-title><italic toggle="yes">xrd_simulator</italic>: 3D X-ray diffraction simulation software</alt-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Henningsson</surname>
          <given-names>Axel</given-names>
        </name>
        <xref rid="a" ref-type="aff">a</xref>
        <xref rid="cor" ref-type="corresp">*</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Hall</surname>
          <given-names>Stephen A.</given-names>
        </name>
        <xref rid="a" ref-type="aff">a</xref>
      </contrib>
      <aff id="a"><label>a</label>Div. Solid Mechanics, <institution>Lund University</institution>, Ole Römers väg 1, Lund, <country>Sweden</country></aff>
    </contrib-group>
    <contrib-group>
      <contrib contrib-type="editor">
        <name>
          <surname>Borbély</surname>
          <given-names>A.</given-names>
        </name>
        <role>Editor</role>
      </contrib>
      <aff>Ecole National Supérieure des Mines, Saint-Etienne, <country>France</country>
</aff>
    </contrib-group>
    <author-notes>
      <corresp id="cor">Correspondence e-mail: <email>axel.henningsson@solid.lth.se</email>
</corresp>
    </author-notes>
    <pub-date pub-type="collection">
      <day>01</day>
      <month>2</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>01</day>
      <month>2</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>01</day>
      <month>2</month>
      <year>2023</year>
    </pub-date>
    <!--PMC Release delay is 0 months and 0 days and was based on the <pub-date pub-type="epub"/>.-->
    <volume>56</volume>
    <issue>Pt 1</issue>
    <issue-id pub-id-type="publisher-id">j230100</issue-id>
    <fpage>282</fpage>
    <lpage>292</lpage>
    <history>
      <date date-type="received">
        <day>14</day>
        <month>6</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>16</day>
        <month>11</month>
        <year>2022</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© Henningsson and Hall 2023</copyright-statement>
      <copyright-year>2023</copyright-year>
      <license>
        <ali:license_ref xmlns:ali="http://www.niso.org/schemas/ali/1.0/" specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p>This is an open-access article distributed under the terms of the Creative Commons Attribution (CC-BY) Licence, which permits unrestricted use, distribution, and reproduction in any medium, provided the original authors and source are cited.</license-p>
      </license>
      <ali:free_to_read xmlns:ali="http://www.niso.org/schemas/ali/1.0/"/>
    </permissions>
    <self-uri xlink:href="https://doi.org/10.1107/S1600576722011001">A full version of this article is available from Crystallography Journals Online.</self-uri>
    <abstract abstract-type="toc">
      <p>An open source Python package named <italic toggle="yes">xrd_simulator</italic>, developed to address the need for 3D microstructure morphology simulation in 3DXRD-type experiments, is described and demonstrated.</p>
    </abstract>
    <abstract>
      <p>An open source Python package named <italic toggle="yes">xrd_simulator</italic>, capable of simulating geometrical interactions between a monochromatic X-ray beam and a polycrystalline microstructure, is described and demonstrated. The software can simulate arbitrary intragranular lattice variations of single crystals embedded within a multiphase 3D aggregate by making use of a tetrahedral mesh representation where each element holds an independent lattice. By approximating the X-ray beam as an arbitrary convex polyhedral region in space and letting the sample be moved continuously through arbitrary rigid motions, data from standard and non-standard measurement sequences can be simulated. This implementation is made possible through analytical solutions to a modified, time-dependent version of the Laue equations. The software, which primarily targets three-dimensional X-ray diffraction microscopy (high-energy X-ray diffraction microscopy) type experiments, enables the numerical exploration of which sample quantities can and cannot be reconstructed for a given acquisition scheme. Similarly, <italic toggle="yes">xrd_simulator</italic> targets investigations of different measurement sequences in relation to optimizing both experimental run times and sampling.</p>
    </abstract>
    <kwd-group>
      <kwd>X-ray diffraction</kwd>
      <kwd>3DXRD</kwd>
      <kwd>simulation tools</kwd>
      <kwd>polycrystalline microstructure</kwd>
      <kwd>computer programs</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>Vetenskapsrådet</funding-source>
        <award-id>2017-06719</award-id>
      </award-group>
      <funding-statement>Funding for this research was provided by Vetenskapsrådet (grant No. 2017-06719).</funding-statement>
    </funding-group>
    <counts>
      <page-count count="11"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec sec-type="introduction" id="sec1">
    <label>1.</label>
    <title>Introduction</title>
    <p>Three-dimensional X-ray diffraction (3DXRD) covers a class of experimental techniques that facilitate the nondestructive study of polycrystalline materials on an inter- and intra-granular level. In its original form, 3DXRD, which is sometimes referred to as high-energy X-ray diffraction microscopy (HEDM) (Bernier <italic toggle="yes">et al.</italic>, 2020<xref rid="bb6" ref-type="bibr"> ▸</xref>), was pioneered by Poulsen (2004<xref rid="bb33" ref-type="bibr"> ▸</xref>) and co workers. The data for 3DXRD are acquired using monochromatic, parallel, hard X-ray beams (10–100 keV) and a 2D area detector that integrates the diffraction signal from a rotating polycrystalline sample. The samples typically studied using 3DXRD, in contrast to those studied with powder diffraction techniques, are polycrystals with a limited number of grains, allowing individual diffraction peaks to be resolved on the 2D detector image. The recorded diffraction peaks can be analysed using a plethora of methods to reconstruct, among other things, grain orientations (Lauridsen <italic toggle="yes">et al.</italic>, 2001<xref rid="bb23" ref-type="bibr"> ▸</xref>; Sharma <italic toggle="yes">et al.</italic>, 2012<italic toggle="yes">a</italic>
<xref rid="bb38" ref-type="bibr"> ▸</xref>,<italic toggle="yes">b</italic>
<xref rid="bb39" ref-type="bibr"> ▸</xref>), grain topology (Poulsen &amp; Schmidt, 2003<xref rid="bb36" ref-type="bibr"> ▸</xref>; Poulsen &amp; Fu, 2003<xref rid="bb35" ref-type="bibr"> ▸</xref>; Alpers <italic toggle="yes">et al.</italic>, 2006<xref rid="bb1" ref-type="bibr"> ▸</xref>; Batenburg <italic toggle="yes">et al.</italic>, 2010<xref rid="bb4" ref-type="bibr"> ▸</xref>), and grain strain or stress tensors (Oddershede <italic toggle="yes">et al.</italic>, 2010<xref rid="bb31" ref-type="bibr"> ▸</xref>). The beam cross section and angular step size in 3DXRD must be selected such that a limited number of grains are illuminated during detector readout, limiting spot overlap and revealing the individual diffraction peaks from grains within the aggregate in the 2D detector images. 3DXRD geometries using a narrow beam cross section, smaller than the grain diameter, are often referred to as scanning-3DXRD (Hayashi <italic toggle="yes">et al.</italic>, 2015<xref rid="bb12" ref-type="bibr"> ▸</xref>). These methods allow for the study of intragranular effects (Hayashi <italic toggle="yes">et al.</italic>, 2017<xref rid="bb13" ref-type="bibr"> ▸</xref>; Hektor <italic toggle="yes">et al.</italic>, 2019<xref rid="bb14" ref-type="bibr"> ▸</xref>; Henningsson <italic toggle="yes">et al.</italic>, 2020<xref rid="bb16" ref-type="bibr"> ▸</xref>) at the cost of having to scan the sample across the narrow beam to collect the full diffraction signal. Another branch of 3DXRD is diffraction contrast tomography (DCT) (Ludwig <italic toggle="yes">et al.</italic>, 2009<xref rid="bb26" ref-type="bibr"> ▸</xref>), where the detector is placed close to the sample such that the projection of individual grain shapes can be seen in the recorded diffraction image. Using iterative reconstruction methods [<italic toggle="yes">e.g.</italic> Reischig &amp; Ludwig (2020<xref rid="bb37" ref-type="bibr"> ▸</xref>)] in conjunction with DCT methods, excellent resolution of the grain shapes can be achieved at the cost of strain resolution (Nervo <italic toggle="yes">et al.</italic>, 2014<xref rid="bb29" ref-type="bibr"> ▸</xref>). For an in-depth summary of the state of the art in hard X-ray microscopy see Poulsen (2020<xref rid="bb34" ref-type="bibr"> ▸</xref>).</p>
    <p>In all of the aforementioned 3DXRD methods, to reconstruct the sample it is necessary to model the sample on a granular or even intragranular level, which stands in contrast to powder-like diffraction experiments where the sample is treated as a continuum. To produce a diffraction pattern of sufficient quality to reconstruct the desired sample details requires selection of experimental parameters such as sample rotation axis, sample translations, X-ray beam shape, detector geometry and sample rotation sequence adapted to the position, shape, orientation and strain of the individual crystals within the polycrystalline aggregate to be studied. The interactions between these acquisition and sample characteristics regulate the quality/resolution of the reconstructions of the sample microstructure as well as the total acquisition times, which can become unrealistically long. The question as to how measurements should be acquired and how many acquisitions are needed to recover a target quantity in a polycrystal are, thus, key in the field of 3DXRD. For instance, by analytical means, Lionheart &amp; Withers (2015<xref rid="bb25" ref-type="bibr"> ▸</xref>) showed that the full strain tensor could be recovered using direct methods if the diffracting sample was allowed to rotate consecutively around three orthogonal axes. On the other hand, using mechanical constraints, it was found that strain reconstructions could be achieved from single axis rotation data (Henningsson &amp; Hendriks, 2021<xref rid="bb15" ref-type="bibr"> ▸</xref>). On another note, recent advances in acquisition strategies for laboratory-based DCT (Oddershede <italic toggle="yes">et al.</italic>, 2022<xref rid="bb30" ref-type="bibr"> ▸</xref>) suggest that more complex scan geometries could be used to improve sampling in 3DXRD experiments. From a practical point of view, considering scanning 3DXRD, the typical wall times to measure a single sample volume are often in the range of hours or even days [<italic toggle="yes">e.g.</italic> Hektor <italic toggle="yes">et al.</italic> (2019<xref rid="bb14" ref-type="bibr"> ▸</xref>)], making efficient measurement schemes that can reduce the amount of data that need to be collected attractive.</p>
    <p>As 3DXRD is a high-energy synchrotron technique, access to experiments is precious and the number of facilities in the world that offer 3DXRD controls the pace of the method development. An alternative route for development is the use of software simulation tools that can serve as a research primer, allowing ideas to be established or discarded at a theoretical stage. Many tools for simulating X-ray diffraction from individual crystals exist [<italic toggle="yes">e.g.</italic> Macrae <italic toggle="yes">et al.</italic> (2006<xref rid="bb27" ref-type="bibr"> ▸</xref>), Momma &amp; Izumi (2008<xref rid="bb28" ref-type="bibr"> ▸</xref>), Soyer (1996<xref rid="bb42" ref-type="bibr"> ▸</xref>), Campbell (1995<xref rid="bb7" ref-type="bibr"> ▸</xref>), Huang (2010<xref rid="bb19" ref-type="bibr"> ▸</xref>), Kanagasabapathy (2016<xref rid="bb20" ref-type="bibr"> ▸</xref>), Weber (1997<xref rid="bb44" ref-type="bibr"> ▸</xref>) and Laugier &amp; Bochu (2001<xref rid="bb22" ref-type="bibr"> ▸</xref>)]. Additional tools exist for simulating 2D diffraction patterns from arbitrarily textured samples (Poulsen, 2004<xref rid="bb33" ref-type="bibr"> ▸</xref>; Le Page &amp; Gabe, 1979<xref rid="bb24" ref-type="bibr"> ▸</xref>; E <italic toggle="yes">et al.</italic>, 2018<xref rid="bb9" ref-type="bibr"> ▸</xref>; Huang <italic toggle="yes">et al.</italic>, 2021<italic toggle="yes">a</italic>
<xref rid="bb17" ref-type="bibr"> ▸</xref>,<italic toggle="yes">b</italic>
<xref rid="bb18" ref-type="bibr"> ▸</xref>; Knudsen, 2009<xref rid="bb21" ref-type="bibr"> ▸</xref>; Bernier <italic toggle="yes">et al.</italic>, 2011<xref rid="bb5" ref-type="bibr"> ▸</xref>; Pagan <italic toggle="yes">et al.</italic>, 2020<xref rid="bb32" ref-type="bibr"> ▸</xref>; Fang <italic toggle="yes">et al.</italic>, 2020<xref rid="bb10" ref-type="bibr"> ▸</xref>; Sørensen <italic toggle="yes">et al.</italic>, 2012<xref rid="bb41" ref-type="bibr"> ▸</xref>). However, for many questions related to 3DXRD techniques, the geometry of the polycrystal grains and the X-ray beam, together with intragranular lattice variations, must be accounted for. At the same time, the diffracting sample must be allowed to move along an arbitrary rigid body motion path, to explore different scan sequences.</p>
    <p>Frameworks similar to those developed by Wong <italic toggle="yes">et al.</italic> (2013<xref rid="bb45" ref-type="bibr"> ▸</xref>) and Song <italic toggle="yes">et al.</italic> (2008<xref rid="bb40" ref-type="bibr"> ▸</xref>) provide important contributions in this direction, incorporating a spatial description of the sample microstructure by making use of a tetrahedral mesh representation. However, this previous work was limited to full-field illumination and sample motions derived from rotations about a fixed axis. Finite beam sizes, illuminating a subvolume of the samples during diffraction, is especially important to simulate scanning 3DXRD were the beam cross section is smaller than the sample.</p>
    <p>In conclusion, no open source software exists with the set of capabilities needed to freely explore acquisition strategies in 3DXRD [see supplementary material of Huang <italic toggle="yes">et al.</italic> (2021<italic toggle="yes">b</italic>
<xref rid="bb18" ref-type="bibr"> ▸</xref>) for a useful summary of existing software capabilities].</p>
    <p>We report on the development of new software, named <italic toggle="yes">xrd_simulator</italic>, that draws on concepts described by Fang <italic toggle="yes">et al.</italic> (2020<xref rid="bb10" ref-type="bibr"> ▸</xref>) and extends the work of Wong <italic toggle="yes">et al.</italic> (2013<xref rid="bb45" ref-type="bibr"> ▸</xref>), to take the beam geometry, the grain shapes and intragranular lattice variations into account using a tetrahedral mesh representation. Additionally, we derive analytical solutions to the Laue equations to calculate the diffraction volumes and vectors for arbitrary positions and orientations of the sample. This enables simulation of diffraction as the sample undergoes user-specified rigid body motion sequences during diffraction readout and can be viewed as a generalization of the equations provided by Wong <italic toggle="yes">et al.</italic> (2013<xref rid="bb45" ref-type="bibr"> ▸</xref>) for single-axis rotation. By making <italic toggle="yes">xrd_simulator</italic> open source and easily accessible, we provide a means to accelerate the rate at which 3DXRD-type methodologies can evolve.</p>
    <p>The paper is structured as follows. In Section 2<xref rid="sec2" ref-type="sec"/> we present the diffraction approximations made in <italic toggle="yes">xrd_simulator</italic> and derive the analytical expressions needed for its implementation. In Sections 3<xref rid="sec3" ref-type="sec"/> and 4<xref rid="sec4" ref-type="sec"/> we comment on the software architecture and availability and provide references to external tutorials and documentation. In Section 5<xref rid="sec5" ref-type="sec"/> we comment on the computational aspects of the software and provide sample benchmarks. Finally, in Section 6<xref rid="sec6" ref-type="sec"/> we provide some concluding remarks. Additionally, we append a case study comparison of simulations performed with <italic toggle="yes">xrd_simulator</italic> and data collected at the ESRF ID11 beamline.</p>
  </sec>
  <sec id="sec2">
    <label>2.</label>
    <title>Diffraction approximations</title>
    <p>X-ray diffraction is computed in <italic toggle="yes">xrd_simulator</italic> by defining a series of mathematical model components, including a polycrystal, an X-ray beam and a detector. In this section we describe the formulation of these models and discuss their interactions. In the following, any vector <bold>v</bold> is normalized by the inclusion of a symbol <inline-formula><inline-graphic xlink:href="j-56-00282-efi1.jpg"/></inline-formula> such that <inline-formula><inline-graphic xlink:href="j-56-00282-efi2.jpg"/></inline-formula>.</p>
    <p>Four Cartesian coordinate systems are used; the laboratory coordinate system, the sample coordinate system, the crystal coordinate system and the detector coordinate system (Fig. 1<xref rid="fig1" ref-type="fig"> ▸</xref>). The crystal, sample and detector coordinate systems are all fixed in relation to a lattice, a polycrystalline sample and a detector plane, respectively. Transformations of these three coordinates systems are tracked by the laboratory coordinate system, which serves as a global frame of reference.</p>
    <p>The morphology of a polycrystalline sample is defined in the global laboratory reference frame with axes <inline-formula><inline-graphic xlink:href="j-56-00282-efi3.jpg"/></inline-formula>. As a starting point, the internal sample coordinate system, with axes <inline-formula><inline-graphic xlink:href="j-56-00282-efi4.jpg"/></inline-formula>, is aligned with the laboratory system. Once the sample has moved, to transform a point <bold>p</bold>
<sub>l</sub> from laboratory to sample coordinates we apply a rigid body motion through a rotation matrix, <bold>R</bold>, and a translation vector, Δ<bold>x</bold> as <disp-formula id="fd1"><graphic xlink:href="j-56-00282-efd1.jpg" position="float"/></disp-formula>The single crystal elements constituting a polycrystalline sample each have their own crystal coordinate reference frame with axes <inline-formula><inline-graphic xlink:href="j-56-00282-efi5.jpg"/></inline-formula>. A vector, <bold>p</bold>
<sub>c</sub>, described in crystal coordinates is transformed to the sample frame via the crystal orientation matrix, <bold>U</bold>, as <disp-formula id="fd2"><graphic xlink:href="j-56-00282-efd2.jpg" position="float"/></disp-formula>The detector coordinate system, with in-plane axes <inline-formula><inline-graphic xlink:href="j-56-00282-efi6.jpg"/></inline-formula> and normal <inline-formula><inline-graphic xlink:href="j-56-00282-efi7.jpg"/></inline-formula>, defines the plane at which a diffraction pattern can be collected. A point on the detector surface, <bold>p</bold>
<sub>l</sub>, can be described by its projection onto the in-plane detector axes <disp-formula id="fd3"><graphic xlink:href="j-56-00282-efd3.jpg" position="float"/></disp-formula>
</p>
    <sec id="sec2.1">
      <label>2.1.</label>
      <title>Diffraction equations</title>
      <p>We define an incident wavevector, <bold>k</bold>, to point in the propagation direction of a parallel monochromatic X-ray beam. The diffraction vector, <bold>G</bold>, is defined as <disp-formula id="fd4"><graphic xlink:href="j-56-00282-efd4.jpg" position="float"/></disp-formula>where <bold>k</bold>′ is an elastically scattered wavevector. The Euclidean norm, || · ||, of the wavevector is defined as <disp-formula id="fd5"><graphic xlink:href="j-56-00282-efd5.jpg" position="float"/></disp-formula>where λ is the X-ray wavelength.</p>
      <p>From equation (4<xref rid="fd4" ref-type="disp-formula"/>) and the elastic scattering condition it follows that <disp-formula id="fd6"><graphic xlink:href="j-56-00282-efd6.jpg" position="float"/></disp-formula>Considering equation (6<xref rid="fd6" ref-type="disp-formula"/>) together with equation (5<xref rid="fd5" ref-type="disp-formula"/>), it follows that <bold>k</bold> and −<bold>k</bold>′ form the same angle, π/2 − θ, to <bold>G</bold>. The Bragg angle, θ, can be found as <disp-formula id="fd7"><graphic xlink:href="j-56-00282-efd7.jpg" position="float"/></disp-formula>For diffraction to occur from a set of lattice planes the Laue equations require that <disp-formula id="fd8"><graphic xlink:href="j-56-00282-efd8.jpg" position="float"/></disp-formula>where <bold>a</bold>, <bold>b</bold> and <bold>c</bold> define a unit cell and <bold>G</bold>
<sub><italic toggle="yes">hkl</italic></sub> = [<italic toggle="yes">h</italic> 
<italic toggle="yes">k</italic> 
<italic toggle="yes">l </italic>]<sup>T</sup> holds the integer Miller indices of the diffracting lattice plane family. Introducing the unique multiplicative decomposition of the inverse matrix [<bold>a</bold> 
<bold>b</bold> 
<bold>c</bold>]<sup>−T</sup> into a unitary rotation matrix, <bold>U</bold>, and an upper triangular matrix, <bold>B</bold>, with positive diagonal elements, we write equation (8<xref rid="fd8" ref-type="disp-formula"/>) as <disp-formula id="fd9"><graphic xlink:href="j-56-00282-efd9.jpg" position="float"/></disp-formula>In this description <bold>U</bold> is the crystal lattice orientation matrix while <bold>B</bold> is defined from the lattice unit cell.</p>
    </sec>
    <sec id="sec2.2">
      <label>2.2.</label>
      <title>Polycrystalline sample representation</title>
      <p>A polycrystalline sample is represented by a tetrahedral mesh with each individual tetrahedron being modelled as a single crystal; grains are thus defined by adjacent cells with the same (or similar) unit-cell parameters (Fig. 2<xref rid="fig2" ref-type="fig"> ▸</xref>). The single crystal elements are defined through a reference unit cell, a phase, a symmetric infinitesimal strain tensor (laboratory coordinates), <bold>ε</bold>
<sub><italic toggle="yes">l</italic></sub>, and a crystal orientation matrix, <bold>U</bold>. Each of these four quantities remain constant over each element volume and spatial variations in the lattice structure are modelled by letting neighbouring elements hold different lattice states. The nodal vertices of a tetrahedron are denoted (<bold>c</bold>
<sub>0</sub>, <bold>c</bold>
<sub>1</sub>, <bold>c</bold>
<sub>2</sub>, <bold>c</bold>
<sub>2</sub>), as illustrated in Fig. 2<xref rid="fig2" ref-type="fig"> ▸</xref>.</p>
      <p>To compute the <bold>B</bold> matrix, given the quantities associated with a single tetrahedron for use in equation (9<xref rid="fd9" ref-type="disp-formula"/>), we use <italic toggle="yes">xfab</italic>, which is part of the <italic toggle="yes">3DXRD Fable</italic> suite (Sørensen <italic toggle="yes">et al.</italic>, 2012<xref rid="bb41" ref-type="bibr"> ▸</xref>).</p>
    </sec>
    <sec id="sec2.3">
      <label>2.3.</label>
      <title>Beam representation</title>
      <p>A beam of X-rays is represented by a convex polyhedron with <italic toggle="yes">n</italic> vertices, <bold>b</bold>
<sub><italic toggle="yes">i</italic></sub>, indexed as <italic toggle="yes">i</italic> = 0, 1,…, <italic toggle="yes">n</italic>. The X-ray propagation direction is defined by the unit vector <inline-formula><inline-graphic xlink:href="j-56-00282-efi8.jpg"/></inline-formula>. The photon density is taken to be uniform within the beam hull and the X-rays are assumed to be linearly polarized in the direction of a unit vector, <inline-formula><inline-graphic xlink:href="j-56-00282-efi9.jpg"/></inline-formula>. An example geometry of an X-ray beam is illustrated in Fig. 3<xref rid="fig3" ref-type="fig"> ▸</xref>.</p>
      <p>The use of a convex polyhedron to represent the beam shape, as opposed to an axis-aligned box for instance, is motivated by the need for <italic toggle="yes">xrd_simulator</italic> to facilitate numerical investigations of scan sequences in far-field X-ray diffraction. Optimal selection of beam cross section shape and scan pattern remain open research questions in scanning 3DXRD experiments. Moreover, the use of a convex beam allows indirectly for simulations of variable beam intensity profiles. This can be achieved by repeatedly computing diffraction from sub regions of a composite beam, one diffraction pattern at a time, to produce a weighted sum of diffraction.</p>
    </sec>
    <sec id="sec2.4">
      <label>2.4.</label>
      <title>Scattering unit</title>
      <p>The volume intersection between an illuminated diffracting single crystal element and the beam is defined as a scattering unit. As both the beam and the single crystal tetrahedrons are convex, their intersections will also form convex polyhedrons. The scattering units each have a diffracted wavevector <bold>k</bold>′ and serve as the basis for rendering diffraction patterns onto the detector area. A simplified 2D illustration of a scattering unit is given in Fig. 4<xref rid="fig4" ref-type="fig"> ▸</xref>
</p>
      <p>To compute the scattering unit polyhedron we use the <italic toggle="yes">SciPy</italic> (Virtanen <italic toggle="yes">et al.</italic>, 2020<xref rid="bb43" ref-type="bibr"> ▸</xref>) wrapper for the <italic toggle="yes">Qhull</italic> (Barber <italic toggle="yes">et al.</italic>, 1996<xref rid="bb3" ref-type="bibr"> ▸</xref>) library. The algorithm is seeded with an interior point of the scattering unit polyhedron, which can be found either by trial and error or by solving a linear program, as described in the <monospace>scipy.spatial.HalfspaceIntersection</monospace> documentation. Since the computation of the scattering unit polyhedron is expensive, <italic toggle="yes">xrd_simulator</italic> implements a collision detection algorithm that checks for intersections between element bounding spheres and the beam hull. This allows <italic toggle="yes">xrd_simulator</italic> to quickly exclude elements of the mesh that cannot take part in diffraction.</p>
    </sec>
    <sec id="sec2.5">
      <label>2.5.</label>
      <title>Detector representation</title>
      <p>A detector is represented by an arbitrary rectangular plane segment holding a grid of rectangular pixels with user specified size (<inline-formula><inline-graphic xlink:href="j-56-00282-efi10.jpg"/></inline-formula>). As depicted in Fig. 1<xref rid="fig1" ref-type="fig"> ▸</xref>, the detector can be parameterized by three vectors (<bold>d</bold>
<sub>0</sub>, <bold>d</bold>
<sub>1</sub>, <bold>d</bold>
<sub>2</sub>) extending from the laboratory origin to the detector corners. The three detector corners are arranged in clockwise order, with respect to the detector normal, and the detector coordinate system origin is taken as <bold>d</bold>
<sub>0</sub>. Since the detector corners <bold>d</bold>
<sub>0</sub>, <bold>d</bold>
<sub>1</sub> and <bold>d</bold>
<sub>2</sub> may be arbitrarily specified in 3D space it is possible to simulate arbitrary detector tilts and misalignments in <italic toggle="yes">xrd_simulator</italic>. The detector coordinate axes are defined as <disp-formula id="fd10"><graphic xlink:href="j-56-00282-efd10.jpg" position="float"/></disp-formula>The detector normal is defined through the cross product, <disp-formula id="fd11"><graphic xlink:href="j-56-00282-efd11.jpg" position="float"/></disp-formula>Additionally, a point spread function, PSF(<italic toggle="yes">z</italic>
<sub><italic toggle="yes">d</italic></sub>, <italic toggle="yes">y</italic>
<sub><italic toggle="yes">d</italic></sub>), simulating blurring due to the detector optics can be specified. When computing the simulated diffraction data the point spread function is convoluted with the 2D diffraction image, as a final step.</p>
    </sec>
    <sec id="sec2.6">
      <label>2.6.</label>
      <title>Sample motion</title>
      <p>Before the derivation of diffraction vectors can be considered, we must first describe the motion path of the sample during detector readout. An arbitrary rigid body motion of the sample is defined by a unit rotation axis, <inline-formula><inline-graphic xlink:href="j-56-00282-efi11.jpg"/></inline-formula>, a rotation angle, Δω ∈ (0, π), and a translation vector, Δ<bold>x</bold>. The motion is executed over the unitless time interval <italic toggle="yes">t</italic> ∈ [0, 1] during which a single detector frame is collected. At the start of detector readout, before the sample has moved, <italic toggle="yes">t</italic> = 0, and at the end of readout, when the sample has translated by Δ<bold>x</bold> and moved Δω radians around <inline-formula><inline-graphic xlink:href="j-56-00282-efi12.jpg"/></inline-formula>, <italic toggle="yes">t</italic> = 1. In this way, arbitrary scan sequences can be modelled using different sample motions for each detector frame readout.</p>
      <p>The sample is modelled to move uniformly over <italic toggle="yes">t</italic> ∈ [0, 1] such that at some intervening time, 0 &lt; <italic toggle="yes">t</italic> &lt; 1, the coordinates of a node, <bold>c</bold>
<sub><italic toggle="yes">i</italic></sub> = <bold>c</bold>
<sub><italic toggle="yes">i</italic></sub>(<italic toggle="yes">t</italic>), in the sample mesh can be found as <disp-formula id="fd12"><graphic xlink:href="j-56-00282-efd12.jpg" position="float"/></disp-formula>
<bold>R</bold> is a Rodriguez rotation matrix, defined as <disp-formula id="fd13"><graphic xlink:href="j-56-00282-efd13.jpg" position="float"/></disp-formula>with unity matrix <bold>I</bold>, and <disp-formula id="fd14"><graphic xlink:href="j-56-00282-efd14.jpg" position="float"/></disp-formula>With the motion path of the sample defined through equations (12<xref rid="fd12" ref-type="disp-formula"/>), (13<xref rid="fd13" ref-type="disp-formula"/>) and (14<xref rid="fd14" ref-type="disp-formula"/>), we may now proceed to compute diffraction vectors.</p>
    </sec>
    <sec id="sec2.7">
      <label>2.7.</label>
      <title>Diffraction computation</title>
      <p>By the introduction of arbitrary rigid body motions of the sample in equation (12<xref rid="fd12" ref-type="disp-formula"/>), the Laue equation (9<xref rid="fd9" ref-type="disp-formula"/>) becomes time dependent. Solutions to these equations for a fixed rotation axis and no sample translations have been derived by Wong <italic toggle="yes">et al.</italic> (2013<xref rid="bb45" ref-type="bibr"> ▸</xref>). In the following we generalize these results to facilitate an arbitrary axis of rotation as well as an arbitrary sample translation.</p>
      <p>Considering a single crystal element, equations (9<xref rid="fd9" ref-type="disp-formula"/>) and (13<xref rid="fd13" ref-type="disp-formula"/>) yield the scattering condition at time <italic toggle="yes">t</italic> as <disp-formula id="fd15"><graphic xlink:href="j-56-00282-efd15.jpg" position="float"/></disp-formula>By finding solutions to equation (15<xref rid="fd15" ref-type="disp-formula"/>) over <italic toggle="yes">t</italic> ∈ [0, 1], the position of the crystal element nodes at the times when diffraction from the volume element can occur can be established through equation (12<xref rid="fd12" ref-type="disp-formula"/>) together with the diffracted wavevector equation (4<xref rid="fd4" ref-type="disp-formula"/>). This information defines the scattering unit. The lack of solutions to equation (15<xref rid="fd15" ref-type="disp-formula"/>) over <italic toggle="yes">t</italic> ∈ [0, 1] means that the crystal cannot diffract over the given sample motion.</p>
      <p>To derive solutions to equation (12<xref rid="fd12" ref-type="disp-formula"/>) in <italic toggle="yes">t</italic> we start by introducing a scalar form of the Laue condition. From equation (6<xref rid="fd6" ref-type="disp-formula"/>) it follows that <disp-formula id="fd16"><graphic xlink:href="j-56-00282-efd16.jpg" position="float"/></disp-formula>Introducing <bold>G</bold>
<sub>0</sub> = <bold>U</bold>
<bold>B</bold>
<bold>G</bold>
<sub><italic toggle="yes">hkl</italic></sub> and combining equation (13<xref rid="fd13" ref-type="disp-formula"/>) with equation (16<xref rid="fd16" ref-type="disp-formula"/>) we find <disp-formula id="fd17"><graphic xlink:href="j-56-00282-efd17.jpg" position="float"/></disp-formula>where we use the fact that <bold>G</bold>
<sup>T</sup>(<italic toggle="yes">t</italic>)<bold>G</bold>(<italic toggle="yes">t</italic>) = <bold>G</bold>
<sub>0</sub>
<bold>G</bold>
<sub>0</sub> since <bold>R</bold>(<italic toggle="yes">t</italic>) is unitary. Introducing the scalars <disp-formula id="fd18"><graphic xlink:href="j-56-00282-efd18.jpg" position="float"/></disp-formula>we may write equation (17<xref rid="fd17" ref-type="disp-formula"/>) as <disp-formula id="fd19"><graphic xlink:href="j-56-00282-efd19.jpg" position="float"/></disp-formula>Introducing the variable <inline-formula><inline-graphic xlink:href="j-56-00282-efi13.jpg"/></inline-formula> we find from the double-angle formula that <disp-formula id="fd20"><graphic xlink:href="j-56-00282-efd20.jpg" position="float"/></disp-formula>Since equation (20<xref rid="fd20" ref-type="disp-formula"/>) is a scalar quadratic equation, one, two or zero solutions must exist. Solving for <italic toggle="yes">s</italic> when ρ<sub>2</sub> ≠ ρ<sub>0</sub> we find that <disp-formula id="fd21"><graphic xlink:href="j-56-00282-efd21.jpg" position="float"/></disp-formula>In the special case of ρ<sub>2</sub> = ρ<sub>0</sub> equation (20<xref rid="fd20" ref-type="disp-formula"/>) reduces to <disp-formula id="fd22"><graphic xlink:href="j-56-00282-efd22.jpg" position="float"/></disp-formula>such that a single solution, <italic toggle="yes">s</italic> = −ρ<sub>0</sub>/ρ<sub>1</sub>, can be found, given that ρ<sub>1</sub> ≠ 0. Finally, the sought time, <italic toggle="yes">t</italic>, in equation (15<xref rid="fd15" ref-type="disp-formula"/>) is found by reversing the tangent substitution, <disp-formula id="fd23"><graphic xlink:href="j-56-00282-efd23.jpg" position="float"/></disp-formula>We remind the reader that the derived solutions, <italic toggle="yes">t</italic>, are the relative moments in time, during a frame acquisition, at which a single crystal element will diffract the incident X-rays. The position of the element nodes during diffraction can, thus, be computed through equation (12<xref rid="fd12" ref-type="disp-formula"/>) and the geometry of the scattering unit is found by computing the intersection of the updated tetrahedral element and the X-ray beam. With this information available we may proceed to propagate the diffracted X-rays onto the 2D detector area.</p>
    </sec>
    <sec id="sec2.8">
      <label>2.8.</label>
      <title>Ray tracing</title>
      <p>Once the scattering units have been established, the diffracted wavevectors, <bold>k</bold>′, are traced onto the detector surface. Two options for ray tracing are available in <italic toggle="yes">xrd_simulator</italic>. Either rays are traced from the centroids of the individual scattering units or, alternatively, rays are traced from the detector pixel centroids back through the scattering units. The latter of the two models can be considered to produce a more accurate projection approximation while the former will be computationally faster. As illustrated in Fig. 5<xref rid="fig5" ref-type="fig"> ▸</xref>, ray tracing driven by the detector grid pixels will produce space-filling projections, while ray tracing driven by the scattering unit centroid will approximate a diffraction peak as a point cloud.</p>
      <p>Considering a point <bold>x</bold> in the sample volume associated with a scattered wavevector <bold>k</bold>′, we may parameterize a scattered ray through a scalar <italic toggle="yes">h</italic> as <disp-formula id="fd24"><graphic xlink:href="j-56-00282-efd24.jpg" position="float"/></disp-formula>The point of intersection, <bold>p</bold>(<italic toggle="yes">h</italic>
<sup>*</sup>), between scattered ray and detector is found from <disp-formula id="fd25"><graphic xlink:href="j-56-00282-efd25.jpg" position="float"/></disp-formula>Solving equation (25<xref rid="fd25" ref-type="disp-formula"/>) for <inline-formula><inline-graphic xlink:href="j-56-00282-efi14.jpg"/></inline-formula> yields <disp-formula id="fd26"><graphic xlink:href="j-56-00282-efd26.jpg" position="float"/></disp-formula>The detector coordinates of the intersection point can now be found through equation (10<xref rid="fd10" ref-type="disp-formula"/>), <disp-formula id="fd27"><graphic xlink:href="j-56-00282-efd27.jpg" position="float"/></disp-formula>By setting <bold>x</bold> in equation (27<xref rid="fd27" ref-type="disp-formula"/>) as the scattering unit centroid, ray tracing can be performed. When ray tracing using the detector pixels as source points is considered instead, <bold>x</bold> in equation (24<xref rid="fd24" ref-type="disp-formula"/>) must be taken as a point in the detector plane. By solving equation (24<xref rid="fd24" ref-type="disp-formula"/>) for the intersections with the planes that define the facets of the scattering unit, an intersection length, <italic toggle="yes">l</italic>, between the ray and polyhedron can be established. To do so, we have implemented the clipping algorithm developed by Cyrus &amp; Beck (1978<xref rid="bb8" ref-type="bibr"> ▸</xref>). To speed up the computations, the vertices of a scattering unit are first projected onto the detector plane, establishing a feasible region on the detector where the projection may fall. In this way equation (24<xref rid="fd24" ref-type="disp-formula"/>) is only solved for a sub-grid of the detector.</p>
    </sec>
    <sec id="sec2.9">
      <label>2.9.</label>
      <title>Intensity model</title>
      <p>Once the diffracted rays of a scattering unit have been mapped to the pixels of the detector, the scattered intensity, <italic toggle="yes">I</italic>, can be computed and deposited. If ray tracing based on the scattering unit centroids is used, the intensity is modelled to be proportional to the scattering unit volume, <italic toggle="yes">V</italic>, polarization factor, <italic toggle="yes">P</italic>, Lorentz factor, <italic toggle="yes">L</italic>, and structure factor, <italic toggle="yes">F</italic>
<sub><italic toggle="yes">hkl</italic></sub>, as <disp-formula id="fd28"><graphic xlink:href="j-56-00282-efd28.jpg" position="float"/></disp-formula>If, instead, ray tracing is driven by the detector pixels, the intensity is modelled as <disp-formula id="fd29"><graphic xlink:href="j-56-00282-efd29.jpg" position="float"/></disp-formula>where <italic toggle="yes">l</italic> is the intersection length between the scattered ray and the scattering unit polyhedron.</p>
      <p>The inclusion of the factors <italic toggle="yes">P</italic>, <italic toggle="yes">L</italic> and <italic toggle="yes">F</italic>
<sub><italic toggle="yes">hkl</italic></sub> in the intensity model of <italic toggle="yes">xrd_simulator</italic> can be toggled by the user. Since <italic toggle="yes">xrd_simulator</italic> is designed to separate the computation of scattering units from the diffraction pattern image rendering, several different intensity and ray tracing combinations can be tested without having to solve equation (15<xref rid="fd15" ref-type="disp-formula"/>) repeatedly. It is also possible to access the scattering units directly in <italic toggle="yes">xrd_simulator</italic>, allowing for custom intensity and ray tracing models to be tested.</p>
      <sec id="sec2.9.1">
        <label>2.9.1.</label>
        <title>Structure factors</title>
        <p>To compute structure factors we use the open source tool <italic toggle="yes">xfab</italic>, which is available as part of the <italic toggle="yes">FABLE-3DXRD</italic> software suite (Sørensen <italic toggle="yes">et al.</italic>, 2012<xref rid="bb41" ref-type="bibr"> ▸</xref>; <ext-link xlink:href="https://github.com/FABLE-3DXRD/xfab" ext-link-type="uri">https:// github.com/FABLE-3DXRD/xfab</ext-link>). An introduction to structure factors is provided by, for example, Als-Nielsen &amp; McMorrow (2011<xref rid="bb2" ref-type="bibr"> ▸</xref>). To include structure factors in the intensity model the user is expected to provide a crystallographic information file (Hall <italic toggle="yes">et al.</italic>, 1991<xref rid="bb11" ref-type="bibr"> ▸</xref>) to <italic toggle="yes">xrd_simulator</italic>, specifying the properties of the simulated material phases. If structure factors are not needed, the user may alternatively define the material phase by passing a set of unit-cell parameters.</p>
      </sec>
      <sec id="sec2.9.2">
        <label>2.9.2.</label>
        <title>Lorentz factors</title>
        <p>As stated by Lauridsen <italic toggle="yes">et al.</italic> (2001<xref rid="bb23" ref-type="bibr"> ▸</xref>), for a single axis rotation geometry, where the rotation axis is aligned with <inline-formula><inline-graphic xlink:href="j-56-00282-efi15.jpg"/></inline-formula>, the Lorentz factor can be approximated as <disp-formula id="fd30"><graphic xlink:href="j-56-00282-efd30.jpg" position="float"/></disp-formula>where η denotes the angle between the projection of the rotation axis, <inline-formula><inline-graphic xlink:href="j-56-00282-efi12.jpg"/></inline-formula>, and scattered ray direction, <inline-formula><inline-graphic xlink:href="j-56-00282-efi17.jpg"/></inline-formula>, onto the <inline-formula><inline-graphic xlink:href="j-56-00282-efi15.jpg"/></inline-formula>–<inline-formula><inline-graphic xlink:href="j-56-00282-efi19.jpg"/></inline-formula> plane. In <italic toggle="yes">xrd_simulator</italic> each detector frame has an arbitrary sample rotation axis and η can be found as <disp-formula id="fd31"><graphic xlink:href="j-56-00282-efd31.jpg" position="float"/></disp-formula>By additionally recovering θ from equation (7<xref rid="fd7" ref-type="disp-formula"/>), the Lorentz factor can be computed from equation (30<xref rid="fd30" ref-type="disp-formula"/>). Note that the expression for the Lorentz factor in equation (30<xref rid="fd30" ref-type="disp-formula"/>) is approximate. Especially, for η = 0 or θ = 0, the intensity will diverge, and <italic toggle="yes">xrd_simulator</italic> will insert <monospace>numpy.inf</monospace> values at the corresponding detector pixels.</p>
      </sec>
      <sec id="sec2.9.3">
        <label>2.9.3.</label>
        <title>Polarization factors</title>
        <p>For linearly polarized X-rays (Als-Nielsen &amp; McMorrow, 2011<xref rid="bb2" ref-type="bibr"> ▸</xref>) the polarization factor takes the form <disp-formula id="fd32"><graphic xlink:href="j-56-00282-efd32.jpg" position="float"/></disp-formula>where <inline-formula><inline-graphic xlink:href="j-56-00282-efi9.jpg"/></inline-formula> and <inline-formula><inline-graphic xlink:href="j-56-00282-efi21.jpg"/></inline-formula> are the unit polarization vectors of the incident and scattered X-rays, respectively. An observer of an oscillating electron sitting on the scattered ray will only see oscillations that exist in the plane perpendicular to the propagation direction of the X-rays. Thus, we can describe <inline-formula><inline-graphic xlink:href="j-56-00282-efi21.jpg"/></inline-formula> by the projection <disp-formula id="fd33"><graphic xlink:href="j-56-00282-efd33.jpg" position="float"/></disp-formula>Inserting equation (33<xref rid="fd33" ref-type="disp-formula"/>) in equation (32<xref rid="fd32" ref-type="disp-formula"/>) we find <disp-formula id="fd34"><graphic xlink:href="j-56-00282-efd34.jpg" position="float"/></disp-formula>
</p>
      </sec>
    </sec>
  </sec>
  <sec id="sec3">
    <label>3.</label>
    <title>Software architecture</title>
    <p><italic toggle="yes">xrd_simulator</italic> is a Python library organized around four Python objects: an X-ray beam, a polycrystalline sample, a detector and a sample motion. These four Python objects are implementations of the mathematical concepts previously outlined in Section 2<xref rid="sec2" ref-type="sec"/> and define together a diffraction experiment simulator. The end user of <italic toggle="yes">xrd_simulator</italic> can define their own simulations through Python scripts, instantiating each of the four necessary objects as desired. By passing a motion object to the polycrystalline sample, together with a beam and detector, diffraction vectors can be computed. Scattering units are computed and stored in the detector object. The user may then call a detector rendering method to compute a diffraction pattern image.</p>
    <p>A schematic overview of the <italic toggle="yes">xrd_simulator</italic> architecture can be found in Fig. 6<xref rid="fig6" ref-type="fig"> ▸</xref>. Detailed code samples and beginners tutorials on how to use <italic toggle="yes">xrd_simulator</italic> can be found both at GitHub (<ext-link xlink:href="https://github.com/FABLE-3DXRD/xrd_simulator" ext-link-type="uri">https://github.com/FABLE-3DXRD/xrd_simulator</ext-link>) as well as in the externally hosted documentation (<ext-link xlink:href="https://fable-3dxrd.github.io/xrd_simulator/" ext-link-type="uri">https://fable-3dxrd.github.io/xrd_simulator/</ext-link>).</p>
  </sec>
  <sec id="sec4">
    <label>4.</label>
    <title>Software availability</title>
    <p>The source code of <italic toggle="yes">xrd_simulator</italic> is openly distributed with an MIT open source licence at GitHub (<ext-link xlink:href="https://github.com/FABLE-3DXRD/xrd_simulator" ext-link-type="uri">https://github.com/FABLE-3DXRD/xrd_simulator</ext-link>). <italic toggle="yes">xrd_simulator</italic> features cross-platform support and can be installed using the Python package installer, <italic toggle="yes">pip</italic>, or alternatively the <italic toggle="yes">Anaconda</italic> package manager. Documentation on installing <italic toggle="yes">xrd_simulator</italic> can be found at the GitHub source location or, alternatively, in the externally hosted documentation (<ext-link xlink:href="https://fable-3dxrd.github.io/xrd_simulator/" ext-link-type="uri">https://fable-3dxrd.github.io/xrd_simulator/</ext-link>).</p>
  </sec>
  <sec id="sec5">
    <label>5.</label>
    <title>Computational tractability</title>
    <p>The core computations of <italic toggle="yes">xrd_simulator</italic> can be summarized in three steps. Firstly, solutions to equation (17<xref rid="fd17" ref-type="disp-formula"/>) are established. Secondly, polyhedral intersection regions between the X-ray beam and mesh elements are computed. Thirdly the diffraction signal is rendered into a diffraction pattern image. The total time needed to compute a diffraction pattern therefore scales with the number of elements within the mesh, the beam cross section and the angular range of the sample rotation. To enable computation of state-of-the-art data sets <italic toggle="yes">xrd_simulator</italic> implements a multiprocessing option using the Python native multiprocessing library. In Fig. 7<xref rid="fig7" ref-type="fig"> ▸</xref> we provide some typical run times of <italic toggle="yes">xrd_simulator</italic> simulating a 10 × 10 pencil beam raster scan with 180 rendered frames in intervals of 1.0°. Considering the selected detector dimensions (2048  ×  2048) the computed data consisted of, in total, 10 × 10 × 180 × 2048 × 2048 ∼ 10<sup>11</sup> floating point numbers. The timings presented in Fig. 7<xref rid="fig7" ref-type="fig"> ▸</xref> were achieved on a Lenovo ThinkStation P330 MT deploying six Intel Core i7-8700K 3.70 GHz CPUs.</p>
    <p>In conclusion, diffraction computations from samples with up to ∼10<sup>6</sup> elements are feasible with <italic toggle="yes">xrd_simulator</italic> within 25 or 17 h, depending on what ray tracing model is selected.</p>
  </sec>
  <sec sec-type="conclusions" id="sec6">
    <label>6.</label>
    <title>Conclusions</title>
    <p>An open source Python package for simulation of X-ray diffraction by polycrystals, named <italic toggle="yes">xrd_simulator</italic>, has been developed. By representing a polycrystalline sample as a tetrahedral mesh, an arbitrary sample morphology and microstructure can be modelled. Diffraction vectors are computed from the solutions of a time-dependent version of the Laue equations, enabling arbitrary rigid body motions of the sample. Diffraction peak intensities are computed as the product of scattering volumes and Lorentz, structure and polarization factors. Combining these features, <italic toggle="yes">xrd_simulator</italic> presents new opportunities to develop and understand the impact of different acquisition schemes for 3DXRD-type experiments such that optimal schemes can be defined in terms of acquisition time and resolution of the target parameters.</p>
  </sec>
</body>
<back>
  <ack>
    <p>We are grateful for the beam time provided at the ESRF ID11 beamline, where the data for evaluating the developed software tool were collected.</p>
  </ack>
  <app-group>
    <app id="appa">
      <label>Appendix A </label>
      <title>Experimental verification</title>
      <p>To demonstrate the use of <italic toggle="yes">xrd_simulator</italic> we have simulated diffraction on the basis of measurements performed at the ESRF ID11 beamline. By comparing the results of <italic toggle="yes">xrd_simulator</italic> with the data from the experiment we explore the diffraction model limitations. The measured sample consisted of 12 quasi-spherical silica (SiO<sub>2</sub>) grains confined within a cylindrical polyether ether ketone tube and subject to 20 N of uni-axial loading along the laboratory <italic toggle="yes">z</italic>-axis direction. The full 3D grain volume was scanned with a scanning 3DXRD geometry (Hayashi <italic toggle="yes">et al.</italic>, 2015<xref rid="bb12" ref-type="bibr"> ▸</xref>) first using a 20 µm × 20 µm pencil beam and then a 20 µm-height letter-box beam (covering the full sample in the <inline-formula><inline-graphic xlink:href="j-56-00282-efi25.jpg"/></inline-formula>–<inline-formula><inline-graphic xlink:href="j-56-00282-efi26.jpg"/></inline-formula> plane). The data from the pencil beam scan were used to perform tomographic reconstruction of the grain shapes, using a method similar to that reported by Poulsen &amp; Schmidt (2003<xref rid="bb36" ref-type="bibr"> ▸</xref>) [Fig. 8<xref rid="fig8" ref-type="fig"> ▸</xref>(<italic toggle="yes">a</italic>)]. The same pencil beam scan data were used to derive average crystallographic orientations and strain tensors of individual grains in the volume, using methods from <italic toggle="yes">ImageD11</italic> (Wright, 2005<xref rid="bb46" ref-type="bibr"> ▸</xref>). A 20 µm-high slice (in the <inline-formula><inline-graphic xlink:href="j-56-00282-efi25.jpg"/></inline-formula>–<inline-formula><inline-graphic xlink:href="j-56-00282-efi26.jpg"/></inline-formula> plane) was extracted from the 3D tomographic reconstruction, to provide an equivalent volume to one of the 20 µm letterbox 3DXRD acquisitions. This volume was used to derive a grain mesh that was input to <italic toggle="yes">xrd_simulator</italic> [Fig. 8<xref rid="fig8" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>)] together with a crystallographic information file corresponding to α-quartz. In this way the input microstructure for <italic toggle="yes">xrd_simulator</italic> was derived soley from the pencil beam scan data while any of the following comparisons between simulated and measured diffraction patterns are made with the independently measured letterbox beam data.</p>
      <p>Diffraction was simulated for the 20 µm-high slice through the sample by integrating the diffraction signal over a 10° rotation. The resulting 2D diffraction patterns were log-normalized and compared with the corresponding measured log-normalized signal (Fig. 9<xref rid="fig9" ref-type="fig"> ▸</xref>) from an equivalent letterbox acquisition.</p>
      <p>Visual comparison between columns A and C in Fig. 9<xref rid="fig9" ref-type="fig"> ▸</xref> shows similar diffraction patterns. However, the subset of diffraction peaks in Figs. 9<xref rid="fig9" ref-type="fig"> ▸</xref>-A2 and 9<xref rid="fig9" ref-type="fig"> ▸</xref>-C2 show some discrepancy between simulated and measured peak shapes. This is not unexpected and several potential sources of errors can be listed. These include:</p>
      <p>(1) <italic toggle="yes">Unknown detector point-spread function</italic> will influence the peak shapes and maximal peak intensities.</p>
      <p>(2) <italic toggle="yes">Low signal-to-noise ratio</italic> will influence low intensity scattering regions, which can lead to the removal of peaks or distortion of peak boundaries during background subtraction.</p>
      <p>(3) <italic toggle="yes">Unknown mosaicity and intragranular strain</italic> will affect which peaks appear or not, as well as the peak shapes and intensities.</p>
      <p>Turning our attention to the last of these error sources (3) we expect some, unknown, intragranular strain and orientation variations to be present within the individual grains. As a result the diffraction peak shapes will be deformed. Additionally, the set of possibly diffracting lattice plane families will be modified as the Bragg condition is shifted. To demonstrate these effects, modest, uniformly random mosaicity and strain variation were introduced into the simulation (Fig. 9<xref rid="fig9" ref-type="fig"> ▸</xref> column B). First, each mesh element was seeded with the corresponding reconstructed grain average orientation matrix (derived from the pencil beam scan data). Next, the seeded orientation matrix was perturbed by a uniformly random rotation in the range 0.0–0.125°. Likewise, each component of strain was uniformly perturbed in the range 0–0.005. The magnitudes of the perturbations were chosen arbitrarily.</p>
      <p>With the inclusion of random intragranular variations, we observe new, additional, diffraction peaks in Fig. 9<xref rid="fig9" ref-type="fig"> ▸</xref>-C as compared to Fig. 9<xref rid="fig9" ref-type="fig"> ▸</xref>-A. Although some diffraction events will now inevitably be erroneously pushed into their favourable Bragg conditions (marked with white squares in Figs. 9<xref rid="fig9" ref-type="fig"> ▸</xref>-A2, 9<xref rid="fig9" ref-type="fig"> ▸</xref>-B2 and 9<xref rid="fig9" ref-type="fig"> ▸</xref>-C2) several diffraction peaks originally missing in the simulation are now recovered (as marked with red circles in Figs. 9<xref rid="fig9" ref-type="fig"> ▸</xref>-A2, 9<xref rid="fig9" ref-type="fig"> ▸</xref>-B2 and 9<xref rid="fig9" ref-type="fig"> ▸</xref>-C2). This serves to illustrate how <italic toggle="yes">xrd_simulator</italic> captures the strong dependence between the measured diffraction signal and the underlying sample microstructure present in these types of experiments.</p>
    </app>
    <app id="appb">
      <label>Appendix B </label>
      <title>Highlights of software capability</title>
      <p><italic toggle="yes">xrd_simulator</italic> features space filling descriptions of polycrystals where each element of the tetrahedral mesh can have an individual phase, strain tensor and lattice orientation. To show how the spatial variation in a polycrystal can impact simulated diffraction patterns we provide far-field diffraction simulations from a multi-phase deformed polycrystal (Fig. 10<xref rid="fig10" ref-type="fig"> ▸</xref>) in this appendix section. As depicted in Fig. 10<xref rid="fig10" ref-type="fig"> ▸</xref>(<italic toggle="yes">c</italic>), a copper (Cu)–tin (Sn) aggregate composed of 64 grains with a combined total of 120282 individual tetrahedrons is considered. The individual grains were each seeded with a mean strain tensor and orientation matrix over which linear gradients in random directions were superimposed [Figs. 10<xref rid="fig10" ref-type="fig"> ▸</xref>(<italic toggle="yes">a</italic>) and 10<xref rid="fig10" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>)]. The aggregate was considered to be fully illuminated by 68.88 keV X-rays propagating along the <italic toggle="yes">x</italic> axis while the sample was rocked 1.0° around the <italic toggle="yes">z</italic> axis. To highlight the impact of the spatial deformation of the polycrystal, diffraction was simulated both with and without the prescribed strain and misorientations. The two resulting 2048 × 2048 pixelated diffraction patterns originating from a deformed and an undeformed sample can be viewed in Figs. 11<xref rid="fig11" ref-type="fig"> ▸</xref>(<italic toggle="yes">a</italic>2) and 11<xref rid="fig11" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>2), respectively. As depicted in Figs. 11<xref rid="fig11" ref-type="fig"> ▸</xref>(<italic toggle="yes">a</italic>1) and 11<xref rid="fig11" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>1) the impact of the lattice spatial variation is evident in the distorted diffraction peaks. Details of the experimental setup are presented in Table 1<xref rid="table1" ref-type="table"> ▸</xref>.</p>
      <p><italic toggle="yes">xrd_simulator</italic> offers a means to understand how the diffraction peak distortions relate to the internal grain deformation. To provide an example of how this can be utilized we have considered diffraction from a single Cu grain in the polycrystalline ensemble. The result of introducing a misorientation gradient around the beam direction and the axis of rotation are depicted in Figs. 12<xref rid="fig12" ref-type="fig"> ▸</xref>(<italic toggle="yes">b</italic>) and 12<xref rid="fig12" ref-type="fig"> ▸</xref>(<italic toggle="yes">c</italic>), respectively, where the resulting 3D peak shapes for the <inline-formula><inline-graphic xlink:href="j-56-00282-efi27.jpg"/></inline-formula>04 reflection have been rendered. Likewise, the effect of a strain gradient in the (<inline-formula><inline-graphic xlink:href="j-56-00282-efi27.jpg"/></inline-formula>04) crystal planes is depicted in Fig. 12<xref rid="fig12" ref-type="fig"> ▸</xref>(<italic toggle="yes">d</italic>). Comparing with a perfect crystal state [Fig. 12<xref rid="fig12" ref-type="fig"> ▸</xref>(<italic toggle="yes">a</italic>)], we see how the diffraction peak arcs over the detector for a misorientation around the beam axis while a misorientation around the rotation axis extends the angular range of diffraction. Finally, we can see the effect of a strain gradient in Fig. 12<xref rid="fig12" ref-type="fig"> ▸</xref>(<italic toggle="yes">d</italic>) resulting in a radially broadened and angularly extended diffraction peak.</p>
    </app>
  </app-group>
  <ref-list>
    <title>References</title>
    <ref id="bb1">
      <mixed-citation publication-type="other">Alpers, A., Poulsen, H. F., Knudsen, E. &amp; Herman, G. T. (2006). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>39</bold>, 582–588.</mixed-citation>
    </ref>
    <ref id="bb2">
      <mixed-citation publication-type="other">Als-Nielsen, J. &amp; McMorrow, D. (2011). <italic toggle="yes">Elements of Modern X-ray Physics.</italic> Chichester: John Wiley &amp; Sons.</mixed-citation>
    </ref>
    <ref id="bb3">
      <mixed-citation publication-type="other">Barber, C. B., Dobkin, D. P. &amp; Huhdanpaa, H. (1996). <italic toggle="yes">ACM Trans. Math. Softw.</italic>
<bold>22</bold>, 469–483.</mixed-citation>
    </ref>
    <ref id="bb4">
      <mixed-citation publication-type="other">Batenburg, K. J., Sijbers, J., Poulsen, H. F. &amp; Knudsen, E. (2010). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>43</bold>, 1464–1473.</mixed-citation>
    </ref>
    <ref id="bb5">
      <mixed-citation publication-type="other">Bernier, J. V., Barton, N. R., Lienert, U. &amp; Miller, M. P. (2011). <italic toggle="yes">J. Strain Anal. Eng. Des.</italic>
<bold>46</bold>, 527–547.</mixed-citation>
    </ref>
    <ref id="bb6">
      <mixed-citation publication-type="other">Bernier, J. V., Suter, R. M., Rollett, A. D. &amp; Almer, J. D. (2020). <italic toggle="yes">Annu. Rev. Mater. Res.</italic>
<bold>50</bold>, 395–436.</mixed-citation>
    </ref>
    <ref id="bb7">
      <mixed-citation publication-type="other">Campbell, J. W. (1995). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>28</bold>, 228–236.</mixed-citation>
    </ref>
    <ref id="bb8">
      <mixed-citation publication-type="other">Cyrus, M. &amp; Beck, J. (1978). <italic toggle="yes">Comput. Graph.</italic>
<bold>3</bold>, 23–28.</mixed-citation>
    </ref>
    <ref id="bb9">
      <mixed-citation publication-type="other">E, J. C., Wang, L., Chen, S., Zhang, Y. Y. &amp; Luo, S. N. (2018). <italic toggle="yes">J. Synchrotron Rad.</italic>
<bold>25</bold>, 604–611.</mixed-citation>
    </ref>
    <ref id="bb10">
      <mixed-citation publication-type="other">Fang, H., Juul Jensen, D. &amp; Zhang, Y. (2020). <italic toggle="yes">Acta Cryst.</italic> A<bold>76</bold>, 652–663.</mixed-citation>
    </ref>
    <ref id="bb11">
      <mixed-citation publication-type="other">Hall, S. R., Allen, F. H. &amp; Brown, I. D. (1991). <italic toggle="yes">Acta Cryst.</italic> A<bold>47</bold>, 655–685.</mixed-citation>
    </ref>
    <ref id="bb12">
      <mixed-citation publication-type="other">Hayashi, Y., Hirose, Y. &amp; Seno, Y. (2015). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>48</bold>, 1094–1101.</mixed-citation>
    </ref>
    <ref id="bb13">
      <mixed-citation publication-type="other">Hayashi, Y., Setoyama, D. &amp; Seno, Y. (2017). <italic toggle="yes">Mater. Sci. Forum</italic>, <bold>905</bold>, 157–164.</mixed-citation>
    </ref>
    <ref id="bb14">
      <mixed-citation publication-type="other">Hektor, J., Hall, S. A., Henningsson, N. A., Engqvist, J., Ristinmaa, M., Lenrick, F. &amp; Wright, J. P. (2019). <italic toggle="yes">Materials</italic>, <bold>12</bold>, 446.</mixed-citation>
    </ref>
    <ref id="bb15">
      <mixed-citation publication-type="other">Henningsson, A. &amp; Hendriks, J. (2021). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>54</bold>, 1057–1070.</mixed-citation>
    </ref>
    <ref id="bb16">
      <mixed-citation publication-type="other">Henningsson, N. A., Hall, S. A., Wright, J. P. &amp; Hektor, J. (2020). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>53</bold>, 314–325.</mixed-citation>
    </ref>
    <ref id="bb17">
      <mixed-citation publication-type="other">Huang, J. W., Cai, Y., Zhong, Z. Y. &amp; Luo, S. N. (2021<italic toggle="yes">a</italic>). <italic toggle="yes">Comput. Mater. Sci.</italic>
<bold>186</bold>, 109997.</mixed-citation>
    </ref>
    <ref id="bb18">
      <mixed-citation publication-type="other">Huang, J. W., Zhang, Y. Y., Hu, S. C., Cai, Y. &amp; Luo, S. N. (2021<italic toggle="yes">b</italic>). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>54</bold>, 686–696.</mixed-citation>
    </ref>
    <ref id="bb19">
      <mixed-citation publication-type="other">Huang, X. R. (2010). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>43</bold>, 926–928.</mixed-citation>
    </ref>
    <ref id="bb20">
      <mixed-citation publication-type="other">Kanagasabapathy, M. (2016). <italic toggle="yes">Crystalsim</italic>, https://sourceforge.net/projects/crystalsim/.</mixed-citation>
    </ref>
    <ref id="bb21">
      <mixed-citation publication-type="other">Knudsen, E. B. (2009). <italic toggle="yes">Quasi-Nearfield Simulation</italic>, https://sourceforge.net/p/fable/wiki/nearfield%20simulation/.</mixed-citation>
    </ref>
    <ref id="bb22">
      <mixed-citation publication-type="other">Laugier, J. &amp; Bochu, B. (2001). <italic toggle="yes">LMGP Suite for Windows</italic>, http://ccp14.cryst.bbk.ac.uk/tutorial/lmgp/index.html.</mixed-citation>
    </ref>
    <ref id="bb23">
      <mixed-citation publication-type="other">Lauridsen, E. M., Schmidt, S., Suter, R. M. &amp; Poulsen, H. F. (2001). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>34</bold>, 744–750.</mixed-citation>
    </ref>
    <ref id="bb24">
      <mixed-citation publication-type="other">Le Page, Y. &amp; Gabe, E. J. (1979). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>12</bold>, 464–466.</mixed-citation>
    </ref>
    <ref id="bb25">
      <mixed-citation publication-type="other">Lionheart, W. R. B. &amp; Withers, P. J. (2015). <italic toggle="yes">Inverse Probl.</italic>
<bold>31</bold>, 045005.</mixed-citation>
    </ref>
    <ref id="bb26">
      <mixed-citation publication-type="other">Ludwig, W., Reischig, P., King, A., Herbig, M., Lauridsen, E. M., Johnson, G., Marrow, T. J. &amp; Buffière, J. Y. (2009). <italic toggle="yes">Rev. Sci. Instrum.</italic>
<bold>80</bold>, 033905.</mixed-citation>
    </ref>
    <ref id="bb27">
      <mixed-citation publication-type="other">Macrae, C. F., Edgington, P. R., McCabe, P., Pidcock, E., Shields, G. P., Taylor, R., Towler, M. &amp; van de Streek, J. (2006). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>39</bold>, 453–457.</mixed-citation>
    </ref>
    <ref id="bb28">
      <mixed-citation publication-type="other">Momma, K. &amp; Izumi, F. (2008). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>41</bold>, 653–658.</mixed-citation>
    </ref>
    <ref id="bb29">
      <mixed-citation publication-type="other">Nervo, L., King, A., Wright, J. P., Ludwig, W., Reischig, P., Quinta da Fonseca, J. &amp; Preuss, M. (2014). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>47</bold>, 1402–1416.</mixed-citation>
    </ref>
    <ref id="bb30">
      <mixed-citation publication-type="other">Oddershede, J., Bachmann, F., Sun, J. &amp; Lauridsen, E. (2022). <italic toggle="yes">Integr. Mater. Manuf. Innov.</italic>
<bold>11</bold>, 1–12.</mixed-citation>
    </ref>
    <ref id="bb31">
      <mixed-citation publication-type="other">Oddershede, J., Schmidt, S., Poulsen, H. F., Sørensen, H. O., Wright, J. &amp; Reimers, W. (2010). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>43</bold>, 539–549.</mixed-citation>
    </ref>
    <ref id="bb32">
      <mixed-citation publication-type="other">Pagan, D. C., Jones, K. K., Bernier, J. V. &amp; Phan, T. Q. (2020). <italic toggle="yes">JOM</italic>, <bold>72</bold>, 4539–4550.</mixed-citation>
    </ref>
    <ref id="bb33">
      <mixed-citation publication-type="other">Poulsen, H. F. (2004). <italic toggle="yes">Three-Dimensional X-ray Diffraction Microscopy. Mapping Polycrystals and Their Dynamics</italic>, Springer Tracts in Modern Physics, Vol. 205. Berlin: Springer.</mixed-citation>
    </ref>
    <ref id="bb34">
      <mixed-citation publication-type="other">Poulsen, H. F. (2020). <italic toggle="yes">Curr. Opin. Solid State Mater. Sci.</italic>
<bold>24</bold>, 100820.</mixed-citation>
    </ref>
    <ref id="bb35">
      <mixed-citation publication-type="other">Poulsen, H. F. &amp; Fu, X. (2003). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>36</bold>, 1062–1068.</mixed-citation>
    </ref>
    <ref id="bb36">
      <mixed-citation publication-type="other">Poulsen, H. F. &amp; Schmidt, S. (2003). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>36</bold>, 319–325.</mixed-citation>
    </ref>
    <ref id="bb37">
      <mixed-citation publication-type="other">Reischig, P. &amp; Ludwig, W. (2020). <italic toggle="yes">Curr. Opin. Solid State Mater. Sci.</italic>
<bold>24</bold>, 100851.</mixed-citation>
    </ref>
    <ref id="bb38">
      <mixed-citation publication-type="other">Sharma, H., Huizenga, R. M. &amp; Offerman, S. E. (2012<italic toggle="yes">a</italic>). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>45</bold>, 693–704.</mixed-citation>
    </ref>
    <ref id="bb39">
      <mixed-citation publication-type="other">Sharma, H., Huizenga, R. M. &amp; Offerman, S. E. (2012<italic toggle="yes">b</italic>). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>45</bold>, 705–718.</mixed-citation>
    </ref>
    <ref id="bb40">
      <mixed-citation publication-type="other">Song, X., Zhang, S. Y., Dini, D. &amp; Korsunsky, A. M. (2008). <italic toggle="yes">Comput. Mater. Sci.</italic>
<bold>44</bold>, 131–137.</mixed-citation>
    </ref>
    <ref id="bb41">
      <mixed-citation publication-type="other">Sørensen, H. O., Schmidt, S., Wright, J. P., Vaughan, G. B. M., Techert, S., Garman, E. F., Oddershede, J., Davaasambuu, J., Paithankar, K. S., Gundlach, C. &amp; Poulsen, H. F. (2012). <italic toggle="yes">Z. Kristallogr.</italic>
<bold>227</bold>, 63–78.</mixed-citation>
    </ref>
    <ref id="bb42">
      <mixed-citation publication-type="other">Soyer, A. (1996). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>29</bold>, 509.</mixed-citation>
    </ref>
    <ref id="bb43">
      <mixed-citation publication-type="other">Virtanen, P., Gommers, R., Oliphant, T. E., Haberland, M., Reddy, T., Cournapeau, D., Burovski, E., Peterson, P., Weckesser, W., Bright, J., van der Walt, S. J., Brett, M., Wilson, J., Millman, K. J., Mayorov, N., Nelson, A. R. J., Jones, E., Kern, R., Larson, E., Carey, C. J., Polat, İ., Feng, Y., Moore, E. W., VanderPlas, J., Laxalde, D., Perktold, J., Cimrman, R., Henriksen, I., Quintero, E. A., Harris, C. R., Archibald, A. M., Ribeiro, A. H., Pedregosa, F., van Mulbregt, P., Vijaykumar, A., Bardelli, A. P., Rothberg, A., Hilboll, A., Kloeckner, A., Scopatz, A., Lee, A., Rokem, A., Woods, C. N., Fulton, C., Masson, C., Häggström, C., Fitzgerald, C., Nicholson, D. A., Hagen, D. R., Pasechnik, D. V., Olivetti, E., Martin, E., Wieser, E., Silva, F., Lenders, F., Wilhelm, F., Young, G., Price, G. A., Ingold, G., Allen, G. E., Lee, G. R., Audren, H., Probst, I., Dietrich, J. P., Silterra, J., Webber, J. T., Slavič, J., Nothman, J., Buchner, J., Kulick, J., Schönberger, J. L., de Miranda Cardoso, J. V., Reimer, J., Harrington, J., Rodríguez, J. L. C., Nunez-Iglesias, J., Kuczynski, J., Tritz, K., Thoma, M., Newville, M., Kümmerer, M., Bolingbroke, M., Tartre, M., Pak, M., Smith, N. J., Nowaczyk, N., Shebanov, N., Pavlyk, O., Brodtkorb, P. A., Lee, P., McGibbon, R. T., Feldbauer, R., Lewis, S., Tygier, S., Sievert, S., Vigna, S., Peterson, S., More, S., Pudlik, T., Oshima, T., Pingel, T. J., Robitaille, T. P., Spura, T., Jones, T. R., Cera, T., Leslie, T., Zito, T., Krauss, T., Upadhyay, U., Halchenko, Y. O. &amp; Vázquez-Baeza, Y. (2020). <italic toggle="yes">Nat. Methods</italic>, <bold>17</bold>, 261–272.</mixed-citation>
    </ref>
    <ref id="bb44">
      <mixed-citation publication-type="other">Weber, S. (1997). <italic toggle="yes">J. Appl. Cryst.</italic>
<bold>30</bold>, 565–566.</mixed-citation>
    </ref>
    <ref id="bb45">
      <mixed-citation publication-type="other">Wong, S. L., Park, J.-S., Miller, M. P. &amp; Dawson, P. R. (2013). <italic toggle="yes">Comput. Mater. Sci.</italic>
<bold>77</bold>, 456–466.</mixed-citation>
    </ref>
    <ref id="bb46">
      <mixed-citation publication-type="other">Wright, J. (2005). <italic toggle="yes">ImageD11</italic>, https://github.com/FABLE-3DXRD/ImageD11/.</mixed-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig position="float" id="fig1">
    <label>Figure 1</label>
    <caption>
      <p>Illustration of <italic toggle="yes">xrd_simulator</italic> laboratory (subscript l), sample (subscript s), crystal (subscript c) and detector (subscript d) coordinates systems. The three corners of the detector (<bold>d</bold>
<sub>0</sub>, <bold>d</bold>
<sub>1</sub>, <bold>d</bold>
<sub>2</sub>) define its position and orientation in space.</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig1" position="float"/>
  </fig>
  <fig position="float" id="fig2">
    <label>Figure 2</label>
    <caption>
      <p>Illustration of a polycrystal representation in <italic toggle="yes">xrd_simulator</italic>. The tetrahedral single crystal elements form a mesh, representing a polycrystalline aggregate. Each individual tetrahedron can hold a unique lattice and phase.</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig2" position="float"/>
  </fig>
  <fig position="float" id="fig3">
    <label>Figure 3</label>
    <caption>
      <p>Example of a possible X-ray beam geometry with a total of eight nodes, <bold>b</bold>
<sub><italic toggle="yes">i</italic></sub>, forming a convex hull in 3D space. Photons propagate in the direction of <inline-formula><inline-graphic xlink:href="j-56-00282-efi8.jpg"/></inline-formula> and are linearly polarized along <inline-formula><inline-graphic xlink:href="j-56-00282-efi9.jpg"/></inline-formula>. The photon intensity inside the beam hull is uniform.</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig3" position="float"/>
  </fig>
  <fig position="float" id="fig4">
    <label>Figure 4</label>
    <caption>
      <p>A simplified 2D example of a scattering unit formed as the intersection between the X-ray beam and a single crystal element. Note that <italic toggle="yes">xrd_simulator</italic> uses 3D representations for both beam and crystals.</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig4" position="float"/>
  </fig>
  <fig position="float" id="fig5">
    <label>Figure 5</label>
    <caption>
      <p>Illustration of a single simulated diffraction peak (right) for an elliptical grain meshed by 3283 elements (left). The difference between ray tracing driven by the scattering unit centroids (A) can be compared with ray tracing driven by the detector pixels grid (B).</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig5" position="float"/>
  </fig>
  <fig position="float" id="fig6">
    <label>Figure 6</label>
    <caption>
      <p>Four Python objects – an X-ray beam, a polycrystalline sample, a detector and a sample motion – define an experiment in <italic toggle="yes">xrd_simulator</italic>. Scattering units are computed and stored in the detector object. By selecting a ray tracing and intensity model a diffraction pattern image can be rendered.</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig6" position="float"/>
  </fig>
  <fig position="float" id="fig7">
    <label>Figure 7</label>
    <caption>
      <p>Typical compute times of <italic toggle="yes">xrd_simulator</italic> for a 10 ×10  × 180 × 2048 × 2048 pencil beam raster scan simulation. Diffraction was simulated from samples with random crystal orientations [coloured by one of their Bunge Euler angles in (<italic toggle="yes">a</italic>)–(<italic toggle="yes">e</italic>)]. For samples with many elements, a reduction in compute time is observed for the simplified ray tracing model described in Section 2<xref rid="sec2" ref-type="sec"/>.8<xref rid="sec2.8" ref-type="sec"/>.</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig7" position="float"/>
  </fig>
  <fig position="float" id="fig8">
    <label>Figure 8</label>
    <caption>
      <p>Exploded view of 12 α-quartz grains measured at the ESRF ID11 beamline (<italic toggle="yes">a</italic>). A single 20 µm-thick slice featuring four distinct grains was extracted and considered for simulation (<italic toggle="yes">b</italic>).</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig8" position="float"/>
  </fig>
  <fig position="float" id="fig9">
    <label>Figure 9</label>
    <caption>
      <p>Simulated (A, B) and measured (C) log-normalized diffraction patterns from four 20 µm-thick <inline-formula><inline-graphic xlink:href="j-56-00282-efi25.jpg"/></inline-formula>–<inline-formula><inline-graphic xlink:href="j-56-00282-efi26.jpg"/></inline-formula> grain slices of α-quartz (SiO<sub>2</sub>). The diffraction pattern was integrated over a 10° sample rotation interval and is displayed with increasing levels of magnification in columns A, B and C, with the full tiled detector depicted in A1, B1 and C1. Diffraction peaks present in the true measured data which are only captured after the introduction of a random mosaicity are marked with circles. Diffraction peaks present in the simulated data but missing in the measurements are marked with squares.</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig9" position="float"/>
  </fig>
  <fig position="float" id="fig10">
    <label>Figure 10</label>
    <caption>
      <p>Phantom polycrystalline Cu–Sn aggregate composed of 120282 tetrahedral elements: (<italic toggle="yes">a</italic>) strain <italic toggle="yes">xx</italic> component, (<italic toggle="yes">b</italic>) Bunge Euler angle φ<sub>1</sub> and (<italic toggle="yes">c</italic>) Cu–Sn phase map.</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig10" position="float"/>
  </fig>
  <fig position="float" id="fig11">
    <label>Figure 11</label>
    <caption>
      <p>Simulated diffraction pattern from the phantom sample depicted in Fig. 10. Column (<italic toggle="yes">a</italic>) contains diffraction from an undeformed sample while column (<italic toggle="yes">b</italic>) depicts diffraction from a deformed version of the phantom. As a result, the diffraction peaks in the zoomed in area (<italic toggle="yes">b</italic>1) are distorted compared with the round diffraction peaks in (<italic toggle="yes">a</italic>1).</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig11" position="float"/>
  </fig>
  <fig position="float" id="fig12">
    <label>Figure 12</label>
    <caption>
      <p>Single copper (Cu) grain extracted from the phantom in Fig. 10 composed of 4195 tetrahedral elements. The top row depicts induced deformation states while the bottom row shows the corresponding <inline-formula><inline-graphic xlink:href="j-56-00282-efi27.jpg"/></inline-formula>04 reflection rendered as a 3D peak, with sample rotational position as the third dimension.</p>
    </caption>
    <graphic xlink:href="j-56-00282-fig12" position="float"/>
  </fig>
  <table-wrap position="float" id="table1">
    <label>Table 1</label>
    <caption>
      <title>Simulation parameters used to render the diffraction patterns in Fig. 11 using the Cu–Sn phantom depicted in Fig. 10</title>
    </caption>
    <table frame="hsides" rules="groups">
      <tbody valign="top">
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Detector distance (µm)</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">191023.9164</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Detector centre pixel <italic toggle="yes">z</italic>
</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">1024.2345</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Detector centre pixel <italic toggle="yes">y</italic>
</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">1023.1129</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Pixel side length <italic toggle="yes">z</italic> (µm)</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">50.4234</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Pixel side length <italic toggle="yes">y</italic> (µm)</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">48.2343</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Number of detector pixels <italic toggle="yes">z</italic>
</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">2048</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Number of detector pixels <italic toggle="yes">y</italic>
</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">2048</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Wavelength (Å)</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">0.18</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Beam side length <italic toggle="yes">z</italic> (µm)</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">400 </td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Beam side length <italic toggle="yes">y</italic> (µm)</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">400 </td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Rotation step (1.0°)</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">1.0</td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Rotation axis</td>
          <td rowspan="1" colspan="1" align="left" char="." charoff="21" valign="top">[0 0 1]</td>
        </tr>
      </tbody>
    </table>
  </table-wrap>
</floats-group>
