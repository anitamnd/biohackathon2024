<?all-math-mml yes?>
<?use-mml?>
<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD with MathML3 v1.2 20190208//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1-mathml3.dtd?>
<?SourceDTD.Version 1.2?>
<?ConverterInfo.XSLTName nihms2pmcx2.xsl?>
<?ConverterInfo.Version 1?>
<?properties manuscript?>
<?origin nihpa?>
<?iso-abbr Nat Methods?>
<?submitter-system nihms?>
<?submitter-canonical-name Nature Publishing Group?>
<?submitter-canonical-id NATURE-STRUCTUR?>
<?submitter-userid 8068858?>
<?submitter-authority myNCBI?>
<?submitter-login nature-structure?>
<?submitter-name Nature Publishing Group?>
<?domain nihpa?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-journal-id">101215604</journal-id>
    <journal-id journal-id-type="pubmed-jr-id">32338</journal-id>
    <journal-id journal-id-type="nlm-ta">Nat Methods</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Methods</journal-id>
    <journal-title-group>
      <journal-title>Nature methods</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1548-7091</issn>
    <issn pub-type="epub">1548-7105</issn>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">8183613</article-id>
    <article-id pub-id-type="pmid">33542510</article-id>
    <article-id pub-id-type="doi">10.1038/s41592-020-01049-4</article-id>
    <article-id pub-id-type="manuscript">nihpa1656428</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>CryoDRGN: Reconstruction of heterogeneous cryo-EM structures using neural networks</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Zhong</surname>
          <given-names>Ellen D.</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Bepler</surname>
          <given-names>Tristan</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Berger</surname>
          <given-names>Bonnie</given-names>
        </name>
        <xref ref-type="aff" rid="A2">2</xref>
        <xref ref-type="aff" rid="A3">3</xref>
        <xref rid="CR1" ref-type="corresp">*</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Davis</surname>
          <given-names>Joseph H.</given-names>
        </name>
        <xref ref-type="aff" rid="A1">1</xref>
        <xref ref-type="aff" rid="A4">4</xref>
        <xref rid="CR1" ref-type="corresp">*</xref>
      </contrib>
    </contrib-group>
    <aff id="A1"><label>1</label>Computational and Systems Biology, Massachusetts Institute of Technology, Cambridge, Massachusetts, USA</aff>
    <aff id="A2"><label>2</label>Computer Science and Artificial Intelligence Laboratory, Massachusetts Institute of Technology, Cambridge, Massachusetts, USA</aff>
    <aff id="A3"><label>3</label>Department of Mathematics, Massachusetts Institute of Technology, Cambridge, Massachusetts, USA</aff>
    <aff id="A4"><label>4</label>Department of Biology, Massachusetts Institute of Technology, Cambridge, Massachusetts, USA</aff>
    <author-notes>
      <fn fn-type="con" id="FN1">
        <p id="P1">Author Contributions</p>
        <p id="P2">All authors conceived of the work and developed the method. EZ implemented the software and performed the experiments. EZ, BB, and JD wrote the manuscript.</p>
      </fn>
      <corresp id="CR1"><label>*</label>Corresponding author. <email>bab@mit.edu</email>; <email>jhdavis@mit.edu</email></corresp>
    </author-notes>
    <pub-date pub-type="nihms-submitted">
      <day>14</day>
      <month>1</month>
      <year>2021</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>04</day>
      <month>2</month>
      <year>2021</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <month>2</month>
      <year>2021</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>04</day>
      <month>8</month>
      <year>2021</year>
    </pub-date>
    <volume>18</volume>
    <issue>2</issue>
    <fpage>176</fpage>
    <lpage>185</lpage>
    <!--elocation-id from pubmed: 10.1038/s41592-020-01049-4-->
    <permissions>
      <license>
        <ali:license_ref xmlns:ali="http://www.niso.org/schemas/ali/1.0/">http://www.nature.com/authors/editorial_policies/license.html#terms</ali:license_ref>
        <license-p>Users may view, print, copy, and download text and data-mine the content in such documents, for the purposes of academic research, subject always to the full Conditions of use:<uri xlink:href="http://www.nature.com/authors/editorial_policies/license.html#terms">http://www.nature.com/authors/editorial_policies/license.html#terms</uri></license-p>
      </license>
    </permissions>
    <abstract id="ABS1">
      <p id="P3">Cryo-EM single-particle analysis has proven powerful in determining the structures of rigid macromolecules. However, many imaged protein complexes exhibit complex conformational and compositional heterogeneity that pose a major challenge to existing 3D reconstruction methods. Here, we present cryoDRGN, an algorithm that leverages the representation power of deep neural networks to directly reconstruct continuous distributions of 3D density maps and map per-particle heterogeneity of single particle cryo-EM datasets. Using cryoDRGN, we uncovered residual heterogeneity in high-resolution datasets of the 80S ribosome and the RAG complex, revealed a new structural state of the assembling 50S ribosome, and visualized large-scale continuous motions of a spliceosome complex. CryoDRGN contains interactive tools to visualize a dataset’s distribution of per-particle variability, generate density maps for exploratory analysis, extract particle subsets for use with other tools, and generate trajectories to visualize molecular motions. CryoDRGN is open-source software freely available at <ext-link ext-link-type="uri" xlink:href="http://cryodrgn.csail.mit.edu/">cryodrgn.csail.mit.edu</ext-link>.</p>
    </abstract>
    <kwd-group>
      <kwd>cryo-electron microscopy</kwd>
      <kwd>macromolecular complexes</kwd>
      <kwd>structural biology</kwd>
      <kwd>machine learning</kwd>
      <kwd>software</kwd>
    </kwd-group>
  </article-meta>
</front>
<body>
  <sec id="S1">
    <title>Introduction</title>
    <p id="P4">Proteins and their complexes are dynamic macromolecular machines that carry out the essential biological processes responsible for life. Although the mechanism of these macromolecular machines is often deduced from a static three-dimensional (3D) structure, a more complete understanding could be achieved if one could analyze the full distribution of conformations relevant to function.</p>
    <p id="P5">Single particle cryo-electron microscopy (cryo-EM) is a rapidly maturing method for high-resolution structure determination of large macromolecular complexes<sup><xref rid="R1" ref-type="bibr">1</xref>,<xref rid="R2" ref-type="bibr">2</xref></sup>. Major advances in hardware<sup><xref rid="R3" ref-type="bibr">3</xref>–<xref rid="R5" ref-type="bibr">5</xref></sup> and software<sup><xref rid="R4" ref-type="bibr">4</xref>–<xref rid="R9" ref-type="bibr">9</xref></sup> have streamlined the collection and analysis of cryo-EM datasets such that structures of rigid macromolecules can routinely be solved at near-atomic resolution<sup><xref rid="R10" ref-type="bibr">10</xref>,<xref rid="R11" ref-type="bibr">11</xref></sup>. Increasingly, cryo-EM has been applied to study heterogeneous complexes as the experimental procedure is less sensitive to sample heterogeneity than other methods for structure determination<sup><xref rid="R12" ref-type="bibr">12</xref>,<xref rid="R13" ref-type="bibr">13</xref></sup>. Additionally, because single particle cryo-EM can capture millions of snapshots of the molecule of interest, each carrying a unique molecule in its own conformational state<sup><xref rid="R14" ref-type="bibr">14</xref></sup>, cryo-EM holds promise in revealing the conformational landscape of dynamic macromolecular complexes. However, reconstructing ensembles of 3D volumes from such snapshots remains a major computational challenge.</p>
    <p id="P6">Existing tools for heterogeneous reconstruction make often-limiting assumptions on the observed structural heterogeneity. Most commonly, heterogeneity is modeled as though it originates from a small number of independent, <italic>discrete</italic> states, implemented as “3D classification” or “heterogeneous refinement” in many cryo-EM software packages<sup><xref rid="R15" ref-type="bibr">15</xref>–<xref rid="R18" ref-type="bibr">18</xref></sup>. However, these discrete classification approaches require specifying initial models for refinement, and because the number and nature of the underlying structural states is unknown <italic>a priori</italic>, this approach is error-prone and often results in the omission of potentially relevant structures. More critically, such discrete approaches are ill-suited for reconstructing structures undergoing <italic>continuous</italic> conformational changes.</p>
    <p id="P7">Advanced methods for heterogeneous reconstruction seek to more closely model the continuous nature of flexible molecules. Multi-body refinement, available in RELION, models the structure as the sum of user-defined rigid bodies that are allowed to rotate relative to one another, placing structural assumptions on the observed heterogeneity<sup><xref rid="R19" ref-type="bibr">19</xref></sup>. Continuous heterogeneity has also been described using principle component analysis (PCA)-based approaches<sup><xref rid="R20" ref-type="bibr">20</xref>–<xref rid="R22" ref-type="bibr">22</xref></sup>, including the recent 3D Variability Analysis (3DVA) algorithm available in cryoSPARC<sup><xref rid="R23" ref-type="bibr">23</xref></sup>. Although the linear subspace model of these approaches can provide a summary of the overall variability within the dataset, the visualized heterogeneity contains artifacts when a molecule’s conformational deformations are poorly approximated by linear interpolations along basis volumes. In the manifold embedding approach proposed in <italic>Dashti et al.</italic><sup><xref rid="R24" ref-type="bibr">24</xref>,<xref rid="R25" ref-type="bibr">25</xref></sup>, heterogeneous structures are recovered by binning particles along the data manifold followed by traditional homogeneous reconstruction. Additional algorithms for continuous heterogeneous reconstruction have been shown on synthetic datasets<sup><xref rid="R26" ref-type="bibr">26</xref>,<xref rid="R27" ref-type="bibr">27</xref></sup>.</p>
    <p id="P8">Here, we present cryoDRGN (Deep Reconstructing Generative Networks), a method for heterogeneous cryo-EM reconstruction based on deep neural networks. We hypothesized that neural networks, which are known for their ability to model complex, nonlinear functions<sup><xref rid="R28" ref-type="bibr">28</xref></sup>, could learn heterogeneous ensembles of cryo-EM density maps. We first show that our neural network representation of structure can model single density maps at high resolution, before demonstrating the full cryoDRGN framework for unsupervised heterogeneous reconstruction.</p>
    <p id="P9">We find that cryoDRGN is a powerful and general approach for analyzing structural heterogeneity in macromolecular complexes of varying size and expected sources of heterogeneity. We show that the cryoDRGN approach can uncover residual heterogeneity in “homogeneous” datasets of the RAG1-RAG2 complex and the 80S ribosome, model large compositional changes of the assembling 50S ribosome, and continuous conformational changes of the precatalytic spliceosome. Remarkably, cryoDRGN’s unsupervised approach for representation learning can readily identify and filter impurities in the dataset and can identify rare structural states containing as few as ~1,000 particles. CryoDRGN is distributed as an open-source tool that can be easily integrated in existing pipelines and is freely available at <ext-link ext-link-type="uri" xlink:href="http://cryodrgn.csail.mit.edu/">cryodrgn.csail.mit.edu</ext-link>.</p>
  </sec>
  <sec id="S2">
    <title>Results</title>
    <sec id="S3">
      <title>The cryoDRGN method</title>
      <p id="P10">CryoDRGN performs heterogeneous reconstruction by learning a deep generative model of 3D structure from single particle cryo-EM images. The method consists of a specialized image encoder – volume decoder architecture, which learns an encoding of 2D particle images into a continuous vector space described by the latent variable <italic>z</italic> ∈ ℝ<sup><italic>n</italic></sup> (<italic>i.e.</italic> the latent space), and the concomitant reconstruction of 3D cryo-EM density maps from this latent space representation (<xref rid="F1" ref-type="fig">Fig 1A</xref>). This choice of model assumes that the heterogeneous structures can be embedded within a continuous, low-dimensional manifold in the latent space, where the dimensionality of the latent space is defined by the user. The model is specified in the Fourier domain in order to relate 2D images as planar slices of the 3D volume<sup><xref rid="R29" ref-type="bibr">29</xref></sup>, whose orientation is previously determined from a consensus reconstruction. The neural networks are jointly trained from random initialization using stochastic gradient descent on an objective function that seeks to maximize (a variational upper bound on) the data likelihood as in standard Variational Autoencoders (VAEs)<sup><xref rid="R30" ref-type="bibr">30</xref></sup>. Additional architectural and training details of cryoDRGN are provided in the <xref rid="S15" ref-type="sec">Methods</xref> section.</p>
      <p id="P11">After training, the output of cryoDRGN analysis includes: 1) per-particle latent encodings, <italic>z</italic><sub><italic>i</italic></sub>, describing the dataset’s heterogeneity; and 2) a neural network model of 3D density maps that can directly reconstruct a density map given <italic>z</italic><sub><italic>i</italic></sub>. Specifically, the encoder network encodes particle images into the continuous latent space, which allows for visualization and inspection of the particle distribution (<xref rid="F1" ref-type="fig">Fig. 1B</xref>, <bold>center</bold>). The trained decoder network can then generate 3D density maps given arbitrary values of the latent variable. For example, representative structures can be generated from regions of latent space with high particle density, and continuous conformational trajectories can be reconstructed by sampling points along a trajectory through latent space (<xref rid="F1" ref-type="fig">Fig. 1B</xref>, <bold>right</bold>). Notably, any cryoDRGN-generated volume can be orthogonally validated by traditional reconstruction approaches<sup><xref rid="R15" ref-type="bibr">15</xref></sup> using nearby particles in the latent space (<xref rid="F1" ref-type="fig">Fig. 1B</xref>, <bold>left</bold>). Lastly, any regions of the latent space that are enriched in impurities or imaging artifacts may be selected, and the encompassed particles filtered from subsequent analysis (<xref rid="F1" ref-type="fig">Fig. 1B</xref>, <bold>left</bold>).</p>
    </sec>
    <sec id="S4">
      <title>Neural networks can represent cryo-EM density maps</title>
      <p id="P12">We first evaluated the cryoDRGN volume decoder in representing high resolution cryo-EM density maps. To learn the homogeneous structure of the RAG1-RAG2 signal end complex (RAG – 369 kDa)<sup><xref rid="R31" ref-type="bibr">31</xref></sup> and the <italic>Plasmodium falciparum</italic> 80S ribosome (<italic>Pf</italic>80S – 4.2 MDa)<sup><xref rid="R32" ref-type="bibr">32</xref></sup>, we trained the volume decoder network with no latent variable input, using image poses obtained from C1 homogeneous refinements in cryoSPARC<sup><xref rid="R16" ref-type="bibr">16</xref></sup> (<xref rid="S15" ref-type="sec">Methods</xref>). Trained on full-resolution images, the cryoDRGN decoder produced structures that correlated with the traditional, voxel-based reconstruction (<xref rid="F2" ref-type="fig">Fig. 2A</xref>) at resolutions up to 3.6 Å for RAG and 3.9 Å for <italic>Pf</italic>80S at an FSC = 0.5 threshold (<xref rid="F2" ref-type="fig">Fig. 2B</xref>), demonstrating the efficacy of this neural-network based representation of 3D structure.</p>
      <p id="P13">As neural networks have a fixed capacity for representation that is constrained by their architecture, we next compared decoder architectures of different sizes to evaluate the tradeoff between representation power and training speed. We found that larger architectures, which have more trainable parameters, result in density maps that correlate with the traditionally reconstructed map at higher resolutions (<xref rid="F2" ref-type="fig">Fig. 2B</xref>). The networks are trained through multiple passes through the dataset (<italic>i.e.</italic> epochs) (<xref rid="F2" ref-type="fig">Fig. 2C</xref>) with lower values of the objective function (<xref rid="F2" ref-type="fig">Fig. 2D</xref>) as training progressed. Notably, while the resolution of the learned structure increased with neural network size, we found that larger models were slower to train (<xref rid="F2" ref-type="fig">Fig. 2E</xref>). These tradeoffs suggest that the architecture and image size should be tuned to suit the desired balance of speed and achievable resolution. Lastly, we found that the cryoDRGN architecture was capable of learning density maps at sufficiently high resolution to visualize structural features such as bulky side-chains that are consistent with our FSC-based resolution estimates (<xref rid="F2" ref-type="fig">Fig. 2F</xref>).</p>
    </sec>
    <sec id="S5">
      <title>CryoDRGN models both discrete and continuous structural heterogeneity</title>
      <p id="P14">We next sought to evaluate the complete cryoDRGN framework for heterogeneous reconstruction using simulated datasets (<xref rid="F3" ref-type="fig">Fig 3A</xref>,<xref rid="F3" ref-type="fig">B</xref>). Datasets modelling continuous heterogeneity were produced by rotating a single dihedral angle of a hypothetical protein complex to simulate a conformational transition along a 1-dimensional reaction coordinate. Single particle cryo-EM images were then simulated either: uniformly along this reaction coordinate (<italic>Uniform</italic>); with bias towards particular conformations exemplary of cooperative transitions (<italic>Cooperative</italic>); or with strong bias leading to unobserved transition states (<italic>Noncontiguous</italic>). A dataset simulating discrete compositional heterogeneity was produced by mixing particles of the bacterial 30S, 50S, and 70S ribosome (<italic>Compositional</italic>). We then provided each of these four simulated datasets and their corresponding poses to cryoDRGN and trained a 1-D latent variable model (<xref rid="S15" ref-type="sec">Methods</xref>).</p>
      <p id="P15">We found that cryoDRGN was capable of reconstructing both continuous and discrete heterogeneous ensembles (<xref rid="F3" ref-type="fig">Fig. 3C</xref>–<xref rid="F3" ref-type="fig">H</xref>). On the <italic>Uniform</italic> conformational heterogeneity dataset, cryoDRGN reconstructed density maps that reproduced the ground truth continuous motion of the complex (<xref rid="F3" ref-type="fig">Fig. 3C</xref>). When trained on the <italic>Compositional</italic> dataset, cryoDRGN reconstructed density maps of the 30S, 50S, and 70S ribosomes at distinct values of the latent variable (<xref rid="F3" ref-type="fig">Fig. 3D</xref>).</p>
      <p id="P16">In addition to reconstructing heterogeneous density maps, cryoDRGN produces a latent encoding for each particle that can be compared to the ground truth reaction coordinate (<xref rid="F3" ref-type="fig">Fig. 3E</xref>–<xref rid="F3" ref-type="fig">H</xref>). For the datasets with continuous conformational changes, the latent encoding of each image correlated with position along the reaction coordinate given by the dihedral angle of the underlying model (Spearman r = −0.996, 0.992, and 0.988 for <italic>Uniform, Cooperative,</italic> and <italic>Noncontiguous</italic>, respectively) (<xref rid="F3" ref-type="fig">Fig. 3E</xref>). We observed that the qualitative features of the distribution of latent encodings matched the ground truth, with three modes in the latent encoding distribution for the <italic>Cooperative</italic> dataset (<xref rid="F3" ref-type="fig">Fig. 3F</xref>) and distinct clusters for the <italic>Noncontiguous</italic> and <italic>Compositional</italic> datasets (<xref rid="F3" ref-type="fig">Fig. 3G</xref>, <xref rid="F3" ref-type="fig">H</xref>). We note that, in general, the parameterization of a reaction coordinate is non-unique (e.g. when described by the learned latent variable or by dihedral angle, leading to different marginal distributions in <xref rid="F3" ref-type="fig">Fig. 3E</xref>). To quantitatively assess that cryoDRGN has learned the correct distribution of <italic>structures</italic>, we compute a “per-image” FSC, which compares reconstructed density maps with the ground-truth on images across the reaction coordinate (<xref rid="S15" ref-type="sec">Methods</xref>), and found that the reconstructed structures of all four datasets correlated well with the ground truth distribution (<xref rid="F3" ref-type="fig">Fig. 3C</xref>, <xref rid="F7" ref-type="fig">Extended Data Fig. 1</xref>).</p>
    </sec>
    <sec id="S6">
      <title>CryoDRGN uncovers residual heterogeneity from “homogeneous” cryo-EM datasets</title>
      <p id="P17">We next evaluated cryoDRGN’s ability to perform heterogeneous reconstruction on real cryo-EM datasets of the RAG complex<sup><xref rid="R31" ref-type="bibr">31</xref></sup> and the <italic>Pf</italic>80S<sup><xref rid="R32" ref-type="bibr">32</xref></sup> ribosome from above. Ru <italic>et al.</italic> reported RAG complex structures from two distinct datasets – the “signal end complex”, which failed to resolve the distal ends of the 12-RSS and 23-RSS DNA elements or the nonamer binding domain (NBD) of RAG-1; and the “paired complex”, which resolved these elements at sufficient resolution for atomic model building (<xref rid="F4" ref-type="fig">Fig. 4A</xref>). To test whether cryoDRGN could newly uncover heterogeneity of these distal elements in the “signal end complex”, we trained a cryoDRGN 10-D latent variable model on the deposited particle images (EMPIAR-10049)<sup><xref rid="R31" ref-type="bibr">31</xref></sup>. We found that cryoDRGN revealed significant heterogeneity of the 12-RSS, 23-RSS, and NBD (<xref rid="F4" ref-type="fig">Fig. 4B</xref>). In addition to maps that only resolve the symmetric core (light grey in <xref rid="F4" ref-type="fig">Fig. 4B</xref>), cryoDRGN revealed structures with RSS positioning that aligns with the canonical conformation found in the “paired complex” atomic model<sup><xref rid="R31" ref-type="bibr">31</xref></sup> (dark blue), tilting of the RSS strands (light blue), linear 23-RSS DNA (purple), as well as the presence (yellow) and absence (coral) of the NBD. These representative maps were selected out of a large ensemble of generated structures (<xref rid="S15" ref-type="sec">Methods</xref>) from different regions of the latent space (<xref rid="F4" ref-type="fig">Fig. 4C</xref>). A trajectory sampling from the continuous distribution modeled by cryoDRGN is shown in <xref rid="SD2" ref-type="supplementary-material">Supplementary Video 1</xref>. To validate the presence of these heterogeneous states in the dataset, we performed heterogeneous 3D refinement in cryoSPARC<sup><xref rid="R16" ref-type="bibr">16</xref></sup> using the cryoDRGN density maps as initial models, which reproduced the heterogeneity of the RSS elements (<xref rid="F8" ref-type="fig">Extended Data Fig. 2</xref>). Subsequent work by Ru <italic>et al.</italic> suggested that the conformational dynamics and asymmetric positioning of the 12- and 23-RSS by NBD in the pre-cleavage form are fundamental to the structural mechanism underlying the 12–23 rule of V(D)J recombination<sup><xref rid="R33" ref-type="bibr">33</xref></sup>. Our results newly demonstrate that such heterogeneity is also present in the post-cleavage “signal end” RAG complex.</p>
      <p id="P18">When analyzing a homogeneous reconstruction of the <italic>Pf</italic>80S ribosome, Wong <italic>et al.</italic> observed flexibility in the small subunit head region and missing density for peripheral rRNA expansion segment elements<sup><xref rid="R32" ref-type="bibr">32</xref></sup>. To explore if this unresolved density resulted from residual heterogeneity, we trained a cryoDRGN 10-D latent variable model on their deposited dataset (EMPIAR-10028)<sup><xref rid="R32" ref-type="bibr">32</xref></sup> and reconstructed an ensemble of density maps that not only contained structures consistent with the homogeneous reconstruction, but also revealed rotation of the 40S small subunit (SSU) (<xref rid="F4" ref-type="fig">Fig. 4D</xref>), heterogeneity within the SSU head (<xref rid="F9" ref-type="fig">Extended Data Fig. 3</xref>), and motion of many peripheral rRNA expansion segments (<xref rid="SD3" ref-type="supplementary-material">Supplementary Video 2</xref>). By visualizing a representative 40S rotated and unrotated density map, we found that cryoDRGN was able to simultaneously capture the large-scale inter-subunit rotation and coordinated smaller-scale structural rearrangements, including motion of the L1 stalk, disappearance of an rRNA helix, and the disappearance of the inter-subunit bridge formed by the C-terminal helix of eL8, which is consistent with Sun <italic>et al.</italic>’s characterization of <italic>Pf</italic>80S dynamics<sup><xref rid="R34" ref-type="bibr">34</xref></sup> (<xref rid="F4" ref-type="fig">Fig 4D</xref>).</p>
      <p id="P19">We then visualized the 10-D latent space representation of the <italic>Pf</italic>80S particles with PCA (<xref rid="F4" ref-type="fig">Fig. 4E</xref>) and with Uniform Manifold Approximate and Projection (UMAP)<sup><xref rid="R35" ref-type="bibr">35</xref></sup> (<xref rid="F10" ref-type="fig">Extended Data Fig. 4</xref>). The 40S rotated density map originated from a region of the particle distribution separated along the first PC of the latent space. To validate the presence of this state, we extracted 4,889 particles constituting the outlying cluster (<xref rid="S15" ref-type="sec">Methods</xref>). Traditional homogeneous reconstruction of these particles in cryoSPARC produced a 6.4 Å reconstruction of the rotated 40S state consistent with the cryoDRGN structure (<xref rid="F10" ref-type="fig">Extended Data Fig. 4</xref>). Additionally, by sampling many density maps from the latent space, we observed that structures with density missing from the SSU head group were located within a subregion of the main cluster of the UMAP visualization (<xref rid="F9" ref-type="fig">Extended Data Fig. 3</xref>). We hypothesize that the 40S rotated state appears as a visually distinct cluster because more mass changes to rotate the entire 40S subunit, as opposed to the missing SSU head group state, which involves changes in a smaller region of the 40S subunit.</p>
    </sec>
    <sec id="S7">
      <title>CryoDRGN automatically partitions assembly states of the bacterial ribosome</title>
      <p id="P20">Next, we sought to evaluate cryoDRGN on a highly heterogeneous cryo-EM dataset of the <italic>E. coli</italic> large ribosomal subunit (LSU) undergoing assembly (EMPIAR-10076)<sup><xref rid="R12" ref-type="bibr">12</xref></sup>. This dataset is known to contain substantial compositional and conformational heterogeneity; In the original analysis, multiple expert-guided rounds of hierarchical 3D classification resulted in 13 discrete structures that were grouped into 4 major assembly states. Here, we aimed to assess if cryoDRGN could automatically reveal these heterogeneous states without user-guided 3D classification.</p>
      <p id="P21">As initial pilot experiments, we first trained 1-D and 10-D latent variable models on downsampled images of the dataset (<xref rid="S15" ref-type="sec">Methods</xref>). The dataset’s latent space representation exhibited distinct peaks in the 1-D case or clusters in the 10-D case when visualized with UMAP<sup><xref rid="R35" ref-type="bibr">35</xref></sup> (<xref rid="F5" ref-type="fig">Fig. 5A</xref>,<xref rid="F5" ref-type="fig">B</xref>) that correspond to the major assembly states when grouped by the published 3D classification labels (<xref rid="F5" ref-type="fig">Fig. 5C</xref>,<xref rid="F5" ref-type="fig">D</xref>). As the particles were obtained by crudely fractionating a lysate in order to capture the full ensemble of cellular assembly intermediates, a substantial fraction of the published particle stack corresponds to 30S or non-ribosomal impurities. These unassigned particles were outliers in the latent representation (<xref rid="F5" ref-type="fig">Fig 5C</xref>, <xref rid="F11" ref-type="fig">Extended Data Fig. 5</xref>), and neither 2D class averages nor a traditional 3D reconstruction of these particles produced structures consistent with assembling LSU ribosomes (<xref rid="F11" ref-type="fig">Extended Data Fig. 5</xref>). As we did not wish to devote representation capacity of the cryoDRGN neural networks in modelling these impurities, we used the latent representation to filter the dataset before further analysis, taking the intersection of the particle stack after filtering based on the 1-D and 10-D latent variable model (<xref rid="S15" ref-type="sec">Methods</xref>).</p>
      <p id="P22">To explore the heterogeneity within the LSU assembly states, we trained a cryoDRGN 10-D latent variable model on the remaining images at higher resolution (<xref rid="S15" ref-type="sec">Methods</xref>). The decoder network reconstructed density maps matching the reported major (<xref rid="F5" ref-type="fig">Fig. 5E</xref>) and minor (<xref rid="F12" ref-type="fig">Extended Data Fig. 6</xref>) assembly states of the LSU. We visualized the encodings of particle images in the 10-D latent space with UMAP and observed clusters corresponding to the major (<xref rid="F5" ref-type="fig">Fig. 5F</xref>) and minor states (<xref rid="F5" ref-type="fig">Fig. 5G</xref>, <xref rid="F12" ref-type="fig">Extended Data Fig. 6</xref>) of LSU assembly after coloring by the published 3D classification. From the latent representation, we also noted a clearly separated cluster of particles assigned to class A, and structures sampled from this region of latent space reconstructed the 70S ribosome, an impurity in the dataset (<xref rid="F5" ref-type="fig">Fig. 5H</xref>). Finally, we identified a small cluster of ~1,100 particles adjacent to the class C cluster whose particles were originally classified into class E (<xref rid="F5" ref-type="fig">Fig. 5F</xref>, <bold>inset</bold>). The density map reconstructed by the decoder from this region revealed a previously unreported assembly intermediate that we newly define as class C4 (<xref rid="F5" ref-type="fig">Fig. 5I</xref>). Like the other class C structures, class C4 lacked the central protuberance, but possessed clearly resolved density for rRNA helix 68, which was only present in the mature E4 and E5 classes from Davis <italic>et al.</italic><sup><xref rid="R12" ref-type="bibr">12</xref></sup> Traditional homogeneous reconstruction of the particle images constituting this cluster reproduced a similar, albeit lower-resolution structure, which confirmed the existence of this structural state in the original dataset (<xref rid="F13" ref-type="fig">Extended Data Fig. 7</xref>). We found that the cryoDRGN latent representation is highly reproducible across replicates (<xref rid="F14" ref-type="fig">Extended Data Fig. 8</xref>). CryoDRGN experiments and runtimes are summarized in <xref rid="F5" ref-type="fig">Figure 5J</xref>. In addition to illustrating cryoDRGN’s ability to model extremely heterogeneous datasets without user-driver classification, this analysis further demonstrated that cryoDRGN can identify novel and rare (~1% of all particles) structural classes that would likely be overlooked by traditional hierarchical classification.</p>
    </sec>
    <sec id="S8">
      <title>CryoDRGN reveals dynamic continuous motions in the pre-catalytic spliceosome</title>
      <p id="P23">Finally, to assess cryoDRGN’s ability to model large continuous conformational changes, we reanalyzed a dataset of the pre-catalytic spliceosome (EMPIAR-10180)<sup><xref rid="R36" ref-type="bibr">36</xref></sup>. Using extensive, expert-guided focused classifications, Plaschka <italic>et al.</italic> reconstructed a composite map for this complex and suggested that the complex sampled a continuum of conformations with large motions of the SF3b subcomplex<sup><xref rid="R36" ref-type="bibr">36</xref></sup>. In our analysis, we first trained a 10-D latent variable model on the downsampled images using image poses derived from a consensus reconstruction (<xref rid="S15" ref-type="sec">Methods</xref>). Multiple clusters were observed in the latent space encodings of the dataset’s particle images (<xref rid="F6" ref-type="fig">Fig. 6A</xref>). In sampling structures from the latent space, the generated density maps revealed expected spliceosome conformations from the largest cluster, poorly resolved structures likely due to imaging artifacts from the leftmost cluster, structures lacking density for the SF3b subcomplex from a third cluster, and extra density of the U2 core, which is thought to be highly dynamic<sup><xref rid="R13" ref-type="bibr">13</xref></sup>, from the uppermost cluster (<xref rid="F6" ref-type="fig">Fig. 6B</xref>). To focus our analysis on bone-fide pre-catalytic spliceosome particles, we leveraged the latent space representation to eliminate any particles that mapped to the undesired clusters from two replicate runs (<xref rid="S15" ref-type="sec">Methods</xref>).</p>
      <p id="P24">With the filtered particle stack, we trained a 10-D model on higher resolution images and visualized the dataset’s latent encodings in 2-D using PCA (<xref rid="F6" ref-type="fig">Fig. 6C</xref>). The visualized data manifold was unfeatured, consistent with a molecule undergoing non-cooperative conformational changes. By generating structures along the first principal component of the latent space encodings, we reconstructed a trajectory of the SF3b and helicase subcomplexes in motion, smoothly transitioning from an elongated state to one compressed against the body of the spliceosome (<xref rid="F6" ref-type="fig">Fig. 6D</xref>). This large scale-motion is consistent with motions derived from the first principal component of rigid body orientations from multi-body analysis (<xref rid="F15" ref-type="fig">Extended Data Fig. 9</xref>) and in the first principal component of 3DVA’s linear subspace model (<xref rid="F16" ref-type="fig">Extended Data Fig 10</xref>). A similar traversal along the second PC produced a continuous trajectory of the SF3b and helicase subcomplexes moving in opposition (<xref rid="SD1" ref-type="supplementary-material">Supplementary Fig. 1</xref>, <xref rid="SD6" ref-type="supplementary-material">Supplementary Video 4</xref>). The anticorrelated motion of the SF3b and helicase subcomplexes in PC2, together with their correlated motion in PC1, suggests that the two domains move independently in the imaged ensemble. Finally, although trajectories along latent space PCs provide a summary of the extent of variability in the structure, cryoDRGN can also generate structures at arbitrary points from the latent space. By traversing along the nearest neighbor graph of the latent encodings and generating structures at the visited nodes, cryoDRGN generated a plausible trajectory of the conformations adopted by the pre-catalytic spliceosome (<xref rid="SD6" ref-type="supplementary-material">Supplementary Video 4</xref>), highlighting the potential of single particle cryo-EM to uncover the conformational dynamics of molecular machines.</p>
    </sec>
  </sec>
  <sec id="S9">
    <title>Discussion</title>
    <p id="P25">This work introduces cryoDRGN, a method using neural networks to reconstruct 3D density maps from heterogeneous single particle cryo-EM datasets. The power of this approach lies in its ability to represent heterogeneous structures without simplifying assumptions on the type of heterogeneity. In principle, cryoDRGN is able to represent any distribution of structures that can be approximated by a deep neural network, a broad class of function approximators for continuous, nonlinear functions<sup><xref rid="R28" ref-type="bibr">28</xref></sup>. This flexibility contrasts with existing methods that impose limiting assumptions on the types of structural heterogeneity present in the sample. For example, 3D classification assumes a mixture of discrete structural classes; multibody refinement assumes conformational changes are composed of user-defined rigid-body motions; and 3DVA assumes that heterogeneity is generated from linear combinations of density maps. Although these approaches have proven useful, their model for heterogeneity is often mismatched with the true structural heterogeneity in many systems, and thus can introduce bias into reconstructions. In contrast, we empirically show that the cryoDRGN architecture can model both discrete compositional heterogeneity and continuous conformational changes without the aforementioned structural assumptions. For example, we discovered heterogeneous states of the RAG complex and <italic>Pf</italic>80S ribosome that were originally averaged out of the homogeneous reconstruction. When analyzing the assembling <italic>E. Coli</italic> LSU dataset, cryoDRGN learned an ensemble of LSU assembly states without <italic>a priori</italic> specification of the number of states or initial models as is required for 3D classification. Finally, when analyzing the pre-catalytic spliceosome, we found that the continuous conformational changes reconstructed by cryoDRGN lacked the rigid-body boundary artifacts from multibody refinement’s mask-based approach<sup><xref rid="R19" ref-type="bibr">19</xref></sup> (<xref rid="F15" ref-type="fig">Extended Data Fig. 9</xref>) or linear interpolation artifacts from 3DVA’s linear subspace model<sup><xref rid="R23" ref-type="bibr">23</xref></sup> (<xref rid="F16" ref-type="fig">Extended Data Fig. 10</xref>).</p>
    <sec id="S10">
      <title>Interpretation of the latent space</title>
      <p id="P26">A key feature of cryoDRGN is its ability to provide a low-dimensional representation of the dataset’s heterogeneity given by each particle’s latent encoding. Subject to optimization, cryoDRGN organizes the latent space such that structurally related particles are in close proximity. In simulated and real datasets, we find that continuous motions are embedded along a continuum in latent space (<xref rid="F3" ref-type="fig">Fig. 3E</xref>–<xref rid="F3" ref-type="fig">G</xref>, <xref rid="F6" ref-type="fig">6C</xref>) and that compositionally distinct states manifest as clusters (<xref rid="F3" ref-type="fig">Fig. 3H</xref>, <xref rid="F5" ref-type="fig">5F</xref>). These empirical results demonstrate that visualization of the distribution of latent encodings can be informative in exploring the structural heterogeneity within the imaged ensemble, and even suggest a possible interpretation of the latent space as a pseudo-conformational landscape. However, we note that cryoDRGN’s objective function aims only to reproduce the distribution of <italic>structures</italic> and does not guarantee that the latent space layout (or its 2D visualization) will produce interpretable features of the underlying energy landscape. Furthermore, structures reconstructed from unoccupied regions of the latent space will not in general correspond to true physical structures, as cryoDRGN optimizes the likelihood of the observed data and these structures are not observed.</p>
      <p id="P27">Finally, in real datasets, there may exist images that do not originate from the standard single particle image formation model, for example, false positives encountered during particle picking. We demonstrated the utility of the latent space representation in identifying such impurities, ice artifacts, and other out-of-distribution particle images that may be filtered out in subsequent analyses (<xref rid="F5" ref-type="fig">Fig. 5A</xref>–<xref rid="F5" ref-type="fig">D</xref>, <xref rid="F6" ref-type="fig">6A</xref>).</p>
      <p id="P28">We emphasize that different datasets have diverse sources of heterogeneity, and thus the interpretation of the cryoDRGN latent space is highly dataset-dependent. We provide interactive analysis tools in the cryoDRGN software for exploring the learned latent space.</p>
    </sec>
    <sec id="S11">
      <title>Visualizing structural trajectories</title>
      <p id="P29">In addition to encoding particles in an unsupervised manner, cryoDRGN can reconstruct 3D density maps from user-defined positions in latent space. Because cryoDRGN learns a generative model for structure, an unlimited number of structures can be generated and analyzed, thus enabling visualization of structural trajectories. By leveraging the latent encodings of the particle images, users can directly traverse the data manifold and only sample structures from regions of latent space with significant particle occupancy. Indeed, we applied a well-established graph-traversal algorithm<sup><xref rid="R37" ref-type="bibr">37</xref></sup> to visualize data-supported motions in the RAG complex, the <italic>Pf</italic>80S ribosome, bL17-independent assembly of the bacterial ribosome, and the pre-catalytic spliceosome (<xref rid="SD2" ref-type="supplementary-material">Supplemental Videos 1</xref>,<xref rid="SD3" ref-type="supplementary-material">2</xref>,<xref rid="SD4" ref-type="supplementary-material">3</xref>,<xref rid="SD6" ref-type="supplementary-material">4</xref>). We note that while this approach is useful in visualizing potential structural changes linking one state to another, they do not necessarily reveal the kinetically preferred path.</p>
    </sec>
    <sec id="S12">
      <title>Practical considerations in choosing training hyperparameters</title>
      <p id="P30">Although this method emphasizes an unsupervised approach to analyzing structural heterogeneity, cryoDRGN does require that the user define the dimensionality of the latent space and the architecture of both the encoder and decoder networks. We find that in practice, training a smaller architecture on downsampled images is effective at distinguishing bona-fide particles from contaminants and imaging artifacts (<xref rid="F5" ref-type="fig">Fig. 5A</xref>–<xref rid="F5" ref-type="fig">D</xref>, <xref rid="F6" ref-type="fig">Fig. 6A</xref>), and we recommend users initially employ such pilot experiments to filter their dataset. Additionally, we find that in our tested datasets, a 10-D latent space provides sufficient representation capacity to effectively model structural heterogeneity, and that this 10-D space can be readily visualized with PCA or UMAP. Notably, we recommend the use of such a 10-D latent space instead of lower dimensional space as we have found that 10-D spaces result in much more rapid overall training, which is consistent with similar observations of related overparameterized neural network architectures<sup><xref rid="R38" ref-type="bibr">38</xref></sup>. Finally, users must specify the number of nodes and layers in the neural networks, hyperparameters that limit the complexity of the learned function. Here, we find an inverse relationship between neural network size and the achievable resolution of a given structure (<xref rid="F2" ref-type="fig">Fig. 2B</xref>). Training larger networks on larger images is significantly slower (<xref rid="F2" ref-type="fig">Fig. 2E</xref>), and we recommend that users perform an initial assessment using down-sampled images and relatively small networks before proceeding to high-resolution reconstructions. We note that use of excessively complex models (<italic>i.e.</italic> large architectures or latent variable dimensions) can lead to overfitting, which may be alleviated by standard neural network regularization techniques such as early stopping or using a simpler model<sup><xref rid="R38" ref-type="bibr">38</xref></sup>. We provide recommended training settings in the cryoDRGN software.</p>
    </sec>
    <sec id="S13">
      <title>Discovering new states using cryoDRGN</title>
      <p id="P31">CryoDRGN can be used to identify novel clusters of structurally-related particles, which can then be visualized by generating density maps from that region of latent space. Indeed, in analyzing the LSU assembly dataset, we noted a completely new structural state, C4, that was completely missed in traditional hierarchical classification. C4 provides structural evidence that a functionally critical intersubunit helix (h68) can dock in a native conformation in the absence of the central protuberance (<xref rid="F5" ref-type="fig">Fig. 5I</xref>). Notably, we could validate the existence of this state by performing traditional homogeneous refinement using ~1,000 particles from this cluster in the cryoDRGN latent space (<xref rid="F13" ref-type="fig">Extended Data Fig. 7</xref>). Although we were able to readily identify this state from a distinct cluster present in the UMAP visualization (<xref rid="F5" ref-type="fig">Fig. 5G</xref>), in general, the definition of distinct “states” may not be as readily apparent (e.g. the “missing SSU head” state in <xref rid="F9" ref-type="fig">Extended Data Fig. 3</xref>), and we view the unsupervised identification of states from the cryoDRGN structural ensemble as an exciting area to pursue.</p>
      <p id="P32">In future work, we envision using cryoDRGN to reveal the number of discrete classes, their constituent particles, and to produce initial 3D models that could be used as inputs for a traditional 3D reconstruction. Given the mature state of such tools<sup><xref rid="R39" ref-type="bibr">39</xref>,<xref rid="R40" ref-type="bibr">40</xref></sup>, this data-driven classification approach followed by traditional homogeneous reconstruction, particle polishing, and higher order image aberration correction, has the potential to produce high-resolution structures of the full spectrum of discrete structural states.</p>
    </sec>
    <sec id="S14">
      <title><italic>De novo</italic> pose estimation</title>
      <p id="P33">As implemented, cryoDRGN uses pose estimates resulting from a traditional consensus 3D reconstruction. In analyzing four publicly available datasets, we found that such consensus pose estimates were sufficiently accurate to generate meaningful latent space encodings and to produce interpretable density maps of distinct structures. It is clear, however, that this approach will fail if the degree of structural heterogeneity in the dataset results in inaccurate pose estimates. For example, a mixture of structurally unrelated complexes will align poorly to a consensus structure, and thus produce poor pose estimates. Notably, our framework is differentiable with respect to pose variables, which, in principle, should allow for on-the-fly pose-refinement or <italic>de novo</italic> pose estimation. Future work will explore the efficacy of incorporating such features to enable fully unsupervised reconstruction of heterogeneous distributions of protein structure from cryo-EM images.</p>
    </sec>
  </sec>
  <sec id="S15">
    <title>Online Methods</title>
    <sec id="S16">
      <title>The cryoDRGN method</title>
      <sec id="S17">
        <title>Coordinate-based networks to represent 3D structure</title>
        <p id="P34">The cryoDRGN method performs heterogeneous cryo-EM reconstruction by learning a neural network representation of 3D structure. In particular, we use a positionally-encoded multilayer perceptron (MLP) to approximate the function <italic>V</italic>: ℝ<sup>3+<italic>n</italic></sup> → ℝ, which models structures as generated from an <italic>n</italic>-dimensional continuous latent space. We refer to this architecture as a <italic>coordinate-based neural network</italic><sup><xref rid="R41" ref-type="bibr">41</xref>,<xref rid="R42" ref-type="bibr">42</xref></sup> as we explicitly model the volume as a function of Cartesian coordinates.</p>
        <p id="P35">Without loss of generality, we model volumes on the domain [−0.5,0.5]<sup><xref rid="R3" ref-type="bibr">3</xref></sup>. Instead of directly supplying the 3D Cartesian coordinates, <bold><italic>k</italic></bold>, to the deep coordinate network, coordinates are featurized with a fixed positional encoding function<sup><xref rid="R43" ref-type="bibr">43</xref></sup> consisting of sinusoids whose wavelengths follow a geometric progression from 1 up to the Nyquist limit:
<disp-formula id="FD1"><mml:math display="block" id="M1"><mml:mrow><mml:mi>p</mml:mi><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>2</mml:mn><mml:mi>i</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>sin</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mi>D</mml:mi><mml:mi>π</mml:mi><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mfrac><mml:mn>2</mml:mn><mml:mi>D</mml:mi></mml:mfrac></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mfrac><mml:mi>i</mml:mi><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mfrac><mml:mi>D</mml:mi><mml:mn>2</mml:mn></mml:mfrac><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mfrac><mml:mi>D</mml:mi><mml:mn>2</mml:mn></mml:mfrac><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo>;</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>∈</mml:mo><mml:mi mathvariant="bold-italic">k</mml:mi></mml:mrow></mml:math></disp-formula>
<disp-formula id="FD2"><mml:math display="block" id="M2"><mml:mrow><mml:mi>p</mml:mi><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mn>2</mml:mn><mml:mi>i</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>cos</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mi>D</mml:mi><mml:mi>π</mml:mi><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mfrac><mml:mn>2</mml:mn><mml:mi>D</mml:mi></mml:mfrac></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mfrac><mml:mi>i</mml:mi><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mfrac><mml:mi>D</mml:mi><mml:mn>2</mml:mn></mml:mfrac><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mfrac><mml:mi>D</mml:mi><mml:mn>2</mml:mn></mml:mfrac><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo>;</mml:mo><mml:msub><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo>∈</mml:mo><mml:mi mathvariant="bold-italic">k</mml:mi></mml:mrow></mml:math></disp-formula>
where <italic>D</italic> is set to the image size<sup><xref ref-type="fn" rid="FN3">1</xref></sup> used in training. Empirically, we found that excluding the highest frequencies of the positional encoding led to better performance when training on noisy data, and we provide an option to modify the positional encoding function by increasing all wavelengths by a factor of 2π.</p>
      </sec>
      <sec id="S18">
        <title>Training system</title>
        <p id="P36">This neural representation of 3D structure is learned via an image-encoder/volume-decoder architecture based on the variational autoencoder (VAE)<sup><xref rid="R30" ref-type="bibr">30</xref>,<xref rid="R44" ref-type="bibr">44</xref></sup>. We follow the standard image formation model in single particle cryo-EM where observed images are generated from projections of a volume at a random unknown orientation, <italic>R</italic> ∈ <italic>SO</italic>(3). We use an additive Gaussian white noise model. Volume heterogeneity is generated from a continuous latent space, modeled by the latent variable <italic><bold>z</bold></italic>, where the dimensionality of <italic><bold>z</bold></italic> is a hyperparameter of the model.</p>
        <p id="P37">Given an image <italic>X</italic>, the variational encoder, <italic>q</italic><sub><italic>ξ</italic></sub>(<bold><italic>z</italic></bold>|<italic>X</italic>), produces a mean and variance, <italic>μ</italic><sub><italic>z</italic>|<italic>X</italic></sub> and Σ<sub><sub><italic>z</italic>|<italic>X</italic></sub></sub>, statistics that parameterize a Gaussian distribution with diagonal covariance, as the variational approximation to the true posterior <italic>p</italic>(<italic><bold>z</bold></italic>|<italic>X</italic>). The prior on the latent variable is a standard normal distribution <inline-formula><mml:math display="inline" id="M3"><mml:mrow><mml:mi mathvariant="script">N</mml:mi></mml:mrow></mml:math></inline-formula>(0, <bold>I</bold>). The positionally-encoded MLP is used as the probabilistic decoder, <italic>p</italic><sub><italic>θ</italic></sub>(<italic>V</italic>| <italic><bold>k</bold></italic>, <italic><bold>z</bold></italic>), and models structures in frequency space. Given Cartesian coordinate <italic><bold>k</bold></italic> ∈ ℝ<sup><xref rid="R3" ref-type="bibr">3</xref></sup> and latent variable <italic><bold>z</bold></italic>, the probabilistic decoder predicts a Gaussian distribution over <italic>V</italic>(<italic><bold>k</bold></italic>, <italic><bold>z</bold></italic>). The encoder and decoder are parameterized with fully connected neural networks with parameters <italic>ξ</italic> and <italic>θ</italic>, respectively.</p>
        <p id="P38">Since 2D projection images can be related to volumes as 2D central slices in Fourier space<sup><xref rid="R29" ref-type="bibr">29</xref></sup>, oriented 3D coordinates for a given image can be obtained by rotating a <italic>D</italic> × <italic>D</italic> lattice spanning [−0.5,0.5]<sup><xref rid="R2" ref-type="bibr">2</xref></sup> originally on the x-y plane by <italic>R</italic>, the orientation of the volume during imaging. Then, given a sample out of <italic>q</italic><sub><italic>ξ</italic></sub>(<italic><bold>z</bold></italic>|<italic>X</italic>) and the oriented coordinates, an image can be reconstructed pixel-by-pixel through the decoder. The reconstructed image is then translated by the image’s in-plane shift and multiplied by the CTF before it is compared to the input image. The negative log likelihood of a given image under our model is computed as the mean square error between the reconstructed image and the input image. Following the standard VAE framework, the optimization objective is a variational lower bound of the model evidence:
<disp-formula id="FD3"><mml:math display="block" id="M4"><mml:mrow><mml:mi mathvariant="script">L</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>X</mml:mi><mml:mo>;</mml:mo><mml:mi>ξ</mml:mi><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mi>E</mml:mi><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mi>ξ</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mo>∣</mml:mo><mml:mi>X</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msub><mml:mo stretchy="false">[</mml:mo><mml:mi>log</mml:mi><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>X</mml:mi><mml:mo>∣</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">]</mml:mo><mml:mo>−</mml:mo><mml:mi>β</mml:mi><mml:mi>K</mml:mi><mml:mi>L</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>q</mml:mi><mml:mi>ξ</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mo>∣</mml:mo><mml:mi>X</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>∥</mml:mo><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></disp-formula>
where the first term is the reconstruction error estimated with one Monte Carlo sample, the second term is a regularization term on the latent representation, and <italic>β</italic> is an additional hyperparameter, which we set by default to 1/|z|. By training on many 2D slices with sufficiently diverse orientations, the 3D volume can be learned through feedback from the 2D views. For further details, we refer the reader to a preliminary version of the method described in the proceedings of the International Conference for Learning Representations<sup><xref rid="R41" ref-type="bibr">41</xref></sup>. The results presented here employ the training regime described in Zhong <italic>et al.</italic> using previously determined poses from a consensus reconstruction<sup><xref rid="R41" ref-type="bibr">41</xref></sup>.</p>
      </sec>
    </sec>
    <sec id="S19">
      <title>Datasets</title>
      <sec id="S20">
        <title>Simulated compositionally heterogeneous dataset generation</title>
        <p id="P39">To generate the compositionally heterogeneous dataset, the 30S, 50S and 70S subunits of the <italic>E. coli</italic> ribosome were extracted from PDB 4YBB in PyMOL<sup><xref rid="R45" ref-type="bibr">45</xref></sup>. A density map of each subunit was generated from the atomic model using the molmap<sup><xref rid="R46" ref-type="bibr">46</xref></sup> command in Chimera<sup><xref rid="R47" ref-type="bibr">47</xref></sup> at a grid spacing of 1.5 Å/pix and a resolution of 4.5 Å. The resulting volume was padded to a box size of D=256, where D is the width in pixels along one dimension. Simulated particle images were generated with a custom Python script available in the cryoDRGN software by rotating the density map with a random rotation sampled uniformly from SO(3), projecting along the z-axis, and shifting the image with an in-plane translation sampled uniformly from [−20,20]<sup><xref rid="R2" ref-type="bibr">2</xref></sup> pixels. Images were then downsampled to D=128 by Fourier clipping using a custom Python script, corresponding to a Nyquist limit of 6 Å. Projection images were multiplied with the CTF in Fourier space, where the CTF was computed from defocus values randomly sampled from those given in EMPIAR-10028<sup><xref rid="R32" ref-type="bibr">32</xref></sup>, no astigmatism, an accelerating voltage of 300 kV, a spherical aberration of 2 mm, and an amplitude contrast ratio of 0.1. An envelope function with a B-factor of 100 Å<sup>2</sup> was applied. Noise was added with a signal to noise ratio (SNR) of 0.1 where the noise-free signal images were defined as the entire <italic>D</italic> × <italic>D</italic> image. After performing this procedure for each subunit, 10k, 15k, and 25k simulated particles of the 30S, 50S, and 70S ribosome, respectively, were combined.</p>
      </sec>
      <sec id="S21">
        <title>Simulated conformationally heterogeneous dataset generation</title>
        <p id="P40">To simulate continuous conformational heterogeneity, 50 density maps were generated along a one-dimensional reaction coordinate defined by rotating a dihedral angle in an atomic model of a hypothetical protein complex. Each model was generated at 0.03 radian increments of the bond rotation, leading to a total range of 1.5 radians. Density maps were generated using the molmap<sup><xref rid="R46" ref-type="bibr">46</xref></sup> command in Chimera<sup><xref rid="R47" ref-type="bibr">47</xref></sup> at a grid spacing of 6 Å/pix and resolution of 12 Å, and padded to a box size of D=128. For the <italic>Uniform</italic> dataset, 1000 projection images were generated for each density map at random orientations and in-plane translations sampled from [−10,10]<sup><xref rid="R2" ref-type="bibr">2</xref></sup> pixels. For the nonuniform datasets, particles were generated along the reaction according to a 3-component Gaussian mixture model with means at the 10<sup>th</sup>, 25<sup>th</sup>, and 40<sup>th</sup> density map and standard deviation of 0.09 and 0.03 radians for the <italic>Cooperative</italic> and <italic>Noncontiguous</italic> datasets, respectively. Sampled reaction coordinate values were binned to convert into a particle distribution among the 50 generated density maps, and clipped at values of the reaction coordinate beyond the 50 maps. A total of 50k particles were generated for each dataset. CTF and noise at an SNR=0.1 were added to all datasets using the same procedure described above with CTF defocus values randomly sampled from EMPIAR-10028<sup><xref rid="R32" ref-type="bibr">32</xref></sup>.</p>
      </sec>
      <sec id="S22">
        <title>Real cryo-EM datasets</title>
        <p id="P41">Picked particles and the star file containing CTF parameters were downloaded from the Electron Microscopy Public Image Archive (EMPIAR)<sup><xref rid="R48" ref-type="bibr">48</xref></sup> for datasets EMPIAR-10049, EMPIAR-10028, EMPIAR-10076, and EMPIAR-10180. Particle images were downsized to the image size used in training by clipping in Fourier space with a custom Python script available in the cryoDRGN software.</p>
      </sec>
    </sec>
    <sec id="S23">
      <title>Consensus reconstructions</title>
      <p id="P42">Homogeneous 3D reconstruction of the <italic>Pf</italic>80S ribosome (EMPIAR-10028) was performed in cryoSPARC v2.4<sup><xref rid="R16" ref-type="bibr">16</xref></sup> using the ab-initio reconstruction job followed by the homogeneous refinement job with default parameters. The final reconstruction reported a GSFSC<sub>0.143</sub><sup><xref rid="R49" ref-type="bibr">49</xref></sup> resolution of 3.1 Å with a tight mask and 4.1 Å unmasked.</p>
      <p id="P43">Homogeneous 3D reconstruction of the bL17-depleted ribosome assembly intermediates (EMPIAR-10076) was performed as above, leading to a final structure with a GSFSC<sub>0.143</sub> resolution of 3.2 Å with a tight mask and 4.8 Å unmasked.</p>
      <p id="P44">Homogeneous 3D reconstruction of the RAG complex (EMPIAR-10049) was performed as a “Homogeneous Refinement (NEW!)” job in cryoSPARC v2.15 with all default settings, including C1 symmetry. The asymmetric PC map of the RAG complex was used as an initial model (EMDB 6489), low pass filtered by 30 Å. The final structure had GSFSC<sub>0.143</sub> resolution of 3.6 Å with a tight mask and 4.6 Å unmasked.</p>
      <p id="P45">Poses from a consensus reconstruction of the pre-catalytic spliceosome were obtained from the star file deposited in EMPIAR-10180.</p>
    </sec>
    <sec id="S24">
      <title>CryoDRGN homogeneous reconstruction</title>
      <p id="P46">CryoDRGN decoder networks with no input latent variable were trained for 50 epochs on full-resolution images of the RAG complex (D=192, 1.23 Å/pix) and the <italic>Pf</italic>80S ribosome (D=360, 1.34 Å/pix). The tested architectures were MLPs with ReLU activations, where the network size was either 3 hidden layers of width 128 (denoted 128 × 3), 256 × 3, 512 × 3, 1024 × 3, or 1024 × 10. Image poses were set to poses obtained from a consensus reconstruction in cryoSPARC, described above<sup><xref rid="R16" ref-type="bibr">16</xref></sup>. Networks were trained on minibatches of 8 images using the Adam optimizer with a learning rate of 0.0001. Once training completed, the decoder network was evaluated on the 3D coordinates of a <italic>D</italic> × <italic>D</italic> × <italic>D</italic> voxel array spanning [−0.5,0.5]<sup><xref rid="R3" ref-type="bibr">3</xref></sup>, where D is the image size in pixels along one dimension. For visualization in <xref rid="F2" ref-type="fig">Figure 2</xref>, the RAG complex density maps were sharpened by −54 Å<sup>2</sup> and −127.4 Å<sup>2</sup> for the cryoDRGN and cryoSPARC map, respectively, based on Guinier analysis<sup><xref rid="R49" ref-type="bibr">49</xref></sup> performed in a custom Python script; both the cryoSPARC and cryoDRGN density maps of the <italic>Pf</italic>80S ribosome were sharpened using the published B-factor of −80.1 Å<sup>2</sup>.</p>
    </sec>
    <sec id="S25">
      <title>Map-to-map FSC</title>
      <p id="P47">Fourier shell correlation curves were computed between the cryoSPARC density maps and cryoDRGN density maps using a custom Python script available in the cryoDRGN software. Real space masks were defined by first thresholding the cryoDRGN volume at half of the 99.99th percentile density value. The mask was then dilated by 25 Å from the original boundary, and a soft cosine edge was used to taper the mask to 0 at 15 Å from the dilated boundary.</p>
    </sec>
    <sec id="S26">
      <title>CryoDRGN heterogeneous reconstruction</title>
      <sec id="S27">
        <title>Model training</title>
        <p id="P48">A summary of the datasets, hyperparameters, and runtimes for all cryoDRGN heterogeneous reconstruction experiments is given in <xref rid="SD5" ref-type="supplementary-material">Supplementary Table 1</xref>. CryoDRGN encoder-decoder networks were trained from their randomly initialized values for each single particle cryo-EM dataset. Image poses used for training were either the ground truth poses for simulated datasets or poses obtained from a consensus reconstruction as described above. All networks were trained on minibatches of 8 images using the Adam optimizer with a learning rate of 0.0001. After training, the dataset images were evaluated through the encoder to obtain the latent encoding for each image. We define the latent encoding as the <italic>maximum a posteriori</italic> value of <italic>q</italic><sub><italic>ξ</italic></sub>(<italic><bold>z</bold></italic>|<italic>X</italic>) predicted by the encoder.</p>
      </sec>
      <sec id="S28">
        <title>Latent space visualization</title>
        <p id="P49">For latent spaces with dimension greater than 2, the distribution of latent encodings were visualized with standard dimensionality reduction techniques such as PCA and UMAP<sup><xref rid="R35" ref-type="bibr">35</xref></sup>. PCA projections of latent space particle distributions were computed using the implementation provided by scikit-learn<sup><xref rid="R50" ref-type="bibr">50</xref></sup>. Two-dimensional UMAP<sup><xref rid="R35" ref-type="bibr">35</xref></sup> embeddings were computed using version 0.4.1 of the Python implementation (<ext-link ext-link-type="uri" xlink:href="https://github.com/lmcinnes/umap">https://github.com/lmcinnes/umap</ext-link>) with the default settings of k=15 for the k-nearest neighbors graph and a minimum distance parameter of 0.1. Automated tools to analyze and visualize the latent space given the outputs of model training are provided in the cryoDRGN software.</p>
      </sec>
      <sec id="S29">
        <title>Density map generation</title>
        <p id="P50">Density maps were generated for a given value of the latent variable <italic>z</italic> by evaluating the trained decoder on <italic>z</italic> and the 3D coordinates of a <italic>D</italic> × <italic>D</italic> × <italic>D</italic> voxel array spanning [−0.5,0.5]<sup><xref rid="R3" ref-type="bibr">3</xref></sup>. For higher dimensional latent spaces (|z| &gt; 1), to generate representative samples from different regions of the latent space, we perform <italic>k</italic>-means clustering of the dataset’s latent encodings to partition the latent space into <italic>k</italic> regions. A representative density map for each region is generated at the “on-data” cluster center; We define the latent encoding closest in Euclidean distance to the <italic>k</italic>-means cluster center as the “on-data” cluster center. Automated tools to generate <italic>k</italic> representative density maps following this procedure are provided in the cryoDRGN software.</p>
      </sec>
    </sec>
    <sec id="S30">
      <title>Heterogeneous reconstruction of simulated datasets</title>
      <p id="P51">For each simulated heterogeneous dataset, a 1-D latent variable model was trained for 100 epochs. The encoder architecture was 256 × 3 and the decoder architecture was 512 × 5. The image poses used for training were the ground truth image poses. After training on the <italic>Uniform</italic> simulated dataset, structures shown in <xref rid="F3" ref-type="fig">Figure 3C</xref> were generated at the 5th, 23rd, 41st, 59th, 77th, and 95<sup>th</sup> percentile values of the latent encodings, and sharpened by a B-factor of −100 Å<sup>2</sup>. After training on the <italic>Compositional</italic> simulated dataset, structures shown in <xref rid="F3" ref-type="fig">Figure 3D</xref> were generated at the <italic>k</italic>-means cluster centers after performing <italic>k</italic>-means clustering with <italic>k</italic>=3 on the latent encodings and sharpened by a B-factor of −100 Å<sup>2</sup>. Spearman correlation was computed using the implementation provided in the scipy version 1.5.2 Python package (<ext-link ext-link-type="uri" xlink:href="https://www.scipy.org/">https://www.scipy.org</ext-link>).</p>
    </sec>
    <sec id="S31">
      <title>Per-image FSC</title>
      <p id="P52">For simulated datasets where the ground-truth distribution of structures is known, “per-image” FSC curves can be computed between cryoDRGN-reconstructed density maps and the ground-truth density maps to quantitatively evaluate the reconstructed ensemble. To compute a per-image FSC, an FSC curve is computed between the density map generated by the cryoDRGN decoder at the value of the latent variable predicted for a given particle image and the ground-truth density map used to generate the image. 100 images randomly sampled according to the ground truth distribution of structures were used in the assessment of each of the simulated datasets. No real-space mask was used in computing the FSC.</p>
    </sec>
    <sec id="S32">
      <title>Heterogeneous reconstruction of the RAG complex (EMPIAR-10049)</title>
      <p id="P53">A 10-D latent variable model was trained on full-resolution particle images from EMPIAR-10049 (D=192, 1.23 Å/pix) and their consensus reconstruction poses for 25 epochs. The encoder and decoder architectures were 1024 × 3.</p>
      <sec id="S33">
        <title>Density map generation:</title>
        <p id="P54">After training, <italic>k</italic>-means clustering with <italic>k</italic>=100 was performed on the predicted latent encodings for the dataset, and volumes were generated at the “on-data” cluster centers using the decoder network. Six structurally diverse representative structures were manually selected for visualization in <xref rid="F4" ref-type="fig">Figure 4A</xref>.</p>
      </sec>
      <sec id="S34">
        <title>Traditional heterogeneous refinement:</title>
        <p id="P55">To validate the heterogeneous RSS and NBD conformations observed in cryoDRGN, we use the 6 selected density maps, low pass filtered by 20 Å, as initial models to a heterogeneous refinement job in cryoSPARC v2.15.</p>
      </sec>
    </sec>
    <sec id="S35">
      <title>Heterogeneous reconstruction of the 80S ribosome (EMPIAR-10028)</title>
      <sec id="S36">
        <title>Pilot experiments:</title>
        <p id="P56">A 10-D latent variable model was trained on downsampled images (D=128, 3.78 Å/pix) from EMPIAR-10028 and their consensus reconstruction poses for 50 epochs. The encoder and decoder architectures were 256 × 3.</p>
      </sec>
      <sec id="S37">
        <title>Particle filtering:</title>
        <p id="P57">After training, <italic>k</italic>-means clustering with <italic>k</italic>=20 was performed on the predicted latent encodings for the dataset. One cluster contained 860 particles that were outliers when viewing the projected encodings along the first and second principal component. This observation was reproducible, and the particles belonging to the outlier cluster from either of two replicates (960 particles in total) were removed from the dataset.</p>
      </sec>
      <sec id="S38">
        <title>High-resolution training:</title>
        <p id="P58">After particle filtering, a 10-D latent variable model was trained on a random 90% the remaining 104,280 images (D=256, 1.88 Å/pix) for 25 epochs. The encoder and decoder architectures were 1024 × 3.</p>
      </sec>
      <sec id="S39">
        <title>Density map generation:</title>
        <p id="P59">After training, <italic>k</italic>-means clustering with <italic>k</italic>=50 was performed on the predicted latent encodings for the dataset, and volumes were generated at the “on-data” cluster centers using the decoder network. A representative structure of the rotated state and the unrotated state were manually selected for visualization in <xref rid="F4" ref-type="fig">Figure 4B</xref>. A representative structure of the missing head group state was manually selected for visualization in <xref rid="F9" ref-type="fig">Extended Data Figure 3</xref>. The numbered k-means cluster centers shown in <xref rid="F9" ref-type="fig">Extended Data Figure 3A</xref>, originally arbitrarily ordered, were reordered based on hierarchical clustering of the latent encodings with Euclidean distance metric and average linkage.</p>
      </sec>
      <sec id="S40">
        <title>Validation with traditional reconstruction:</title>
        <p id="P60">To validate the 40S rotated state, we selected 4,889 particles as the cluster from <italic>k</italic>-means clustering with <italic>k</italic>=20 that was separated along PC1 (<xref rid="F10" ref-type="fig">Extended Data Fig. 4</xref>). These particles were then input to a homogeneous refinement job in cryoSPARC v2.15. The cryoDRGN density map, low pass filtered by 30 Å, was used as the initial model.</p>
      </sec>
    </sec>
    <sec id="S41">
      <title>Heterogeneous reconstruction of the assembling 50S ribosome (EMPIAR-10076)</title>
      <sec id="S42">
        <title>Pilot experiments:</title>
        <p id="P61">A 1-D and a 10-D latent variable model were trained on downsampled images (D=128, 3.3 Å/pix) from EMPIAR-10076 with poses from a consensus reconstruction for 50 epochs. The encoder and decoder architectures were 256 × 3.</p>
      </sec>
      <sec id="S43">
        <title>Particle filtering:</title>
        <p id="P62">From the 1-D experiment, particles with <italic><bold>z</bold></italic> ≤ −1 were removed from subsequent analysis. From the 10-D experiment, a 5-component, full-covariance Gaussian mixture model (GMM) was fit to the latent encodings using scikit-learn<sup><xref rid="R50" ref-type="bibr">50</xref></sup>, and particles from the outlier cluster were removed. The outlier cluster was identified by visualizing the magnitude of the latent encodings (<xref rid="F10" ref-type="fig">Extended Data Fig. 4</xref>). The intersection of both filtered particles stacks was used for subsequent analysis. 2D classification of the kept and removed particles was performed in cryoSPARC v2.4<sup><xref rid="R16" ref-type="bibr">16</xref></sup> using all default options except for the number of 2D classes, which was set to 20. <italic>Ab-initio</italic> reconstruction of the kept and removed particles was performed in cryoSPARC v2.4<sup><xref rid="R16" ref-type="bibr">16</xref></sup> using all default options.</p>
      </sec>
      <sec id="S44">
        <title>High-resolution training:</title>
        <p id="P63">A 10-D latent variable model was trained on a random 90% of the remaining 97,031 images (D=256, 1.7 Å/pix) for 50 epochs. The encoder and decoder architectures were 1024 × 3. Two additional replicates were run, one with the exact settings from a different random initialization and a second with latent variable dimension |z| = 8.</p>
      </sec>
      <sec id="S45">
        <title>Density map generation:</title>
        <p id="P64">After training, the dataset’s latent encodings were viewed in 2D with UMAP<sup><xref rid="R35" ref-type="bibr">35</xref></sup>. Density maps corresponding to the major and minor assembly states were generated at the “on-data” mean latent encoding for each class, <italic>i.e.</italic>
<inline-formula><mml:math display="inline" id="M5"><mml:mrow><mml:msub><mml:mover accent="true"><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mi>M</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mo stretchy="false">|</mml:mo><mml:mi>M</mml:mi><mml:mo stretchy="false">|</mml:mo></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mi>M</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mstyle></mml:mrow></mml:math></inline-formula>, where M is the set of particles assigned to a given class in the published 3D classification.</p>
      </sec>
      <sec id="S46">
        <title>Map-to-map FSC:</title>
        <p id="P65">The map-to-map FSC was computed between the cryoDRGN and published density map for each minor class. Density maps were aligned in Chimera and a loose real-space mask (obtained as described above) was applied before computing an FSC curve.</p>
      </sec>
      <sec id="S47">
        <title>Reproducibility analysis:</title>
        <p id="P66">For each replicate, a 5-component, full-covariance GMM was fit to the UMAP embeddings using scikit-learn<sup><xref rid="R50" ref-type="bibr">50</xref></sup>. UMAP axes were negated to facilitate visual comparison. Label assignments were permuted to ensure consistent assignments between replicates. Clustering consistency was computed as the percentage of particles with identical GMM labels.</p>
      </sec>
      <sec id="S48">
        <title>New assembly state C4:</title>
        <p id="P67">Particles corresponding to the new assembly state were manually selected from the UMAP embeddings with an interactive lasso tool in a custom visualization script available in the cryoDRGN software, whose outline is shown in the <xref rid="F5" ref-type="fig">Figure 5F</xref> inset. The mean latent encoding of the resulting 1,113 selected particles was used to generate the structure representative for this new assembly state.</p>
      </sec>
      <sec id="S49">
        <title>Validation of C4 with traditional refinement:</title>
        <p id="P68">The particles associated with class C4 were then input to a homogeneous refinement job in cryoSPARC v2.15. The cryoDRGN density map, low pass filtered to 30 Å, was used as the initial model.</p>
      </sec>
    </sec>
    <sec id="S50">
      <title>Heterogeneous reconstruction of the pre-catalytic spliceosome (EMPIAR-10180)</title>
      <sec id="S51">
        <title>Pilot experiments:</title>
        <p id="P69">A 10-D latent variable model was trained on downsampled images (D=128, 4.25 Å/pix) from EMPIAR-10180 for 50 epochs. The encoder and decoder architectures were 256×3. Poses were obtained from the consensus reconstruction values given in the consensus_data.star deposited to EMPIAR-10180.</p>
      </sec>
      <sec id="S52">
        <title>Particle filtering:</title>
        <p id="P70">The UMAP embeddings showed multiple clusters where the largest cluster corresponded to fully formed pre-catalytic spliceosomes. Particles corresponding to other clusters were removed from subsequent analyses by first performing <italic>k</italic>-means clustering with <italic>k</italic>=20 on the latent encodings, and removing <italic>k</italic>-means clusters whose structure did not resemble the fully formed pre-catalytic spliceosome (11 out of 20 <italic>k</italic>-means clusters in one replicate, and 10 out of 20 in a second replicate).</p>
      </sec>
      <sec id="S53">
        <title>High-resolution training:</title>
        <p id="P71">A 10-D latent variable model was trained on a random 90% of the remaining 155,247 images (D=256, 2.1 Å/pix) for 50 epochs. The encoder and decoder architectures were 1024 × 3.</p>
      </sec>
      <sec id="S54">
        <title>Density map generation:</title>
        <p id="P72">After training, the dataset’s latent encoding was viewed in 2-D with UMAP and PCA. Density maps in <xref rid="F6" ref-type="fig">Figure 6D</xref> were generated at the latent encoding values along the PC1 axis at five equally spaced points between the 5<sup>th</sup> and 95<sup>th</sup> percentile of PC1 values. Density maps in <xref rid="SD1" ref-type="supplementary-material">Supplementary Figure 1</xref> were generated at the latent encoding values along the PC2 axis at five equally spaced points between the 5<sup>th</sup> and 95<sup>th</sup> percentile of PC2 values. Density map generation along PC axes is implemented in a custom script in the cryoDRGN software.</p>
      </sec>
    </sec>
    <sec id="S55">
      <title>Latent space graph traversal for generating trajectories</title>
      <p id="P73">Trajectories were generated by first creating a nearest-neighbors graph from the latent encodings of the images, where a neighbor was defined if the Euclidean distance was below a threshold computed from the statistics of all pairwise distances. We choose a value for each dataset such that the average number of neighbors across all nodes is 5. Edges were then pruned such that a given node does not have more than 10 neighbors. Then, Djikstra’s algorithm<sup><xref rid="R37" ref-type="bibr">37</xref></sup> was used to find the shortest path along the graph connecting a series of anchor points, and density maps were generated at the <italic><bold>z</bold></italic> value of the visited nodes. Anchor points were either defined manually or set to be the “on-data” cluster centers after performing <italic>k</italic>-means clustering of the latent encodings.</p>
      <p id="P74">For the graph traversal of the RAG complex in <xref rid="SD2" ref-type="supplementary-material">Supplemental Video 1</xref>, we use the latent encodings of the 6 density maps shown in <xref rid="F4" ref-type="fig">Figure 4A</xref> as the anchor points. For the graph traversal of the <italic>Pf</italic>80S ribosome in <xref rid="SD3" ref-type="supplementary-material">Supplemental Video 2</xref>, we use 10 randomly chosen latent encodings as the anchor points out of the k-means cluster centers with <italic>k</italic>=20 that are shown prior to the graph traversal. For the graph traversal of the assembling ribosome in <xref rid="SD4" ref-type="supplementary-material">Supplemental Video 3</xref>, we use the latent encodings of the minor assembly states following the three assembly pathways given in Figure 7 of <italic>Davis et al</italic><sup><xref rid="R12" ref-type="bibr">12</xref></sup>. For the graph traversal of the pre-catalytic spliceosome in <xref rid="SD6" ref-type="supplementary-material">Supplemental Video 4</xref>, we use the latent encodings of the <italic>k</italic>-means cluster centers with <italic>k</italic>=20 as the anchor points. All density map figures and trajectories were prepared with ChimeraX<sup><xref rid="R51" ref-type="bibr">51</xref></sup> and are viewed at identical isosurface levels for a given model unless otherwise specified. CryoDRGN’s graph traversal algorithm is provided in the cryoDRGN software.</p>
    </sec>
    <sec id="S56">
      <title>3DVA</title>
      <p id="P75">3D Variability Analysis<sup><xref rid="R23" ref-type="bibr">23</xref></sup> was performed in cryoSPARC v2.15 on the 139,722 particles and their consensus poses comprising the filtered EMPIAR-10180 dataset used in cryoDRGN analysis. Three variability modes were solved with all default options and the low-pass filter resolution set to 7 Å. 3DVA per-particle latent encodings were extracted from the cryoSPARC metadata file. Spearman correlation was computed using the implementation provided in the scipy version 1.5.2 Python package (<ext-link ext-link-type="uri" xlink:href="https://www.scipy.org/">https://www.scipy.org</ext-link>). To visualize the component 1 trajectory in <xref rid="F10" ref-type="fig">Extended Data Figure 10</xref>, the consensus density map was combined with the component 1 eigen-volume at 5 equally spaced points between the 1<sup>st</sup> and 99<sup>th</sup> percentile value of the 3DVA component 1 latent encoding distribution.</p>
    </sec>
    <sec sec-type="data-availability" id="S57">
      <title>Data Availability Statement</title>
      <p id="P108">Trained cryoDRGN models and generated volumes are deposited to Zenodo at doi:<ext-link ext-link-type="doi" xlink:href="10.5281/zenodo.4355284">10.5281/zenodo.4355284</ext-link>. Inputs files for training (excluding particle stacks) are deposited to Zenodo at doi:<ext-link ext-link-type="doi" xlink:href="10.5281/zenodo.4412072">10.5281/zenodo.4412072</ext-link> and are also available at <ext-link ext-link-type="uri" xlink:href="http://www.github.com/zhonge/cryodrgn_empiar">www.github.com/zhonge/cryodrgn_empiar</ext-link>. We used the following publicly available datasets:
<list list-type="bullet" id="L1"><list-item><p id="P109">EMPIAR-10049: Cryo-EM structures of a synaptic RAG1-RAG2 complex</p></list-item><list-item><p id="P110">EMPIAR-10028: Cryo-EM structure of a <italic>Plasmodium falciparum</italic> 80S ribosome bound to the anti-protozoan drug emetine</p></list-item><list-item><p id="P111">EMPIAR-10076: Modular assembly of the large bacterial ribosome</p></list-item><list-item><p id="P112">EMPIAR-10180: Structure of a pre-catalytic spliceosome</p></list-item></list></p>
      <p id="P113">The simulated datasets of conformational and compositional heterogeneous are deposited to Zenodo at doi:<ext-link ext-link-type="doi" xlink:href="10.5281/zenodo.4355284">10.5281/zenodo.4355284</ext-link>.</p>
    </sec>
    <sec id="S58">
      <title>Code Availability Statement</title>
      <p id="P115">CryoDRGN software and analysis scripts are implemented in custom software deposited to Zenodo at doi:<ext-link ext-link-type="doi" xlink:href="10.5281/zenodo.4412058">10.5281/zenodo.4412058</ext-link> and are also available at <ext-link ext-link-type="uri" xlink:href="http://www.github.com/zhonge/cryodrgn">www.github.com/zhonge/cryodrgn</ext-link>.</p>
    </sec>
  </sec>
  <sec sec-type="extended-data" id="S59">
    <title>Extended Data</title>
    <fig id="F7" orientation="portrait" position="anchor">
      <label>Extended Data Figure 1.</label>
      <caption>
        <title>Per-image FSC curves between ground-truth maps and density maps from cryoDRGN trained on simulated heterogeneous datasets.</title>
        <p id="P76">For each dataset, we compute 100 “per-image FSC curves” between generated and ground-truth density maps (<xref rid="S15" ref-type="sec">Methods</xref>). Images are sampled at equally spaced percentiles along the reaction coordinate for the <italic>Uniform</italic>, <italic>Cooperative</italic>, and <italic>Noncontiguous</italic> datasets. For the <italic>Compositional</italic> dataset, the per-image FSC for 20, 30, and 50 randomly sampled images of the 30S, 50S, and 70S ribosome, respectively, are shown. No mask is used in computing the FSC.</p>
      </caption>
      <graphic xlink:href="nihms-1656428-f0007"/>
    </fig>
    <fig id="F8" orientation="portrait" position="anchor">
      <label>Extended Data Figure 2.</label>
      <caption>
        <title>RAG complex density maps reconstructed by cryoDRGN and by heterogeneous refinement in cryoSPARC.</title>
        <p id="P77"><bold>A)</bold> Front (top) and back (bottom) view of the six cryoDRGN density maps of the RAG complex from <xref rid="F4" ref-type="fig">Figure 4B</xref>.</p>
        <p id="P78"><bold>B)</bold> Density maps from 3D classification in cryoSPARC using the cryoDRGN density maps in (<bold>A</bold>) as initial models. Gold-standard FSC resolution and number of particles used in reconstruction are noted.</p>
        <p id="P79"><bold>C)</bold> Two side views of the density maps from 3D classification in (<bold>B</bold>), focusing on the RSS and NBD.</p>
      </caption>
      <graphic xlink:href="nihms-1656428-f0008"/>
    </fig>
    <fig id="F9" orientation="portrait" position="anchor">
      <label>Extended Data Figure 3.</label>
      <caption>
        <title>Missing head group of the <italic>Pf</italic>80S ribosome.</title>
        <p id="P80"><bold>A)</bold> UMAP visualization of latent space encodings of EMPIAR-10028 particles with 50 sampled points shown in black. Sampled points are ordered according to distances in latent space (<xref rid="S15" ref-type="sec">Methods</xref>). Visual inspection of the 50 volumes generated at the depicted points reveals 3 volumes with the 40S in a rotated state (purple) and 6 volumes with portions of the 40S head region missing (pink).</p>
        <p id="P81"><bold>B)</bold> Density map of the 80S ribosome with the missing head group reconstructed by cryoDRGN (pink) compared with the density maps from <xref rid="F4" ref-type="fig">Figure 4C</xref> showing the canonical (blue) and 40S-rotated (purple) forms of the 80S ribosome. The density maps are generated from points 32, 4, and 1 in panel A from left to right.</p>
      </caption>
      <graphic xlink:href="nihms-1656428-f0009"/>
    </fig>
    <fig id="F10" orientation="portrait" position="anchor">
      <label>Extended Data Figure 4.</label>
      <caption>
        <title>Validation of <italic>Pf</italic>80S rotated state with cryoSPARC.</title>
        <p id="P82"><bold>A)</bold> PCA and UMAP visualization of the cryoDRGN latent space representation of <italic>Pf</italic>80S particle images with 4,889 particles separated along PC1, selected with <italic>k</italic>-means clustering, colored in purple (<xref rid="S15" ref-type="sec">Methods</xref>).</p>
        <p id="P83"><bold>B)</bold> Density map from cryoSPARC homogeneous refinement (purple) using the 4,889 particles selected in (<bold>A</bold>). The density map is also shown superimposed with the cryoDRGN unrotated state (blue) and annotated as in <xref rid="F4" ref-type="fig">Figure 4C</xref>.</p>
        <p id="P84"><bold>C)</bold> Gold standard FSC (GSFSC) curve between independent half-maps of the cryoSPARC refinement of the <italic>Pf</italic>80S rotated state and map-to-map FSC between the cryoDRGN and cryoSPARC density map of the <italic>Pf</italic>80S rotated state. Dotted lines indicate 0.5 and 0.143 cutoffs.</p>
      </caption>
      <graphic xlink:href="nihms-1656428-f0010"/>
    </fig>
    <fig id="F11" orientation="portrait" position="anchor">
      <label>Extended Data Figure 5.</label>
      <caption>
        <title>Filtering of particles from the assembling ribosome dataset.</title>
        <p id="P85"><bold>A)</bold> UMAP visualization of the 10-D latent encodings from cryoDRGN as in <xref rid="F5" ref-type="fig">Figure 5B</xref>, colored by cluster after fitting a 5-component Gaussian mixture model. The cluster that was removed from subsequent analysis is colored orange.</p>
        <p id="P86"><bold>B)</bold> UMAP visualization of (<bold>A</bold>), colored by the magnitude of the latent encodings, ||z||.</p>
        <p id="P87"><bold>C)</bold> Nine randomly sampled particle images from EMPIAR-10076 with latent encoding magnitude ||z|| &gt; 10 as predicted from cryoDRGN training in (<bold>A,B</bold>). Each image is 419.2 Å along each side.</p>
        <p id="P88"><bold>D)</bold> Table summarizing dataset filtering.</p>
        <p id="P89"><bold>E,F)</bold> 2D classification and <italic>ab initio</italic> reconstruction of the 34,868 removed particles.</p>
        <p id="P90"><bold>G,H)</bold> 2D classification and <italic>ab initio</italic> reconstruction of the 97,031 kept particles.</p>
      </caption>
      <graphic xlink:href="nihms-1656428-f0011"/>
    </fig>
    <fig id="F12" orientation="portrait" position="anchor">
      <label>Extended Data Figure 6.</label>
      <caption>
        <title>Minor LSU assembly states reconstructed by cryoDRGN.</title>
        <p id="P91"><bold>A)</bold> Density maps of the LSU minor assembly states reconstructed by cryoDRGN. Each cryoDRGN structure is generated at mean of the latent encoding of particles with the corresponding class assignment from <italic>Davis et al</italic>.<sup><xref rid="R12" ref-type="bibr">12</xref></sup></p>
        <p id="P92"><bold>B)</bold> Map-to-map FSC curves between the generated cryoDRGN density maps and the published density map from <italic>Davis et al.</italic><sup><xref rid="R12" ref-type="bibr">12</xref></sup>. Published resolutions for assembly states B-E ranged between ~4–5 Å. Dotted lines indicate 0.5 and 0.143 cutoffs.</p>
        <p id="P93"><bold>C,D)</bold> Reproduction of the cryoDRGN latent space shown in <xref rid="F5" ref-type="fig">Figure 5G</xref>, colored by minor assembly state (<bold>C</bold>), or viewed in separate panels (<bold>D</bold>).</p>
      </caption>
      <graphic xlink:href="nihms-1656428-f0012"/>
    </fig>
    <fig id="F13" orientation="portrait" position="anchor">
      <label>Extended Data Figure 7.</label>
      <caption>
        <title>Validation of LSU class C4 with cryoSPARC.</title>
        <p id="P94"><bold>A)</bold> Density map from cryoSPARC homogeneous refinement of the 1,113 particles selected from the cryoDRGN latent representation that constitute class C4 (right), compared with the density map generated by cryoDRGN (left) from <xref rid="F5" ref-type="fig">Figure 5I</xref>. rRNA helix 68 is circled in red.</p>
        <p id="P95"><bold>B)</bold> Gold standard FSC (GSFSC) curve between independent half-maps of the cryoSPARC reconstruction and map-to-map FSC between the cryoDRGN and cryoSPARC maps shown in (<bold>A</bold>). Dotted lines indicate 0.5 and 0.143 cutoffs.</p>
      </caption>
      <graphic xlink:href="nihms-1656428-f0013"/>
    </fig>
    <fig id="F14" orientation="portrait" position="anchor">
      <label>Extended Data Figure 8.</label>
      <caption>
        <title>Reproducibility of cryoDRGN’s latent space representation of the assembling ribosome.</title>
        <p id="P96"><bold>A)</bold> UMAP visualization of the latent encodings from replicate runs of cryoDRGN trained on the filtered particles of EMPIAR-10076. Particle embeddings are colored by major assembly state assigned from 3D classification in <italic>Davis et al</italic><sup><xref rid="R12" ref-type="bibr">12</xref></sup>.</p>
        <p id="P97"><bold>B)</bold> UMAP visualization of (<bold>A</bold>), colored by cluster after fitting a 5-component Gaussian mixture model on the UMAP embeddings.</p>
        <p id="P98"><bold>C, D)</bold> Consistency of the GMM labeling between replicates reported as the percentage of particles with identical labels (<bold>C</bold>) and the confusion matrix of GMM cluster assignments (<bold>D</bold>).</p>
      </caption>
      <graphic xlink:href="nihms-1656428-f0014"/>
    </fig>
    <fig id="F15" orientation="portrait" position="anchor">
      <label>Extended Data Figure 9.</label>
      <caption>
        <title>Comparison of multi-body refinement and cryoDRGN of the pre-catalytic spliceosome.</title>
        <p id="P99"><bold>A)</bold> Visualization of a rigid-body trajectory from multibody refinement of the pre-catalytic spliceosome. Snapshots are extracted from the trajectory along PC1 of rigid-body orientations, showing a large-scale motion of the SF3b subcomplex. The masks that define the rigid-body decomposition of the complex are shown on the right. The circle highlights a helix that breaks at the boundary between bodies where the rigid-body assumption no longer holds. Adapted from Video 3 of Nakane <italic>et al.</italic><sup><xref rid="R19" ref-type="bibr">19</xref></sup> and density maps and masks deposited in EMPIAR-10180.</p>
        <p id="P100"><bold>B)</bold> Alternate view of cryoDRGN’s PC1 traversal in <xref rid="F6" ref-type="fig">Figure 6</xref>. CryoDRGN learns the same overall motion of the SF3b subcomplex, however its neural network representation lacks the helix-breaking artifact.</p>
      </caption>
      <graphic xlink:href="nihms-1656428-f0015"/>
    </fig>
    <fig id="F16" orientation="portrait" position="anchor">
      <label>Extended Data Figure 10.</label>
      <caption>
        <title>Comparison of cryoSPARC’s 3D variability analysis and cryoDRGN.</title>
        <p id="P101"><bold>A)</bold> Density map of the consensus reconstruction and 2D projections of the top three 3DVA variability components (<italic>i.e.</italic> eigen-volumes) that form a linear basis describing structural heterogeneity of the pre-catalytic spliceosome.</p>
        <p id="P102"><bold>B)</bold> 3DVA latent encodings of particles from the filtered EMPIAR-10180 dataset.</p>
        <p id="P103"><bold>C)</bold> Comparison of 3DVA component 1 latent encodings and PC1 of the cryoDRGN 10-D latent encodings from <xref rid="F6" ref-type="fig">Figure 6C</xref>. Correlation indicates Spearman correlation.</p>
        <p id="P104"><bold>D)</bold> 3DVA component 1 trajectory at the depicted points in (<bold>B</bold>).</p>
        <p id="P105"><bold>E)</bold> Alternate view of the density maps from the cryoDRGN PC1 trajectory in <xref rid="F6" ref-type="fig">Figure 6D</xref>.</p>
      </caption>
      <graphic xlink:href="nihms-1656428-f0016"/>
    </fig>
  </sec>
  <sec sec-type="supplementary-material" id="SM1">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="SD1">
      <label>SuppMaterial</label>
      <media xlink:href="NIHMS1656428-supplement-SuppMaterial.pdf" orientation="portrait" id="d40e2523" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD2">
      <label>1656428_SuppVideo1</label>
      <media xlink:href="NIHMS1656428-supplement-1656428_SuppVideo1.mp4" orientation="portrait" id="d40e2527" position="anchor" mimetype="video"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD3">
      <label>1656428_SuppVideo2</label>
      <media xlink:href="NIHMS1656428-supplement-1656428_SuppVideo2.mp4" orientation="portrait" id="d40e2531" position="anchor" mimetype="video"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD4">
      <label>1656428_SuppVideo3</label>
      <media xlink:href="NIHMS1656428-supplement-1656428_SuppVideo3.mp4" orientation="portrait" id="d40e2535" position="anchor" mimetype="video"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD5">
      <label>1656428_SuppTable1</label>
      <media xlink:href="NIHMS1656428-supplement-1656428_SuppTable1.docx" orientation="portrait" id="d40e2539" position="anchor"/>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="SD6">
      <label>1656428_SuppVideo4</label>
      <media xlink:href="NIHMS1656428-supplement-1656428_SuppVideo4.mp4" orientation="portrait" id="d40e2543" position="anchor" mimetype="video"/>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack id="S60">
    <title>Acknowledgements</title>
    <p id="P106">We thank A. Lerer, R. Lederman, B. Demeo, A. Narayan, K. Kelley, B. Sauer, P. Sharp, S. Rodriques, and D. Haselbach for helpful discussions and feedback. We are grateful to the MIT-IBM Satori team for GPU computing resources and support. This work was funded by the National Science Foundation Graduate Research Fellowship Program to E.D.Z., NIH grant R01-GM081871 to B.B., NIH grant R00-AG050749 to J.H.D., NVIDIA-GPU grant to J.H.D., and a grant from the MIT J-Clinic for Machine Learning and Health to J.H.D. and B.B.</p>
  </ack>
  <fn-group>
    <fn fn-type="COI-statement" id="FN2">
      <p id="P116">Ethics Declaration</p>
      <p id="P117">The authors declare no competing financial interests.</p>
    </fn>
    <fn id="FN3">
      <label>1</label>
      <p id="P118">Number of pixels along one dimension of the image, i.e. a <italic>D</italic> × <italic>D</italic> image</p>
    </fn>
  </fn-group>
  <ref-list>
    <title>References</title>
    <ref id="R1">
      <label>1.</label>
      <mixed-citation publication-type="journal"><name><surname>Nogales</surname><given-names>E</given-names></name>. <article-title>The development of cryo-EM into a mainstream structural biology technique</article-title>. <source>Nat. Methods</source><volume>13</volume>, <fpage>24</fpage>–<lpage>27</lpage> (<year>2015</year>).</mixed-citation>
    </ref>
    <ref id="R2">
      <label>2.</label>
      <mixed-citation publication-type="journal"><name><surname>Cheng</surname><given-names>Y</given-names></name>. <article-title>Single-particle cryo-EM-How did it get here and where will it go</article-title>. <source>Science</source>. <volume>361</volume>, <fpage>876</fpage>–<lpage>880</lpage> (<year>2018</year>).<pub-id pub-id-type="pmid">30166484</pub-id></mixed-citation>
    </ref>
    <ref id="R3">
      <label>3.</label>
      <mixed-citation publication-type="journal"><name><surname>Bammes</surname><given-names>BE</given-names></name>, <name><surname>Rochat</surname><given-names>RH</given-names></name>, <name><surname>Jakana</surname><given-names>J</given-names></name>, <name><surname>Chen</surname><given-names>D-H</given-names></name> &amp; <name><surname>Chiu</surname><given-names>W</given-names></name>. <article-title>Direct electron detection yields cryo-EM reconstructions at resolutions beyond 3/4 Nyquist frequency</article-title>. <source>J. Struct. Biol</source>
<volume>177</volume>, <fpage>589</fpage>–<lpage>601</lpage> (<year>2012</year>).<pub-id pub-id-type="pmid">22285189</pub-id></mixed-citation>
    </ref>
    <ref id="R4">
      <label>4.</label>
      <mixed-citation publication-type="journal"><name><surname>Suloway</surname><given-names>C</given-names></name>. <etal/><article-title>Automated molecular microscopy: The new Leginon system</article-title>. <source>J. Struct. Biol</source><volume>151</volume>, <fpage>41</fpage>–<lpage>60</lpage> (<year>2005</year>).<pub-id pub-id-type="pmid">15890530</pub-id></mixed-citation>
    </ref>
    <ref id="R5">
      <label>5.</label>
      <mixed-citation publication-type="journal"><name><surname>Li</surname><given-names>X</given-names></name>. <etal/><article-title>Electron counting and beam-induced motion correction enable near-atomic-resolution single-particle cryo-EM</article-title>. <source>Nat. Methods</source><volume>10</volume>, <fpage>584</fpage>–<lpage>590</lpage> (<year>2013</year>).<pub-id pub-id-type="pmid">23644547</pub-id></mixed-citation>
    </ref>
    <ref id="R6">
      <label>6.</label>
      <mixed-citation publication-type="journal"><name><surname>Zhang</surname><given-names>K</given-names></name>. <article-title>Gctf: Real-time CTF determination and correction</article-title>. <source>J. Struct. Biol</source><volume>193</volume>, <fpage>1</fpage>–<lpage>12</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">26592709</pub-id></mixed-citation>
    </ref>
    <ref id="R7">
      <label>7.</label>
      <mixed-citation publication-type="journal"><name><surname>Brubaker</surname><given-names>MA</given-names></name>, <name><surname>Punjani</surname><given-names>A</given-names></name>. &amp; <name><surname>Fleet</surname><given-names>DJ</given-names></name>
<article-title>Building Proteins in a Day: Efficient 3D Molecular Reconstruction</article-title>. <source>Proc. IEEE Comput. Soc. Conf. Comput. Vis. Pattern Recognit</source>, <fpage>3099</fpage>–<lpage>3108</lpage> (<year>2015</year>).</mixed-citation>
    </ref>
    <ref id="R8">
      <label>8.</label>
      <mixed-citation publication-type="journal"><name><surname>Scheres</surname><given-names>SHW</given-names></name><article-title>A Bayesian view on cryo-EM structure determination</article-title>. <source>J. Mol. Biol</source><volume>415</volume>, <fpage>406</fpage>–<lpage>418</lpage> (<year>2012</year>).<pub-id pub-id-type="pmid">22100448</pub-id></mixed-citation>
    </ref>
    <ref id="R9">
      <label>9.</label>
      <mixed-citation publication-type="journal"><name><surname>Bepler</surname><given-names>T</given-names></name>. <etal/><article-title>Positive-unlabeled convolutional neural networks for particle picking in cryo-electron micrographs</article-title>. <source>Nat. Methods</source><volume>16</volume>, <fpage>1153</fpage>–<lpage>1160</lpage> (<year>2019</year>).<pub-id pub-id-type="pmid">31591578</pub-id></mixed-citation>
    </ref>
    <ref id="R10">
      <label>10.</label>
      <mixed-citation publication-type="journal"><name><surname>Ahmed</surname><given-names>T</given-names></name>, <name><surname>Yin</surname><given-names>Z</given-names></name>. &amp; <name><surname>Bhushan</surname><given-names>S</given-names></name>. <article-title>Cryo-EM structure of the large subunit of the spinach chloroplast ribosome</article-title>. <source>Sci. Rep</source>
<volume>6</volume>, <fpage>1</fpage>–<lpage>13</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">28442746</pub-id></mixed-citation>
    </ref>
    <ref id="R11">
      <label>11.</label>
      <mixed-citation publication-type="journal"><name><surname>Wrapp</surname><given-names>D</given-names></name>. <etal/><article-title>Cryo-EM structure of the 2019-nCoV spike in the prefusion conformation</article-title>. <source>Science</source>. <volume>367</volume>, <fpage>1260</fpage>–<lpage>1263</lpage> (<year>2020</year>).<pub-id pub-id-type="pmid">32075877</pub-id></mixed-citation>
    </ref>
    <ref id="R12">
      <label>12.</label>
      <mixed-citation publication-type="journal"><name><surname>Davis</surname><given-names>JH</given-names></name><etal/><article-title>Modular Assembly of the Bacterial Large Ribosomal Subunit</article-title>. <source>Cell</source><volume>167</volume>, 1610−−1622.e15 (<year>2016</year>).</mixed-citation>
    </ref>
    <ref id="R13">
      <label>13.</label>
      <mixed-citation publication-type="journal"><name><surname>Haselbach</surname><given-names>D</given-names></name>. <etal/><article-title>Structure and Conformational Dynamics of the Human Spliceosomal Bact Complex</article-title>. <source>Cell</source><volume>172</volume>, 454−−464.e11 (<year>2018</year>).</mixed-citation>
    </ref>
    <ref id="R14">
      <label>14.</label>
      <mixed-citation publication-type="journal"><name><surname>Sigworth</surname><given-names>FJ</given-names></name><article-title>Principles of cryo-EM single-particle image processing</article-title>. <source>Microscopy (Oxf.)</source><volume>65</volume>, <fpage>57</fpage>–<lpage>67</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">26705325</pub-id></mixed-citation>
    </ref>
    <ref id="R15">
      <label>15.</label>
      <mixed-citation publication-type="journal"><name><surname>Scheres</surname><given-names>SHW</given-names></name><article-title>RELION: implementation of a Bayesian approach to cryo-EM structure determination</article-title>. <source>J. Struct. Biol</source><volume>180</volume>, <fpage>519</fpage>–<lpage>530</lpage> (<year>2012</year>).<pub-id pub-id-type="pmid">23000701</pub-id></mixed-citation>
    </ref>
    <ref id="R16">
      <label>16.</label>
      <mixed-citation publication-type="journal"><name><surname>Punjani</surname><given-names>A</given-names></name>, <name><surname>Rubinstein</surname><given-names>JL</given-names></name>, <name><surname>Fleet</surname><given-names>DJ</given-names></name> &amp; <name><surname>Brubaker</surname><given-names>MA</given-names></name>
<article-title>cryoSPARC: algorithms for rapid unsupervised cryo-EM structure determination</article-title>. <source>Nat. Methods</source>
<volume>14</volume>, <fpage>290</fpage>–<lpage>296</lpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28165473</pub-id></mixed-citation>
    </ref>
    <ref id="R17">
      <label>17.</label>
      <mixed-citation publication-type="journal"><name><surname>Lyumkis</surname><given-names>D</given-names></name>, <name><surname>Brilot</surname><given-names>AF</given-names></name>, <name><surname>Theobald</surname><given-names>DL</given-names></name> &amp; <name><surname>Grigorieff</surname><given-names>N</given-names></name>. <article-title>Likelihood-based classification of cryo-EM images using FREALIGN</article-title>. <source>J. Struct. Biol</source>
<volume>183</volume>, <fpage>377</fpage>–<lpage>388</lpage> (<year>2013</year>).<pub-id pub-id-type="pmid">23872434</pub-id></mixed-citation>
    </ref>
    <ref id="R18">
      <label>18.</label>
      <mixed-citation publication-type="journal"><name><surname>Grant</surname><given-names>T</given-names></name>, <name><surname>Rohou</surname><given-names>A</given-names></name>. &amp; <name><surname>Grigorieff</surname><given-names>N</given-names></name>. <article-title>cisTEM, user-friendly software for single-particle image processing</article-title>. <source>Elife</source>
<volume>7</volume>, e14874 (<year>2018</year>).</mixed-citation>
    </ref>
    <ref id="R19">
      <label>19.</label>
      <mixed-citation publication-type="journal"><name><surname>Nakane</surname><given-names>T</given-names></name>, <name><surname>Kimanius</surname><given-names>D</given-names></name>, <name><surname>Lindahl</surname><given-names>E</given-names></name>. &amp; <name><surname>Scheres</surname><given-names>SH</given-names></name>
<article-title>Characterisation of molecular motions in cryo-EM single-particle data by multi-body refinement in RELION</article-title>. <source>Elife</source>
<volume>7</volume>, e36861 (<year>2018</year>).</mixed-citation>
    </ref>
    <ref id="R20">
      <label>20.</label>
      <mixed-citation publication-type="journal"><name><surname>Liu</surname><given-names>W</given-names></name>. &amp; <name><surname>Frank</surname><given-names>J</given-names></name>. <article-title>Estimation of variance distribution in three-dimensional reconstruction I Theory</article-title>. <source>J. Opt. Soc. Am. A</source> (<year>1995</year>) doi:<pub-id pub-id-type="doi">10.1364/josaa.12.002615</pub-id><comment>.</comment></mixed-citation>
    </ref>
    <ref id="R21">
      <label>21.</label>
      <mixed-citation publication-type="journal"><name><surname>Penczek</surname><given-names>PA</given-names></name>, <name><surname>Kimmel</surname><given-names>M</given-names></name>. &amp; <name><surname>Spahn</surname><given-names>CMT</given-names></name>
<article-title>Identifying conformational states of macromolecules by eigen-analysis of resampled cryo-EM images</article-title>. <source>Structure</source>
<volume>19</volume>, <fpage>1582</fpage>–<lpage>1590</lpage> (<year>2011</year>).<pub-id pub-id-type="pmid">22078558</pub-id></mixed-citation>
    </ref>
    <ref id="R22">
      <label>22.</label>
      <mixed-citation publication-type="journal"><name><surname>Tagare</surname><given-names>HD</given-names></name>, <name><surname>Kucukelbir</surname><given-names>A</given-names></name>, <name><surname>Sigworth</surname><given-names>FJ</given-names></name>, <name><surname>Wang</surname><given-names>H</given-names></name>. &amp; <name><surname>Rao</surname><given-names>M</given-names></name>. <article-title>Directly reconstructing principal components of heterogeneous particles from cryo-EM images</article-title>. <source>J. Struct. Biol</source>
<volume>191</volume>, <fpage>245</fpage>–<lpage>262</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">26049077</pub-id></mixed-citation>
    </ref>
    <ref id="R23">
      <label>23.</label>
      <mixed-citation publication-type="journal"><name><surname>Punjani</surname><given-names>A</given-names></name>. &amp; <name><surname>Fleet</surname><given-names>DJ</given-names></name>
<article-title>3D Variability Analysis: Directly resolving continuous flexibility and discrete heterogeneity from single particle cryo-EM images</article-title>. <source>bioRxiv</source>
<volume>11</volume>, 2020.04.08.032466 (<year>2020</year>).</mixed-citation>
    </ref>
    <ref id="R24">
      <label>24.</label>
      <mixed-citation publication-type="journal"><name><surname>Dashti</surname><given-names>A</given-names></name>. <etal/><article-title>Trajectories of the ribosome as a Brownian nanomachine</article-title>. <source>Proc. Natl. Acad. Sci. U. S. A</source><volume>111</volume>, 17492–17497 (<year>2014</year>).</mixed-citation>
    </ref>
    <ref id="R25">
      <label>25.</label>
      <mixed-citation publication-type="journal"><name><surname>Frank</surname><given-names>J</given-names></name>. &amp; <name><surname>Ourmazd</surname><given-names>A</given-names></name>. <article-title>Continuous changes in structure mapped by manifold embedding of single-particle data in cryo-EM</article-title>. <source>Methods</source>
<volume>100</volume>, <fpage>61</fpage>–<lpage>67</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">26884261</pub-id></mixed-citation>
    </ref>
    <ref id="R26">
      <label>26.</label>
      <mixed-citation publication-type="journal"><name><surname>Moscovich</surname><given-names>A</given-names></name>, <name><surname>Halevi</surname><given-names>A</given-names></name>, <name><surname>Andén</surname><given-names>J</given-names></name>. &amp; <name><surname>Singer</surname><given-names>A</given-names></name>. <article-title>Cryo-EM reconstruction of continuous heterogeneity by Laplacian spectral volumes</article-title>. <source>Inverse Probl</source>. (<year>2020</year>) doi:<pub-id pub-id-type="doi">10.1088/1361-6420/ab4f55</pub-id><comment>.</comment></mixed-citation>
    </ref>
    <ref id="R27">
      <label>27.</label>
      <mixed-citation publication-type="journal"><name><surname>Lederman</surname><given-names>RR</given-names></name> &amp; <name><surname>Singer</surname><given-names>A</given-names></name>. <article-title>Continuously heterogeneous hyper-objects in cryo-EM and 3-D movies of many temporal dimensions</article-title>. <source>arXiv 1704.02899</source> (<year>2017</year>).</mixed-citation>
    </ref>
    <ref id="R28">
      <label>28.</label>
      <mixed-citation publication-type="journal"><name><surname>Hornik</surname><given-names>K</given-names></name>, <name><surname>Stinchcombe</surname><given-names>MB</given-names></name> &amp; <name><surname>White</surname><given-names>H</given-names></name>. <article-title>Multilayer feedforward networks are universal approximators</article-title>. <source>Neural Networks</source>
<volume>2</volume>, <fpage>359</fpage>–<lpage>366</lpage> (<year>1989</year>).</mixed-citation>
    </ref>
    <ref id="R29">
      <label>29.</label>
      <mixed-citation publication-type="journal"><name><surname>Bracewell</surname><given-names>RN</given-names></name><article-title>Strip Integration in Radio Astronomy</article-title>. <source>Aust. J. Phys</source><volume>9</volume>, <fpage>198</fpage>–<lpage>217</lpage> (<year>1956</year>).</mixed-citation>
    </ref>
    <ref id="R30">
      <label>30.</label>
      <mixed-citation publication-type="confproc"><name><surname>Kingma</surname><given-names>DP</given-names></name> &amp; <name><surname>Welling</surname><given-names>M</given-names></name>. <source>Auto-encoding variational bayes</source>. in <conf-name>International Conference on Learning Representations</conf-name>, <publisher-name>ICLR</publisher-name> (<year>2014</year>).</mixed-citation>
    </ref>
    <ref id="R31">
      <label>31.</label>
      <mixed-citation publication-type="journal"><name><surname>Ru</surname><given-names>H</given-names></name>. <etal/><article-title>Molecular Mechanism of V(D)J Recombination from Synaptic RAG1-RAG2 Complex Structures</article-title>. <source>Cell</source><volume>163</volume>, <fpage>1138</fpage>–<lpage>1152</lpage> (<year>2015</year>).<pub-id pub-id-type="pmid">26548953</pub-id></mixed-citation>
    </ref>
    <ref id="R32">
      <label>32.</label>
      <mixed-citation publication-type="journal"><name><surname>Wong</surname><given-names>W</given-names></name>. <etal/><article-title>Cryo-EM structure of the Plasmodium falciparum 80S ribosome bound to the anti-protozoan drug emetine</article-title>. <source>Elife</source><volume>3</volume>, e01963 (<year>2014</year>).</mixed-citation>
    </ref>
    <ref id="R33">
      <label>33.</label>
      <mixed-citation publication-type="journal"><name><surname>Ru</surname><given-names>H</given-names></name>, <name><surname>Zhang</surname><given-names>P</given-names></name>. &amp; <name><surname>Wu</surname><given-names>H</given-names></name>. <article-title>Structural gymnastics of RAG-mediated DNA cleavage in V(D)J recombination</article-title>. <source>Current Opinion in Structural Biology</source> (<year>2018</year>) doi:<pub-id pub-id-type="doi">10.1016/j.sbi.2018.11.001</pub-id><comment>.</comment></mixed-citation>
    </ref>
    <ref id="R34">
      <label>34.</label>
      <mixed-citation publication-type="journal"><name><surname>Sun</surname><given-names>M</given-names></name>. <etal/><article-title>Dynamical features of the Plasmodium falciparum ribosome during translation</article-title>. <source>Nucleic Acids Res</source>. (<year>2015</year>) doi:<pub-id pub-id-type="doi">10.1093/nar/gkv991</pub-id><comment>.</comment></mixed-citation>
    </ref>
    <ref id="R35">
      <label>35.</label>
      <mixed-citation publication-type="journal"><name><surname>McInnes</surname><given-names>L</given-names></name>, <name><surname>Healy</surname><given-names>J</given-names></name>. &amp; <name><surname>Melville</surname><given-names>J</given-names></name>. <article-title>UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction</article-title>. <source>arXiv 1802.03426</source> (<year>2018</year>).</mixed-citation>
    </ref>
    <ref id="R36">
      <label>36.</label>
      <mixed-citation publication-type="journal"><name><surname>Plaschka</surname><given-names>C</given-names></name>, <name><surname>Lin</surname><given-names>P-C</given-names></name> &amp; <name><surname>Nagai</surname><given-names>K</given-names></name>. <article-title>Structure of a pre-catalytic spliceosome</article-title>. <source>Nature</source>
<volume>546</volume>, <fpage>617</fpage>–<lpage>621</lpage> (<year>2017</year>).<pub-id pub-id-type="pmid">28530653</pub-id></mixed-citation>
    </ref>
    <ref id="R37">
      <label>37.</label>
      <mixed-citation publication-type="book"><name><surname>Cormen</surname><given-names>TH</given-names></name>, <name><surname>Leiserson</surname><given-names>CE</given-names></name>, <name><surname>Rivest</surname><given-names>RL</given-names></name> &amp; <name><surname>Stein</surname><given-names>C</given-names></name>. <source>Introduction to Algorithms</source>. in <fpage>595</fpage>–<lpage>601</lpage> (<publisher-name>MIT Press and McGraw-Hill</publisher-name>).</mixed-citation>
    </ref>
    <ref id="R38">
      <label>38.</label>
      <mixed-citation publication-type="journal"><name><surname>Zhang</surname><given-names>C</given-names></name>, <name><surname>Bengio</surname><given-names>S</given-names></name>, <name><surname>Hardt</surname><given-names>M</given-names></name>, <name><surname>Recht</surname><given-names>B</given-names></name>. &amp; <name><surname>Vinyals</surname><given-names>O</given-names></name>. <article-title>Understanding deep learning requires rethinking generalization</article-title>. <source>Int. Conf. Learn. Represent. ICLR</source> (<year>2017</year>).</mixed-citation>
    </ref>
    <ref id="R39">
      <label>39.</label>
      <mixed-citation publication-type="journal"><name><surname>Zivanov</surname><given-names>J</given-names></name>, <name><surname>Nakane</surname><given-names>T</given-names></name>. &amp; <name><surname>Scheres</surname><given-names>SHW</given-names></name>
<article-title>Estimation of high-order aberrations and anisotropic magnification from cryo-EM data sets in RELION-3.1</article-title>. <source>IUCrJ</source>
<volume>7</volume>, <fpage>253</fpage>–<lpage>267</lpage> (<year>2020</year>).</mixed-citation>
    </ref>
    <ref id="R40">
      <label>40.</label>
      <mixed-citation publication-type="journal"><name><surname>Punjani</surname><given-names>A</given-names></name>, <name><surname>Zhang</surname><given-names>H</given-names></name>. &amp; <name><surname>Fleet</surname><given-names>DJ</given-names></name>
<article-title>Non-uniform refinement: Adaptive regularization improves single particle cryo-EM reconstruction</article-title>. <source>bioRxiv</source>
<volume>179</volume>, 2019.12.15.877092 (<year>2019</year>).</mixed-citation>
    </ref>
  </ref-list>
  <ref-list>
    <title>Methods-only References</title>
    <ref id="R41">
      <label>41.</label>
      <mixed-citation publication-type="journal"><name><surname>Zhong</surname><given-names>ED</given-names></name>, <name><surname>Bepler</surname><given-names>T</given-names></name>, <name><surname>Davis</surname><given-names>JH</given-names></name> &amp; <name><surname>Berger</surname><given-names>B</given-names></name>. <article-title>Reconstructing continuous distributions of 3</article-title><source>D protein structure from cryo-EM images in International Conference of Learning Representations</source>, ICLR (2020).</mixed-citation>
    </ref>
    <ref id="R42">
      <label>42.</label>
      <mixed-citation publication-type="journal"><name><surname>Bepler</surname><given-names>T</given-names></name>, <name><surname>Zhong</surname><given-names>E</given-names></name>, <name><surname>Kelley</surname><given-names>K</given-names></name>, <name><surname>Brignole</surname><given-names>E</given-names></name>. &amp; <name><surname>Berger</surname><given-names>B</given-names></name>. <article-title>Explicitly disentangling image content from translation and rotation with spatial-VAE</article-title>. in <source>Advances in Neural Information Processing Systems</source> (<year>2019</year>).</mixed-citation>
    </ref>
    <ref id="R43">
      <label>43.</label>
      <mixed-citation publication-type="journal"><name><surname>Vaswani</surname><given-names>A</given-names></name>. <etal/><article-title>Attention is all you need</article-title>. in <source>Advances in Neural Information Processing Systems</source> (<year>2017</year>).</mixed-citation>
    </ref>
    <ref id="R44">
      <label>44.</label>
      <mixed-citation publication-type="journal"><name><surname>Rezende</surname><given-names>DJ</given-names></name>, <name><surname>Mohamed</surname><given-names>S</given-names></name>. &amp; <name><surname>Wierstra</surname><given-names>D</given-names></name>. <article-title>Stochastic backpropagation and approximate inference in deep generative models</article-title>. in <source>International Conference on Machine Learning</source>, ICML (<year>2014</year>).</mixed-citation>
    </ref>
    <ref id="R45">
      <label>45.</label>
      <mixed-citation publication-type="journal"><source>The PyMOL Molecular Graphics System</source>, Version 2.3, Schrodinger, LLC.</mixed-citation>
    </ref>
    <ref id="R46">
      <label>46.</label>
      <mixed-citation publication-type="journal"><name><surname>Tang</surname><given-names>G</given-names></name>. <etal/><article-title>EMAN2: an extensible image processing suite for electron microscopy</article-title>. <source>J. Struct. Biol</source><volume>157</volume>, <fpage>38</fpage>–<lpage>46</lpage> (<year>2007</year>).<pub-id pub-id-type="pmid">16859925</pub-id></mixed-citation>
    </ref>
    <ref id="R47">
      <label>47.</label>
      <mixed-citation publication-type="journal"><name><surname>Pettersen</surname><given-names>EF</given-names></name><etal/><article-title>UCSF Chimera - A visualization system for exploratory research and analysis</article-title>. <source>J. Comput. Chem</source><volume>25</volume>, <fpage>1605</fpage>–<lpage>1612</lpage> (<year>2004</year>).<pub-id pub-id-type="pmid">15264254</pub-id></mixed-citation>
    </ref>
    <ref id="R48">
      <label>48.</label>
      <mixed-citation publication-type="journal"><name><surname>Iudin</surname><given-names>A</given-names></name>, <name><surname>Korir</surname><given-names>PK</given-names></name>, <name><surname>Salavert-Torres</surname><given-names>J</given-names></name>, <name><surname>Kleywegt</surname><given-names>GJ</given-names></name> &amp; <name><surname>Patwardhan</surname><given-names>A</given-names></name>. <article-title>EMPIAR: a public archive for raw electron microscopy image data</article-title>. <source>Nat. Methods</source>
<volume>13</volume>, <fpage>387</fpage>–<lpage>388</lpage> (<year>2016</year>).<pub-id pub-id-type="pmid">27067018</pub-id></mixed-citation>
    </ref>
    <ref id="R49">
      <label>49.</label>
      <mixed-citation publication-type="journal"><name><surname>Rosenthal</surname><given-names>PB</given-names></name> &amp; <name><surname>Henderson</surname><given-names>R</given-names></name>. <article-title>Optimal determination of particle orientation, absolute hand, and contrast loss in single-particle electron cryomicroscopy</article-title>. <source>J. Mol. Biol</source>
<volume>333</volume>, <fpage>721</fpage>–<lpage>745</lpage> (<year>2003</year>).<pub-id pub-id-type="pmid">14568533</pub-id></mixed-citation>
    </ref>
    <ref id="R50">
      <label>50.</label>
      <mixed-citation publication-type="journal"><name><surname>Pedregosa</surname><given-names>F</given-names></name>. <etal/> Scikit-learn: <source>Machine Learning in Python. J. Mach. Learn. Res</source>
<volume>12</volume>, <fpage>2825</fpage>–<lpage>2830</lpage> (<year>2011</year>).</mixed-citation>
    </ref>
    <ref id="R51">
      <label>51.</label>
      <mixed-citation publication-type="journal"><name><surname>Goddard</surname><given-names>TD</given-names></name><etal/><article-title>UCSF ChimeraX: Meeting modern challenges in visualization and analysis</article-title>. <source>Protein Sci</source>. <volume>27</volume>, <fpage>14</fpage>–<lpage>25</lpage> (<year>2018</year>).<pub-id pub-id-type="pmid">28710774</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig id="F1" orientation="portrait" position="float">
    <label>Figure 1.</label>
    <caption>
      <title>The cryoDRGN method for heterogeneous single particle cryo-EM reconstruction.</title>
      <p id="P119"><bold>A)</bold> The cryoDRGN model consists of two neural networks structured in an image encoder-volume decoder architecture with a continuous latent variable representation of heterogeneity. During training, each particle image is encoded into the low-dimensional latent space, and then reconstructed as its corresponding model slice based on the Fourier slice theorem. Image and volume data are depicted in real space for visual clarity.</p>
      <p id="P120"><bold>B)</bold> Once a cryoDRGN model has been trained, the full dataset of particle images is encoded into the latent space, which is visualized as a contour map here with darker regions corresponding to higher particle density (center). The decoder, which represents an ensemble of 3D density maps, can directly generate density maps from arbitrary values of the latent variable (right). The particle stack may also be filtered using the latent space representation for validation of specific structures via traditional tools or to remove impurities from the dataset (left). Example images from EMPIAR-10180<sup><xref rid="R36" ref-type="bibr">36</xref></sup>.</p>
    </caption>
    <graphic xlink:href="nihms-1656428-f0001"/>
  </fig>
  <fig id="F2" orientation="portrait" position="float">
    <label>Figure 2)</label>
    <caption>
      <title>Neural network representation of cryo-EM density maps.</title>
      <p id="P121"><bold>A)</bold> Density maps of the RAG1-RAG2 complex (EMPIAR-10049)<sup><xref rid="R31" ref-type="bibr">31</xref></sup> and of the eukaryotic <italic>Pf</italic>80S ribosome (EMPIAR-10028)<sup><xref rid="R32" ref-type="bibr">32</xref></sup> reconstructed by cryoDRGN’s decoder neural network (left) and a traditional, voxel-based reconstruction in cryoSPARC (right). The cryoDRGN volumes were generated from decoder networks with 3 hidden layers and 1024 nodes per hidden layer (denoted as 1024 × 3) trained for 25 epochs.</p>
      <p id="P122"><bold>B)</bold> Fourier shell correlation (FSC) curves between density maps produced by the cryoDRGN decoder of varying architecture and the traditional reconstruction in (A).</p>
      <p id="P123"><bold>C,D)</bold> Evolution of the FSC curve in (B) and the training curve over multiple epochs of cryoDRGN model training.</p>
      <p id="P124"><bold>E)</bold> Training speed in minutes per 100k images for cryoDRGN decoder networks of different architectures on different image sizes (D, in pixels) on a single Nvidia V100 GPU.</p>
      <p id="P125"><bold>F)</bold> Representative regions of the RAG1-RAG2 density map from cryoDRGN superimposed with the published atomic model (PDB: 3JBX).</p>
    </caption>
    <graphic xlink:href="nihms-1656428-f0002"/>
  </fig>
  <fig id="F3" orientation="portrait" position="float">
    <label>Figure 3)</label>
    <caption>
      <title>CryoDRGN heterogeneous reconstruction of simulated datasets.</title>
      <p id="P126"><bold>A)</bold> Ground truth density maps simulating continuous heterogeneity generated by sampling conformations along a 1-D conformational transition from leftmost to rightmost structure (left). Particles along this conformation transition were sampled uniformly (top), or with a mixture of Gaussians of varying widths (middle, bottom) to simulate various degrees of cooperative transitions between three states.</p>
      <p id="P127"><bold>B)</bold> Compositional heterogeneity simulated by mixing particles of the 30S, 50S, and 70S bacterial ribosomal complexes.</p>
      <p id="P128"><bold>C)</bold> Density maps reconstructed by cryoDRGN trained on the uniformly sampled dataset in (<bold>A</bold>). Six structures are sampled from the specified values of the latent variable (top). “Per-image” Fourier Shell Correlation (FSC) curves are shown, where for 100 images equally spaced along the reaction coordinate, we compute the FSC between a map generated by cryoDRGN at the predicted latent encoding for each image and ground truth density map for that image (bottom). See <xref rid="S15" ref-type="sec">Methods</xref> for description of the “Per-image” FSC approach.</p>
      <p id="P129"><bold>D)</bold> Density maps reconstructed by cryoDRGN from the <italic>Compositional</italic> dataset in (<bold>B</bold>), and their FSC to the corresponding ground truth density map.</p>
      <p id="P130"><bold>E-H)</bold> Predicted latent space encoding for each particle image of different simulated datasets versus the ground truth reaction coordinate describing the motion (<bold>E,F,G</bold>) or the ground truth class assignment (<bold>H</bold>).</p>
      <p id="P131">All cryoDRGN reconstructions use a 1-D latent variable model.</p>
    </caption>
    <graphic xlink:href="nihms-1656428-f0003"/>
  </fig>
  <fig id="F4" orientation="portrait" position="float">
    <label>Figure 4.</label>
    <caption>
      <title>Discovery of residual heterogeneity in “homogeneous” datasets.</title>
      <p id="P132"><bold>A)</bold> Published density maps of the 369 kDa RAG1-RAG2 complex. The signal end complex (left) shows the C2 symmetric core and the paired complex (right) resolves additional asymmetric 12- and 23-RSS DNA elements and the RAG-1 nonamer binding domain (NBD) that extend below the core.</p>
      <p id="P133"><bold>B)</bold> Representative density maps of the RAG signal end complex (EMPIAR-10049)<sup><xref rid="R31" ref-type="bibr">31</xref></sup> reconstructed by cryoDRGN. Density maps resolve variable conformations of the 12- and 23-RSS DNA elements and the nonamer binding domain (NBD) missing from the homogeneous refinement. Docked atomic model (PDB: 3JBW) of the RAG paired complex includes an asymmetric conformation of the RSS and NBD elements outside of the core RAG complex.</p>
      <p id="P134"><bold>C)</bold> Latent space representation of particles images from EMPIAR-10049<sup><xref rid="R31" ref-type="bibr">31</xref></sup>, visualized using PCA with explained variance (EV) noted. Structures from (<bold>B</bold>) are marked with the corresponding color.</p>
      <p id="P135"><bold>D)</bold> Density map of the 4.2 MDa <italic>Pf</italic>80S ribosome (EMPIAR-10028)<sup><xref rid="R32" ref-type="bibr">32</xref></sup> in an unrotated (blue) and rotated (purple) state reconstructed by cryoDRGN. Arrows indicate rotation of the 40S subunit relative to the 60S subunit (top) and motion of the L1 stalk (bottom). Circles indicate differential occupancy of the C-terminal helix of <italic>eL8</italic> and an rRNA helix between the two states.</p>
      <p id="P136"><bold>E)</bold> Latent space representation of particle images from EMPIAR-10028<sup><xref rid="R32" ref-type="bibr">32</xref></sup>, visualized using PCA with explained variance (EV) noted. Structures from (<bold>D</bold>) are marked with the corresponding color. A cluster of particles separated along PC1 of (<bold>D</bold>) that corresponds to the rotated state of the <italic>Pf</italic>80S ribosome is noted.</p>
      <p id="P137">Additional density maps from these datasets are shown in <xref rid="F8" ref-type="fig">Extended Data Figure 2</xref> and <xref rid="SD2" ref-type="supplementary-material">Supplemental Videos 1</xref>
<bold>and</bold>
<xref rid="SD3" ref-type="supplementary-material">2</xref>.</p>
    </caption>
    <graphic xlink:href="nihms-1656428-f0004"/>
  </fig>
  <fig id="F5" orientation="portrait" position="float">
    <label>Figure 5.</label>
    <caption>
      <title>CryoDRGN heterogeneous reconstruction of the assembly landscape of the bacterial large ribosome subunit.</title>
      <p id="P138"><bold>A,B)</bold> Latent space representation of particle images of the assembling large ribosomal subunit (LSU) (EMPIAR-10076)<sup><xref rid="R12" ref-type="bibr">12</xref></sup> as a histogram or UMAP embeddings after training a cryoDRGN 1-D and 10-D latent variable model, respectively.</p>
      <p id="P139"><bold>C,D)</bold> Latent space representation of particles colored by major LSU assembly state assigned from 3D classification in <italic>Davis et al</italic><sup><xref rid="R12" ref-type="bibr">12</xref></sup>. Impurities in the dataset were assigned and subsequently filtered based on a cutoff of z = −1 in the 1-D case (dotted line), and cluster assignment from a 5-component Gaussian mixture model in the 10-D case. Dotted line in <bold>D</bold> indicates rough outline of cluster assignment, shown in <xref rid="F10" ref-type="fig">Extended Data Figure 4</xref>.</p>
      <p id="P140"><bold>E)</bold> Density maps reconstructed by cryoDRGN of the four major assembly states of the LSU, after training on the filtered dataset. Dotted line indicates outline of the fully mature 50S ribosome.</p>
      <p id="P141"><bold>F,G)</bold> Latent space representation of the filtered dataset, colored by major and minor assembly state assigned from 3D classification in <italic>Davis et al</italic><sup><xref rid="R12" ref-type="bibr">12</xref></sup>. Points denote cluster centers for the corresponding assembly state. Major assembly state labels correspond to the structures from (<bold>E</bold>). Inset shows magnified view of the state C cluster, and a population of particles originally mis-classified into state E.</p>
      <p id="P142"><bold>H,I)</bold> CryoDRGN reconstruction of additional density maps, showing the 70S ribosome, an impurity during purification, and LSU minor states C4 and E5. Newly identified C4 resembles major state C in maturation, but contains rRNA helix 68, previously present only in mature assembly states E4 and E5.</p>
      <p id="P143"><bold>J)</bold> Hyperparameters and runtime of the initial pilot experiments for particle filtering (<bold>A-D</bold>) and the final cryoDRGN model (<bold>E-I</bold>) trained on the assembling LSU dataset.</p>
      <p id="P144">Additional density maps are shown in <xref rid="F11" ref-type="fig">Extended Data Figure 5</xref> and <xref rid="SD4" ref-type="supplementary-material">Supplemental Video 3</xref>.</p>
    </caption>
    <graphic xlink:href="nihms-1656428-f0005"/>
  </fig>
  <fig id="F6" orientation="portrait" position="float">
    <label>Figure 6.</label>
    <caption>
      <title>CryoDRGN heterogeneous reconstruction of the pre-catalytic spliceosome.</title>
      <p id="P145"><bold>A)</bold> UMAP visualization of the latent space representation of particle images of pre-catalytic spliceosome (EMPIAR-10180)<sup><xref rid="R36" ref-type="bibr">36</xref></sup> after training a 10-D latent variable model with cryoDRGN.</p>
      <p id="P146"><bold>B)</bold> Representative structures generated at points shown in (<bold>A</bold>) that depict the expected structures of the pre-catalytic spliceosome (i,ii), structures likely corrupted by imaging artifacts (iii), the complex lacking the SF3b subcomplex (iv), and with the U2 core (v). Density maps are shown at identical isosurface levels except for (v) which required a lower value to highlight the U2 core.</p>
      <p id="P147"><bold>C)</bold> PCA projection of latent space encodings after training a 10-D latent variable model on the dataset filtered for the selected region in (<bold>A</bold>).</p>
      <p id="P148"><bold>D)</bold> Structures generated by traversing along PC1 of the latent space representation at points shown in (<bold>C</bold>).</p>
      <p id="P149">Additional density maps are shown in <xref rid="F13" ref-type="fig">Extended Data Figure 7</xref> and <xref rid="SD6" ref-type="supplementary-material">Supplemental Video 4</xref>.</p>
    </caption>
    <graphic xlink:href="nihms-1656428-f0006"/>
  </fig>
</floats-group>
