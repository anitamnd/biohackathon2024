<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD Journal Publishing DTD v2.3 20070202//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName journalpublishing.dtd?>
<?SourceDTD.Version 2.3?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 2?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">J Appl Crystallogr</journal-id>
    <journal-id journal-id-type="iso-abbrev">J Appl Crystallogr</journal-id>
    <journal-id journal-id-type="publisher-id">J. Appl. Cryst.</journal-id>
    <journal-title-group>
      <journal-title>Journal of Applied Crystallography</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">0021-8898</issn>
    <issn pub-type="epub">1600-5767</issn>
    <publisher>
      <publisher-name>International Union of Crystallography</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">4970500</article-id>
    <article-id pub-id-type="publisher-id">zd5005</article-id>
    <article-id pub-id-type="doi">10.1107/S1600576716009213</article-id>
    <article-id pub-id-type="coden">JACGAR</article-id>
    <article-id pub-id-type="pii">S1600576716009213</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Computer Programs</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title><italic>Condor</italic>: a simulation tool for flash X-ray imaging<xref ref-type="fn" rid="fn1">1</xref></article-title>
      <alt-title>
        <italic>Condor</italic>
      </alt-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Hantke</surname>
          <given-names>Max F.</given-names>
        </name>
        <xref ref-type="aff" rid="a">a</xref>
        <xref ref-type="corresp" rid="cor">*</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Ekeberg</surname>
          <given-names>Tomas</given-names>
        </name>
        <xref ref-type="aff" rid="a">a</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Maia</surname>
          <given-names>Filipe R. N. C.</given-names>
        </name>
        <xref ref-type="aff" rid="a">a</xref>
        <xref ref-type="aff" rid="b">b</xref>
      </contrib>
      <aff id="a"><label>a</label>Laboratory of Molecular Biophysics, Department of Cell and Molecular Biology, Uppsala University, Husargatan 3 (Box 596), SE-751 24 Uppsala, <country>Sweden</country></aff>
      <aff id="b"><label>b</label>NERSC, Lawrence Berkeley National Laboratory, Berkeley, California 94720, <country>USA</country></aff>
    </contrib-group>
    <author-notes>
      <corresp id="cor">Correspondence e-mail: <email>hantke@xray.bmc.uu.se</email></corresp>
    </author-notes>
    <pub-date pub-type="collection">
      <day>01</day>
      <month>8</month>
      <year>2016</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>14</day>
      <month>7</month>
      <year>2016</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>14</day>
      <month>7</month>
      <year>2016</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on the <pub-date pub-type="epub"/>. -->
    <volume>49</volume>
    <issue>Pt 4</issue>
    <issue-id pub-id-type="publisher-id">j160400</issue-id>
    <fpage>1356</fpage>
    <lpage>1362</lpage>
    <history>
      <date date-type="received">
        <day>03</day>
        <month>2</month>
        <year>2016</year>
      </date>
      <date date-type="accepted">
        <day>07</day>
        <month>6</month>
        <year>2016</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© Max F. Hantke et al. 2016</copyright-statement>
      <copyright-year>2016</copyright-year>
      <license license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/2.0/uk/">
        <license-p>This is an open-access article distributed under
the terms of the Creative Commons Attribution
Licence, which permits unrestricted use,
distribution, and reproduction in any medium,
provided the original authors and source are
cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:type="simple" xlink:href="http://dx.doi.org/10.1107/S1600576716009213">A full version of this
article is available from Crystallography Journals Online.</self-uri>
    <abstract abstract-type="toc">
      <p><italic>Condor</italic>, an open-source simulation tool to predict X-ray scattering amplitudes for flash X-ray imaging experiments, is introduced.</p>
    </abstract>
    <abstract>
      <p>Flash X-ray imaging has the potential to determine structures down to molecular resolution without the need for crystallization. The ability to accurately predict the diffraction signal and to identify the optimal experimental configuration within the limits of the instrument is important for successful data collection. This article introduces <italic>Condor</italic>, an open-source simulation tool to predict X-ray far-field scattering amplitudes of isolated particles for customized experimental designs and samples, which the user defines by an atomic or a refractive index model. The software enables researchers to test whether their envisaged imaging experiment is feasible, and to optimize critical parameters for reaching the best possible result. It also aims to support researchers who intend to create or advance reconstruction algorithms by simulating realistic test data. <italic>Condor</italic> is designed to be easy to use and can be either installed as a Python package or used from its web interface (<ext-link ext-link-type="uri" xlink:href="http://lmb.icm.uu.se/condor">http://lmb.icm.uu.se/condor</ext-link>). X-ray free-electron lasers have high running costs and beam time at these facilities is precious. Data quality can be substantially improved by using simulations to guide the experimental design and simplify data analysis.</p>
    </abstract>
    <kwd-group>
      <kwd>femtosecond coherent diffractive imaging</kwd>
      <kwd>X-ray free-electron lasers</kwd>
      <kwd>simulation</kwd>
      <kwd>single-particle imaging</kwd>
      <kwd>computer programs</kwd>
    </kwd-group>
  </article-meta>
</front>
<body>
  <sec id="sec1">
    <label>1.</label>
    <title>Introduction   </title>
    <p>Flash X-ray imaging (FXI) may become a tool to solve structures down to molecular resolution without the need for crystallization (Neutze <italic>et al.</italic>, 2000<xref ref-type="bibr" rid="bb22"> ▸</xref>; Bergh <italic>et al.</italic>, 2008<xref ref-type="bibr" rid="bb4"> ▸</xref>). By employing femtosecond pulses produced by X-ray free-electron lasers, FXI can outrun radiation damage processes that limit resolution (Chapman <italic>et al.</italic>, 2006<xref ref-type="bibr" rid="bb8"> ▸</xref>). FXI dispenses with image forming lenses and thereby circumvents the difficulty of manufacturing efficient lenses for X-rays (Chapman &amp; Nugent, 2010<xref ref-type="bibr" rid="bb9"> ▸</xref>). Aersosol sample delivery avoids a sample support, which means that the structure can be imaged with practically no background (Bogan <italic>et al.</italic>, 2008<xref ref-type="bibr" rid="bb6"> ▸</xref>; Seibert <italic>et al.</italic>, 2011<xref ref-type="bibr" rid="bb25"> ▸</xref>; Hantke <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb15"> ▸</xref>).</p>
    <p>For reaching the goal of 3 Å resolution, the Single Particle Imaging Initiative identifies the requirement of simulations that realistically represent the experiment conditions to guide future development (Aquila <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb2"> ▸</xref>). It is essential to optimize and harmonize all relevant experimental parameters, such as photon wavelength, photon flux, illumination profile, camera distance, detector settings, sample density and even sample type. Being able to accurately predict diffraction data facilitates optimization of the experimental setup and helps to provide accurate estimates of the expected data quality. Simulation tools can help researchers to use their beam time more efficiently and measure diffraction data at the highest possible quality.</p>
    <p>Software for simulating X-ray diffraction data exists. For crystal diffraction, for example, <italic>CCP4</italic> (Winn <italic>et al.</italic>, 2011<xref ref-type="bibr" rid="bb28"> ▸</xref>) is widely used. But it is aimed at crystal diffraction, making it hard to use for simulating continuous diffraction patterns. In a couple of publications (Yefanov &amp; Vartanyants, 2013<xref ref-type="bibr" rid="bb29"> ▸</xref>; Serkez <italic>et al.</italic>, 2013<xref ref-type="bibr" rid="bb26"> ▸</xref>; Ayyer <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb3"> ▸</xref>) the program <italic>Moltrans</italic> is mentioned and described as a software package to simulate FXI data for atomic models. Unfortunately, the code is not openly available. Very recently, <italic>SimS2E</italic> was released, which is a very sophisticated start-to-end simulation framework specialized for single-molecule FXI at the European X-ray free-electron laser (Yoon <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb30"> ▸</xref>). A practical, convenient and openly available FXI software tool for a range of sample models is missing.</p>
    <p>Here we introduce <italic>Condor</italic>, an easy-to-use software package to simulate FXI far-field scattering amplitudes from an experimental setup customized by the user. The user may define the sample either by atom positions or at lower resolution by a three-dimensional refractive index map. This allows one to simulate diffraction from samples that are unknown at atomic resolution but for which low-resolution densities from, for example, electron microscopy studies exist. Common challenges that a researcher faces with real data (Seibert <italic>et al.</italic>, 2011<xref ref-type="bibr" rid="bb25"> ▸</xref>; Loh <italic>et al.</italic>, 2012<xref ref-type="bibr" rid="bb19"> ▸</xref>; Hantke <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb15"> ▸</xref>; van der Schot <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb24"> ▸</xref>; Ekeberg <italic>et al.</italic>, 2015<xref ref-type="bibr" rid="bb12"> ▸</xref>) can be introduced by adding, for example, noise, signal variation, missing data regions, fluctuation of the beam tilt, sample heterogeneity or sample contamination. So far, <italic>Condor</italic> has demonstrated its usefulness for the preparation of experiments, data validation (Hantke <italic>et al.</italic>, 2014<xref ref-type="bibr" rid="bb15"> ▸</xref>), and the development of new software and algorithms (Daurer <italic>et al.</italic>, 2016<xref ref-type="bibr" rid="bb11"> ▸</xref>).</p>
    <p><italic>Condor</italic> is distributed under the free open-source Simplified Berkeley Software Distribution (BSD) License to ensure transparency and to ease future development and availability of the code. The source code can be downloaded from <ext-link ext-link-type="uri" xlink:href="http://github.com/mhantke/condor">http://github.com/mhantke/condor</ext-link>. <italic>Condor</italic> does not require a local installation. It can be used directly from its web interface at <ext-link ext-link-type="uri" xlink:href="http://lmb.icm.uu.se/condor">http://lmb.icm.uu.se/condor</ext-link> (Fig. 1<xref ref-type="fig" rid="fig1"> ▸</xref>).</p>
    <p>In this paper we give a description of the theoretical diffraction model that the code is based on (§<xref ref-type="sec" rid="sec2"/>2), describe how to use <italic>Condor</italic> (§3<xref ref-type="sec" rid="sec3"/>) and outline details of the current implementation (§4<xref ref-type="sec" rid="sec4"/>). The last chapter summarizes the paper and draws conclusions (§5<xref ref-type="sec" rid="sec5"/>).</p>
  </sec>
  <sec id="sec2">
    <label>2.</label>
    <title>Theory   </title>
    <p><italic>Condor</italic> attempts to predict coherent X-ray diffraction patterns on the basis of a sample model. Below we briefly outline the necessary approximations and the derivation of the scattering formulas that are used. For a comprehensive description of the theory behind, see, for example, Paganin (2006<xref ref-type="bibr" rid="bb23"> ▸</xref>) and Als-Nielsen &amp; McMorrow (2001<xref ref-type="bibr" rid="bb1"> ▸</xref>).</p>
    <p>For X-ray energies far from any absorption edges and well below the rest mass energy of an electron (511 keV) we may neglect Compton scattering. The samples that are considered here have a thickness of up to a few hundred nanometres and interact, because of their small size, only weakly with X-rays. This circumstance allows us to neglect the perturbation of the primary wave by the scattered wave within the sample. This approximation is well known as the first-order Born approximation.</p>
    <p>Predictions suggest that femtosecond X-ray pulses can outrun radiation damage processes (Neutze <italic>et al.</italic>, 2000<xref ref-type="bibr" rid="bb22"> ▸</xref>). Hence, in the simulations we model the sample by a scattering potential <inline-formula><inline-graphic xlink:href="j-49-01356-efi1.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>, which is invariant over the duration of the pulse.</p>
    <p>The sample particle is placed in vacuum and illuminated by a plane wave with wavevector <inline-formula><inline-graphic xlink:href="j-49-01356-efi2.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> (see Fig. 2<xref ref-type="fig" rid="fig2"> ▸</xref>). We seek to predict the wavefield Ψ at pixel positions <inline-formula><inline-graphic xlink:href="j-49-01356-efi3.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> in the detector plane that is orthogonal to the beam axis and at a far distance from the object. In this scenario <inline-formula><inline-graphic xlink:href="j-49-01356-efi4.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> can be expressed as the sum of the primary wave <inline-formula><inline-graphic xlink:href="j-49-01356-efi5.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and the scattered wave (or scattering amplitude) <inline-formula><inline-graphic xlink:href="j-49-01356-efi6.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>. The direct beam <inline-formula><inline-graphic xlink:href="j-49-01356-efi5.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> does not carry any structural information and is confined to the forward direction. It usually passes through a gap between the detector panels or is blocked by a beam stop and is never measured. Structural information about the sample is encoded by the scattering amplitude <inline-formula><inline-graphic xlink:href="j-49-01356-efi8.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>, which is the superposition of spherical waves with amplitude <inline-formula><inline-graphic xlink:href="j-49-01356-efi9.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> originating from all points <inline-formula><inline-graphic xlink:href="j-49-01356-efi10.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> in the scattering volume:<disp-formula id="fd1"><graphic xlink:href="j-49-01356-efd1.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>In our scenario, the sample volume is small and the detector distance large. Hence, we may safely assume <inline-formula><inline-graphic xlink:href="j-49-01356-efi11.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and obtain the far-field approximation of (1<xref ref-type="disp-formula" rid="fd1"/>):<disp-formula id="fd2"><graphic xlink:href="j-49-01356-efd2.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>where <inline-formula><inline-graphic xlink:href="j-49-01356-efi12.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> denotes the scattering vector and <inline-formula><inline-graphic xlink:href="j-49-01356-efi13.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>. Since we only consider elastic scattering the energy is conserved and so is the wavenumber <inline-formula><inline-graphic xlink:href="j-49-01356-efi14.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>, where λ denotes the wavelength. As we are only interested in relative phase differences we neglect the phase factor <inline-formula><inline-graphic xlink:href="j-49-01356-efi15.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> in the following equations.</p>
    <p>For numerical calculation of the scattering amplitude <inline-formula><inline-graphic xlink:href="j-49-01356-efi16.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> we have to either solve the integral in (2<xref ref-type="disp-formula" rid="fd2"/>) or approximate it by a discrete function. Analytical solutions exist for certain sample models, such as uniformly filled spheres or spheroids (Feigin &amp; Svergun, 1987<xref ref-type="bibr" rid="bb13"> ▸</xref>; Hamzeh &amp; Bragg, 1974<xref ref-type="bibr" rid="bb14"> ▸</xref>). In <italic>Condor</italic> these solutions of (2<xref ref-type="disp-formula" rid="fd2"/>) are implemented and can be customized by a few parameters. For more complex samples <italic>Condor</italic> provides two ways of defining the sample: either by a positional arrangement of atoms or by a gridded refractive index map. In the following subsections numerical solutions for these two particle models are presented. Both involve approximating the integral in (2<xref ref-type="disp-formula" rid="fd2"/>) by discrete Fourier transforms (DFTs) that have the general form<disp-formula id="fd3"><graphic xlink:href="j-49-01356-efd3.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>This formulation allows <italic>Condor</italic> to deploy efficient fast Fourier transform algorithms and exploit rapid parallel computing architectures.</p>
    <sec id="sec2.1">
      <label>2.1.</label>
      <title>Atomic model   </title>
      <p>FXI studies often target small sample particles that have sufficient resemblance to systems for which atomic structures have been determined by either X-ray crystallography, cryo-electron microscopy or nuclear magnetic resonance spectroscopy. X-rays are scattered by atoms because of their bound electrons. The scattering strength of a single free electron is known as the Thomson scattering length <inline-formula><inline-graphic xlink:href="j-49-01356-efi17.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>. The scattering potential for <italic>N</italic> free electrons located at the respective positions <inline-formula><inline-graphic xlink:href="j-49-01356-efi18.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> may be written as<disp-formula id="fd4"><graphic xlink:href="j-49-01356-efd4.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>By substituting (4<xref ref-type="disp-formula" rid="fd4"/>) into (2<xref ref-type="disp-formula" rid="fd2"/>) the δ functions conveniently reduce the integral in (2<xref ref-type="disp-formula" rid="fd2"/>) to a sum and we obtain the scattering amplitude in a simpler form:<disp-formula id="fd5"><graphic xlink:href="j-49-01356-efd5.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>
</p>
      <p>For electrons bound to an atom of species <italic>a</italic> the scattering length can be calculated by multiplying <inline-formula><inline-graphic xlink:href="j-49-01356-efi17.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> with the atomic scattering factor <inline-formula><inline-graphic xlink:href="j-49-01356-efi20.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>. The atomic scattering factor is a semi-empirically determined element-specific constant that is tabulated for a large range of wavelengths λ and scattering angles θ (Brown <italic>et al.</italic>, 2006<xref ref-type="bibr" rid="bb7"> ▸</xref>; Henke <italic>et al.</italic>, 1993<xref ref-type="bibr" rid="bb16"> ▸</xref>). The shape of the atom is reflected in the angular dependency; hence the atomic scattering factor is also known as the atomic form factor.</p>
      <p>This permits us to replace the integral in (2<xref ref-type="disp-formula" rid="fd2"/>) as in (5<xref ref-type="disp-formula" rid="fd5"/>) by a sum. The scattering amplitude can be evaluated by separating the calculation into sums for each atom species <italic>a</italic> that accounts for <inline-formula><inline-graphic xlink:href="j-49-01356-efi21.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> atoms at positions <inline-formula><inline-graphic xlink:href="j-49-01356-efi22.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>. We obtain<disp-formula id="fd6"><graphic xlink:href="j-49-01356-efd6.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>
</p>
      <p><inline-formula><inline-graphic xlink:href="j-49-01356-efi23.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> now has the form of a sum of DFTs (3<xref ref-type="disp-formula" rid="fd3"/>) with <inline-formula><inline-graphic xlink:href="j-49-01356-efi24.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> computed on the nonregular grid <inline-formula><inline-graphic xlink:href="j-49-01356-efi22.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>.</p>
    </sec>
    <sec id="sec2.2">
      <label>2.2.</label>
      <title>Refractive index model   </title>
      <p>For larger objects, such as big protein complexes or virus particles, the atomic structure is rarely on hand. However, at lower than atomic resolution electron density maps <inline-formula><inline-graphic xlink:href="j-49-01356-efi26.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> of a wide range of structures have been measured by electron microscopy. Also, for many relevant optical media we can estimate the atomic composition (see Table 1<xref ref-type="table" rid="table1"> ▸</xref>) and are able to model samples by customized density maps of optical media. For these cases the scattering potential <inline-formula><inline-graphic xlink:href="j-49-01356-efi27.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> can be derived from the Maxwell equations and written as a function of the complex valued refractive index <inline-formula><inline-graphic xlink:href="j-49-01356-efi28.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>:<disp-formula id="fd7"><graphic xlink:href="j-49-01356-efd7.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>For convenience we define <inline-formula><inline-graphic xlink:href="j-49-01356-efi29.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>. By inserting (7<xref ref-type="disp-formula" rid="fd7"/>) into (2<xref ref-type="disp-formula" rid="fd2"/>) we obtain the scattering amplitude as a function of <inline-formula><inline-graphic xlink:href="j-49-01356-efi30.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>:<disp-formula id="fd8"><graphic xlink:href="j-49-01356-efd8.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>If this equation is interpreted as the continuum limit of (5<xref ref-type="disp-formula" rid="fd5"/>) the relationship between the refractive index and the electron density distribution <inline-formula><inline-graphic xlink:href="j-49-01356-efi26.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> becomes<disp-formula id="fd9"><graphic xlink:href="j-49-01356-efd9.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>and the relationship between refractive index and the atom density distribution <inline-formula><inline-graphic xlink:href="j-49-01356-efi32.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> becomes<disp-formula id="fd10"><graphic xlink:href="j-49-01356-efd10.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>Using the relationships (9<xref ref-type="disp-formula" rid="fd9"/>) and (10<xref ref-type="disp-formula" rid="fd10"/>), <italic>Condor</italic> converts electron and atom density maps into refractive index maps. We presume here that <inline-formula><inline-graphic xlink:href="j-49-01356-efi33.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> for all scattering angles θ, which is a valid assumption if the resolution of the measurement is well below atomic length scales.</p>
      <p>Discretization of the Fourier integral in (2<xref ref-type="disp-formula" rid="fd2"/>) with (3<xref ref-type="disp-formula" rid="fd3"/>) on a three-dimensional cubic grid of <inline-formula><inline-graphic xlink:href="j-49-01356-efi34.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> points at spacing <inline-formula><inline-graphic xlink:href="j-49-01356-efi35.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> results in<disp-formula id="fd11"><graphic xlink:href="j-49-01356-efd11.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>with <inline-formula><inline-graphic xlink:href="j-49-01356-efi36.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> being the Fourier transform of <inline-formula><inline-graphic xlink:href="j-49-01356-efi30.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>. This expression allows <italic>Condor</italic> to efficiently calculate the scattering amplitude for any discrete map <inline-formula><inline-graphic xlink:href="j-49-01356-efi38.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> on the regular grid <inline-formula><inline-graphic xlink:href="j-49-01356-efi39.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>.</p>
    </sec>
    <sec id="sec2.3">
      <label>2.3.</label>
      <title>Diffraction measurement   </title>
      <p>To predict the absolute scattering signal <inline-formula><inline-graphic xlink:href="j-49-01356-efi40.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> measured with a photon detector we need to take into account the intensity <inline-formula><inline-graphic xlink:href="j-49-01356-efi41.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> of the illumination, the solid angle <inline-formula><inline-graphic xlink:href="j-49-01356-efi42.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> that is covered by the detector pixel, and the polarization factor <inline-formula><inline-graphic xlink:href="j-49-01356-efi43.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>, which accounts for the effects of the polarization of the incoming beam in the scattered signal (Als-Nielsen &amp; McMorrow, 2001<xref ref-type="bibr" rid="bb1"> ▸</xref>). With these parameters the expectation value for the number of scattered photons measured in a pixel (without noise and any losses) is given by<disp-formula id="fd12"><graphic xlink:href="j-49-01356-efd12.jpg" mimetype="image" mime-subtype="gif" position="float"/></disp-formula>
</p>
      <p>Owing to the quantum nature of photons the measurement of <inline-formula><inline-graphic xlink:href="j-49-01356-efi40.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> inevitably suffers from shot noise and thus follows Poisson statistics. This type and other types of measurement errors such as detector noise, parasitic scattering and limited quantum efficiency may be added to the simulated intensity values if desired.</p>
      <p>For the refractive index model the agreement of data from a real FXI experiment and simulated data calculated by using the formalism that has been described here is demonstrated in Fig. 3<xref ref-type="fig" rid="fig3"> ▸</xref>. For the atomic model such a comparison cannot be made because we lack suitable experimental data at this point.</p>
    </sec>
  </sec>
  <sec id="sec3">
    <label>3.</label>
    <title>Usage   </title>
    <p>In the following paragraphs we give an introduction to the usage and functionality of <italic>Condor</italic>. For a detailed description of all features please see <italic>Condor</italic>’s documentation at <ext-link ext-link-type="uri" xlink:href="http://lmb.icm.uu.se/condor/documentation">http://lmb.icm.uu.se/condor/documentation</ext-link>.</p>
    <p>Every <italic>Condor</italic> simulation requires the configuration of at least three components: the X-ray source, at least one sample and a pixel array detector. The configuration of the X-ray source defines the photon wavelength and intensity at the interaction point. The model of the sample can be of different kinds, either an atomic model or a refractive index description. The atomic description requires knowledge about all atom positions and atom species in the scattering volume. For example the online Protein Data Bank (PDB; Berman <italic>et al.</italic>, 2000<xref ref-type="bibr" rid="bb5"> ▸</xref>) is a resource that provides a wide range of structures at atomic resolution. The structure can be provided either by a list of coordinates and atomic numbers or by a PDB file or PDB ID code.</p>
    <p>To define a refractive index map <italic>Condor</italic> accepts a three-dimensional array of data points on a cubic Cartesian grid or the geometrical parameters of a sphere or spheroid. The map values can be refractive indices, electron densities or atom densities. For the last two, formulas (9<xref ref-type="disp-formula" rid="fd9"/>) or (10<xref ref-type="disp-formula" rid="fd10"/>) are used for the conversion to refractive indices. <italic>Condor</italic> interfaces to the Electron Microscopy Databank (EMDB; Lawson <italic>et al.</italic>, 2011<xref ref-type="bibr" rid="bb18"> ▸</xref>), from which density maps can be retrieved. The orientation of the particle is defined by an extrinsic rotation. The rotation can be defined by either a triple of Euler angles, a rotation matrix or a quaternion. Multiple particles at different positions in the beam can be simulated as well. The configuration of the pixel detector determines the position of all pixels in space with respect to the interaction point. The detector noise, the fluctuating beam tilt, the saturation level, a missing data mask <italic>etc</italic>. may also be specified.</p>
    <p>The default way of carrying out a <italic>Condor</italic> simulation is by calling the executable <monospace>condor</monospace> from a folder that contains a configuration file named <monospace>condor.conf</monospace>. Fig. 4<xref ref-type="fig" rid="fig4"> ▸</xref> shows two example configuration files, one for the calculation with an atomic model (Fig. 4<xref ref-type="fig" rid="fig4"> ▸</xref>
<italic>a</italic>) and one for the calculation with a refractive index model (Fig. 4<xref ref-type="fig" rid="fig4"> ▸</xref>
<italic>b</italic>). Every configuration file is subdivided into at least three sections [X-ray source, sample particle(s), pixel array detector]. All quantities follow the convention of the International System of Units. If a parameter is unspecified it is set to a default value. At the end of execution the results are written to an HDF5 file. The acronym HDF5 stands for Hierarchical Data Format version 5 (The HDF Group, 2016<xref ref-type="bibr" rid="bb27"> ▸</xref>), which is a widely used file format for scientific applications and ensures high portability and performance. The data structure within the file follows the guidelines for the Coherent X-ray Imaging file format (Maia, 2012<xref ref-type="bibr" rid="bb20"> ▸</xref>).</p>
    <p>The two example configuration files shown in Fig. 4<xref ref-type="fig" rid="fig4"> ▸</xref> define experimentally feasible configurations at the LINAC Coherent Light Source (LCLS). The selected particle structures are the GroEL–GroES protein complex (Fig. 4<xref ref-type="fig" rid="fig4"> ▸</xref>
<italic>a</italic>) and the poliovirus particle (Fig. 4<xref ref-type="fig" rid="fig4"> ▸</xref>
<italic>b</italic>). The structure for the GroEL–GroES protein complex is taken from the atom positions of PDB entry <ext-link ext-link-type="uri" xlink:href="http://scripts.iucr.org/cgi-bin/cr.cgi?rm=pdb&amp;pdbId=1aon">1aon</ext-link> (Xu <italic>et al.</italic>, 1997<xref ref-type="bibr" rid="bb31"> ▸</xref>). The poliovirus particle is modelled by the density map derived from EMDB entry 1144 (Bubeck <italic>et al.</italic>, 2005<xref ref-type="bibr" rid="bb32"> ▸</xref>). We projected the EMDB map to electron densities using experimentally determined values for atomic composition (Molla <italic>et al.</italic>, 1991<xref ref-type="bibr" rid="bb21"> ▸</xref>) and mass density (Dans <italic>et al.</italic>, 1966<xref ref-type="bibr" rid="bb10"> ▸</xref>) of poliovirus virions. Simulated results from these examples are shown in Fig. 5<xref ref-type="fig" rid="fig5"> ▸</xref>.</p>
    <p><italic>Condor</italic> provides not only intensities but also phases. Here the curvature of the Ewald sphere is small, and hence projection images in real space (left column in Fig. 5<xref ref-type="fig" rid="fig5"> ▸</xref>) can be readily calculated by inverse Fourier transforming the scattering amplitudes.</p>
    <p>For a more customizable use, <italic>Condor</italic>’s application programming interface (API) can be called directly from any Python software. The <italic>Condor</italic> engine can thus be easily integrated into any software tool or pipeline that relies on simulated diffraction data. An example for a script that uses the <italic>Condor</italic> API is shown in Fig. 6<xref ref-type="fig" rid="fig6"> ▸</xref>. Projection images and diffraction patterns that were generated with this script are presented in Fig. 7<xref ref-type="fig" rid="fig7"> ▸</xref>. The script simulates an experiment where spheroidal water droplets contaminate the particle stream of GroEL–GroES protein complexes. Both particle species arrive in the scattering volume in random orientations and at random positions. The arrival statistics are modelled by a Poisson process with arrival rates of 0.2 for the water droplets and 0.9 for the protein complexes. The water droplets are not simulated as perfectly reproducible structures but as spheroids of varying size and shape. This is reflected in the model by size parameters that follow a normal distribution centred at 8 nm and values of the flattening parameter that follow a uniform distribution between 0.8 and 1.0.</p>
  </sec>
  <sec id="sec4">
    <label>4.</label>
    <title>Implementation   </title>
    <p><italic>Condor</italic> is a Python package including C extensions for the computationally heavy operations. For the calculation of the discrete Fourier transform in equations (6<xref ref-type="disp-formula" rid="fd6"/>) and (11<xref ref-type="disp-formula" rid="fd11"/>), <italic>Condor</italic> makes use of the non-equispaced fast Fourier transform (<italic>NFFT</italic>) C library (Keiner <italic>et al.</italic>, 2009<xref ref-type="bibr" rid="bb17"> ▸</xref>). This library provides routines to calculate the discrete Fourier transform at non-equispaced points, for example on the curved surface of the Ewald sphere. For the refractive index model <italic>Condor</italic> deploys the common <italic>NFFT</italic> algorithm, which still requires equispaced sampling in the real-space domain. For the atomic model the generalized <italic>NNFFT</italic> algorithm is used, as it allows for non-equispaced sampling in both domains. The computation of the sums in the discrete Fourier transform can benefit from parallelization. Compilation with OpenMP (<ext-link ext-link-type="uri" xlink:href="http://openmp.org">http://openmp.org</ext-link>) allows for an easy parallelization with moderate speed-ups. Diffraction from atomic models is normally more computationally demanding and here <italic>Condor</italic> supports the use of CUDA-capable graphics cards (<ext-link ext-link-type="uri" xlink:href="http://nvidia.com/cuda">http://nvidia.com/cuda</ext-link>), which can provide a drastic increase in performance.</p>
    <p>Computation times were measured for the simulations of the examples shown in Figs. 4<xref ref-type="fig" rid="fig4"> ▸</xref> and 5<xref ref-type="fig" rid="fig5"> ▸</xref>, which were carried out on a MacBookPro computer [2.5 GHz Intel Core i7 (4 cores, 8 threads), 16 GB 1600 MHz DDR3] equipped with a CUDA-capable graphics card (NVIDIA GeForce GT 750 M, 2048 MB memory). The atomic model included of 58 870 atom positions, and diffraction was predicted at 256 × 256 detector pixels. Using a single CPU and with CUDA disabled the calculation took 208 s. Enabling CUDA resulted in a computation time of 3 s, giving a speedup of 69.3×. The refractive index map consisted of 173 × 173 × 173 voxels, and diffraction was predicted at 512 × 512 detector pixels. Using a single CPU the calculation took 19 s, and using four CPU threads it took 6.8 s, resulting in a speed-up of 2.8×.</p>
    <p>Fig. 8<xref ref-type="fig" rid="fig8"> ▸</xref>(<italic>a</italic>) illustrates the representation of an experiment in <italic>Condor</italic> as a Python object. It contains a source object, one or several particle objects, and a detector object. The experiment object has a method <monospace>propagate()</monospace> that starts the simulation of a single shot and returns the results in the form of a Python dictionary.</p>
    <p>As an alternative to a local installation, <italic>Condor</italic> is also provided as a web application (Fig. 1<xref ref-type="fig" rid="fig1"> ▸</xref>) that supports most of the functionality of the full package. In the left panel of the web application one can configure the X-ray source, sample particle and detector. The upper right panel is used to submit simulation requests and monitor their progress. After a simulation has finished its results can be previewed and downloaded from the bottom right panel.</p>
    <p>The web implementation of <italic>Condor</italic> is based on a Django (<ext-link ext-link-type="uri" xlink:href="https://www.djangoproject.com/">https://www.djangoproject.com/</ext-link>) web framework and uses a database for caching user inputs. The system is hosted by the Davinci GPU computer cluster of the Laboratory of Molecular Biophysics (Uppsala University, Sweden).</p>
    <p>The architecture of the server–client model of the web implementation is illustrated in Fig. 8<xref ref-type="fig" rid="fig7"> ▸</xref>(<italic>b</italic>). When a user submits a simulation request the web server first checks the input. If the input passes validation the web server sends the requests to the <italic>Condor</italic> server, which manages a number of <italic>Condor</italic> clients. The first worker client that becomes available starts the <italic>Condor</italic> simulation. The number of worker clients is dynamically adjusted to the current load of the web page, such that at least one worker client is always available for processing a simulation request. The hierarchical architecture ensures responsiveness of the servers at all times, even when running multiple simulations simultaneously. While a simulation is running the scheduling server monitors the progress of the simulation. When finished the results are sent to the web server, which presents the user with previews and links for downloading the results as an HDF5 file.</p>
  </sec>
  <sec id="sec5">
    <label>5.</label>
    <title>Conclusion   </title>
    <p>FXI experiments at free-electron laser facilities are expensive and precious. Easy-to-use software can support researchers in improving data quality and can support data analysis. The software <italic>Condor</italic> is a fast simulation tool specialized for FXI research and covers a wide range of use cases and functionalities. Practically anybody is able to use <italic>Condor</italic> because of its simple structure and because common hurdles such as limited cross-platform compatibility or demanding hardware requirements have been avoided by making key features available through a web application. We, the developers, encourage and support the integration of the code into other software that relies on simulated FXI data. Reusability of the source code is facilitated by the availability of a simple and flexible Python API and by the distribution of the code under the Simplified BSD license.</p>
    <p>Beyond its relevance in research <italic>Condor</italic> may be a useful educational software tool. Students may gain understanding of the laws of X-ray diffraction by studying changes in the diffraction pattern while changing experimental parameters. Moreover, entire experimental data sets can be readily simulated by the students themselves. Students may be invited to pursue a reconstruction from simulated data.</p>
    <p>In conclusion, <italic>Condor</italic> will enhance and stimulate collaborative activities in software development within the FXI community. Furthermore, the software will underpin efforts in FXI education, experiment planning, conducting of experiments, algorithm development and data validation.</p>
  </sec>
</body>
<back>
  <fn-group>
    <fn id="fn1">
      <label>1</label>
      <p>This article will form part of a virtual special issue of the journal on free-electron laser software.</p>
    </fn>
  </fn-group>
  <ref-list>
    <title>References</title>
    <ref id="bb1">
      <mixed-citation publication-type="other">Als-Nielsen, J. &amp; McMorrow, D. (2001). <italic>Elements of Modern X-ray Physics.</italic> New York: Wiley.</mixed-citation>
    </ref>
    <ref id="bb2">
      <mixed-citation publication-type="other">Aquila, A. <italic>et al.</italic> (2015). <italic>Struct. Dyn.</italic>
<bold>2</bold>, 041701.</mixed-citation>
    </ref>
    <ref id="bb3">
      <mixed-citation publication-type="other">Ayyer, K., Geloni, G., Kocharyan, V., Saldin, E., Serkez, S., Yefanov, O. &amp; Zagorodnov, I. (2015). <italic>Struct. Dyn.</italic>
<bold>2</bold>, 041702.</mixed-citation>
    </ref>
    <ref id="bb4">
      <mixed-citation publication-type="other">Bergh, M., Huldt, G., Tîmneanu, N., Maia, F. R. N. C. &amp; Hajdu, J. (2008). <italic>Q. Rev. Biophys.</italic>
<bold>41</bold>, 181–204.</mixed-citation>
    </ref>
    <ref id="bb5">
      <mixed-citation publication-type="other">Berman, H., Westbrook, J., Feng, Z., Gilliland, G., Bhat, T. N., Weissig, H., Shindyalov, I. N. &amp; Bourne, P. E. (2000). <italic>Nucleic Acids Res.</italic>
<bold>28</bold>, 235–242.</mixed-citation>
    </ref>
    <ref id="bb6">
      <mixed-citation publication-type="other">Bogan, M. J. <italic>et al.</italic> (2008). <italic>Nano Lett.</italic>
<bold>8</bold>, 310–316.</mixed-citation>
    </ref>
    <ref id="bb7">
      <mixed-citation publication-type="other">Brown, P. J., Fox, A. G., Maslen, E. N., O’Keefe, M. A. &amp; Willis, B. T. M. (2006). <italic>International Tables for Crystallography</italic>, Vol. C, 1st online ed., edited by E. Prince, ch. 6.1. Chester: International Union of Crystallography.</mixed-citation>
    </ref>
    <ref id="bb32">
      <mixed-citation publication-type="other">Bubeck D., Filman, D. J., Cheng, N., Steven, A. C., Hogle, J. M. &amp; Belnap, D. M. (2005). <italic>J. Virol.</italic>
<bold>79</bold>, 7745–7755.</mixed-citation>
    </ref>
    <ref id="bb8">
      <mixed-citation publication-type="other">Chapman, H. N., Barty, A. <italic>et al.</italic> (2006). <italic>Nat. Phys.</italic>
<bold>2</bold>, 839–843.</mixed-citation>
    </ref>
    <ref id="bb9">
      <mixed-citation publication-type="other">Chapman, H. N. &amp; Nugent, K. A. (2010). <italic>Nat. Photon.</italic>
<bold>4</bold>, 833–839.</mixed-citation>
    </ref>
    <ref id="bb10">
      <mixed-citation publication-type="other">Dans, P. E., Forsyth, B. R. &amp; Chanock, R. M. (1966). <italic>J. Bacteriol.</italic>
<bold>91</bold>, 1605–1611.</mixed-citation>
    </ref>
    <ref id="bb11">
      <mixed-citation publication-type="other">Daurer, B. J., Hantke, M. F., Nettelblad, C. &amp; Maia, F. R. N. C. (2016). <italic>J. Appl. Cryst.</italic>
<bold>49</bold>, 1–6.</mixed-citation>
    </ref>
    <ref id="bb12">
      <mixed-citation publication-type="other">Ekeberg, T. <italic>et al.</italic> (2015). <italic>Phys. Rev. Lett.</italic>
<bold>114</bold>, 098102, 1–6.</mixed-citation>
    </ref>
    <ref id="bb13">
      <mixed-citation publication-type="other">Feigin, L. A. &amp; Svergun, D. I. (1987). <italic>Structure Analysis by Small-Angle X-ray and Neutron Scattering.</italic> New York: Plenum Press.</mixed-citation>
    </ref>
    <ref id="bb14">
      <mixed-citation publication-type="other">Hamzeh, F. M. &amp; Bragg, R. H. (1974). <italic>J. Appl. Phys.</italic>
<bold>45</bold>, 3189–3195.</mixed-citation>
    </ref>
    <ref id="bb15">
      <mixed-citation publication-type="other">Hantke, M. F. <italic>et al.</italic> (2014). <italic>Nat. Photon.</italic>
<bold>8</bold>, 943–949.</mixed-citation>
    </ref>
    <ref id="bb16">
      <mixed-citation publication-type="other">Henke, B. L., Gullikson, E. &amp; Davis, J. (1993). <italic>At. Data Nucl. Data Tables</italic>, <bold>54</bold>, 181–342.</mixed-citation>
    </ref>
    <ref id="bb17">
      <mixed-citation publication-type="other">Keiner, J., Kunis, S. &amp; Potts, D. (2009). <italic>ACM Trans. Math. Softw.</italic>
<bold>36</bold>, 1–30.</mixed-citation>
    </ref>
    <ref id="bb18">
      <mixed-citation publication-type="other">Lawson, C. L. <italic>et al.</italic> (2011). <italic>Nucleic Acids Res.</italic>
<bold>39</bold>, D456–D464.</mixed-citation>
    </ref>
    <ref id="bb19">
      <mixed-citation publication-type="other">Loh, N. D. <italic>et al.</italic> (2012). <italic>Proc. SPIE</italic>, <bold>8504</bold>, 850403.</mixed-citation>
    </ref>
    <ref id="bb20">
      <mixed-citation publication-type="other">Maia, F. R. N. C. (2012). <italic>Nat. Methods</italic>, <bold>9</bold>, 854–855.</mixed-citation>
    </ref>
    <ref id="bb21">
      <mixed-citation publication-type="other">Molla, A., Paul, A. &amp; Wimmer, E. (1991). <italic>Science</italic>, <bold>254</bold>, 1647–1651.</mixed-citation>
    </ref>
    <ref id="bb22">
      <mixed-citation publication-type="other">Neutze, R., Wouts, R., van der Spoel, D., Weckert, E. &amp; Hajdu, J. (2000). <italic>Nature</italic>, <bold>406</bold>, 752–757.</mixed-citation>
    </ref>
    <ref id="bb23">
      <mixed-citation publication-type="other">Paganin, D. M. (2006). <italic>Coherent X-ray Optics.</italic> Oxford University Press.</mixed-citation>
    </ref>
    <ref id="bb24">
      <mixed-citation publication-type="other">Schot, G. van der <italic>et al.</italic> (2015). <italic>Nat. Commun.</italic>
<bold>6</bold>, 5704.</mixed-citation>
    </ref>
    <ref id="bb25">
      <mixed-citation publication-type="other">Seibert, M. M. <italic>et al.</italic> (2011). <italic>Nature</italic>, <bold>470</bold>, 78–81.</mixed-citation>
    </ref>
    <ref id="bb26">
      <mixed-citation publication-type="other">Serkez, S., Kocharyan, V. &amp; Saldin, E. (2013). <italic>35th International Free-Electron Laser Conference</italic>, pp. 574–582. Red Hook: Curran Associates.</mixed-citation>
    </ref>
    <ref id="bb27">
      <mixed-citation publication-type="other">The HDF Group (2016). Hierarchical Data Format. Version 5. http://www.hdfgroup.org/HDF5/.</mixed-citation>
    </ref>
    <ref id="bb28">
      <mixed-citation publication-type="other">Winn, M. D. <italic>et al.</italic> (2011). <italic>Acta Cryst.</italic> D<bold>67</bold>, 235–242.</mixed-citation>
    </ref>
    <ref id="bb31">
      <mixed-citation publication-type="other">Xu, Z., Horwich, A. L. &amp; Sigler, P. B. (1997). <italic>Nature</italic>, <bold>388</bold>, 741–750.</mixed-citation>
    </ref>
    <ref id="bb29">
      <mixed-citation publication-type="other">Yefanov, O. M. &amp; Vartanyants, I. A. (2013). <italic>J. Phys. B At. Mol. Opt. Phys.</italic>
<bold>46</bold>, 164013.</mixed-citation>
    </ref>
    <ref id="bb30">
      <mixed-citation publication-type="other">Yoon, C. H., Yurkov, M. V., Schneidmiller, E. A., Samoylova, L., Buzmakov, A., Jurek, Z., Santra, R., Loh, N. D. &amp; Mancuso, A. P. (2015). <italic>Sci. Rep.</italic>
<bold>6</bold>, 24791.</mixed-citation>
    </ref>
  </ref-list>
</back>
<floats-group>
  <fig id="fig1" position="float">
    <label>Figure 1</label>
    <caption>
      <p>The interface of <italic>Condor</italic>’s web application (<ext-link ext-link-type="uri" xlink:href="http://lmb.icm.uu.se/condor">http://lmb.icm.uu.se/condor</ext-link>). In the left panels the user configures the source, particle and detector model. From the upper-right panel the job is submitted, and after the job has completed a preview and download links of the simulated data appear in the lower-right panel.</p>
    </caption>
    <graphic xlink:href="j-49-01356-fig1"/>
  </fig>
  <fig id="fig2" position="float">
    <label>Figure 2</label>
    <caption>
      <p>Schematic representation of the geometry in real and Fourier space. (<italic>a</italic>) A plane wave illuminates the sample. It is placed in vacuum and confined to the scattering volume illustrated by the green box. The signal at the detector plane is the superposition of the primary wave with wavevector <inline-formula><inline-graphic xlink:href="j-49-01356-efi2.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and the scattered wave with wavevector <inline-formula><inline-graphic xlink:href="j-49-01356-efi59.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>. (<italic>b</italic>) The diffraction space is the reciprocal space of scattering vectors <inline-formula><inline-graphic xlink:href="j-49-01356-efi12.jpg" mimetype="image" mime-subtype="gif"/></inline-formula> and contains the Fourier transform of the scattering potential <inline-formula><inline-graphic xlink:href="j-49-01356-efi1.jpg" mimetype="image" mime-subtype="gif"/></inline-formula>.</p>
    </caption>
    <graphic xlink:href="j-49-01356-fig2"/>
  </fig>
  <fig id="fig3" position="float">
    <label>Figure 3</label>
    <caption>
      <p>Comparison of experimental data and simulated data. (<italic>a</italic>) From the measured FXI diffraction pattern (top) of a single carboxysome (<italic>i.e.</italic> an icosahedral cell organelle) the projection image (bottom) was reconstructed by iterative phase retrieval down to 18.1 nm resolution. (<italic>b</italic>) At the given resolution the <italic>Condor</italic> simulation of a diffraction pattern and projection image for a uniformly filled icosahedron in matching orientation and size provides an acceptable approximation for the data shown in (<italic>a</italic>). Figure adapted from Hantke <italic>et al.</italic> (2014<xref ref-type="bibr" rid="bb15"> ▸</xref>).</p>
    </caption>
    <graphic xlink:href="j-49-01356-fig3"/>
  </fig>
  <fig id="fig4" position="float">
    <label>Figure 4</label>
    <caption>
      <p>Configuration files for simulation with (<italic>a</italic>) an atomic and (<italic>b</italic>) a refractive index model. The <monospace>source</monospace> section defines the illumination properties, the <monospace>particle</monospace> section the sample properties and the <monospace>detector</monospace> section the parameters for the area pixel detector. Many parameters are optional and are set to default values if not specified. These configuration files together with the required structure files are included in the online repository of <italic>Condor</italic> and are located in the folder <monospace>examples_publication</monospace>.</p>
    </caption>
    <graphic xlink:href="j-49-01356-fig4"/>
  </fig>
  <fig id="fig5" position="float">
    <label>Figure 5</label>
    <caption>
      <p>Simulation of diffraction patterns for two biological structures: (<italic>a</italic>) the GroEL–GroES complex and (<italic>b</italic>) the poliovirus particle. For each model the projection image is shown on the left and the noise-free intensity pattern on the right.</p>
    </caption>
    <graphic xlink:href="j-49-01356-fig5"/>
  </fig>
  <fig id="fig6" position="float">
    <label>Figure 6</label>
    <caption>
      <p>Customized use of <italic>Condor</italic> by direct interaction with the Python API. The script simulates diffraction patterns from a mixture of GroEL–GroES complex and spheroidal water droplets of varying shape and size. A missing data region and Poisson noise are taken into account for the intensity estimate at the detector pixels. After the initialization, patterns are simulated sequentially in a loop by calling the method <monospace>propagate()</monospace> and appending the results to an HDF5 file.</p>
    </caption>
    <graphic xlink:href="j-49-01356-fig6"/>
  </fig>
  <fig id="fig7" position="float">
    <label>Figure 7</label>
    <caption>
      <p>Simulation of diffraction patterns for a mixture of two particle species: the GroEL–GroES complex and spheroidal water droplets. (<italic>a</italic>) Real-space projection images and (<italic>b</italic>) respective simulated diffraction intensity patterns with Poisson noise and a pixel mask. The physical parameters resemble the conditions at the AMO beamline at the LCLS.</p>
    </caption>
    <graphic xlink:href="j-49-01356-fig7"/>
  </fig>
  <fig id="fig8" position="float">
    <label>Figure 8</label>
    <caption>
      <p>Implementation architecture. (<italic>a</italic>) An experiment is represented in <italic>Condor</italic> as a Python object that includes a source object, one or several sample particle objects, and a detector object. A call of the method <monospace>propagate()</monospace> starts a simulation and returns the diffraction data. (<italic>b</italic>) The web version of <italic>Condor</italic> is realized as a hierarchical client–server model. The web server provides a dynamic web page under the address <ext-link ext-link-type="uri" xlink:href="http://lmb.icm.uu.se/condor">http://lmb.icm.uu.se/condor</ext-link>. Under this page users can configure their experiment, and upon submission data are validated and then cached in a database. Simulation jobs are scheduled by a scheduling server that manages a network of worker clients. This worker farm is dynamically extended and shrunk depending on the number of requests. After completion of a simulation the web server presents previews and links to download to the user.</p>
    </caption>
    <graphic xlink:href="j-49-01356-fig8"/>
  </fig>
  <table-wrap id="table1" position="float">
    <label>Table 1</label>
    <caption>
      <title>Mass density, atomic composition and refractive index for a selection of optical media</title>
      <p>The material constants were taken from Bergh <italic>et al.</italic> (2008<xref ref-type="bibr" rid="bb4"> ▸</xref>), Molla <italic>et al.</italic> (1991<xref ref-type="bibr" rid="bb21"> ▸</xref>) and Dans <italic>et al.</italic> (1966<xref ref-type="bibr" rid="bb10"> ▸</xref>), and the refractive index was calculated from these values with the relationship given by (10<xref ref-type="disp-formula" rid="fd10"/>).</p>
    </caption>
    <table frame="hsides" rules="groups">
      <thead valign="top">
        <tr>
          <th style="border-bottom:1px solid black;" rowspan="1" colspan="1" align="left" charoff="50" valign="bottom">Material type</th>
          <th style="border-bottom:1px solid black;" rowspan="1" colspan="1" align="left" charoff="50" valign="bottom">Density (g cm<sup>−3</sup>)</th>
          <th style="border-bottom:1px solid black;" rowspan="1" colspan="1" align="left" charoff="50" valign="bottom">Atomic composition</th>
          <th style="border-bottom:1px solid black;" rowspan="1" colspan="1" align="left" charoff="50" valign="bottom">Refractive index (λ = 1.240 nm)</th>
        </tr>
      </thead>
      <tbody valign="top">
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Water</td>
          <td rowspan="1" colspan="1" align="left" valign="top">1.00</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi45.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi46.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Protein</td>
          <td rowspan="1" colspan="1" align="left" valign="top">1.35</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi47.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi48.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">DNA</td>
          <td rowspan="1" colspan="1" align="left" valign="top">1.70</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi49.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi50.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Lipid</td>
          <td rowspan="1" colspan="1" align="left" valign="top">1.00</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi51.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi52.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Cell</td>
          <td rowspan="1" colspan="1" align="left" valign="top">1.00</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi53.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi54.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
        </tr>
        <tr>
          <td rowspan="1" colspan="1" align="left" valign="top">Poliovirus particle</td>
          <td rowspan="1" colspan="1" align="left" valign="top">1.34</td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi55.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi56.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
          <td rowspan="1" colspan="1" align="left" valign="top">
            <inline-formula>
              <inline-graphic xlink:href="j-49-01356-efi57.jpg" mimetype="image" mime-subtype="gif"/>
            </inline-formula>
          </td>
        </tr>
      </tbody>
    </table>
  </table-wrap>
</floats-group>
