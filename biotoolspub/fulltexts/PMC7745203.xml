<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//ACS//DTD ACS Journal DTD v1.02 20061031//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName ACSJournal-v102.dtd?>
<?SourceDTD.Version 1.02?>
<?ConverterInfo.XSLTName acs2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Anal Chem</journal-id>
    <journal-id journal-id-type="iso-abbrev">Anal Chem</journal-id>
    <journal-id journal-id-type="publisher-id">ac</journal-id>
    <journal-id journal-id-type="coden">ancham</journal-id>
    <journal-title-group>
      <journal-title>Analytical Chemistry</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">0003-2700</issn>
    <issn pub-type="epub">1520-6882</issn>
    <publisher>
      <publisher-name>American
Chemical
Society</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">7745203</article-id>
    <article-id pub-id-type="pmid">33317272</article-id>
    <article-id pub-id-type="doi">10.1021/acs.analchem.0c03833</article-id>
    <article-categories>
      <subj-group>
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>MSIWarp: A General Approach to Mass Alignment in Mass
Spectrometry Imaging</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" id="ath1">
        <name>
          <surname>Eriksson</surname>
          <given-names>Jonatan
O.</given-names>
        </name>
        <xref rid="aff1" ref-type="aff">†</xref>
      </contrib>
      <contrib contrib-type="author" id="ath2">
        <name>
          <surname>Sánchez Brotons</surname>
          <given-names>Alejandro</given-names>
        </name>
        <xref rid="aff2" ref-type="aff">‡</xref>
      </contrib>
      <contrib contrib-type="author" id="ath3">
        <name>
          <surname>Rezeli</surname>
          <given-names>Melinda</given-names>
        </name>
        <xref rid="aff1" ref-type="aff">†</xref>
      </contrib>
      <contrib contrib-type="author" id="ath4">
        <name>
          <surname>Suits</surname>
          <given-names>Frank</given-names>
        </name>
        <xref rid="aff3" ref-type="aff">§</xref>
      </contrib>
      <contrib contrib-type="author" id="ath5">
        <name>
          <surname>Markó-Varga</surname>
          <given-names>György</given-names>
        </name>
        <xref rid="aff1" ref-type="aff">†</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes" id="ath6">
        <name>
          <surname>Horvatovich</surname>
          <given-names>Peter</given-names>
        </name>
        <xref rid="cor1" ref-type="other">*</xref>
        <xref rid="aff1" ref-type="aff">†</xref>
        <xref rid="aff2" ref-type="aff">‡</xref>
      </contrib>
      <aff id="aff1"><label>†</label>Department
of Biomedical Engineering, <institution>Lund University</institution>, Lund 221 00, <country>Sweden</country></aff>
      <aff id="aff2"><label>‡</label>Department
of Analytical Biochemistry, Groningen Research Institute of Pharmacy, <institution>University of Groningen</institution>, Antonius Deusinglaan 1, 9713 AV Groningen, <country>The Netherlands</country></aff>
      <aff id="aff3"><label>§</label><institution>IBM
Research - Australia</institution>, 60 City Road, Southbank, VIC 3006, <country>Australia</country></aff>
    </contrib-group>
    <author-notes>
      <corresp id="cor1"><label>*</label>Email: <email>p.l.horvatovich@rug.nl</email>.</corresp>
    </author-notes>
    <pub-date pub-type="epub">
      <day>02</day>
      <month>12</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <day>15</day>
      <month>12</month>
      <year>2020</year>
    </pub-date>
    <volume>92</volume>
    <issue>24</issue>
    <fpage>16138</fpage>
    <lpage>16148</lpage>
    <history>
      <date date-type="received">
        <day>09</day>
        <month>09</month>
        <year>2020</year>
      </date>
      <date date-type="accepted">
        <day>16</day>
        <month>11</month>
        <year>2020</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© 2020 American Chemical Society</copyright-statement>
      <copyright-year>2020</copyright-year>
      <copyright-holder>American Chemical
Society</copyright-holder>
      <license>
        <license-p>This is an open access article published under a Creative Commons Non-Commercial No Derivative Works (CC-BY-NC-ND) Attribution <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/page/policy/authorchoice_ccbyncnd_termsofuse.html">License</ext-link>, which permits copying and redistribution of the article, and creation of adaptations, all for non-commercial purposes.</license-p>
      </license>
    </permissions>
    <abstract>
      <p content-type="toc-graphic">
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0008" id="ab-tgr1"/>
      </p>
      <p>Mass spectrometry imaging (MSI) is
a technique that provides comprehensive
molecular information with high spatial resolution from tissue. Today,
there is a strong push toward sharing data sets through public repositories
in many research fields where MSI is commonly applied; yet, there
is no standardized protocol for analyzing these data sets in a reproducible
manner. Shifts in the mass-to-charge ratio (<italic>m</italic>/<italic>z</italic>) of molecular peaks present a major obstacle that can
make it impossible to distinguish one compound from another. Here,
we present a label-free <italic>m</italic>/<italic>z</italic> alignment
approach that is compatible with multiple instrument types and makes
no assumptions on the sample’s molecular composition. Our approach,
MSIWarp (<uri xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://github.com/horvatovichlab/MSIWarp">https://github.com/horvatovichlab/MSIWarp</uri>), finds an <italic>m</italic>/<italic>z</italic> recalibration function
by maximizing a similarity score that considers both the intensity
and <italic>m</italic>/<italic>z</italic> position of peaks matched
between two spectra. MSIWarp requires only centroid spectra to find
the recalibration function and is thereby readily applicable to almost
any MSI data set. To deal with particularly misaligned or peak-sparse
spectra, we provide an option to detect and exclude spurious peak
matches with a tailored random sample consensus (RANSAC) procedure.
We evaluate our approach with four publicly available data sets from
both time-of-flight (TOF) and Orbitrap instruments and demonstrate
up to 88% improvement in <italic>m</italic>/<italic>z</italic> alignment.</p>
    </abstract>
    <custom-meta-group>
      <custom-meta>
        <meta-name>document-id-old-9</meta-name>
        <meta-value>ac0c03833</meta-value>
      </custom-meta>
      <custom-meta>
        <meta-name>document-id-new-14</meta-name>
        <meta-value>ac0c03833</meta-value>
      </custom-meta>
      <custom-meta>
        <meta-name>ccc-price</meta-name>
        <meta-value/>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="sec1">
    <title>Introduction</title>
    <p>Mass spectrometry (MS)
is a widespread analytical technique used
to detect and quantify ionized molecules, and it has many applications
in biology, chemistry, and medicine. In MS imaging (MSI), molecular
ions are sampled from different locations on a surface area, such
as a tissue section, allowing the mass spectrometer to serve as a
molecular imaging device. The ability to determine the spatial distribution
of thousands of biological compounds in a single experiment makes
MSI a powerful tool for tissue characterization. There have been extensive
developments in the MSI field during the last decades, resulting in
new experimental workflows, improved ionization and sampling methods,
and advances in both the spatial and mass resolutions of instruments.<sup><xref ref-type="bibr" rid="ref1">1</xref>−<xref ref-type="bibr" rid="ref3">3</xref></sup> The availability of a wide variety of ionization techniques such
as secondary-ion MS (SIMS), desorption electrospray ionization (DESI),
and matrix-assisted laser desorption/ionization (MALDI) allows ionization
of many compound classes with both targeted and untargeted approaches.<sup><xref ref-type="bibr" rid="ref1">1</xref></sup> High-performance Orbitrap and Fourier transform
ion cyclotron resonance (FT-ICR) mass analyzers can scan tissue sections
with a subcellular spatial resolution and a mass resolution exceeding
500 000. Low sensitivity has been a longstanding obstacle for
high-spatial-resolution MSI but has recently been improved by optimizing
the laser wavelength in MALDI to increase ionization efficiency, or
by post-ionizing neutral molecules to increase ion yield.<sup><xref ref-type="bibr" rid="ref2">2</xref></sup> Novel sample preparation workflows have led to
enhanced quantification and identification of metabolites, peptides,
and proteins. These include protein extraction methods, in situ protease
digestion of proteins, and the use of chemical derivatization such
as labeling with photocleavable mass tags to enhance low-intensity
molecule signals.<sup><xref ref-type="bibr" rid="ref3">3</xref>,<xref ref-type="bibr" rid="ref4">4</xref></sup> Altogether, this leads to highly
complex data sets that demand accurate preprocessing and sophisticated
bioinformatic analysis to maximize their utility in biological and
clinical research.<sup><xref ref-type="bibr" rid="ref5">5</xref></sup></p>
    <p>A persisting
issue in MSI is systematic mass misalignment, leading
to slight shifts in the <italic>m</italic>/<italic>z</italic> ratio
of molecule peaks across spectra. These shifts can result in misidentified
peaks or an increased risk of mixing peaks from different molecules
with similar masses in the same ion image. Mass misalignment is typically
more severe for time-of-flight (TOF) instruments than for FT-ICR,
Orbitrap, or other Fourier transform (FT) instruments.<sup><xref ref-type="bibr" rid="ref6">6</xref></sup> Variations in temperature throughout the experiment, contractions
and dilatations of the ion tube, contamination of the ion source,
and tissue topography are some factors that are related to mass shifts
in spectra generated by TOF instruments. For FT instruments, the most
common source of mass misalignment is the space-charge effect, which
causes mass shifts that increase with the number of ions in the trap.<sup><xref ref-type="bibr" rid="ref7">7</xref>,<xref ref-type="bibr" rid="ref8">8</xref></sup> The mass shifts in FT instruments can often be limited using automatic
gain control (AGC), but can be considerable if suboptimal AGC settings
are used.</p>
    <p>When discussing mass misalignment and mass shifts,
it is important
to distinguish between relative mass alignment and absolute mass accuracy.
Here, the former refers to how tightly peak masses are distributed
across spectra, while the latter refers to the difference between
a molecule’s theoretical peak mass and its observed peak mass.
A common approach to correct mass shifts is to perform either external
or internal calibration by comparing the measured masses of predefined
peaks to their expected theoretical masses. External calibration is
performed by depositing a calibration standard outside the tissue
region and comparing the measured peak masses to the known masses
of the calibrants. The same calibration function is then applied to
all tissue spectra. While this approach is simple, it does not reduce
the relative misalignment or correct mass shifts introduced during
the experiment. Internal calibration, on the other hand, relies on
identifying known peaks in each tissue spectrum. The known peaks can
be either prominent molecule peaks intrinsic to the tissue or peaks
corresponding to calibrants sprayed on the whole tissue area. Internal
calibration can improve both the relative alignment between spectra
and absolute mass accuracy but performs poorly for spectra in which
the calibration peaks are missing or incorrectly assigned.<sup><xref ref-type="bibr" rid="ref9">9</xref></sup></p>
    <p>An alternative approach is to align all
spectra to a common reference
spectrum. Given that the absolute mass accuracy of the reference spectrum
is high, this can reduce relative misalignment and improve absolute
mass accuracy simultaneously. A simple approach to aligning one spectrum
to another is fitting a polynomial recalibration function to the mass
difference of their shared peaks and then using this recalibration
function to recalibrate all peak masses. While this approach is flexible,
it is highly sensitive to spurious peak matches. Bocker and Makinen<sup><xref ref-type="bibr" rid="ref10">10</xref></sup> introduced a linear curve-fitting approach that
is robust to spurious peak matches, and Kulkarni et al.<sup><xref ref-type="bibr" rid="ref11">11</xref></sup> later used this approach, together with spatial
information, to further improve mass alignment. More recently, there
has been increased focus on mass alignment for TOF instruments. Ráfols
et al.<sup><xref ref-type="bibr" rid="ref6">6</xref></sup> proposed an alignment algorithm
that uses the cross-correlation between two spectra in the upper and
lower parts of the mass range to estimate mass shift. They then use
the upper and lower shifts to recalibrate the mass axis of one of
the spectra to that of the other. Boskamp et al.<sup><xref ref-type="bibr" rid="ref9">9</xref></sup> elegantly exploit statistical properties of the peptide
background signal to improve mass alignment and absolute mass accuracy.
They estimate the mass shift across the <italic>m</italic>/<italic>z</italic> range by comparing observed to theoretical peak masses
on the Kendrick mass scale. Unlike Ráfols et al.’s method,
their method can correct nonlinear mass shifts, but the dependency
on the peptide background limits its generalizability.</p>
    <p>Another
aspect of mass alignment is at which stage in the processing
pipeline it is performed. It can be performed in the time domain for
TOF spectra, in the frequency domain for FT spectra, using profile
mass spectra, or using centroided mass spectra.<sup><xref ref-type="bibr" rid="ref6">6</xref>,<xref ref-type="bibr" rid="ref10">10</xref>,<xref ref-type="bibr" rid="ref12">12</xref>,<xref ref-type="bibr" rid="ref13">13</xref></sup> In principle,
aligning spectra at an early stage is advantageous in the sense that
errors are not accumulated in subsequent processing steps. In practice,
however, time or frequency spectra are often inaccessible as vendor
software typically only provide mass spectra, and the majority of
data sets uploaded to repositories are processed to some extent. FT
spectra, in particular, are often centroided to reduce their otherwise
impractical size.<sup><xref ref-type="bibr" rid="ref14">14</xref></sup> It is impossible to
recover a raw spectrum from one that has been processed. Hence, an
approach must be able to perform alignment with processed spectra
to be compatible with most MSI data sets. This compatibility is essential;
data sets generated independently in other labs are frequently used
to validate biological findings or novel methods. A public data set
may be generated with any instrument and additional processing is
sometimes required to ensure its quality. This compatibility requirement,
together with the growing popularity of public MSI data set repositories
such as MetaboLights<sup><xref ref-type="bibr" rid="ref15">15</xref></sup> or METASPACE,<sup><xref ref-type="bibr" rid="ref16">16</xref></sup> creates a demand for algorithms that can perform
accurate mass alignment on spectra acquired with multiple instrument
types and regardless of whether they are already partially processed.</p>
    <p>In this work, we adapt the correlation optimized warping (COW)<sup><xref ref-type="bibr" rid="ref17">17</xref></sup> algorithm to perform label-free MSI mass alignment
using a custom benefit function and show that we can greatly reduce
variation in peak masses between spectra. COW aligns a pair of signals
by performing local warpings on one signal so that the global similarity
relative to the other is maximized. We have previously shown that
COW is effective in reducing misalignment in the time dimension between
liquid chromatography–mass spectrometry (LC-MS) sample runs.<sup><xref ref-type="bibr" rid="ref18">18</xref>,<xref ref-type="bibr" rid="ref19">19</xref></sup> Here, we instead use COW to reduce mass misalignment between spectra
by warping the mass dimension.</p>
    <p>Crucially, our method finds the
optimal warping of one spectrum
relative to another using only a list of centroided peaks from each
spectrum. We model centroided peaks as Gaussians whose widths vary
with <italic>m</italic>/<italic>z</italic>, and define the similarity
between two spectra as the total overlap of their shared peaks. To
assess and further improve COW’s robustness for particularly
peak-sparse or misaligned spectra, we include an optional outlier
detection step in the form of a tailored random sample consensus (RANSAC)<sup><xref ref-type="bibr" rid="ref20">20</xref></sup> procedure. The concept of our method is similar
to that of Ráfols et al.,<sup><xref ref-type="bibr" rid="ref6">6</xref></sup> but differs
in two key aspects. First, we find the mass recalibration function
by maximizing the product (overlap) of centroided peaks instead of
the cross-correlation of continuous spectra. Second, our method can,
since it is derived from COW, correct nonlinear mass shifts. Thereby,
our method utilizes information about peak height and width (not simply
mass location) while remaining compatible with most MSI data sets.
We demonstrate the effectiveness and generalizability of our method,
named MSIWarp, by applying it to four publicly available data sets.
MSIWarp performs accurate and robust alignment with centroided spectra,
is compatible with multiple instrument types, and makes no assumptions
on the molecular composition of the sample. We provide a fast C++
implementation of MSIWarp together with a Python binding at <uri xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://github.com/horvatovichlab/MSIWarp">https://github.com/horvatovichlab/MSIWarp</uri>.</p>
  </sec>
  <sec id="sec2">
    <title>Theory</title>
    <p>The core of MSIWarp is a spectrum-to-spectrum similarity
score
that is used to find an optimal warping function between the mass
axis of one spectrum and that of another. To align an entire MSI data
set, all spectra, the sample spectra, are warped to a common reference
spectrum that can be selected from the data set, or be a composite
spectrum constructed from multiple spectra. Similar to our previous
work,<sup><xref ref-type="bibr" rid="ref19">19</xref></sup> MSIWarp deliberately relies on
centroided, i.e., peak-picked, spectra to perform alignment. Peak-picking
can improve alignment by retaining most compound-related signals while
removing background noise that degrades performance. More importantly,
however, an alignment method that takes centroided spectra as input
can trivially be used to align profile spectra, but not vice versa.
MSIWarp relies on centroid spectra instead of profile spectra and
is thereby readily applicable to almost any MSI data set.</p>
    <p>MSIWarp
can be summarized in three steps (<xref rid="fig1" ref-type="fig">Figure <xref rid="fig1" ref-type="fig">1</xref></xref>): first, we match the peaks of the sample
spectrum against those of the reference spectrum. Second, based on
the peak matches from step one, we split the <italic>m</italic>/<italic>z</italic> range in a manner that ensures there is sufficient shared
information in all segments. Finally, we find an optimal warping function
with the peak matches and the partitioning of the <italic>m</italic>/<italic>z</italic> range obtained in steps one and two, respectively,
and use this function to recalibrate the peak masses of the sample
spectrum.</p>
    <fig id="fig1" position="float">
      <label>Figure 1</label>
      <caption>
        <p>Conceptual description of MSIWarp. After matching the peaks in
the sample spectrum against those in the reference spectrum, the sample
spectrum is warped so that its similarity to the reference spectrum
is maximized. (A) Scatter of the mass shift between matched peaks
across the <italic>m</italic>/<italic>z</italic> range. The shifted
warping nodes are marked with vertical arrows (the actual search space
is centered around zero and extends beyond the arrows). The orange
curve shows the estimated mass shift based on our similarity score.
(B) The similarity score is evaluated for the set of candidate warpings,
and the warping resulting in the highest score is used to align the
sample spectrum. (C) Zoom-in of the spectra with the centroided peaks
modeled as Gaussians. Two sample spectrum peaks are matched to the
reference spectrum peak at 1207 <italic>m</italic>/<italic>z</italic>, but the spurious match (also marked in (A)) has no effect on the
warping.</p>
      </caption>
      <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0002" id="gr1" position="float"/>
    </fig>
    <sec id="sec2.1">
      <title>Mass Alignment</title>
      <p>Our method aligns
a pair of spectra
by warping one in the mass dimension so that its similarity to the
other is maximized. Provided that the type of mass spectrometer used
to generate the spectra is known, it requires only a list of peak
heights and <italic>m</italic>/<italic>z</italic> locations for each
spectrum. We model peak intensity as a Gaussian function of <italic>m</italic>/<italic>z</italic> with centroid mass μ and height <italic>H</italic>. With this peak model, we can then compute the similarity
of two centroided spectra as the sum of all pairwise peak overlaps,
and use this similarity score as a measure of alignment quality. To
model peak width, σ, we use known theoretical relationships
between peak width and <italic>m</italic>/<italic>z</italic>, together
with the mass resolution of the data set. The theoretical relationships
depend on instrument type and are summarized in Suits et al.<sup><xref ref-type="bibr" rid="ref21">21</xref></sup> If the mass resolution is unknown, a good estimate
of a single peak’s full width at half-maximum (FWHM) is enough
to model the width of all other peaks in the data set. While not a
true representation of a mass spectrum peak, the Gaussian peak model
is a sufficient approximation for the purpose of alignment. Similarly,
the modeled peak width does not have to match the true width exactly,
since its main purpose is to provide some freedom when matching and
aligning peaks.</p>
      <p><xref rid="eq1" ref-type="disp-formula">Equations <xref rid="eq1" ref-type="disp-formula">1</xref></xref>–<xref rid="eq4" ref-type="disp-formula">4</xref> formally define our Gaussian
peak model <italic>p</italic>, the overlap between two peaks <italic>I</italic>, and the similarity between two spectra, <italic>B</italic>. The intensity of a peak varies with <italic>m</italic>/<italic>z</italic> according to<disp-formula id="eq1"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m001" position="anchor"/><label>1</label></disp-formula>The
overlap of two peaks is<disp-formula id="eq2"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m002" position="anchor"/><label>2</label></disp-formula>The integral in <xref rid="eq2" ref-type="disp-formula">eq <xref rid="eq2" ref-type="disp-formula">2</xref></xref> can be solved analytically to yield<disp-formula id="eq3"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m003" position="anchor"/><label>3</label></disp-formula>where<disp-formula id="ueq1"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m004" position="anchor"/></disp-formula>and<disp-formula id="ueq2"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m005" position="anchor"/></disp-formula>The similarity
score, <italic>B</italic>,
between two spectra, <italic>S</italic><sub><italic>i</italic></sub> and <italic>S</italic><sub><italic>j</italic></sub>, is the sum
overlap of all matched peaks<disp-formula id="eq4"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m006" position="anchor"/><label>4</label></disp-formula>To compute
the similarity score between a
pair of spectra, the set of peak pairs that satisfy the condition
in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref> must be found.
A peak in the first spectrum is matched to one in the second spectrum
if their <italic>m</italic>/<italic>z</italic> locations are within
a small distance threshold, ϵ, of each other. Note that a peak
in one spectrum can be matched to multiple peaks in the other spectrum.
The threshold ϵ in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref> is proportional to the modeled peak width and therefore increases
with <italic>m</italic>/<italic>z</italic>.</p>
      <p>With our definition
of pairwise similarity between two centroided
spectra, we can search for an optimal warping from a set of candidate
warpings in a similar way as the original COW implementation. This
involves dividing the <italic>m</italic>/<italic>z</italic> range
into segments, evaluating <italic>B</italic> for all candidate warpings
for each segment independently, and then finding the optimal combination
of segment warpings. The analytical form of the integral in <xref rid="eq2" ref-type="disp-formula">eq <xref rid="eq2" ref-type="disp-formula">2</xref></xref> enables fast computation
of the similarity score, which is critical since it must be repeated
for each candidate warping. Here, we denote the lower and upper edges
of an <italic>m</italic>/<italic>z</italic> segment <italic>n</italic><sub>l</sub> and <italic>n</italic><sub>r</sub>, respectively, and
refer to them as the warping nodes of the segment. Note that each
warping node, except those at the lowest and highest ends of the <italic>m</italic>/<italic>z</italic> range, are shared by two segments.
To generate the set of candidate warpings for an <italic>m</italic>/<italic>z</italic> segment, the warping nodes at its edges are shifted
a fixed number of steps upward and downward in <italic>m</italic>/<italic>z</italic>. The set of warpings for that segment then corresponds
to all possible combinations of shifts of <italic>n</italic><sub>l</sub> and <italic>n</italic><sub>r</sub>. Computing <italic>B</italic> for a particular warping and segment is then performed by warping
the peaks in the segment and then computing <italic>B</italic> with
the warped peaks and the peaks from the corresponding segment in the
reference spectrum. Peaks are warped by updating their mass with linear
interpolation according to<disp-formula id="eq5"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m007" position="anchor"/><label>5</label></disp-formula>where<disp-formula id="ueq3"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m008" position="anchor"/></disp-formula>μ is the original
peak mass, μ′
is the warped peak mass, and <italic>n</italic><sub>l</sub><sup arrange="stack">′</sup> and <italic>n</italic><sub>r</sub><sup arrange="stack">′</sup> are
the shifted positions of <italic>n</italic><sub>l</sub> and <italic>n</italic><sub>r</sub>, respectively. Note that while segments are
compressed, stretched, and/or shifted, a peak is never warped out
of its segment and its width and height are left untouched. Finally,
like in the original COW implementation,<sup><xref ref-type="bibr" rid="ref17">17</xref></sup> the optimal combination of warping node moves is found with dynamic
programming. The shift of a warping node is bounded by the slack parameter:
|<italic>n</italic>′ – <italic>n</italic>| ≤ <italic>m</italic><sub><italic>n</italic></sub>. The slack is reflected by
the amplitude of the warping function and should be sufficiently large
to capture the largest shifts. Like the peak matching threshold (ϵ
in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref>), <italic>m</italic> is proportional to FWHM and is computed for each warping node individually.</p>
      <p>By maximizing our similarity score, we find a piecewise linear
mass recalibration function with a degree of freedom determined by
the number of warping nodes. A large number of short segments gives
a flexible warping function that can correct local <italic>m</italic>/<italic>z</italic> shifts, whereas a small number of long segments
generally results in a more stable, but less flexible, warping function.
The risk of overfitting the warping function to noise or random variations
in peak mass is smaller with segments that have many matched peaks.
Due to this, we prefer long segments that accommodate a sufficient
number of peak matches (at least 10–20) to short segments that
are potentially more flexible.</p>
    </sec>
    <sec id="sec2.2">
      <title>Placement of Warping Nodes</title>
      <p>In many MSI data sets, there
is a large variation in peak density across the <italic>m</italic>/<italic>z</italic> range. For such data sets, the placement of the
warping nodes can greatly influence the warping quality. The same
warping nodes can be used for all spectra, or they can be placed uniquely
for each spectrum. The goal of the warping node placement is to have
a segment length that is adapted to the amount of shared information,
i.e., peak matches, between the sample and reference spectra in all
parts of the <italic>m</italic>/<italic>z</italic> range. This can
be achieved by generating a density estimate (smooth histogram) of
the peak matches between the sample and reference spectra over the <italic>m</italic>/<italic>z</italic> range and then placing the warping
nodes between the peaks of the density curve. If the warping nodes
are uniquely placed for each spectrum, they can alternatively be placed
so that the number of peak matches is the same in all segments. A
third option is to use segments with uniform lengths. This may work
well for spectra with a high peak density throughout the <italic>m</italic>/<italic>z</italic> range but can result in segments without peak
matches for peak-sparse spectra.</p>
    </sec>
    <sec id="sec2.3">
      <title>RANSAC Outlier Detection</title>
      <p>Unlike alignment methods that
rely solely on the difference in mass between matched peaks, MSIWarp
is naturally robust to spurious matches, as long as there are sufficiently
many true matches. To confirm this, we use a custom RANSAC procedure
to detect spurious matches, perform alignment both with the full set
of peak matches and with that obtained after having removed spurious
matches, and compare the results to evaluate whether spurious matches
degrade the alignment quality of MSIWarp in practice. Generally, RANSAC
fits a model to a minimal subset of data points that may contain outliers.
The subset is resampled numerous times and the model is fit to each
subset. The best model, given some criteria, is then selected and
all data points that fit the model are included in the “inlier”
set. We combine RANSAC with our method to separate true matches (inliers)
from spurious matches in the following way:<list list-type="simple"><list-item><label>(i)</label><p>Generate a list of preliminary peak
matches with a permissive distance threshold proportional to peak
FWHM.</p></list-item><list-item><label>(ii)</label><p>Randomly sample
two matches from
the preliminary set of matches for each segment, and fit a trial warping
model to the sampled matches. Warp all other preliminary matches according
to the trial model.</p></list-item><list-item><label>(iii)</label><p>Add peak matches whose mass distance
after alignment is below a strict threshold to the inlier set.</p></list-item><list-item><label>(iv)</label><p>Repeat steps (i)–(iii) <italic>n</italic> times and return the largest set of inliers. Given an
estimate of the fraction of inliers among the peak matches, <italic>n</italic> can be set to obtain a desired probability of an outlier-free
candidate model.</p></list-item></list>We use ϵ from <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref> as the threshold in (i)
and 0.3 times peak FWHM as that in
(iii). When using a large number of segments, the warping function
found using the subset of peak matches in (ii) is highly unstable
and can sometimes fit a large number of spurious matches by chance.
Therefore, we use only one or two warping segments in the RANSAC step.
After removing the spurious matches, more warping segments can be
added in parts of the <italic>m</italic>/<italic>z</italic> range
that are supported by the number of true matches. The final warping
is then searched for using all, or a large fraction, of the true matches.</p>
    </sec>
  </sec>
  <sec id="sec3">
    <title>Materials and Methods</title>
    <sec id="sec3.1">
      <title>Data Sets</title>
      <p>To evaluate MSIWarp, we
applied it to four
publicly available data sets that together represent the most common
MSI experimental setups. The first data set was generated from two
mouse kidney sections with a rapifleX MALDI TOF/TOF instrument (Bruker
Daltonics).<sup><xref ref-type="bibr" rid="ref22">22</xref></sup> The second data set was generated
from human cancer spheroids with an ultrafleXtreme MALDI-TOF/TOF instrument
(Bruker Daltonics).<sup><xref ref-type="bibr" rid="ref23">23</xref></sup> The third data set
was generated from a rat liver section with a MALDI LTQ Orbitrap XL
instrument (Thermo Fischer Scientific).<sup><xref ref-type="bibr" rid="ref24">24</xref></sup> The fourth data set was generated from a colorectal adenocarcinoma
sample using a home-built motorized DESI ion source and an LTQ XL
Orbitrap Discovery instrument (Thermo Fischer Scientific).<sup><xref ref-type="bibr" rid="ref25">25</xref></sup> The data sets, referred to as the TOF kidney,
TOF spheroids, Orbitrap liver, and Orbitrap DESI data sets, are summarized
in <xref rid="tbl1" ref-type="other">Table <xref rid="tbl1" ref-type="other">1</xref></xref>. A more
detailed description of the data sets is available in the <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Supporting Information</ext-link>, and total ion current
(TIC) images for each data set are shown in <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figure S1</ext-link>. Before performing mass alignment, we filtered out peaks
whose intensity was below a signal-to-noise ratio (SNR) of 2.5 from
the mouse kidney TOF data set and centroided all data sets, except
for the Orbitrap DESI, with the parabolic centroiding algorithm by
Robichaud et al.<sup><xref ref-type="bibr" rid="ref26">26</xref></sup> We downloaded the Orbitrap
DESI data set in centroid mode from the MetaboLights repository. The
data sets were preprocessed with in-house Python scripts.</p>
      <table-wrap id="tbl1" position="float">
        <label>Table 1</label>
        <caption>
          <title>Summary of the Data Sets<xref rid="t1fn1" ref-type="table-fn">a</xref></title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center"> </th>
              <th style="border:none;" align="center">TOF kidney</th>
              <th style="border:none;" align="center">TOF spheroids</th>
              <th style="border:none;" align="center">Orbitrap
liver</th>
              <th style="border:none;" align="center">Orbitrap
DESI</th>
            </tr>
            <tr>
              <th style="border:none;" align="center">ionization
technique</th>
              <th style="border:none;" align="center">MALDI</th>
              <th style="border:none;" align="center">MALDI</th>
              <th style="border:none;" align="center">MALDI</th>
              <th style="border:none;" align="center">DESI</th>
            </tr>
            <tr>
              <th style="border:none;" align="center">species</th>
              <th style="border:none;" align="center">mouse</th>
              <th style="border:none;" align="center">human</th>
              <th style="border:none;" align="center">rat</th>
              <th style="border:none;" align="center">human</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">no. spectra</td>
              <td style="border:none;" align="left">33 242</td>
              <td style="border:none;" align="left">1114</td>
              <td style="border:none;" align="left">23 823</td>
              <td style="border:none;" align="left">20 286</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">raster size (μm)</td>
              <td style="border:none;" align="left">100</td>
              <td style="border:none;" align="left">50</td>
              <td style="border:none;" align="left">50</td>
              <td style="border:none;" align="left">100</td>
            </tr>
            <tr>
              <td style="border:none;" align="left"><italic>m</italic>/<italic>z</italic> range (Da)</td>
              <td style="border:none;" align="left">500–2500</td>
              <td style="border:none;" align="left">800–4500</td>
              <td style="border:none;" align="left">150–1000</td>
              <td style="border:none;" align="left">200–1000</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">resolution</td>
              <td style="border:none;" align="left">2600</td>
              <td style="border:none;" align="left">17 500</td>
              <td style="border:none;" align="left">60 000</td>
              <td style="border:none;" align="left">60 000</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">avg. no. peaks</td>
              <td style="border:none;" align="left">244</td>
              <td style="border:none;" align="left">57</td>
              <td style="border:none;" align="left">730</td>
              <td style="border:none;" align="left">701</td>
            </tr>
          </tbody>
        </table>
        <table-wrap-foot>
          <fn id="t1fn1">
            <label>a</label>
            <p>Both TOF
data sets were uploaded
to ProteomeXchange smoothed and with their baseline removed. Resolutions
for the Orbitrap data sets were calculated at 400 <italic>m</italic>/<italic>z</italic>.</p>
          </fn>
        </table-wrap-foot>
      </table-wrap>
    </sec>
    <sec id="sec3.2">
      <title>Data Analysis</title>
      <p>To measure the effect of alignment in
each data set, we calculated the mass dispersion around a set of reference
peaks. We obtained the mass dispersion of a reference peak by binning
all spectra around its <italic>m</italic>/<italic>z</italic> and then
calculating the standard deviation of peak masses within the resulting
mass bin. By binning we mean isolating peaks across spectra at predefined <italic>m</italic>/<italic>z</italic> locations, and we refer to the isolation
windows as mass bins. We used a bin width two times the FWHM of the
reference peak. As reference peaks, we used the most intense peaks
of the mean spectrum (100 for the TOF kidney, Orbitrap liver, and
Orbitrap DESI data sets and 50 for the TOF spheroid data set), some
matrix peaks, and peaks that were identified in the papers that originally
published the data sets. The mean spectrum was generated after alignment
with MSIWarp, and we performed the binning and calculated mass dispersion
both before and after alignment.</p>
      <p>To further assess the quality
of the alignment, we generated scatter plots of peak mass and spectrum
acquisition time for the mass bin of each reference peak (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figures S3–S13</ext-link>). The scatter plots provide
a clear view of the mass shift before and after alignment and serve
as valuable quality control for the alignment of specific peaks. Despite
the previous intensity filtering of the TOF kidney data set based
on SNR, some mass bins were still contaminated with faint background
peaks. To reduce the influence of these, we applied an intensity threshold
to each mass bin. The threshold was defined as the lower intensity
quartile of all of the peaks in the mass bin, and peaks whose intensity
was below this threshold were excluded when calculating mass dispersion.</p>
    </sec>
  </sec>
  <sec id="sec4">
    <title>Results and Discussion</title>
    <p>To reiterate, MSIWarp aligns a data
set by maximizing the similarity
between each spectrum and a common reference spectrum. Like any method
that performs pairwise alignment, it relies on shared information.
In the ideal case, all spectra share numerous peaks with the reference
spectrum throughout the <italic>m</italic>/<italic>z</italic> range.
In a more challenging case, there are few shared peaks overall and/or
wide gaps in the <italic>m</italic>/<italic>z</italic> range without
any shared peaks. <xref rid="fig2" ref-type="fig">Figure <xref rid="fig2" ref-type="fig">2</xref></xref> shows a pair of spectra from the Orbitrap data set, another
from the TOF kidney data set, and the <italic>m</italic>/<italic>z</italic> difference between preliminary matched peaks. The Orbitrap spectra
are homogeneous, with shared peaks throughout the <italic>m</italic>/<italic>z</italic> range, and the mass shifts are small (&lt;1.5
ppm). In contrast, the TOF spectra are heterogeneous, the mass shifts
are significantly larger (&gt;200 ppm), and there is a part of the <italic>m</italic>/<italic>z</italic> range with almost no shared peaks (1000–1400 <italic>m</italic>/<italic>z</italic>). Note that the mass differences between
shared peaks for a pair of aligned spectra are expected to be distributed
around zero throughout the <italic>m</italic>/<italic>z</italic> range.
However, in these examples, the misalignment is apparent; the mass
shift of matched peaks consistently increases with <italic>m</italic>/<italic>z</italic> for both pairs. To accommodate large mass shifts,
we used a peak matching threshold (ϵ in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref>) of approximately two times the FWHM when
matching peaks. With the low mass resolution in the TOF kidney data
set, this meant matching peaks within a window of ±0.76 <italic>m</italic>/<italic>z</italic> at 1000 <italic>m</italic>/<italic>z</italic>. A wide matching window increases the number of spurious
matches; the scatter in <xref rid="fig2" ref-type="fig">Figure <xref rid="fig2" ref-type="fig">2</xref></xref>b contains numerous examples, most notably those clustered
around 850 and 1050 <italic>m</italic>/<italic>z</italic>. Finally,
we chose to place the warping nodes based on the density estimate
of peak matches, since it generally resulted in a smoother partitioning
of the <italic>m</italic>/<italic>z</italic> range than when placing
them so that all segments contained the same number of peak matches.
We generated the density estimate by performing a Kernel density estimation
(KDE) of peak <italic>m</italic>/<italic>z</italic> and then placed
the warping nodes between the peaks of the density curve, resulting
in 4–10 warping segments for the four data sets. Increasing
and decreasing the bandwidth of the KDE is a flexible way to adjust
the number of warping segments and the number of peak matches in each
segment. We used a bandwidth of 15 Da for the TOF kidney and Orbitrap
data sets, and a bandwidth of 100 Da for the TOF spheroid data set
since it was significantly less peak-dense than the other data sets.</p>
    <fig id="fig2" position="float">
      <label>Figure 2</label>
      <caption>
        <p>Top: pair
of raw spectra from the Orbitrap liver data set (a) and
another from the TOF kidney (b). Bottom: scatters of <italic>m</italic>/<italic>z</italic> difference between matched peaks with point size
scaled by intensity. The Orbitrap spectra share peaks across the entire <italic>m</italic>/<italic>z</italic> range. In contrast, the TOF spectra
share no peaks in a large part of the <italic>m</italic>/<italic>z</italic> range (1000–1400 <italic>m</italic>/<italic>z</italic>).
This example also highlights the severity of the mass shift in the
TOF kidney data set: at 800 <italic>m</italic>/<italic>z</italic>,
the shift is close to 0.18 <italic>m</italic>/<italic>z</italic> (219
ppm) between the TOF pair compared to 0.001 <italic>m</italic>/<italic>z</italic> (1.25 ppm) between the Orbitrap pair.</p>
      </caption>
      <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0003" id="gr2" position="float"/>
    </fig>
    <p>Spurious peak matches are largely inconsequential to MSIWarp as
long as spectra are reasonably peak-dense; in fact, most spectra are
aligned accurately and reliably without RANSAC, even those in the
TOF data sets. We hypothesized that the importance of identifying
true matches increases when aligning peak-sparse spectra. For this
reason, we aligned the TOF data sets both with and without RANSAC.
When combining RANSAC with COW, it is important to use a small number
of warping segments in this step to avoid overfitting the candidate
models to spurious peak matches; here, we used two segments for both
TOF data sets in the RANSAC step. Manual inspection of scatter plots
like those in <xref rid="fig3" ref-type="fig">Figure <xref rid="fig3" ref-type="fig">3</xref></xref> suggests that RANSAC confidently filters out spurious peak matches
in almost all spectra across both TOF data sets. We used RANSAC to
filter out spurious peak matches before searching for the optimal
warping. Then, we added more warping nodes in the peak-dense parts
of the <italic>m</italic>/<italic>z</italic> range to gain more flexibility.
Thereby, we obtained a flexibility in the warping function that was
adapted to the number of shared peaks throughout the <italic>m</italic>/<italic>z</italic> range. We provide some examples of how RANSAC
finds the true peak matches (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figure S2</ext-link>)
along with an animation in the <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Supporting Information</ext-link>.</p>
    <fig id="fig3" position="float">
      <label>Figure 3</label>
      <caption>
        <p>(a, b) Mass shift estimated by MSIWarp (orange line) overlaid on
the peak match scatter from <xref rid="fig2" ref-type="fig">Figure <xref rid="fig2" ref-type="fig">2</xref></xref>. (b) We use more warping nodes in the peak-dense part
of the <italic>m</italic>/<italic>z</italic> range than in the peak-sparse
part; the zoom-in shows that the warping function closely follows
the local shifts between 700 and 900 <italic>m</italic>/<italic>z</italic>.</p>
      </caption>
      <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0004" id="gr3" position="float"/>
    </fig>
    <p>When aligning a data set by aligning
each spectrum to a common
reference spectrum, the quality of that reference spectrum is essential.
We tried an approach similar to that of Kulkarni et al.,<sup><xref ref-type="bibr" rid="ref11">11</xref></sup> where the reference spectrum is continuously
updated with each aligned sample spectrum, but observed no significant
improvement over aligning against a constant reference spectrum of
high quality. The spectrum with the highest TIC was sufficient in
terms of peak coverage for all four data sets, and we therefore chose
to use it as a reference. Although the spectra with the highest TIC
were appropriate references for the alignment of the data sets that
we discuss here, a composite spectrum may be needed to fully cover
the <italic>m</italic>/<italic>z</italic> range in other data sets.</p>
    <p>How we dealt with segments without shared peaks also deserves mention.
We chose to interpolate the warping function in empty regions, as
is evident in <xref rid="fig3" ref-type="fig">Figure <xref rid="fig3" ref-type="fig">3</xref></xref>b at around 1200 <italic>m</italic>/<italic>z</italic>. This is reasonable
under the assumption that some relevant data set peaks are missing
in the reference spectrum, which is often the case, so they can be
present in a sample spectrum without being shared with the reference.
An alternative approach is to leave the empty parts of the <italic>m</italic>/<italic>z</italic> region unaligned, which can be more
appropriate if the reference spectrum has a very high peak coverage
throughout the <italic>m</italic>/<italic>z</italic> range. When this
is the case, the sample spectrum likely has little or no information
in regions where it does not share peaks with the reference spectrum,
and aligning those regions is unnecessary.</p>
    <sec id="sec4.1">
      <title>Reduction in Mass Misalignment</title>
      <p>After alignment with
MSIWarp, mass dispersion is reduced considerably in all four data
sets. In <xref rid="tbl2" ref-type="other">Table <xref rid="tbl2" ref-type="other">2</xref></xref>, the
mass dispersions of the mean spectrum peaks before and after alignment
are reported in both ppm and FWHM. The full list of dispersions of
the mean spectrum peaks is available in the <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Supporting Information</ext-link> spreadsheet. Interestingly, we observed no significant
improvement when aligning the TOF data sets with RANSAC compared to
aligning it without RANSAC. This suggests that the inherent robustness
of COW is sufficient in dealing with spurious peak matches for the
majority of spectra. To assess the sensitivity of MSIWarp to the modeled
peak width, σ, and the peak matching threshold, ϵ, we
reran the analysis of the Orbitrap liver and TOF kidney data sets
for various values of these parameters (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Table S1 and S2</ext-link>). This parameter sensitivity analysis suggests that
MSIWarp can perform well even when σ over- or underestimates
the experimental peak width by a factor of up to 2. It also suggests
that a large peak matching threshold is better than a small one, which
is further evidence that MSIWarp is robust to spurious peak matches
and that the most important factor is that true matches are captured
throughout the <italic>m</italic>/<italic>z</italic> range. In addition
to using the spectrum with the highest TIC as a reference, we also
aligned the TOF kidney data set to each of the 11 spectra with TICs
closest to the data set median, resulting in median mass dispersions
of mean spectrum peaks between 11.64 and 16.10 ppm (avg. 12.53). For
9 out of 11 spectra, the median mass dispersion was lower than when
using the spectrum with the highest TIC as a reference (12.73 ppm).
In comparison, using the spectrum with the lowest TIC as a reference
resulted in a median mass dispersion of 73.45 ppm. Altogether, this
indicates that a minimum TIC threshold can be used to filter out unsuitable
reference spectra, but otherwise, the TIC provides little or no information
about a spectrum’s suitability as a reference.</p>
      <table-wrap id="tbl2" position="float">
        <label>Table 2</label>
        <caption>
          <title>Median Mass Dispersion of Mean Spectrum
Peaks before (Raw) and after Alignment (Warped) for the Four Data
Sets</title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center"> </th>
              <th style="border:none;" align="center" char=".">TOF kidney</th>
              <th style="border:none;" align="center" char=".">TOF spheroids</th>
              <th style="border:none;" align="center" char=".">Orbitrap
liver</th>
              <th style="border:none;" align="center" char=".">Orbitrap
DESI</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">raw (ppm)</td>
              <td style="border:none;" align="char" char=".">106.39</td>
              <td style="border:none;" align="char" char=".">35.63</td>
              <td style="border:none;" align="char" char=".">0.63</td>
              <td style="border:none;" align="char" char=".">0.52</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">warped (ppm)</td>
              <td style="border:none;" align="char" char=".">12.73</td>
              <td style="border:none;" align="char" char=".">6.48</td>
              <td style="border:none;" align="char" char=".">0.18</td>
              <td style="border:none;" align="char" char=".">0.17</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">raw (FWHM)</td>
              <td style="border:none;" align="char" char=".">0.27</td>
              <td style="border:none;" align="char" char=".">0.63</td>
              <td style="border:none;" align="char" char=".">0.03</td>
              <td style="border:none;" align="char" char=".">0.03</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">warped (FWHM)</td>
              <td style="border:none;" align="char" char=".">0.03</td>
              <td style="border:none;" align="char" char=".">0.11</td>
              <td style="border:none;" align="char" char=".">0.01</td>
              <td style="border:none;" align="char" char=".">0.01</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">reduction (%)</td>
              <td style="border:none;" align="char" char=".">88.03</td>
              <td style="border:none;" align="char" char=".">81.82</td>
              <td style="border:none;" align="char" char=".">72.03</td>
              <td style="border:none;" align="char" char=".">68.00</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
      <p>Visualization of how
the peak mass varies across the experiment
gives a good overview of alignment; <xref rid="fig4" ref-type="fig">Figure <xref rid="fig4" ref-type="fig">4</xref></xref>a–<xref rid="fig4" ref-type="fig">4</xref>c shows
the scatter of the relative peak mass before and after alignment with
MSIWarp and spectrum acquisition time for three example peaks. The
same pattern is seen for the three peaks: aligning with MSIWarp visibly
tightens the peak scatter and removes the systematic shifts related
to spectrum acquisition time. These scatter plots are effective in
visualizing time-dependent mass shift but do not provide a clear picture
of how mass shift relates to tissue location. To better visualize
this relationship, we show the relative mass shift of a matrix peak
([M – H<sub>2</sub>O + H]<sup>+</sup>, 172.04 <italic>m</italic>/<italic>z</italic>) from the Orbitrap data set as a function of
tissue location in <xref rid="fig5" ref-type="fig">Figure <xref rid="fig5" ref-type="fig">5</xref></xref>a. In this plot, it is evident that the peak masses decrease
with time (the tissue was scanned from top to bottom), but also that
some shifts are related to tissue location. The blue spots in the
bottom half of the section break the trend related to acquisition
time; in these spots, peak masses are increased by more than 4 ppm,
compared to an average decrease of approximately 1 ppm in the bottom
half of the section. The blue spots appear to be correlated to the
TIC of the spectra, which could be due to the space-charge effect. <xref rid="fig5" ref-type="fig">Figure <xref rid="fig5" ref-type="fig">5</xref></xref>b shows the mass
shift image of the peak at 890.8 <italic>m</italic>/<italic>z</italic> (PI 38:2) from the TOF kidney data set. In contrast to the matrix
peak from the Orbitrap data set, the mass shift of this peak appears
to be unrelated to both spectrum acquisition time and TIC (<xref rid="fig4" ref-type="fig">Figures <xref rid="fig4" ref-type="fig">4</xref></xref>a and <xref rid="fig5" ref-type="fig">5</xref>b). Instead, there is a strong relationship to tissue location:
in both kidney sections, peak masses appear to be increased in the
cortex and decreased in the medulla. The “stripes” at
the top part of the left section are likely an experimental artifact
(due to tissue folding or damage) rather than being related to any
tissue structure.</p>
      <fig id="fig4" position="float">
        <label>Figure 4</label>
        <caption>
          <p>Scatter plots of mass shift relative to the reference
peak (<italic>y</italic>-axis) and spectrum index ordered according
to acquisition
time (<italic>y</italic>-axis) before (cyan) and after alignment (orange).
(a–c) Scatters around reference peaks at <italic>m</italic>/<italic>z</italic> 850.80 (PI 36:7), 1403.10 (unknown), and 172.04
(matrix) in the TOF kidney, TOF spheroids, and Orbitrap liver data
sets, respectively.</p>
        </caption>
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0005" id="gr4" position="float"/>
      </fig>
      <fig id="fig5" position="float">
        <label>Figure 5</label>
        <caption>
          <p>Mass shift and TIC images
from the Orbitrap liver and TOF kidney
data sets. Left: the mass shift (a) of the matrix peak at 172.04 <italic>m</italic>/<italic>z</italic> in the Orbitrap data set is correlated
to TIC (c). Right: the mass shift (b) of the lipid peak (PI 38:2)
in the TOF kidney data set appears to be related to tissue structures
rather than to TIC (d) or acquisition time.</p>
        </caption>
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0006" id="gr5" position="float"/>
      </fig>
      <p>The mass dispersion of some identified compounds and matrix peaks
in the Orbitrap liver and TOF kidney data sets are shown in <xref rid="tbl3" ref-type="other">Tables <xref rid="tbl3" ref-type="other">3</xref></xref> and <xref rid="tbl4" ref-type="other">4</xref>, respectively. The monoisotopic peak of the phosphatidylcholine
head group (184.07 <italic>m</italic>/<italic>z</italic>) in the Orbitrap
data set has a notably lower dispersion after alignment (0.036 ppm)
than those of the other compounds (0.086–0.435 ppm). The intensity
of this peak is several orders of magnitude larger than that of all
other peaks. As a consequence, it dominates the similarity score and
effectively acts as a lock mass for the warping function. Importantly,
this does not appear to increase dispersion for lower intensity peaks
close in <italic>m</italic>/<italic>z</italic>; the matrix peaks at
172.04 and 190.05 <italic>m</italic>/<italic>z</italic> contribute
insignificantly to the similarity score in comparison, but still have
lower dispersion than most other peaks after alignment. This suggests
that the shift in low-intensity peaks can be estimated accurately
with the shift of nearby high-intensity peaks. In the TOF kidney data
set, dispersion is reduced consistently by more than 80 percent, except
for the peak at <italic>m</italic>/<italic>z</italic> 919.90 (PI 40:1),
whose dispersion remains relatively high after alignment (32.69 ppm).
By looking at the mass scatter of this peak, however, it is evident
that it has been mixed with another peak in the same mass bin and
that this causes the relatively high dispersion after alignment (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figure S5</ext-link>, Supporting Information).</p>
      <table-wrap id="tbl3" position="float">
        <label>Table 3</label>
        <caption>
          <title>Mass Dispersion (ppm) of Five Matrix
(α-Cyano-4-hydroxycinnamic Acid) Peaks, the Monoisotopic Peak
of Two Spiked-In Compounds, and the Peak of Phosphocholine before
(Raw) and after Alignment (Warped) in the Orbitrap Liver Data Set</title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center">compound</th>
              <th style="border:none;" align="center" char="."><italic>m</italic>/<italic>z</italic></th>
              <th style="border:none;" align="center" char=".">disp. raw
(ppm)</th>
              <th style="border:none;" align="center" char=".">disp. warped
(ppm)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">[M – H<sub>2</sub>O + H]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">172.039</td>
              <td style="border:none;" align="char" char=".">0.644</td>
              <td style="border:none;" align="char" char=".">0.159</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[M + H]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">190.050</td>
              <td style="border:none;" align="char" char=".">0.743</td>
              <td style="border:none;" align="char" char=".">0.086</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[M + Na]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">212.032</td>
              <td style="border:none;" align="char" char=".">0.724</td>
              <td style="border:none;" align="char" char=".">0.222</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[M – H + 2Na]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">234.014</td>
              <td style="border:none;" align="char" char=".">0.998</td>
              <td style="border:none;" align="char" char=".">0.435</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[2M + H]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">379.092</td>
              <td style="border:none;" align="char" char=".">0.699</td>
              <td style="border:none;" align="char" char=".">0.343</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">phosphocholine</td>
              <td style="border:none;" align="char" char=".">184.073</td>
              <td style="border:none;" align="char" char=".">0.706</td>
              <td style="border:none;" align="char" char=".">0.036</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">ipratropium</td>
              <td style="border:none;" align="char" char=".">332.222</td>
              <td style="border:none;" align="char" char=".">0.675</td>
              <td style="border:none;" align="char" char=".">0.271</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">dasatinib</td>
              <td style="border:none;" align="char" char=".">488.164</td>
              <td style="border:none;" align="char" char=".">0.475</td>
              <td style="border:none;" align="char" char=".">0.364</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
      <table-wrap id="tbl4" position="float">
        <label>Table 4</label>
        <caption>
          <title>Mass Dispersion (ppm) of Some Identified
Lipid Peaks before (Raw) and after Alignment (Warped) in the TOF Kidney
Data Set<xref rid="t4fn1" ref-type="table-fn">a</xref></title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center">compound</th>
              <th style="border:none;" align="center" char="."><italic>m</italic>/<italic>z</italic></th>
              <th style="border:none;" align="center" char=".">disp. raw
(ppm)</th>
              <th style="border:none;" align="center" char=".">disp. warped
(ppm)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">LPS 18:0</td>
              <td style="border:none;" align="char" char=".">524.19</td>
              <td style="border:none;" align="char" char=".">126.83</td>
              <td style="border:none;" align="char" char=".">15.24</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PA 34:1</td>
              <td style="border:none;" align="char" char=".">673.68</td>
              <td style="border:none;" align="char" char=".">128.19</td>
              <td style="border:none;" align="char" char=".">24.99</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PA 36:1</td>
              <td style="border:none;" align="char" char=".">701.76</td>
              <td style="border:none;" align="char" char=".">123.15</td>
              <td style="border:none;" align="char" char=".">16.80</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PS 36:3</td>
              <td style="border:none;" align="char" char=".">784.38</td>
              <td style="border:none;" align="char" char=".">118.82</td>
              <td style="border:none;" align="char" char=".">16.13</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PI 36:7</td>
              <td style="border:none;" align="char" char=".">850.80</td>
              <td style="border:none;" align="char" char=".">103.38</td>
              <td style="border:none;" align="char" char=".">5.70</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PS 42:5</td>
              <td style="border:none;" align="char" char=".">864.82</td>
              <td style="border:none;" align="char" char=".">105.18</td>
              <td style="border:none;" align="char" char=".">7.23</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PI 40:6</td>
              <td style="border:none;" align="char" char=".">907.87</td>
              <td style="border:none;" align="char" char=".">103.49</td>
              <td style="border:none;" align="char" char=".">6.51</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PI 40:1</td>
              <td style="border:none;" align="char" char=".">919.90</td>
              <td style="border:none;" align="char" char=".">87.83</td>
              <td style="border:none;" align="char" char=".">32.69</td>
            </tr>
          </tbody>
        </table>
        <table-wrap-foot>
          <fn id="t4fn1">
            <label>a</label>
            <p>All lipids are represented as [M
– H]<sup>−</sup> ions.</p>
          </fn>
        </table-wrap-foot>
      </table-wrap>
      <p>An interesting example of the utility of MSIWarp is
shown in <xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>.
Like the mass bin
at 919.90 <italic>m</italic>/<italic>z</italic>, other mass bins in
the TOF kidney data set contain mixed peaks as well, including that
of the unidentified reference peak at 904.90 <italic>m</italic>/<italic>z</italic>. Before alignment, the two peaks in this bin are indistinguishable,
but after alignment, the peaks are separated sufficiently to enable
us to generate a distinct ion image for each. The distribution of
peak mass within the bin is considerably narrower after alignment
(<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>b). Crucially,
the density curve of the warped peak masses reveals, albeit just barely,
the second peak as distinct from the first one. By re-binning the
spectra with two tighter windows (±10 ppm), whose respective
centers are at the main and shoulder peaks of the density estimate,
two distinct ion images can be generated (<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>d,<xref rid="fig6" ref-type="fig">6</xref>e) instead of one
in which the two compounds are mixed (<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>c). Despite the low mass resolution of the
TOF kidney data (the FWHM is approximately 380 ppm), these two peaks,
which are 25 ppm apart, can still be separated by looking at the mass
locations of their centroids. Note that while we separate them on
a data set level, we do not separate them in a single spectrum; when
the compounds corresponding to the peaks are present in the same spectrum,
i.e., tissue spot, the peak of the more intensive compound masks that
of the other. This is evident in the ion images of the two peaks (<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>d,<xref rid="fig6" ref-type="fig">6</xref>e): only the more intense peak (904.878 <italic>m</italic>/<italic>z</italic>) is visible in the pixels where the two peaks
overlap.</p>
      <fig id="fig6" position="float">
        <label>Figure 6</label>
        <caption>
          <p>Mass bin from the TOF kidney data set exemplifies how severe misalignment
leads to mixed ion images. The scatter of peak mass and acquisition
time in (a) reveals two peaks after alignment (orange) that are indistinguishable
before alignment (cyan). Alignment similarly reveals the two peaks
in the density estimate of peak mass within the bin (b): before alignment
(raw), the variation in peak mass across the spectra is too large
to separate the two peaks, but after alignment (warped), the peaks
appear as the main and shoulder peaks of the density curve. The left
ion image (c) was generated from the raw (unaligned) spectra with
a wide bin window (±200 ppm), while the center (d) and right
(e) ion images were generated by binning the warped spectra with a
narrow window (±10 ppm) around 904.855 and 904.878 <italic>m</italic>/<italic>z</italic>, respectively. The median mass of the two peaks
and the narrow windows are marked in the zoom-in on the density curve
in (b). The ion images in (c)–(e) were generated by summing
peak intensities in the bin for each spectrum/pixel.</p>
        </caption>
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0007" id="gr6" position="float"/>
      </fig>
    </sec>
    <sec id="sec4.2">
      <title>Implementation and Processing Time</title>
      <p>Although our method
involves repeating the similarity score computation for a large number
of candidate warpings to align a single spectrum, we keep the processing
time for a whole data set low by implementing the core part of MSIWarp
in efficient C++. Aligning the TOF kidney data set, consisting of
33 242 spectra with 244 peaks on average, took approximately
150 s when MSIWarp was run without RANSAC and in parallel mode on
a laptop with an Intel i7-6700HQ CPU (2.6 GHz) and 16 GB RAM. Aligning
the Orbitrap liver data set with the same settings took approximately
300 s. The parameter that has the largest impact on processing time
is the number of steps by which the warping nodes are shifted when
searching for the optimal warping. Given that the slack has been set
to capture the mass shift for all spectra, the number of steps corresponds
to the resolution of the warping function. We found that a step size
of 0.05–0.10 times the peak FWHM gives a sufficient alignment
resolution. If the search space of the warping function is ±2
FWHM, this results in 40–80 steps for each warping node. The
source code of MSIWarp along with Python bindings are available at <uri xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://github.com/horvatovichlab/MSIWarp">https://github.com/horvatovichlab/MSIWarp</uri>. Our goal is to make it possible to interface MSIWarp with existing
MSI analysis packages such as MALDIquant,<sup><xref ref-type="bibr" rid="ref27">27</xref></sup> Cardinal,<sup><xref ref-type="bibr" rid="ref28">28</xref></sup> and rMSIproc.<sup><xref ref-type="bibr" rid="ref29">29</xref></sup></p>
    </sec>
  </sec>
  <sec id="sec5">
    <title>Conclusions</title>
    <p>We have presented an
approach, MSIWarp, that readily improves relative
alignment in both TOF and Orbitrap data sets that together represent
a large variety of MSI experimental setups. Even the severe misalignment
in the TOF kidney data set is brought down to a level that enables
separation of peaks close in <italic>m</italic>/<italic>z</italic>. With a median mass dispersion of 6.48 ppm (and below 5 ppm for
more than half of the peaks) in the TOF spheroid data set, MSIWarp
matches the alignment performance of methods that rely on profile
spectra using only centroided spectra. While the largest improvements
in relative mass alignment can be gained for TOF spectra, our results
suggest that MSIWarp can further improve the already high mass alignment
in Orbitrap data sets. By investigating the effect of spurious peak
matches with RANSAC, we have also shown that MSIWarp is robust and
performs well even for most peak-sparse spectra. Finally, we believe
that a careful assessment of mass alignment is critical when analyzing
MSI data sets. Tools such as scatter plots of peak mass and acquisition
time, scatter plots of mass shift between individual pairs of spectra,
and images of mass shift as a function of tissue location for individual
peaks provide a way to do this in a simple manner.</p>
    <p>Although
MSIWarp has demonstrated significant benefits in analyzing
MSI data sets, there are several research paths that could yield additional
improvements. Currently, the output of MSIWarp is an <italic>m</italic>/<italic>z</italic> recalibration function for each data set spectrum.
It is important to highlight that even though this function is found
by searching for the optimal alignment between a pair of centroided
spectra, it can also be used to align the corresponding profile spectra.
Conceptually, the recalibration function could also be found by directly
computing the correlation integral between the profile spectra, if
available, instead of using our analytical expression based on the
overlap of centroided peaks. This would allow MSIWarp to utilize subtle
features in the profile data, such as peak shape, that may be lost
in the peak-picking step. Another possible enhancement is to create
a hybrid approach by combining MSIWarp with existing calibration strategies
to improve absolute mass accuracy in addition to relative mass alignment.
To do this, a spectrum with accurate masses should be used as a reference,
and if no such spectrum is available, the reference spectrum can be
chosen based on other criteria and calibrated prior to alignment.
Together, these approaches represent a rich area of research that
would allow interesting comparisons of related techniques and potential
for even further improvements in performance.</p>
  </sec>
</body>
<back>
  <notes id="notes-1" notes-type="si">
    <title>Supporting Information Available</title>
    <p>The Supporting Information
is available free of charge at <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="https://pubs.acs.org/doi/10.1021/acs.analchem.0c03833?goto=supporting-info">https://pubs.acs.org/doi/10.1021/acs.analchem.0c03833</ext-link>.<list id="silist" list-type="simple"><list-item><p>Description of the TOF
kidney, TOF spheroids, Orbitrap
liver, and Orbitrap DESI data sets. Tables S1 and S2, median mass
dispersions of mean spectrum peaks from the TOF kidney and Orbitrap
liver data sets after alignment with various values of σ and
ϵ. Figure S1, TIC images for the four MSI data sets. Figure
S2, RANSAC outlier detection results for three example spectra from
the TOF kidney data set. Figures S3–S13, scatter plots of peak
mass and acquisition time for mean spectrum peaks from the top 100,
50, 100, and 100 mean spectrum peaks’ TOF kidney, TOF spheroids,
Orbitrap liver and Orbitrap DESI data sets (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">PDF</ext-link>)</p></list-item><list-item><p>Ransac outlier detection animation
(<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_002.zip">ZIP</ext-link>)</p></list-item><list-item><p>Mean
spectrum dispersions (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_003.xlsx">XLSX</ext-link>)</p></list-item></list></p>
  </notes>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="sifile1">
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_si_001.pdf">
        <caption>
          <p>ac0c03833_si_001.pdf</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sifile2">
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_si_002.zip">
        <caption>
          <p>ac0c03833_si_002.zip</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sifile3">
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_si_003.xlsx">
        <caption>
          <p>ac0c03833_si_003.xlsx</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
  <notes notes-type="COI-statement" id="NOTES-d7e2460-autogenerated">
    <p>The
authors declare no
competing financial interest.</p>
  </notes>
  <ack>
    <title>Acknowledgments</title>
    <p>We acknowledge the support from Fru Berta Kamprads Stiftelse.
This research was part of the Netherlands X-omics Initiative and partially
funded by NWO, project 184.034.019. We also thank the reviewers for
their valuable feedback.</p>
  </ack>
  <ref-list>
    <title>References</title>
    <ref id="ref1">
      <mixed-citation publication-type="journal" id="cit1"><name><surname>Buchberger</surname><given-names>A. R.</given-names></name>; <name><surname>DeLaney</surname><given-names>K.</given-names></name>; <name><surname>Johnson</surname><given-names>J.</given-names></name>; <name><surname>Li</surname><given-names>L.</given-names></name><article-title>Mass spectrometry imaging:
a review of emerging advancements and future insights</article-title>. <source>Anal. Chem.</source><year>2018</year>, <volume>90</volume>, <fpage>240</fpage>–<lpage>265</lpage>. <pub-id pub-id-type="doi">10.1021/acs.analchem.7b04733</pub-id>.<pub-id pub-id-type="pmid">29155564</pub-id></mixed-citation>
    </ref>
    <ref id="ref2">
      <mixed-citation publication-type="journal" id="cit2"><name><surname>Gilmore</surname><given-names>I. S.</given-names></name>; <name><surname>Heiles</surname><given-names>S.</given-names></name>; <name><surname>Pieterse</surname><given-names>C. L.</given-names></name><article-title>Metabolic
imaging at the single-cell
scale: recent advances in mass spectrometry imaging</article-title>. <source>Annu. Rev. Anal. Chem.</source><year>2019</year>, <volume>12</volume>, <fpage>201</fpage>–<lpage>224</lpage>. <pub-id pub-id-type="doi">10.1146/annurev-anchem-061318-115516</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref3">
      <mixed-citation publication-type="journal" id="cit3"><name><surname>Han</surname><given-names>J.</given-names></name>; <name><surname>Permentier</surname><given-names>H.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Groothuis</surname><given-names>G.</given-names></name>; <name><surname>Casini</surname><given-names>A.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Imaging of
protein distribution in
tissues using mass spectrometry: An interdisciplinary challenge</article-title>. <source>TrAC, Trends Anal. Chem.</source><year>2019</year>, <volume>112</volume>, <fpage>13</fpage>–<lpage>28</lpage>. <pub-id pub-id-type="doi">10.1016/j.trac.2018.12.016</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref4">
      <mixed-citation publication-type="journal" id="cit4"><name><surname>Ryan</surname><given-names>D. J.</given-names></name>; <name><surname>Spraggins</surname><given-names>J. M.</given-names></name>; <name><surname>Caprioli</surname><given-names>R. M.</given-names></name><article-title>Protein identification
strategies
in MALDI imaging mass spectrometry: a brief review</article-title>. <source>Curr. Opin. Chem. Biol.</source><year>2019</year>, <volume>48</volume>, <fpage>64</fpage>–<lpage>72</lpage>. <pub-id pub-id-type="doi">10.1016/j.cbpa.2018.10.023</pub-id>.<pub-id pub-id-type="pmid">30476689</pub-id></mixed-citation>
    </ref>
    <ref id="ref5">
      <mixed-citation publication-type="journal" id="cit5"><name><surname>Verbeeck</surname><given-names>N.</given-names></name>; <name><surname>Caprioli</surname><given-names>R. M.</given-names></name>; <name><surname>Van de
Plas</surname><given-names>R.</given-names></name><article-title>Unsupervised machine learning for
exploratory data analysis in imaging mass spectrometry</article-title>. <source>Mass Spectrom. Rev.</source><year>2020</year>, <volume>39</volume>, <fpage>245</fpage>–<lpage>291</lpage>. <pub-id pub-id-type="doi">10.1002/mas.21602</pub-id>.<pub-id pub-id-type="pmid">31602691</pub-id></mixed-citation>
    </ref>
    <ref id="ref6">
      <mixed-citation publication-type="journal" id="cit6"><name><surname>Ràfols</surname><given-names>P.</given-names></name>; <name><surname>del Castillo</surname><given-names>E.</given-names></name>; <name><surname>Yanes</surname><given-names>O.</given-names></name>; <name><surname>Brezmes</surname><given-names>J.</given-names></name>; <name><surname>Correig</surname><given-names>X.</given-names></name><article-title>Novel automated
workflow for spectral alignment and mass calibration in MS imaging
using a sputtered Ag nanolayer</article-title>. <source>Anal. Chim.
Acta</source><year>2018</year>, <volume>1022</volume>, <fpage>61</fpage>–<lpage>69</lpage>. <pub-id pub-id-type="doi">10.1016/j.aca.2018.03.031</pub-id>.<pub-id pub-id-type="pmid">29729739</pub-id></mixed-citation>
    </ref>
    <ref id="ref7">
      <mixed-citation publication-type="journal" id="cit7"><name><surname>Gorshkov</surname><given-names>M. V.</given-names></name>; <name><surname>Good</surname><given-names>D. M.</given-names></name>; <name><surname>Lyutvinskiy</surname><given-names>Y.</given-names></name>; <name><surname>Yang</surname><given-names>H.</given-names></name>; <name><surname>Zubarev</surname><given-names>R. A.</given-names></name><article-title>Calibration
function for the Orbitrap FTMS accounting for the space charge effect</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2010</year>, <volume>21</volume>, <fpage>1846</fpage>–<lpage>1851</lpage>. <pub-id pub-id-type="doi">10.1016/j.jasms.2010.06.021</pub-id>.<pub-id pub-id-type="pmid">20696596</pub-id></mixed-citation>
    </ref>
    <ref id="ref8">
      <mixed-citation publication-type="journal" id="cit8"><name><surname>Kharchenko</surname><given-names>A.</given-names></name>; <name><surname>Vladimirov</surname><given-names>G.</given-names></name>; <name><surname>Heeren</surname><given-names>R. M.</given-names></name>; <name><surname>Nikolaev</surname><given-names>E. N.</given-names></name><article-title>Performance
of Orbitrap
mass analyzer at various space charge and non-ideal field conditions:
simulation approach</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2012</year>, <volume>23</volume>, <fpage>977</fpage>–<lpage>987</lpage>. <pub-id pub-id-type="doi">10.1007/s13361-011-0325-3</pub-id>.<pub-id pub-id-type="pmid">22354683</pub-id></mixed-citation>
    </ref>
    <ref id="ref9">
      <mixed-citation publication-type="journal" id="cit9"><name><surname>Boskamp</surname><given-names>T.</given-names></name>; <name><surname>Lachmund</surname><given-names>D.</given-names></name>; <name><surname>Casadonte</surname><given-names>R.</given-names></name>; <name><surname>Hauberg-Lotte</surname><given-names>L.</given-names></name>; <name><surname>Kobarg</surname><given-names>J. H.</given-names></name>; <name><surname>Kriegsmann</surname><given-names>J.</given-names></name>; <name><surname>Maass</surname><given-names>P.</given-names></name><article-title>Using the chemical
noise background in MALDI mass spectrometry imaging for mass alignment
and calibration</article-title>. <source>Anal. Chem.</source><year>2020</year>, <fpage>1301</fpage><pub-id pub-id-type="doi">10.1021/acs.analchem.9b04473</pub-id>.<pub-id pub-id-type="pmid">31793765</pub-id></mixed-citation>
    </ref>
    <ref id="ref10">
      <mixed-citation publication-type="journal" id="cit10"><name><surname>Bocker</surname><given-names>S.</given-names></name>; <name><surname>Makinen</surname><given-names>V.</given-names></name><article-title>Combinatorial approaches
for mass spectra recalibration</article-title>. <source>IEEE/ACM Trans.
Comput. Biol. Bioinf.</source><year>2008</year>, <volume>5</volume>, <fpage>91</fpage>–<lpage>100</lpage>. <pub-id pub-id-type="doi">10.1109/tcbb.2007.1077</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref11">
      <mixed-citation publication-type="journal" id="cit11"><name><surname>Kulkarni</surname><given-names>P.</given-names></name>; <name><surname>Kaftan</surname><given-names>F.</given-names></name>; <name><surname>Kynast</surname><given-names>P.</given-names></name>; <name><surname>Svatoš</surname><given-names>A.</given-names></name>; <name><surname>Böcker</surname><given-names>S.</given-names></name><article-title>Correcting mass shifts: a lock mass-free
recalibration
procedure for mass spectrometry imaging data</article-title>. <source>Anal. Bioanal. Chem.</source><year>2015</year>, <volume>407</volume>, <fpage>7603</fpage>–<lpage>7613</lpage>. <pub-id pub-id-type="doi">10.1007/s00216-015-8935-4</pub-id>.<pub-id pub-id-type="pmid">26345438</pub-id></mixed-citation>
    </ref>
    <ref id="ref12">
      <mixed-citation publication-type="journal" id="cit12"><name><surname>Tracy</surname><given-names>M. B.</given-names></name>; <name><surname>Chen</surname><given-names>H.</given-names></name>; <name><surname>Weaver</surname><given-names>D. M.</given-names></name>; <name><surname>Malyarenko</surname><given-names>D. I.</given-names></name>; <name><surname>Sasinowski</surname><given-names>M.</given-names></name>; <name><surname>Cazares</surname><given-names>L. H.</given-names></name>; <name><surname>Drake</surname><given-names>R. R.</given-names></name>; <name><surname>Semmes</surname><given-names>O. J.</given-names></name>; <name><surname>Tracy</surname><given-names>E. R.</given-names></name>; <name><surname>Cooke</surname><given-names>W. E.</given-names></name><article-title>Precision enhancement of MALDI-TOF
MS using high resolution peak detection and label-free alignment</article-title>. <source>Proteomics</source><year>2008</year>, <volume>8</volume>, <fpage>1530</fpage>–<lpage>1538</lpage>. <pub-id pub-id-type="doi">10.1002/pmic.200701146</pub-id>.<pub-id pub-id-type="pmid">18340636</pub-id></mixed-citation>
    </ref>
    <ref id="ref13">
      <mixed-citation publication-type="journal" id="cit13"><name><surname>Barry</surname><given-names>J. A.</given-names></name>; <name><surname>Robichaud</surname><given-names>G.</given-names></name>; <name><surname>Muddiman</surname><given-names>D. C.</given-names></name><article-title>Mass recalibration of FT-ICR mass
spectrometry imaging data using the average frequency shift of ambient
ions</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2013</year>, <volume>24</volume>, <fpage>1137</fpage>–<lpage>1145</lpage>. <pub-id pub-id-type="doi">10.1007/s13361-013-0659-0</pub-id>.<pub-id pub-id-type="pmid">23715870</pub-id></mixed-citation>
    </ref>
    <ref id="ref14">
      <mixed-citation publication-type="journal" id="cit14"><name><surname>Alexandrov</surname><given-names>T.</given-names></name><article-title>Spatial Metabolomics
and Imaging Mass Spectrometry in the Age of Artificial Intelligence</article-title>. <source>Annu. Rev. Biomed. Data Sci.</source><year>2020</year>, <volume>3</volume>, <fpage>61</fpage><pub-id pub-id-type="doi">10.1146/annurev-biodatasci-011420-031537</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref15">
      <mixed-citation publication-type="journal" id="cit15"><name><surname>Haug</surname><given-names>K.</given-names></name>; <name><surname>Salek</surname><given-names>R. M.</given-names></name>; <name><surname>Conesa</surname><given-names>P.</given-names></name>; <name><surname>Hastings</surname><given-names>J.</given-names></name>; <name><surname>De Matos</surname><given-names>P.</given-names></name>; <name><surname>Rijnbeek</surname><given-names>M.</given-names></name>; <name><surname>Mahendraker</surname><given-names>T.</given-names></name>; <name><surname>Williams</surname><given-names>M.</given-names></name>; <name><surname>Neumann</surname><given-names>S.</given-names></name>; <name><surname>Rocca-Serra</surname><given-names>P.</given-names></name>; et al. <article-title>MetaboLights–an open-access general-purpose
repository for metabolomics studies and associated meta-data</article-title>. <source>Nucleic Acids Res.</source><year>2013</year>, <volume>41</volume>, <fpage>D781</fpage>–<lpage>D786</lpage>. <pub-id pub-id-type="doi">10.1093/nar/gks1004</pub-id>.<pub-id pub-id-type="pmid">23109552</pub-id></mixed-citation>
    </ref>
    <ref id="ref16">
      <mixed-citation publication-type="journal" id="cit16"><name><surname>Alexandrov</surname><given-names>T.</given-names></name>; <name><surname>Ovchnnikova</surname><given-names>K.</given-names></name>; <name><surname>Palmer</surname><given-names>A.</given-names></name>; <name><surname>Kovalev</surname><given-names>V.</given-names></name>; <name><surname>Tarasov</surname><given-names>A.</given-names></name>; <name><surname>Stuart</surname><given-names>L.</given-names></name>; <name><surname>Nigmetzianov</surname><given-names>R.</given-names></name>; <name><surname>Fay</surname><given-names>D.</given-names></name>; <name><surname>Contributors</surname><given-names>K. M.</given-names></name><article-title>METASPACE:
A community-populated knowledge base of spatial metabolomes in health
and disease</article-title>. <source>BioRxiv</source><year>2019</year>, <elocation-id>539478</elocation-id><pub-id pub-id-type="doi">10.1101/539478</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref17">
      <mixed-citation publication-type="journal" id="cit17"><name><surname>Nielsen</surname><given-names>N.-P. V.</given-names></name>; <name><surname>Carstensen</surname><given-names>J. M.</given-names></name>; <name><surname>Smedsgaard</surname><given-names>J.</given-names></name><article-title>Aligning of
single and multiple wavelength chromatographic profiles for chemometric
data analysis using correlation optimised warping</article-title>. <source>J. Chromatogr. A</source><year>1998</year>, <volume>805</volume>, <fpage>17</fpage>–<lpage>35</lpage>. <pub-id pub-id-type="doi">10.1016/S0021-9673(98)00021-1</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref18">
      <mixed-citation publication-type="journal" id="cit18"><name><surname>Christin</surname><given-names>C.</given-names></name>; <name><surname>Smilde</surname><given-names>A. K.</given-names></name>; <name><surname>Hoefsloot</surname><given-names>H. C.</given-names></name>; <name><surname>Suits</surname><given-names>F.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P. L.</given-names></name><article-title>Optimized
time alignment algorithm for LC-MS data:
correlation optimized warping using component detection algorithm-selected
mass chromatograms</article-title>. <source>Anal. Chem.</source><year>2008</year>, <volume>80</volume>, <fpage>7012</fpage>–<lpage>7021</lpage>. <pub-id pub-id-type="doi">10.1021/ac800920h</pub-id>.<pub-id pub-id-type="pmid">18715018</pub-id></mixed-citation>
    </ref>
    <ref id="ref19">
      <mixed-citation publication-type="journal" id="cit19"><name><surname>Suits</surname><given-names>F.</given-names></name>; <name><surname>Lepre</surname><given-names>J.</given-names></name>; <name><surname>Du</surname><given-names>P.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Two-Dimensional
Method for Time Aligning Liquid Chromatography- Mass Spectrometry
Data</article-title>. <source>Anal. Chem.</source><year>2008</year>, <volume>80</volume>, <fpage>3095</fpage>–<lpage>3104</lpage>. <pub-id pub-id-type="doi">10.1021/ac702267h</pub-id>.<pub-id pub-id-type="pmid">18396914</pub-id></mixed-citation>
    </ref>
    <ref id="ref20">
      <mixed-citation publication-type="journal" id="cit20"><name><surname>Fischler</surname><given-names>M. A.</given-names></name>; <name><surname>Bolles</surname><given-names>R. C.</given-names></name><article-title>Random sample consensus: a paradigm for model fitting
with applications to image analysis and automated cartography</article-title>. <source>Commun. ACM</source><year>1981</year>, <volume>24</volume>, <fpage>381</fpage>–<lpage>395</lpage>. <pub-id pub-id-type="doi">10.1145/358669.358692</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref21">
      <mixed-citation publication-type="journal" id="cit21"><name><surname>Suits</surname><given-names>F.</given-names></name>; <name><surname>Hoekman</surname><given-names>B.</given-names></name>; <name><surname>Rosenling</surname><given-names>T.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Threshold-avoiding
proteomics pipeline</article-title>. <source>Anal. Chem.</source><year>2011</year>, <volume>83</volume>, <fpage>7786</fpage>–<lpage>7794</lpage>. <pub-id pub-id-type="doi">10.1021/ac201332j</pub-id>.<pub-id pub-id-type="pmid">21879761</pub-id></mixed-citation>
    </ref>
    <ref id="ref22">
      <mixed-citation publication-type="journal" id="cit22"><name><surname>Noh</surname><given-names>S. A.</given-names></name>; <name><surname>Kim</surname><given-names>S.-M.</given-names></name>; <name><surname>Park</surname><given-names>S. H.</given-names></name>; <name><surname>Kim</surname><given-names>D.-J.</given-names></name>; <name><surname>Lee</surname><given-names>J. W.</given-names></name>; <name><surname>Kim</surname><given-names>Y. G.</given-names></name>; <name><surname>Moon</surname><given-names>J.-Y.</given-names></name>; <name><surname>Lim</surname><given-names>S.-J.</given-names></name>; <name><surname>Lee</surname><given-names>S.-H.</given-names></name>; <name><surname>Kim</surname><given-names>K. P.</given-names></name><article-title>Alterations in Lipid Profile of the Aging Kidney Identified
by MALDI Imaging Mass Spectrometry</article-title>. <source>J. Proteome
Res.</source><year>2019</year>, <volume>18</volume>, <fpage>2803</fpage>–<lpage>2812</lpage>. <pub-id pub-id-type="doi">10.1021/acs.jproteome.9b00108</pub-id>.<pub-id pub-id-type="pmid">31244212</pub-id></mixed-citation>
    </ref>
    <ref id="ref23">
      <mixed-citation publication-type="journal" id="cit23"><name><surname>Mittal</surname><given-names>P.</given-names></name>; <name><surname>Price</surname><given-names>Z. K.</given-names></name>; <name><surname>Lokman</surname><given-names>N. A.</given-names></name>; <name><surname>Ricciardelli</surname><given-names>C.</given-names></name>; <name><surname>Oehler</surname><given-names>M. K.</given-names></name>; <name><surname>Klingler-Hoffmann</surname><given-names>M.</given-names></name>; <name><surname>Hoffmann</surname><given-names>P.</given-names></name><article-title>Matrix Assisted Laser
Desorption/Ionization Mass Spectrometry Imaging (MALDI MSI) for Monitoring
of Drug Response in Primary Cancer Spheroids</article-title>. <source>Proteomics</source><year>2019</year>, <volume>19</volume>, <elocation-id>1900146</elocation-id><pub-id pub-id-type="doi">10.1002/pmic.201900146</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref24">
      <mixed-citation publication-type="journal" id="cit24"><name><surname>Eriksson</surname><given-names>J. O.</given-names></name>; <name><surname>Rezeli</surname><given-names>M.</given-names></name>; <name><surname>Hefner</surname><given-names>M.</given-names></name>; <name><surname>Marko-Varga</surname><given-names>G.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Clusterwise peak detection and filtering
based on spatial
distribution to efficiently mine mass spectrometry imaging data</article-title>. <source>Anal. Chem.</source><year>2019</year>, <volume>91</volume>, <fpage>11888</fpage>–<lpage>11896</lpage>. <pub-id pub-id-type="doi">10.1021/acs.analchem.9b02637</pub-id>.<pub-id pub-id-type="pmid">31403280</pub-id></mixed-citation>
    </ref>
    <ref id="ref25">
      <mixed-citation publication-type="journal" id="cit25"><name><surname>Gerbig</surname><given-names>S.</given-names></name>; <name><surname>Golf</surname><given-names>O.</given-names></name>; <name><surname>Balog</surname><given-names>J.</given-names></name>; <name><surname>Denes</surname><given-names>J.</given-names></name>; <name><surname>Baranyai</surname><given-names>Z.</given-names></name>; <name><surname>Zarand</surname><given-names>A.</given-names></name>; <name><surname>Raso</surname><given-names>E.</given-names></name>; <name><surname>Timar</surname><given-names>J.</given-names></name>; <name><surname>Takats</surname><given-names>Z.</given-names></name><article-title>Analysis of
colorectal adenocarcinoma tissue by desorption electrospray ionization
mass spectrometric imaging</article-title>. <source>Anal. Bioanal. Chem.</source><year>2012</year>, <volume>403</volume>, <fpage>2315</fpage>–<lpage>2325</lpage>. <pub-id pub-id-type="doi">10.1007/s00216-012-5841-x</pub-id>.<pub-id pub-id-type="pmid">22447214</pub-id></mixed-citation>
    </ref>
    <ref id="ref26">
      <mixed-citation publication-type="journal" id="cit26"><name><surname>Robichaud</surname><given-names>G.</given-names></name>; <name><surname>Garrard</surname><given-names>K. P.</given-names></name>; <name><surname>Barry</surname><given-names>J. A.</given-names></name>; <name><surname>Muddiman</surname><given-names>D. C.</given-names></name><article-title>MSiReader: an open-source
interface to view and analyze high resolving power MS imaging files
on Matlab platform</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2013</year>, <volume>24</volume>, <fpage>718</fpage>–<lpage>721</lpage>. <pub-id pub-id-type="doi">10.1007/s13361-013-0607-z</pub-id>.<pub-id pub-id-type="pmid">23536269</pub-id></mixed-citation>
    </ref>
    <ref id="ref27">
      <mixed-citation publication-type="journal" id="cit27"><name><surname>Gibb</surname><given-names>S.</given-names></name>; <name><surname>Strimmer</surname><given-names>K.</given-names></name><article-title>MALDIquant: a versatile
R package for the analysis
of mass spectrometry data</article-title>. <source>Bioinformatics</source><year>2012</year>, <volume>28</volume>, <fpage>2270</fpage>–<lpage>2271</lpage>. <pub-id pub-id-type="doi">10.1093/bioinformatics/bts447</pub-id>.<pub-id pub-id-type="pmid">22796955</pub-id></mixed-citation>
    </ref>
    <ref id="ref28">
      <mixed-citation publication-type="journal" id="cit28"><name><surname>Bemis</surname><given-names>K. D.</given-names></name>; <name><surname>Harry</surname><given-names>A.</given-names></name>; <name><surname>Eberlin</surname><given-names>L. S.</given-names></name>; <name><surname>Ferreira</surname><given-names>C.</given-names></name>; <name><surname>van de Ven</surname><given-names>S. M.</given-names></name>; <name><surname>Mallick</surname><given-names>P.</given-names></name>; <name><surname>Stolowitz</surname><given-names>M.</given-names></name>; <name><surname>Vitek</surname><given-names>O.</given-names></name><article-title>Cardinal: an R package
for statistical analysis of mass spectrometry-based imaging experiments</article-title>. <source>Bioinformatics</source><year>2015</year>, <volume>31</volume>, <fpage>2418</fpage>–<lpage>2420</lpage>. <pub-id pub-id-type="doi">10.1093/bioinformatics/btv146</pub-id>.<pub-id pub-id-type="pmid">25777525</pub-id></mixed-citation>
    </ref>
    <ref id="ref29">
      <mixed-citation publication-type="journal" id="cit29"><name><surname>Ràfols</surname><given-names>P.</given-names></name>; <name><surname>Heijs</surname><given-names>B.</given-names></name>; <name><surname>del Castillo</surname><given-names>E.</given-names></name>; <name><surname>Yanes</surname><given-names>O.</given-names></name>; <name><surname>McDonnell</surname><given-names>L. A.</given-names></name>; <name><surname>Brezmes</surname><given-names>J.</given-names></name>; <name><surname>Pérez-Taboada</surname><given-names>I.</given-names></name>; <name><surname>Vallejo</surname><given-names>M.</given-names></name>; <name><surname>García-Altares</surname><given-names>M.</given-names></name>; <name><surname>Correig</surname><given-names>X.</given-names></name><article-title>rMSIproc: an R package
for mass spectrometry imaging data processing</article-title>. <source>Bioinformatics</source><year>2020</year>, <volume>36</volume>, <fpage>3618</fpage>–<lpage>3619</lpage>. <pub-id pub-id-type="doi">10.1093/bioinformatics/btaa142</pub-id>.<pub-id pub-id-type="pmid">32108859</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//ACS//DTD ACS Journal DTD v1.02 20061031//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName ACSJournal-v102.dtd?>
<?SourceDTD.Version 1.02?>
<?ConverterInfo.XSLTName acs2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Anal Chem</journal-id>
    <journal-id journal-id-type="iso-abbrev">Anal Chem</journal-id>
    <journal-id journal-id-type="publisher-id">ac</journal-id>
    <journal-id journal-id-type="coden">ancham</journal-id>
    <journal-title-group>
      <journal-title>Analytical Chemistry</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">0003-2700</issn>
    <issn pub-type="epub">1520-6882</issn>
    <publisher>
      <publisher-name>American
Chemical
Society</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">7745203</article-id>
    <article-id pub-id-type="pmid">33317272</article-id>
    <article-id pub-id-type="doi">10.1021/acs.analchem.0c03833</article-id>
    <article-categories>
      <subj-group>
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>MSIWarp: A General Approach to Mass Alignment in Mass
Spectrometry Imaging</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" id="ath1">
        <name>
          <surname>Eriksson</surname>
          <given-names>Jonatan
O.</given-names>
        </name>
        <xref rid="aff1" ref-type="aff">†</xref>
      </contrib>
      <contrib contrib-type="author" id="ath2">
        <name>
          <surname>Sánchez Brotons</surname>
          <given-names>Alejandro</given-names>
        </name>
        <xref rid="aff2" ref-type="aff">‡</xref>
      </contrib>
      <contrib contrib-type="author" id="ath3">
        <name>
          <surname>Rezeli</surname>
          <given-names>Melinda</given-names>
        </name>
        <xref rid="aff1" ref-type="aff">†</xref>
      </contrib>
      <contrib contrib-type="author" id="ath4">
        <name>
          <surname>Suits</surname>
          <given-names>Frank</given-names>
        </name>
        <xref rid="aff3" ref-type="aff">§</xref>
      </contrib>
      <contrib contrib-type="author" id="ath5">
        <name>
          <surname>Markó-Varga</surname>
          <given-names>György</given-names>
        </name>
        <xref rid="aff1" ref-type="aff">†</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes" id="ath6">
        <name>
          <surname>Horvatovich</surname>
          <given-names>Peter</given-names>
        </name>
        <xref rid="cor1" ref-type="other">*</xref>
        <xref rid="aff1" ref-type="aff">†</xref>
        <xref rid="aff2" ref-type="aff">‡</xref>
      </contrib>
      <aff id="aff1"><label>†</label>Department
of Biomedical Engineering, <institution>Lund University</institution>, Lund 221 00, <country>Sweden</country></aff>
      <aff id="aff2"><label>‡</label>Department
of Analytical Biochemistry, Groningen Research Institute of Pharmacy, <institution>University of Groningen</institution>, Antonius Deusinglaan 1, 9713 AV Groningen, <country>The Netherlands</country></aff>
      <aff id="aff3"><label>§</label><institution>IBM
Research - Australia</institution>, 60 City Road, Southbank, VIC 3006, <country>Australia</country></aff>
    </contrib-group>
    <author-notes>
      <corresp id="cor1"><label>*</label>Email: <email>p.l.horvatovich@rug.nl</email>.</corresp>
    </author-notes>
    <pub-date pub-type="epub">
      <day>02</day>
      <month>12</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <day>15</day>
      <month>12</month>
      <year>2020</year>
    </pub-date>
    <volume>92</volume>
    <issue>24</issue>
    <fpage>16138</fpage>
    <lpage>16148</lpage>
    <history>
      <date date-type="received">
        <day>09</day>
        <month>09</month>
        <year>2020</year>
      </date>
      <date date-type="accepted">
        <day>16</day>
        <month>11</month>
        <year>2020</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© 2020 American Chemical Society</copyright-statement>
      <copyright-year>2020</copyright-year>
      <copyright-holder>American Chemical
Society</copyright-holder>
      <license>
        <license-p>This is an open access article published under a Creative Commons Non-Commercial No Derivative Works (CC-BY-NC-ND) Attribution <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/page/policy/authorchoice_ccbyncnd_termsofuse.html">License</ext-link>, which permits copying and redistribution of the article, and creation of adaptations, all for non-commercial purposes.</license-p>
      </license>
    </permissions>
    <abstract>
      <p content-type="toc-graphic">
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0008" id="ab-tgr1"/>
      </p>
      <p>Mass spectrometry imaging (MSI) is
a technique that provides comprehensive
molecular information with high spatial resolution from tissue. Today,
there is a strong push toward sharing data sets through public repositories
in many research fields where MSI is commonly applied; yet, there
is no standardized protocol for analyzing these data sets in a reproducible
manner. Shifts in the mass-to-charge ratio (<italic>m</italic>/<italic>z</italic>) of molecular peaks present a major obstacle that can
make it impossible to distinguish one compound from another. Here,
we present a label-free <italic>m</italic>/<italic>z</italic> alignment
approach that is compatible with multiple instrument types and makes
no assumptions on the sample’s molecular composition. Our approach,
MSIWarp (<uri xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://github.com/horvatovichlab/MSIWarp">https://github.com/horvatovichlab/MSIWarp</uri>), finds an <italic>m</italic>/<italic>z</italic> recalibration function
by maximizing a similarity score that considers both the intensity
and <italic>m</italic>/<italic>z</italic> position of peaks matched
between two spectra. MSIWarp requires only centroid spectra to find
the recalibration function and is thereby readily applicable to almost
any MSI data set. To deal with particularly misaligned or peak-sparse
spectra, we provide an option to detect and exclude spurious peak
matches with a tailored random sample consensus (RANSAC) procedure.
We evaluate our approach with four publicly available data sets from
both time-of-flight (TOF) and Orbitrap instruments and demonstrate
up to 88% improvement in <italic>m</italic>/<italic>z</italic> alignment.</p>
    </abstract>
    <custom-meta-group>
      <custom-meta>
        <meta-name>document-id-old-9</meta-name>
        <meta-value>ac0c03833</meta-value>
      </custom-meta>
      <custom-meta>
        <meta-name>document-id-new-14</meta-name>
        <meta-value>ac0c03833</meta-value>
      </custom-meta>
      <custom-meta>
        <meta-name>ccc-price</meta-name>
        <meta-value/>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="sec1">
    <title>Introduction</title>
    <p>Mass spectrometry (MS)
is a widespread analytical technique used
to detect and quantify ionized molecules, and it has many applications
in biology, chemistry, and medicine. In MS imaging (MSI), molecular
ions are sampled from different locations on a surface area, such
as a tissue section, allowing the mass spectrometer to serve as a
molecular imaging device. The ability to determine the spatial distribution
of thousands of biological compounds in a single experiment makes
MSI a powerful tool for tissue characterization. There have been extensive
developments in the MSI field during the last decades, resulting in
new experimental workflows, improved ionization and sampling methods,
and advances in both the spatial and mass resolutions of instruments.<sup><xref ref-type="bibr" rid="ref1">1</xref>−<xref ref-type="bibr" rid="ref3">3</xref></sup> The availability of a wide variety of ionization techniques such
as secondary-ion MS (SIMS), desorption electrospray ionization (DESI),
and matrix-assisted laser desorption/ionization (MALDI) allows ionization
of many compound classes with both targeted and untargeted approaches.<sup><xref ref-type="bibr" rid="ref1">1</xref></sup> High-performance Orbitrap and Fourier transform
ion cyclotron resonance (FT-ICR) mass analyzers can scan tissue sections
with a subcellular spatial resolution and a mass resolution exceeding
500 000. Low sensitivity has been a longstanding obstacle for
high-spatial-resolution MSI but has recently been improved by optimizing
the laser wavelength in MALDI to increase ionization efficiency, or
by post-ionizing neutral molecules to increase ion yield.<sup><xref ref-type="bibr" rid="ref2">2</xref></sup> Novel sample preparation workflows have led to
enhanced quantification and identification of metabolites, peptides,
and proteins. These include protein extraction methods, in situ protease
digestion of proteins, and the use of chemical derivatization such
as labeling with photocleavable mass tags to enhance low-intensity
molecule signals.<sup><xref ref-type="bibr" rid="ref3">3</xref>,<xref ref-type="bibr" rid="ref4">4</xref></sup> Altogether, this leads to highly
complex data sets that demand accurate preprocessing and sophisticated
bioinformatic analysis to maximize their utility in biological and
clinical research.<sup><xref ref-type="bibr" rid="ref5">5</xref></sup></p>
    <p>A persisting
issue in MSI is systematic mass misalignment, leading
to slight shifts in the <italic>m</italic>/<italic>z</italic> ratio
of molecule peaks across spectra. These shifts can result in misidentified
peaks or an increased risk of mixing peaks from different molecules
with similar masses in the same ion image. Mass misalignment is typically
more severe for time-of-flight (TOF) instruments than for FT-ICR,
Orbitrap, or other Fourier transform (FT) instruments.<sup><xref ref-type="bibr" rid="ref6">6</xref></sup> Variations in temperature throughout the experiment, contractions
and dilatations of the ion tube, contamination of the ion source,
and tissue topography are some factors that are related to mass shifts
in spectra generated by TOF instruments. For FT instruments, the most
common source of mass misalignment is the space-charge effect, which
causes mass shifts that increase with the number of ions in the trap.<sup><xref ref-type="bibr" rid="ref7">7</xref>,<xref ref-type="bibr" rid="ref8">8</xref></sup> The mass shifts in FT instruments can often be limited using automatic
gain control (AGC), but can be considerable if suboptimal AGC settings
are used.</p>
    <p>When discussing mass misalignment and mass shifts,
it is important
to distinguish between relative mass alignment and absolute mass accuracy.
Here, the former refers to how tightly peak masses are distributed
across spectra, while the latter refers to the difference between
a molecule’s theoretical peak mass and its observed peak mass.
A common approach to correct mass shifts is to perform either external
or internal calibration by comparing the measured masses of predefined
peaks to their expected theoretical masses. External calibration is
performed by depositing a calibration standard outside the tissue
region and comparing the measured peak masses to the known masses
of the calibrants. The same calibration function is then applied to
all tissue spectra. While this approach is simple, it does not reduce
the relative misalignment or correct mass shifts introduced during
the experiment. Internal calibration, on the other hand, relies on
identifying known peaks in each tissue spectrum. The known peaks can
be either prominent molecule peaks intrinsic to the tissue or peaks
corresponding to calibrants sprayed on the whole tissue area. Internal
calibration can improve both the relative alignment between spectra
and absolute mass accuracy but performs poorly for spectra in which
the calibration peaks are missing or incorrectly assigned.<sup><xref ref-type="bibr" rid="ref9">9</xref></sup></p>
    <p>An alternative approach is to align all
spectra to a common reference
spectrum. Given that the absolute mass accuracy of the reference spectrum
is high, this can reduce relative misalignment and improve absolute
mass accuracy simultaneously. A simple approach to aligning one spectrum
to another is fitting a polynomial recalibration function to the mass
difference of their shared peaks and then using this recalibration
function to recalibrate all peak masses. While this approach is flexible,
it is highly sensitive to spurious peak matches. Bocker and Makinen<sup><xref ref-type="bibr" rid="ref10">10</xref></sup> introduced a linear curve-fitting approach that
is robust to spurious peak matches, and Kulkarni et al.<sup><xref ref-type="bibr" rid="ref11">11</xref></sup> later used this approach, together with spatial
information, to further improve mass alignment. More recently, there
has been increased focus on mass alignment for TOF instruments. Ráfols
et al.<sup><xref ref-type="bibr" rid="ref6">6</xref></sup> proposed an alignment algorithm
that uses the cross-correlation between two spectra in the upper and
lower parts of the mass range to estimate mass shift. They then use
the upper and lower shifts to recalibrate the mass axis of one of
the spectra to that of the other. Boskamp et al.<sup><xref ref-type="bibr" rid="ref9">9</xref></sup> elegantly exploit statistical properties of the peptide
background signal to improve mass alignment and absolute mass accuracy.
They estimate the mass shift across the <italic>m</italic>/<italic>z</italic> range by comparing observed to theoretical peak masses
on the Kendrick mass scale. Unlike Ráfols et al.’s method,
their method can correct nonlinear mass shifts, but the dependency
on the peptide background limits its generalizability.</p>
    <p>Another
aspect of mass alignment is at which stage in the processing
pipeline it is performed. It can be performed in the time domain for
TOF spectra, in the frequency domain for FT spectra, using profile
mass spectra, or using centroided mass spectra.<sup><xref ref-type="bibr" rid="ref6">6</xref>,<xref ref-type="bibr" rid="ref10">10</xref>,<xref ref-type="bibr" rid="ref12">12</xref>,<xref ref-type="bibr" rid="ref13">13</xref></sup> In principle,
aligning spectra at an early stage is advantageous in the sense that
errors are not accumulated in subsequent processing steps. In practice,
however, time or frequency spectra are often inaccessible as vendor
software typically only provide mass spectra, and the majority of
data sets uploaded to repositories are processed to some extent. FT
spectra, in particular, are often centroided to reduce their otherwise
impractical size.<sup><xref ref-type="bibr" rid="ref14">14</xref></sup> It is impossible to
recover a raw spectrum from one that has been processed. Hence, an
approach must be able to perform alignment with processed spectra
to be compatible with most MSI data sets. This compatibility is essential;
data sets generated independently in other labs are frequently used
to validate biological findings or novel methods. A public data set
may be generated with any instrument and additional processing is
sometimes required to ensure its quality. This compatibility requirement,
together with the growing popularity of public MSI data set repositories
such as MetaboLights<sup><xref ref-type="bibr" rid="ref15">15</xref></sup> or METASPACE,<sup><xref ref-type="bibr" rid="ref16">16</xref></sup> creates a demand for algorithms that can perform
accurate mass alignment on spectra acquired with multiple instrument
types and regardless of whether they are already partially processed.</p>
    <p>In this work, we adapt the correlation optimized warping (COW)<sup><xref ref-type="bibr" rid="ref17">17</xref></sup> algorithm to perform label-free MSI mass alignment
using a custom benefit function and show that we can greatly reduce
variation in peak masses between spectra. COW aligns a pair of signals
by performing local warpings on one signal so that the global similarity
relative to the other is maximized. We have previously shown that
COW is effective in reducing misalignment in the time dimension between
liquid chromatography–mass spectrometry (LC-MS) sample runs.<sup><xref ref-type="bibr" rid="ref18">18</xref>,<xref ref-type="bibr" rid="ref19">19</xref></sup> Here, we instead use COW to reduce mass misalignment between spectra
by warping the mass dimension.</p>
    <p>Crucially, our method finds the
optimal warping of one spectrum
relative to another using only a list of centroided peaks from each
spectrum. We model centroided peaks as Gaussians whose widths vary
with <italic>m</italic>/<italic>z</italic>, and define the similarity
between two spectra as the total overlap of their shared peaks. To
assess and further improve COW’s robustness for particularly
peak-sparse or misaligned spectra, we include an optional outlier
detection step in the form of a tailored random sample consensus (RANSAC)<sup><xref ref-type="bibr" rid="ref20">20</xref></sup> procedure. The concept of our method is similar
to that of Ráfols et al.,<sup><xref ref-type="bibr" rid="ref6">6</xref></sup> but differs
in two key aspects. First, we find the mass recalibration function
by maximizing the product (overlap) of centroided peaks instead of
the cross-correlation of continuous spectra. Second, our method can,
since it is derived from COW, correct nonlinear mass shifts. Thereby,
our method utilizes information about peak height and width (not simply
mass location) while remaining compatible with most MSI data sets.
We demonstrate the effectiveness and generalizability of our method,
named MSIWarp, by applying it to four publicly available data sets.
MSIWarp performs accurate and robust alignment with centroided spectra,
is compatible with multiple instrument types, and makes no assumptions
on the molecular composition of the sample. We provide a fast C++
implementation of MSIWarp together with a Python binding at <uri xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://github.com/horvatovichlab/MSIWarp">https://github.com/horvatovichlab/MSIWarp</uri>.</p>
  </sec>
  <sec id="sec2">
    <title>Theory</title>
    <p>The core of MSIWarp is a spectrum-to-spectrum similarity
score
that is used to find an optimal warping function between the mass
axis of one spectrum and that of another. To align an entire MSI data
set, all spectra, the sample spectra, are warped to a common reference
spectrum that can be selected from the data set, or be a composite
spectrum constructed from multiple spectra. Similar to our previous
work,<sup><xref ref-type="bibr" rid="ref19">19</xref></sup> MSIWarp deliberately relies on
centroided, i.e., peak-picked, spectra to perform alignment. Peak-picking
can improve alignment by retaining most compound-related signals while
removing background noise that degrades performance. More importantly,
however, an alignment method that takes centroided spectra as input
can trivially be used to align profile spectra, but not vice versa.
MSIWarp relies on centroid spectra instead of profile spectra and
is thereby readily applicable to almost any MSI data set.</p>
    <p>MSIWarp
can be summarized in three steps (<xref rid="fig1" ref-type="fig">Figure <xref rid="fig1" ref-type="fig">1</xref></xref>): first, we match the peaks of the sample
spectrum against those of the reference spectrum. Second, based on
the peak matches from step one, we split the <italic>m</italic>/<italic>z</italic> range in a manner that ensures there is sufficient shared
information in all segments. Finally, we find an optimal warping function
with the peak matches and the partitioning of the <italic>m</italic>/<italic>z</italic> range obtained in steps one and two, respectively,
and use this function to recalibrate the peak masses of the sample
spectrum.</p>
    <fig id="fig1" position="float">
      <label>Figure 1</label>
      <caption>
        <p>Conceptual description of MSIWarp. After matching the peaks in
the sample spectrum against those in the reference spectrum, the sample
spectrum is warped so that its similarity to the reference spectrum
is maximized. (A) Scatter of the mass shift between matched peaks
across the <italic>m</italic>/<italic>z</italic> range. The shifted
warping nodes are marked with vertical arrows (the actual search space
is centered around zero and extends beyond the arrows). The orange
curve shows the estimated mass shift based on our similarity score.
(B) The similarity score is evaluated for the set of candidate warpings,
and the warping resulting in the highest score is used to align the
sample spectrum. (C) Zoom-in of the spectra with the centroided peaks
modeled as Gaussians. Two sample spectrum peaks are matched to the
reference spectrum peak at 1207 <italic>m</italic>/<italic>z</italic>, but the spurious match (also marked in (A)) has no effect on the
warping.</p>
      </caption>
      <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0002" id="gr1" position="float"/>
    </fig>
    <sec id="sec2.1">
      <title>Mass Alignment</title>
      <p>Our method aligns
a pair of spectra
by warping one in the mass dimension so that its similarity to the
other is maximized. Provided that the type of mass spectrometer used
to generate the spectra is known, it requires only a list of peak
heights and <italic>m</italic>/<italic>z</italic> locations for each
spectrum. We model peak intensity as a Gaussian function of <italic>m</italic>/<italic>z</italic> with centroid mass μ and height <italic>H</italic>. With this peak model, we can then compute the similarity
of two centroided spectra as the sum of all pairwise peak overlaps,
and use this similarity score as a measure of alignment quality. To
model peak width, σ, we use known theoretical relationships
between peak width and <italic>m</italic>/<italic>z</italic>, together
with the mass resolution of the data set. The theoretical relationships
depend on instrument type and are summarized in Suits et al.<sup><xref ref-type="bibr" rid="ref21">21</xref></sup> If the mass resolution is unknown, a good estimate
of a single peak’s full width at half-maximum (FWHM) is enough
to model the width of all other peaks in the data set. While not a
true representation of a mass spectrum peak, the Gaussian peak model
is a sufficient approximation for the purpose of alignment. Similarly,
the modeled peak width does not have to match the true width exactly,
since its main purpose is to provide some freedom when matching and
aligning peaks.</p>
      <p><xref rid="eq1" ref-type="disp-formula">Equations <xref rid="eq1" ref-type="disp-formula">1</xref></xref>–<xref rid="eq4" ref-type="disp-formula">4</xref> formally define our Gaussian
peak model <italic>p</italic>, the overlap between two peaks <italic>I</italic>, and the similarity between two spectra, <italic>B</italic>. The intensity of a peak varies with <italic>m</italic>/<italic>z</italic> according to<disp-formula id="eq1"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m001" position="anchor"/><label>1</label></disp-formula>The
overlap of two peaks is<disp-formula id="eq2"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m002" position="anchor"/><label>2</label></disp-formula>The integral in <xref rid="eq2" ref-type="disp-formula">eq <xref rid="eq2" ref-type="disp-formula">2</xref></xref> can be solved analytically to yield<disp-formula id="eq3"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m003" position="anchor"/><label>3</label></disp-formula>where<disp-formula id="ueq1"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m004" position="anchor"/></disp-formula>and<disp-formula id="ueq2"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m005" position="anchor"/></disp-formula>The similarity
score, <italic>B</italic>,
between two spectra, <italic>S</italic><sub><italic>i</italic></sub> and <italic>S</italic><sub><italic>j</italic></sub>, is the sum
overlap of all matched peaks<disp-formula id="eq4"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m006" position="anchor"/><label>4</label></disp-formula>To compute
the similarity score between a
pair of spectra, the set of peak pairs that satisfy the condition
in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref> must be found.
A peak in the first spectrum is matched to one in the second spectrum
if their <italic>m</italic>/<italic>z</italic> locations are within
a small distance threshold, ϵ, of each other. Note that a peak
in one spectrum can be matched to multiple peaks in the other spectrum.
The threshold ϵ in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref> is proportional to the modeled peak width and therefore increases
with <italic>m</italic>/<italic>z</italic>.</p>
      <p>With our definition
of pairwise similarity between two centroided
spectra, we can search for an optimal warping from a set of candidate
warpings in a similar way as the original COW implementation. This
involves dividing the <italic>m</italic>/<italic>z</italic> range
into segments, evaluating <italic>B</italic> for all candidate warpings
for each segment independently, and then finding the optimal combination
of segment warpings. The analytical form of the integral in <xref rid="eq2" ref-type="disp-formula">eq <xref rid="eq2" ref-type="disp-formula">2</xref></xref> enables fast computation
of the similarity score, which is critical since it must be repeated
for each candidate warping. Here, we denote the lower and upper edges
of an <italic>m</italic>/<italic>z</italic> segment <italic>n</italic><sub>l</sub> and <italic>n</italic><sub>r</sub>, respectively, and
refer to them as the warping nodes of the segment. Note that each
warping node, except those at the lowest and highest ends of the <italic>m</italic>/<italic>z</italic> range, are shared by two segments.
To generate the set of candidate warpings for an <italic>m</italic>/<italic>z</italic> segment, the warping nodes at its edges are shifted
a fixed number of steps upward and downward in <italic>m</italic>/<italic>z</italic>. The set of warpings for that segment then corresponds
to all possible combinations of shifts of <italic>n</italic><sub>l</sub> and <italic>n</italic><sub>r</sub>. Computing <italic>B</italic> for a particular warping and segment is then performed by warping
the peaks in the segment and then computing <italic>B</italic> with
the warped peaks and the peaks from the corresponding segment in the
reference spectrum. Peaks are warped by updating their mass with linear
interpolation according to<disp-formula id="eq5"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m007" position="anchor"/><label>5</label></disp-formula>where<disp-formula id="ueq3"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m008" position="anchor"/></disp-formula>μ is the original
peak mass, μ′
is the warped peak mass, and <italic>n</italic><sub>l</sub><sup arrange="stack">′</sup> and <italic>n</italic><sub>r</sub><sup arrange="stack">′</sup> are
the shifted positions of <italic>n</italic><sub>l</sub> and <italic>n</italic><sub>r</sub>, respectively. Note that while segments are
compressed, stretched, and/or shifted, a peak is never warped out
of its segment and its width and height are left untouched. Finally,
like in the original COW implementation,<sup><xref ref-type="bibr" rid="ref17">17</xref></sup> the optimal combination of warping node moves is found with dynamic
programming. The shift of a warping node is bounded by the slack parameter:
|<italic>n</italic>′ – <italic>n</italic>| ≤ <italic>m</italic><sub><italic>n</italic></sub>. The slack is reflected by
the amplitude of the warping function and should be sufficiently large
to capture the largest shifts. Like the peak matching threshold (ϵ
in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref>), <italic>m</italic> is proportional to FWHM and is computed for each warping node individually.</p>
      <p>By maximizing our similarity score, we find a piecewise linear
mass recalibration function with a degree of freedom determined by
the number of warping nodes. A large number of short segments gives
a flexible warping function that can correct local <italic>m</italic>/<italic>z</italic> shifts, whereas a small number of long segments
generally results in a more stable, but less flexible, warping function.
The risk of overfitting the warping function to noise or random variations
in peak mass is smaller with segments that have many matched peaks.
Due to this, we prefer long segments that accommodate a sufficient
number of peak matches (at least 10–20) to short segments that
are potentially more flexible.</p>
    </sec>
    <sec id="sec2.2">
      <title>Placement of Warping Nodes</title>
      <p>In many MSI data sets, there
is a large variation in peak density across the <italic>m</italic>/<italic>z</italic> range. For such data sets, the placement of the
warping nodes can greatly influence the warping quality. The same
warping nodes can be used for all spectra, or they can be placed uniquely
for each spectrum. The goal of the warping node placement is to have
a segment length that is adapted to the amount of shared information,
i.e., peak matches, between the sample and reference spectra in all
parts of the <italic>m</italic>/<italic>z</italic> range. This can
be achieved by generating a density estimate (smooth histogram) of
the peak matches between the sample and reference spectra over the <italic>m</italic>/<italic>z</italic> range and then placing the warping
nodes between the peaks of the density curve. If the warping nodes
are uniquely placed for each spectrum, they can alternatively be placed
so that the number of peak matches is the same in all segments. A
third option is to use segments with uniform lengths. This may work
well for spectra with a high peak density throughout the <italic>m</italic>/<italic>z</italic> range but can result in segments without peak
matches for peak-sparse spectra.</p>
    </sec>
    <sec id="sec2.3">
      <title>RANSAC Outlier Detection</title>
      <p>Unlike alignment methods that
rely solely on the difference in mass between matched peaks, MSIWarp
is naturally robust to spurious matches, as long as there are sufficiently
many true matches. To confirm this, we use a custom RANSAC procedure
to detect spurious matches, perform alignment both with the full set
of peak matches and with that obtained after having removed spurious
matches, and compare the results to evaluate whether spurious matches
degrade the alignment quality of MSIWarp in practice. Generally, RANSAC
fits a model to a minimal subset of data points that may contain outliers.
The subset is resampled numerous times and the model is fit to each
subset. The best model, given some criteria, is then selected and
all data points that fit the model are included in the “inlier”
set. We combine RANSAC with our method to separate true matches (inliers)
from spurious matches in the following way:<list list-type="simple"><list-item><label>(i)</label><p>Generate a list of preliminary peak
matches with a permissive distance threshold proportional to peak
FWHM.</p></list-item><list-item><label>(ii)</label><p>Randomly sample
two matches from
the preliminary set of matches for each segment, and fit a trial warping
model to the sampled matches. Warp all other preliminary matches according
to the trial model.</p></list-item><list-item><label>(iii)</label><p>Add peak matches whose mass distance
after alignment is below a strict threshold to the inlier set.</p></list-item><list-item><label>(iv)</label><p>Repeat steps (i)–(iii) <italic>n</italic> times and return the largest set of inliers. Given an
estimate of the fraction of inliers among the peak matches, <italic>n</italic> can be set to obtain a desired probability of an outlier-free
candidate model.</p></list-item></list>We use ϵ from <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref> as the threshold in (i)
and 0.3 times peak FWHM as that in
(iii). When using a large number of segments, the warping function
found using the subset of peak matches in (ii) is highly unstable
and can sometimes fit a large number of spurious matches by chance.
Therefore, we use only one or two warping segments in the RANSAC step.
After removing the spurious matches, more warping segments can be
added in parts of the <italic>m</italic>/<italic>z</italic> range
that are supported by the number of true matches. The final warping
is then searched for using all, or a large fraction, of the true matches.</p>
    </sec>
  </sec>
  <sec id="sec3">
    <title>Materials and Methods</title>
    <sec id="sec3.1">
      <title>Data Sets</title>
      <p>To evaluate MSIWarp, we
applied it to four
publicly available data sets that together represent the most common
MSI experimental setups. The first data set was generated from two
mouse kidney sections with a rapifleX MALDI TOF/TOF instrument (Bruker
Daltonics).<sup><xref ref-type="bibr" rid="ref22">22</xref></sup> The second data set was generated
from human cancer spheroids with an ultrafleXtreme MALDI-TOF/TOF instrument
(Bruker Daltonics).<sup><xref ref-type="bibr" rid="ref23">23</xref></sup> The third data set
was generated from a rat liver section with a MALDI LTQ Orbitrap XL
instrument (Thermo Fischer Scientific).<sup><xref ref-type="bibr" rid="ref24">24</xref></sup> The fourth data set was generated from a colorectal adenocarcinoma
sample using a home-built motorized DESI ion source and an LTQ XL
Orbitrap Discovery instrument (Thermo Fischer Scientific).<sup><xref ref-type="bibr" rid="ref25">25</xref></sup> The data sets, referred to as the TOF kidney,
TOF spheroids, Orbitrap liver, and Orbitrap DESI data sets, are summarized
in <xref rid="tbl1" ref-type="other">Table <xref rid="tbl1" ref-type="other">1</xref></xref>. A more
detailed description of the data sets is available in the <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Supporting Information</ext-link>, and total ion current
(TIC) images for each data set are shown in <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figure S1</ext-link>. Before performing mass alignment, we filtered out peaks
whose intensity was below a signal-to-noise ratio (SNR) of 2.5 from
the mouse kidney TOF data set and centroided all data sets, except
for the Orbitrap DESI, with the parabolic centroiding algorithm by
Robichaud et al.<sup><xref ref-type="bibr" rid="ref26">26</xref></sup> We downloaded the Orbitrap
DESI data set in centroid mode from the MetaboLights repository. The
data sets were preprocessed with in-house Python scripts.</p>
      <table-wrap id="tbl1" position="float">
        <label>Table 1</label>
        <caption>
          <title>Summary of the Data Sets<xref rid="t1fn1" ref-type="table-fn">a</xref></title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center"> </th>
              <th style="border:none;" align="center">TOF kidney</th>
              <th style="border:none;" align="center">TOF spheroids</th>
              <th style="border:none;" align="center">Orbitrap
liver</th>
              <th style="border:none;" align="center">Orbitrap
DESI</th>
            </tr>
            <tr>
              <th style="border:none;" align="center">ionization
technique</th>
              <th style="border:none;" align="center">MALDI</th>
              <th style="border:none;" align="center">MALDI</th>
              <th style="border:none;" align="center">MALDI</th>
              <th style="border:none;" align="center">DESI</th>
            </tr>
            <tr>
              <th style="border:none;" align="center">species</th>
              <th style="border:none;" align="center">mouse</th>
              <th style="border:none;" align="center">human</th>
              <th style="border:none;" align="center">rat</th>
              <th style="border:none;" align="center">human</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">no. spectra</td>
              <td style="border:none;" align="left">33 242</td>
              <td style="border:none;" align="left">1114</td>
              <td style="border:none;" align="left">23 823</td>
              <td style="border:none;" align="left">20 286</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">raster size (μm)</td>
              <td style="border:none;" align="left">100</td>
              <td style="border:none;" align="left">50</td>
              <td style="border:none;" align="left">50</td>
              <td style="border:none;" align="left">100</td>
            </tr>
            <tr>
              <td style="border:none;" align="left"><italic>m</italic>/<italic>z</italic> range (Da)</td>
              <td style="border:none;" align="left">500–2500</td>
              <td style="border:none;" align="left">800–4500</td>
              <td style="border:none;" align="left">150–1000</td>
              <td style="border:none;" align="left">200–1000</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">resolution</td>
              <td style="border:none;" align="left">2600</td>
              <td style="border:none;" align="left">17 500</td>
              <td style="border:none;" align="left">60 000</td>
              <td style="border:none;" align="left">60 000</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">avg. no. peaks</td>
              <td style="border:none;" align="left">244</td>
              <td style="border:none;" align="left">57</td>
              <td style="border:none;" align="left">730</td>
              <td style="border:none;" align="left">701</td>
            </tr>
          </tbody>
        </table>
        <table-wrap-foot>
          <fn id="t1fn1">
            <label>a</label>
            <p>Both TOF
data sets were uploaded
to ProteomeXchange smoothed and with their baseline removed. Resolutions
for the Orbitrap data sets were calculated at 400 <italic>m</italic>/<italic>z</italic>.</p>
          </fn>
        </table-wrap-foot>
      </table-wrap>
    </sec>
    <sec id="sec3.2">
      <title>Data Analysis</title>
      <p>To measure the effect of alignment in
each data set, we calculated the mass dispersion around a set of reference
peaks. We obtained the mass dispersion of a reference peak by binning
all spectra around its <italic>m</italic>/<italic>z</italic> and then
calculating the standard deviation of peak masses within the resulting
mass bin. By binning we mean isolating peaks across spectra at predefined <italic>m</italic>/<italic>z</italic> locations, and we refer to the isolation
windows as mass bins. We used a bin width two times the FWHM of the
reference peak. As reference peaks, we used the most intense peaks
of the mean spectrum (100 for the TOF kidney, Orbitrap liver, and
Orbitrap DESI data sets and 50 for the TOF spheroid data set), some
matrix peaks, and peaks that were identified in the papers that originally
published the data sets. The mean spectrum was generated after alignment
with MSIWarp, and we performed the binning and calculated mass dispersion
both before and after alignment.</p>
      <p>To further assess the quality
of the alignment, we generated scatter plots of peak mass and spectrum
acquisition time for the mass bin of each reference peak (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figures S3–S13</ext-link>). The scatter plots provide
a clear view of the mass shift before and after alignment and serve
as valuable quality control for the alignment of specific peaks. Despite
the previous intensity filtering of the TOF kidney data set based
on SNR, some mass bins were still contaminated with faint background
peaks. To reduce the influence of these, we applied an intensity threshold
to each mass bin. The threshold was defined as the lower intensity
quartile of all of the peaks in the mass bin, and peaks whose intensity
was below this threshold were excluded when calculating mass dispersion.</p>
    </sec>
  </sec>
  <sec id="sec4">
    <title>Results and Discussion</title>
    <p>To reiterate, MSIWarp aligns a data
set by maximizing the similarity
between each spectrum and a common reference spectrum. Like any method
that performs pairwise alignment, it relies on shared information.
In the ideal case, all spectra share numerous peaks with the reference
spectrum throughout the <italic>m</italic>/<italic>z</italic> range.
In a more challenging case, there are few shared peaks overall and/or
wide gaps in the <italic>m</italic>/<italic>z</italic> range without
any shared peaks. <xref rid="fig2" ref-type="fig">Figure <xref rid="fig2" ref-type="fig">2</xref></xref> shows a pair of spectra from the Orbitrap data set, another
from the TOF kidney data set, and the <italic>m</italic>/<italic>z</italic> difference between preliminary matched peaks. The Orbitrap spectra
are homogeneous, with shared peaks throughout the <italic>m</italic>/<italic>z</italic> range, and the mass shifts are small (&lt;1.5
ppm). In contrast, the TOF spectra are heterogeneous, the mass shifts
are significantly larger (&gt;200 ppm), and there is a part of the <italic>m</italic>/<italic>z</italic> range with almost no shared peaks (1000–1400 <italic>m</italic>/<italic>z</italic>). Note that the mass differences between
shared peaks for a pair of aligned spectra are expected to be distributed
around zero throughout the <italic>m</italic>/<italic>z</italic> range.
However, in these examples, the misalignment is apparent; the mass
shift of matched peaks consistently increases with <italic>m</italic>/<italic>z</italic> for both pairs. To accommodate large mass shifts,
we used a peak matching threshold (ϵ in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref>) of approximately two times the FWHM when
matching peaks. With the low mass resolution in the TOF kidney data
set, this meant matching peaks within a window of ±0.76 <italic>m</italic>/<italic>z</italic> at 1000 <italic>m</italic>/<italic>z</italic>. A wide matching window increases the number of spurious
matches; the scatter in <xref rid="fig2" ref-type="fig">Figure <xref rid="fig2" ref-type="fig">2</xref></xref>b contains numerous examples, most notably those clustered
around 850 and 1050 <italic>m</italic>/<italic>z</italic>. Finally,
we chose to place the warping nodes based on the density estimate
of peak matches, since it generally resulted in a smoother partitioning
of the <italic>m</italic>/<italic>z</italic> range than when placing
them so that all segments contained the same number of peak matches.
We generated the density estimate by performing a Kernel density estimation
(KDE) of peak <italic>m</italic>/<italic>z</italic> and then placed
the warping nodes between the peaks of the density curve, resulting
in 4–10 warping segments for the four data sets. Increasing
and decreasing the bandwidth of the KDE is a flexible way to adjust
the number of warping segments and the number of peak matches in each
segment. We used a bandwidth of 15 Da for the TOF kidney and Orbitrap
data sets, and a bandwidth of 100 Da for the TOF spheroid data set
since it was significantly less peak-dense than the other data sets.</p>
    <fig id="fig2" position="float">
      <label>Figure 2</label>
      <caption>
        <p>Top: pair
of raw spectra from the Orbitrap liver data set (a) and
another from the TOF kidney (b). Bottom: scatters of <italic>m</italic>/<italic>z</italic> difference between matched peaks with point size
scaled by intensity. The Orbitrap spectra share peaks across the entire <italic>m</italic>/<italic>z</italic> range. In contrast, the TOF spectra
share no peaks in a large part of the <italic>m</italic>/<italic>z</italic> range (1000–1400 <italic>m</italic>/<italic>z</italic>).
This example also highlights the severity of the mass shift in the
TOF kidney data set: at 800 <italic>m</italic>/<italic>z</italic>,
the shift is close to 0.18 <italic>m</italic>/<italic>z</italic> (219
ppm) between the TOF pair compared to 0.001 <italic>m</italic>/<italic>z</italic> (1.25 ppm) between the Orbitrap pair.</p>
      </caption>
      <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0003" id="gr2" position="float"/>
    </fig>
    <p>Spurious peak matches are largely inconsequential to MSIWarp as
long as spectra are reasonably peak-dense; in fact, most spectra are
aligned accurately and reliably without RANSAC, even those in the
TOF data sets. We hypothesized that the importance of identifying
true matches increases when aligning peak-sparse spectra. For this
reason, we aligned the TOF data sets both with and without RANSAC.
When combining RANSAC with COW, it is important to use a small number
of warping segments in this step to avoid overfitting the candidate
models to spurious peak matches; here, we used two segments for both
TOF data sets in the RANSAC step. Manual inspection of scatter plots
like those in <xref rid="fig3" ref-type="fig">Figure <xref rid="fig3" ref-type="fig">3</xref></xref> suggests that RANSAC confidently filters out spurious peak matches
in almost all spectra across both TOF data sets. We used RANSAC to
filter out spurious peak matches before searching for the optimal
warping. Then, we added more warping nodes in the peak-dense parts
of the <italic>m</italic>/<italic>z</italic> range to gain more flexibility.
Thereby, we obtained a flexibility in the warping function that was
adapted to the number of shared peaks throughout the <italic>m</italic>/<italic>z</italic> range. We provide some examples of how RANSAC
finds the true peak matches (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figure S2</ext-link>)
along with an animation in the <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Supporting Information</ext-link>.</p>
    <fig id="fig3" position="float">
      <label>Figure 3</label>
      <caption>
        <p>(a, b) Mass shift estimated by MSIWarp (orange line) overlaid on
the peak match scatter from <xref rid="fig2" ref-type="fig">Figure <xref rid="fig2" ref-type="fig">2</xref></xref>. (b) We use more warping nodes in the peak-dense part
of the <italic>m</italic>/<italic>z</italic> range than in the peak-sparse
part; the zoom-in shows that the warping function closely follows
the local shifts between 700 and 900 <italic>m</italic>/<italic>z</italic>.</p>
      </caption>
      <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0004" id="gr3" position="float"/>
    </fig>
    <p>When aligning a data set by aligning
each spectrum to a common
reference spectrum, the quality of that reference spectrum is essential.
We tried an approach similar to that of Kulkarni et al.,<sup><xref ref-type="bibr" rid="ref11">11</xref></sup> where the reference spectrum is continuously
updated with each aligned sample spectrum, but observed no significant
improvement over aligning against a constant reference spectrum of
high quality. The spectrum with the highest TIC was sufficient in
terms of peak coverage for all four data sets, and we therefore chose
to use it as a reference. Although the spectra with the highest TIC
were appropriate references for the alignment of the data sets that
we discuss here, a composite spectrum may be needed to fully cover
the <italic>m</italic>/<italic>z</italic> range in other data sets.</p>
    <p>How we dealt with segments without shared peaks also deserves mention.
We chose to interpolate the warping function in empty regions, as
is evident in <xref rid="fig3" ref-type="fig">Figure <xref rid="fig3" ref-type="fig">3</xref></xref>b at around 1200 <italic>m</italic>/<italic>z</italic>. This is reasonable
under the assumption that some relevant data set peaks are missing
in the reference spectrum, which is often the case, so they can be
present in a sample spectrum without being shared with the reference.
An alternative approach is to leave the empty parts of the <italic>m</italic>/<italic>z</italic> region unaligned, which can be more
appropriate if the reference spectrum has a very high peak coverage
throughout the <italic>m</italic>/<italic>z</italic> range. When this
is the case, the sample spectrum likely has little or no information
in regions where it does not share peaks with the reference spectrum,
and aligning those regions is unnecessary.</p>
    <sec id="sec4.1">
      <title>Reduction in Mass Misalignment</title>
      <p>After alignment with
MSIWarp, mass dispersion is reduced considerably in all four data
sets. In <xref rid="tbl2" ref-type="other">Table <xref rid="tbl2" ref-type="other">2</xref></xref>, the
mass dispersions of the mean spectrum peaks before and after alignment
are reported in both ppm and FWHM. The full list of dispersions of
the mean spectrum peaks is available in the <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Supporting Information</ext-link> spreadsheet. Interestingly, we observed no significant
improvement when aligning the TOF data sets with RANSAC compared to
aligning it without RANSAC. This suggests that the inherent robustness
of COW is sufficient in dealing with spurious peak matches for the
majority of spectra. To assess the sensitivity of MSIWarp to the modeled
peak width, σ, and the peak matching threshold, ϵ, we
reran the analysis of the Orbitrap liver and TOF kidney data sets
for various values of these parameters (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Table S1 and S2</ext-link>). This parameter sensitivity analysis suggests that
MSIWarp can perform well even when σ over- or underestimates
the experimental peak width by a factor of up to 2. It also suggests
that a large peak matching threshold is better than a small one, which
is further evidence that MSIWarp is robust to spurious peak matches
and that the most important factor is that true matches are captured
throughout the <italic>m</italic>/<italic>z</italic> range. In addition
to using the spectrum with the highest TIC as a reference, we also
aligned the TOF kidney data set to each of the 11 spectra with TICs
closest to the data set median, resulting in median mass dispersions
of mean spectrum peaks between 11.64 and 16.10 ppm (avg. 12.53). For
9 out of 11 spectra, the median mass dispersion was lower than when
using the spectrum with the highest TIC as a reference (12.73 ppm).
In comparison, using the spectrum with the lowest TIC as a reference
resulted in a median mass dispersion of 73.45 ppm. Altogether, this
indicates that a minimum TIC threshold can be used to filter out unsuitable
reference spectra, but otherwise, the TIC provides little or no information
about a spectrum’s suitability as a reference.</p>
      <table-wrap id="tbl2" position="float">
        <label>Table 2</label>
        <caption>
          <title>Median Mass Dispersion of Mean Spectrum
Peaks before (Raw) and after Alignment (Warped) for the Four Data
Sets</title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center"> </th>
              <th style="border:none;" align="center" char=".">TOF kidney</th>
              <th style="border:none;" align="center" char=".">TOF spheroids</th>
              <th style="border:none;" align="center" char=".">Orbitrap
liver</th>
              <th style="border:none;" align="center" char=".">Orbitrap
DESI</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">raw (ppm)</td>
              <td style="border:none;" align="char" char=".">106.39</td>
              <td style="border:none;" align="char" char=".">35.63</td>
              <td style="border:none;" align="char" char=".">0.63</td>
              <td style="border:none;" align="char" char=".">0.52</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">warped (ppm)</td>
              <td style="border:none;" align="char" char=".">12.73</td>
              <td style="border:none;" align="char" char=".">6.48</td>
              <td style="border:none;" align="char" char=".">0.18</td>
              <td style="border:none;" align="char" char=".">0.17</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">raw (FWHM)</td>
              <td style="border:none;" align="char" char=".">0.27</td>
              <td style="border:none;" align="char" char=".">0.63</td>
              <td style="border:none;" align="char" char=".">0.03</td>
              <td style="border:none;" align="char" char=".">0.03</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">warped (FWHM)</td>
              <td style="border:none;" align="char" char=".">0.03</td>
              <td style="border:none;" align="char" char=".">0.11</td>
              <td style="border:none;" align="char" char=".">0.01</td>
              <td style="border:none;" align="char" char=".">0.01</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">reduction (%)</td>
              <td style="border:none;" align="char" char=".">88.03</td>
              <td style="border:none;" align="char" char=".">81.82</td>
              <td style="border:none;" align="char" char=".">72.03</td>
              <td style="border:none;" align="char" char=".">68.00</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
      <p>Visualization of how
the peak mass varies across the experiment
gives a good overview of alignment; <xref rid="fig4" ref-type="fig">Figure <xref rid="fig4" ref-type="fig">4</xref></xref>a–<xref rid="fig4" ref-type="fig">4</xref>c shows
the scatter of the relative peak mass before and after alignment with
MSIWarp and spectrum acquisition time for three example peaks. The
same pattern is seen for the three peaks: aligning with MSIWarp visibly
tightens the peak scatter and removes the systematic shifts related
to spectrum acquisition time. These scatter plots are effective in
visualizing time-dependent mass shift but do not provide a clear picture
of how mass shift relates to tissue location. To better visualize
this relationship, we show the relative mass shift of a matrix peak
([M – H<sub>2</sub>O + H]<sup>+</sup>, 172.04 <italic>m</italic>/<italic>z</italic>) from the Orbitrap data set as a function of
tissue location in <xref rid="fig5" ref-type="fig">Figure <xref rid="fig5" ref-type="fig">5</xref></xref>a. In this plot, it is evident that the peak masses decrease
with time (the tissue was scanned from top to bottom), but also that
some shifts are related to tissue location. The blue spots in the
bottom half of the section break the trend related to acquisition
time; in these spots, peak masses are increased by more than 4 ppm,
compared to an average decrease of approximately 1 ppm in the bottom
half of the section. The blue spots appear to be correlated to the
TIC of the spectra, which could be due to the space-charge effect. <xref rid="fig5" ref-type="fig">Figure <xref rid="fig5" ref-type="fig">5</xref></xref>b shows the mass
shift image of the peak at 890.8 <italic>m</italic>/<italic>z</italic> (PI 38:2) from the TOF kidney data set. In contrast to the matrix
peak from the Orbitrap data set, the mass shift of this peak appears
to be unrelated to both spectrum acquisition time and TIC (<xref rid="fig4" ref-type="fig">Figures <xref rid="fig4" ref-type="fig">4</xref></xref>a and <xref rid="fig5" ref-type="fig">5</xref>b). Instead, there is a strong relationship to tissue location:
in both kidney sections, peak masses appear to be increased in the
cortex and decreased in the medulla. The “stripes” at
the top part of the left section are likely an experimental artifact
(due to tissue folding or damage) rather than being related to any
tissue structure.</p>
      <fig id="fig4" position="float">
        <label>Figure 4</label>
        <caption>
          <p>Scatter plots of mass shift relative to the reference
peak (<italic>y</italic>-axis) and spectrum index ordered according
to acquisition
time (<italic>y</italic>-axis) before (cyan) and after alignment (orange).
(a–c) Scatters around reference peaks at <italic>m</italic>/<italic>z</italic> 850.80 (PI 36:7), 1403.10 (unknown), and 172.04
(matrix) in the TOF kidney, TOF spheroids, and Orbitrap liver data
sets, respectively.</p>
        </caption>
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0005" id="gr4" position="float"/>
      </fig>
      <fig id="fig5" position="float">
        <label>Figure 5</label>
        <caption>
          <p>Mass shift and TIC images
from the Orbitrap liver and TOF kidney
data sets. Left: the mass shift (a) of the matrix peak at 172.04 <italic>m</italic>/<italic>z</italic> in the Orbitrap data set is correlated
to TIC (c). Right: the mass shift (b) of the lipid peak (PI 38:2)
in the TOF kidney data set appears to be related to tissue structures
rather than to TIC (d) or acquisition time.</p>
        </caption>
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0006" id="gr5" position="float"/>
      </fig>
      <p>The mass dispersion of some identified compounds and matrix peaks
in the Orbitrap liver and TOF kidney data sets are shown in <xref rid="tbl3" ref-type="other">Tables <xref rid="tbl3" ref-type="other">3</xref></xref> and <xref rid="tbl4" ref-type="other">4</xref>, respectively. The monoisotopic peak of the phosphatidylcholine
head group (184.07 <italic>m</italic>/<italic>z</italic>) in the Orbitrap
data set has a notably lower dispersion after alignment (0.036 ppm)
than those of the other compounds (0.086–0.435 ppm). The intensity
of this peak is several orders of magnitude larger than that of all
other peaks. As a consequence, it dominates the similarity score and
effectively acts as a lock mass for the warping function. Importantly,
this does not appear to increase dispersion for lower intensity peaks
close in <italic>m</italic>/<italic>z</italic>; the matrix peaks at
172.04 and 190.05 <italic>m</italic>/<italic>z</italic> contribute
insignificantly to the similarity score in comparison, but still have
lower dispersion than most other peaks after alignment. This suggests
that the shift in low-intensity peaks can be estimated accurately
with the shift of nearby high-intensity peaks. In the TOF kidney data
set, dispersion is reduced consistently by more than 80 percent, except
for the peak at <italic>m</italic>/<italic>z</italic> 919.90 (PI 40:1),
whose dispersion remains relatively high after alignment (32.69 ppm).
By looking at the mass scatter of this peak, however, it is evident
that it has been mixed with another peak in the same mass bin and
that this causes the relatively high dispersion after alignment (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figure S5</ext-link>, Supporting Information).</p>
      <table-wrap id="tbl3" position="float">
        <label>Table 3</label>
        <caption>
          <title>Mass Dispersion (ppm) of Five Matrix
(α-Cyano-4-hydroxycinnamic Acid) Peaks, the Monoisotopic Peak
of Two Spiked-In Compounds, and the Peak of Phosphocholine before
(Raw) and after Alignment (Warped) in the Orbitrap Liver Data Set</title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center">compound</th>
              <th style="border:none;" align="center" char="."><italic>m</italic>/<italic>z</italic></th>
              <th style="border:none;" align="center" char=".">disp. raw
(ppm)</th>
              <th style="border:none;" align="center" char=".">disp. warped
(ppm)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">[M – H<sub>2</sub>O + H]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">172.039</td>
              <td style="border:none;" align="char" char=".">0.644</td>
              <td style="border:none;" align="char" char=".">0.159</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[M + H]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">190.050</td>
              <td style="border:none;" align="char" char=".">0.743</td>
              <td style="border:none;" align="char" char=".">0.086</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[M + Na]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">212.032</td>
              <td style="border:none;" align="char" char=".">0.724</td>
              <td style="border:none;" align="char" char=".">0.222</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[M – H + 2Na]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">234.014</td>
              <td style="border:none;" align="char" char=".">0.998</td>
              <td style="border:none;" align="char" char=".">0.435</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[2M + H]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">379.092</td>
              <td style="border:none;" align="char" char=".">0.699</td>
              <td style="border:none;" align="char" char=".">0.343</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">phosphocholine</td>
              <td style="border:none;" align="char" char=".">184.073</td>
              <td style="border:none;" align="char" char=".">0.706</td>
              <td style="border:none;" align="char" char=".">0.036</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">ipratropium</td>
              <td style="border:none;" align="char" char=".">332.222</td>
              <td style="border:none;" align="char" char=".">0.675</td>
              <td style="border:none;" align="char" char=".">0.271</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">dasatinib</td>
              <td style="border:none;" align="char" char=".">488.164</td>
              <td style="border:none;" align="char" char=".">0.475</td>
              <td style="border:none;" align="char" char=".">0.364</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
      <table-wrap id="tbl4" position="float">
        <label>Table 4</label>
        <caption>
          <title>Mass Dispersion (ppm) of Some Identified
Lipid Peaks before (Raw) and after Alignment (Warped) in the TOF Kidney
Data Set<xref rid="t4fn1" ref-type="table-fn">a</xref></title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center">compound</th>
              <th style="border:none;" align="center" char="."><italic>m</italic>/<italic>z</italic></th>
              <th style="border:none;" align="center" char=".">disp. raw
(ppm)</th>
              <th style="border:none;" align="center" char=".">disp. warped
(ppm)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">LPS 18:0</td>
              <td style="border:none;" align="char" char=".">524.19</td>
              <td style="border:none;" align="char" char=".">126.83</td>
              <td style="border:none;" align="char" char=".">15.24</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PA 34:1</td>
              <td style="border:none;" align="char" char=".">673.68</td>
              <td style="border:none;" align="char" char=".">128.19</td>
              <td style="border:none;" align="char" char=".">24.99</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PA 36:1</td>
              <td style="border:none;" align="char" char=".">701.76</td>
              <td style="border:none;" align="char" char=".">123.15</td>
              <td style="border:none;" align="char" char=".">16.80</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PS 36:3</td>
              <td style="border:none;" align="char" char=".">784.38</td>
              <td style="border:none;" align="char" char=".">118.82</td>
              <td style="border:none;" align="char" char=".">16.13</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PI 36:7</td>
              <td style="border:none;" align="char" char=".">850.80</td>
              <td style="border:none;" align="char" char=".">103.38</td>
              <td style="border:none;" align="char" char=".">5.70</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PS 42:5</td>
              <td style="border:none;" align="char" char=".">864.82</td>
              <td style="border:none;" align="char" char=".">105.18</td>
              <td style="border:none;" align="char" char=".">7.23</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PI 40:6</td>
              <td style="border:none;" align="char" char=".">907.87</td>
              <td style="border:none;" align="char" char=".">103.49</td>
              <td style="border:none;" align="char" char=".">6.51</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PI 40:1</td>
              <td style="border:none;" align="char" char=".">919.90</td>
              <td style="border:none;" align="char" char=".">87.83</td>
              <td style="border:none;" align="char" char=".">32.69</td>
            </tr>
          </tbody>
        </table>
        <table-wrap-foot>
          <fn id="t4fn1">
            <label>a</label>
            <p>All lipids are represented as [M
– H]<sup>−</sup> ions.</p>
          </fn>
        </table-wrap-foot>
      </table-wrap>
      <p>An interesting example of the utility of MSIWarp is
shown in <xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>.
Like the mass bin
at 919.90 <italic>m</italic>/<italic>z</italic>, other mass bins in
the TOF kidney data set contain mixed peaks as well, including that
of the unidentified reference peak at 904.90 <italic>m</italic>/<italic>z</italic>. Before alignment, the two peaks in this bin are indistinguishable,
but after alignment, the peaks are separated sufficiently to enable
us to generate a distinct ion image for each. The distribution of
peak mass within the bin is considerably narrower after alignment
(<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>b). Crucially,
the density curve of the warped peak masses reveals, albeit just barely,
the second peak as distinct from the first one. By re-binning the
spectra with two tighter windows (±10 ppm), whose respective
centers are at the main and shoulder peaks of the density estimate,
two distinct ion images can be generated (<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>d,<xref rid="fig6" ref-type="fig">6</xref>e) instead of one
in which the two compounds are mixed (<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>c). Despite the low mass resolution of the
TOF kidney data (the FWHM is approximately 380 ppm), these two peaks,
which are 25 ppm apart, can still be separated by looking at the mass
locations of their centroids. Note that while we separate them on
a data set level, we do not separate them in a single spectrum; when
the compounds corresponding to the peaks are present in the same spectrum,
i.e., tissue spot, the peak of the more intensive compound masks that
of the other. This is evident in the ion images of the two peaks (<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>d,<xref rid="fig6" ref-type="fig">6</xref>e): only the more intense peak (904.878 <italic>m</italic>/<italic>z</italic>) is visible in the pixels where the two peaks
overlap.</p>
      <fig id="fig6" position="float">
        <label>Figure 6</label>
        <caption>
          <p>Mass bin from the TOF kidney data set exemplifies how severe misalignment
leads to mixed ion images. The scatter of peak mass and acquisition
time in (a) reveals two peaks after alignment (orange) that are indistinguishable
before alignment (cyan). Alignment similarly reveals the two peaks
in the density estimate of peak mass within the bin (b): before alignment
(raw), the variation in peak mass across the spectra is too large
to separate the two peaks, but after alignment (warped), the peaks
appear as the main and shoulder peaks of the density curve. The left
ion image (c) was generated from the raw (unaligned) spectra with
a wide bin window (±200 ppm), while the center (d) and right
(e) ion images were generated by binning the warped spectra with a
narrow window (±10 ppm) around 904.855 and 904.878 <italic>m</italic>/<italic>z</italic>, respectively. The median mass of the two peaks
and the narrow windows are marked in the zoom-in on the density curve
in (b). The ion images in (c)–(e) were generated by summing
peak intensities in the bin for each spectrum/pixel.</p>
        </caption>
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0007" id="gr6" position="float"/>
      </fig>
    </sec>
    <sec id="sec4.2">
      <title>Implementation and Processing Time</title>
      <p>Although our method
involves repeating the similarity score computation for a large number
of candidate warpings to align a single spectrum, we keep the processing
time for a whole data set low by implementing the core part of MSIWarp
in efficient C++. Aligning the TOF kidney data set, consisting of
33 242 spectra with 244 peaks on average, took approximately
150 s when MSIWarp was run without RANSAC and in parallel mode on
a laptop with an Intel i7-6700HQ CPU (2.6 GHz) and 16 GB RAM. Aligning
the Orbitrap liver data set with the same settings took approximately
300 s. The parameter that has the largest impact on processing time
is the number of steps by which the warping nodes are shifted when
searching for the optimal warping. Given that the slack has been set
to capture the mass shift for all spectra, the number of steps corresponds
to the resolution of the warping function. We found that a step size
of 0.05–0.10 times the peak FWHM gives a sufficient alignment
resolution. If the search space of the warping function is ±2
FWHM, this results in 40–80 steps for each warping node. The
source code of MSIWarp along with Python bindings are available at <uri xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://github.com/horvatovichlab/MSIWarp">https://github.com/horvatovichlab/MSIWarp</uri>. Our goal is to make it possible to interface MSIWarp with existing
MSI analysis packages such as MALDIquant,<sup><xref ref-type="bibr" rid="ref27">27</xref></sup> Cardinal,<sup><xref ref-type="bibr" rid="ref28">28</xref></sup> and rMSIproc.<sup><xref ref-type="bibr" rid="ref29">29</xref></sup></p>
    </sec>
  </sec>
  <sec id="sec5">
    <title>Conclusions</title>
    <p>We have presented an
approach, MSIWarp, that readily improves relative
alignment in both TOF and Orbitrap data sets that together represent
a large variety of MSI experimental setups. Even the severe misalignment
in the TOF kidney data set is brought down to a level that enables
separation of peaks close in <italic>m</italic>/<italic>z</italic>. With a median mass dispersion of 6.48 ppm (and below 5 ppm for
more than half of the peaks) in the TOF spheroid data set, MSIWarp
matches the alignment performance of methods that rely on profile
spectra using only centroided spectra. While the largest improvements
in relative mass alignment can be gained for TOF spectra, our results
suggest that MSIWarp can further improve the already high mass alignment
in Orbitrap data sets. By investigating the effect of spurious peak
matches with RANSAC, we have also shown that MSIWarp is robust and
performs well even for most peak-sparse spectra. Finally, we believe
that a careful assessment of mass alignment is critical when analyzing
MSI data sets. Tools such as scatter plots of peak mass and acquisition
time, scatter plots of mass shift between individual pairs of spectra,
and images of mass shift as a function of tissue location for individual
peaks provide a way to do this in a simple manner.</p>
    <p>Although
MSIWarp has demonstrated significant benefits in analyzing
MSI data sets, there are several research paths that could yield additional
improvements. Currently, the output of MSIWarp is an <italic>m</italic>/<italic>z</italic> recalibration function for each data set spectrum.
It is important to highlight that even though this function is found
by searching for the optimal alignment between a pair of centroided
spectra, it can also be used to align the corresponding profile spectra.
Conceptually, the recalibration function could also be found by directly
computing the correlation integral between the profile spectra, if
available, instead of using our analytical expression based on the
overlap of centroided peaks. This would allow MSIWarp to utilize subtle
features in the profile data, such as peak shape, that may be lost
in the peak-picking step. Another possible enhancement is to create
a hybrid approach by combining MSIWarp with existing calibration strategies
to improve absolute mass accuracy in addition to relative mass alignment.
To do this, a spectrum with accurate masses should be used as a reference,
and if no such spectrum is available, the reference spectrum can be
chosen based on other criteria and calibrated prior to alignment.
Together, these approaches represent a rich area of research that
would allow interesting comparisons of related techniques and potential
for even further improvements in performance.</p>
  </sec>
</body>
<back>
  <notes id="notes-1" notes-type="si">
    <title>Supporting Information Available</title>
    <p>The Supporting Information
is available free of charge at <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="https://pubs.acs.org/doi/10.1021/acs.analchem.0c03833?goto=supporting-info">https://pubs.acs.org/doi/10.1021/acs.analchem.0c03833</ext-link>.<list id="silist" list-type="simple"><list-item><p>Description of the TOF
kidney, TOF spheroids, Orbitrap
liver, and Orbitrap DESI data sets. Tables S1 and S2, median mass
dispersions of mean spectrum peaks from the TOF kidney and Orbitrap
liver data sets after alignment with various values of σ and
ϵ. Figure S1, TIC images for the four MSI data sets. Figure
S2, RANSAC outlier detection results for three example spectra from
the TOF kidney data set. Figures S3–S13, scatter plots of peak
mass and acquisition time for mean spectrum peaks from the top 100,
50, 100, and 100 mean spectrum peaks’ TOF kidney, TOF spheroids,
Orbitrap liver and Orbitrap DESI data sets (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">PDF</ext-link>)</p></list-item><list-item><p>Ransac outlier detection animation
(<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_002.zip">ZIP</ext-link>)</p></list-item><list-item><p>Mean
spectrum dispersions (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_003.xlsx">XLSX</ext-link>)</p></list-item></list></p>
  </notes>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="sifile1">
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_si_001.pdf">
        <caption>
          <p>ac0c03833_si_001.pdf</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sifile2">
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_si_002.zip">
        <caption>
          <p>ac0c03833_si_002.zip</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sifile3">
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_si_003.xlsx">
        <caption>
          <p>ac0c03833_si_003.xlsx</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
  <notes notes-type="COI-statement" id="NOTES-d7e2460-autogenerated">
    <p>The
authors declare no
competing financial interest.</p>
  </notes>
  <ack>
    <title>Acknowledgments</title>
    <p>We acknowledge the support from Fru Berta Kamprads Stiftelse.
This research was part of the Netherlands X-omics Initiative and partially
funded by NWO, project 184.034.019. We also thank the reviewers for
their valuable feedback.</p>
  </ack>
  <ref-list>
    <title>References</title>
    <ref id="ref1">
      <mixed-citation publication-type="journal" id="cit1"><name><surname>Buchberger</surname><given-names>A. R.</given-names></name>; <name><surname>DeLaney</surname><given-names>K.</given-names></name>; <name><surname>Johnson</surname><given-names>J.</given-names></name>; <name><surname>Li</surname><given-names>L.</given-names></name><article-title>Mass spectrometry imaging:
a review of emerging advancements and future insights</article-title>. <source>Anal. Chem.</source><year>2018</year>, <volume>90</volume>, <fpage>240</fpage>–<lpage>265</lpage>. <pub-id pub-id-type="doi">10.1021/acs.analchem.7b04733</pub-id>.<pub-id pub-id-type="pmid">29155564</pub-id></mixed-citation>
    </ref>
    <ref id="ref2">
      <mixed-citation publication-type="journal" id="cit2"><name><surname>Gilmore</surname><given-names>I. S.</given-names></name>; <name><surname>Heiles</surname><given-names>S.</given-names></name>; <name><surname>Pieterse</surname><given-names>C. L.</given-names></name><article-title>Metabolic
imaging at the single-cell
scale: recent advances in mass spectrometry imaging</article-title>. <source>Annu. Rev. Anal. Chem.</source><year>2019</year>, <volume>12</volume>, <fpage>201</fpage>–<lpage>224</lpage>. <pub-id pub-id-type="doi">10.1146/annurev-anchem-061318-115516</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref3">
      <mixed-citation publication-type="journal" id="cit3"><name><surname>Han</surname><given-names>J.</given-names></name>; <name><surname>Permentier</surname><given-names>H.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Groothuis</surname><given-names>G.</given-names></name>; <name><surname>Casini</surname><given-names>A.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Imaging of
protein distribution in
tissues using mass spectrometry: An interdisciplinary challenge</article-title>. <source>TrAC, Trends Anal. Chem.</source><year>2019</year>, <volume>112</volume>, <fpage>13</fpage>–<lpage>28</lpage>. <pub-id pub-id-type="doi">10.1016/j.trac.2018.12.016</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref4">
      <mixed-citation publication-type="journal" id="cit4"><name><surname>Ryan</surname><given-names>D. J.</given-names></name>; <name><surname>Spraggins</surname><given-names>J. M.</given-names></name>; <name><surname>Caprioli</surname><given-names>R. M.</given-names></name><article-title>Protein identification
strategies
in MALDI imaging mass spectrometry: a brief review</article-title>. <source>Curr. Opin. Chem. Biol.</source><year>2019</year>, <volume>48</volume>, <fpage>64</fpage>–<lpage>72</lpage>. <pub-id pub-id-type="doi">10.1016/j.cbpa.2018.10.023</pub-id>.<pub-id pub-id-type="pmid">30476689</pub-id></mixed-citation>
    </ref>
    <ref id="ref5">
      <mixed-citation publication-type="journal" id="cit5"><name><surname>Verbeeck</surname><given-names>N.</given-names></name>; <name><surname>Caprioli</surname><given-names>R. M.</given-names></name>; <name><surname>Van de
Plas</surname><given-names>R.</given-names></name><article-title>Unsupervised machine learning for
exploratory data analysis in imaging mass spectrometry</article-title>. <source>Mass Spectrom. Rev.</source><year>2020</year>, <volume>39</volume>, <fpage>245</fpage>–<lpage>291</lpage>. <pub-id pub-id-type="doi">10.1002/mas.21602</pub-id>.<pub-id pub-id-type="pmid">31602691</pub-id></mixed-citation>
    </ref>
    <ref id="ref6">
      <mixed-citation publication-type="journal" id="cit6"><name><surname>Ràfols</surname><given-names>P.</given-names></name>; <name><surname>del Castillo</surname><given-names>E.</given-names></name>; <name><surname>Yanes</surname><given-names>O.</given-names></name>; <name><surname>Brezmes</surname><given-names>J.</given-names></name>; <name><surname>Correig</surname><given-names>X.</given-names></name><article-title>Novel automated
workflow for spectral alignment and mass calibration in MS imaging
using a sputtered Ag nanolayer</article-title>. <source>Anal. Chim.
Acta</source><year>2018</year>, <volume>1022</volume>, <fpage>61</fpage>–<lpage>69</lpage>. <pub-id pub-id-type="doi">10.1016/j.aca.2018.03.031</pub-id>.<pub-id pub-id-type="pmid">29729739</pub-id></mixed-citation>
    </ref>
    <ref id="ref7">
      <mixed-citation publication-type="journal" id="cit7"><name><surname>Gorshkov</surname><given-names>M. V.</given-names></name>; <name><surname>Good</surname><given-names>D. M.</given-names></name>; <name><surname>Lyutvinskiy</surname><given-names>Y.</given-names></name>; <name><surname>Yang</surname><given-names>H.</given-names></name>; <name><surname>Zubarev</surname><given-names>R. A.</given-names></name><article-title>Calibration
function for the Orbitrap FTMS accounting for the space charge effect</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2010</year>, <volume>21</volume>, <fpage>1846</fpage>–<lpage>1851</lpage>. <pub-id pub-id-type="doi">10.1016/j.jasms.2010.06.021</pub-id>.<pub-id pub-id-type="pmid">20696596</pub-id></mixed-citation>
    </ref>
    <ref id="ref8">
      <mixed-citation publication-type="journal" id="cit8"><name><surname>Kharchenko</surname><given-names>A.</given-names></name>; <name><surname>Vladimirov</surname><given-names>G.</given-names></name>; <name><surname>Heeren</surname><given-names>R. M.</given-names></name>; <name><surname>Nikolaev</surname><given-names>E. N.</given-names></name><article-title>Performance
of Orbitrap
mass analyzer at various space charge and non-ideal field conditions:
simulation approach</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2012</year>, <volume>23</volume>, <fpage>977</fpage>–<lpage>987</lpage>. <pub-id pub-id-type="doi">10.1007/s13361-011-0325-3</pub-id>.<pub-id pub-id-type="pmid">22354683</pub-id></mixed-citation>
    </ref>
    <ref id="ref9">
      <mixed-citation publication-type="journal" id="cit9"><name><surname>Boskamp</surname><given-names>T.</given-names></name>; <name><surname>Lachmund</surname><given-names>D.</given-names></name>; <name><surname>Casadonte</surname><given-names>R.</given-names></name>; <name><surname>Hauberg-Lotte</surname><given-names>L.</given-names></name>; <name><surname>Kobarg</surname><given-names>J. H.</given-names></name>; <name><surname>Kriegsmann</surname><given-names>J.</given-names></name>; <name><surname>Maass</surname><given-names>P.</given-names></name><article-title>Using the chemical
noise background in MALDI mass spectrometry imaging for mass alignment
and calibration</article-title>. <source>Anal. Chem.</source><year>2020</year>, <fpage>1301</fpage><pub-id pub-id-type="doi">10.1021/acs.analchem.9b04473</pub-id>.<pub-id pub-id-type="pmid">31793765</pub-id></mixed-citation>
    </ref>
    <ref id="ref10">
      <mixed-citation publication-type="journal" id="cit10"><name><surname>Bocker</surname><given-names>S.</given-names></name>; <name><surname>Makinen</surname><given-names>V.</given-names></name><article-title>Combinatorial approaches
for mass spectra recalibration</article-title>. <source>IEEE/ACM Trans.
Comput. Biol. Bioinf.</source><year>2008</year>, <volume>5</volume>, <fpage>91</fpage>–<lpage>100</lpage>. <pub-id pub-id-type="doi">10.1109/tcbb.2007.1077</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref11">
      <mixed-citation publication-type="journal" id="cit11"><name><surname>Kulkarni</surname><given-names>P.</given-names></name>; <name><surname>Kaftan</surname><given-names>F.</given-names></name>; <name><surname>Kynast</surname><given-names>P.</given-names></name>; <name><surname>Svatoš</surname><given-names>A.</given-names></name>; <name><surname>Böcker</surname><given-names>S.</given-names></name><article-title>Correcting mass shifts: a lock mass-free
recalibration
procedure for mass spectrometry imaging data</article-title>. <source>Anal. Bioanal. Chem.</source><year>2015</year>, <volume>407</volume>, <fpage>7603</fpage>–<lpage>7613</lpage>. <pub-id pub-id-type="doi">10.1007/s00216-015-8935-4</pub-id>.<pub-id pub-id-type="pmid">26345438</pub-id></mixed-citation>
    </ref>
    <ref id="ref12">
      <mixed-citation publication-type="journal" id="cit12"><name><surname>Tracy</surname><given-names>M. B.</given-names></name>; <name><surname>Chen</surname><given-names>H.</given-names></name>; <name><surname>Weaver</surname><given-names>D. M.</given-names></name>; <name><surname>Malyarenko</surname><given-names>D. I.</given-names></name>; <name><surname>Sasinowski</surname><given-names>M.</given-names></name>; <name><surname>Cazares</surname><given-names>L. H.</given-names></name>; <name><surname>Drake</surname><given-names>R. R.</given-names></name>; <name><surname>Semmes</surname><given-names>O. J.</given-names></name>; <name><surname>Tracy</surname><given-names>E. R.</given-names></name>; <name><surname>Cooke</surname><given-names>W. E.</given-names></name><article-title>Precision enhancement of MALDI-TOF
MS using high resolution peak detection and label-free alignment</article-title>. <source>Proteomics</source><year>2008</year>, <volume>8</volume>, <fpage>1530</fpage>–<lpage>1538</lpage>. <pub-id pub-id-type="doi">10.1002/pmic.200701146</pub-id>.<pub-id pub-id-type="pmid">18340636</pub-id></mixed-citation>
    </ref>
    <ref id="ref13">
      <mixed-citation publication-type="journal" id="cit13"><name><surname>Barry</surname><given-names>J. A.</given-names></name>; <name><surname>Robichaud</surname><given-names>G.</given-names></name>; <name><surname>Muddiman</surname><given-names>D. C.</given-names></name><article-title>Mass recalibration of FT-ICR mass
spectrometry imaging data using the average frequency shift of ambient
ions</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2013</year>, <volume>24</volume>, <fpage>1137</fpage>–<lpage>1145</lpage>. <pub-id pub-id-type="doi">10.1007/s13361-013-0659-0</pub-id>.<pub-id pub-id-type="pmid">23715870</pub-id></mixed-citation>
    </ref>
    <ref id="ref14">
      <mixed-citation publication-type="journal" id="cit14"><name><surname>Alexandrov</surname><given-names>T.</given-names></name><article-title>Spatial Metabolomics
and Imaging Mass Spectrometry in the Age of Artificial Intelligence</article-title>. <source>Annu. Rev. Biomed. Data Sci.</source><year>2020</year>, <volume>3</volume>, <fpage>61</fpage><pub-id pub-id-type="doi">10.1146/annurev-biodatasci-011420-031537</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref15">
      <mixed-citation publication-type="journal" id="cit15"><name><surname>Haug</surname><given-names>K.</given-names></name>; <name><surname>Salek</surname><given-names>R. M.</given-names></name>; <name><surname>Conesa</surname><given-names>P.</given-names></name>; <name><surname>Hastings</surname><given-names>J.</given-names></name>; <name><surname>De Matos</surname><given-names>P.</given-names></name>; <name><surname>Rijnbeek</surname><given-names>M.</given-names></name>; <name><surname>Mahendraker</surname><given-names>T.</given-names></name>; <name><surname>Williams</surname><given-names>M.</given-names></name>; <name><surname>Neumann</surname><given-names>S.</given-names></name>; <name><surname>Rocca-Serra</surname><given-names>P.</given-names></name>; et al. <article-title>MetaboLights–an open-access general-purpose
repository for metabolomics studies and associated meta-data</article-title>. <source>Nucleic Acids Res.</source><year>2013</year>, <volume>41</volume>, <fpage>D781</fpage>–<lpage>D786</lpage>. <pub-id pub-id-type="doi">10.1093/nar/gks1004</pub-id>.<pub-id pub-id-type="pmid">23109552</pub-id></mixed-citation>
    </ref>
    <ref id="ref16">
      <mixed-citation publication-type="journal" id="cit16"><name><surname>Alexandrov</surname><given-names>T.</given-names></name>; <name><surname>Ovchnnikova</surname><given-names>K.</given-names></name>; <name><surname>Palmer</surname><given-names>A.</given-names></name>; <name><surname>Kovalev</surname><given-names>V.</given-names></name>; <name><surname>Tarasov</surname><given-names>A.</given-names></name>; <name><surname>Stuart</surname><given-names>L.</given-names></name>; <name><surname>Nigmetzianov</surname><given-names>R.</given-names></name>; <name><surname>Fay</surname><given-names>D.</given-names></name>; <name><surname>Contributors</surname><given-names>K. M.</given-names></name><article-title>METASPACE:
A community-populated knowledge base of spatial metabolomes in health
and disease</article-title>. <source>BioRxiv</source><year>2019</year>, <elocation-id>539478</elocation-id><pub-id pub-id-type="doi">10.1101/539478</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref17">
      <mixed-citation publication-type="journal" id="cit17"><name><surname>Nielsen</surname><given-names>N.-P. V.</given-names></name>; <name><surname>Carstensen</surname><given-names>J. M.</given-names></name>; <name><surname>Smedsgaard</surname><given-names>J.</given-names></name><article-title>Aligning of
single and multiple wavelength chromatographic profiles for chemometric
data analysis using correlation optimised warping</article-title>. <source>J. Chromatogr. A</source><year>1998</year>, <volume>805</volume>, <fpage>17</fpage>–<lpage>35</lpage>. <pub-id pub-id-type="doi">10.1016/S0021-9673(98)00021-1</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref18">
      <mixed-citation publication-type="journal" id="cit18"><name><surname>Christin</surname><given-names>C.</given-names></name>; <name><surname>Smilde</surname><given-names>A. K.</given-names></name>; <name><surname>Hoefsloot</surname><given-names>H. C.</given-names></name>; <name><surname>Suits</surname><given-names>F.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P. L.</given-names></name><article-title>Optimized
time alignment algorithm for LC-MS data:
correlation optimized warping using component detection algorithm-selected
mass chromatograms</article-title>. <source>Anal. Chem.</source><year>2008</year>, <volume>80</volume>, <fpage>7012</fpage>–<lpage>7021</lpage>. <pub-id pub-id-type="doi">10.1021/ac800920h</pub-id>.<pub-id pub-id-type="pmid">18715018</pub-id></mixed-citation>
    </ref>
    <ref id="ref19">
      <mixed-citation publication-type="journal" id="cit19"><name><surname>Suits</surname><given-names>F.</given-names></name>; <name><surname>Lepre</surname><given-names>J.</given-names></name>; <name><surname>Du</surname><given-names>P.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Two-Dimensional
Method for Time Aligning Liquid Chromatography- Mass Spectrometry
Data</article-title>. <source>Anal. Chem.</source><year>2008</year>, <volume>80</volume>, <fpage>3095</fpage>–<lpage>3104</lpage>. <pub-id pub-id-type="doi">10.1021/ac702267h</pub-id>.<pub-id pub-id-type="pmid">18396914</pub-id></mixed-citation>
    </ref>
    <ref id="ref20">
      <mixed-citation publication-type="journal" id="cit20"><name><surname>Fischler</surname><given-names>M. A.</given-names></name>; <name><surname>Bolles</surname><given-names>R. C.</given-names></name><article-title>Random sample consensus: a paradigm for model fitting
with applications to image analysis and automated cartography</article-title>. <source>Commun. ACM</source><year>1981</year>, <volume>24</volume>, <fpage>381</fpage>–<lpage>395</lpage>. <pub-id pub-id-type="doi">10.1145/358669.358692</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref21">
      <mixed-citation publication-type="journal" id="cit21"><name><surname>Suits</surname><given-names>F.</given-names></name>; <name><surname>Hoekman</surname><given-names>B.</given-names></name>; <name><surname>Rosenling</surname><given-names>T.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Threshold-avoiding
proteomics pipeline</article-title>. <source>Anal. Chem.</source><year>2011</year>, <volume>83</volume>, <fpage>7786</fpage>–<lpage>7794</lpage>. <pub-id pub-id-type="doi">10.1021/ac201332j</pub-id>.<pub-id pub-id-type="pmid">21879761</pub-id></mixed-citation>
    </ref>
    <ref id="ref22">
      <mixed-citation publication-type="journal" id="cit22"><name><surname>Noh</surname><given-names>S. A.</given-names></name>; <name><surname>Kim</surname><given-names>S.-M.</given-names></name>; <name><surname>Park</surname><given-names>S. H.</given-names></name>; <name><surname>Kim</surname><given-names>D.-J.</given-names></name>; <name><surname>Lee</surname><given-names>J. W.</given-names></name>; <name><surname>Kim</surname><given-names>Y. G.</given-names></name>; <name><surname>Moon</surname><given-names>J.-Y.</given-names></name>; <name><surname>Lim</surname><given-names>S.-J.</given-names></name>; <name><surname>Lee</surname><given-names>S.-H.</given-names></name>; <name><surname>Kim</surname><given-names>K. P.</given-names></name><article-title>Alterations in Lipid Profile of the Aging Kidney Identified
by MALDI Imaging Mass Spectrometry</article-title>. <source>J. Proteome
Res.</source><year>2019</year>, <volume>18</volume>, <fpage>2803</fpage>–<lpage>2812</lpage>. <pub-id pub-id-type="doi">10.1021/acs.jproteome.9b00108</pub-id>.<pub-id pub-id-type="pmid">31244212</pub-id></mixed-citation>
    </ref>
    <ref id="ref23">
      <mixed-citation publication-type="journal" id="cit23"><name><surname>Mittal</surname><given-names>P.</given-names></name>; <name><surname>Price</surname><given-names>Z. K.</given-names></name>; <name><surname>Lokman</surname><given-names>N. A.</given-names></name>; <name><surname>Ricciardelli</surname><given-names>C.</given-names></name>; <name><surname>Oehler</surname><given-names>M. K.</given-names></name>; <name><surname>Klingler-Hoffmann</surname><given-names>M.</given-names></name>; <name><surname>Hoffmann</surname><given-names>P.</given-names></name><article-title>Matrix Assisted Laser
Desorption/Ionization Mass Spectrometry Imaging (MALDI MSI) for Monitoring
of Drug Response in Primary Cancer Spheroids</article-title>. <source>Proteomics</source><year>2019</year>, <volume>19</volume>, <elocation-id>1900146</elocation-id><pub-id pub-id-type="doi">10.1002/pmic.201900146</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref24">
      <mixed-citation publication-type="journal" id="cit24"><name><surname>Eriksson</surname><given-names>J. O.</given-names></name>; <name><surname>Rezeli</surname><given-names>M.</given-names></name>; <name><surname>Hefner</surname><given-names>M.</given-names></name>; <name><surname>Marko-Varga</surname><given-names>G.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Clusterwise peak detection and filtering
based on spatial
distribution to efficiently mine mass spectrometry imaging data</article-title>. <source>Anal. Chem.</source><year>2019</year>, <volume>91</volume>, <fpage>11888</fpage>–<lpage>11896</lpage>. <pub-id pub-id-type="doi">10.1021/acs.analchem.9b02637</pub-id>.<pub-id pub-id-type="pmid">31403280</pub-id></mixed-citation>
    </ref>
    <ref id="ref25">
      <mixed-citation publication-type="journal" id="cit25"><name><surname>Gerbig</surname><given-names>S.</given-names></name>; <name><surname>Golf</surname><given-names>O.</given-names></name>; <name><surname>Balog</surname><given-names>J.</given-names></name>; <name><surname>Denes</surname><given-names>J.</given-names></name>; <name><surname>Baranyai</surname><given-names>Z.</given-names></name>; <name><surname>Zarand</surname><given-names>A.</given-names></name>; <name><surname>Raso</surname><given-names>E.</given-names></name>; <name><surname>Timar</surname><given-names>J.</given-names></name>; <name><surname>Takats</surname><given-names>Z.</given-names></name><article-title>Analysis of
colorectal adenocarcinoma tissue by desorption electrospray ionization
mass spectrometric imaging</article-title>. <source>Anal. Bioanal. Chem.</source><year>2012</year>, <volume>403</volume>, <fpage>2315</fpage>–<lpage>2325</lpage>. <pub-id pub-id-type="doi">10.1007/s00216-012-5841-x</pub-id>.<pub-id pub-id-type="pmid">22447214</pub-id></mixed-citation>
    </ref>
    <ref id="ref26">
      <mixed-citation publication-type="journal" id="cit26"><name><surname>Robichaud</surname><given-names>G.</given-names></name>; <name><surname>Garrard</surname><given-names>K. P.</given-names></name>; <name><surname>Barry</surname><given-names>J. A.</given-names></name>; <name><surname>Muddiman</surname><given-names>D. C.</given-names></name><article-title>MSiReader: an open-source
interface to view and analyze high resolving power MS imaging files
on Matlab platform</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2013</year>, <volume>24</volume>, <fpage>718</fpage>–<lpage>721</lpage>. <pub-id pub-id-type="doi">10.1007/s13361-013-0607-z</pub-id>.<pub-id pub-id-type="pmid">23536269</pub-id></mixed-citation>
    </ref>
    <ref id="ref27">
      <mixed-citation publication-type="journal" id="cit27"><name><surname>Gibb</surname><given-names>S.</given-names></name>; <name><surname>Strimmer</surname><given-names>K.</given-names></name><article-title>MALDIquant: a versatile
R package for the analysis
of mass spectrometry data</article-title>. <source>Bioinformatics</source><year>2012</year>, <volume>28</volume>, <fpage>2270</fpage>–<lpage>2271</lpage>. <pub-id pub-id-type="doi">10.1093/bioinformatics/bts447</pub-id>.<pub-id pub-id-type="pmid">22796955</pub-id></mixed-citation>
    </ref>
    <ref id="ref28">
      <mixed-citation publication-type="journal" id="cit28"><name><surname>Bemis</surname><given-names>K. D.</given-names></name>; <name><surname>Harry</surname><given-names>A.</given-names></name>; <name><surname>Eberlin</surname><given-names>L. S.</given-names></name>; <name><surname>Ferreira</surname><given-names>C.</given-names></name>; <name><surname>van de Ven</surname><given-names>S. M.</given-names></name>; <name><surname>Mallick</surname><given-names>P.</given-names></name>; <name><surname>Stolowitz</surname><given-names>M.</given-names></name>; <name><surname>Vitek</surname><given-names>O.</given-names></name><article-title>Cardinal: an R package
for statistical analysis of mass spectrometry-based imaging experiments</article-title>. <source>Bioinformatics</source><year>2015</year>, <volume>31</volume>, <fpage>2418</fpage>–<lpage>2420</lpage>. <pub-id pub-id-type="doi">10.1093/bioinformatics/btv146</pub-id>.<pub-id pub-id-type="pmid">25777525</pub-id></mixed-citation>
    </ref>
    <ref id="ref29">
      <mixed-citation publication-type="journal" id="cit29"><name><surname>Ràfols</surname><given-names>P.</given-names></name>; <name><surname>Heijs</surname><given-names>B.</given-names></name>; <name><surname>del Castillo</surname><given-names>E.</given-names></name>; <name><surname>Yanes</surname><given-names>O.</given-names></name>; <name><surname>McDonnell</surname><given-names>L. A.</given-names></name>; <name><surname>Brezmes</surname><given-names>J.</given-names></name>; <name><surname>Pérez-Taboada</surname><given-names>I.</given-names></name>; <name><surname>Vallejo</surname><given-names>M.</given-names></name>; <name><surname>García-Altares</surname><given-names>M.</given-names></name>; <name><surname>Correig</surname><given-names>X.</given-names></name><article-title>rMSIproc: an R package
for mass spectrometry imaging data processing</article-title>. <source>Bioinformatics</source><year>2020</year>, <volume>36</volume>, <fpage>3618</fpage>–<lpage>3619</lpage>. <pub-id pub-id-type="doi">10.1093/bioinformatics/btaa142</pub-id>.<pub-id pub-id-type="pmid">32108859</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//ACS//DTD ACS Journal DTD v1.02 20061031//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName ACSJournal-v102.dtd?>
<?SourceDTD.Version 1.02?>
<?ConverterInfo.XSLTName acs2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Anal Chem</journal-id>
    <journal-id journal-id-type="iso-abbrev">Anal Chem</journal-id>
    <journal-id journal-id-type="publisher-id">ac</journal-id>
    <journal-id journal-id-type="coden">ancham</journal-id>
    <journal-title-group>
      <journal-title>Analytical Chemistry</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">0003-2700</issn>
    <issn pub-type="epub">1520-6882</issn>
    <publisher>
      <publisher-name>American
Chemical
Society</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">7745203</article-id>
    <article-id pub-id-type="pmid">33317272</article-id>
    <article-id pub-id-type="doi">10.1021/acs.analchem.0c03833</article-id>
    <article-categories>
      <subj-group>
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>MSIWarp: A General Approach to Mass Alignment in Mass
Spectrometry Imaging</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" id="ath1">
        <name>
          <surname>Eriksson</surname>
          <given-names>Jonatan
O.</given-names>
        </name>
        <xref rid="aff1" ref-type="aff">†</xref>
      </contrib>
      <contrib contrib-type="author" id="ath2">
        <name>
          <surname>Sánchez Brotons</surname>
          <given-names>Alejandro</given-names>
        </name>
        <xref rid="aff2" ref-type="aff">‡</xref>
      </contrib>
      <contrib contrib-type="author" id="ath3">
        <name>
          <surname>Rezeli</surname>
          <given-names>Melinda</given-names>
        </name>
        <xref rid="aff1" ref-type="aff">†</xref>
      </contrib>
      <contrib contrib-type="author" id="ath4">
        <name>
          <surname>Suits</surname>
          <given-names>Frank</given-names>
        </name>
        <xref rid="aff3" ref-type="aff">§</xref>
      </contrib>
      <contrib contrib-type="author" id="ath5">
        <name>
          <surname>Markó-Varga</surname>
          <given-names>György</given-names>
        </name>
        <xref rid="aff1" ref-type="aff">†</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes" id="ath6">
        <name>
          <surname>Horvatovich</surname>
          <given-names>Peter</given-names>
        </name>
        <xref rid="cor1" ref-type="other">*</xref>
        <xref rid="aff1" ref-type="aff">†</xref>
        <xref rid="aff2" ref-type="aff">‡</xref>
      </contrib>
      <aff id="aff1"><label>†</label>Department
of Biomedical Engineering, <institution>Lund University</institution>, Lund 221 00, <country>Sweden</country></aff>
      <aff id="aff2"><label>‡</label>Department
of Analytical Biochemistry, Groningen Research Institute of Pharmacy, <institution>University of Groningen</institution>, Antonius Deusinglaan 1, 9713 AV Groningen, <country>The Netherlands</country></aff>
      <aff id="aff3"><label>§</label><institution>IBM
Research - Australia</institution>, 60 City Road, Southbank, VIC 3006, <country>Australia</country></aff>
    </contrib-group>
    <author-notes>
      <corresp id="cor1"><label>*</label>Email: <email>p.l.horvatovich@rug.nl</email>.</corresp>
    </author-notes>
    <pub-date pub-type="epub">
      <day>02</day>
      <month>12</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <day>15</day>
      <month>12</month>
      <year>2020</year>
    </pub-date>
    <volume>92</volume>
    <issue>24</issue>
    <fpage>16138</fpage>
    <lpage>16148</lpage>
    <history>
      <date date-type="received">
        <day>09</day>
        <month>09</month>
        <year>2020</year>
      </date>
      <date date-type="accepted">
        <day>16</day>
        <month>11</month>
        <year>2020</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© 2020 American Chemical Society</copyright-statement>
      <copyright-year>2020</copyright-year>
      <copyright-holder>American Chemical
Society</copyright-holder>
      <license>
        <license-p>This is an open access article published under a Creative Commons Non-Commercial No Derivative Works (CC-BY-NC-ND) Attribution <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/page/policy/authorchoice_ccbyncnd_termsofuse.html">License</ext-link>, which permits copying and redistribution of the article, and creation of adaptations, all for non-commercial purposes.</license-p>
      </license>
    </permissions>
    <abstract>
      <p content-type="toc-graphic">
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0008" id="ab-tgr1"/>
      </p>
      <p>Mass spectrometry imaging (MSI) is
a technique that provides comprehensive
molecular information with high spatial resolution from tissue. Today,
there is a strong push toward sharing data sets through public repositories
in many research fields where MSI is commonly applied; yet, there
is no standardized protocol for analyzing these data sets in a reproducible
manner. Shifts in the mass-to-charge ratio (<italic>m</italic>/<italic>z</italic>) of molecular peaks present a major obstacle that can
make it impossible to distinguish one compound from another. Here,
we present a label-free <italic>m</italic>/<italic>z</italic> alignment
approach that is compatible with multiple instrument types and makes
no assumptions on the sample’s molecular composition. Our approach,
MSIWarp (<uri xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://github.com/horvatovichlab/MSIWarp">https://github.com/horvatovichlab/MSIWarp</uri>), finds an <italic>m</italic>/<italic>z</italic> recalibration function
by maximizing a similarity score that considers both the intensity
and <italic>m</italic>/<italic>z</italic> position of peaks matched
between two spectra. MSIWarp requires only centroid spectra to find
the recalibration function and is thereby readily applicable to almost
any MSI data set. To deal with particularly misaligned or peak-sparse
spectra, we provide an option to detect and exclude spurious peak
matches with a tailored random sample consensus (RANSAC) procedure.
We evaluate our approach with four publicly available data sets from
both time-of-flight (TOF) and Orbitrap instruments and demonstrate
up to 88% improvement in <italic>m</italic>/<italic>z</italic> alignment.</p>
    </abstract>
    <custom-meta-group>
      <custom-meta>
        <meta-name>document-id-old-9</meta-name>
        <meta-value>ac0c03833</meta-value>
      </custom-meta>
      <custom-meta>
        <meta-name>document-id-new-14</meta-name>
        <meta-value>ac0c03833</meta-value>
      </custom-meta>
      <custom-meta>
        <meta-name>ccc-price</meta-name>
        <meta-value/>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="sec1">
    <title>Introduction</title>
    <p>Mass spectrometry (MS)
is a widespread analytical technique used
to detect and quantify ionized molecules, and it has many applications
in biology, chemistry, and medicine. In MS imaging (MSI), molecular
ions are sampled from different locations on a surface area, such
as a tissue section, allowing the mass spectrometer to serve as a
molecular imaging device. The ability to determine the spatial distribution
of thousands of biological compounds in a single experiment makes
MSI a powerful tool for tissue characterization. There have been extensive
developments in the MSI field during the last decades, resulting in
new experimental workflows, improved ionization and sampling methods,
and advances in both the spatial and mass resolutions of instruments.<sup><xref ref-type="bibr" rid="ref1">1</xref>−<xref ref-type="bibr" rid="ref3">3</xref></sup> The availability of a wide variety of ionization techniques such
as secondary-ion MS (SIMS), desorption electrospray ionization (DESI),
and matrix-assisted laser desorption/ionization (MALDI) allows ionization
of many compound classes with both targeted and untargeted approaches.<sup><xref ref-type="bibr" rid="ref1">1</xref></sup> High-performance Orbitrap and Fourier transform
ion cyclotron resonance (FT-ICR) mass analyzers can scan tissue sections
with a subcellular spatial resolution and a mass resolution exceeding
500 000. Low sensitivity has been a longstanding obstacle for
high-spatial-resolution MSI but has recently been improved by optimizing
the laser wavelength in MALDI to increase ionization efficiency, or
by post-ionizing neutral molecules to increase ion yield.<sup><xref ref-type="bibr" rid="ref2">2</xref></sup> Novel sample preparation workflows have led to
enhanced quantification and identification of metabolites, peptides,
and proteins. These include protein extraction methods, in situ protease
digestion of proteins, and the use of chemical derivatization such
as labeling with photocleavable mass tags to enhance low-intensity
molecule signals.<sup><xref ref-type="bibr" rid="ref3">3</xref>,<xref ref-type="bibr" rid="ref4">4</xref></sup> Altogether, this leads to highly
complex data sets that demand accurate preprocessing and sophisticated
bioinformatic analysis to maximize their utility in biological and
clinical research.<sup><xref ref-type="bibr" rid="ref5">5</xref></sup></p>
    <p>A persisting
issue in MSI is systematic mass misalignment, leading
to slight shifts in the <italic>m</italic>/<italic>z</italic> ratio
of molecule peaks across spectra. These shifts can result in misidentified
peaks or an increased risk of mixing peaks from different molecules
with similar masses in the same ion image. Mass misalignment is typically
more severe for time-of-flight (TOF) instruments than for FT-ICR,
Orbitrap, or other Fourier transform (FT) instruments.<sup><xref ref-type="bibr" rid="ref6">6</xref></sup> Variations in temperature throughout the experiment, contractions
and dilatations of the ion tube, contamination of the ion source,
and tissue topography are some factors that are related to mass shifts
in spectra generated by TOF instruments. For FT instruments, the most
common source of mass misalignment is the space-charge effect, which
causes mass shifts that increase with the number of ions in the trap.<sup><xref ref-type="bibr" rid="ref7">7</xref>,<xref ref-type="bibr" rid="ref8">8</xref></sup> The mass shifts in FT instruments can often be limited using automatic
gain control (AGC), but can be considerable if suboptimal AGC settings
are used.</p>
    <p>When discussing mass misalignment and mass shifts,
it is important
to distinguish between relative mass alignment and absolute mass accuracy.
Here, the former refers to how tightly peak masses are distributed
across spectra, while the latter refers to the difference between
a molecule’s theoretical peak mass and its observed peak mass.
A common approach to correct mass shifts is to perform either external
or internal calibration by comparing the measured masses of predefined
peaks to their expected theoretical masses. External calibration is
performed by depositing a calibration standard outside the tissue
region and comparing the measured peak masses to the known masses
of the calibrants. The same calibration function is then applied to
all tissue spectra. While this approach is simple, it does not reduce
the relative misalignment or correct mass shifts introduced during
the experiment. Internal calibration, on the other hand, relies on
identifying known peaks in each tissue spectrum. The known peaks can
be either prominent molecule peaks intrinsic to the tissue or peaks
corresponding to calibrants sprayed on the whole tissue area. Internal
calibration can improve both the relative alignment between spectra
and absolute mass accuracy but performs poorly for spectra in which
the calibration peaks are missing or incorrectly assigned.<sup><xref ref-type="bibr" rid="ref9">9</xref></sup></p>
    <p>An alternative approach is to align all
spectra to a common reference
spectrum. Given that the absolute mass accuracy of the reference spectrum
is high, this can reduce relative misalignment and improve absolute
mass accuracy simultaneously. A simple approach to aligning one spectrum
to another is fitting a polynomial recalibration function to the mass
difference of their shared peaks and then using this recalibration
function to recalibrate all peak masses. While this approach is flexible,
it is highly sensitive to spurious peak matches. Bocker and Makinen<sup><xref ref-type="bibr" rid="ref10">10</xref></sup> introduced a linear curve-fitting approach that
is robust to spurious peak matches, and Kulkarni et al.<sup><xref ref-type="bibr" rid="ref11">11</xref></sup> later used this approach, together with spatial
information, to further improve mass alignment. More recently, there
has been increased focus on mass alignment for TOF instruments. Ráfols
et al.<sup><xref ref-type="bibr" rid="ref6">6</xref></sup> proposed an alignment algorithm
that uses the cross-correlation between two spectra in the upper and
lower parts of the mass range to estimate mass shift. They then use
the upper and lower shifts to recalibrate the mass axis of one of
the spectra to that of the other. Boskamp et al.<sup><xref ref-type="bibr" rid="ref9">9</xref></sup> elegantly exploit statistical properties of the peptide
background signal to improve mass alignment and absolute mass accuracy.
They estimate the mass shift across the <italic>m</italic>/<italic>z</italic> range by comparing observed to theoretical peak masses
on the Kendrick mass scale. Unlike Ráfols et al.’s method,
their method can correct nonlinear mass shifts, but the dependency
on the peptide background limits its generalizability.</p>
    <p>Another
aspect of mass alignment is at which stage in the processing
pipeline it is performed. It can be performed in the time domain for
TOF spectra, in the frequency domain for FT spectra, using profile
mass spectra, or using centroided mass spectra.<sup><xref ref-type="bibr" rid="ref6">6</xref>,<xref ref-type="bibr" rid="ref10">10</xref>,<xref ref-type="bibr" rid="ref12">12</xref>,<xref ref-type="bibr" rid="ref13">13</xref></sup> In principle,
aligning spectra at an early stage is advantageous in the sense that
errors are not accumulated in subsequent processing steps. In practice,
however, time or frequency spectra are often inaccessible as vendor
software typically only provide mass spectra, and the majority of
data sets uploaded to repositories are processed to some extent. FT
spectra, in particular, are often centroided to reduce their otherwise
impractical size.<sup><xref ref-type="bibr" rid="ref14">14</xref></sup> It is impossible to
recover a raw spectrum from one that has been processed. Hence, an
approach must be able to perform alignment with processed spectra
to be compatible with most MSI data sets. This compatibility is essential;
data sets generated independently in other labs are frequently used
to validate biological findings or novel methods. A public data set
may be generated with any instrument and additional processing is
sometimes required to ensure its quality. This compatibility requirement,
together with the growing popularity of public MSI data set repositories
such as MetaboLights<sup><xref ref-type="bibr" rid="ref15">15</xref></sup> or METASPACE,<sup><xref ref-type="bibr" rid="ref16">16</xref></sup> creates a demand for algorithms that can perform
accurate mass alignment on spectra acquired with multiple instrument
types and regardless of whether they are already partially processed.</p>
    <p>In this work, we adapt the correlation optimized warping (COW)<sup><xref ref-type="bibr" rid="ref17">17</xref></sup> algorithm to perform label-free MSI mass alignment
using a custom benefit function and show that we can greatly reduce
variation in peak masses between spectra. COW aligns a pair of signals
by performing local warpings on one signal so that the global similarity
relative to the other is maximized. We have previously shown that
COW is effective in reducing misalignment in the time dimension between
liquid chromatography–mass spectrometry (LC-MS) sample runs.<sup><xref ref-type="bibr" rid="ref18">18</xref>,<xref ref-type="bibr" rid="ref19">19</xref></sup> Here, we instead use COW to reduce mass misalignment between spectra
by warping the mass dimension.</p>
    <p>Crucially, our method finds the
optimal warping of one spectrum
relative to another using only a list of centroided peaks from each
spectrum. We model centroided peaks as Gaussians whose widths vary
with <italic>m</italic>/<italic>z</italic>, and define the similarity
between two spectra as the total overlap of their shared peaks. To
assess and further improve COW’s robustness for particularly
peak-sparse or misaligned spectra, we include an optional outlier
detection step in the form of a tailored random sample consensus (RANSAC)<sup><xref ref-type="bibr" rid="ref20">20</xref></sup> procedure. The concept of our method is similar
to that of Ráfols et al.,<sup><xref ref-type="bibr" rid="ref6">6</xref></sup> but differs
in two key aspects. First, we find the mass recalibration function
by maximizing the product (overlap) of centroided peaks instead of
the cross-correlation of continuous spectra. Second, our method can,
since it is derived from COW, correct nonlinear mass shifts. Thereby,
our method utilizes information about peak height and width (not simply
mass location) while remaining compatible with most MSI data sets.
We demonstrate the effectiveness and generalizability of our method,
named MSIWarp, by applying it to four publicly available data sets.
MSIWarp performs accurate and robust alignment with centroided spectra,
is compatible with multiple instrument types, and makes no assumptions
on the molecular composition of the sample. We provide a fast C++
implementation of MSIWarp together with a Python binding at <uri xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://github.com/horvatovichlab/MSIWarp">https://github.com/horvatovichlab/MSIWarp</uri>.</p>
  </sec>
  <sec id="sec2">
    <title>Theory</title>
    <p>The core of MSIWarp is a spectrum-to-spectrum similarity
score
that is used to find an optimal warping function between the mass
axis of one spectrum and that of another. To align an entire MSI data
set, all spectra, the sample spectra, are warped to a common reference
spectrum that can be selected from the data set, or be a composite
spectrum constructed from multiple spectra. Similar to our previous
work,<sup><xref ref-type="bibr" rid="ref19">19</xref></sup> MSIWarp deliberately relies on
centroided, i.e., peak-picked, spectra to perform alignment. Peak-picking
can improve alignment by retaining most compound-related signals while
removing background noise that degrades performance. More importantly,
however, an alignment method that takes centroided spectra as input
can trivially be used to align profile spectra, but not vice versa.
MSIWarp relies on centroid spectra instead of profile spectra and
is thereby readily applicable to almost any MSI data set.</p>
    <p>MSIWarp
can be summarized in three steps (<xref rid="fig1" ref-type="fig">Figure <xref rid="fig1" ref-type="fig">1</xref></xref>): first, we match the peaks of the sample
spectrum against those of the reference spectrum. Second, based on
the peak matches from step one, we split the <italic>m</italic>/<italic>z</italic> range in a manner that ensures there is sufficient shared
information in all segments. Finally, we find an optimal warping function
with the peak matches and the partitioning of the <italic>m</italic>/<italic>z</italic> range obtained in steps one and two, respectively,
and use this function to recalibrate the peak masses of the sample
spectrum.</p>
    <fig id="fig1" position="float">
      <label>Figure 1</label>
      <caption>
        <p>Conceptual description of MSIWarp. After matching the peaks in
the sample spectrum against those in the reference spectrum, the sample
spectrum is warped so that its similarity to the reference spectrum
is maximized. (A) Scatter of the mass shift between matched peaks
across the <italic>m</italic>/<italic>z</italic> range. The shifted
warping nodes are marked with vertical arrows (the actual search space
is centered around zero and extends beyond the arrows). The orange
curve shows the estimated mass shift based on our similarity score.
(B) The similarity score is evaluated for the set of candidate warpings,
and the warping resulting in the highest score is used to align the
sample spectrum. (C) Zoom-in of the spectra with the centroided peaks
modeled as Gaussians. Two sample spectrum peaks are matched to the
reference spectrum peak at 1207 <italic>m</italic>/<italic>z</italic>, but the spurious match (also marked in (A)) has no effect on the
warping.</p>
      </caption>
      <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0002" id="gr1" position="float"/>
    </fig>
    <sec id="sec2.1">
      <title>Mass Alignment</title>
      <p>Our method aligns
a pair of spectra
by warping one in the mass dimension so that its similarity to the
other is maximized. Provided that the type of mass spectrometer used
to generate the spectra is known, it requires only a list of peak
heights and <italic>m</italic>/<italic>z</italic> locations for each
spectrum. We model peak intensity as a Gaussian function of <italic>m</italic>/<italic>z</italic> with centroid mass μ and height <italic>H</italic>. With this peak model, we can then compute the similarity
of two centroided spectra as the sum of all pairwise peak overlaps,
and use this similarity score as a measure of alignment quality. To
model peak width, σ, we use known theoretical relationships
between peak width and <italic>m</italic>/<italic>z</italic>, together
with the mass resolution of the data set. The theoretical relationships
depend on instrument type and are summarized in Suits et al.<sup><xref ref-type="bibr" rid="ref21">21</xref></sup> If the mass resolution is unknown, a good estimate
of a single peak’s full width at half-maximum (FWHM) is enough
to model the width of all other peaks in the data set. While not a
true representation of a mass spectrum peak, the Gaussian peak model
is a sufficient approximation for the purpose of alignment. Similarly,
the modeled peak width does not have to match the true width exactly,
since its main purpose is to provide some freedom when matching and
aligning peaks.</p>
      <p><xref rid="eq1" ref-type="disp-formula">Equations <xref rid="eq1" ref-type="disp-formula">1</xref></xref>–<xref rid="eq4" ref-type="disp-formula">4</xref> formally define our Gaussian
peak model <italic>p</italic>, the overlap between two peaks <italic>I</italic>, and the similarity between two spectra, <italic>B</italic>. The intensity of a peak varies with <italic>m</italic>/<italic>z</italic> according to<disp-formula id="eq1"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m001" position="anchor"/><label>1</label></disp-formula>The
overlap of two peaks is<disp-formula id="eq2"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m002" position="anchor"/><label>2</label></disp-formula>The integral in <xref rid="eq2" ref-type="disp-formula">eq <xref rid="eq2" ref-type="disp-formula">2</xref></xref> can be solved analytically to yield<disp-formula id="eq3"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m003" position="anchor"/><label>3</label></disp-formula>where<disp-formula id="ueq1"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m004" position="anchor"/></disp-formula>and<disp-formula id="ueq2"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m005" position="anchor"/></disp-formula>The similarity
score, <italic>B</italic>,
between two spectra, <italic>S</italic><sub><italic>i</italic></sub> and <italic>S</italic><sub><italic>j</italic></sub>, is the sum
overlap of all matched peaks<disp-formula id="eq4"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m006" position="anchor"/><label>4</label></disp-formula>To compute
the similarity score between a
pair of spectra, the set of peak pairs that satisfy the condition
in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref> must be found.
A peak in the first spectrum is matched to one in the second spectrum
if their <italic>m</italic>/<italic>z</italic> locations are within
a small distance threshold, ϵ, of each other. Note that a peak
in one spectrum can be matched to multiple peaks in the other spectrum.
The threshold ϵ in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref> is proportional to the modeled peak width and therefore increases
with <italic>m</italic>/<italic>z</italic>.</p>
      <p>With our definition
of pairwise similarity between two centroided
spectra, we can search for an optimal warping from a set of candidate
warpings in a similar way as the original COW implementation. This
involves dividing the <italic>m</italic>/<italic>z</italic> range
into segments, evaluating <italic>B</italic> for all candidate warpings
for each segment independently, and then finding the optimal combination
of segment warpings. The analytical form of the integral in <xref rid="eq2" ref-type="disp-formula">eq <xref rid="eq2" ref-type="disp-formula">2</xref></xref> enables fast computation
of the similarity score, which is critical since it must be repeated
for each candidate warping. Here, we denote the lower and upper edges
of an <italic>m</italic>/<italic>z</italic> segment <italic>n</italic><sub>l</sub> and <italic>n</italic><sub>r</sub>, respectively, and
refer to them as the warping nodes of the segment. Note that each
warping node, except those at the lowest and highest ends of the <italic>m</italic>/<italic>z</italic> range, are shared by two segments.
To generate the set of candidate warpings for an <italic>m</italic>/<italic>z</italic> segment, the warping nodes at its edges are shifted
a fixed number of steps upward and downward in <italic>m</italic>/<italic>z</italic>. The set of warpings for that segment then corresponds
to all possible combinations of shifts of <italic>n</italic><sub>l</sub> and <italic>n</italic><sub>r</sub>. Computing <italic>B</italic> for a particular warping and segment is then performed by warping
the peaks in the segment and then computing <italic>B</italic> with
the warped peaks and the peaks from the corresponding segment in the
reference spectrum. Peaks are warped by updating their mass with linear
interpolation according to<disp-formula id="eq5"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m007" position="anchor"/><label>5</label></disp-formula>where<disp-formula id="ueq3"><graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_m008" position="anchor"/></disp-formula>μ is the original
peak mass, μ′
is the warped peak mass, and <italic>n</italic><sub>l</sub><sup arrange="stack">′</sup> and <italic>n</italic><sub>r</sub><sup arrange="stack">′</sup> are
the shifted positions of <italic>n</italic><sub>l</sub> and <italic>n</italic><sub>r</sub>, respectively. Note that while segments are
compressed, stretched, and/or shifted, a peak is never warped out
of its segment and its width and height are left untouched. Finally,
like in the original COW implementation,<sup><xref ref-type="bibr" rid="ref17">17</xref></sup> the optimal combination of warping node moves is found with dynamic
programming. The shift of a warping node is bounded by the slack parameter:
|<italic>n</italic>′ – <italic>n</italic>| ≤ <italic>m</italic><sub><italic>n</italic></sub>. The slack is reflected by
the amplitude of the warping function and should be sufficiently large
to capture the largest shifts. Like the peak matching threshold (ϵ
in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref>), <italic>m</italic> is proportional to FWHM and is computed for each warping node individually.</p>
      <p>By maximizing our similarity score, we find a piecewise linear
mass recalibration function with a degree of freedom determined by
the number of warping nodes. A large number of short segments gives
a flexible warping function that can correct local <italic>m</italic>/<italic>z</italic> shifts, whereas a small number of long segments
generally results in a more stable, but less flexible, warping function.
The risk of overfitting the warping function to noise or random variations
in peak mass is smaller with segments that have many matched peaks.
Due to this, we prefer long segments that accommodate a sufficient
number of peak matches (at least 10–20) to short segments that
are potentially more flexible.</p>
    </sec>
    <sec id="sec2.2">
      <title>Placement of Warping Nodes</title>
      <p>In many MSI data sets, there
is a large variation in peak density across the <italic>m</italic>/<italic>z</italic> range. For such data sets, the placement of the
warping nodes can greatly influence the warping quality. The same
warping nodes can be used for all spectra, or they can be placed uniquely
for each spectrum. The goal of the warping node placement is to have
a segment length that is adapted to the amount of shared information,
i.e., peak matches, between the sample and reference spectra in all
parts of the <italic>m</italic>/<italic>z</italic> range. This can
be achieved by generating a density estimate (smooth histogram) of
the peak matches between the sample and reference spectra over the <italic>m</italic>/<italic>z</italic> range and then placing the warping
nodes between the peaks of the density curve. If the warping nodes
are uniquely placed for each spectrum, they can alternatively be placed
so that the number of peak matches is the same in all segments. A
third option is to use segments with uniform lengths. This may work
well for spectra with a high peak density throughout the <italic>m</italic>/<italic>z</italic> range but can result in segments without peak
matches for peak-sparse spectra.</p>
    </sec>
    <sec id="sec2.3">
      <title>RANSAC Outlier Detection</title>
      <p>Unlike alignment methods that
rely solely on the difference in mass between matched peaks, MSIWarp
is naturally robust to spurious matches, as long as there are sufficiently
many true matches. To confirm this, we use a custom RANSAC procedure
to detect spurious matches, perform alignment both with the full set
of peak matches and with that obtained after having removed spurious
matches, and compare the results to evaluate whether spurious matches
degrade the alignment quality of MSIWarp in practice. Generally, RANSAC
fits a model to a minimal subset of data points that may contain outliers.
The subset is resampled numerous times and the model is fit to each
subset. The best model, given some criteria, is then selected and
all data points that fit the model are included in the “inlier”
set. We combine RANSAC with our method to separate true matches (inliers)
from spurious matches in the following way:<list list-type="simple"><list-item><label>(i)</label><p>Generate a list of preliminary peak
matches with a permissive distance threshold proportional to peak
FWHM.</p></list-item><list-item><label>(ii)</label><p>Randomly sample
two matches from
the preliminary set of matches for each segment, and fit a trial warping
model to the sampled matches. Warp all other preliminary matches according
to the trial model.</p></list-item><list-item><label>(iii)</label><p>Add peak matches whose mass distance
after alignment is below a strict threshold to the inlier set.</p></list-item><list-item><label>(iv)</label><p>Repeat steps (i)–(iii) <italic>n</italic> times and return the largest set of inliers. Given an
estimate of the fraction of inliers among the peak matches, <italic>n</italic> can be set to obtain a desired probability of an outlier-free
candidate model.</p></list-item></list>We use ϵ from <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref> as the threshold in (i)
and 0.3 times peak FWHM as that in
(iii). When using a large number of segments, the warping function
found using the subset of peak matches in (ii) is highly unstable
and can sometimes fit a large number of spurious matches by chance.
Therefore, we use only one or two warping segments in the RANSAC step.
After removing the spurious matches, more warping segments can be
added in parts of the <italic>m</italic>/<italic>z</italic> range
that are supported by the number of true matches. The final warping
is then searched for using all, or a large fraction, of the true matches.</p>
    </sec>
  </sec>
  <sec id="sec3">
    <title>Materials and Methods</title>
    <sec id="sec3.1">
      <title>Data Sets</title>
      <p>To evaluate MSIWarp, we
applied it to four
publicly available data sets that together represent the most common
MSI experimental setups. The first data set was generated from two
mouse kidney sections with a rapifleX MALDI TOF/TOF instrument (Bruker
Daltonics).<sup><xref ref-type="bibr" rid="ref22">22</xref></sup> The second data set was generated
from human cancer spheroids with an ultrafleXtreme MALDI-TOF/TOF instrument
(Bruker Daltonics).<sup><xref ref-type="bibr" rid="ref23">23</xref></sup> The third data set
was generated from a rat liver section with a MALDI LTQ Orbitrap XL
instrument (Thermo Fischer Scientific).<sup><xref ref-type="bibr" rid="ref24">24</xref></sup> The fourth data set was generated from a colorectal adenocarcinoma
sample using a home-built motorized DESI ion source and an LTQ XL
Orbitrap Discovery instrument (Thermo Fischer Scientific).<sup><xref ref-type="bibr" rid="ref25">25</xref></sup> The data sets, referred to as the TOF kidney,
TOF spheroids, Orbitrap liver, and Orbitrap DESI data sets, are summarized
in <xref rid="tbl1" ref-type="other">Table <xref rid="tbl1" ref-type="other">1</xref></xref>. A more
detailed description of the data sets is available in the <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Supporting Information</ext-link>, and total ion current
(TIC) images for each data set are shown in <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figure S1</ext-link>. Before performing mass alignment, we filtered out peaks
whose intensity was below a signal-to-noise ratio (SNR) of 2.5 from
the mouse kidney TOF data set and centroided all data sets, except
for the Orbitrap DESI, with the parabolic centroiding algorithm by
Robichaud et al.<sup><xref ref-type="bibr" rid="ref26">26</xref></sup> We downloaded the Orbitrap
DESI data set in centroid mode from the MetaboLights repository. The
data sets were preprocessed with in-house Python scripts.</p>
      <table-wrap id="tbl1" position="float">
        <label>Table 1</label>
        <caption>
          <title>Summary of the Data Sets<xref rid="t1fn1" ref-type="table-fn">a</xref></title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
            <col align="left"/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center"> </th>
              <th style="border:none;" align="center">TOF kidney</th>
              <th style="border:none;" align="center">TOF spheroids</th>
              <th style="border:none;" align="center">Orbitrap
liver</th>
              <th style="border:none;" align="center">Orbitrap
DESI</th>
            </tr>
            <tr>
              <th style="border:none;" align="center">ionization
technique</th>
              <th style="border:none;" align="center">MALDI</th>
              <th style="border:none;" align="center">MALDI</th>
              <th style="border:none;" align="center">MALDI</th>
              <th style="border:none;" align="center">DESI</th>
            </tr>
            <tr>
              <th style="border:none;" align="center">species</th>
              <th style="border:none;" align="center">mouse</th>
              <th style="border:none;" align="center">human</th>
              <th style="border:none;" align="center">rat</th>
              <th style="border:none;" align="center">human</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">no. spectra</td>
              <td style="border:none;" align="left">33 242</td>
              <td style="border:none;" align="left">1114</td>
              <td style="border:none;" align="left">23 823</td>
              <td style="border:none;" align="left">20 286</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">raster size (μm)</td>
              <td style="border:none;" align="left">100</td>
              <td style="border:none;" align="left">50</td>
              <td style="border:none;" align="left">50</td>
              <td style="border:none;" align="left">100</td>
            </tr>
            <tr>
              <td style="border:none;" align="left"><italic>m</italic>/<italic>z</italic> range (Da)</td>
              <td style="border:none;" align="left">500–2500</td>
              <td style="border:none;" align="left">800–4500</td>
              <td style="border:none;" align="left">150–1000</td>
              <td style="border:none;" align="left">200–1000</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">resolution</td>
              <td style="border:none;" align="left">2600</td>
              <td style="border:none;" align="left">17 500</td>
              <td style="border:none;" align="left">60 000</td>
              <td style="border:none;" align="left">60 000</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">avg. no. peaks</td>
              <td style="border:none;" align="left">244</td>
              <td style="border:none;" align="left">57</td>
              <td style="border:none;" align="left">730</td>
              <td style="border:none;" align="left">701</td>
            </tr>
          </tbody>
        </table>
        <table-wrap-foot>
          <fn id="t1fn1">
            <label>a</label>
            <p>Both TOF
data sets were uploaded
to ProteomeXchange smoothed and with their baseline removed. Resolutions
for the Orbitrap data sets were calculated at 400 <italic>m</italic>/<italic>z</italic>.</p>
          </fn>
        </table-wrap-foot>
      </table-wrap>
    </sec>
    <sec id="sec3.2">
      <title>Data Analysis</title>
      <p>To measure the effect of alignment in
each data set, we calculated the mass dispersion around a set of reference
peaks. We obtained the mass dispersion of a reference peak by binning
all spectra around its <italic>m</italic>/<italic>z</italic> and then
calculating the standard deviation of peak masses within the resulting
mass bin. By binning we mean isolating peaks across spectra at predefined <italic>m</italic>/<italic>z</italic> locations, and we refer to the isolation
windows as mass bins. We used a bin width two times the FWHM of the
reference peak. As reference peaks, we used the most intense peaks
of the mean spectrum (100 for the TOF kidney, Orbitrap liver, and
Orbitrap DESI data sets and 50 for the TOF spheroid data set), some
matrix peaks, and peaks that were identified in the papers that originally
published the data sets. The mean spectrum was generated after alignment
with MSIWarp, and we performed the binning and calculated mass dispersion
both before and after alignment.</p>
      <p>To further assess the quality
of the alignment, we generated scatter plots of peak mass and spectrum
acquisition time for the mass bin of each reference peak (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figures S3–S13</ext-link>). The scatter plots provide
a clear view of the mass shift before and after alignment and serve
as valuable quality control for the alignment of specific peaks. Despite
the previous intensity filtering of the TOF kidney data set based
on SNR, some mass bins were still contaminated with faint background
peaks. To reduce the influence of these, we applied an intensity threshold
to each mass bin. The threshold was defined as the lower intensity
quartile of all of the peaks in the mass bin, and peaks whose intensity
was below this threshold were excluded when calculating mass dispersion.</p>
    </sec>
  </sec>
  <sec id="sec4">
    <title>Results and Discussion</title>
    <p>To reiterate, MSIWarp aligns a data
set by maximizing the similarity
between each spectrum and a common reference spectrum. Like any method
that performs pairwise alignment, it relies on shared information.
In the ideal case, all spectra share numerous peaks with the reference
spectrum throughout the <italic>m</italic>/<italic>z</italic> range.
In a more challenging case, there are few shared peaks overall and/or
wide gaps in the <italic>m</italic>/<italic>z</italic> range without
any shared peaks. <xref rid="fig2" ref-type="fig">Figure <xref rid="fig2" ref-type="fig">2</xref></xref> shows a pair of spectra from the Orbitrap data set, another
from the TOF kidney data set, and the <italic>m</italic>/<italic>z</italic> difference between preliminary matched peaks. The Orbitrap spectra
are homogeneous, with shared peaks throughout the <italic>m</italic>/<italic>z</italic> range, and the mass shifts are small (&lt;1.5
ppm). In contrast, the TOF spectra are heterogeneous, the mass shifts
are significantly larger (&gt;200 ppm), and there is a part of the <italic>m</italic>/<italic>z</italic> range with almost no shared peaks (1000–1400 <italic>m</italic>/<italic>z</italic>). Note that the mass differences between
shared peaks for a pair of aligned spectra are expected to be distributed
around zero throughout the <italic>m</italic>/<italic>z</italic> range.
However, in these examples, the misalignment is apparent; the mass
shift of matched peaks consistently increases with <italic>m</italic>/<italic>z</italic> for both pairs. To accommodate large mass shifts,
we used a peak matching threshold (ϵ in <xref rid="eq4" ref-type="disp-formula">eq <xref rid="eq4" ref-type="disp-formula">4</xref></xref>) of approximately two times the FWHM when
matching peaks. With the low mass resolution in the TOF kidney data
set, this meant matching peaks within a window of ±0.76 <italic>m</italic>/<italic>z</italic> at 1000 <italic>m</italic>/<italic>z</italic>. A wide matching window increases the number of spurious
matches; the scatter in <xref rid="fig2" ref-type="fig">Figure <xref rid="fig2" ref-type="fig">2</xref></xref>b contains numerous examples, most notably those clustered
around 850 and 1050 <italic>m</italic>/<italic>z</italic>. Finally,
we chose to place the warping nodes based on the density estimate
of peak matches, since it generally resulted in a smoother partitioning
of the <italic>m</italic>/<italic>z</italic> range than when placing
them so that all segments contained the same number of peak matches.
We generated the density estimate by performing a Kernel density estimation
(KDE) of peak <italic>m</italic>/<italic>z</italic> and then placed
the warping nodes between the peaks of the density curve, resulting
in 4–10 warping segments for the four data sets. Increasing
and decreasing the bandwidth of the KDE is a flexible way to adjust
the number of warping segments and the number of peak matches in each
segment. We used a bandwidth of 15 Da for the TOF kidney and Orbitrap
data sets, and a bandwidth of 100 Da for the TOF spheroid data set
since it was significantly less peak-dense than the other data sets.</p>
    <fig id="fig2" position="float">
      <label>Figure 2</label>
      <caption>
        <p>Top: pair
of raw spectra from the Orbitrap liver data set (a) and
another from the TOF kidney (b). Bottom: scatters of <italic>m</italic>/<italic>z</italic> difference between matched peaks with point size
scaled by intensity. The Orbitrap spectra share peaks across the entire <italic>m</italic>/<italic>z</italic> range. In contrast, the TOF spectra
share no peaks in a large part of the <italic>m</italic>/<italic>z</italic> range (1000–1400 <italic>m</italic>/<italic>z</italic>).
This example also highlights the severity of the mass shift in the
TOF kidney data set: at 800 <italic>m</italic>/<italic>z</italic>,
the shift is close to 0.18 <italic>m</italic>/<italic>z</italic> (219
ppm) between the TOF pair compared to 0.001 <italic>m</italic>/<italic>z</italic> (1.25 ppm) between the Orbitrap pair.</p>
      </caption>
      <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0003" id="gr2" position="float"/>
    </fig>
    <p>Spurious peak matches are largely inconsequential to MSIWarp as
long as spectra are reasonably peak-dense; in fact, most spectra are
aligned accurately and reliably without RANSAC, even those in the
TOF data sets. We hypothesized that the importance of identifying
true matches increases when aligning peak-sparse spectra. For this
reason, we aligned the TOF data sets both with and without RANSAC.
When combining RANSAC with COW, it is important to use a small number
of warping segments in this step to avoid overfitting the candidate
models to spurious peak matches; here, we used two segments for both
TOF data sets in the RANSAC step. Manual inspection of scatter plots
like those in <xref rid="fig3" ref-type="fig">Figure <xref rid="fig3" ref-type="fig">3</xref></xref> suggests that RANSAC confidently filters out spurious peak matches
in almost all spectra across both TOF data sets. We used RANSAC to
filter out spurious peak matches before searching for the optimal
warping. Then, we added more warping nodes in the peak-dense parts
of the <italic>m</italic>/<italic>z</italic> range to gain more flexibility.
Thereby, we obtained a flexibility in the warping function that was
adapted to the number of shared peaks throughout the <italic>m</italic>/<italic>z</italic> range. We provide some examples of how RANSAC
finds the true peak matches (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figure S2</ext-link>)
along with an animation in the <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Supporting Information</ext-link>.</p>
    <fig id="fig3" position="float">
      <label>Figure 3</label>
      <caption>
        <p>(a, b) Mass shift estimated by MSIWarp (orange line) overlaid on
the peak match scatter from <xref rid="fig2" ref-type="fig">Figure <xref rid="fig2" ref-type="fig">2</xref></xref>. (b) We use more warping nodes in the peak-dense part
of the <italic>m</italic>/<italic>z</italic> range than in the peak-sparse
part; the zoom-in shows that the warping function closely follows
the local shifts between 700 and 900 <italic>m</italic>/<italic>z</italic>.</p>
      </caption>
      <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0004" id="gr3" position="float"/>
    </fig>
    <p>When aligning a data set by aligning
each spectrum to a common
reference spectrum, the quality of that reference spectrum is essential.
We tried an approach similar to that of Kulkarni et al.,<sup><xref ref-type="bibr" rid="ref11">11</xref></sup> where the reference spectrum is continuously
updated with each aligned sample spectrum, but observed no significant
improvement over aligning against a constant reference spectrum of
high quality. The spectrum with the highest TIC was sufficient in
terms of peak coverage for all four data sets, and we therefore chose
to use it as a reference. Although the spectra with the highest TIC
were appropriate references for the alignment of the data sets that
we discuss here, a composite spectrum may be needed to fully cover
the <italic>m</italic>/<italic>z</italic> range in other data sets.</p>
    <p>How we dealt with segments without shared peaks also deserves mention.
We chose to interpolate the warping function in empty regions, as
is evident in <xref rid="fig3" ref-type="fig">Figure <xref rid="fig3" ref-type="fig">3</xref></xref>b at around 1200 <italic>m</italic>/<italic>z</italic>. This is reasonable
under the assumption that some relevant data set peaks are missing
in the reference spectrum, which is often the case, so they can be
present in a sample spectrum without being shared with the reference.
An alternative approach is to leave the empty parts of the <italic>m</italic>/<italic>z</italic> region unaligned, which can be more
appropriate if the reference spectrum has a very high peak coverage
throughout the <italic>m</italic>/<italic>z</italic> range. When this
is the case, the sample spectrum likely has little or no information
in regions where it does not share peaks with the reference spectrum,
and aligning those regions is unnecessary.</p>
    <sec id="sec4.1">
      <title>Reduction in Mass Misalignment</title>
      <p>After alignment with
MSIWarp, mass dispersion is reduced considerably in all four data
sets. In <xref rid="tbl2" ref-type="other">Table <xref rid="tbl2" ref-type="other">2</xref></xref>, the
mass dispersions of the mean spectrum peaks before and after alignment
are reported in both ppm and FWHM. The full list of dispersions of
the mean spectrum peaks is available in the <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Supporting Information</ext-link> spreadsheet. Interestingly, we observed no significant
improvement when aligning the TOF data sets with RANSAC compared to
aligning it without RANSAC. This suggests that the inherent robustness
of COW is sufficient in dealing with spurious peak matches for the
majority of spectra. To assess the sensitivity of MSIWarp to the modeled
peak width, σ, and the peak matching threshold, ϵ, we
reran the analysis of the Orbitrap liver and TOF kidney data sets
for various values of these parameters (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Table S1 and S2</ext-link>). This parameter sensitivity analysis suggests that
MSIWarp can perform well even when σ over- or underestimates
the experimental peak width by a factor of up to 2. It also suggests
that a large peak matching threshold is better than a small one, which
is further evidence that MSIWarp is robust to spurious peak matches
and that the most important factor is that true matches are captured
throughout the <italic>m</italic>/<italic>z</italic> range. In addition
to using the spectrum with the highest TIC as a reference, we also
aligned the TOF kidney data set to each of the 11 spectra with TICs
closest to the data set median, resulting in median mass dispersions
of mean spectrum peaks between 11.64 and 16.10 ppm (avg. 12.53). For
9 out of 11 spectra, the median mass dispersion was lower than when
using the spectrum with the highest TIC as a reference (12.73 ppm).
In comparison, using the spectrum with the lowest TIC as a reference
resulted in a median mass dispersion of 73.45 ppm. Altogether, this
indicates that a minimum TIC threshold can be used to filter out unsuitable
reference spectra, but otherwise, the TIC provides little or no information
about a spectrum’s suitability as a reference.</p>
      <table-wrap id="tbl2" position="float">
        <label>Table 2</label>
        <caption>
          <title>Median Mass Dispersion of Mean Spectrum
Peaks before (Raw) and after Alignment (Warped) for the Four Data
Sets</title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center"> </th>
              <th style="border:none;" align="center" char=".">TOF kidney</th>
              <th style="border:none;" align="center" char=".">TOF spheroids</th>
              <th style="border:none;" align="center" char=".">Orbitrap
liver</th>
              <th style="border:none;" align="center" char=".">Orbitrap
DESI</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">raw (ppm)</td>
              <td style="border:none;" align="char" char=".">106.39</td>
              <td style="border:none;" align="char" char=".">35.63</td>
              <td style="border:none;" align="char" char=".">0.63</td>
              <td style="border:none;" align="char" char=".">0.52</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">warped (ppm)</td>
              <td style="border:none;" align="char" char=".">12.73</td>
              <td style="border:none;" align="char" char=".">6.48</td>
              <td style="border:none;" align="char" char=".">0.18</td>
              <td style="border:none;" align="char" char=".">0.17</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">raw (FWHM)</td>
              <td style="border:none;" align="char" char=".">0.27</td>
              <td style="border:none;" align="char" char=".">0.63</td>
              <td style="border:none;" align="char" char=".">0.03</td>
              <td style="border:none;" align="char" char=".">0.03</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">warped (FWHM)</td>
              <td style="border:none;" align="char" char=".">0.03</td>
              <td style="border:none;" align="char" char=".">0.11</td>
              <td style="border:none;" align="char" char=".">0.01</td>
              <td style="border:none;" align="char" char=".">0.01</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">reduction (%)</td>
              <td style="border:none;" align="char" char=".">88.03</td>
              <td style="border:none;" align="char" char=".">81.82</td>
              <td style="border:none;" align="char" char=".">72.03</td>
              <td style="border:none;" align="char" char=".">68.00</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
      <p>Visualization of how
the peak mass varies across the experiment
gives a good overview of alignment; <xref rid="fig4" ref-type="fig">Figure <xref rid="fig4" ref-type="fig">4</xref></xref>a–<xref rid="fig4" ref-type="fig">4</xref>c shows
the scatter of the relative peak mass before and after alignment with
MSIWarp and spectrum acquisition time for three example peaks. The
same pattern is seen for the three peaks: aligning with MSIWarp visibly
tightens the peak scatter and removes the systematic shifts related
to spectrum acquisition time. These scatter plots are effective in
visualizing time-dependent mass shift but do not provide a clear picture
of how mass shift relates to tissue location. To better visualize
this relationship, we show the relative mass shift of a matrix peak
([M – H<sub>2</sub>O + H]<sup>+</sup>, 172.04 <italic>m</italic>/<italic>z</italic>) from the Orbitrap data set as a function of
tissue location in <xref rid="fig5" ref-type="fig">Figure <xref rid="fig5" ref-type="fig">5</xref></xref>a. In this plot, it is evident that the peak masses decrease
with time (the tissue was scanned from top to bottom), but also that
some shifts are related to tissue location. The blue spots in the
bottom half of the section break the trend related to acquisition
time; in these spots, peak masses are increased by more than 4 ppm,
compared to an average decrease of approximately 1 ppm in the bottom
half of the section. The blue spots appear to be correlated to the
TIC of the spectra, which could be due to the space-charge effect. <xref rid="fig5" ref-type="fig">Figure <xref rid="fig5" ref-type="fig">5</xref></xref>b shows the mass
shift image of the peak at 890.8 <italic>m</italic>/<italic>z</italic> (PI 38:2) from the TOF kidney data set. In contrast to the matrix
peak from the Orbitrap data set, the mass shift of this peak appears
to be unrelated to both spectrum acquisition time and TIC (<xref rid="fig4" ref-type="fig">Figures <xref rid="fig4" ref-type="fig">4</xref></xref>a and <xref rid="fig5" ref-type="fig">5</xref>b). Instead, there is a strong relationship to tissue location:
in both kidney sections, peak masses appear to be increased in the
cortex and decreased in the medulla. The “stripes” at
the top part of the left section are likely an experimental artifact
(due to tissue folding or damage) rather than being related to any
tissue structure.</p>
      <fig id="fig4" position="float">
        <label>Figure 4</label>
        <caption>
          <p>Scatter plots of mass shift relative to the reference
peak (<italic>y</italic>-axis) and spectrum index ordered according
to acquisition
time (<italic>y</italic>-axis) before (cyan) and after alignment (orange).
(a–c) Scatters around reference peaks at <italic>m</italic>/<italic>z</italic> 850.80 (PI 36:7), 1403.10 (unknown), and 172.04
(matrix) in the TOF kidney, TOF spheroids, and Orbitrap liver data
sets, respectively.</p>
        </caption>
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0005" id="gr4" position="float"/>
      </fig>
      <fig id="fig5" position="float">
        <label>Figure 5</label>
        <caption>
          <p>Mass shift and TIC images
from the Orbitrap liver and TOF kidney
data sets. Left: the mass shift (a) of the matrix peak at 172.04 <italic>m</italic>/<italic>z</italic> in the Orbitrap data set is correlated
to TIC (c). Right: the mass shift (b) of the lipid peak (PI 38:2)
in the TOF kidney data set appears to be related to tissue structures
rather than to TIC (d) or acquisition time.</p>
        </caption>
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0006" id="gr5" position="float"/>
      </fig>
      <p>The mass dispersion of some identified compounds and matrix peaks
in the Orbitrap liver and TOF kidney data sets are shown in <xref rid="tbl3" ref-type="other">Tables <xref rid="tbl3" ref-type="other">3</xref></xref> and <xref rid="tbl4" ref-type="other">4</xref>, respectively. The monoisotopic peak of the phosphatidylcholine
head group (184.07 <italic>m</italic>/<italic>z</italic>) in the Orbitrap
data set has a notably lower dispersion after alignment (0.036 ppm)
than those of the other compounds (0.086–0.435 ppm). The intensity
of this peak is several orders of magnitude larger than that of all
other peaks. As a consequence, it dominates the similarity score and
effectively acts as a lock mass for the warping function. Importantly,
this does not appear to increase dispersion for lower intensity peaks
close in <italic>m</italic>/<italic>z</italic>; the matrix peaks at
172.04 and 190.05 <italic>m</italic>/<italic>z</italic> contribute
insignificantly to the similarity score in comparison, but still have
lower dispersion than most other peaks after alignment. This suggests
that the shift in low-intensity peaks can be estimated accurately
with the shift of nearby high-intensity peaks. In the TOF kidney data
set, dispersion is reduced consistently by more than 80 percent, except
for the peak at <italic>m</italic>/<italic>z</italic> 919.90 (PI 40:1),
whose dispersion remains relatively high after alignment (32.69 ppm).
By looking at the mass scatter of this peak, however, it is evident
that it has been mixed with another peak in the same mass bin and
that this causes the relatively high dispersion after alignment (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">Figure S5</ext-link>, Supporting Information).</p>
      <table-wrap id="tbl3" position="float">
        <label>Table 3</label>
        <caption>
          <title>Mass Dispersion (ppm) of Five Matrix
(α-Cyano-4-hydroxycinnamic Acid) Peaks, the Monoisotopic Peak
of Two Spiked-In Compounds, and the Peak of Phosphocholine before
(Raw) and after Alignment (Warped) in the Orbitrap Liver Data Set</title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center">compound</th>
              <th style="border:none;" align="center" char="."><italic>m</italic>/<italic>z</italic></th>
              <th style="border:none;" align="center" char=".">disp. raw
(ppm)</th>
              <th style="border:none;" align="center" char=".">disp. warped
(ppm)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">[M – H<sub>2</sub>O + H]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">172.039</td>
              <td style="border:none;" align="char" char=".">0.644</td>
              <td style="border:none;" align="char" char=".">0.159</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[M + H]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">190.050</td>
              <td style="border:none;" align="char" char=".">0.743</td>
              <td style="border:none;" align="char" char=".">0.086</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[M + Na]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">212.032</td>
              <td style="border:none;" align="char" char=".">0.724</td>
              <td style="border:none;" align="char" char=".">0.222</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[M – H + 2Na]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">234.014</td>
              <td style="border:none;" align="char" char=".">0.998</td>
              <td style="border:none;" align="char" char=".">0.435</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">[2M + H]<sup>+</sup></td>
              <td style="border:none;" align="char" char=".">379.092</td>
              <td style="border:none;" align="char" char=".">0.699</td>
              <td style="border:none;" align="char" char=".">0.343</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">phosphocholine</td>
              <td style="border:none;" align="char" char=".">184.073</td>
              <td style="border:none;" align="char" char=".">0.706</td>
              <td style="border:none;" align="char" char=".">0.036</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">ipratropium</td>
              <td style="border:none;" align="char" char=".">332.222</td>
              <td style="border:none;" align="char" char=".">0.675</td>
              <td style="border:none;" align="char" char=".">0.271</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">dasatinib</td>
              <td style="border:none;" align="char" char=".">488.164</td>
              <td style="border:none;" align="char" char=".">0.475</td>
              <td style="border:none;" align="char" char=".">0.364</td>
            </tr>
          </tbody>
        </table>
      </table-wrap>
      <table-wrap id="tbl4" position="float">
        <label>Table 4</label>
        <caption>
          <title>Mass Dispersion (ppm) of Some Identified
Lipid Peaks before (Raw) and after Alignment (Warped) in the TOF Kidney
Data Set<xref rid="t4fn1" ref-type="table-fn">a</xref></title>
        </caption>
        <table frame="hsides" rules="groups" border="0">
          <colgroup>
            <col align="left"/>
            <col align="char" char="."/>
            <col align="char" char="."/>
            <col align="char" char="."/>
          </colgroup>
          <thead>
            <tr>
              <th style="border:none;" align="center">compound</th>
              <th style="border:none;" align="center" char="."><italic>m</italic>/<italic>z</italic></th>
              <th style="border:none;" align="center" char=".">disp. raw
(ppm)</th>
              <th style="border:none;" align="center" char=".">disp. warped
(ppm)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:none;" align="left">LPS 18:0</td>
              <td style="border:none;" align="char" char=".">524.19</td>
              <td style="border:none;" align="char" char=".">126.83</td>
              <td style="border:none;" align="char" char=".">15.24</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PA 34:1</td>
              <td style="border:none;" align="char" char=".">673.68</td>
              <td style="border:none;" align="char" char=".">128.19</td>
              <td style="border:none;" align="char" char=".">24.99</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PA 36:1</td>
              <td style="border:none;" align="char" char=".">701.76</td>
              <td style="border:none;" align="char" char=".">123.15</td>
              <td style="border:none;" align="char" char=".">16.80</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PS 36:3</td>
              <td style="border:none;" align="char" char=".">784.38</td>
              <td style="border:none;" align="char" char=".">118.82</td>
              <td style="border:none;" align="char" char=".">16.13</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PI 36:7</td>
              <td style="border:none;" align="char" char=".">850.80</td>
              <td style="border:none;" align="char" char=".">103.38</td>
              <td style="border:none;" align="char" char=".">5.70</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PS 42:5</td>
              <td style="border:none;" align="char" char=".">864.82</td>
              <td style="border:none;" align="char" char=".">105.18</td>
              <td style="border:none;" align="char" char=".">7.23</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PI 40:6</td>
              <td style="border:none;" align="char" char=".">907.87</td>
              <td style="border:none;" align="char" char=".">103.49</td>
              <td style="border:none;" align="char" char=".">6.51</td>
            </tr>
            <tr>
              <td style="border:none;" align="left">PI 40:1</td>
              <td style="border:none;" align="char" char=".">919.90</td>
              <td style="border:none;" align="char" char=".">87.83</td>
              <td style="border:none;" align="char" char=".">32.69</td>
            </tr>
          </tbody>
        </table>
        <table-wrap-foot>
          <fn id="t4fn1">
            <label>a</label>
            <p>All lipids are represented as [M
– H]<sup>−</sup> ions.</p>
          </fn>
        </table-wrap-foot>
      </table-wrap>
      <p>An interesting example of the utility of MSIWarp is
shown in <xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>.
Like the mass bin
at 919.90 <italic>m</italic>/<italic>z</italic>, other mass bins in
the TOF kidney data set contain mixed peaks as well, including that
of the unidentified reference peak at 904.90 <italic>m</italic>/<italic>z</italic>. Before alignment, the two peaks in this bin are indistinguishable,
but after alignment, the peaks are separated sufficiently to enable
us to generate a distinct ion image for each. The distribution of
peak mass within the bin is considerably narrower after alignment
(<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>b). Crucially,
the density curve of the warped peak masses reveals, albeit just barely,
the second peak as distinct from the first one. By re-binning the
spectra with two tighter windows (±10 ppm), whose respective
centers are at the main and shoulder peaks of the density estimate,
two distinct ion images can be generated (<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>d,<xref rid="fig6" ref-type="fig">6</xref>e) instead of one
in which the two compounds are mixed (<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>c). Despite the low mass resolution of the
TOF kidney data (the FWHM is approximately 380 ppm), these two peaks,
which are 25 ppm apart, can still be separated by looking at the mass
locations of their centroids. Note that while we separate them on
a data set level, we do not separate them in a single spectrum; when
the compounds corresponding to the peaks are present in the same spectrum,
i.e., tissue spot, the peak of the more intensive compound masks that
of the other. This is evident in the ion images of the two peaks (<xref rid="fig6" ref-type="fig">Figure <xref rid="fig6" ref-type="fig">6</xref></xref>d,<xref rid="fig6" ref-type="fig">6</xref>e): only the more intense peak (904.878 <italic>m</italic>/<italic>z</italic>) is visible in the pixels where the two peaks
overlap.</p>
      <fig id="fig6" position="float">
        <label>Figure 6</label>
        <caption>
          <p>Mass bin from the TOF kidney data set exemplifies how severe misalignment
leads to mixed ion images. The scatter of peak mass and acquisition
time in (a) reveals two peaks after alignment (orange) that are indistinguishable
before alignment (cyan). Alignment similarly reveals the two peaks
in the density estimate of peak mass within the bin (b): before alignment
(raw), the variation in peak mass across the spectra is too large
to separate the two peaks, but after alignment (warped), the peaks
appear as the main and shoulder peaks of the density curve. The left
ion image (c) was generated from the raw (unaligned) spectra with
a wide bin window (±200 ppm), while the center (d) and right
(e) ion images were generated by binning the warped spectra with a
narrow window (±10 ppm) around 904.855 and 904.878 <italic>m</italic>/<italic>z</italic>, respectively. The median mass of the two peaks
and the narrow windows are marked in the zoom-in on the density curve
in (b). The ion images in (c)–(e) were generated by summing
peak intensities in the bin for each spectrum/pixel.</p>
        </caption>
        <graphic xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_0007" id="gr6" position="float"/>
      </fig>
    </sec>
    <sec id="sec4.2">
      <title>Implementation and Processing Time</title>
      <p>Although our method
involves repeating the similarity score computation for a large number
of candidate warpings to align a single spectrum, we keep the processing
time for a whole data set low by implementing the core part of MSIWarp
in efficient C++. Aligning the TOF kidney data set, consisting of
33 242 spectra with 244 peaks on average, took approximately
150 s when MSIWarp was run without RANSAC and in parallel mode on
a laptop with an Intel i7-6700HQ CPU (2.6 GHz) and 16 GB RAM. Aligning
the Orbitrap liver data set with the same settings took approximately
300 s. The parameter that has the largest impact on processing time
is the number of steps by which the warping nodes are shifted when
searching for the optimal warping. Given that the slack has been set
to capture the mass shift for all spectra, the number of steps corresponds
to the resolution of the warping function. We found that a step size
of 0.05–0.10 times the peak FWHM gives a sufficient alignment
resolution. If the search space of the warping function is ±2
FWHM, this results in 40–80 steps for each warping node. The
source code of MSIWarp along with Python bindings are available at <uri xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://github.com/horvatovichlab/MSIWarp">https://github.com/horvatovichlab/MSIWarp</uri>. Our goal is to make it possible to interface MSIWarp with existing
MSI analysis packages such as MALDIquant,<sup><xref ref-type="bibr" rid="ref27">27</xref></sup> Cardinal,<sup><xref ref-type="bibr" rid="ref28">28</xref></sup> and rMSIproc.<sup><xref ref-type="bibr" rid="ref29">29</xref></sup></p>
    </sec>
  </sec>
  <sec id="sec5">
    <title>Conclusions</title>
    <p>We have presented an
approach, MSIWarp, that readily improves relative
alignment in both TOF and Orbitrap data sets that together represent
a large variety of MSI experimental setups. Even the severe misalignment
in the TOF kidney data set is brought down to a level that enables
separation of peaks close in <italic>m</italic>/<italic>z</italic>. With a median mass dispersion of 6.48 ppm (and below 5 ppm for
more than half of the peaks) in the TOF spheroid data set, MSIWarp
matches the alignment performance of methods that rely on profile
spectra using only centroided spectra. While the largest improvements
in relative mass alignment can be gained for TOF spectra, our results
suggest that MSIWarp can further improve the already high mass alignment
in Orbitrap data sets. By investigating the effect of spurious peak
matches with RANSAC, we have also shown that MSIWarp is robust and
performs well even for most peak-sparse spectra. Finally, we believe
that a careful assessment of mass alignment is critical when analyzing
MSI data sets. Tools such as scatter plots of peak mass and acquisition
time, scatter plots of mass shift between individual pairs of spectra,
and images of mass shift as a function of tissue location for individual
peaks provide a way to do this in a simple manner.</p>
    <p>Although
MSIWarp has demonstrated significant benefits in analyzing
MSI data sets, there are several research paths that could yield additional
improvements. Currently, the output of MSIWarp is an <italic>m</italic>/<italic>z</italic> recalibration function for each data set spectrum.
It is important to highlight that even though this function is found
by searching for the optimal alignment between a pair of centroided
spectra, it can also be used to align the corresponding profile spectra.
Conceptually, the recalibration function could also be found by directly
computing the correlation integral between the profile spectra, if
available, instead of using our analytical expression based on the
overlap of centroided peaks. This would allow MSIWarp to utilize subtle
features in the profile data, such as peak shape, that may be lost
in the peak-picking step. Another possible enhancement is to create
a hybrid approach by combining MSIWarp with existing calibration strategies
to improve absolute mass accuracy in addition to relative mass alignment.
To do this, a spectrum with accurate masses should be used as a reference,
and if no such spectrum is available, the reference spectrum can be
chosen based on other criteria and calibrated prior to alignment.
Together, these approaches represent a rich area of research that
would allow interesting comparisons of related techniques and potential
for even further improvements in performance.</p>
  </sec>
</body>
<back>
  <notes id="notes-1" notes-type="si">
    <title>Supporting Information Available</title>
    <p>The Supporting Information
is available free of charge at <ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="https://pubs.acs.org/doi/10.1021/acs.analchem.0c03833?goto=supporting-info">https://pubs.acs.org/doi/10.1021/acs.analchem.0c03833</ext-link>.<list id="silist" list-type="simple"><list-item><p>Description of the TOF
kidney, TOF spheroids, Orbitrap
liver, and Orbitrap DESI data sets. Tables S1 and S2, median mass
dispersions of mean spectrum peaks from the TOF kidney and Orbitrap
liver data sets after alignment with various values of σ and
ϵ. Figure S1, TIC images for the four MSI data sets. Figure
S2, RANSAC outlier detection results for three example spectra from
the TOF kidney data set. Figures S3–S13, scatter plots of peak
mass and acquisition time for mean spectrum peaks from the top 100,
50, 100, and 100 mean spectrum peaks’ TOF kidney, TOF spheroids,
Orbitrap liver and Orbitrap DESI data sets (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_001.pdf">PDF</ext-link>)</p></list-item><list-item><p>Ransac outlier detection animation
(<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_002.zip">ZIP</ext-link>)</p></list-item><list-item><p>Mean
spectrum dispersions (<ext-link xmlns:xlink="http://www.w3.org/1999/xlink" ext-link-type="uri" xlink:href="http://pubs.acs.org/doi/suppl/10.1021/acs.analchem.0c03833/suppl_file/ac0c03833_si_003.xlsx">XLSX</ext-link>)</p></list-item></list></p>
  </notes>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="sifile1">
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_si_001.pdf">
        <caption>
          <p>ac0c03833_si_001.pdf</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sifile2">
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_si_002.zip">
        <caption>
          <p>ac0c03833_si_002.zip</p>
        </caption>
      </media>
    </supplementary-material>
    <supplementary-material content-type="local-data" id="sifile3">
      <media xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="ac0c03833_si_003.xlsx">
        <caption>
          <p>ac0c03833_si_003.xlsx</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
  <notes notes-type="COI-statement" id="NOTES-d7e2460-autogenerated">
    <p>The
authors declare no
competing financial interest.</p>
  </notes>
  <ack>
    <title>Acknowledgments</title>
    <p>We acknowledge the support from Fru Berta Kamprads Stiftelse.
This research was part of the Netherlands X-omics Initiative and partially
funded by NWO, project 184.034.019. We also thank the reviewers for
their valuable feedback.</p>
  </ack>
  <ref-list>
    <title>References</title>
    <ref id="ref1">
      <mixed-citation publication-type="journal" id="cit1"><name><surname>Buchberger</surname><given-names>A. R.</given-names></name>; <name><surname>DeLaney</surname><given-names>K.</given-names></name>; <name><surname>Johnson</surname><given-names>J.</given-names></name>; <name><surname>Li</surname><given-names>L.</given-names></name><article-title>Mass spectrometry imaging:
a review of emerging advancements and future insights</article-title>. <source>Anal. Chem.</source><year>2018</year>, <volume>90</volume>, <fpage>240</fpage>–<lpage>265</lpage>. <pub-id pub-id-type="doi">10.1021/acs.analchem.7b04733</pub-id>.<pub-id pub-id-type="pmid">29155564</pub-id></mixed-citation>
    </ref>
    <ref id="ref2">
      <mixed-citation publication-type="journal" id="cit2"><name><surname>Gilmore</surname><given-names>I. S.</given-names></name>; <name><surname>Heiles</surname><given-names>S.</given-names></name>; <name><surname>Pieterse</surname><given-names>C. L.</given-names></name><article-title>Metabolic
imaging at the single-cell
scale: recent advances in mass spectrometry imaging</article-title>. <source>Annu. Rev. Anal. Chem.</source><year>2019</year>, <volume>12</volume>, <fpage>201</fpage>–<lpage>224</lpage>. <pub-id pub-id-type="doi">10.1146/annurev-anchem-061318-115516</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref3">
      <mixed-citation publication-type="journal" id="cit3"><name><surname>Han</surname><given-names>J.</given-names></name>; <name><surname>Permentier</surname><given-names>H.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Groothuis</surname><given-names>G.</given-names></name>; <name><surname>Casini</surname><given-names>A.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Imaging of
protein distribution in
tissues using mass spectrometry: An interdisciplinary challenge</article-title>. <source>TrAC, Trends Anal. Chem.</source><year>2019</year>, <volume>112</volume>, <fpage>13</fpage>–<lpage>28</lpage>. <pub-id pub-id-type="doi">10.1016/j.trac.2018.12.016</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref4">
      <mixed-citation publication-type="journal" id="cit4"><name><surname>Ryan</surname><given-names>D. J.</given-names></name>; <name><surname>Spraggins</surname><given-names>J. M.</given-names></name>; <name><surname>Caprioli</surname><given-names>R. M.</given-names></name><article-title>Protein identification
strategies
in MALDI imaging mass spectrometry: a brief review</article-title>. <source>Curr. Opin. Chem. Biol.</source><year>2019</year>, <volume>48</volume>, <fpage>64</fpage>–<lpage>72</lpage>. <pub-id pub-id-type="doi">10.1016/j.cbpa.2018.10.023</pub-id>.<pub-id pub-id-type="pmid">30476689</pub-id></mixed-citation>
    </ref>
    <ref id="ref5">
      <mixed-citation publication-type="journal" id="cit5"><name><surname>Verbeeck</surname><given-names>N.</given-names></name>; <name><surname>Caprioli</surname><given-names>R. M.</given-names></name>; <name><surname>Van de
Plas</surname><given-names>R.</given-names></name><article-title>Unsupervised machine learning for
exploratory data analysis in imaging mass spectrometry</article-title>. <source>Mass Spectrom. Rev.</source><year>2020</year>, <volume>39</volume>, <fpage>245</fpage>–<lpage>291</lpage>. <pub-id pub-id-type="doi">10.1002/mas.21602</pub-id>.<pub-id pub-id-type="pmid">31602691</pub-id></mixed-citation>
    </ref>
    <ref id="ref6">
      <mixed-citation publication-type="journal" id="cit6"><name><surname>Ràfols</surname><given-names>P.</given-names></name>; <name><surname>del Castillo</surname><given-names>E.</given-names></name>; <name><surname>Yanes</surname><given-names>O.</given-names></name>; <name><surname>Brezmes</surname><given-names>J.</given-names></name>; <name><surname>Correig</surname><given-names>X.</given-names></name><article-title>Novel automated
workflow for spectral alignment and mass calibration in MS imaging
using a sputtered Ag nanolayer</article-title>. <source>Anal. Chim.
Acta</source><year>2018</year>, <volume>1022</volume>, <fpage>61</fpage>–<lpage>69</lpage>. <pub-id pub-id-type="doi">10.1016/j.aca.2018.03.031</pub-id>.<pub-id pub-id-type="pmid">29729739</pub-id></mixed-citation>
    </ref>
    <ref id="ref7">
      <mixed-citation publication-type="journal" id="cit7"><name><surname>Gorshkov</surname><given-names>M. V.</given-names></name>; <name><surname>Good</surname><given-names>D. M.</given-names></name>; <name><surname>Lyutvinskiy</surname><given-names>Y.</given-names></name>; <name><surname>Yang</surname><given-names>H.</given-names></name>; <name><surname>Zubarev</surname><given-names>R. A.</given-names></name><article-title>Calibration
function for the Orbitrap FTMS accounting for the space charge effect</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2010</year>, <volume>21</volume>, <fpage>1846</fpage>–<lpage>1851</lpage>. <pub-id pub-id-type="doi">10.1016/j.jasms.2010.06.021</pub-id>.<pub-id pub-id-type="pmid">20696596</pub-id></mixed-citation>
    </ref>
    <ref id="ref8">
      <mixed-citation publication-type="journal" id="cit8"><name><surname>Kharchenko</surname><given-names>A.</given-names></name>; <name><surname>Vladimirov</surname><given-names>G.</given-names></name>; <name><surname>Heeren</surname><given-names>R. M.</given-names></name>; <name><surname>Nikolaev</surname><given-names>E. N.</given-names></name><article-title>Performance
of Orbitrap
mass analyzer at various space charge and non-ideal field conditions:
simulation approach</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2012</year>, <volume>23</volume>, <fpage>977</fpage>–<lpage>987</lpage>. <pub-id pub-id-type="doi">10.1007/s13361-011-0325-3</pub-id>.<pub-id pub-id-type="pmid">22354683</pub-id></mixed-citation>
    </ref>
    <ref id="ref9">
      <mixed-citation publication-type="journal" id="cit9"><name><surname>Boskamp</surname><given-names>T.</given-names></name>; <name><surname>Lachmund</surname><given-names>D.</given-names></name>; <name><surname>Casadonte</surname><given-names>R.</given-names></name>; <name><surname>Hauberg-Lotte</surname><given-names>L.</given-names></name>; <name><surname>Kobarg</surname><given-names>J. H.</given-names></name>; <name><surname>Kriegsmann</surname><given-names>J.</given-names></name>; <name><surname>Maass</surname><given-names>P.</given-names></name><article-title>Using the chemical
noise background in MALDI mass spectrometry imaging for mass alignment
and calibration</article-title>. <source>Anal. Chem.</source><year>2020</year>, <fpage>1301</fpage><pub-id pub-id-type="doi">10.1021/acs.analchem.9b04473</pub-id>.<pub-id pub-id-type="pmid">31793765</pub-id></mixed-citation>
    </ref>
    <ref id="ref10">
      <mixed-citation publication-type="journal" id="cit10"><name><surname>Bocker</surname><given-names>S.</given-names></name>; <name><surname>Makinen</surname><given-names>V.</given-names></name><article-title>Combinatorial approaches
for mass spectra recalibration</article-title>. <source>IEEE/ACM Trans.
Comput. Biol. Bioinf.</source><year>2008</year>, <volume>5</volume>, <fpage>91</fpage>–<lpage>100</lpage>. <pub-id pub-id-type="doi">10.1109/tcbb.2007.1077</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref11">
      <mixed-citation publication-type="journal" id="cit11"><name><surname>Kulkarni</surname><given-names>P.</given-names></name>; <name><surname>Kaftan</surname><given-names>F.</given-names></name>; <name><surname>Kynast</surname><given-names>P.</given-names></name>; <name><surname>Svatoš</surname><given-names>A.</given-names></name>; <name><surname>Böcker</surname><given-names>S.</given-names></name><article-title>Correcting mass shifts: a lock mass-free
recalibration
procedure for mass spectrometry imaging data</article-title>. <source>Anal. Bioanal. Chem.</source><year>2015</year>, <volume>407</volume>, <fpage>7603</fpage>–<lpage>7613</lpage>. <pub-id pub-id-type="doi">10.1007/s00216-015-8935-4</pub-id>.<pub-id pub-id-type="pmid">26345438</pub-id></mixed-citation>
    </ref>
    <ref id="ref12">
      <mixed-citation publication-type="journal" id="cit12"><name><surname>Tracy</surname><given-names>M. B.</given-names></name>; <name><surname>Chen</surname><given-names>H.</given-names></name>; <name><surname>Weaver</surname><given-names>D. M.</given-names></name>; <name><surname>Malyarenko</surname><given-names>D. I.</given-names></name>; <name><surname>Sasinowski</surname><given-names>M.</given-names></name>; <name><surname>Cazares</surname><given-names>L. H.</given-names></name>; <name><surname>Drake</surname><given-names>R. R.</given-names></name>; <name><surname>Semmes</surname><given-names>O. J.</given-names></name>; <name><surname>Tracy</surname><given-names>E. R.</given-names></name>; <name><surname>Cooke</surname><given-names>W. E.</given-names></name><article-title>Precision enhancement of MALDI-TOF
MS using high resolution peak detection and label-free alignment</article-title>. <source>Proteomics</source><year>2008</year>, <volume>8</volume>, <fpage>1530</fpage>–<lpage>1538</lpage>. <pub-id pub-id-type="doi">10.1002/pmic.200701146</pub-id>.<pub-id pub-id-type="pmid">18340636</pub-id></mixed-citation>
    </ref>
    <ref id="ref13">
      <mixed-citation publication-type="journal" id="cit13"><name><surname>Barry</surname><given-names>J. A.</given-names></name>; <name><surname>Robichaud</surname><given-names>G.</given-names></name>; <name><surname>Muddiman</surname><given-names>D. C.</given-names></name><article-title>Mass recalibration of FT-ICR mass
spectrometry imaging data using the average frequency shift of ambient
ions</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2013</year>, <volume>24</volume>, <fpage>1137</fpage>–<lpage>1145</lpage>. <pub-id pub-id-type="doi">10.1007/s13361-013-0659-0</pub-id>.<pub-id pub-id-type="pmid">23715870</pub-id></mixed-citation>
    </ref>
    <ref id="ref14">
      <mixed-citation publication-type="journal" id="cit14"><name><surname>Alexandrov</surname><given-names>T.</given-names></name><article-title>Spatial Metabolomics
and Imaging Mass Spectrometry in the Age of Artificial Intelligence</article-title>. <source>Annu. Rev. Biomed. Data Sci.</source><year>2020</year>, <volume>3</volume>, <fpage>61</fpage><pub-id pub-id-type="doi">10.1146/annurev-biodatasci-011420-031537</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref15">
      <mixed-citation publication-type="journal" id="cit15"><name><surname>Haug</surname><given-names>K.</given-names></name>; <name><surname>Salek</surname><given-names>R. M.</given-names></name>; <name><surname>Conesa</surname><given-names>P.</given-names></name>; <name><surname>Hastings</surname><given-names>J.</given-names></name>; <name><surname>De Matos</surname><given-names>P.</given-names></name>; <name><surname>Rijnbeek</surname><given-names>M.</given-names></name>; <name><surname>Mahendraker</surname><given-names>T.</given-names></name>; <name><surname>Williams</surname><given-names>M.</given-names></name>; <name><surname>Neumann</surname><given-names>S.</given-names></name>; <name><surname>Rocca-Serra</surname><given-names>P.</given-names></name>; et al. <article-title>MetaboLights–an open-access general-purpose
repository for metabolomics studies and associated meta-data</article-title>. <source>Nucleic Acids Res.</source><year>2013</year>, <volume>41</volume>, <fpage>D781</fpage>–<lpage>D786</lpage>. <pub-id pub-id-type="doi">10.1093/nar/gks1004</pub-id>.<pub-id pub-id-type="pmid">23109552</pub-id></mixed-citation>
    </ref>
    <ref id="ref16">
      <mixed-citation publication-type="journal" id="cit16"><name><surname>Alexandrov</surname><given-names>T.</given-names></name>; <name><surname>Ovchnnikova</surname><given-names>K.</given-names></name>; <name><surname>Palmer</surname><given-names>A.</given-names></name>; <name><surname>Kovalev</surname><given-names>V.</given-names></name>; <name><surname>Tarasov</surname><given-names>A.</given-names></name>; <name><surname>Stuart</surname><given-names>L.</given-names></name>; <name><surname>Nigmetzianov</surname><given-names>R.</given-names></name>; <name><surname>Fay</surname><given-names>D.</given-names></name>; <name><surname>Contributors</surname><given-names>K. M.</given-names></name><article-title>METASPACE:
A community-populated knowledge base of spatial metabolomes in health
and disease</article-title>. <source>BioRxiv</source><year>2019</year>, <elocation-id>539478</elocation-id><pub-id pub-id-type="doi">10.1101/539478</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref17">
      <mixed-citation publication-type="journal" id="cit17"><name><surname>Nielsen</surname><given-names>N.-P. V.</given-names></name>; <name><surname>Carstensen</surname><given-names>J. M.</given-names></name>; <name><surname>Smedsgaard</surname><given-names>J.</given-names></name><article-title>Aligning of
single and multiple wavelength chromatographic profiles for chemometric
data analysis using correlation optimised warping</article-title>. <source>J. Chromatogr. A</source><year>1998</year>, <volume>805</volume>, <fpage>17</fpage>–<lpage>35</lpage>. <pub-id pub-id-type="doi">10.1016/S0021-9673(98)00021-1</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref18">
      <mixed-citation publication-type="journal" id="cit18"><name><surname>Christin</surname><given-names>C.</given-names></name>; <name><surname>Smilde</surname><given-names>A. K.</given-names></name>; <name><surname>Hoefsloot</surname><given-names>H. C.</given-names></name>; <name><surname>Suits</surname><given-names>F.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P. L.</given-names></name><article-title>Optimized
time alignment algorithm for LC-MS data:
correlation optimized warping using component detection algorithm-selected
mass chromatograms</article-title>. <source>Anal. Chem.</source><year>2008</year>, <volume>80</volume>, <fpage>7012</fpage>–<lpage>7021</lpage>. <pub-id pub-id-type="doi">10.1021/ac800920h</pub-id>.<pub-id pub-id-type="pmid">18715018</pub-id></mixed-citation>
    </ref>
    <ref id="ref19">
      <mixed-citation publication-type="journal" id="cit19"><name><surname>Suits</surname><given-names>F.</given-names></name>; <name><surname>Lepre</surname><given-names>J.</given-names></name>; <name><surname>Du</surname><given-names>P.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Two-Dimensional
Method for Time Aligning Liquid Chromatography- Mass Spectrometry
Data</article-title>. <source>Anal. Chem.</source><year>2008</year>, <volume>80</volume>, <fpage>3095</fpage>–<lpage>3104</lpage>. <pub-id pub-id-type="doi">10.1021/ac702267h</pub-id>.<pub-id pub-id-type="pmid">18396914</pub-id></mixed-citation>
    </ref>
    <ref id="ref20">
      <mixed-citation publication-type="journal" id="cit20"><name><surname>Fischler</surname><given-names>M. A.</given-names></name>; <name><surname>Bolles</surname><given-names>R. C.</given-names></name><article-title>Random sample consensus: a paradigm for model fitting
with applications to image analysis and automated cartography</article-title>. <source>Commun. ACM</source><year>1981</year>, <volume>24</volume>, <fpage>381</fpage>–<lpage>395</lpage>. <pub-id pub-id-type="doi">10.1145/358669.358692</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref21">
      <mixed-citation publication-type="journal" id="cit21"><name><surname>Suits</surname><given-names>F.</given-names></name>; <name><surname>Hoekman</surname><given-names>B.</given-names></name>; <name><surname>Rosenling</surname><given-names>T.</given-names></name>; <name><surname>Bischoff</surname><given-names>R.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Threshold-avoiding
proteomics pipeline</article-title>. <source>Anal. Chem.</source><year>2011</year>, <volume>83</volume>, <fpage>7786</fpage>–<lpage>7794</lpage>. <pub-id pub-id-type="doi">10.1021/ac201332j</pub-id>.<pub-id pub-id-type="pmid">21879761</pub-id></mixed-citation>
    </ref>
    <ref id="ref22">
      <mixed-citation publication-type="journal" id="cit22"><name><surname>Noh</surname><given-names>S. A.</given-names></name>; <name><surname>Kim</surname><given-names>S.-M.</given-names></name>; <name><surname>Park</surname><given-names>S. H.</given-names></name>; <name><surname>Kim</surname><given-names>D.-J.</given-names></name>; <name><surname>Lee</surname><given-names>J. W.</given-names></name>; <name><surname>Kim</surname><given-names>Y. G.</given-names></name>; <name><surname>Moon</surname><given-names>J.-Y.</given-names></name>; <name><surname>Lim</surname><given-names>S.-J.</given-names></name>; <name><surname>Lee</surname><given-names>S.-H.</given-names></name>; <name><surname>Kim</surname><given-names>K. P.</given-names></name><article-title>Alterations in Lipid Profile of the Aging Kidney Identified
by MALDI Imaging Mass Spectrometry</article-title>. <source>J. Proteome
Res.</source><year>2019</year>, <volume>18</volume>, <fpage>2803</fpage>–<lpage>2812</lpage>. <pub-id pub-id-type="doi">10.1021/acs.jproteome.9b00108</pub-id>.<pub-id pub-id-type="pmid">31244212</pub-id></mixed-citation>
    </ref>
    <ref id="ref23">
      <mixed-citation publication-type="journal" id="cit23"><name><surname>Mittal</surname><given-names>P.</given-names></name>; <name><surname>Price</surname><given-names>Z. K.</given-names></name>; <name><surname>Lokman</surname><given-names>N. A.</given-names></name>; <name><surname>Ricciardelli</surname><given-names>C.</given-names></name>; <name><surname>Oehler</surname><given-names>M. K.</given-names></name>; <name><surname>Klingler-Hoffmann</surname><given-names>M.</given-names></name>; <name><surname>Hoffmann</surname><given-names>P.</given-names></name><article-title>Matrix Assisted Laser
Desorption/Ionization Mass Spectrometry Imaging (MALDI MSI) for Monitoring
of Drug Response in Primary Cancer Spheroids</article-title>. <source>Proteomics</source><year>2019</year>, <volume>19</volume>, <elocation-id>1900146</elocation-id><pub-id pub-id-type="doi">10.1002/pmic.201900146</pub-id>.</mixed-citation>
    </ref>
    <ref id="ref24">
      <mixed-citation publication-type="journal" id="cit24"><name><surname>Eriksson</surname><given-names>J. O.</given-names></name>; <name><surname>Rezeli</surname><given-names>M.</given-names></name>; <name><surname>Hefner</surname><given-names>M.</given-names></name>; <name><surname>Marko-Varga</surname><given-names>G.</given-names></name>; <name><surname>Horvatovich</surname><given-names>P.</given-names></name><article-title>Clusterwise peak detection and filtering
based on spatial
distribution to efficiently mine mass spectrometry imaging data</article-title>. <source>Anal. Chem.</source><year>2019</year>, <volume>91</volume>, <fpage>11888</fpage>–<lpage>11896</lpage>. <pub-id pub-id-type="doi">10.1021/acs.analchem.9b02637</pub-id>.<pub-id pub-id-type="pmid">31403280</pub-id></mixed-citation>
    </ref>
    <ref id="ref25">
      <mixed-citation publication-type="journal" id="cit25"><name><surname>Gerbig</surname><given-names>S.</given-names></name>; <name><surname>Golf</surname><given-names>O.</given-names></name>; <name><surname>Balog</surname><given-names>J.</given-names></name>; <name><surname>Denes</surname><given-names>J.</given-names></name>; <name><surname>Baranyai</surname><given-names>Z.</given-names></name>; <name><surname>Zarand</surname><given-names>A.</given-names></name>; <name><surname>Raso</surname><given-names>E.</given-names></name>; <name><surname>Timar</surname><given-names>J.</given-names></name>; <name><surname>Takats</surname><given-names>Z.</given-names></name><article-title>Analysis of
colorectal adenocarcinoma tissue by desorption electrospray ionization
mass spectrometric imaging</article-title>. <source>Anal. Bioanal. Chem.</source><year>2012</year>, <volume>403</volume>, <fpage>2315</fpage>–<lpage>2325</lpage>. <pub-id pub-id-type="doi">10.1007/s00216-012-5841-x</pub-id>.<pub-id pub-id-type="pmid">22447214</pub-id></mixed-citation>
    </ref>
    <ref id="ref26">
      <mixed-citation publication-type="journal" id="cit26"><name><surname>Robichaud</surname><given-names>G.</given-names></name>; <name><surname>Garrard</surname><given-names>K. P.</given-names></name>; <name><surname>Barry</surname><given-names>J. A.</given-names></name>; <name><surname>Muddiman</surname><given-names>D. C.</given-names></name><article-title>MSiReader: an open-source
interface to view and analyze high resolving power MS imaging files
on Matlab platform</article-title>. <source>J. Am. Soc. Mass Spectrom.</source><year>2013</year>, <volume>24</volume>, <fpage>718</fpage>–<lpage>721</lpage>. <pub-id pub-id-type="doi">10.1007/s13361-013-0607-z</pub-id>.<pub-id pub-id-type="pmid">23536269</pub-id></mixed-citation>
    </ref>
    <ref id="ref27">
      <mixed-citation publication-type="journal" id="cit27"><name><surname>Gibb</surname><given-names>S.</given-names></name>; <name><surname>Strimmer</surname><given-names>K.</given-names></name><article-title>MALDIquant: a versatile
R package for the analysis
of mass spectrometry data</article-title>. <source>Bioinformatics</source><year>2012</year>, <volume>28</volume>, <fpage>2270</fpage>–<lpage>2271</lpage>. <pub-id pub-id-type="doi">10.1093/bioinformatics/bts447</pub-id>.<pub-id pub-id-type="pmid">22796955</pub-id></mixed-citation>
    </ref>
    <ref id="ref28">
      <mixed-citation publication-type="journal" id="cit28"><name><surname>Bemis</surname><given-names>K. D.</given-names></name>; <name><surname>Harry</surname><given-names>A.</given-names></name>; <name><surname>Eberlin</surname><given-names>L. S.</given-names></name>; <name><surname>Ferreira</surname><given-names>C.</given-names></name>; <name><surname>van de Ven</surname><given-names>S. M.</given-names></name>; <name><surname>Mallick</surname><given-names>P.</given-names></name>; <name><surname>Stolowitz</surname><given-names>M.</given-names></name>; <name><surname>Vitek</surname><given-names>O.</given-names></name><article-title>Cardinal: an R package
for statistical analysis of mass spectrometry-based imaging experiments</article-title>. <source>Bioinformatics</source><year>2015</year>, <volume>31</volume>, <fpage>2418</fpage>–<lpage>2420</lpage>. <pub-id pub-id-type="doi">10.1093/bioinformatics/btv146</pub-id>.<pub-id pub-id-type="pmid">25777525</pub-id></mixed-citation>
    </ref>
    <ref id="ref29">
      <mixed-citation publication-type="journal" id="cit29"><name><surname>Ràfols</surname><given-names>P.</given-names></name>; <name><surname>Heijs</surname><given-names>B.</given-names></name>; <name><surname>del Castillo</surname><given-names>E.</given-names></name>; <name><surname>Yanes</surname><given-names>O.</given-names></name>; <name><surname>McDonnell</surname><given-names>L. A.</given-names></name>; <name><surname>Brezmes</surname><given-names>J.</given-names></name>; <name><surname>Pérez-Taboada</surname><given-names>I.</given-names></name>; <name><surname>Vallejo</surname><given-names>M.</given-names></name>; <name><surname>García-Altares</surname><given-names>M.</given-names></name>; <name><surname>Correig</surname><given-names>X.</given-names></name><article-title>rMSIproc: an R package
for mass spectrometry imaging data processing</article-title>. <source>Bioinformatics</source><year>2020</year>, <volume>36</volume>, <fpage>3618</fpage>–<lpage>3619</lpage>. <pub-id pub-id-type="doi">10.1093/bioinformatics/btaa142</pub-id>.<pub-id pub-id-type="pmid">32108859</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
