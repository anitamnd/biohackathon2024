<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Methods</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Methods</journal-id>
    <journal-title-group>
      <journal-title>Nature Methods</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1548-7091</issn>
    <issn pub-type="epub">1548-7105</issn>
    <publisher>
      <publisher-name>Nature Publishing Group US</publisher-name>
      <publisher-loc>New York</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10630141</article-id>
    <article-id pub-id-type="pmid">37813988</article-id>
    <article-id pub-id-type="publisher-id">2031</article-id>
    <article-id pub-id-type="doi">10.1038/s41592-023-02031-6</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>OPUS-DSD: deep structural disentanglement for cryo-EM single-particle analysis</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Luo</surname>
          <given-names>Zhenwei</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Ni</surname>
          <given-names>Fengyun</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-0480-3404</contrib-id>
        <name>
          <surname>Wang</surname>
          <given-names>Qinghua</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0009-0001-2124-6080</contrib-id>
        <name>
          <surname>Ma</surname>
          <given-names>Jianpeng</given-names>
        </name>
        <address>
          <email>jpma@fudan.edu.cn</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/013q1eq08</institution-id><institution-id institution-id-type="GRID">grid.8547.e</institution-id><institution-id institution-id-type="ISNI">0000 0001 0125 2443</institution-id><institution>Multiscale Research Institute of Complex Systems, </institution><institution>Fudan University, </institution></institution-wrap>Shanghai, China </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/013q1eq08</institution-id><institution-id institution-id-type="GRID">grid.8547.e</institution-id><institution-id institution-id-type="ISNI">0000 0001 0125 2443</institution-id><institution>Zhangjiang Fudan International Innovation Center, </institution><institution>Fudan University, </institution></institution-wrap>Shanghai, China </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="GRID">grid.517892.0</institution-id><institution-id institution-id-type="ISNI">0000 0005 0475 7227</institution-id><institution>Shanghai AI Laboratory, </institution></institution-wrap>Shanghai, China </aff>
      <aff id="Aff4"><label>4</label>Center for Biomolecular Innovation, Harcam Biomedicines, Shanghai, China </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>9</day>
      <month>10</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>9</day>
      <month>10</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <year>2023</year>
    </pub-date>
    <volume>20</volume>
    <issue>11</issue>
    <fpage>1729</fpage>
    <lpage>1738</lpage>
    <history>
      <date date-type="received">
        <day>22</day>
        <month>11</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>24</day>
        <month>8</month>
        <year>2023</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2023</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Cryo-electron microscopy (cryo-EM) captures snapshots of dynamic macromolecules, collectively illustrating the involved structural landscapes. This provides an exciting opportunity to explore the structural variations of macromolecules under study. However, traditional cryo-EM single-particle analysis often yields static structures. Here we describe OPUS-DSD, an algorithm capable of efficiently reconstructing the structural landscape embedded in cryo-EM data. OPUS-DSD uses a three-dimensional convolutional encoder–decoder architecture trained with cryo-EM images, thereby encoding structural variations into a smooth and easily analyzable low-dimension space. This space can be traversed to reconstruct continuous dynamics or clustered to identify distinct conformations. OPUS-DSD can offer meaningful insights into the structural variations of macromolecules, filling in the gaps left by traditional cryo-EM structural determination, and potentially improves the reconstruction resolution by reliably clustering similar particles within the dataset. These functionalities are especially relevant to the study of highly dynamic biological systems. OPUS-DSD is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/alncat/opusDSD">https://github.com/alncat/opusDSD</ext-link>.</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">OPUS-DSD is a neural network-based algorithm that reconstructs distinct conformations or continuous dynamics of the macromolecular structural landscape, starting from single-particle cryo-EM data.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Computational biophysics</kwd>
      <kwd>Computational models</kwd>
      <kwd>Cryoelectron microscopy</kwd>
      <kwd>Proteins</kwd>
      <kwd>Software</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Shanghai Municipal Science and Technology Major Project (No.2018SHZDZX01) and ZJLab, National Key Research and Development Program of China (No.2021YFF1200400).</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© Springer Nature America, Inc. 2023</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Main</title>
    <p id="Par3">Macromolecules are dynamic machines that use specialized motions to carry out their functions<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>. Structural biology aims to determine the three-dimensional (3D) structure of macromolecules to high resolution, and at the same time understand their functions by reconstructing the underlying dynamics. Cryo-electron microscopy (cryo-EM) single-particle analysis (SPA) is a powerful method for obtaining high-resolution 3D structures<sup><xref ref-type="bibr" rid="CR2">2</xref>–<xref ref-type="bibr" rid="CR4">4</xref></sup>. Conventional cryo-EM SPA reconstruction often produces only a single static 3D model. However, the large number of snapshots captured by cryo-EM preserves a huge amount of conformational and/or compositional heterogeneity that may be functionally important. Moreover, the flexibility of 3D macromolecules is a major bottleneck to the achievement of high resolution in cryo-EM SPA<sup><xref ref-type="bibr" rid="CR2">2</xref></sup>. Therefore, powerful analysis methods are needed to reliably recover structural heterogeneity and help improve the resolution of cryo-EM reconstruction for macromolecules.</p>
    <p id="Par4">The conventional tool for resolving heterogeneity in cryo-EM datasets is 3D classification<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR6">6</xref></sup>, which models different conformations as individual 3D volumes. However, 3D classification scales poorly with respect to the number of conformations, and falls short of resolving structural dynamics composed of a large number of transitional conformations. Existing approaches such as multi-body refinement in RELION<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>, and 3D variability analysis in cryoSPARC<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> model continuous conformation changes using linear combinations of reaction coordinates. The multi-body refinement in RELION is particularly effective at modeling large-scale conformational dynamics of rigid-body components, yielding high-resolution structures for otherwise unresolved densities. It becomes less effective, however, for macromolecular systems in which dynamic structural components do not move as rigid bodies.</p>
    <p id="Par5">Recently, deep learning has emerged as a viable solution for handling structural heterogeneity. There are a number of deep learning approaches to probe structural heterogeneity, including Multi-CryoGAN<sup><xref ref-type="bibr" rid="CR9">9</xref></sup>, e2gmm<sup><xref ref-type="bibr" rid="CR10">10</xref></sup> and 3DFlex in cryoSPARC<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>. Multi-CryoGAN is based on a generative adversarial network and its validity has been demonstrated using synthetic data. E2gmm represents the 3D structure using a set of Gaussians, while 3DFlex uses a neural network to fit the 3D displacement field of each particle. By contrast, a neural network-based method, cryoDRGN, uses two-dimensional (2D) images as input, and the particle poses are determined by consensus refinement<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>. This method adopted a neural representation for 3D structures and leveraged a variational autoencoder (VAE)<sup><xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR14">14</xref></sup> to train the neural network that translates 2D images to 3D volumes end-to-end.</p>
    <p id="Par6">In the 2D image to 3D structure translation formulation as implemented in cryoDRGN<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, the landscape of 3D structures is in a low-dimension latent space. Translating a 2D image to a 3D structure is equivalent to mapping the 2D image to the encoding of its underlying 3D structure in latent space using neural networks. Both the encoding of the 2D image to latent code and the decoding of the latent code to a 3D structure are performed by neural networks. The continuous transformation between 2D image and 3D structure can then be learned end-to-end. Despite the use of neural networks, recovering the landscape of 3D structures using only 2D images is still inherently ill-posed, that is, the unknown 3D structures are of much higher dimensionality than the available 2D data. Furthermore, the pose parameters determined by consensus refinement are provided only for resolved densities.</p>
    <p id="Par7">The smoothness of latent space is critical for both resolving continuous structural heterogeneity and reliably recovering the distribution of conformations in cryo-EM datasets. A smooth latent space ensures that the neural network can generate continuous conformations when traversing the latent space, and guarantees the clustering of images with similar structures. Popular methods to encourage the smoothness of latent space are the VAE and its extensions, including β-VAE<sup><xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR14">14</xref></sup>, which apply variational Bayesian learning to the distribution of latent variables (more details can be found in ‘Training objectives’ subsection in <xref rid="Sec10" ref-type="sec">Methods</xref>).</p>
    <p id="Par8">In this study, we present a neural network-based method, OPUS deep structural disentanglement (OPUS-DSD), for 3D structural heterogeneity analysis. Built upon cryoDRGN 1.0 (ref. <sup><xref ref-type="bibr" rid="CR12">12</xref></sup>), OPUS-DSD incorporates a large number of methodological improvements, including the use of 3D convolutional architecture, that is, neural volumes<sup><xref ref-type="bibr" rid="CR15">15</xref>–<xref ref-type="bibr" rid="CR17">17</xref></sup>, and latent priors to encourage the smoothness of the latent space. By systematic testing on synthetic and real cryo-EM datasets, we demonstrate the performance of OPUS-DSD in resolving structural heterogeneity, even at lower signal-to-noise ratios. OPUS-DSD not only reconstructs the large-scale continuous dynamics, but also shows the associated compositional changes. By effectively reducing the level of structural heterogeneity in selected particles, OPUS-DSD also improves structural determination in cryo-EM SPA reconstructions.</p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>Design of OPUS-DSD</title>
      <p id="Par9">OPUS-DSD is designed to elucidate the structural heterogeneity in a cryo-EM dataset using 2D images as input. Overall, it contains two primary components: an encoder–decoder network to convert the 2D cryo-EM image to its corresponding 3D structure (solid red box in Fig. <xref rid="Fig1" ref-type="fig">1a</xref>), and a prior in latent space that facilitates the encoding of structural information in 2D images (dashed red box in Fig. <xref rid="Fig1" ref-type="fig">1a</xref>).<fig id="Fig1"><label>Fig. 1</label><caption><title>Architecture of OPUS-DSD.</title><p><bold>a</bold>, Schematic diagram of the architecture. Pose refers to the projection direction of input with respect to the consensus model. For simplicity, the standard Gaussian prior for latent distribution as well as the smoothness and sparseness priors for the 3D volume are omitted in this chart. <bold>b</bold>, Architecture of the encoder of OPUS-DSD. This diagram shows the encoder that translates a 2D cryo-EM image into the latent encoding. The top row denotes the dimensions of the intermediate tensors. The arrow links the input and output of the operation above. FC, fully connected layer; Conv3D, 3D convolution; ST, spatial transformer (which back-projects the 2D image to a 3D volume). The number of channels of the convolution kernel can be derived from the dimensions of its input and output. The ellipsis represents the repeating of the preceding operation until the tensor reaches the output dimension. All convolutions and fully connected layers except the last one had LeakyReLU<sup><xref ref-type="bibr" rid="CR33">33</xref></sup> (leaky rectified linear unit) non-linearity with a negative slope of 0.2. <bold>c</bold>, Architecture of the decoder of OPUS-DSD. This diagram shows the decoder that translates the latent encoding <italic>z</italic> into a reconstructed 2D projection. Conv3D<sup>T</sup>, 3D transposed convolution; ST, spatial transformer, which here renders the 3D volume into the 2D image of desired resolution. All transposed convolutions except the last one and fully connected layers have LeakyReLU non-linearity with a negative slope of 0.2.</p></caption><graphic xlink:href="41592_2023_2031_Fig1_HTML" id="d32e417"/></fig></p>
      <p id="Par10">The encoder–decoder network works as follows. The encoder takes a 2D cryo-EM image as input, and estimates the distribution of its associated latent code <italic>z</italic> in a low-dimension space <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathbb{R}}}^{d}$$\end{document}</tex-math><mml:math id="M2"><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq1.gif"/></alternatives></inline-formula>. The decoder then produces a 3D volume by sampling a latent code from the distribution estimated by the encoder (Fig. <xref rid="Fig1" ref-type="fig">1a</xref>). The latent code is assumed to follow a Gaussian distribution, for which the mean <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z\in {{\mathbb{R}}}^{d}$$\end{document}</tex-math><mml:math id="M4"><mml:mrow><mml:mi>z</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq2.gif"/></alternatives></inline-formula> and standard variation <inline-formula id="IEq3"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma \in {{\mathbb{R}}}^{d}$$\end{document}</tex-math><mml:math id="M6"><mml:mrow><mml:mi>σ</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq3.gif"/></alternatives></inline-formula> are estimated by the encoder<sup><xref ref-type="bibr" rid="CR14">14</xref></sup>. The 3D volume is represented as a discrete grid of voxels, <italic>V</italic>(<bold><italic>x</italic></bold>), where <inline-formula id="IEq4"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{x}}\in {{\mathbb{R}}}^{3}$$\end{document}</tex-math><mml:math id="M8"><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq4.gif"/></alternatives></inline-formula> is a point in 3D space. This explicit 3D voxel grid <italic>V</italic>(<bold><italic>x</italic></bold>) is then transformed into a 2D reconstruction with specified pose and contrast transfer function (CTF) parameters according to the differentiable cryo-EM image formation model. The neural architecture of OPUS-DSD can then be trained end-to-end by reconstructing each input image and minimizing the squared reconstruction error.</p>
      <p id="Par11">In addition, we incorporated a latent prior to promote a specific type of geometry in latent space (Fig. <xref rid="Fig1" ref-type="fig">1a</xref>). The structural heterogeneity is resolved within the encoder–decoder architecture of OPUS-DSD by integrating structural information into the latent space. That is, the variation of latent codes should primarily correspond to the variation in 3D structures. This kind of latent space specifies a geometry in which the similarity between 3D structures is proportional to the distance between their latent codes. In other words, the latent codes of similar 3D structures are clustered together, while the latent codes of distinct 3D structures are far apart. This not only ensures the smoothness of the latent space but also enhances the correlation between latent codes and structural variations. The formulation of this multi-component latent prior is detailed in <xref rid="Sec10" ref-type="sec">Methods</xref>. For a given latent code, the latent codes of similar 3D structures can be identified as its <italic>k</italic> nearest neighbors (kNN), whereas those of different 3D structures can be found as its <italic>k</italic> furthest points (kFP) (Fig. <xref rid="Fig1" ref-type="fig">1a</xref>). The latent prior is implemented by querying the kNN and kFP from a dynamically updated memory bank that stores the latent codes of all images. Furthermore, we implemented the reconstruction loss to guide the neural network to generate an ensemble of 3D structures congruent with the cryo-EM dataset. Concurrently, the latent prior refines the geometry of the latent space, providing a regularizing effect that enables the neural network to better capture the structural dynamics.</p>
      <p id="Par12">The encoder network converts the 2D input to latent vector <italic>z</italic> by going through a series of intermediate representations (shown as different shapes in Fig. <xref rid="Fig1" ref-type="fig">1b</xref>). The imputation of pose information to the 2D projection is performed by back-projection as follows. The 2D projection of size <italic>D</italic><sup>2</sup> (a square) is first converted into a pseudo 3D volume (first cube) by repeating along the <italic>z</italic> axis <italic>D</italic> times. Given that the pose of the pseudo 3D volume remains the same as the original 2D projection, a spatial transformer module<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> is introduced to transform the pseudo volume into the canonical pose, matching the consensus model. The spatial transformer enables neural networks to disentangle object pose from shape and texture in images, thereby realizing spatial invariance<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>. In OPUS-DSD, the spatial transformer aligns pseudo volumes with the consensus model by performing rotations using predetermined poses, thereby enabling different pseudo volumes with varying poses to be brought back to the same canonical pose, aiding the encoder to distinguish structural heterogeneities from pose variations. It is worth noting that the spatial transformer in this context is not trainable. Subsequently, the aligned pseudo 3D volume is down-sampled to a 1<sup>3</sup> cube with 512 channels using six consecutive strided convolutions<sup><xref ref-type="bibr" rid="CR16">16</xref></sup> with a kernel size of 4. Then the 1<sup>3</sup> cube with 512 channels is flattened into a 512-dimension vector (first rectangle) that is transformed into the distribution of latent code by estimating the mean <italic>z</italic> and standard deviation <italic>σ</italic> via the application of two fully connected layers with non-linearity.</p>
      <p id="Par13">To ensure the smoothness of the 3D density maps generated by the neural network and avoid overfitting<sup><xref ref-type="bibr" rid="CR3">3</xref>,<xref ref-type="bibr" rid="CR19">19</xref></sup>, the decoder in OPUS-DSD uses a convolutional architecture, neural volumes<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, that converts the latent vector to a smooth 3D volume (Fig. <xref rid="Fig1" ref-type="fig">1c</xref>). First, a series of fully connected layers with non-linearity are applied to transform the sampled latent vector (second rectangle) into a 2,048-dimensional representation, resulting in a 1<sup>3</sup> cube with 2,048 channels. Then the 2,048 × 1<sup>3</sup> cube is up-sampled into a 1 × 256<sup>3</sup> 3D volume (last cube) using eight consecutive transposed convolutions<sup><xref ref-type="bibr" rid="CR16">16</xref></sup>. The kernel size is 2 for the first two convolutions and 4 for the remaining convolutions. The 2D reconstruction (square) is generated from the 256<sup>3</sup> volume by the spatial transformer with predetermined pose and CTF parameters<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>. Although only the process to generate a 256<sup>3</sup> volume from a latent code is shown, the decoder can produce a 3D volume in any size by changing the intermediate tensors.</p>
      <p id="Par14">Given that OPUS-DSD is designed to improve on cryoDRGN 1.0 (ref. <sup><xref ref-type="bibr" rid="CR12">12</xref></sup>), the performance of these two methods is compared using synthetic and real datasets. For simplicity, cryoDRGN 1.0 is referred to as cryoDRGN hereafter.</p>
    </sec>
    <sec id="Sec4">
      <title>Pre-catalytic spliceosome</title>
      <p id="Par15">OPUS-DSD was used to analyze the structural heterogeneity of the pre-catalytic spliceosome (EMPIAR-10180, ref. <sup><xref ref-type="bibr" rid="CR20">20</xref></sup>) to enable direct comparison with other methods<sup><xref ref-type="bibr" rid="CR7">7</xref>,<xref ref-type="bibr" rid="CR10">10</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup>. We trained a 12-dimensional latent variable model using the consensus refinement results deposited in EMPIAR-10180. Uniform manifold approximation and projection (UMAP) visualization<sup><xref ref-type="bibr" rid="CR21">21</xref></sup> of the latent space of OPUS-DSD shows 20 classes using the Kmeans algorithm (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>). By reconstructing the density maps using the cluster centers as input for the decoder of OPUS-DSD, those clusters were found to represent different combinations of spliceosome subcomplexes, namely core, foot, helicase and SF3b, as previously defined<sup><xref ref-type="bibr" rid="CR7">7</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2b</xref> and Extended Data Fig. <xref rid="Fig7" ref-type="fig">1a</xref>). For instance, class 12 represents the spliceosome with all four expected subcomplexes, class 10 shows a spliceosome with an additional U2 core<sup><xref ref-type="bibr" rid="CR22">22</xref></sup>, while class 18 has only the core and helicase, and class 14 lacks SF3b. Similar compositional heterogeneities were also detected by cryoDRGN<sup><xref ref-type="bibr" rid="CR12">12</xref></sup> but not by e2gmm<sup><xref ref-type="bibr" rid="CR10">10</xref></sup>. The densities for each of the four subcomplexes in these structures agreed very well with their ground-truth high-resolution structures obtained by multi-body refinement<sup><xref ref-type="bibr" rid="CR7">7</xref></sup> (Extended Data Fig. <xref rid="Fig7" ref-type="fig">1b</xref>). Furthermore, traversal along the first principal component (PC1) in principal component analysis (PCA) of the latent space showed distinct conformations. The structures at the two ends of PC1 correspond to two opposite conformations. The structure at the negative end of PC1 shows an ‘open’ conformation in which SF3b stays on the top of the core and the regions highlighted in the yellow ellipse and circle are far apart (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>). By contrast, the structure at the positive end of PC1 shows a ‘closed’ conformation in which SF3b is almost folded onto the core, the regions enclosed in the yellow ellipse and circle come together in space, and a chain appears in the yellow ellipses connecting helicase and SF3b. The emergence of this chain was not previously reported. Traversal along the PC1 in Supplementary Video <xref rid="MOESM4" ref-type="media">1</xref> shows the continuous dynamics between the open and closed conformations, highlighting the synchronous movements of the subcomplexes, that is, the helicase bends towards the foot while SF3b folds onto the core. Moreover, displacement of SF3b between these two conformations was observed (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>, green arrows).<fig id="Fig2"><label>Fig. 2</label><caption><title>Heterogeneity analysis on the pre-catalytic spliceosome (EMPIAR-10180).</title><p><bold>a</bold>, UMAP visualization of the 12-dimensional latent space of all particles encoded by OPUS-DSD. Solid black dots represent the cluster centers for labeled classes. <bold>b</bold>, Conformations with major compositional heterogeneities determined using OPUS-DSD. The density maps were generated by the decoder of OPUS-DSD with the corresponding class centers shown in <bold>a</bold>. Class 12 is the expected structure of the pre-catalytic spliceosome, class 10 is a complete structure with the U2 core, class 18 only has the core, and class 14 lacks the SF3b subcomplex. <bold>c</bold>, Open and closed conformations of the spliceosome generated along the PC1 of the latent space. The open and closed conformations were generated at the PC1 with an amplitude of −1.1 and 1.0, respectively. The superposition shows the displacement of SF3b and helicase between these two conformations as indicated by the green arrows. The yellow dashed ellipses highlight the occupancy differences of a chain between helicase and SF3b in different conformations. The yellow dashed circles mark the domain in SF3b that connects to this chain. All maps were contoured at the same level and visualized using ChimeraX<sup><xref ref-type="bibr" rid="CR34">34</xref></sup>.</p></caption><graphic xlink:href="41592_2023_2031_Fig2_HTML" id="d32e717"/></fig></p>
    </sec>
    <sec id="Sec5">
      <title><italic>Plasmodium falciparum</italic> 80S ribosome</title>
      <p id="Par16">OPUS-DSD was used to analyze the structural heterogeneity of the <italic>Plasmodium falciparum</italic> 80S (<italic>Pf</italic>80S) ribosome (EMPIAR-10028, ref. <sup><xref ref-type="bibr" rid="CR23">23</xref></sup>), which was studied by cryoDRGN and multi-body refinement<sup><xref ref-type="bibr" rid="CR7">7</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup>. We trained a 12-dimensional latent variable model using the consensus refinement results from RELION 3.1. The UMAP visualization of the latent space of OPUS-DSD showed clusters with a greater degree of separation (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>) than that of cryoDRGN<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>. Furthermore, we obtained 20 classes after Kmeans clustering in latent space and reconstructed their density maps by supplying the cluster centers to the decoder of OPUS-DSD. Classes 6, 7, 8, 9, 15 and 16 all harbor an RNA strand in the region highlighted by a red ellipse, which is absent in other classes (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>). The existence of this heterogeneity was confirmed by comparing class 8 with the consensus model at a lower contour level (Extended Data Fig. <xref rid="Fig8" ref-type="fig">2</xref>), and was reported by cryoDRGN<sup><xref ref-type="bibr" rid="CR12">12</xref></sup> as well. Traversal along PC1 in the latent space uncovered distinct conformations and their interconnections (Supplementary Video <xref rid="MOESM5" ref-type="media">2</xref>). The structures at the positive or negative end of PC1 are denoted as the positive or negative conformations, respectively, with the red arrows indicating the relative displacement between them (Fig. <xref rid="Fig3" ref-type="fig">3c,d</xref>). Following the division of the <italic>Pf</italic>80S ribosome into three subunits, head, large subunit (LSU) and small subunit (SSU), in the published multi-body refinement<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>, the two sides of the LSU move in opposite directions. In the positive conformation there is an RNA (marked by the yellow ellipse) connecting the SSU and LSU, which becomes absent in the negative conformation (Fig. <xref rid="Fig3" ref-type="fig">3c</xref>). A series of intermediate structures along the PC1 in Supplementary Video <xref rid="MOESM5" ref-type="media">2</xref> show how this RNA slides out of its original site in the SSU and docks onto the LSU. This kind of visualization is more difficult for multi-body analysis because it involves a series of small-scale occupancy changes during transition. In addition, at the back of the <italic>Pf</italic>80S ribosome a peripheral RNA strand gradually moves closer to its binding site on the LSU in the positive conformation and forms a new link (marked by the orange ellipse) with the LSU, while the head and LSU perform coordinated movements during this transition (Fig. <xref rid="Fig3" ref-type="fig">3d</xref> and Supplementary Video <xref rid="MOESM6" ref-type="media">3</xref>).<fig id="Fig3"><label>Fig. 3</label><caption><title>Heterogeneity analysis of the <italic>Pf</italic>80S ribosome (EMPIAR-10028).</title><p><bold>a</bold>, UMAP visualization of the 12-dimensional latent space of all particles encoded by OPUS-DSD. Solid black dots represent the cluster centers for labeled classes. <bold>b</bold>, Twenty density maps generated by the decoder of OPUS-DSD using the cluster centers shown in <bold>a</bold> as inputs. Red dashed ellipses highlight the presence of a peripheral RNA between SSU and LSU in the corresponding classes. <bold>c</bold>, Change in occupancy of an RNA according to conformation. The negative and positive conformations were generated at the PC1 with an amplitude of −1.4 and 1.8, respectively. Their superposition shows the displacement of different subunits as indicated by the red arrows. The yellow dashed ellipses highlight compositional differences of that RNA. <bold>d</bold>, Change in occupancy of a chain between a peripheral RNA and the LSU in the positive and negative conformations. The orange dashed ellipses highlight the compositional differences of that chain. Red arrows show the displacement of different subunits. All maps were contoured at the same level and visualized using ChimeraX.</p></caption><graphic xlink:href="41592_2023_2031_Fig3_HTML" id="d32e817"/></fig></p>
    </sec>
    <sec id="Sec6">
      <title><italic>Saccharomyces cerevisiae</italic> 80S ribosome</title>
      <p id="Par17">OPUS-DSD was used to analyze the structural heterogeneity of a smaller dataset of the <italic>Saccharomyces cerevisiae</italic> 80S (<italic>Sc</italic>80S) ribosome containing 60,363 images (EMPIAR-10002, ref. <sup><xref ref-type="bibr" rid="CR24">24</xref></sup>). We trained an eight-dimensional latent space model using 90% of images in this dataset. UMAP visualization of the latent space of OPUS-DSD and cryoDRGN showed similar clustering patterns (Fig. <xref rid="Fig4" ref-type="fig">4a</xref> and Extended Data Fig. <xref rid="Fig9" ref-type="fig">3a</xref>). However, OPUS-DSD uncovered many interesting structural heterogeneities. First, a single 60S class was identified (class 0 in Fig. <xref rid="Fig4" ref-type="fig">4b</xref>) uniquely by OPUS-DSD. Second, OPUS-DSD showed the movements of an RNA strand that binds with the 60S subunit (Fig. <xref rid="Fig4" ref-type="fig">4b</xref>, highlighted in red dashed boxes; Extended Data Fig. <xref rid="Fig10" ref-type="fig">4a</xref>). This movement can also be observed in Supplementary Video <xref rid="MOESM7" ref-type="media">4</xref> (which consists of a series of states along the PC1 of the latent space) and appears to be coordinated with the rotation of the 40S subunit. Traversal of the PC1 of the latent space in the cryoDRGN results also suggested this movement (Supplementary Video <xref rid="MOESM8" ref-type="media">5</xref>). Third, the red solid boxes in Fig. <xref rid="Fig4" ref-type="fig">4b</xref> mark two different binding locations of an RNA strand, which were not observed in the cryoDRGN results at this contour level (Extended Data Fig. <xref rid="Fig9" ref-type="fig">3b</xref>). Last, OPUS-DSD showed the large-scale displacement of the 40S subunit between different classes (Fig. <xref rid="Fig4" ref-type="fig">4c</xref>, Extended Data Fig. <xref rid="Fig10" ref-type="fig">4b</xref> and Supplementary Video <xref rid="MOESM7" ref-type="media">4</xref>). At the same contour level, the density map of class 9 reconstructed by the trained decoder of OPUS-DSD showed a much more complete 40S subunit than the consensus model by RELION using all particles (Fig. <xref rid="Fig4" ref-type="fig">4d</xref>), which also confirmed the high mobility of this region. The density map from class 8 by cryoDRGN also partially recovered the missing densities of the 40S subunit (Extended Data Fig. <xref rid="Fig9" ref-type="fig">3c</xref>, red ellipses) when contoured at the same level.<fig id="Fig4"><label>Fig. 4</label><caption><title>Heterogeneity analysis of the <italic>Sc</italic>80S ribosome (EMPIAR: 10002).</title><p><bold>a</bold>, UMAP visualization of the eight-dimensional latent space of all particles encoded by OPUS-DSD. Solid black dots represent the cluster centers for labeled classes. <bold>b</bold>, Sixteen density maps reconstructed by the decoder of OPUS-DSD using the Kmeans clustering centers in its eight-dimensional latent space as inputs. The different locations of two RNA strands in different conformations are highlighted by the red solid and dashed boxes, respectively. <bold>c</bold>, Superimposition of class 1 and class 6 to show the displacement of 40S subunits highlighted in the red dashed boxes. Red arrows indicate the displacement directions. 60S is highlighted in a green dashed ellipse. <bold>d</bold>, The density map of class 9 is more complete than that reconstructed using all particles. Both maps are contoured at the same level and visualized by ChimeraX.</p></caption><graphic xlink:href="41592_2023_2031_Fig4_HTML" id="d32e904"/></fig></p>
    </sec>
    <sec id="Sec7">
      <title>Synthetic NEXT complex data</title>
      <p id="Par18">OPUS-DSD was further tested on the synthetic data of the nuclear exosome-targeting (NEXT) complex, a highly mobile system. The NEXT complex has a dumbbell shape, in which two MTR4 helicase domains<sup><xref ref-type="bibr" rid="CR25">25</xref></sup> located at the two ends are connected by a ZCCHC8 center formed by two stranded helices. Starting from the structure of the NEXT complex determined in our own group (Fig. <xref rid="Fig5" ref-type="fig">5a</xref> and Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>), eight different conformations were generated by shifting the MTR4 helicase domains relative to the ZCCHC8 center (Fig. <xref rid="Fig5" ref-type="fig">5b</xref>). The synthetic data were constructed with a uniform distribution of the eight different conformations, that is, each conformation has 8,000 particles. The synthetic NEXT complex dataset with 64,000 particles yielded a consensus model using cryoSPARC (Fig. <xref rid="Fig5" ref-type="fig">5c</xref>).<fig id="Fig5"><label>Fig. 5</label><caption><title>Heterogeneity analysis of the synthetic dataset of the NEXT complex with a signal-to-noise ratio of 0.05.</title><p><bold>a</bold>, The starting atomic model of the NEXT complex. <bold>b</bold>, The ground-truth density maps of the NEXT complex. Of the eight conformations, conformations <italic>a</italic>,<italic>d</italic>,<italic>e</italic> are similar and difficult to distinguish, and conformations <italic>f</italic>,<italic>g</italic>,<italic>h</italic> have larger shifts in the MTR domains. <bold>c</bold>, The consensus map reconstructed by cryoSPARC. <bold>d</bold>, UMAP visualization of the eight-dimensional latent space of all particles encoded by OPUS-DSD and cryoDRGN. Solid black dots represent the cluster centers for labeled classes, identified using the Kmeans algorithm. <bold>e</bold>, The distribution of particles in the clusters in the latent space of OPUS-DSD. Bars are colored as the ground-truth density maps in <bold>b</bold>. Entropy is defined as the average of <inline-formula id="IEq5"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$-{\sum }_{i}{p}_{i}\log {p}_{i}$$\end{document}</tex-math><mml:math id="M10"><mml:mrow><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mi>log</mml:mi><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq5.gif"/></alternatives></inline-formula> for each cluster, where <inline-formula id="IEq6"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${p}_{i}=\frac{{n}_{i}}{{\sum }_{i}{n}_{i}}$$\end{document}</tex-math><mml:math id="M12"><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq6.gif"/></alternatives></inline-formula>, and <italic>n</italic><sub><italic>i</italic></sub> is the number of particles in the ground-truth conformation <italic>i</italic>. <bold>f</bold>, The distribution of particles in the clusters in the latent space of cryoDRGN. <bold>g</bold>, Translation–rotation plot for the upper MTR4 domain for results from both methods. <bold>h</bold>, Translation–rotation plot for the lower MTR4 domain for results from both methods. The movements were measured for the upper (<bold>g</bold>) or lower (<bold>h</bold>) MTR4 domains relative to the ZCCHC8 of each conformation using Dyndom<sup><xref ref-type="bibr" rid="CR35">35</xref></sup> with the ground-truth conformation <italic>d</italic> as a reference.</p><p><xref rid="MOESM9" ref-type="media">Source data</xref></p></caption><graphic xlink:href="41592_2023_2031_Fig5_HTML" id="d32e1088"/></fig></p>
      <p id="Par19">When the signal-to-noise ratio was 0.05, OPUS-DSD and cryoDRGN differed significantly in the clustering results and 3D density maps (Fig. <xref rid="Fig5" ref-type="fig">5d</xref>). In the UMAP visualization of latent space, clusters of OPUS-DSD were better separated than those of cryoDRGN (Fig. <xref rid="Fig5" ref-type="fig">5d</xref>). Judging by the quality of the density map generated by the decoders of both methods, OPUS-DSD delivered better density maps with resolutions similar to that of the consensus model (Extended Data Fig. <xref rid="Fig11" ref-type="fig">5a</xref>), while cryoDRGN produced density maps with very low-resolution MTR domains and noise in the ZCCHC8 center (Extended Data Fig. <xref rid="Fig11" ref-type="fig">5b</xref>). OPUS-DSD identified some clusters with high accuracy (Fig. <xref rid="Fig5" ref-type="fig">5e</xref>). For example, class 1 recovered approximately 67% of particles belonging to conformation <italic>f</italic> (Fig. <xref rid="Fig5" ref-type="fig">5e</xref>), and the 3D reconstruction using class 1 also resembled conformation <italic>f</italic> (Extended Data Fig. <xref rid="Fig11" ref-type="fig">5c</xref>). In contrast, cryoDRGN yielded a more even distribution of the particles with high classification errors in all classes (Fig. <xref rid="Fig5" ref-type="fig">5f</xref>), even for class 7 with the highest dominating conformation, only 28% of particles were from conformation <italic>f</italic>. Using entropy as a metric, the average entropy value for clusters in OPUS-DSD (at 0.756) was lower than that for cryoDRGN (at 0.882), where the entropy of a uniform distribution of conformations was 0.903. Comparing the density maps generated by cryoSPARC using classes from either method, the maps from OPUS-DSD were generally of higher quality than those from cryoDRGN (Extended Data Fig. <xref rid="Fig11" ref-type="fig">5c,d</xref>). In translation–rotation plots, the classes from cryoDRGN showed little difference and the rotations of MTR4 relative to ZCCHC8 were clustered within 10° (Fig. <xref rid="Fig5" ref-type="fig">5g,h</xref>, blue dots). The results of OPUS-DSD, however, showed a much wider range of structural changes (Fig. <xref rid="Fig5" ref-type="fig">5g,h</xref>, red dots), agreeing with the structural changes in ground-truth conformations (Fig. <xref rid="Fig5" ref-type="fig">5g,h</xref>, green dots). For example, the translations and rotations of MTR4 in class 1 of OPUS-DSD closely resembled conformation <italic>f</italic>, while classes 3 and 5 closely resembled conformations <italic>g</italic> and <italic>b</italic>, respectively (Fig. <xref rid="Fig5" ref-type="fig">5g,h</xref>). Hence, OPUS-DSD clearly recovered more ground-truth structural heterogeneities in this case. Furthermore, the average resolution of density maps reconstructed by classes from OPUS-DSD was also higher, suggesting its improved classification accuracy (Extended Data Fig. <xref rid="Fig11" ref-type="fig">5c,d</xref>).</p>
      <p id="Par20">When the signal-to-noise ratio increases to 0.1, both methods performed similarly and recovered most ground-truth conformations (Extended Data Fig. <xref rid="Fig12" ref-type="fig">6</xref>). However, there were still noticeable differences between the 3D density maps from their decoders (Extended Data Fig. <xref rid="Fig12" ref-type="fig">6g,h</xref>). The density maps from OPUS-DSD (Extended Data Fig. <xref rid="Fig12" ref-type="fig">6g</xref>) had a similar resolution to the consensus model across the entire complex. In contrast, the density maps from cryoDRGN were of a higher resolution than the consensus model for the central ZCCHC8 domain but a lower resolution for the MTR domains, especially in classes with larger shifts (Extended Data Fig. <xref rid="Fig12" ref-type="fig">6h</xref>).</p>
      <p id="Par21">The synthetic data of the NEXT complex also provided an ideal test for assessing the contributions of some of the methodological designs in OPUS-DSD. At a signal-to-noise ratio of 0.05, we found that turning off the disentanglement prior tended to reduce the classification accuracy of clustering results, most significantly for classes 1, 2, 3, 5 and 7 (Extended Data Fig. <xref rid="Fig13" ref-type="fig">7a,b</xref>). Similar behaviors were observed when turning off data augmentation, where the classification accuracy decreased in the latent space of OPUS-DSD, most significantly for classes 2, 3, 5, 6, and 7 (Extended Data Fig. <xref rid="Fig13" ref-type="fig">7a,c</xref>). In addition, the presence of data augmentation decreased the validation error and improved the generalization on the <italic>Sc</italic>80S ribosome (Extended Data Fig. <xref rid="Fig13" ref-type="fig">7d,e</xref>).</p>
    </sec>
    <sec id="Sec8">
      <title>Real cryo-EM data of the NEXT complex</title>
      <p id="Par22">Next, OPUS-DSD was tested on experimental data of the NEXT complex collected in our own group, which contained 224,354 particles after multiple rounds of 2D and 3D classifications (Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref> and Supplementary Fig. <xref rid="MOESM1" ref-type="media">1</xref>). Given that the complete NEXT complex is too dynamic to be determined to high resolution, signals of one MTR4 helicase domain were subtracted by RELION to facilitate cryo-EM SPA reconstruction<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>. Consensus refinement using the 224,354 particles of the NEXT complex produced a resolution of 5.59 Å measured using the gold-standard Fourier shell correlation (FSC) curve at 0.143 (ref. <sup><xref ref-type="bibr" rid="CR27">27</xref></sup>) (Fig. <xref rid="Fig6" ref-type="fig">6a</xref>). OPUS-DSD and cryoDRGN were used to analyze the structural heterogeneity by learning a latent space with the consensus refinement result (Fig. <xref rid="Fig6" ref-type="fig">6a</xref>).<fig id="Fig6"><label>Fig. 6</label><caption><title>Heterogeneity analysis of 224,354 particles of the NEXT complex.</title><p><bold>a</bold>, Starting consensus model and its gold-standard FSCs for all particles. The dashed horizontal line denotes FSC = 0.143. <bold>b</bold>, UMAP visualization of the latent space learned by OPUS-DSD and cryoDRGN. Solid black dots represent the cluster centers for labeled classes, identified using the Kmeans algorithm. <bold>c</bold>, Ten classes reconstructed by OPUS-DSD at points shown in <bold>b</bold> and the corresponding number of particles in each class. There were seven classes with complete densities on the right-hand side of the UMAP (classes 3–9), and three classes with incomplete densities on the left-hand side of the UMAP (classes 0–2). <bold>d</bold>, Ten classes reconstructed by cryoDRGN at points shown in <bold>b</bold> and the corresponding number of particles in each class. <bold>e</bold>, Translation–rotation plot for reconstructions from OPUS-DSD. The movement was measured for the MTR4 domain relative to the ZCCHC8 domain of each conformation by Dyndom using the consensus model as a reference. <bold>f</bold>, Density map and gold-standard FSCs for 116,712 particles by combining the OPUS-DSD clusters that had small structural variations (grouped by the red circle in <bold>e</bold>). <bold>g</bold>, Translation–rotation plot for reconstructions from cryoDRGN. <bold>h</bold>, Density map and gold-standard FSCs for 200,154 particles by combining the cryoDRGN clusters that had small structural variations (grouped by the blue circle in <bold>g</bold>). The dashed horizontal line in <bold>f</bold> and <bold>h</bold> denotes FSC = 0.143.</p><p><xref rid="MOESM9" ref-type="media">Source data</xref></p></caption><graphic xlink:href="41592_2023_2031_Fig6_HTML" id="d32e1264"/></fig></p>
      <p id="Par23">For OPUS-DSD, the UMAP for the latent space of all particles had a bipolar distribution (Fig. <xref rid="Fig6" ref-type="fig">6b</xref>). Classes 0, 1 and 2 on the left side of the UMAP correspond to reconstructions in which NEXT complex densities were not complete, while classes 3–9 on the right side of the UMAP correspond to reconstructions in which NEXT complex densities were complete (Fig. <xref rid="Fig6" ref-type="fig">6c</xref>). In the translation–rotation plot, five reconstructions from OPUS-DSD were within 2° of rotation and 1 Å of translation, forming a cluster of 116,712 particles, while another two classes had a much larger extent of motion at rotations of 3° and 6° (classes 9 and 5, respectively) (Fig. <xref rid="Fig6" ref-type="fig">6e</xref>). Non-uniform refinement<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> using the 116,712 particles improved the resolution of the reconstruction from 5.59 Å to 4.45 Å (Fig. <xref rid="Fig6" ref-type="fig">6f</xref> and Extended Data Fig. <xref rid="Fig14" ref-type="fig">8a</xref>). In comparison, using cryoDRGN on the same dataset (Fig. <xref rid="Fig6" ref-type="fig">6b</xref>) resulted in reconstructions that all had complete NEXT complex densities (Fig. <xref rid="Fig6" ref-type="fig">6d</xref>). In the translation–rotation plot, one reconstruction had a large rotation and translation (class 9, ~4° and ~3 Å, respectively) while the remaining nine reconstructions (classes 0–8) were clustered within 2° of rotation and 1 Å of translation (Fig. <xref rid="Fig6" ref-type="fig">6g</xref>). The 200,154 particles from these nine classes (blue circle) yielded a reconstruction with a resolution of 6.12 Å in non-uniform refinement (Fig. <xref rid="Fig6" ref-type="fig">6h</xref> and Extended Data Fig. <xref rid="Fig14" ref-type="fig">8b</xref>).</p>
      <p id="Par24">We also performed focused refinement on the ZCCHC8 dimeric center, leaving the pose parameter of MTR4 helicase undetermined (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9a</xref>). The UMAP for the latent space from OPUS-DSD was bipolar (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9b</xref>), in which classes 0–4 on the left side of UMAP correspond to complete complexes, whereas classes 5–9 on the right side of UMAP represent incomplete complexes (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9c</xref>). By contrast, the UMAP from cryoDRGN was circular (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9b</xref>), and nine out of 10 reconstructions showed complete densities with even particle distributions (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9d</xref>). The translation–rotation plots from both methods (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9e,g</xref>) showed a larger range of motion than previous analysis in Fig. <xref rid="Fig6" ref-type="fig">6</xref>. Classes with a small range of motion were then combined for further refinement. For OPUS-DSD, three classes with a rotation of approximately 5° (classes 2–4; 85,570 particles) were selected (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9e</xref>), which yielded a resolution of 4.52 Å (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9f,i</xref>). For cryoDRGN, four classes with rotations within 5° (classes 0, 4, 5 and 7; 96,466 particles) were selected for refinement (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9g</xref>), which resulted in a reconstruction with a resolution of 5.60 Å (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9h,j</xref>), on par with the consensus refinement (resolution of 5.59 Å) using the entire set of 224,354 particles (Fig. <xref rid="Fig6" ref-type="fig">6a</xref>).</p>
      <p id="Par25">It is worth noting that in the case of the NEXT complex with focused refinement, both cryoDRGN and OPUS-DSD showed the large-scale movements of MTR4 relative to ZCCHC8. The fact that cryoDRGN achieved a higher resolution in focused refinement suggests that its ability to resolve structural heterogeneity may be influenced by the degree of heterogeneity in a dataset.</p>
      <p id="Par26">We next tested a smaller dataset of 84,530 particles of the NEXT complex, which was obtained by applying several rounds of heterogenous refinements in cryoSPARC, with the best resolution of 4.39 Å (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10a</xref>). This scenario represents the stage after conventional classification is converged.</p>
      <p id="Par27">In UMAP visualization, classes 0, 1 and 3 from OPUS-DSD were separated from classes 2 and 4 (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10b</xref>). Classes 0, 1 and 3 all had complete density of the NEXT complex, while classes 2 and 4 were incomplete (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10c</xref>). The particles in classes 0, 1 and 3 (63,368 particles in total) yielded a resolution of 4.48 Å (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10e</xref>). Although the resolution does not improve, the average <italic>B</italic> factor decreased from 121 Å<sup>2</sup> to 109 Å<sup>2</sup>, suggesting a somewhat overall improvement in map quality (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10e</xref>). In contrast, the classes from cryoDRGN exhibited a more uniform distribution in UMAP (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10b</xref>) and similar reconstructions (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10d</xref>). Non-uniform refinement on classes 1–4 (68,879 particles) from cryoDRGN resulted in a resolution of 5.58 Å and <italic>B</italic> factor of 291 Å<sup>2</sup> (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10f</xref>). As a baseline comparison, reconstructions using four sets of particles in which ~25% of particles were randomly discarded yielded resolutions of 5.60–6.35 Å (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10g</xref>).</p>
      <p id="Par28">The test on the 84,530 particles of the NEXT complex shows that OPUS-DSD can still detect real heterogeneity in the dataset at the stage where conventional classification has been converged.</p>
    </sec>
  </sec>
  <sec id="Sec9" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par29">Built upon the PyTorch version of cryo-EM data processing utilities provided by cryoDRGN 1.0, OPUS-DSD introduces a set of methodological improvements aiming to effectively and reliably capture structural heterogeneities.</p>
    <p id="Par30">One critical component of OPUS-DSD is the 3D convolutional neural network with translational equivariance. Consensus 3D refinement can determine only the well-ordered portions of a macromolecule to high resolution, while averaging out the densities of flexible parts across space as exemplified by the pre-catalytic spliceosome (Extended Data Fig. <xref rid="Fig8" ref-type="fig">2</xref>). Hence, the pose parameters of well-ordered structural elements in each image are better determined than those of flexible structural elements. If the unresolved mobile elements undergo rigid-body movements, the problem of resolving structural heterogeneity can be simplified as multi-body refinement<sup><xref ref-type="bibr" rid="CR7">7</xref></sup> in which the pose parameters of dynamic elements are determined in relation to the well-ordered structures. By contrast, neural networks can resolve structural heterogeneity end-to-end by reconstructing the underlying conformations directly from an image without prior knowledge. To accomplish this, the neural network needs to be equivariant to variations of objects in input. Specifically, for a neural network that is equivariant to translation, any amount of shift of an object in input results in the same degree of shift of the same object in output. Convolutional neural networks are well-known for translational equivariance<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>, which contributes critically to the effectiveness of OPUS-DSD in modeling structural heterogeneity using consensus refinement results. In contrast, cryoDRGN leverages a different mechanism by operating in reciprocal space, that is, using the Fourier shift theorem, in which shifting a function by Δ in real space results in a multiplication of the Fourier transform of that function by <inline-formula id="IEq7"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${e}^{-i2\pi \Delta s}$$\end{document}</tex-math><mml:math id="M14"><mml:msup><mml:mrow><mml:mi>e</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mi>i</mml:mi><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:mi mathvariant="normal">Δ</mml:mi><mml:mi>s</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq7.gif"/></alternatives></inline-formula> in reciprocal space. Consequently, a local change in real space causes a global change to every voxel in reciprocal space. Therefore, cryoDRGN needs to approximate the change in every voxel in reciprocal space to high precision to reliably capture the structural heterogeneity.</p>
    <p id="Par31">By contrast, cryo-EM images contain high levels of noise. Even for the well-resolved structures in a complex determined by consensus refinement, their projection poses estimated by consensus refinement could still contain significant errors. These errors could compromise the quality of the 3D density map reconstructed by the neural network. To overcome this, OPUS-DSD leverages real-space 3D volume as an intermediate representation<sup><xref ref-type="bibr" rid="CR16">16</xref>,<xref ref-type="bibr" rid="CR17">17</xref></sup>. This representation enables fast sampling of different projections near the given direction without revaluating the decoder. This set-up enables OPUS-DSD to incorporate a reconstruction loss in which an experimental image is compared with an ensemble of projections at its estimated pose determined from consensus refinement and neighboring poses. Conceptually similar to the local angle search in RELION<sup><xref ref-type="bibr" rid="CR30">30</xref></sup>, the inclusion of this loss increases the robustness of OPUS-DSD to errors in pose parameters. In addition, the quality of the 3D volume representation is improved by encouraging its smoothness and sparseness via traditional regularizers such as total variation and LASSO<sup><xref ref-type="bibr" rid="CR19">19</xref>,<xref ref-type="bibr" rid="CR31">31</xref>,<xref ref-type="bibr" rid="CR32">32</xref></sup>, which are integrated into the training objective function of OPUS-DSD.</p>
    <p id="Par32">Despite these methodological improvements, training a neural network to reconstruct 3D dynamic objects using only 2D images remains challenging. The most formidable challenge comes from the inherent ill-posedness of the 2D to 3D translation, in which the encoder must disentangle the 3D structural information from other non-structural factors in 2D cryo-EM images. To this end, OPUS-DSD uses a multifaceted approach. The ill-posedness is first mitigated by reducing the pose variations in the input distribution through a back-projection step, in which the input is aligned with the same reference frame as the consensus model, which assists the encoder to disentangle structural heterogeneity from pose variations in 2D images. The ill-posedness is further alleviated by encouraging the smoothness of the latent space with respect to structural variations so that similar 3D structures are encoded by similar latent codes. By encouraging the smoothness of the latent space, the number of training samples available for the decoder at any meaningful latent code increases, ultimately improving the quality of the 3D density map reconstructed by the decoder. In OPUS-DSD, the smoothness of the latent space is encouraged by β-VAE as in cryoDRGN<sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR13">13</xref></sup>, and additionally by a multi-component latent prior that facilitates the clustering of images with similar structures in latent space. Furthermore, data augmentation is implemented in OPUS-DSD to reduce its sensitivity to contrast variations in 2D images.</p>
    <p id="Par33">We expect OPUS-DSD to facilitate structural determination and analysis of macromolecular complexes with unresolved structural elements due to high mobility, regardless of whether the mobile elements undergo rigid-body movements or not. Moreover, the end-to-end neural network-based approaches such as cryoDRGN and OPUS-DSD require no prior knowledge about the division of subcomplexes and can automatically reconstruct them and the corresponding dynamics. This enables the reconstruction of synchronous movement among different subcomplexes. One trade-off of this approach is that the resolution of reconstructed subcomplexes is not as high as in multi-body refinement. Additionally, due to the 3D volume representation in real space, OPUS-DSD has a somewhat higher computational cost than cryoDRGN, which only needs to output a 2D slice in the Fourier domain during training. By contrast, OPUS-DSD is able to output a 3D volume much faster in one pass during inference time, while cryoDRGN needs to evaluate the 3D volume voxel by voxel.</p>
  </sec>
  <sec id="Sec10">
    <title>Methods</title>
    <sec id="Sec11">
      <title>Notation</title>
      <p id="Par34">The notation used in this paper is as follows. <italic>V</italic> represents the 3D structure. <italic>X</italic> represents the 2D projection of the 3D structure. For a vector <inline-formula id="IEq8"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{x}}\in {{\mathbb{R}}}^{N}$$\end{document}</tex-math><mml:math id="M16"><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq8.gif"/></alternatives></inline-formula>, <inline-formula id="IEq9"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{||}{\boldsymbol{x}}{||}}^{2}={\sum }_{i}{{\boldsymbol{x}}}_{i}^{2}$$\end{document}</tex-math><mml:math id="M18"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="italic">||</mml:mi><mml:mi mathvariant="bold-italic">x</mml:mi><mml:mi mathvariant="italic">||</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq9.gif"/></alternatives></inline-formula> is the sum of squares of the vector <bold><italic>x</italic></bold>. <inline-formula id="IEq10"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{||}{\boldsymbol{x}}{||}}_{2}=\sqrt{{\sum }_{i}{{\boldsymbol{x}}}_{i}^{2}}$$\end{document}</tex-math><mml:math id="M20"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="italic">||</mml:mi><mml:mi mathvariant="bold-italic">x</mml:mi><mml:mi mathvariant="italic">||</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msqrt><mml:mrow><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mrow></mml:msqrt></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq10.gif"/></alternatives></inline-formula> represents the <italic>l</italic><sub>2</sub> norm of the vector <bold><italic>x</italic></bold>. <inline-formula id="IEq11"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{||}{\boldsymbol{x}}{||}}_{1}={\sum }_{i}|{{\boldsymbol{x}}}_{i}|$$\end{document}</tex-math><mml:math id="M22"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="italic">||</mml:mi><mml:mi mathvariant="bold-italic">x</mml:mi><mml:mi mathvariant="italic">||</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mi>|</mml:mi><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mi>|</mml:mi></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq11.gif"/></alternatives></inline-formula> represents the <italic>l</italic><sub>1</sub> norm of the vector <bold><italic>x</italic></bold>. ∙<sup><italic>T</italic></sup> represents the transpose of a matrix. Var represents the variance of a random variable. SO(3) represents the 3D rotation group.</p>
    </sec>
    <sec id="Sec12">
      <title>Image formation model</title>
      <p id="Par35">The image formation model of cryo-EM is typically defined in the frequency domain. Given that the images collected in cryo-EM are 2D projections of a 3D molecular structure, their Fourier transform has the following relationship with the Fourier transform of the 3D molecular structure according to the projection-slice theorem. Let the 3D molecular structure be <italic>V</italic>, and its Fourier transform be <inline-formula id="IEq12"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathcal{V}}$$\end{document}</tex-math><mml:math id="M24"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">V</mml:mi></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq12.gif"/></alternatives></inline-formula>. Assume an <italic>N</italic><sup>2</sup> image <italic>X</italic> is formed by rotating an <italic>N</italic><sup>3</sup> 3D volume <italic>V</italic> with the Euler angle set, <italic>ϕ</italic>, and projecting along the <italic>z</italic> axis; using the projection-slice theorem, the Fourier transform of the image <inline-formula id="IEq13"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathcal{X}}$$\end{document}</tex-math><mml:math id="M26"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">X</mml:mi></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq13.gif"/></alternatives></inline-formula> can be expressed as<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathcal{X}}}_{(h,k)}={{\rm{CTF}}}_{h,k}\mathop{\sum }\limits_{h{\prime} =1}^{N}\mathop{\sum }\limits_{k{\prime} =1}^{N}\mathop{\sum }\limits_{l{\prime} =1}^{N}{P}_{h{\prime} k{\prime} l{\prime} }^{h,k}(\phi ){{\mathcal{V}}}_{h{\prime} k{\prime} l{\prime} }+{\in }_{h,k},$$\end{document}</tex-math><mml:math id="M28"><mml:mrow><mml:msub><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">CTF</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>′</mml:mo><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>′</mml:mo><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>′</mml:mo><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:msubsup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>′</mml:mo><mml:mi>k</mml:mi><mml:mo>′</mml:mo><mml:mi>l</mml:mi><mml:mo>′</mml:mo></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msubsup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="script">V</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>′</mml:mo><mml:mi>k</mml:mi><mml:mo>′</mml:mo><mml:mi>l</mml:mi><mml:mo>′</mml:mo></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mo>∈</mml:mo></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq14"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathcal{X}}}_{h,k}$$\end{document}</tex-math><mml:math id="M30"><mml:msub><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq14.gif"/></alternatives></inline-formula> is a component of the Fourier transform of the image <italic>X</italic> with the spatial frequency vector [<italic>h</italic>,<italic>k</italic>], CTF<sub><italic>h,k</italic></sub> is a component of the CTF (ref. <sup><xref ref-type="bibr" rid="CR36">36</xref></sup>), <inline-formula id="IEq15"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${P}_{h{\prime} k{\prime} l{\prime} }^{h,k}(\phi )$$\end{document}</tex-math><mml:math id="M32"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>′</mml:mo><mml:mi>k</mml:mi><mml:mo>′</mml:mo><mml:mi>l</mml:mi><mml:mo>′</mml:mo></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msubsup><mml:mo>(</mml:mo><mml:mi>ϕ</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq15.gif"/></alternatives></inline-formula> is the slice operator that slices a plane in the 3D Fourier transform <inline-formula id="IEq16"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathcal{V}}$$\end{document}</tex-math><mml:math id="M34"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">V</mml:mi></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq16.gif"/></alternatives></inline-formula> according to the Euler angle set <italic>ϕ</italic>, and <italic>ϵ</italic><sub><italic>h,k</italic></sub> is the noise that corrupts the projection. The 2D image <italic>X</italic> can further undergo a set of 2D rigid transformations such as rotation and translation in the projection plane, which, however, are omitted in our discussions because they can be easily corrected using known pose parameters.</p>
      <p id="Par36">We elaborate on the slice operator <italic>P</italic><sup><italic>ϕ</italic></sup> by giving its formal definition. Let the index of a voxel in the 3D Fourier transform <inline-formula id="IEq17"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathcal{V}}$$\end{document}</tex-math><mml:math id="M36"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">V</mml:mi></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq17.gif"/></alternatives></inline-formula> be [<italic>h</italic>′,<italic>k</italic>′,<italic>l</italic>′], and the index of the corresponding pixel of the Fourier transform of the image is [<italic>h</italic>,<italic>k</italic>]; the slice operator <italic>P</italic><sup><italic>ϕ</italic></sup> transforms the 3D index to a 2D index by the following equation:<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left({\begin{array}{c}h\\k\\ 0\end{array}}\right)={R}_{\phi }^{T}\left({\begin{array}{c}{{h}^{{\prime} }}\\{k}^{{\prime} }\\ {l}^{{\prime} }\end{array}}\right),$$\end{document}</tex-math><mml:math id="M38"><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:mi>h</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>k</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mn>0</mml:mn></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msubsup><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi>h</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula>where <italic>R</italic><sub><italic>ϕ</italic></sub> is a rotation matrix parameterized by the Euler angle set <italic>ϕ</italic>. The counterpart of the slice operator in real space is the projection operator. Let <italic>V</italic> be the template volume, and <italic>V</italic>′ be the volume rotated by the Euler angle set <italic>ϕ</italic>; the projection operator rotates the 3D template volume by the following equation:<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$V{\prime} \left(\left({\begin{array}{c}{x}\\y\\ z\end{array}}\right)\right)=V\left({R}_{\phi }^{T}\left({\begin{array}{c}{x}\\y\\ z\end{array}}\right)\right).$$\end{document}</tex-math><mml:math id="M40"><mml:mrow><mml:mi>V</mml:mi><mml:mo>′</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:mi>x</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>y</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>z</mml:mi></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mi>V</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msubsup><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:mi>x</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>y</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>z</mml:mi></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:mrow></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par37">The projection operator then generates the 2D projection <italic>X</italic> by summing along the <italic>z</italic> axis of the rotated volume <italic>V</italic>′:<disp-formula id="Equ4"><label>4</label><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$X\left(\left(\begin{array}{c}{x}\\{y}\end{array}\right)\right)=\mathop{\sum }\limits_{z=1}^{N}{V}^{{\prime} }\left(\left({\begin{array}{c}{x}\\y\\ z\end{array}}\right)\right).$$\end{document}</tex-math><mml:math id="M42"><mml:mrow><mml:mi>X</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:mi>x</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>y</mml:mi></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>z</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:msup><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mfenced close=")" open="("><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:mi>x</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>y</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>z</mml:mi></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:mrow></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ4.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par38">In summary, the real-space 3D volume in OPUS-DSD undergoes a rotation in 3D and 2D rigid transformations before transforming to a 2D projection. The 2D cryo-EM reconstruction is obtained by first rotating the 3D volume by the spatial transformer<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>, which is then projected along the <italic>z</italic> axis to generate a 2D projection that further undergoes defocus correction to generate the 2D cryo-EM reconstruction by applying a CTF as in equation (<xref rid="Equ1" ref-type="disp-formula">1</xref>). The 2D cryo-EM image <italic>X</italic> is thus a function of the 3D volume <italic>V</italic>, the projection angle <italic>P</italic> and the defocus parameters of microscope <italic>u</italic>, all of which defines the CTF, that is, <italic>X</italic>(<italic>V</italic>, <italic>P</italic>,<italic>u</italic>). Therefore, the entire image formation process is differentiable and suitable for end-to-end training.</p>
    </sec>
    <sec id="Sec13">
      <title>cryoDRGN</title>
      <p id="Par39">CryoDRGN proposed a neural representation to model the 2D projection in 3D Fourier volume. The projection can be described as a continuous function <inline-formula id="IEq18"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$V:{{\mathbb{R}}}^{3}{\mathbb{\to }}{\mathbb{R}}$$\end{document}</tex-math><mml:math id="M44"><mml:mrow><mml:mi>V</mml:mi><mml:mo>:</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:msup><mml:mo>→</mml:mo><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq18.gif"/></alternatives></inline-formula>, which maps the 3D coordinate to a voxel value. CryoDRGN approximates the function <italic>V</italic> directly by using a multilayer perceptron (MLP)<sup><xref ref-type="bibr" rid="CR37">37</xref></sup>. Instead of supplying the 3D coordinates into the MLP, cryoDRGN encodes the coordinates using a specific positional encoding<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>. The 2D projection at a specific angle is computed from positional encodings of the coordinates in its corresponding slice (equation (<xref rid="Equ2" ref-type="disp-formula">2</xref>)), pixel by pixel. Different structures are generated by concatenating their latent codes to the positional encodings and supplying those combinations to the MLP. CryoDRGN is trained using β-VAE<sup><xref ref-type="bibr" rid="CR13">13</xref></sup>.</p>
    </sec>
    <sec id="Sec14">
      <title>Structural disentanglement prior</title>
      <p id="Par40">In the framework of the encode–decoder network, resolving the structural heterogeneity in a cryo-EM dataset can be formulated as learning a latent space that captures the 3D structural information. Each latent code represents a unique 3D structure in this space, <bold><italic>z</italic></bold> ~ <italic>V</italic>. Given a latent code, the decoder network can produce the corresponding 3D volume <italic>g</italic>(<italic>V</italic>|<bold><italic>z</italic></bold>). The similarity between 3D structures correlates with the distance between their latent codes. From the perspective of the decoder, encoding structural information in the latent space can be encouraged by explicitly supplementing the non-structural information such as poses and defocus parameters into the reconstruction of the 2D projection from the 3D volume. If reliably modeled, the non-structural information in 2D images will not propagate from the decoder into the latent space during backpropagation. However, when the pose assignments of the 2D images are erroneous, the 3D reconstruction from the decoder will be distorted to account for the pose assignment errors. Therefore, this approach is greatly affected by the accuracy of pose assignment, which depends heavily on the signal-to-noise ratios of a dataset. The power of a neural network for resolving structural heterogeneity will quickly deteriorate as the signal-to-noise ratios of a dataset drop. The disentanglement of structural content from pose parameters in cryoDRGN 1.0 was achieved via this approach<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>. The most recent version of cryoDRGN2 introduced a pose update to mitigate this issue<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>.</p>
      <p id="Par41">From the perspective of the encoder, learning a structural latent space can be achieved by learning a projection and defocus invariant encoding for all 2D cryo-EM images from the same 3D structure, namely, <inline-formula id="IEq19"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f\left(X(V,{P},u)\right)=f\left(X\left(V,{P}^{{\prime} },{u}^{{\prime} }\right)\right),\forall P,{P}^{{\prime} }\in {{\mathrm{SO}}}\left(3\right),\forall u,{u}^{{\prime} }\in {{\mathbb{R}}}^{n}$$\end{document}</tex-math><mml:math id="M46"><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>X</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:mi>P</mml:mi><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>X</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:mo>∀</mml:mo><mml:mi>P</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">SO</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:mo>∀</mml:mo><mml:mi>u</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq19.gif"/></alternatives></inline-formula>. The 2D cryo-EM image is a function, <italic>X</italic>(<italic>V</italic>, <italic>P</italic>, <italic>u</italic>). It can vary considerably by changing the projection angle and defocus parameters while fixing the underlying 3D structure, namely, <inline-formula id="IEq20"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$X(V,P,u)\ne X(V,{P}^{{\prime} },{u}^{{\prime} })$$\end{document}</tex-math><mml:math id="M48"><mml:mrow><mml:mi>X</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:mi>P</mml:mi><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>≠</mml:mo><mml:mi>X</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq20.gif"/></alternatives></inline-formula> as long as <inline-formula id="IEq21"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P\ne {{P}^{{\prime} }}$$\end{document}</tex-math><mml:math id="M50"><mml:mrow><mml:mi>P</mml:mi><mml:mo>≠</mml:mo><mml:msup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq21.gif"/></alternatives></inline-formula> or <inline-formula id="IEq22"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$u\ne {{u}^{{\prime} }}$$\end{document}</tex-math><mml:math id="M52"><mml:mrow><mml:mi>u</mml:mi><mml:mo>≠</mml:mo><mml:msup><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq22.gif"/></alternatives></inline-formula>. In order to approximate such a latent space that primarily encodes 3D structural information, the encoder network should disentangle the 3D structural variations in 2D inputs from other factors such as projection angles and defocus parameters.</p>
      <p id="Par42">An important component of OPUS-DSD is a latent space prior disentangling the 3D structural heterogeneity from the non-structural information and encoding the 3D structural heterogeneity. The encoder network in OPUS-DSD is encouraged to generate latent encodings with larger variations for 3D structural changes in 2D inputs, while being relatively insensitive to the poses and contrast changes, namely, <inline-formula id="IEq23"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\rm{Var}}(\partial f\left(X(V,{P},u)\right)/\partial V)\gg {\rm{Var}}(\partial f\left(X(V,{P},u)\right)/\partial \Delta ),\Delta ={P}\,{\rm{or}}\,{u}$$\end{document}</tex-math><mml:math id="M54"><mml:mrow><mml:mi mathvariant="normal">Var</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>∂</mml:mi><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>X</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:mi>P</mml:mi><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfenced><mml:mo>/</mml:mo><mml:mi>∂</mml:mi><mml:mi>V</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>≫</mml:mo><mml:mi mathvariant="normal">Var</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>∂</mml:mi><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>X</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:mi>P</mml:mi><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfenced><mml:mo>/</mml:mo><mml:mi>∂</mml:mi><mml:mi mathvariant="normal">Δ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mi mathvariant="normal">Δ</mml:mi><mml:mo>=</mml:mo><mml:mi>P</mml:mi><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">or</mml:mi><mml:mspace width="0.25em"/><mml:mi>u</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq23.gif"/></alternatives></inline-formula>, where variances are taken over all images. Specifically, the disentanglement is achieved by adding attracting forces and repelling forces between the encodings of a specific combination of images. The attracting forces restrain the distance between the latent codes of images from similar 3D structures, while the repelling forces encourage the separation between the latent codes of different 3D structures.</p>
      <p id="Par43">The latent space prior is composed of two components, namely the intraclass prior for 2D images of similar projection angles and the interclass prior for 2D images of different projection angles. First let us consider the intraclass prior. The 3D structural heterogeneity is most discernible in 2D cryo-EM images that have the same projection angle, namely, the variation of <italic>X</italic>(<italic>V</italic>,<italic>P</italic>,<italic>u</italic>) can be mainly attributed to <italic>V</italic> when conditioned on <italic>P</italic>. The repelling force is added between the latent codes of those pairs of images to amplify the difference between latent codes for images from different 3D structures, which encourages the encoder to discern images from different structures. Next, to encourage the smoothness of latent codes, the distances of the latent codes of similar images are restrained to prevent over-separation. To formally define the prior, given the projection angles form an SO(3) group that can be discretized into a number of classes using HEALPix<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>, 2D images can be classified into different projection classes according to their projection angles. Suppose the encoder network is <italic>f</italic>, the projection class of image <italic>X</italic><sub>i</sub> is <italic>P</italic><sub><italic>i</italic></sub>, the projection class of image <italic>X</italic><sub><italic>j</italic></sub> is <italic>P</italic><sub><italic>j</italic></sub>, inspired by the objective function of UAMP<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>, the prior for the encoder network that encourages the encoding of structural information for images in the same projection class <italic>P</italic><sub><italic>i</italic></sub> can be expressed as<disp-formula id="Equ5"><label>5</label><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{array}{l}{J}_{1}\left(\,f\right)=\mathop{\sum }\limits_{{X}_{i}}\frac{1}{K}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kNN}}\left(\,f\left({X}_{i}\right)\right),{P}_{j}={P}_{i}}^{K} \\ \log \left(1+{{||}\,f(X_{i}({V}_{i},{P}_{i},{u}_{i}))-f({X}_{j}({V}_{j},{P}_{j},{u}_{j})){||}}^{2}\right) \\ +\mathop{\sum }\limits_{{X}_{i}}\frac{1}{N}\mathop{\sum }\limits_{{X}_{j}\ne {X}_{i},{P}_{j}={P}_{i}}^{N}\log \left(1+\frac{1}{{{||}\,f(X_{i}({V}_{i},{P}_{i},{u}_{i}))-f({X}_{j}({V}_{j},{P}_{j},{u}_{j})){||}}^{2}}\right),\end{array}$$\end{document}</tex-math><mml:math id="M56"><mml:mtable><mml:mtr><mml:mtd columnalign="left"><mml:msub><mml:mrow><mml:mi>J</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kNN</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ5.gif" position="anchor"/></alternatives></disp-formula>where kNN refers to the <italic>k</italic> nearest neighbors of the image measured by Euclidean distance in latent space, <italic>K</italic> refers to the number of nearest neighbors, and the second summation in the second term is over all images in the same class as image <italic>X</italic><sub><italic>i</italic></sub> except itself, and <italic>N</italic> refers to the size of the projection class of image <italic>X</italic><sub><italic>i</italic></sub>. For images with similar codes, the attracting prior reaches a minimum when <inline-formula id="IEq24"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f\left({X}_{i}\right)=f({X}_{j})$$\end{document}</tex-math><mml:math id="M58"><mml:mrow><mml:mi>f</mml:mi><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mo>=</mml:mo><mml:mi>f</mml:mi><mml:mo>(</mml:mo><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq24.gif"/></alternatives></inline-formula>. By contrast, the minimum of the repelling prior is obtained at <inline-formula id="IEq25"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${||f}\left({X}_{i}\right)-f\left({X}_{j}\right){||}\to \infty$$\end{document}</tex-math><mml:math id="M60"><mml:mrow><mml:mi mathvariant="italic">||f</mml:mi><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mi mathvariant="italic">||</mml:mi><mml:mo>→</mml:mo><mml:mi>∞</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq25.gif"/></alternatives></inline-formula>, thus the encoder is forced to amplify the structural differences between <italic>X</italic><sub><italic>i</italic></sub> and <italic>X</italic><sub><italic>j</italic></sub>.</p>
      <p id="Par44">Next let us consider the interclass prior aiming to improve the clustering of images according to structural information while reducing the impact of projection poses. This is achieved by collating the latent codes of different projections of the same 3D structure. The projections with similar latent codes are considered to be from the same structure. The attracting force can be added among them. To encourage the separation of different 3D structures, a repelling prior is added to an image and its <italic>k</italic> farthest point in latent space. Formally, let the kNN of the image <italic>X</italic><sub><italic>i</italic></sub> in latent space be <inline-formula id="IEq26"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\rm{kNN}}\left(f\left({X}_{i}\right)\right)$$\end{document}</tex-math><mml:math id="M62"><mml:mrow><mml:mi mathvariant="normal">kNN</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq26.gif"/></alternatives></inline-formula>, the projection class of image <italic>X</italic><sub><italic>i</italic></sub> be <italic>P</italic><sub><italic>i</italic></sub>, the <italic>k</italic> farthest point of the image <italic>X</italic><sub><italic>i</italic></sub> in latent space be <inline-formula id="IEq27"><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\rm{kFP}}\left(f\left({X}_{i}\right)\right)$$\end{document}</tex-math><mml:math id="M64"><mml:mrow><mml:mi mathvariant="normal">kFP</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq27.gif"/></alternatives></inline-formula>, then our prior for encouraging the clustering of images with similar latent codes and different poses can be expressed as<disp-formula id="Equ6"><label>6</label><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{array}{l}{J}_{2}\left(\,f\,\right)=\mathop{\sum }\limits_{{X}_{i}}\frac{1}{K}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kNN}}\left(\,f\left({X}_{i}\right)\right),{P}_{j}\ne {P}_{i}}^{K} \\ \log \left(1+{{||}\,f(X_{i}({V}_{i},{P}_{i},{u}_{i}))-f({X}_{j}({V}_{j},{P}_{j},{u}_{j})){||}}^{2}\right) \\ +\mathop{\sum }\limits_{{X}_{i}}\frac{1}{N}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kFP}}\left(\,f\left({X}_{i}\right)\right),{P}_{j}\ne {P}_{i}}^{N}\log \left(1+\frac{1}{{{||}\,f(X_{i}({V}_{i},{P}_{i},{u}_{i}))-f({X}_{j}({V}_{j},{P}_{j},{u}_{j})){||}}^{2}}\right),\end{array}$$\end{document}</tex-math><mml:math id="M66"><mml:mtable><mml:mtr><mml:mtd columnalign="left"><mml:msub><mml:mrow><mml:mi>J</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mspace width="0.25em"/></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kNN</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kFP</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ6.gif" position="anchor"/></alternatives></disp-formula>where the second summation in both terms is over all images that do not belong to the same projection class as <italic>X</italic><sub><italic>i</italic></sub>, <italic>K</italic> refers to the number of nearest neighbors of <italic>X</italic><sub><italic>i</italic></sub> and <italic>N</italic> refers to the number of farthest points of <italic>X</italic><sub><italic>i</italic></sub>, which are both tunable hyperparameters. The complete structural disentanglement prior is the sum of equation (<xref rid="Equ5" ref-type="disp-formula">5</xref>) and equation (<xref rid="Equ6" ref-type="disp-formula">6</xref>), which can be written as<disp-formula id="Equ7"><label>7</label><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{array}{rcl}J\left(\,f\,\right)&amp;=&amp;\mathop{\sum }\limits_{{X}_{i}}\frac{1}{{K}_{1}}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kNN}}\left(\,f\left({X}_{i}\right)\right),{P}_{j}={P}_{i}}^{K} \\ &amp;&amp; \log \left(1+{{||}\,f(X_{i})-f({X}_{j}){||}}^{2}\right) \\&amp;&amp; +\,\frac{1}{{N}_{1}}\mathop{\sum }\limits_{{X}_{j}\ne {X}_{i},{P}_{j}={P}_{i}}\log \left(1+\frac{1}{{{||}\,f(X_{i})-f({X}_{j}){||}}^{2}}\right) \\ &amp;&amp; +\,\frac{1}{{K}_{2}}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kNN}}\left(f\left({X}_{i}\right)\right),{P}_{j}\ne {P}_{i}}\log \left(1+{{||}\,f(X_{i})-f({X}_{j}){||}}^{2}\right) \\ &amp;&amp; +\,\frac{1}{{N}_{2}}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kFP}}\left(f\left({X}_{i}\right)\right),{P}_{j}\ne {P}_{i}}^{N}\log \left(1+\frac{1}{{{||}\,f(X_{i})-f({X}_{j}){||}}^{2}}\right),\end{array}$$\end{document}</tex-math><mml:math id="M68"><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mi>J</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mspace width="0.25em"/></mml:mrow></mml:mfenced></mml:mtd><mml:mtd columnalign="center"><mml:mo>=</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>K</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kNN</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"/><mml:mtd columnalign="center"/><mml:mtd columnalign="left"><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"/><mml:mtd columnalign="center"/><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:mspace width="0.25em"/><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"/><mml:mtd columnalign="center"/><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:mspace width="0.25em"/><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>K</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kNN</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"/><mml:mtd columnalign="center"/><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:mspace width="0.25em"/><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kFP</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ7.gif" position="anchor"/></alternatives></disp-formula>where the first two terms for images with <italic>P</italic><sub><italic>j</italic></sub> = <italic>P</italic><sub><italic>i</italic></sub> are the intraclass comparison, while the last two terms for images with <inline-formula id="IEq28"><alternatives><tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${P}_{j}\ne {P}_{i}$$\end{document}</tex-math><mml:math id="M70"><mml:mrow><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq28.gif"/></alternatives></inline-formula> are the interclass comparison.</p>
      <p id="Par45">To compute the structural disentanglement latent prior, equation (<xref rid="Equ5" ref-type="disp-formula">5</xref>) can be approximated using a batch of images from the same projection class (intraclass). For equation (<xref rid="Equ6" ref-type="disp-formula">6</xref>), given that a cryo-EM dataset contains hundreds of thousands of images, it is computationally inefficient to compute kNN and kFP for each image over all images. We compute them approximately for each query by using a subset of images from projection classes other than the query’s projection class to ensure interclass comparison. This subset is randomly sampled from a memory bank that stores all latent codes. The distances between the query latent code and samples are then computed and sorted in ascending order. The first <italic>K</italic><sub>2</sub> latent codes with the shortest distances are designated as the nearest neighbors of the query. The last <italic>N</italic><sub>2</sub> latent codes with the longest distances are denoted as the farthest points of the query.</p>
    </sec>
    <sec id="Sec15">
      <title>Data augmentation</title>
      <p id="Par46">The final ingredient to increase the robustness of OPUS-DSD to contrast changes is a data augmentation pipeline. The CTF blurs the cryo-EM 2D projection while strongly modulating its contrast<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>. The encoder might learn to recognize the pattern of the CTF instead of the signal of the underlying structure. To make the network more robust to the defocus variations, we propose to corrupt the pattern of the CTF by constructing input and output image pairs with randomized amplitudes of Fourier transforms. Specifically, the input and output are two images that have been independently constructed by multiplying the random Gaussian function with the Fourier transform of the original image. That is, let the Fourier transform of the constructed image be <inline-formula id="IEq29"><alternatives><tex-math id="M71">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathscr{X}}}_{h,k}^{{\prime} }$$\end{document}</tex-math><mml:math id="M72"><mml:msubsup><mml:mrow><mml:mi mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq29.gif"/></alternatives></inline-formula> and the Fourier transform of the original image be <inline-formula id="IEq30"><alternatives><tex-math id="M73">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathscr{X}}}_{h,k}$$\end{document}</tex-math><mml:math id="M74"><mml:msub><mml:mrow><mml:mi mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq30.gif"/></alternatives></inline-formula>, and the data augmentation process is defined as<disp-formula id="Equ8"><label>8</label><alternatives><tex-math id="M75">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathscr{X}}}_{h,k}^{{\prime} }={e}^{-b{\pi }^{2}{s}^{2}}{{\mathscr{X}}}_{h,k},$$\end{document}</tex-math><mml:math id="M76"><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi>e</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mi>b</mml:mi><mml:msup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mi>s</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ8.gif" position="anchor"/></alternatives></disp-formula>where <italic>b</italic> is a uniform random <italic>B</italic> factor in the range [−0.5, 0.5] and <inline-formula id="IEq31"><alternatives><tex-math id="M77">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$s=\sqrt{{h}^{2}+{k}^{2}}$$\end{document}</tex-math><mml:math id="M78"><mml:mrow><mml:mi>s</mml:mi><mml:mo>=</mml:mo><mml:msqrt><mml:mrow><mml:msup><mml:mrow><mml:mi>h</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:msqrt></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq31.gif"/></alternatives></inline-formula> is the modulus of the spatial frequency vector of the Fourier transform. The image contrast is sharpened when <italic>b</italic> &lt; 0, while the image contrast is blurred when <italic>b</italic> &gt; 0. The <italic>B</italic> factors applied to input and output are two independently sampled values. We further multiply the Gaussian blurred or sharpened input image with a uniform random constant in the range [0.75, 1.25] to change its overall contrast and brightness. The input image is then fed into the encoder, while the decoder is asked to reconstruct the output image. The neural network thus is forced to reconstruct an image using input with different contrast values. This data augmentation pipeline increases the robustness of the encoder network to the contrast variations of inputs, and reduces the impact of defocus parameters on latent codes.</p>
    </sec>
    <sec id="Sec16">
      <title>Training objectives</title>
      <p id="Par47">The smoothness of latent space is of paramount importance to the generalizability of the generative model. To generate plausible samples during a traversal through the latent space, the generative model needs to smoothly interpolate between training samples. One way to achieve this is by VAE<sup><xref ref-type="bibr" rid="CR14">14</xref></sup>. Instead of producing a deterministic latent code, the encoder approximates a posterior distribution of latent code conditioned on image <italic>X</italic>, <italic>f</italic>(<bold><italic>z</italic></bold>|<italic>X</italic>), which is often assumed to be a diagonal Gaussian distribution for simplicity. The encoder then parameterizes this diagonal Gaussian distribution by outputting its mean and variance. The smoothness of latent space is encouraged by increasing the overlapping between the approximate posterior distributions of images, namely, restraining the deviation of approximate posterior distributions from the standard Gaussian distribution. The default VAE assumes that the reconstruction loss and restraints are of equal weights, while β-VAE introduces a tunable parameter to control the strength of the standard Gaussian restraints<sup><xref ref-type="bibr" rid="CR13">13</xref></sup>. Furthermore, to generate a plausible 3D volume, total variation and LASSO priors are imposed on the reconstructed 3D volume to encourage its smoothness and sparseness<sup><xref ref-type="bibr" rid="CR31">31</xref>,<xref ref-type="bibr" rid="CR32">32</xref></sup>.</p>
      <p id="Par48">As mentioned in the Structural Disentanglement Prior subsection, the pose assignment errors from consensus refinement have an adverse effect on the quality of the 3D reconstruction output by the neural network. We have therefore designed a reconstruction loss that is robust to pose assignment errors by comparing an experimental image with multiple reconstructions obtained at its pose from consensus refinement and neighboring poses. The objective function leveraged by OPUS-DSD with the aforementioned considerations is as follows. Using β-VAE, let <italic>θ</italic> be the projection angle determined by a consensus 3D refinement for each image, <italic>f</italic> be the encoder network, <italic>g</italic> be the decoder network, <italic>F</italic> represent the image formation process given the 3D volume <italic>V</italic>, projection angle <italic>θ</italic>′ and defocus parameters <italic>u</italic>, let the dimension of the 3D volume be <italic>N</italic><sup>3</sup>, and the objective function for learning a neural network to resolve 3D structural heterogeneity can be expressed as<disp-formula id="Equ9"><label>9</label><alternatives><tex-math id="M79">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{array}{l}\mathop{\min }\limits_{f,g}{E}_{f\left({\boldsymbol{z}}|X\right)}-\log \mathop{\sum }\limits_{{\theta }^{{\prime} }\in {NN}(\theta )}\exp -\frac{1}{2}{{||X}-F\left(g\left(V({\boldsymbol{x}}){\rm{|}}{\boldsymbol{z}}\right),{\theta }^{{\prime} },u\right){||}}^{2} \\ +\,\beta {D}_{{{\mathrm{KL}}}}\left(\,f({\boldsymbol{z}}{\rm{|}}X\,){\rm{|}}|{\mathscr{N}}\left(0,I\,\right)\right)+\lambda J\left(\,f({\boldsymbol{z}}{|X}\,)\right) \\ +\, \frac{{\lambda }_{{{\mathrm{tv}}}}}{N}\mathop{\sum }\limits_{\boldsymbol{x}}{{\Big|\Big|}\frac{\partial g\left(V\left({\boldsymbol{x}}\right)|{\boldsymbol{z}}\right)}{\partial {\boldsymbol{x}}}{\Big|\Big|}}_{2}+\frac{{\lambda }_{{l}_{1}}}{N}\mathop{\sum }\limits_{\boldsymbol{x}}{{||g}\left(V\left({\boldsymbol{x}}\right)|{\boldsymbol{z}}\right){||}}_{1},\end{array}$$\end{document}</tex-math><mml:math id="M80"><mml:mtable><mml:mtr><mml:mtd columnalign="left"><mml:munder><mml:mrow><mml:mi>min</mml:mi></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mo>∣</mml:mo><mml:mi>X</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mi>log</mml:mi><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:mi>N</mml:mi><mml:mi>N</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:munder><mml:mi>exp</mml:mi><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:mfrac><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mi>X</mml:mi><mml:mo>−</mml:mo><mml:mi>F</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>g</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi mathvariant="normal">∣</mml:mi><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow></mml:mfenced><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:mspace width="0.25em"/><mml:mi>β</mml:mi><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">KL</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mi mathvariant="normal">∣</mml:mi><mml:mi>X</mml:mi><mml:mspace width="0.25em"/></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi mathvariant="normal">∣</mml:mi><mml:mo>∣</mml:mo><mml:mi mathvariant="script">N</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>I</mml:mi><mml:mspace width="0.25em"/></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>+</mml:mo><mml:mi>λ</mml:mi><mml:mi>J</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mo>∣</mml:mo><mml:mi>X</mml:mi><mml:mspace width="0.25em"/></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:mspace width="0.25em"/><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">tv</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:mfrac><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mstyle mathsize="1.61em"><mml:mfenced open="∣"><mml:mrow/></mml:mfenced></mml:mstyle><mml:mstyle mathsize="1.61em"><mml:mfenced open="∣"><mml:mrow/></mml:mfenced></mml:mstyle><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mi>g</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:mfenced><mml:mo>∣</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:mfrac><mml:mstyle mathsize="1.61em"><mml:mfenced open="∣"><mml:mrow/></mml:mfenced></mml:mstyle><mml:mstyle mathsize="1.61em"><mml:mfenced open="∣"><mml:mrow/></mml:mfenced></mml:mstyle></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:mfrac><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mi>g</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:mfenced><mml:mo>∣</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:mfenced><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ9.gif" position="anchor"/></alternatives></disp-formula>where <italic>NN</italic>(<italic>θ</italic>) represents the nearest neighbors of the projection angle <italic>θ</italic>, the first term is the expectation of errors between the ground-truth image <italic>X</italic> and the reconstruction <inline-formula id="IEq32"><alternatives><tex-math id="M81">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$F\left(g\left({V|}{\boldsymbol{z}}\right),\theta {\prime} ,u\right)$$\end{document}</tex-math><mml:math id="M82"><mml:mrow><mml:mi>F</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>g</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mo>∣</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>′</mml:mo><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq32.gif"/></alternatives></inline-formula> over the distribution of latent code <bold><italic>z</italic></bold>, <inline-formula id="IEq33"><alternatives><tex-math id="M83">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathscr{N}}\left(0,I\right)$$\end{document}</tex-math><mml:math id="M84"><mml:mrow><mml:mi mathvariant="script">N</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>I</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq33.gif"/></alternatives></inline-formula> is the standard Gaussian distribution, <italic>D</italic><sub>KL</sub> is the Kullback–Leibler (KL) divergence between the distribution given by the encoder network <italic>f</italic> and the standard Gaussian <inline-formula id="IEq34"><alternatives><tex-math id="M85">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathscr{N}}\left(0,I\right)$$\end{document}</tex-math><mml:math id="M86"><mml:mrow><mml:mi mathvariant="script">N</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>I</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq34.gif"/></alternatives></inline-formula>, the term <italic>J</italic>(<italic>f</italic>(<bold><italic>z</italic></bold>│<italic>X</italic>)) is the structural disentanglement prior to encourage the encoding of the 3D structural information in latent space, <inline-formula id="IEq35"><alternatives><tex-math id="M87">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\frac{\partial g\left(V\left({\boldsymbol{x}}\right)|{\boldsymbol{z}}\right)}{\partial {\boldsymbol{x}}}$$\end{document}</tex-math><mml:math id="M88"><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mi>g</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:mfenced><mml:mo>∣</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:mfrac></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq35.gif"/></alternatives></inline-formula> denotes the gradient of the 3D volume at grid point <bold><italic>x</italic></bold>, <italic>β</italic> is the restraint strength for <italic>D</italic><sub>KL</sub>, <italic>λ</italic> is the restraint strength for the structural disentanglement prior, <italic>λ</italic><sub>tv</sub> is the restraint strength for total variation, and <inline-formula id="IEq36"><alternatives><tex-math id="M89">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\lambda }_{{l}_{1}}$$\end{document}</tex-math><mml:math id="M90"><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq36.gif"/></alternatives></inline-formula> is the restraint strength for LASSO. Computing the expectation in equation (<xref rid="Equ9" ref-type="disp-formula">9</xref>) is intractable, and we use a reparameterization trick<sup><xref ref-type="bibr" rid="CR14">14</xref></sup> to approximate the expectation integral.</p>
    </sec>
    <sec id="Sec17">
      <title>Training</title>
      <p id="Par49">Our network was trained using 2D images. The projection pose parameters of 2D images were determined by the consensus 3D refinement in RELION or cryoSPARC<sup><xref ref-type="bibr" rid="CR6">6</xref>,<xref ref-type="bibr" rid="CR41">41</xref></sup>. The 2D images were randomly split into a training set and a validation set using a specified split ratio. The images in the validation set were used to evaluate the reconstruction quality of the neural network only. For the spliceosome and <italic>Pf</italic>80S ribosome with a large amount of data and good signal-to-noise ratios, we used 20% of the images for validation. For the <italic>Sc</italic>80S ribosome and NEXT complex data, 10% of the images were used for validation. The computation of the structural disentanglement prior requires us to perform intraclass and interclass comparisons. Hence, the training images were classified into 48 different projection classes according to their first two Euler angles using HEALPix<sup><xref ref-type="bibr" rid="CR40">40</xref></sup> before being sent to training. At each iteration a projection class was selected uniformly and a batch of images in the selected projection class was sampled by a customized batch sampler. The structural disentanglement prior can be easily computed using such a batching process. The image sample was passed to the encoder, which outputs a sample of the latent distribution <italic>f</italic>(<bold><italic>z</italic></bold>|<italic>X</italic>). The decoder reconstructs a 3D volume according to the latent code. The total variations and LASSO priors were imposed on the reconstructed 3D volume to encourage its smoothness and sparseness<sup><xref ref-type="bibr" rid="CR31">31</xref>,<xref ref-type="bibr" rid="CR32">32</xref></sup>. The 3D volume was rendered into a 2D reconstruction with predetermined pose according to the cryo-EM image formation model. The inputs and reconstructions together with the latent codes were used to construct the training loss as in equation (<xref rid="Equ9" ref-type="disp-formula">9</xref>), which was minimized using the Adam optimizer<sup><xref ref-type="bibr" rid="CR42">42</xref></sup>.</p>
    </sec>
    <sec id="Sec18">
      <title>Implementation</title>
      <p id="Par50">The neural network of OPUS-DSD was implemented in PyTorch with automatic differentiation support<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>. The major computation bottleneck is caused by the 3D convolution autoencoder given that every 2D image has to go through a series of 3D operations. The run time and memory cost of OPUS-DSD was hence almost irrelevant to the size of the 2D images. Using four Nvidia V100 GPUs (graphics processing units), the training of 1,000 images took around 1 min. For the pre-catalytic spliceosome dataset containing 262,816 images, the training took 3 h per epoch (an epoch represents a loop through the whole training set once) using four Nvidia V100 GPUs, and the best results were obtained between 12 and 16 epochs. The 3D convolutional architecture incurred a larger memory cost than cryoDRGN. When the output 3D volume is of a size of 256<sup>3</sup>, an Nvidia V100 GPU with 32 GB memory could process around 16 images at once. However, OPUS-DSD enables the user to specify a smaller output volume to save memory, which was accomplished by resampling intermediate tensors: for example, the resampling of the tensor of 256 × 8<sup>3</sup> in Fig. <xref rid="Fig1" ref-type="fig">1c</xref> to 256 × 6<sup>3</sup> yields an output volume of 192<sup>3</sup>, thus saving memory. Despite the larger computational and memory cost compared with cryoDRGN, the run time of OPUS-DSD should still be acceptable given that it generally converges well before the 20th epoch. For example, on the <italic>Sc</italic>80S ribosome, cryoDRGN took 8.75 h to converge using four GPUs, while OPUS-DSD took 11 h to obtain the results presented here. On the synthetic NEXT complex, cryoDRGN took 3 h with four GPUs to converge, while OPUS-DSD took 8 h to obtain the results reported. Moreover, OPUS-DSD was able to very quickly reconstruct a 3D volume for a given latent code because it generated the whole volume in one pass. In contrast, cryoDRGN is required to reevaluate the neural network at each voxel to produce a final volume. Last, OPUS-DSD implements a routine to estimate the signal-to-noise ratio of a dataset and automatically balance the strengths of regularization penalties and the reconstruction loss. Users can specify the parameters using an absolute scale without worrying about the actual signal-to-noise ratios of the dataset.</p>
    </sec>
    <sec id="Sec19">
      <title>Hyperparameter settings</title>
      <p id="Par51">In our experiments we set the restraint strength for KL divergence to be proportional to the signal-to-noise ratio of the dataset, specifically <italic>λ</italic><sub>KL</sub> = 2 × signal-to-noise ratio. OPUS-DSD can automatically estimate the signal-to-noise ratio during training. The restraint strength for the structural disentanglement prior was also set according to the signal-to-noise ratios of the dataset. For the spliceosome and <italic>Pf</italic>80S ribosome with a high signal-to-noise ratio we set <italic>λ</italic> = 2. For the <italic>Sc</italic>80S ribosome we set <italic>λ</italic> = 1. For the synthetic data and real NEXT complex datasets we set <italic>λ</italic> = 0.5. Furthermore, previous restraint strengths were weighted by a cyclical annealing schedule to avoid posterior collapse<sup><xref ref-type="bibr" rid="CR44">44</xref></sup>. We fixed the restraint strength for the total variation of the 3D volume as <italic>λ</italic><sub>tv</sub> = 1 and the restraint strength for LASSO as <inline-formula id="IEq37"><alternatives><tex-math id="M91">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\lambda }_{{l}_{1}}=0.3$$\end{document}</tex-math><mml:math id="M92"><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0.3</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq37.gif"/></alternatives></inline-formula>. The learning rate was set to 10<sup>−4</sup> and decayed by 0.95 at each epoch for all experiments. The batch size was set to 72 during the training. All training sessions were performed on four Nvidia V100 GPUs. The number of samples for interclass comparison was set to 12,800. The number of kNNs for interclass or intraclass comparison was set to 128 or 4, respectively, while the number of kFPs for interclass comparison was set to 512. The latent codes of particles were updated with a momentum of 0.7. The dimension of latent space can limit the amount of information flowing from encoder to decoder, and was often set to around 10 in the 2D to 3D translation in our experiments.</p>
    </sec>
    <sec id="Sec20">
      <title>Computation protocol</title>
      <p id="Par52">For each system the structural heterogeneity analyses were performed on the same consensus refinement result for different methods. For cryoDRGN, due to the lack of validation metrics, the number of training epochs was chosen based on the quality of the density maps reconstructed. By contrast, OPUS-DSD selected models for further analyses according to the average reconstruction errors using the validation set. The structural heterogeneity was determined by analyzing the 3D density maps reconstructed from the centroids of clusters in latent space generated by the simple Kmeans clustering algorithm<sup><xref ref-type="bibr" rid="CR45">45</xref></sup>. The latent space of different methods was also visualized in 2D using UMAP<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>. The structural heterogeneity was also analyzed using PCA. Kmeans clustering and PCA were carried out in scikit-learn 1.3.0 (ref. <sup><xref ref-type="bibr" rid="CR46">46</xref></sup>). All movies were generated by Chimera<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>.</p>
    </sec>
    <sec id="Sec21">
      <title>Cryo-EM data collection</title>
      <p id="Par53">Recombinant proteins (MTR4, RBM7 and ZCCHC8) of the NEXT complex were overexpressed separately in HEK293 GnTIˉ cells. Cells were infected with 10% volume of recombinant baculovirus at 37 °C, 95 rpm for 20 h before adding sodium butyrate to a final concentration of 10 mM, and then transferred to 30 °C for another 40 h. Cells were collected by centrifugation at 800<italic>g</italic> for 10 min at 4 °C. Recombinant protein cell pellets were mixed and suspended in lysis buffer containing 20 mM HEPES, pH 7.4, 300 mM NaCl, 4% glycerol, 1 mM TCEP and 1% NP-40, 0.1‰ nuclease and lysed using high-pressure homogenizer before centrifugation at 44,000<italic>g</italic> for 30 min at 4 °C. The supernatant was incubated with 1 ml (50% slurry) poly-flag-tag beads for 1 h at 4 °C and then poured into a gravity flow column, and beads were washed with 20 mM HEPES, pH 7.4, 300 mM NaCl and 4% glycerol. Bound proteins were eluted in the buffer containing 20 mM HEPES, pH 7.4, 300 mM NaCl, 4% glycerol and 400 μg ml<sup>−</sup><sup>1</sup> poly-flag-peptide. The NEXT complex was further purified using Superdex 200 Increase 10/300 (GE Healthcare) in a buffered solution containing 20 mM HEPES, pH 7.4, 300 mM NaCl and 4% glycerol. The desired fraction was concentrated to 50 μl. Protein cross-linking was achieved by density gradient centrifugation (10–30% glycerol, 0.2% glutaraldehyde) at 47,000 rpm (SW-55Ti, Beckman) for 8.5 h at 4 °C. Sample after centrifugation was concentrated to a minimal volume and changed to the buffer containing 20 mM HEPES, pH 7.4, and 150 mM NaCl by dialysis. Three microliters of the complex sample were applied to a Cryo Matrix amorphous alloy film R1.2/1.3 300 mesh (Zhenjiang Lehua Technology) that had been glow-discharged and vitrified using Vitrobot (Thermo Fisher Scientific) at 4 °C and 100% humidity. The experimental NEXT dataset was collected using a Titan Krios G3i 300 KV electron microscope (Thermo Fisher Scientific) equipped with a BioQuantum-K3 Summit camera (Gatan) with a 20 eV slit and in super-resolution mode. Micrographs were captured at a nominal magnification of 81,000 and a calibrated pixel size of 0.55 Å. Each video stack received a total electron dose of 50 e<sup>−</sup> per Å<sup>2</sup> in a 2.19-s exposure.</p>
    </sec>
    <sec id="Sec22">
      <title>Synthetic data preparation</title>
      <p id="Par54">The synthetic NEXT dataset consisted of 64,000 2D images of eight different conformations that were generated from the starting conformation by shifting the MTR4 helicase domains relative to the ZCCHC8 center. The density maps for these eight conformations were generated using the molmap command in Chimera from the corresponding atomic models<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>. The 2D projection was obtained by projecting the density map of a conformation onto the 2D plane along a randomly sampled projection angle. The 2D projection was then convolved with a randomly sampled CTF and contaminated by specific levels of noise to generate the final synthetic 2D images. Each conformation contained 8,000 2D images produced in this way.</p>
    </sec>
    <sec id="Sec23">
      <title>Reporting summary</title>
      <p id="Par55">Further information on research design is available in the <xref rid="MOESM2" ref-type="media">Nature Portfolio Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec id="Sec24" sec-type="materials|methods">
    <title>Online content</title>
    <p id="Par56">Any methods, additional references, Nature Portfolio reporting summaries, source data, extended data, supplementary information, acknowledgements, peer review information; details of author contributions and competing interests; and statements of data and code availability are available at 10.1038/s41592-023-02031-6.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <sec id="Sec26">
      <title>Supplementary information</title>
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41592_2023_2031_MOESM1_ESM.pdf">
            <label>Supplementary Information</label>
            <caption>
              <p>Supplementary Table 1 and Fig. 1.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="41592_2023_2031_MOESM2_ESM.pdf">
            <caption>
              <p>Reporting Summary</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="41592_2023_2031_MOESM3_ESM.pdf">
            <caption>
              <p>Peer Review File</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM4">
          <media xlink:href="41592_2023_2031_MOESM4_ESM.mp4">
            <label>Supplementary Video 1</label>
            <caption>
              <p>Traversal along the first principal component of the latent space of the pre-catalytic spliceosome showing the folding of SF3b onto the core and the formation of a chain between SF3b and helicase. Red arrow marks the location of this new chain.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM5">
          <media xlink:href="41592_2023_2031_MOESM5_ESM.mp4">
            <label>Supplementary Video 2</label>
            <caption>
              <p>Traversal along the PC1 of the latent space of the <italic>Pf</italic>80S ribosome showing the docking process of an RNA from LSU to SSU. A green arrow marks the location of this RNA on LSU, while a red arrow marks the location of this RNA on SSU.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM6">
          <media xlink:href="41592_2023_2031_MOESM6_ESM.mp4">
            <label>Supplementary Video 3</label>
            <caption>
              <p>Traversal along the PC1 of the latent space of the <italic>Pf</italic>80S ribosome showing the formation of a chain that connects one of the ends of a peripheral RNA back to SSU. A red arrow marks the location of this new chain.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM7">
          <media xlink:href="41592_2023_2031_MOESM7_ESM.mp4">
            <label>Supplementary Video 4</label>
            <caption>
              <p>Traversal along the PC1 of the latent space of the <italic>Sc</italic>80S ribosome showing the swing of a peripheral RNA. A red arrow marks the location of this RNA in the conformation at the positive end of PC1, while a green arrow marks its location in the conformation at the negative end of PC1.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM8">
          <media xlink:href="41592_2023_2031_MOESM8_ESM.mp4">
            <label>Supplementary Video 5</label>
            <caption>
              <p>Traversal along the PC1 of the latent space of the <italic>Sc</italic>80S ribosome shown by cryoDRGN. A red arrow marks the location of an RNA in the conformation at the positive end of PC1, while a green arrow marks its location in the conformation at the negative end of PC1.</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
    <sec id="Sec27">
      <title>Source data</title>
      <p>
        <supplementary-material content-type="local-data" id="MOESM9">
          <media xlink:href="41592_2023_2031_MOESM9_ESM.xlsx">
            <label>Source Data Figs. 5g,h and 6e,g and Extended Data Fig. 9e,g</label>
            <caption>
              <p>Statistical source data.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM10">
          <media xlink:href="41592_2023_2031_MOESM10_ESM.xlsx">
            <label>Source Data Fig. 5e,f and Extended Data Figs. 6e,f and 7a–c</label>
            <caption>
              <p>Statistical source data.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM11">
          <media xlink:href="41592_2023_2031_MOESM11_ESM.xlsx">
            <label>Source Data Fig. 6a,f,h and Extended Data Figs. 9f,h and 10a,e,f,g1–g4</label>
            <caption>
              <p>Statistical source data.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM12">
          <media xlink:href="41592_2023_2031_MOESM12_ESM.xlsx">
            <label>Source Data Extended Data Fig. 7d,e</label>
            <caption>
              <p>Statistical source data.</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <app-group>
    <app id="App1">
      <sec id="Sec25">
        <title>Extended data</title>
        <p id="Par61">
          <fig id="Fig7">
            <label>Extended Data Fig. 1</label>
            <caption>
              <title>Density maps of the pre-catalytic spliceosome reconstructed by OPUS-DSD’s decoder.</title>
              <p><bold>a)</bold>. Twenty density maps of the pre-catalytic spliceosome generated by OPUS-DSD’s decoder at cluster centers shown in Fig. <xref rid="Fig2" ref-type="fig">2a</xref> as inputs. <bold>b)</bold>. Comparisons between densities of SF3b, Helicase and Core in Class 12 from OPUS-DSD and high-resolution structure from multi-body refinement, together with the consensus model. Class 12 is shown in green and transparent. The high-resolution structures from multi-body refinement are shown in solid colors inside Class 12. Left-to-right three columns: the comparisons focusing on SF3b (purple), Helicase (red) and Core/Foot (yellow), respectively. The consensus structure is shown in solid blue on the right as a reference.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig7_ESM" id="d32e5457"/>
          </fig>
        </p>
        <p id="Par62">
          <fig id="Fig8">
            <label>Extended Data Fig. 2</label>
            <caption>
              <title>A highly mobile RNA identified in Class 8 of Pf80S ribosome by OPUS-DSD.</title>
              <p><bold>a)</bold> and <bold>b)</bold>. The consensus map shown at two different contour levels. <bold>c)</bold>. The density map of Class 8 identified by OPUS-DSD. The maps in a) and c) are at the same contour level, which the map at b) is at a much lower contour level. The RNA strand is visible in Class 8 from OPUS-DSD (c) and the consensus map at a very low contour level (b), while it is absent in consensus map on the same contour level as Class 8 (a), suggesting its high flexibility.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig8_ESM" id="d32e5479"/>
          </fig>
        </p>
        <p id="Par63">
          <fig id="Fig9">
            <label>Extended Data Fig. 3</label>
            <caption>
              <title>Heterogeneity analysis on S.cerevisiae 80S (S.c80S) ribosome (EMPIAR: 10002) by cryoDRGN.</title>
              <p><bold>a)</bold>. UMAP visualization of the 8-dimensional latent space of all particles encoded by cryoDRGN. Solid black dots represent the cluster centers for labeled classes. <bold>b)</bold>. Sixteen density maps reconstructed by cryoDRGN’s decoder using Kmeans clustering centers in its 8-dimensional latent space as inputs. The swinging RNA strand which was revealed in the results of OPUS-DSD can also be observed in cryoDRGN’s results here (red dashed boxes). <bold>c)</bold>. Comparison between the density maps of Class 9 from OPUS-DSD (in green color) and Class 8 from cryoDRGN (in purple color). The density map of Class 9 from OPUS-DSD is more complete in regions marked by red dashed ellipse. Both maps are contoured at the same level.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig9_ESM" id="d32e5501"/>
          </fig>
        </p>
        <p id="Par64">
          <fig id="Fig10">
            <label>Extended Data Fig. 4</label>
            <caption>
              <title>The movements of an RNA strand and the 40S subunit in S.c80S ribosome revealed by OPUS-DSD.</title>
              <p><bold>a)</bold>. The movements of an RNA strand in S.c80S ribosome revealed by OPUS-DSD. The reference density map of Class 9 from OPUS-DSD is colored in green and semi-transparent. The density maps shown in order are Classes 8, 4, 6, and 5, exhibiting increasingly larger displacements in the RNA (as marked by the red dashed boxes) relative to its position in Class 9. The arrows in the same color as the density maps are drawn to highlight the displacements. <bold>b)</bold>. The movement of the 40S subunit in S.c80S ribosome revealed by OPUS-DSD. The reference density map of Class 4 from OPUS-DSD is colored in violet and semi-transparent. The density maps shown in order are Classes 2, 13, 7, and 15, displaying increasingly larger displacements in 40S subunit (marked by red dashed boxes) relative to its position in Class 4. The arrows in the same color as the density maps are drawn to highlight the displacements.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig10_ESM" id="d32e5520"/>
          </fig>
        </p>
        <p id="Par65">
          <fig id="Fig11">
            <label>Extended Data Fig. 5</label>
            <caption>
              <title>Reconstructions of OPUS-DSD and cryoDRGN on synthetic dataset of NEXT complex with a signal-to-noise ratio of 0.05.</title>
              <p><bold>a)</bold>. 3D density maps reconstructed by the decoder of OPUS-DSD using cluster centers shown in Fig. <xref rid="Fig6" ref-type="fig">6b</xref>. <bold>b)</bold>. 3D density maps reconstructed by the decoder of cryoDRGN using cluster centers shown in Fig. <xref rid="Fig6" ref-type="fig">6b</xref>. <bold>c)</bold>. 3D density maps reconstructed by cryoSPARC with particles in each class from OPUS-DSD. <bold>d)</bold>. 3D density maps reconstructed by cryoSPARC with particles in each class from cryoDRGN.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig11_ESM" id="d32e5551"/>
          </fig>
        </p>
        <p id="Par66">
          <fig id="Fig12">
            <label>Extended Data Fig. 6</label>
            <caption>
              <title>Heterogeneity analysis on synthetic dataset of NEXT complex with signal-to-noise ratio of 0.1.</title>
              <p><bold>a)</bold>. The starting atomic model of NEXT complex. <bold>b)</bold>. Ground-truth density maps of NEXT complexes. <bold>c)</bold>. Consensus model reconstructed by cryoSPARC using all particles. <bold>d)</bold>. UMAP visualizations of the 8-dimensional latent spaces of all particles encoded by OPUS-DSD (left panel) and cryoDRGN (right panel). <bold>e)</bold>. Distribution of particles in clusters in the latent space of OPUS-DSD. Bars are colored to match the profiles of the ground-truth density maps in b). Entropy is defined as the average of <inline-formula id="IEq38"><alternatives><tex-math id="M93">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$-{\sum }_{i}{p}_{i}\log {p}_{i}$$\end{document}</tex-math><mml:math id="M94"><mml:mrow><mml:mo>−</mml:mo><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mi>log</mml:mi><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq38.gif"/></alternatives></inline-formula> of each cluster, where <inline-formula id="IEq39"><alternatives><tex-math id="M95">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${p}_{i}=\frac{{n}_{i}}{{\sum }_{i}{n}_{i}}$$\end{document}</tex-math><mml:math id="M96"><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq39.gif"/></alternatives></inline-formula>, and <italic>n</italic><sub><italic>i</italic></sub> is the number of particles in the ground-truth conformation <italic>i</italic>. <bold>f)</bold>. Distribution of particles in clusters in the latent space of cryoDRGN. <bold>g)</bold>. 3D density maps reconstructed by particles in each class from OPUS-DSD. <bold>h)</bold>. 3D density maps reconstructed by particles in each class from cryoDRGN.</p>
              <p>
                <xref rid="MOESM10" ref-type="media">Source data</xref>
              </p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig12_ESM" id="d32e5681"/>
          </fig>
        </p>
        <p id="Par67">
          <fig id="Fig13">
            <label>Extended Data Fig. 7</label>
            <caption>
              <title>Contributions of disentanglement prior and data augmentation to the performance of OPUS-DSD.</title>
              <p><bold>a)</bold>. Distribution of particles in the latent space of OPUS-DSD with disentanglement prior and data augmentation on the synthetic data of NEXT complex. <bold>b)</bold>. Distribution of particles in the latent space of OPUS-DSD without disentanglement prior. <bold>c)</bold>. Distribution of particles in the latent space of OPUS-DSD without data augmentation. <bold>d)</bold>. Validation and training losses of S.c80S ribosome with data augmentation in OPUS-DSD. <bold>e)</bold>. Validation and training losses of S.c80S ribosome without data augmentation in OPUS-DSD.</p>
              <p>
                <xref rid="MOESM10" ref-type="media">Source data</xref>
              </p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig13_ESM" id="d32e5714"/>
          </fig>
        </p>
        <p id="Par68">
          <fig id="Fig14">
            <label>Extended Data Fig. 8</label>
            <caption>
              <title>Comparison of unmasked half maps.</title>
              <p><bold>a)</bold>. Unmasked half maps from the results of heterogeneity analyses by OPUS-DSD on the 224,354 particles of NEXT complex. <bold>b)</bold>. Unmasked half maps from the results of heterogeneity analyses by cryoDRGN on the 224,354 particles of NEXT complex.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig14_ESM" id="d32e5733"/>
          </fig>
        </p>
        <p id="Par69">
          <fig id="Fig15">
            <label>Extended Data Fig. 9</label>
            <caption>
              <title>Heterogeneity analysis on NEXT complex with focused refinement.</title>
              <p><bold>a)</bold>. Starting consensus model which was refined with a mask without the MTR4 domain using RELION. <bold>b)</bold>. UMAP visualizations of latent spaces learned by OPUS-DSD (left panel) and cryoDRGN (right panel). The dots with numbers are cluster centers found by Kmeans algorithm. <bold>c)</bold>. Ten classes reconstructed by OPUS-DSD at points shown in <bold>b</bold> and the corresponding number of particles in each class. <bold>d)</bold>. Ten classes reconstructed by cryoDRGN and the corresponding number of particles in each class. <bold>e)</bold>. Translation–rotation plot for reconstructions from OPUS-DSD. The movement is measured for the MTR4 domain relative to the ZCCHC8 domain of each conformation by Dyndom using the consensus model as a reference. <bold>f)</bold>. Density map and gold-standard FSCs for 85,570 particles by combining OPUS-DSD’s clusters with small structural variations (grouped by red circle in <bold>e</bold>). <bold>g)</bold>. Translation–rotation plot for reconstructions from cryoDRGN. The movement is measured for the MTR4 domain relative to the ZCCHC8 domain of each conformation by Dyndom using the consensus model as a reference. <bold>h)</bold>. Density map and gold-standard FSCs for 96,466 particles by combining cryoDRGN’s clusters with small structural variations (grouped by blue circle in <bold>g</bold>). <bold>i)</bold>. Unmasked half maps for OPUS-DSD’s cluster in <bold>f)</bold>. <bold>j)</bold>. Unmasked half maps for cryoDRGN’s cluster in <bold>h)</bold>. All maps are contoured at the same level.</p>
              <p>
                <xref rid="MOESM9" ref-type="media">Source data</xref>
              </p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig15_ESM" id="d32e5798"/>
          </fig>
        </p>
        <p id="Par70">
          <fig id="Fig16">
            <label>Extended Data Fig. 10</label>
            <caption>
              <title>Heterogeneity analysis of 84,530 particles of NEXT complex.</title>
              <p><bold>a)</bold>. Starting consensus model and its gold-standard FSCs for all particles. <bold>b)</bold>. UMAP visualizations of latent spaces learned by OPUS-DSD (left panel) and cryoDRGN (right panel). The dots with numbers are cluster centers found by Kmeans algorithm. <bold>c)</bold>. Five classes reconstructed by OPUS-DSD and the corresponding number of particles in each class. <bold>d)</bold>. Five classes reconstructed by cryoDRGN and the corresponding number of particles in each class. <bold>e)</bold>. Density map and gold-standard FSCs for 63,368 particles by combining OPUS-DSD’s Classes 0, 1 and 3. <bold>f)</bold>. Density map and gold-standard FSCs for 68,879 particles by combining cryoDRGN’s Classes 1 ~ 4. <bold>g)</bold>. FSCs for reconstructions after randomly discarding a quarter of 84,530 particles in four parallel trials.</p>
              <p>
                <xref rid="MOESM11" ref-type="media">Source data</xref>
              </p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig16_ESM" id="d32e5838"/>
          </fig>
        </p>
      </sec>
    </app>
  </app-group>
  <fn-group>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <sec>
    <sec id="FPar1">
      <title>Extended data</title>
      <p id="Par57">are available for this paper at 10.1038/s41592-023-02031-6.</p>
    </sec>
    <sec id="FPar2" sec-type="supplementary-material">
      <title>Supplementary information</title>
      <p id="Par58">The online version contains supplementary material available at 10.1038/s41592-023-02031-6.</p>
    </sec>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank C. Jia for providing the cryo-EM dataset for the NEXT complex. We also thank the staff at MRICS Cryo-EM Center at Fudan University for their help with data collection. We also acknowledge the open-source software cryoDRGN, upon which OPUS-DSD was built. The research was partially supported by the National Key Research and Development Program of China (No. 2021YFF1200400), and Shanghai Municipal Science and Technology Major Project (No. 2018SHZDZX01) and ZJLab.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>Z.L., Q.W. and J.M. conceived the work. Z.L. designed the algorithm and implemented the software. Z.L. and F.N. performed the experiments. All authors wrote and approved the final paper.</p>
  </notes>
  <notes notes-type="peer-review">
    <title>Peer review</title>
    <sec id="FPar3">
      <title>Peer review information</title>
      <p id="Par59"><italic>Nature Methods</italic> thanks Tim Grant and the other, anonymous, reviewer(s) for their contribution to the peer review of this work. <xref rid="MOESM3" ref-type="media">Peer reviewer reports</xref> are available. Primary Handling Editor: Allison Doerr, in collaboration with the <italic>Nature Methods</italic> team.</p>
    </sec>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>We used the following publicly available datasets: EMPIAR-10180 (structure of a pre-catalytic spliceosome), EMPIAR-10028 (cryo-EM structure of a <italic>Pf</italic>80S ribosome bound to the anti-protozoan drug emetine) and EMPIAR-10002 (<italic>Sc</italic>80S ribosome direct electron detector dataset). Synthetic and real NEXT datasets are deposited in Zenodo at 10.5281/zenodo.8093296 (ref. <sup><xref ref-type="bibr" rid="CR48">48</xref></sup>). Cryo-EM density maps for the real NEXT complex are deposited in the Electron Microscopy DataBank (EMDB) with the accession number EMD-<ext-link ext-link-type="uri" xlink:href="https://www.ebi.ac.uk/pdbe/entry/emdb/EMD-37262">37262</ext-link>. Trained models and heterogeneity analysis results are deposited in Zenodo at 10.5281/zenodo.8143779 (ref. <sup><xref ref-type="bibr" rid="CR49">49</xref></sup>). <xref ref-type="sec" rid="Sec27">Source data</xref> are provided with this paper.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>OPUS-DSD software is deposited in Code Ocean at 10.24433/CO.3046690.v1 (ref. <sup><xref ref-type="bibr" rid="CR50">50</xref></sup>) and is also available at <ext-link ext-link-type="uri" xlink:href="https://github.com/alncat/opusDSD">https://github.com/alncat/opusDSD</ext-link>.</p>
  </notes>
  <notes id="FPar4" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par60">Q.W. is an employee of Harcam Biomedicines who is bound by confidentiality agreements that prevent her from disclosing the competing interests in this work. The other authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <mixed-citation publication-type="other">McCammon, J. A. &amp; Harvey, S. C. <italic>Dynamics of Proteins and Nucleic Acids</italic> (Cambridge Univ. Press, 1988).</mixed-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Glaeser</surname>
            <given-names>RM</given-names>
          </name>
        </person-group>
        <article-title>How good can cryo-EM become?</article-title>
        <source>Nat. Methods</source>
        <year>2016</year>
        <volume>13</volume>
        <fpage>28</fpage>
        <lpage>32</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.3695</pub-id>
        <?supplied-pmid 26716559?>
        <pub-id pub-id-type="pmid">26716559</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Scheres</surname>
            <given-names>SHW</given-names>
          </name>
        </person-group>
        <article-title>A Bayesian view on cryo-EM structure determination</article-title>
        <source>J. Mol. Biol.</source>
        <year>2012</year>
        <volume>415</volume>
        <fpage>406</fpage>
        <lpage>418</lpage>
        <pub-id pub-id-type="doi">10.1016/j.jmb.2011.11.010</pub-id>
        <?supplied-pmid 22100448?>
        <pub-id pub-id-type="pmid">22100448</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cheng</surname>
            <given-names>Y</given-names>
          </name>
        </person-group>
        <article-title>Single-particle cryo-EM at crystallographic resolution</article-title>
        <source>Cell</source>
        <year>2015</year>
        <volume>161</volume>
        <fpage>450</fpage>
        <lpage>457</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2015.03.049</pub-id>
        <?supplied-pmid 25910205?>
        <pub-id pub-id-type="pmid">25910205</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lyumkis</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Brilot</surname>
            <given-names>AF</given-names>
          </name>
          <name>
            <surname>Theobald</surname>
            <given-names>DL</given-names>
          </name>
          <name>
            <surname>Grigorieff</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Likelihood-based classification of cryo-EM images using FREALIGN</article-title>
        <source>J. Struct. Biol.</source>
        <year>2013</year>
        <volume>183</volume>
        <fpage>377</fpage>
        <lpage>388</lpage>
        <pub-id pub-id-type="doi">10.1016/j.jsb.2013.07.005</pub-id>
        <?supplied-pmid 23872434?>
        <pub-id pub-id-type="pmid">23872434</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Scheres</surname>
            <given-names>SHW</given-names>
          </name>
        </person-group>
        <article-title>RELION: implementation of a Bayesian approach to cryo-EM structure determination</article-title>
        <source>J. Struct. Biol.</source>
        <year>2012</year>
        <volume>180</volume>
        <fpage>519</fpage>
        <lpage>530</lpage>
        <pub-id pub-id-type="doi">10.1016/j.jsb.2012.09.006</pub-id>
        <?supplied-pmid 23000701?>
        <pub-id pub-id-type="pmid">23000701</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Nakane</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Kimanius</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Lindahl</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Scheres</surname>
            <given-names>SH</given-names>
          </name>
        </person-group>
        <article-title>Characterisation of molecular motions in cryo-EM single-particle data by multi-body refinement in RELION</article-title>
        <source>eLife</source>
        <year>2018</year>
        <volume>7</volume>
        <fpage>e36861</fpage>
        <pub-id pub-id-type="doi">10.7554/eLife.36861</pub-id>
        <?supplied-pmid 29856314?>
        <pub-id pub-id-type="pmid">29856314</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Punjani</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Fleet</surname>
            <given-names>DJ</given-names>
          </name>
        </person-group>
        <article-title>3D variability analysis: resolving continuous flexibility and discrete heterogeneity from single particle cryo-EM</article-title>
        <source>J. Struct. Biol.</source>
        <year>2021</year>
        <volume>213</volume>
        <fpage>107702</fpage>
        <pub-id pub-id-type="doi">10.1016/j.jsb.2021.107702</pub-id>
        <?supplied-pmid 33582281?>
        <pub-id pub-id-type="pmid">33582281</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <mixed-citation publication-type="other">Gupta, H., Phan, T. H., Yoo, J. &amp; Unser, M. Multi-CryoGAN: reconstruction of continuous conformations in cryo-EM using generative adversarial networks. In <italic>Computer Vision – ECCV 2020 Workshops</italic> (eds Bartoli, A. &amp; Fusiello, A.) 429–444 (ECCV, 2020).</mixed-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Chen</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Ludtke</surname>
            <given-names>SJ</given-names>
          </name>
        </person-group>
        <article-title>Deep learning-based mixed-dimensional Gaussian mixture model for characterizing variability in cryo-EM</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>930</fpage>
        <lpage>936</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-021-01220-5</pub-id>
        <?supplied-pmid 34326541?>
        <pub-id pub-id-type="pmid">34326541</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Punjani</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Fleet</surname>
            <given-names>DJ</given-names>
          </name>
        </person-group>
        <article-title>3D flexible refinement: determining structure and motion of flexible proteins from cryo-EM</article-title>
        <source>Microsc. Microanal.</source>
        <year>2023</year>
        <volume>29</volume>
        <issue>Suppl. 1</issue>
        <fpage>1024</fpage>
        <pub-id pub-id-type="doi">10.1093/micmic/ozad067.518</pub-id>
        <?supplied-pmid 37613218?>
        <pub-id pub-id-type="pmid">37613218</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhong</surname>
            <given-names>ED</given-names>
          </name>
          <name>
            <surname>Bepler</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Berger</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Davis</surname>
            <given-names>JH</given-names>
          </name>
        </person-group>
        <article-title>CryoDRGN: reconstruction of heterogeneous cryo-EM structures using neural networks</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>176</fpage>
        <lpage>185</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-020-01049-4</pub-id>
        <?supplied-pmid 33542510?>
        <pub-id pub-id-type="pmid">33542510</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <mixed-citation publication-type="other">Higgins, I. et al. β-VAE: learning basic visual concepts with a constrained variational framework. In <italic>International Conference on Learning Representations</italic> (ICLR, 2017).</mixed-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <mixed-citation publication-type="other">Kingma, D. P. &amp; Welling, M. Auto-encoding variational Bayes. In <italic>International Conference for Learning Representations</italic> (ICLR, 2014).</mixed-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <mixed-citation publication-type="other">LeCun, Y. &amp; Bengio, Y. Convolutional networks for images, speech, and time series. In <italic>The Handbook of Brain Theory and Neural Networks</italic> (ed. Arbib, M. A.) 255–258 (MIT Press, 1998).</mixed-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ji</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Xu</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Yu</surname>
            <given-names>K</given-names>
          </name>
        </person-group>
        <article-title>3D convolutional neural networks for human action recognition</article-title>
        <source>IEEE Trans. Pattern Anal. Mach. Intell.</source>
        <year>2013</year>
        <volume>35</volume>
        <fpage>221</fpage>
        <lpage>231</lpage>
        <pub-id pub-id-type="doi">10.1109/TPAMI.2012.59</pub-id>
        <?supplied-pmid 22392705?>
        <pub-id pub-id-type="pmid">22392705</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lombardi</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Neural volumes: learning dynamic renderable volumes from images</article-title>
        <source>ACM Trans. Graph.</source>
        <year>2019</year>
        <volume>38</volume>
        <fpage>65</fpage>
        <pub-id pub-id-type="doi">10.1145/3306346.3323020</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <mixed-citation publication-type="other">Jaderberg, M., Simonyan, K., Zisserman, A. &amp; Kavukcuoglu, K. Spatial transformer networks. In <italic>Advances in Neural Information Processing Systems</italic><bold>28</bold> (NeurIPS, 2015).</mixed-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Luo</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Campos-Acevedo</surname>
            <given-names>AA</given-names>
          </name>
          <name>
            <surname>Lv</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Ma</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Sparseness and smoothness regularized imaging for improving the resolution of cryo-EM single-particle reconstruction</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2021</year>
        <volume>118</volume>
        <fpage>e2013756118</fpage>
        <pub-id pub-id-type="doi">10.1073/pnas.2013756118</pub-id>
        <?supplied-pmid 33402531?>
        <pub-id pub-id-type="pmid">33402531</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Plaschka</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Lin</surname>
            <given-names>P-C</given-names>
          </name>
          <name>
            <surname>Nagai</surname>
            <given-names>K</given-names>
          </name>
        </person-group>
        <article-title>Structure of a pre-catalytic spliceosome</article-title>
        <source>Nature</source>
        <year>2017</year>
        <volume>546</volume>
        <fpage>617</fpage>
        <lpage>621</lpage>
        <pub-id pub-id-type="doi">10.1038/nature22799</pub-id>
        <?supplied-pmid 28530653?>
        <pub-id pub-id-type="pmid">28530653</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <mixed-citation publication-type="other">McInnes, L., Healy, J. &amp; Melville, J. UMAP: uniform manifold approximation and projection for dimension reduction. Preprint at <ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1802.03426">https://arxiv.org/abs/1802.03426</ext-link> (2018).</mixed-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Haselbach</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Structure and conformational dynamics of the human spliceosomal Bact complex</article-title>
        <source>Cell</source>
        <year>2018</year>
        <volume>172</volume>
        <fpage>454</fpage>
        <lpage>464</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2018.01.010</pub-id>
        <?supplied-pmid 29361316?>
        <pub-id pub-id-type="pmid">29361316</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wong</surname>
            <given-names>W</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cryo-EM structure of the <italic>Plasmodium falciparum</italic> 80S ribosome bound to the anti-protozoan drug emetine</article-title>
        <source>eLife</source>
        <year>2014</year>
        <volume>3</volume>
        <fpage>e03080</fpage>
        <pub-id pub-id-type="doi">10.7554/eLife.03080</pub-id>
        <?supplied-pmid 24913268?>
        <pub-id pub-id-type="pmid">24913268</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bai</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Fernandez</surname>
            <given-names>IS</given-names>
          </name>
          <name>
            <surname>McMullan</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Scheres</surname>
            <given-names>SHW</given-names>
          </name>
        </person-group>
        <article-title>Ribosome structures to near-atomic resolution from thirty thousand cryo-EM particles</article-title>
        <source>eLife</source>
        <year>2013</year>
        <volume>2</volume>
        <fpage>e00461</fpage>
        <pub-id pub-id-type="doi">10.7554/eLife.00461</pub-id>
        <?supplied-pmid 23427024?>
        <pub-id pub-id-type="pmid">23427024</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Puno</surname>
            <given-names>MR</given-names>
          </name>
          <name>
            <surname>Lima</surname>
            <given-names>CD</given-names>
          </name>
        </person-group>
        <article-title>Structural basis for MTR4–ZCCHC8 interactions that stimulate the MTR4 helicase in the nuclear exosome-targeting complex</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2018</year>
        <volume>115</volume>
        <fpage>E5506</fpage>
        <lpage>E5515</lpage>
        <pub-id pub-id-type="doi">10.1073/pnas.1803530115</pub-id>
        <?supplied-pmid 29844170?>
        <pub-id pub-id-type="pmid">29844170</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bai</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Rajendra</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Shi</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Scheres</surname>
            <given-names>SHW</given-names>
          </name>
        </person-group>
        <article-title>Sampling the conformational space of the catalytic subunit of human γ-secretase</article-title>
        <source>eLife</source>
        <year>2015</year>
        <volume>4</volume>
        <fpage>e11182</fpage>
        <pub-id pub-id-type="doi">10.7554/eLife.11182</pub-id>
        <?supplied-pmid 26623517?>
        <pub-id pub-id-type="pmid">26623517</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Chen</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>High-resolution noise substitution to measure overfitting and validate resolution in 3D structure determination by single particle electron cryomicroscopy</article-title>
        <source>Ultramicroscopy</source>
        <year>2013</year>
        <volume>135</volume>
        <fpage>24</fpage>
        <lpage>35</lpage>
        <pub-id pub-id-type="doi">10.1016/j.ultramic.2013.06.004</pub-id>
        <?supplied-pmid 23872039?>
        <pub-id pub-id-type="pmid">23872039</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Punjani</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Fleet</surname>
            <given-names>DJ</given-names>
          </name>
        </person-group>
        <article-title>Non-uniform refinement: adaptive regularization improves single-particle cryo-EM reconstruction</article-title>
        <source>Nat. Methods</source>
        <year>2020</year>
        <volume>17</volume>
        <fpage>1214</fpage>
        <lpage>1221</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-020-00990-8</pub-id>
        <?supplied-pmid 33257830?>
        <pub-id pub-id-type="pmid">33257830</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <mixed-citation publication-type="other">Cohen, T. &amp; Welling, M. Group equivariant convolutional networks. In <italic>Proc. 33rd</italic><italic>International Conference on Machine Learning</italic> (eds Balcan, M. F. &amp; Weinberger, K. Q.) 2990–2999 (PMLR, 2016).</mixed-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Scheres</surname>
            <given-names>SHW</given-names>
          </name>
        </person-group>
        <article-title>Semi-automated selection of cryo-EM particles in RELION-1.3</article-title>
        <source>J. Struct. Biol.</source>
        <year>2015</year>
        <volume>189</volume>
        <fpage>114</fpage>
        <lpage>122</lpage>
        <pub-id pub-id-type="doi">10.1016/j.jsb.2014.11.010</pub-id>
        <?supplied-pmid 25486611?>
        <pub-id pub-id-type="pmid">25486611</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rudin</surname>
            <given-names>LI</given-names>
          </name>
          <name>
            <surname>Osher</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Fatemi</surname>
            <given-names>E</given-names>
          </name>
        </person-group>
        <article-title>Nonlinear total variation based noise removal algorithms</article-title>
        <source>Phys. D Nonlin. Phenom.</source>
        <year>1992</year>
        <volume>60</volume>
        <fpage>259</fpage>
        <lpage>268</lpage>
        <pub-id pub-id-type="doi">10.1016/0167-2789(92)90242-F</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tibshirani</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Regression shrinkage and selection via the lasso</article-title>
        <source>J. R. Stat. Soc. (Methodol.)</source>
        <year>1996</year>
        <volume>58</volume>
        <fpage>267</fpage>
        <lpage>288</lpage>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <mixed-citation publication-type="other">Maas, A. L., Hannun, A. Y. &amp; Ng, A. Y. Rectifier nonlinearities improve neural network acoustic models. In <italic>International Conference on Machine Learning</italic><bold>30</bold>, 3 (ICML, 2013).</mixed-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Goddard</surname>
            <given-names>TD</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>UCSF ChimeraX: meeting modern challenges in visualization and analysis</article-title>
        <source>Protein Sci.</source>
        <year>2018</year>
        <volume>27</volume>
        <fpage>14</fpage>
        <lpage>25</lpage>
        <pub-id pub-id-type="doi">10.1002/pro.3235</pub-id>
        <?supplied-pmid 28710774?>
        <pub-id pub-id-type="pmid">28710774</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Veevers</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Hayward</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Methodological improvements for the analysis of domain movements in large biomolecular complexes</article-title>
        <source>Biophys. Physicobiol.</source>
        <year>2019</year>
        <volume>16</volume>
        <fpage>328</fpage>
        <lpage>336</lpage>
        <pub-id pub-id-type="doi">10.2142/biophysico.16.0_328</pub-id>
        <?supplied-pmid 31984188?>
        <pub-id pub-id-type="pmid">31984188</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rohou</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Grigorieff</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>CTFFIND4: fast and accurate defocus estimation from electron micrographs</article-title>
        <source>J. Struct. Biol.</source>
        <year>2015</year>
        <volume>192</volume>
        <fpage>216</fpage>
        <lpage>221</lpage>
        <pub-id pub-id-type="doi">10.1016/j.jsb.2015.08.008</pub-id>
        <?supplied-pmid 26278980?>
        <pub-id pub-id-type="pmid">26278980</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rosenblatt</surname>
            <given-names>F</given-names>
          </name>
        </person-group>
        <article-title>The perceptron: a probabilistic model for information storage and organization in the brain</article-title>
        <source>Psychol. Rev.</source>
        <year>1958</year>
        <volume>65</volume>
        <fpage>386</fpage>
        <lpage>408</lpage>
        <pub-id pub-id-type="doi">10.1037/h0042519</pub-id>
        <?supplied-pmid 13602029?>
        <pub-id pub-id-type="pmid">13602029</pub-id>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <mixed-citation publication-type="other">Bepler, T., Zhong, E., Kelley, K., Brignole, E. &amp; Berger, B. Explicitly disentangling image content from translation and rotation with spatial-VAE. In <italic>Advances in Neural Information Processing Systems</italic><bold>32</bold> (NeurIPS, 2019).</mixed-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <mixed-citation publication-type="other">Zhong, E. D., Lerer, A., Davis, J. H. &amp; Berger, B. CryoDRGN2: ab initio neural reconstruction of 3D protein structures from real cryo-EM images. In <italic>Proc. IEEE/CVF International Conference on Computer Vision</italic> 4066–4075 (ICCV, 2021).</mixed-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Gorski</surname>
            <given-names>KM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>HEALPix: a framework for high-resolution discretization and fast analysis of data distributed on the sphere</article-title>
        <source>Astrophys. J.</source>
        <year>2005</year>
        <volume>622</volume>
        <fpage>759</fpage>
        <pub-id pub-id-type="doi">10.1086/427976</pub-id>
      </element-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Punjani</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Rubinstein</surname>
            <given-names>JL</given-names>
          </name>
          <name>
            <surname>Fleet</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Brubaker</surname>
            <given-names>MA</given-names>
          </name>
        </person-group>
        <article-title>cryoSPARC: algorithms for rapid unsupervised cryo-EM structure determination</article-title>
        <source>Nat. Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>290</fpage>
        <lpage>296</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4169</pub-id>
        <?supplied-pmid 28165473?>
        <pub-id pub-id-type="pmid">28165473</pub-id>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <mixed-citation publication-type="other">Kingma, D. P. &amp; Ba, J. Adam: a method for stochastic optimization. In <italic>International Conference for Learning Representations</italic> (ICLR, 2015).</mixed-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <mixed-citation publication-type="other">Paszke, A. et al. PyTorch: an imperative style, high-performance deep learning library. In <italic>Advances in Neural Information Processing Systems</italic><bold>32</bold> (NeurIPS, 2019).</mixed-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <mixed-citation publication-type="other">Fu, H. et al. Cyclical annealing schedule: a simple approach to mitigating KL vanishing. In <italic>Proc. 2019 Conference of</italic><italic>the North American Chapter of the Association for Computational Linguistics: Human Language Technologies, Volume 1 (Long and Short Papers)</italic> (eds Burstein, J. et al) 240–250 (Association for Computational Linguistics, 2019).</mixed-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lloyd</surname>
            <given-names>SP</given-names>
          </name>
        </person-group>
        <article-title>Least squares quantization in PCM</article-title>
        <source>IEEE Trans. Inf. Theory</source>
        <year>1982</year>
        <volume>28</volume>
        <fpage>129</fpage>
        <lpage>137</lpage>
        <pub-id pub-id-type="doi">10.1109/TIT.1982.1056489</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Pedregosa</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Scikit-learn: machine learning in Python</article-title>
        <source>J. Mach. Learn. Res.</source>
        <year>2011</year>
        <volume>12</volume>
        <fpage>2825</fpage>
        <lpage>2830</lpage>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Pettersen</surname>
            <given-names>EF</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>UCSF Chimera: a visualization system for exploratory research and analysis</article-title>
        <source>J. Comput. Chem.</source>
        <year>2004</year>
        <volume>25</volume>
        <fpage>1605</fpage>
        <lpage>1612</lpage>
        <pub-id pub-id-type="doi">10.1002/jcc.20084</pub-id>
        <?supplied-pmid 15264254?>
        <pub-id pub-id-type="pmid">15264254</pub-id>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <mixed-citation publication-type="other">Luo, Z., Ni, F., Wang, Q. &amp; Ma, J. Data for ‘OPUS-DSD: deep structural disentanglement for cryo-EM single particle analysis’. <italic>Zenodo</italic>10.5281/zenodo.8093296 (2023).</mixed-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <mixed-citation publication-type="other">Luo, Z., Ni, F., Ma, J. &amp; Wang, Q. Results for ‘OPUS-DSD: deep structural disentanglement for cryo-EM single particle analysis’. <italic>Zenodo</italic>10.5281/zenodo.8143779 (2023).</mixed-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <mixed-citation publication-type="other">Luo, Z. OPUS-DSD: version 1.0.0. <italic>Code Ocean</italic>10.24433/CO.3046690.v1 (2023).</mixed-citation>
    </ref>
  </ref-list>
</back>
<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Methods</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Methods</journal-id>
    <journal-title-group>
      <journal-title>Nature Methods</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1548-7091</issn>
    <issn pub-type="epub">1548-7105</issn>
    <publisher>
      <publisher-name>Nature Publishing Group US</publisher-name>
      <publisher-loc>New York</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10630141</article-id>
    <article-id pub-id-type="pmid">37813988</article-id>
    <article-id pub-id-type="publisher-id">2031</article-id>
    <article-id pub-id-type="doi">10.1038/s41592-023-02031-6</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>OPUS-DSD: deep structural disentanglement for cryo-EM single-particle analysis</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Luo</surname>
          <given-names>Zhenwei</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Ni</surname>
          <given-names>Fengyun</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-0480-3404</contrib-id>
        <name>
          <surname>Wang</surname>
          <given-names>Qinghua</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0009-0001-2124-6080</contrib-id>
        <name>
          <surname>Ma</surname>
          <given-names>Jianpeng</given-names>
        </name>
        <address>
          <email>jpma@fudan.edu.cn</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff2">2</xref>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/013q1eq08</institution-id><institution-id institution-id-type="GRID">grid.8547.e</institution-id><institution-id institution-id-type="ISNI">0000 0001 0125 2443</institution-id><institution>Multiscale Research Institute of Complex Systems, </institution><institution>Fudan University, </institution></institution-wrap>Shanghai, China </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ROR">https://ror.org/013q1eq08</institution-id><institution-id institution-id-type="GRID">grid.8547.e</institution-id><institution-id institution-id-type="ISNI">0000 0001 0125 2443</institution-id><institution>Zhangjiang Fudan International Innovation Center, </institution><institution>Fudan University, </institution></institution-wrap>Shanghai, China </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="GRID">grid.517892.0</institution-id><institution-id institution-id-type="ISNI">0000 0005 0475 7227</institution-id><institution>Shanghai AI Laboratory, </institution></institution-wrap>Shanghai, China </aff>
      <aff id="Aff4"><label>4</label>Center for Biomolecular Innovation, Harcam Biomedicines, Shanghai, China </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>9</day>
      <month>10</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>9</day>
      <month>10</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="ppub">
      <year>2023</year>
    </pub-date>
    <volume>20</volume>
    <issue>11</issue>
    <fpage>1729</fpage>
    <lpage>1738</lpage>
    <history>
      <date date-type="received">
        <day>22</day>
        <month>11</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>24</day>
        <month>8</month>
        <year>2023</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2023</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Cryo-electron microscopy (cryo-EM) captures snapshots of dynamic macromolecules, collectively illustrating the involved structural landscapes. This provides an exciting opportunity to explore the structural variations of macromolecules under study. However, traditional cryo-EM single-particle analysis often yields static structures. Here we describe OPUS-DSD, an algorithm capable of efficiently reconstructing the structural landscape embedded in cryo-EM data. OPUS-DSD uses a three-dimensional convolutional encoder–decoder architecture trained with cryo-EM images, thereby encoding structural variations into a smooth and easily analyzable low-dimension space. This space can be traversed to reconstruct continuous dynamics or clustered to identify distinct conformations. OPUS-DSD can offer meaningful insights into the structural variations of macromolecules, filling in the gaps left by traditional cryo-EM structural determination, and potentially improves the reconstruction resolution by reliably clustering similar particles within the dataset. These functionalities are especially relevant to the study of highly dynamic biological systems. OPUS-DSD is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/alncat/opusDSD">https://github.com/alncat/opusDSD</ext-link>.</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">OPUS-DSD is a neural network-based algorithm that reconstructs distinct conformations or continuous dynamics of the macromolecular structural landscape, starting from single-particle cryo-EM data.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Computational biophysics</kwd>
      <kwd>Computational models</kwd>
      <kwd>Cryoelectron microscopy</kwd>
      <kwd>Proteins</kwd>
      <kwd>Software</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Shanghai Municipal Science and Technology Major Project (No.2018SHZDZX01) and ZJLab, National Key Research and Development Program of China (No.2021YFF1200400).</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© Springer Nature America, Inc. 2023</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Main</title>
    <p id="Par3">Macromolecules are dynamic machines that use specialized motions to carry out their functions<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>. Structural biology aims to determine the three-dimensional (3D) structure of macromolecules to high resolution, and at the same time understand their functions by reconstructing the underlying dynamics. Cryo-electron microscopy (cryo-EM) single-particle analysis (SPA) is a powerful method for obtaining high-resolution 3D structures<sup><xref ref-type="bibr" rid="CR2">2</xref>–<xref ref-type="bibr" rid="CR4">4</xref></sup>. Conventional cryo-EM SPA reconstruction often produces only a single static 3D model. However, the large number of snapshots captured by cryo-EM preserves a huge amount of conformational and/or compositional heterogeneity that may be functionally important. Moreover, the flexibility of 3D macromolecules is a major bottleneck to the achievement of high resolution in cryo-EM SPA<sup><xref ref-type="bibr" rid="CR2">2</xref></sup>. Therefore, powerful analysis methods are needed to reliably recover structural heterogeneity and help improve the resolution of cryo-EM reconstruction for macromolecules.</p>
    <p id="Par4">The conventional tool for resolving heterogeneity in cryo-EM datasets is 3D classification<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR6">6</xref></sup>, which models different conformations as individual 3D volumes. However, 3D classification scales poorly with respect to the number of conformations, and falls short of resolving structural dynamics composed of a large number of transitional conformations. Existing approaches such as multi-body refinement in RELION<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>, and 3D variability analysis in cryoSPARC<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> model continuous conformation changes using linear combinations of reaction coordinates. The multi-body refinement in RELION is particularly effective at modeling large-scale conformational dynamics of rigid-body components, yielding high-resolution structures for otherwise unresolved densities. It becomes less effective, however, for macromolecular systems in which dynamic structural components do not move as rigid bodies.</p>
    <p id="Par5">Recently, deep learning has emerged as a viable solution for handling structural heterogeneity. There are a number of deep learning approaches to probe structural heterogeneity, including Multi-CryoGAN<sup><xref ref-type="bibr" rid="CR9">9</xref></sup>, e2gmm<sup><xref ref-type="bibr" rid="CR10">10</xref></sup> and 3DFlex in cryoSPARC<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>. Multi-CryoGAN is based on a generative adversarial network and its validity has been demonstrated using synthetic data. E2gmm represents the 3D structure using a set of Gaussians, while 3DFlex uses a neural network to fit the 3D displacement field of each particle. By contrast, a neural network-based method, cryoDRGN, uses two-dimensional (2D) images as input, and the particle poses are determined by consensus refinement<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>. This method adopted a neural representation for 3D structures and leveraged a variational autoencoder (VAE)<sup><xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR14">14</xref></sup> to train the neural network that translates 2D images to 3D volumes end-to-end.</p>
    <p id="Par6">In the 2D image to 3D structure translation formulation as implemented in cryoDRGN<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, the landscape of 3D structures is in a low-dimension latent space. Translating a 2D image to a 3D structure is equivalent to mapping the 2D image to the encoding of its underlying 3D structure in latent space using neural networks. Both the encoding of the 2D image to latent code and the decoding of the latent code to a 3D structure are performed by neural networks. The continuous transformation between 2D image and 3D structure can then be learned end-to-end. Despite the use of neural networks, recovering the landscape of 3D structures using only 2D images is still inherently ill-posed, that is, the unknown 3D structures are of much higher dimensionality than the available 2D data. Furthermore, the pose parameters determined by consensus refinement are provided only for resolved densities.</p>
    <p id="Par7">The smoothness of latent space is critical for both resolving continuous structural heterogeneity and reliably recovering the distribution of conformations in cryo-EM datasets. A smooth latent space ensures that the neural network can generate continuous conformations when traversing the latent space, and guarantees the clustering of images with similar structures. Popular methods to encourage the smoothness of latent space are the VAE and its extensions, including β-VAE<sup><xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR14">14</xref></sup>, which apply variational Bayesian learning to the distribution of latent variables (more details can be found in ‘Training objectives’ subsection in <xref rid="Sec10" ref-type="sec">Methods</xref>).</p>
    <p id="Par8">In this study, we present a neural network-based method, OPUS deep structural disentanglement (OPUS-DSD), for 3D structural heterogeneity analysis. Built upon cryoDRGN 1.0 (ref. <sup><xref ref-type="bibr" rid="CR12">12</xref></sup>), OPUS-DSD incorporates a large number of methodological improvements, including the use of 3D convolutional architecture, that is, neural volumes<sup><xref ref-type="bibr" rid="CR15">15</xref>–<xref ref-type="bibr" rid="CR17">17</xref></sup>, and latent priors to encourage the smoothness of the latent space. By systematic testing on synthetic and real cryo-EM datasets, we demonstrate the performance of OPUS-DSD in resolving structural heterogeneity, even at lower signal-to-noise ratios. OPUS-DSD not only reconstructs the large-scale continuous dynamics, but also shows the associated compositional changes. By effectively reducing the level of structural heterogeneity in selected particles, OPUS-DSD also improves structural determination in cryo-EM SPA reconstructions.</p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>Design of OPUS-DSD</title>
      <p id="Par9">OPUS-DSD is designed to elucidate the structural heterogeneity in a cryo-EM dataset using 2D images as input. Overall, it contains two primary components: an encoder–decoder network to convert the 2D cryo-EM image to its corresponding 3D structure (solid red box in Fig. <xref rid="Fig1" ref-type="fig">1a</xref>), and a prior in latent space that facilitates the encoding of structural information in 2D images (dashed red box in Fig. <xref rid="Fig1" ref-type="fig">1a</xref>).<fig id="Fig1"><label>Fig. 1</label><caption><title>Architecture of OPUS-DSD.</title><p><bold>a</bold>, Schematic diagram of the architecture. Pose refers to the projection direction of input with respect to the consensus model. For simplicity, the standard Gaussian prior for latent distribution as well as the smoothness and sparseness priors for the 3D volume are omitted in this chart. <bold>b</bold>, Architecture of the encoder of OPUS-DSD. This diagram shows the encoder that translates a 2D cryo-EM image into the latent encoding. The top row denotes the dimensions of the intermediate tensors. The arrow links the input and output of the operation above. FC, fully connected layer; Conv3D, 3D convolution; ST, spatial transformer (which back-projects the 2D image to a 3D volume). The number of channels of the convolution kernel can be derived from the dimensions of its input and output. The ellipsis represents the repeating of the preceding operation until the tensor reaches the output dimension. All convolutions and fully connected layers except the last one had LeakyReLU<sup><xref ref-type="bibr" rid="CR33">33</xref></sup> (leaky rectified linear unit) non-linearity with a negative slope of 0.2. <bold>c</bold>, Architecture of the decoder of OPUS-DSD. This diagram shows the decoder that translates the latent encoding <italic>z</italic> into a reconstructed 2D projection. Conv3D<sup>T</sup>, 3D transposed convolution; ST, spatial transformer, which here renders the 3D volume into the 2D image of desired resolution. All transposed convolutions except the last one and fully connected layers have LeakyReLU non-linearity with a negative slope of 0.2.</p></caption><graphic xlink:href="41592_2023_2031_Fig1_HTML" id="d32e417"/></fig></p>
      <p id="Par10">The encoder–decoder network works as follows. The encoder takes a 2D cryo-EM image as input, and estimates the distribution of its associated latent code <italic>z</italic> in a low-dimension space <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathbb{R}}}^{d}$$\end{document}</tex-math><mml:math id="M2"><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq1.gif"/></alternatives></inline-formula>. The decoder then produces a 3D volume by sampling a latent code from the distribution estimated by the encoder (Fig. <xref rid="Fig1" ref-type="fig">1a</xref>). The latent code is assumed to follow a Gaussian distribution, for which the mean <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$z\in {{\mathbb{R}}}^{d}$$\end{document}</tex-math><mml:math id="M4"><mml:mrow><mml:mi>z</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq2.gif"/></alternatives></inline-formula> and standard variation <inline-formula id="IEq3"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\sigma \in {{\mathbb{R}}}^{d}$$\end{document}</tex-math><mml:math id="M6"><mml:mrow><mml:mi>σ</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>d</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq3.gif"/></alternatives></inline-formula> are estimated by the encoder<sup><xref ref-type="bibr" rid="CR14">14</xref></sup>. The 3D volume is represented as a discrete grid of voxels, <italic>V</italic>(<bold><italic>x</italic></bold>), where <inline-formula id="IEq4"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{x}}\in {{\mathbb{R}}}^{3}$$\end{document}</tex-math><mml:math id="M8"><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq4.gif"/></alternatives></inline-formula> is a point in 3D space. This explicit 3D voxel grid <italic>V</italic>(<bold><italic>x</italic></bold>) is then transformed into a 2D reconstruction with specified pose and contrast transfer function (CTF) parameters according to the differentiable cryo-EM image formation model. The neural architecture of OPUS-DSD can then be trained end-to-end by reconstructing each input image and minimizing the squared reconstruction error.</p>
      <p id="Par11">In addition, we incorporated a latent prior to promote a specific type of geometry in latent space (Fig. <xref rid="Fig1" ref-type="fig">1a</xref>). The structural heterogeneity is resolved within the encoder–decoder architecture of OPUS-DSD by integrating structural information into the latent space. That is, the variation of latent codes should primarily correspond to the variation in 3D structures. This kind of latent space specifies a geometry in which the similarity between 3D structures is proportional to the distance between their latent codes. In other words, the latent codes of similar 3D structures are clustered together, while the latent codes of distinct 3D structures are far apart. This not only ensures the smoothness of the latent space but also enhances the correlation between latent codes and structural variations. The formulation of this multi-component latent prior is detailed in <xref rid="Sec10" ref-type="sec">Methods</xref>. For a given latent code, the latent codes of similar 3D structures can be identified as its <italic>k</italic> nearest neighbors (kNN), whereas those of different 3D structures can be found as its <italic>k</italic> furthest points (kFP) (Fig. <xref rid="Fig1" ref-type="fig">1a</xref>). The latent prior is implemented by querying the kNN and kFP from a dynamically updated memory bank that stores the latent codes of all images. Furthermore, we implemented the reconstruction loss to guide the neural network to generate an ensemble of 3D structures congruent with the cryo-EM dataset. Concurrently, the latent prior refines the geometry of the latent space, providing a regularizing effect that enables the neural network to better capture the structural dynamics.</p>
      <p id="Par12">The encoder network converts the 2D input to latent vector <italic>z</italic> by going through a series of intermediate representations (shown as different shapes in Fig. <xref rid="Fig1" ref-type="fig">1b</xref>). The imputation of pose information to the 2D projection is performed by back-projection as follows. The 2D projection of size <italic>D</italic><sup>2</sup> (a square) is first converted into a pseudo 3D volume (first cube) by repeating along the <italic>z</italic> axis <italic>D</italic> times. Given that the pose of the pseudo 3D volume remains the same as the original 2D projection, a spatial transformer module<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> is introduced to transform the pseudo volume into the canonical pose, matching the consensus model. The spatial transformer enables neural networks to disentangle object pose from shape and texture in images, thereby realizing spatial invariance<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>. In OPUS-DSD, the spatial transformer aligns pseudo volumes with the consensus model by performing rotations using predetermined poses, thereby enabling different pseudo volumes with varying poses to be brought back to the same canonical pose, aiding the encoder to distinguish structural heterogeneities from pose variations. It is worth noting that the spatial transformer in this context is not trainable. Subsequently, the aligned pseudo 3D volume is down-sampled to a 1<sup>3</sup> cube with 512 channels using six consecutive strided convolutions<sup><xref ref-type="bibr" rid="CR16">16</xref></sup> with a kernel size of 4. Then the 1<sup>3</sup> cube with 512 channels is flattened into a 512-dimension vector (first rectangle) that is transformed into the distribution of latent code by estimating the mean <italic>z</italic> and standard deviation <italic>σ</italic> via the application of two fully connected layers with non-linearity.</p>
      <p id="Par13">To ensure the smoothness of the 3D density maps generated by the neural network and avoid overfitting<sup><xref ref-type="bibr" rid="CR3">3</xref>,<xref ref-type="bibr" rid="CR19">19</xref></sup>, the decoder in OPUS-DSD uses a convolutional architecture, neural volumes<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, that converts the latent vector to a smooth 3D volume (Fig. <xref rid="Fig1" ref-type="fig">1c</xref>). First, a series of fully connected layers with non-linearity are applied to transform the sampled latent vector (second rectangle) into a 2,048-dimensional representation, resulting in a 1<sup>3</sup> cube with 2,048 channels. Then the 2,048 × 1<sup>3</sup> cube is up-sampled into a 1 × 256<sup>3</sup> 3D volume (last cube) using eight consecutive transposed convolutions<sup><xref ref-type="bibr" rid="CR16">16</xref></sup>. The kernel size is 2 for the first two convolutions and 4 for the remaining convolutions. The 2D reconstruction (square) is generated from the 256<sup>3</sup> volume by the spatial transformer with predetermined pose and CTF parameters<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>. Although only the process to generate a 256<sup>3</sup> volume from a latent code is shown, the decoder can produce a 3D volume in any size by changing the intermediate tensors.</p>
      <p id="Par14">Given that OPUS-DSD is designed to improve on cryoDRGN 1.0 (ref. <sup><xref ref-type="bibr" rid="CR12">12</xref></sup>), the performance of these two methods is compared using synthetic and real datasets. For simplicity, cryoDRGN 1.0 is referred to as cryoDRGN hereafter.</p>
    </sec>
    <sec id="Sec4">
      <title>Pre-catalytic spliceosome</title>
      <p id="Par15">OPUS-DSD was used to analyze the structural heterogeneity of the pre-catalytic spliceosome (EMPIAR-10180, ref. <sup><xref ref-type="bibr" rid="CR20">20</xref></sup>) to enable direct comparison with other methods<sup><xref ref-type="bibr" rid="CR7">7</xref>,<xref ref-type="bibr" rid="CR10">10</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup>. We trained a 12-dimensional latent variable model using the consensus refinement results deposited in EMPIAR-10180. Uniform manifold approximation and projection (UMAP) visualization<sup><xref ref-type="bibr" rid="CR21">21</xref></sup> of the latent space of OPUS-DSD shows 20 classes using the Kmeans algorithm (Fig. <xref rid="Fig2" ref-type="fig">2a</xref>). By reconstructing the density maps using the cluster centers as input for the decoder of OPUS-DSD, those clusters were found to represent different combinations of spliceosome subcomplexes, namely core, foot, helicase and SF3b, as previously defined<sup><xref ref-type="bibr" rid="CR7">7</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2b</xref> and Extended Data Fig. <xref rid="Fig7" ref-type="fig">1a</xref>). For instance, class 12 represents the spliceosome with all four expected subcomplexes, class 10 shows a spliceosome with an additional U2 core<sup><xref ref-type="bibr" rid="CR22">22</xref></sup>, while class 18 has only the core and helicase, and class 14 lacks SF3b. Similar compositional heterogeneities were also detected by cryoDRGN<sup><xref ref-type="bibr" rid="CR12">12</xref></sup> but not by e2gmm<sup><xref ref-type="bibr" rid="CR10">10</xref></sup>. The densities for each of the four subcomplexes in these structures agreed very well with their ground-truth high-resolution structures obtained by multi-body refinement<sup><xref ref-type="bibr" rid="CR7">7</xref></sup> (Extended Data Fig. <xref rid="Fig7" ref-type="fig">1b</xref>). Furthermore, traversal along the first principal component (PC1) in principal component analysis (PCA) of the latent space showed distinct conformations. The structures at the two ends of PC1 correspond to two opposite conformations. The structure at the negative end of PC1 shows an ‘open’ conformation in which SF3b stays on the top of the core and the regions highlighted in the yellow ellipse and circle are far apart (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>). By contrast, the structure at the positive end of PC1 shows a ‘closed’ conformation in which SF3b is almost folded onto the core, the regions enclosed in the yellow ellipse and circle come together in space, and a chain appears in the yellow ellipses connecting helicase and SF3b. The emergence of this chain was not previously reported. Traversal along the PC1 in Supplementary Video <xref rid="MOESM4" ref-type="media">1</xref> shows the continuous dynamics between the open and closed conformations, highlighting the synchronous movements of the subcomplexes, that is, the helicase bends towards the foot while SF3b folds onto the core. Moreover, displacement of SF3b between these two conformations was observed (Fig. <xref rid="Fig2" ref-type="fig">2c</xref>, green arrows).<fig id="Fig2"><label>Fig. 2</label><caption><title>Heterogeneity analysis on the pre-catalytic spliceosome (EMPIAR-10180).</title><p><bold>a</bold>, UMAP visualization of the 12-dimensional latent space of all particles encoded by OPUS-DSD. Solid black dots represent the cluster centers for labeled classes. <bold>b</bold>, Conformations with major compositional heterogeneities determined using OPUS-DSD. The density maps were generated by the decoder of OPUS-DSD with the corresponding class centers shown in <bold>a</bold>. Class 12 is the expected structure of the pre-catalytic spliceosome, class 10 is a complete structure with the U2 core, class 18 only has the core, and class 14 lacks the SF3b subcomplex. <bold>c</bold>, Open and closed conformations of the spliceosome generated along the PC1 of the latent space. The open and closed conformations were generated at the PC1 with an amplitude of −1.1 and 1.0, respectively. The superposition shows the displacement of SF3b and helicase between these two conformations as indicated by the green arrows. The yellow dashed ellipses highlight the occupancy differences of a chain between helicase and SF3b in different conformations. The yellow dashed circles mark the domain in SF3b that connects to this chain. All maps were contoured at the same level and visualized using ChimeraX<sup><xref ref-type="bibr" rid="CR34">34</xref></sup>.</p></caption><graphic xlink:href="41592_2023_2031_Fig2_HTML" id="d32e717"/></fig></p>
    </sec>
    <sec id="Sec5">
      <title><italic>Plasmodium falciparum</italic> 80S ribosome</title>
      <p id="Par16">OPUS-DSD was used to analyze the structural heterogeneity of the <italic>Plasmodium falciparum</italic> 80S (<italic>Pf</italic>80S) ribosome (EMPIAR-10028, ref. <sup><xref ref-type="bibr" rid="CR23">23</xref></sup>), which was studied by cryoDRGN and multi-body refinement<sup><xref ref-type="bibr" rid="CR7">7</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup>. We trained a 12-dimensional latent variable model using the consensus refinement results from RELION 3.1. The UMAP visualization of the latent space of OPUS-DSD showed clusters with a greater degree of separation (Fig. <xref rid="Fig3" ref-type="fig">3a</xref>) than that of cryoDRGN<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>. Furthermore, we obtained 20 classes after Kmeans clustering in latent space and reconstructed their density maps by supplying the cluster centers to the decoder of OPUS-DSD. Classes 6, 7, 8, 9, 15 and 16 all harbor an RNA strand in the region highlighted by a red ellipse, which is absent in other classes (Fig. <xref rid="Fig3" ref-type="fig">3b</xref>). The existence of this heterogeneity was confirmed by comparing class 8 with the consensus model at a lower contour level (Extended Data Fig. <xref rid="Fig8" ref-type="fig">2</xref>), and was reported by cryoDRGN<sup><xref ref-type="bibr" rid="CR12">12</xref></sup> as well. Traversal along PC1 in the latent space uncovered distinct conformations and their interconnections (Supplementary Video <xref rid="MOESM5" ref-type="media">2</xref>). The structures at the positive or negative end of PC1 are denoted as the positive or negative conformations, respectively, with the red arrows indicating the relative displacement between them (Fig. <xref rid="Fig3" ref-type="fig">3c,d</xref>). Following the division of the <italic>Pf</italic>80S ribosome into three subunits, head, large subunit (LSU) and small subunit (SSU), in the published multi-body refinement<sup><xref ref-type="bibr" rid="CR7">7</xref></sup>, the two sides of the LSU move in opposite directions. In the positive conformation there is an RNA (marked by the yellow ellipse) connecting the SSU and LSU, which becomes absent in the negative conformation (Fig. <xref rid="Fig3" ref-type="fig">3c</xref>). A series of intermediate structures along the PC1 in Supplementary Video <xref rid="MOESM5" ref-type="media">2</xref> show how this RNA slides out of its original site in the SSU and docks onto the LSU. This kind of visualization is more difficult for multi-body analysis because it involves a series of small-scale occupancy changes during transition. In addition, at the back of the <italic>Pf</italic>80S ribosome a peripheral RNA strand gradually moves closer to its binding site on the LSU in the positive conformation and forms a new link (marked by the orange ellipse) with the LSU, while the head and LSU perform coordinated movements during this transition (Fig. <xref rid="Fig3" ref-type="fig">3d</xref> and Supplementary Video <xref rid="MOESM6" ref-type="media">3</xref>).<fig id="Fig3"><label>Fig. 3</label><caption><title>Heterogeneity analysis of the <italic>Pf</italic>80S ribosome (EMPIAR-10028).</title><p><bold>a</bold>, UMAP visualization of the 12-dimensional latent space of all particles encoded by OPUS-DSD. Solid black dots represent the cluster centers for labeled classes. <bold>b</bold>, Twenty density maps generated by the decoder of OPUS-DSD using the cluster centers shown in <bold>a</bold> as inputs. Red dashed ellipses highlight the presence of a peripheral RNA between SSU and LSU in the corresponding classes. <bold>c</bold>, Change in occupancy of an RNA according to conformation. The negative and positive conformations were generated at the PC1 with an amplitude of −1.4 and 1.8, respectively. Their superposition shows the displacement of different subunits as indicated by the red arrows. The yellow dashed ellipses highlight compositional differences of that RNA. <bold>d</bold>, Change in occupancy of a chain between a peripheral RNA and the LSU in the positive and negative conformations. The orange dashed ellipses highlight the compositional differences of that chain. Red arrows show the displacement of different subunits. All maps were contoured at the same level and visualized using ChimeraX.</p></caption><graphic xlink:href="41592_2023_2031_Fig3_HTML" id="d32e817"/></fig></p>
    </sec>
    <sec id="Sec6">
      <title><italic>Saccharomyces cerevisiae</italic> 80S ribosome</title>
      <p id="Par17">OPUS-DSD was used to analyze the structural heterogeneity of a smaller dataset of the <italic>Saccharomyces cerevisiae</italic> 80S (<italic>Sc</italic>80S) ribosome containing 60,363 images (EMPIAR-10002, ref. <sup><xref ref-type="bibr" rid="CR24">24</xref></sup>). We trained an eight-dimensional latent space model using 90% of images in this dataset. UMAP visualization of the latent space of OPUS-DSD and cryoDRGN showed similar clustering patterns (Fig. <xref rid="Fig4" ref-type="fig">4a</xref> and Extended Data Fig. <xref rid="Fig9" ref-type="fig">3a</xref>). However, OPUS-DSD uncovered many interesting structural heterogeneities. First, a single 60S class was identified (class 0 in Fig. <xref rid="Fig4" ref-type="fig">4b</xref>) uniquely by OPUS-DSD. Second, OPUS-DSD showed the movements of an RNA strand that binds with the 60S subunit (Fig. <xref rid="Fig4" ref-type="fig">4b</xref>, highlighted in red dashed boxes; Extended Data Fig. <xref rid="Fig10" ref-type="fig">4a</xref>). This movement can also be observed in Supplementary Video <xref rid="MOESM7" ref-type="media">4</xref> (which consists of a series of states along the PC1 of the latent space) and appears to be coordinated with the rotation of the 40S subunit. Traversal of the PC1 of the latent space in the cryoDRGN results also suggested this movement (Supplementary Video <xref rid="MOESM8" ref-type="media">5</xref>). Third, the red solid boxes in Fig. <xref rid="Fig4" ref-type="fig">4b</xref> mark two different binding locations of an RNA strand, which were not observed in the cryoDRGN results at this contour level (Extended Data Fig. <xref rid="Fig9" ref-type="fig">3b</xref>). Last, OPUS-DSD showed the large-scale displacement of the 40S subunit between different classes (Fig. <xref rid="Fig4" ref-type="fig">4c</xref>, Extended Data Fig. <xref rid="Fig10" ref-type="fig">4b</xref> and Supplementary Video <xref rid="MOESM7" ref-type="media">4</xref>). At the same contour level, the density map of class 9 reconstructed by the trained decoder of OPUS-DSD showed a much more complete 40S subunit than the consensus model by RELION using all particles (Fig. <xref rid="Fig4" ref-type="fig">4d</xref>), which also confirmed the high mobility of this region. The density map from class 8 by cryoDRGN also partially recovered the missing densities of the 40S subunit (Extended Data Fig. <xref rid="Fig9" ref-type="fig">3c</xref>, red ellipses) when contoured at the same level.<fig id="Fig4"><label>Fig. 4</label><caption><title>Heterogeneity analysis of the <italic>Sc</italic>80S ribosome (EMPIAR: 10002).</title><p><bold>a</bold>, UMAP visualization of the eight-dimensional latent space of all particles encoded by OPUS-DSD. Solid black dots represent the cluster centers for labeled classes. <bold>b</bold>, Sixteen density maps reconstructed by the decoder of OPUS-DSD using the Kmeans clustering centers in its eight-dimensional latent space as inputs. The different locations of two RNA strands in different conformations are highlighted by the red solid and dashed boxes, respectively. <bold>c</bold>, Superimposition of class 1 and class 6 to show the displacement of 40S subunits highlighted in the red dashed boxes. Red arrows indicate the displacement directions. 60S is highlighted in a green dashed ellipse. <bold>d</bold>, The density map of class 9 is more complete than that reconstructed using all particles. Both maps are contoured at the same level and visualized by ChimeraX.</p></caption><graphic xlink:href="41592_2023_2031_Fig4_HTML" id="d32e904"/></fig></p>
    </sec>
    <sec id="Sec7">
      <title>Synthetic NEXT complex data</title>
      <p id="Par18">OPUS-DSD was further tested on the synthetic data of the nuclear exosome-targeting (NEXT) complex, a highly mobile system. The NEXT complex has a dumbbell shape, in which two MTR4 helicase domains<sup><xref ref-type="bibr" rid="CR25">25</xref></sup> located at the two ends are connected by a ZCCHC8 center formed by two stranded helices. Starting from the structure of the NEXT complex determined in our own group (Fig. <xref rid="Fig5" ref-type="fig">5a</xref> and Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref>), eight different conformations were generated by shifting the MTR4 helicase domains relative to the ZCCHC8 center (Fig. <xref rid="Fig5" ref-type="fig">5b</xref>). The synthetic data were constructed with a uniform distribution of the eight different conformations, that is, each conformation has 8,000 particles. The synthetic NEXT complex dataset with 64,000 particles yielded a consensus model using cryoSPARC (Fig. <xref rid="Fig5" ref-type="fig">5c</xref>).<fig id="Fig5"><label>Fig. 5</label><caption><title>Heterogeneity analysis of the synthetic dataset of the NEXT complex with a signal-to-noise ratio of 0.05.</title><p><bold>a</bold>, The starting atomic model of the NEXT complex. <bold>b</bold>, The ground-truth density maps of the NEXT complex. Of the eight conformations, conformations <italic>a</italic>,<italic>d</italic>,<italic>e</italic> are similar and difficult to distinguish, and conformations <italic>f</italic>,<italic>g</italic>,<italic>h</italic> have larger shifts in the MTR domains. <bold>c</bold>, The consensus map reconstructed by cryoSPARC. <bold>d</bold>, UMAP visualization of the eight-dimensional latent space of all particles encoded by OPUS-DSD and cryoDRGN. Solid black dots represent the cluster centers for labeled classes, identified using the Kmeans algorithm. <bold>e</bold>, The distribution of particles in the clusters in the latent space of OPUS-DSD. Bars are colored as the ground-truth density maps in <bold>b</bold>. Entropy is defined as the average of <inline-formula id="IEq5"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$-{\sum }_{i}{p}_{i}\log {p}_{i}$$\end{document}</tex-math><mml:math id="M10"><mml:mrow><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mi>log</mml:mi><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq5.gif"/></alternatives></inline-formula> for each cluster, where <inline-formula id="IEq6"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${p}_{i}=\frac{{n}_{i}}{{\sum }_{i}{n}_{i}}$$\end{document}</tex-math><mml:math id="M12"><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq6.gif"/></alternatives></inline-formula>, and <italic>n</italic><sub><italic>i</italic></sub> is the number of particles in the ground-truth conformation <italic>i</italic>. <bold>f</bold>, The distribution of particles in the clusters in the latent space of cryoDRGN. <bold>g</bold>, Translation–rotation plot for the upper MTR4 domain for results from both methods. <bold>h</bold>, Translation–rotation plot for the lower MTR4 domain for results from both methods. The movements were measured for the upper (<bold>g</bold>) or lower (<bold>h</bold>) MTR4 domains relative to the ZCCHC8 of each conformation using Dyndom<sup><xref ref-type="bibr" rid="CR35">35</xref></sup> with the ground-truth conformation <italic>d</italic> as a reference.</p><p><xref rid="MOESM9" ref-type="media">Source data</xref></p></caption><graphic xlink:href="41592_2023_2031_Fig5_HTML" id="d32e1088"/></fig></p>
      <p id="Par19">When the signal-to-noise ratio was 0.05, OPUS-DSD and cryoDRGN differed significantly in the clustering results and 3D density maps (Fig. <xref rid="Fig5" ref-type="fig">5d</xref>). In the UMAP visualization of latent space, clusters of OPUS-DSD were better separated than those of cryoDRGN (Fig. <xref rid="Fig5" ref-type="fig">5d</xref>). Judging by the quality of the density map generated by the decoders of both methods, OPUS-DSD delivered better density maps with resolutions similar to that of the consensus model (Extended Data Fig. <xref rid="Fig11" ref-type="fig">5a</xref>), while cryoDRGN produced density maps with very low-resolution MTR domains and noise in the ZCCHC8 center (Extended Data Fig. <xref rid="Fig11" ref-type="fig">5b</xref>). OPUS-DSD identified some clusters with high accuracy (Fig. <xref rid="Fig5" ref-type="fig">5e</xref>). For example, class 1 recovered approximately 67% of particles belonging to conformation <italic>f</italic> (Fig. <xref rid="Fig5" ref-type="fig">5e</xref>), and the 3D reconstruction using class 1 also resembled conformation <italic>f</italic> (Extended Data Fig. <xref rid="Fig11" ref-type="fig">5c</xref>). In contrast, cryoDRGN yielded a more even distribution of the particles with high classification errors in all classes (Fig. <xref rid="Fig5" ref-type="fig">5f</xref>), even for class 7 with the highest dominating conformation, only 28% of particles were from conformation <italic>f</italic>. Using entropy as a metric, the average entropy value for clusters in OPUS-DSD (at 0.756) was lower than that for cryoDRGN (at 0.882), where the entropy of a uniform distribution of conformations was 0.903. Comparing the density maps generated by cryoSPARC using classes from either method, the maps from OPUS-DSD were generally of higher quality than those from cryoDRGN (Extended Data Fig. <xref rid="Fig11" ref-type="fig">5c,d</xref>). In translation–rotation plots, the classes from cryoDRGN showed little difference and the rotations of MTR4 relative to ZCCHC8 were clustered within 10° (Fig. <xref rid="Fig5" ref-type="fig">5g,h</xref>, blue dots). The results of OPUS-DSD, however, showed a much wider range of structural changes (Fig. <xref rid="Fig5" ref-type="fig">5g,h</xref>, red dots), agreeing with the structural changes in ground-truth conformations (Fig. <xref rid="Fig5" ref-type="fig">5g,h</xref>, green dots). For example, the translations and rotations of MTR4 in class 1 of OPUS-DSD closely resembled conformation <italic>f</italic>, while classes 3 and 5 closely resembled conformations <italic>g</italic> and <italic>b</italic>, respectively (Fig. <xref rid="Fig5" ref-type="fig">5g,h</xref>). Hence, OPUS-DSD clearly recovered more ground-truth structural heterogeneities in this case. Furthermore, the average resolution of density maps reconstructed by classes from OPUS-DSD was also higher, suggesting its improved classification accuracy (Extended Data Fig. <xref rid="Fig11" ref-type="fig">5c,d</xref>).</p>
      <p id="Par20">When the signal-to-noise ratio increases to 0.1, both methods performed similarly and recovered most ground-truth conformations (Extended Data Fig. <xref rid="Fig12" ref-type="fig">6</xref>). However, there were still noticeable differences between the 3D density maps from their decoders (Extended Data Fig. <xref rid="Fig12" ref-type="fig">6g,h</xref>). The density maps from OPUS-DSD (Extended Data Fig. <xref rid="Fig12" ref-type="fig">6g</xref>) had a similar resolution to the consensus model across the entire complex. In contrast, the density maps from cryoDRGN were of a higher resolution than the consensus model for the central ZCCHC8 domain but a lower resolution for the MTR domains, especially in classes with larger shifts (Extended Data Fig. <xref rid="Fig12" ref-type="fig">6h</xref>).</p>
      <p id="Par21">The synthetic data of the NEXT complex also provided an ideal test for assessing the contributions of some of the methodological designs in OPUS-DSD. At a signal-to-noise ratio of 0.05, we found that turning off the disentanglement prior tended to reduce the classification accuracy of clustering results, most significantly for classes 1, 2, 3, 5 and 7 (Extended Data Fig. <xref rid="Fig13" ref-type="fig">7a,b</xref>). Similar behaviors were observed when turning off data augmentation, where the classification accuracy decreased in the latent space of OPUS-DSD, most significantly for classes 2, 3, 5, 6, and 7 (Extended Data Fig. <xref rid="Fig13" ref-type="fig">7a,c</xref>). In addition, the presence of data augmentation decreased the validation error and improved the generalization on the <italic>Sc</italic>80S ribosome (Extended Data Fig. <xref rid="Fig13" ref-type="fig">7d,e</xref>).</p>
    </sec>
    <sec id="Sec8">
      <title>Real cryo-EM data of the NEXT complex</title>
      <p id="Par22">Next, OPUS-DSD was tested on experimental data of the NEXT complex collected in our own group, which contained 224,354 particles after multiple rounds of 2D and 3D classifications (Supplementary Table <xref rid="MOESM1" ref-type="media">1</xref> and Supplementary Fig. <xref rid="MOESM1" ref-type="media">1</xref>). Given that the complete NEXT complex is too dynamic to be determined to high resolution, signals of one MTR4 helicase domain were subtracted by RELION to facilitate cryo-EM SPA reconstruction<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>. Consensus refinement using the 224,354 particles of the NEXT complex produced a resolution of 5.59 Å measured using the gold-standard Fourier shell correlation (FSC) curve at 0.143 (ref. <sup><xref ref-type="bibr" rid="CR27">27</xref></sup>) (Fig. <xref rid="Fig6" ref-type="fig">6a</xref>). OPUS-DSD and cryoDRGN were used to analyze the structural heterogeneity by learning a latent space with the consensus refinement result (Fig. <xref rid="Fig6" ref-type="fig">6a</xref>).<fig id="Fig6"><label>Fig. 6</label><caption><title>Heterogeneity analysis of 224,354 particles of the NEXT complex.</title><p><bold>a</bold>, Starting consensus model and its gold-standard FSCs for all particles. The dashed horizontal line denotes FSC = 0.143. <bold>b</bold>, UMAP visualization of the latent space learned by OPUS-DSD and cryoDRGN. Solid black dots represent the cluster centers for labeled classes, identified using the Kmeans algorithm. <bold>c</bold>, Ten classes reconstructed by OPUS-DSD at points shown in <bold>b</bold> and the corresponding number of particles in each class. There were seven classes with complete densities on the right-hand side of the UMAP (classes 3–9), and three classes with incomplete densities on the left-hand side of the UMAP (classes 0–2). <bold>d</bold>, Ten classes reconstructed by cryoDRGN at points shown in <bold>b</bold> and the corresponding number of particles in each class. <bold>e</bold>, Translation–rotation plot for reconstructions from OPUS-DSD. The movement was measured for the MTR4 domain relative to the ZCCHC8 domain of each conformation by Dyndom using the consensus model as a reference. <bold>f</bold>, Density map and gold-standard FSCs for 116,712 particles by combining the OPUS-DSD clusters that had small structural variations (grouped by the red circle in <bold>e</bold>). <bold>g</bold>, Translation–rotation plot for reconstructions from cryoDRGN. <bold>h</bold>, Density map and gold-standard FSCs for 200,154 particles by combining the cryoDRGN clusters that had small structural variations (grouped by the blue circle in <bold>g</bold>). The dashed horizontal line in <bold>f</bold> and <bold>h</bold> denotes FSC = 0.143.</p><p><xref rid="MOESM9" ref-type="media">Source data</xref></p></caption><graphic xlink:href="41592_2023_2031_Fig6_HTML" id="d32e1264"/></fig></p>
      <p id="Par23">For OPUS-DSD, the UMAP for the latent space of all particles had a bipolar distribution (Fig. <xref rid="Fig6" ref-type="fig">6b</xref>). Classes 0, 1 and 2 on the left side of the UMAP correspond to reconstructions in which NEXT complex densities were not complete, while classes 3–9 on the right side of the UMAP correspond to reconstructions in which NEXT complex densities were complete (Fig. <xref rid="Fig6" ref-type="fig">6c</xref>). In the translation–rotation plot, five reconstructions from OPUS-DSD were within 2° of rotation and 1 Å of translation, forming a cluster of 116,712 particles, while another two classes had a much larger extent of motion at rotations of 3° and 6° (classes 9 and 5, respectively) (Fig. <xref rid="Fig6" ref-type="fig">6e</xref>). Non-uniform refinement<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> using the 116,712 particles improved the resolution of the reconstruction from 5.59 Å to 4.45 Å (Fig. <xref rid="Fig6" ref-type="fig">6f</xref> and Extended Data Fig. <xref rid="Fig14" ref-type="fig">8a</xref>). In comparison, using cryoDRGN on the same dataset (Fig. <xref rid="Fig6" ref-type="fig">6b</xref>) resulted in reconstructions that all had complete NEXT complex densities (Fig. <xref rid="Fig6" ref-type="fig">6d</xref>). In the translation–rotation plot, one reconstruction had a large rotation and translation (class 9, ~4° and ~3 Å, respectively) while the remaining nine reconstructions (classes 0–8) were clustered within 2° of rotation and 1 Å of translation (Fig. <xref rid="Fig6" ref-type="fig">6g</xref>). The 200,154 particles from these nine classes (blue circle) yielded a reconstruction with a resolution of 6.12 Å in non-uniform refinement (Fig. <xref rid="Fig6" ref-type="fig">6h</xref> and Extended Data Fig. <xref rid="Fig14" ref-type="fig">8b</xref>).</p>
      <p id="Par24">We also performed focused refinement on the ZCCHC8 dimeric center, leaving the pose parameter of MTR4 helicase undetermined (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9a</xref>). The UMAP for the latent space from OPUS-DSD was bipolar (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9b</xref>), in which classes 0–4 on the left side of UMAP correspond to complete complexes, whereas classes 5–9 on the right side of UMAP represent incomplete complexes (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9c</xref>). By contrast, the UMAP from cryoDRGN was circular (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9b</xref>), and nine out of 10 reconstructions showed complete densities with even particle distributions (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9d</xref>). The translation–rotation plots from both methods (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9e,g</xref>) showed a larger range of motion than previous analysis in Fig. <xref rid="Fig6" ref-type="fig">6</xref>. Classes with a small range of motion were then combined for further refinement. For OPUS-DSD, three classes with a rotation of approximately 5° (classes 2–4; 85,570 particles) were selected (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9e</xref>), which yielded a resolution of 4.52 Å (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9f,i</xref>). For cryoDRGN, four classes with rotations within 5° (classes 0, 4, 5 and 7; 96,466 particles) were selected for refinement (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9g</xref>), which resulted in a reconstruction with a resolution of 5.60 Å (Extended Data Fig. <xref rid="Fig15" ref-type="fig">9h,j</xref>), on par with the consensus refinement (resolution of 5.59 Å) using the entire set of 224,354 particles (Fig. <xref rid="Fig6" ref-type="fig">6a</xref>).</p>
      <p id="Par25">It is worth noting that in the case of the NEXT complex with focused refinement, both cryoDRGN and OPUS-DSD showed the large-scale movements of MTR4 relative to ZCCHC8. The fact that cryoDRGN achieved a higher resolution in focused refinement suggests that its ability to resolve structural heterogeneity may be influenced by the degree of heterogeneity in a dataset.</p>
      <p id="Par26">We next tested a smaller dataset of 84,530 particles of the NEXT complex, which was obtained by applying several rounds of heterogenous refinements in cryoSPARC, with the best resolution of 4.39 Å (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10a</xref>). This scenario represents the stage after conventional classification is converged.</p>
      <p id="Par27">In UMAP visualization, classes 0, 1 and 3 from OPUS-DSD were separated from classes 2 and 4 (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10b</xref>). Classes 0, 1 and 3 all had complete density of the NEXT complex, while classes 2 and 4 were incomplete (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10c</xref>). The particles in classes 0, 1 and 3 (63,368 particles in total) yielded a resolution of 4.48 Å (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10e</xref>). Although the resolution does not improve, the average <italic>B</italic> factor decreased from 121 Å<sup>2</sup> to 109 Å<sup>2</sup>, suggesting a somewhat overall improvement in map quality (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10e</xref>). In contrast, the classes from cryoDRGN exhibited a more uniform distribution in UMAP (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10b</xref>) and similar reconstructions (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10d</xref>). Non-uniform refinement on classes 1–4 (68,879 particles) from cryoDRGN resulted in a resolution of 5.58 Å and <italic>B</italic> factor of 291 Å<sup>2</sup> (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10f</xref>). As a baseline comparison, reconstructions using four sets of particles in which ~25% of particles were randomly discarded yielded resolutions of 5.60–6.35 Å (Extended Data Fig. <xref rid="Fig16" ref-type="fig">10g</xref>).</p>
      <p id="Par28">The test on the 84,530 particles of the NEXT complex shows that OPUS-DSD can still detect real heterogeneity in the dataset at the stage where conventional classification has been converged.</p>
    </sec>
  </sec>
  <sec id="Sec9" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par29">Built upon the PyTorch version of cryo-EM data processing utilities provided by cryoDRGN 1.0, OPUS-DSD introduces a set of methodological improvements aiming to effectively and reliably capture structural heterogeneities.</p>
    <p id="Par30">One critical component of OPUS-DSD is the 3D convolutional neural network with translational equivariance. Consensus 3D refinement can determine only the well-ordered portions of a macromolecule to high resolution, while averaging out the densities of flexible parts across space as exemplified by the pre-catalytic spliceosome (Extended Data Fig. <xref rid="Fig8" ref-type="fig">2</xref>). Hence, the pose parameters of well-ordered structural elements in each image are better determined than those of flexible structural elements. If the unresolved mobile elements undergo rigid-body movements, the problem of resolving structural heterogeneity can be simplified as multi-body refinement<sup><xref ref-type="bibr" rid="CR7">7</xref></sup> in which the pose parameters of dynamic elements are determined in relation to the well-ordered structures. By contrast, neural networks can resolve structural heterogeneity end-to-end by reconstructing the underlying conformations directly from an image without prior knowledge. To accomplish this, the neural network needs to be equivariant to variations of objects in input. Specifically, for a neural network that is equivariant to translation, any amount of shift of an object in input results in the same degree of shift of the same object in output. Convolutional neural networks are well-known for translational equivariance<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>, which contributes critically to the effectiveness of OPUS-DSD in modeling structural heterogeneity using consensus refinement results. In contrast, cryoDRGN leverages a different mechanism by operating in reciprocal space, that is, using the Fourier shift theorem, in which shifting a function by Δ in real space results in a multiplication of the Fourier transform of that function by <inline-formula id="IEq7"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${e}^{-i2\pi \Delta s}$$\end{document}</tex-math><mml:math id="M14"><mml:msup><mml:mrow><mml:mi>e</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mi>i</mml:mi><mml:mn>2</mml:mn><mml:mi>π</mml:mi><mml:mi mathvariant="normal">Δ</mml:mi><mml:mi>s</mml:mi></mml:mrow></mml:msup></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq7.gif"/></alternatives></inline-formula> in reciprocal space. Consequently, a local change in real space causes a global change to every voxel in reciprocal space. Therefore, cryoDRGN needs to approximate the change in every voxel in reciprocal space to high precision to reliably capture the structural heterogeneity.</p>
    <p id="Par31">By contrast, cryo-EM images contain high levels of noise. Even for the well-resolved structures in a complex determined by consensus refinement, their projection poses estimated by consensus refinement could still contain significant errors. These errors could compromise the quality of the 3D density map reconstructed by the neural network. To overcome this, OPUS-DSD leverages real-space 3D volume as an intermediate representation<sup><xref ref-type="bibr" rid="CR16">16</xref>,<xref ref-type="bibr" rid="CR17">17</xref></sup>. This representation enables fast sampling of different projections near the given direction without revaluating the decoder. This set-up enables OPUS-DSD to incorporate a reconstruction loss in which an experimental image is compared with an ensemble of projections at its estimated pose determined from consensus refinement and neighboring poses. Conceptually similar to the local angle search in RELION<sup><xref ref-type="bibr" rid="CR30">30</xref></sup>, the inclusion of this loss increases the robustness of OPUS-DSD to errors in pose parameters. In addition, the quality of the 3D volume representation is improved by encouraging its smoothness and sparseness via traditional regularizers such as total variation and LASSO<sup><xref ref-type="bibr" rid="CR19">19</xref>,<xref ref-type="bibr" rid="CR31">31</xref>,<xref ref-type="bibr" rid="CR32">32</xref></sup>, which are integrated into the training objective function of OPUS-DSD.</p>
    <p id="Par32">Despite these methodological improvements, training a neural network to reconstruct 3D dynamic objects using only 2D images remains challenging. The most formidable challenge comes from the inherent ill-posedness of the 2D to 3D translation, in which the encoder must disentangle the 3D structural information from other non-structural factors in 2D cryo-EM images. To this end, OPUS-DSD uses a multifaceted approach. The ill-posedness is first mitigated by reducing the pose variations in the input distribution through a back-projection step, in which the input is aligned with the same reference frame as the consensus model, which assists the encoder to disentangle structural heterogeneity from pose variations in 2D images. The ill-posedness is further alleviated by encouraging the smoothness of the latent space with respect to structural variations so that similar 3D structures are encoded by similar latent codes. By encouraging the smoothness of the latent space, the number of training samples available for the decoder at any meaningful latent code increases, ultimately improving the quality of the 3D density map reconstructed by the decoder. In OPUS-DSD, the smoothness of the latent space is encouraged by β-VAE as in cryoDRGN<sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR13">13</xref></sup>, and additionally by a multi-component latent prior that facilitates the clustering of images with similar structures in latent space. Furthermore, data augmentation is implemented in OPUS-DSD to reduce its sensitivity to contrast variations in 2D images.</p>
    <p id="Par33">We expect OPUS-DSD to facilitate structural determination and analysis of macromolecular complexes with unresolved structural elements due to high mobility, regardless of whether the mobile elements undergo rigid-body movements or not. Moreover, the end-to-end neural network-based approaches such as cryoDRGN and OPUS-DSD require no prior knowledge about the division of subcomplexes and can automatically reconstruct them and the corresponding dynamics. This enables the reconstruction of synchronous movement among different subcomplexes. One trade-off of this approach is that the resolution of reconstructed subcomplexes is not as high as in multi-body refinement. Additionally, due to the 3D volume representation in real space, OPUS-DSD has a somewhat higher computational cost than cryoDRGN, which only needs to output a 2D slice in the Fourier domain during training. By contrast, OPUS-DSD is able to output a 3D volume much faster in one pass during inference time, while cryoDRGN needs to evaluate the 3D volume voxel by voxel.</p>
  </sec>
  <sec id="Sec10">
    <title>Methods</title>
    <sec id="Sec11">
      <title>Notation</title>
      <p id="Par34">The notation used in this paper is as follows. <italic>V</italic> represents the 3D structure. <italic>X</italic> represents the 2D projection of the 3D structure. For a vector <inline-formula id="IEq8"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\boldsymbol{x}}\in {{\mathbb{R}}}^{N}$$\end{document}</tex-math><mml:math id="M16"><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq8.gif"/></alternatives></inline-formula>, <inline-formula id="IEq9"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{||}{\boldsymbol{x}}{||}}^{2}={\sum }_{i}{{\boldsymbol{x}}}_{i}^{2}$$\end{document}</tex-math><mml:math id="M18"><mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="italic">||</mml:mi><mml:mi mathvariant="bold-italic">x</mml:mi><mml:mi mathvariant="italic">||</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq9.gif"/></alternatives></inline-formula> is the sum of squares of the vector <bold><italic>x</italic></bold>. <inline-formula id="IEq10"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{||}{\boldsymbol{x}}{||}}_{2}=\sqrt{{\sum }_{i}{{\boldsymbol{x}}}_{i}^{2}}$$\end{document}</tex-math><mml:math id="M20"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="italic">||</mml:mi><mml:mi mathvariant="bold-italic">x</mml:mi><mml:mi mathvariant="italic">||</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msqrt><mml:mrow><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:mrow></mml:mrow></mml:msqrt></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq10.gif"/></alternatives></inline-formula> represents the <italic>l</italic><sub>2</sub> norm of the vector <bold><italic>x</italic></bold>. <inline-formula id="IEq11"><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{||}{\boldsymbol{x}}{||}}_{1}={\sum }_{i}|{{\boldsymbol{x}}}_{i}|$$\end{document}</tex-math><mml:math id="M22"><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="italic">||</mml:mi><mml:mi mathvariant="bold-italic">x</mml:mi><mml:mi mathvariant="italic">||</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mi>|</mml:mi><mml:msub><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mi>|</mml:mi></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq11.gif"/></alternatives></inline-formula> represents the <italic>l</italic><sub>1</sub> norm of the vector <bold><italic>x</italic></bold>. ∙<sup><italic>T</italic></sup> represents the transpose of a matrix. Var represents the variance of a random variable. SO(3) represents the 3D rotation group.</p>
    </sec>
    <sec id="Sec12">
      <title>Image formation model</title>
      <p id="Par35">The image formation model of cryo-EM is typically defined in the frequency domain. Given that the images collected in cryo-EM are 2D projections of a 3D molecular structure, their Fourier transform has the following relationship with the Fourier transform of the 3D molecular structure according to the projection-slice theorem. Let the 3D molecular structure be <italic>V</italic>, and its Fourier transform be <inline-formula id="IEq12"><alternatives><tex-math id="M23">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathcal{V}}$$\end{document}</tex-math><mml:math id="M24"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">V</mml:mi></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq12.gif"/></alternatives></inline-formula>. Assume an <italic>N</italic><sup>2</sup> image <italic>X</italic> is formed by rotating an <italic>N</italic><sup>3</sup> 3D volume <italic>V</italic> with the Euler angle set, <italic>ϕ</italic>, and projecting along the <italic>z</italic> axis; using the projection-slice theorem, the Fourier transform of the image <inline-formula id="IEq13"><alternatives><tex-math id="M25">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathcal{X}}$$\end{document}</tex-math><mml:math id="M26"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">X</mml:mi></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq13.gif"/></alternatives></inline-formula> can be expressed as<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M27">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathcal{X}}}_{(h,k)}={{\rm{CTF}}}_{h,k}\mathop{\sum }\limits_{h{\prime} =1}^{N}\mathop{\sum }\limits_{k{\prime} =1}^{N}\mathop{\sum }\limits_{l{\prime} =1}^{N}{P}_{h{\prime} k{\prime} l{\prime} }^{h,k}(\phi ){{\mathcal{V}}}_{h{\prime} k{\prime} l{\prime} }+{\in }_{h,k},$$\end{document}</tex-math><mml:math id="M28"><mml:mrow><mml:msub><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="normal">CTF</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>′</mml:mo><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:mo>′</mml:mo><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>l</mml:mi><mml:mo>′</mml:mo><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:msubsup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>′</mml:mo><mml:mi>k</mml:mi><mml:mo>′</mml:mo><mml:mi>l</mml:mi><mml:mo>′</mml:mo></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msubsup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:msub><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="script">V</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>′</mml:mo><mml:mi>k</mml:mi><mml:mo>′</mml:mo><mml:mi>l</mml:mi><mml:mo>′</mml:mo></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mo>∈</mml:mo></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula>where <inline-formula id="IEq14"><alternatives><tex-math id="M29">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathcal{X}}}_{h,k}$$\end{document}</tex-math><mml:math id="M30"><mml:msub><mml:mrow><mml:mi class="MJX-tex-caligraphic" mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq14.gif"/></alternatives></inline-formula> is a component of the Fourier transform of the image <italic>X</italic> with the spatial frequency vector [<italic>h</italic>,<italic>k</italic>], CTF<sub><italic>h,k</italic></sub> is a component of the CTF (ref. <sup><xref ref-type="bibr" rid="CR36">36</xref></sup>), <inline-formula id="IEq15"><alternatives><tex-math id="M31">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${P}_{h{\prime} k{\prime} l{\prime} }^{h,k}(\phi )$$\end{document}</tex-math><mml:math id="M32"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>′</mml:mo><mml:mi>k</mml:mi><mml:mo>′</mml:mo><mml:mi>l</mml:mi><mml:mo>′</mml:mo></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msubsup><mml:mo>(</mml:mo><mml:mi>ϕ</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq15.gif"/></alternatives></inline-formula> is the slice operator that slices a plane in the 3D Fourier transform <inline-formula id="IEq16"><alternatives><tex-math id="M33">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathcal{V}}$$\end{document}</tex-math><mml:math id="M34"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">V</mml:mi></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq16.gif"/></alternatives></inline-formula> according to the Euler angle set <italic>ϕ</italic>, and <italic>ϵ</italic><sub><italic>h,k</italic></sub> is the noise that corrupts the projection. The 2D image <italic>X</italic> can further undergo a set of 2D rigid transformations such as rotation and translation in the projection plane, which, however, are omitted in our discussions because they can be easily corrected using known pose parameters.</p>
      <p id="Par36">We elaborate on the slice operator <italic>P</italic><sup><italic>ϕ</italic></sup> by giving its formal definition. Let the index of a voxel in the 3D Fourier transform <inline-formula id="IEq17"><alternatives><tex-math id="M35">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathcal{V}}$$\end{document}</tex-math><mml:math id="M36"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">V</mml:mi></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq17.gif"/></alternatives></inline-formula> be [<italic>h</italic>′,<italic>k</italic>′,<italic>l</italic>′], and the index of the corresponding pixel of the Fourier transform of the image is [<italic>h</italic>,<italic>k</italic>]; the slice operator <italic>P</italic><sup><italic>ϕ</italic></sup> transforms the 3D index to a 2D index by the following equation:<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M37">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left({\begin{array}{c}h\\k\\ 0\end{array}}\right)={R}_{\phi }^{T}\left({\begin{array}{c}{{h}^{{\prime} }}\\{k}^{{\prime} }\\ {l}^{{\prime} }\end{array}}\right),$$\end{document}</tex-math><mml:math id="M38"><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:mi>h</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>k</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mn>0</mml:mn></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:msubsup><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msubsup><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi>h</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:msup><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula>where <italic>R</italic><sub><italic>ϕ</italic></sub> is a rotation matrix parameterized by the Euler angle set <italic>ϕ</italic>. The counterpart of the slice operator in real space is the projection operator. Let <italic>V</italic> be the template volume, and <italic>V</italic>′ be the volume rotated by the Euler angle set <italic>ϕ</italic>; the projection operator rotates the 3D template volume by the following equation:<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M39">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$V{\prime} \left(\left({\begin{array}{c}{x}\\y\\ z\end{array}}\right)\right)=V\left({R}_{\phi }^{T}\left({\begin{array}{c}{x}\\y\\ z\end{array}}\right)\right).$$\end{document}</tex-math><mml:math id="M40"><mml:mrow><mml:mi>V</mml:mi><mml:mo>′</mml:mo><mml:mfenced close=")" open="("><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:mi>x</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>y</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>z</mml:mi></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mi>V</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mrow><mml:mi>R</mml:mi></mml:mrow><mml:mrow><mml:mi>ϕ</mml:mi></mml:mrow><mml:mrow><mml:mi>T</mml:mi></mml:mrow></mml:msubsup><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:mi>x</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>y</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>z</mml:mi></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:mrow></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par37">The projection operator then generates the 2D projection <italic>X</italic> by summing along the <italic>z</italic> axis of the rotated volume <italic>V</italic>′:<disp-formula id="Equ4"><label>4</label><alternatives><tex-math id="M41">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$X\left(\left(\begin{array}{c}{x}\\{y}\end{array}\right)\right)=\mathop{\sum }\limits_{z=1}^{N}{V}^{{\prime} }\left(\left({\begin{array}{c}{x}\\y\\ z\end{array}}\right)\right).$$\end{document}</tex-math><mml:math id="M42"><mml:mrow><mml:mi>X</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:mi>x</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>y</mml:mi></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>z</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:msup><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mfenced close=")" open="("><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mtable><mml:mtr><mml:mtd columnalign="center"><mml:mi>x</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>y</mml:mi></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="center"><mml:mi>z</mml:mi></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>.</mml:mo></mml:mrow></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ4.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par38">In summary, the real-space 3D volume in OPUS-DSD undergoes a rotation in 3D and 2D rigid transformations before transforming to a 2D projection. The 2D cryo-EM reconstruction is obtained by first rotating the 3D volume by the spatial transformer<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>, which is then projected along the <italic>z</italic> axis to generate a 2D projection that further undergoes defocus correction to generate the 2D cryo-EM reconstruction by applying a CTF as in equation (<xref rid="Equ1" ref-type="disp-formula">1</xref>). The 2D cryo-EM image <italic>X</italic> is thus a function of the 3D volume <italic>V</italic>, the projection angle <italic>P</italic> and the defocus parameters of microscope <italic>u</italic>, all of which defines the CTF, that is, <italic>X</italic>(<italic>V</italic>, <italic>P</italic>,<italic>u</italic>). Therefore, the entire image formation process is differentiable and suitable for end-to-end training.</p>
    </sec>
    <sec id="Sec13">
      <title>cryoDRGN</title>
      <p id="Par39">CryoDRGN proposed a neural representation to model the 2D projection in 3D Fourier volume. The projection can be described as a continuous function <inline-formula id="IEq18"><alternatives><tex-math id="M43">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$V:{{\mathbb{R}}}^{3}{\mathbb{\to }}{\mathbb{R}}$$\end{document}</tex-math><mml:math id="M44"><mml:mrow><mml:mi>V</mml:mi><mml:mo>:</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:msup><mml:mo>→</mml:mo><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq18.gif"/></alternatives></inline-formula>, which maps the 3D coordinate to a voxel value. CryoDRGN approximates the function <italic>V</italic> directly by using a multilayer perceptron (MLP)<sup><xref ref-type="bibr" rid="CR37">37</xref></sup>. Instead of supplying the 3D coordinates into the MLP, cryoDRGN encodes the coordinates using a specific positional encoding<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>. The 2D projection at a specific angle is computed from positional encodings of the coordinates in its corresponding slice (equation (<xref rid="Equ2" ref-type="disp-formula">2</xref>)), pixel by pixel. Different structures are generated by concatenating their latent codes to the positional encodings and supplying those combinations to the MLP. CryoDRGN is trained using β-VAE<sup><xref ref-type="bibr" rid="CR13">13</xref></sup>.</p>
    </sec>
    <sec id="Sec14">
      <title>Structural disentanglement prior</title>
      <p id="Par40">In the framework of the encode–decoder network, resolving the structural heterogeneity in a cryo-EM dataset can be formulated as learning a latent space that captures the 3D structural information. Each latent code represents a unique 3D structure in this space, <bold><italic>z</italic></bold> ~ <italic>V</italic>. Given a latent code, the decoder network can produce the corresponding 3D volume <italic>g</italic>(<italic>V</italic>|<bold><italic>z</italic></bold>). The similarity between 3D structures correlates with the distance between their latent codes. From the perspective of the decoder, encoding structural information in the latent space can be encouraged by explicitly supplementing the non-structural information such as poses and defocus parameters into the reconstruction of the 2D projection from the 3D volume. If reliably modeled, the non-structural information in 2D images will not propagate from the decoder into the latent space during backpropagation. However, when the pose assignments of the 2D images are erroneous, the 3D reconstruction from the decoder will be distorted to account for the pose assignment errors. Therefore, this approach is greatly affected by the accuracy of pose assignment, which depends heavily on the signal-to-noise ratios of a dataset. The power of a neural network for resolving structural heterogeneity will quickly deteriorate as the signal-to-noise ratios of a dataset drop. The disentanglement of structural content from pose parameters in cryoDRGN 1.0 was achieved via this approach<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>. The most recent version of cryoDRGN2 introduced a pose update to mitigate this issue<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>.</p>
      <p id="Par41">From the perspective of the encoder, learning a structural latent space can be achieved by learning a projection and defocus invariant encoding for all 2D cryo-EM images from the same 3D structure, namely, <inline-formula id="IEq19"><alternatives><tex-math id="M45">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f\left(X(V,{P},u)\right)=f\left(X\left(V,{P}^{{\prime} },{u}^{{\prime} }\right)\right),\forall P,{P}^{{\prime} }\in {{\mathrm{SO}}}\left(3\right),\forall u,{u}^{{\prime} }\in {{\mathbb{R}}}^{n}$$\end{document}</tex-math><mml:math id="M46"><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>X</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:mi>P</mml:mi><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>X</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:mo>∀</mml:mo><mml:mi>P</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">SO</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:mo>∀</mml:mo><mml:mi>u</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mrow><mml:mi mathvariant="double-struck">R</mml:mi></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq19.gif"/></alternatives></inline-formula>. The 2D cryo-EM image is a function, <italic>X</italic>(<italic>V</italic>, <italic>P</italic>, <italic>u</italic>). It can vary considerably by changing the projection angle and defocus parameters while fixing the underlying 3D structure, namely, <inline-formula id="IEq20"><alternatives><tex-math id="M47">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$X(V,P,u)\ne X(V,{P}^{{\prime} },{u}^{{\prime} })$$\end{document}</tex-math><mml:math id="M48"><mml:mrow><mml:mi>X</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:mi>P</mml:mi><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>≠</mml:mo><mml:mi>X</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq20.gif"/></alternatives></inline-formula> as long as <inline-formula id="IEq21"><alternatives><tex-math id="M49">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$P\ne {{P}^{{\prime} }}$$\end{document}</tex-math><mml:math id="M50"><mml:mrow><mml:mi>P</mml:mi><mml:mo>≠</mml:mo><mml:msup><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq21.gif"/></alternatives></inline-formula> or <inline-formula id="IEq22"><alternatives><tex-math id="M51">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$u\ne {{u}^{{\prime} }}$$\end{document}</tex-math><mml:math id="M52"><mml:mrow><mml:mi>u</mml:mi><mml:mo>≠</mml:mo><mml:msup><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq22.gif"/></alternatives></inline-formula>. In order to approximate such a latent space that primarily encodes 3D structural information, the encoder network should disentangle the 3D structural variations in 2D inputs from other factors such as projection angles and defocus parameters.</p>
      <p id="Par42">An important component of OPUS-DSD is a latent space prior disentangling the 3D structural heterogeneity from the non-structural information and encoding the 3D structural heterogeneity. The encoder network in OPUS-DSD is encouraged to generate latent encodings with larger variations for 3D structural changes in 2D inputs, while being relatively insensitive to the poses and contrast changes, namely, <inline-formula id="IEq23"><alternatives><tex-math id="M53">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\rm{Var}}(\partial f\left(X(V,{P},u)\right)/\partial V)\gg {\rm{Var}}(\partial f\left(X(V,{P},u)\right)/\partial \Delta ),\Delta ={P}\,{\rm{or}}\,{u}$$\end{document}</tex-math><mml:math id="M54"><mml:mrow><mml:mi mathvariant="normal">Var</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>∂</mml:mi><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>X</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:mi>P</mml:mi><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfenced><mml:mo>/</mml:mo><mml:mi>∂</mml:mi><mml:mi>V</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>≫</mml:mo><mml:mi mathvariant="normal">Var</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>∂</mml:mi><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>X</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>V</mml:mi><mml:mo>,</mml:mo><mml:mi>P</mml:mi><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfenced><mml:mo>/</mml:mo><mml:mi>∂</mml:mi><mml:mi mathvariant="normal">Δ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mi mathvariant="normal">Δ</mml:mi><mml:mo>=</mml:mo><mml:mi>P</mml:mi><mml:mspace width="0.25em"/><mml:mi mathvariant="normal">or</mml:mi><mml:mspace width="0.25em"/><mml:mi>u</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq23.gif"/></alternatives></inline-formula>, where variances are taken over all images. Specifically, the disentanglement is achieved by adding attracting forces and repelling forces between the encodings of a specific combination of images. The attracting forces restrain the distance between the latent codes of images from similar 3D structures, while the repelling forces encourage the separation between the latent codes of different 3D structures.</p>
      <p id="Par43">The latent space prior is composed of two components, namely the intraclass prior for 2D images of similar projection angles and the interclass prior for 2D images of different projection angles. First let us consider the intraclass prior. The 3D structural heterogeneity is most discernible in 2D cryo-EM images that have the same projection angle, namely, the variation of <italic>X</italic>(<italic>V</italic>,<italic>P</italic>,<italic>u</italic>) can be mainly attributed to <italic>V</italic> when conditioned on <italic>P</italic>. The repelling force is added between the latent codes of those pairs of images to amplify the difference between latent codes for images from different 3D structures, which encourages the encoder to discern images from different structures. Next, to encourage the smoothness of latent codes, the distances of the latent codes of similar images are restrained to prevent over-separation. To formally define the prior, given the projection angles form an SO(3) group that can be discretized into a number of classes using HEALPix<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>, 2D images can be classified into different projection classes according to their projection angles. Suppose the encoder network is <italic>f</italic>, the projection class of image <italic>X</italic><sub>i</sub> is <italic>P</italic><sub><italic>i</italic></sub>, the projection class of image <italic>X</italic><sub><italic>j</italic></sub> is <italic>P</italic><sub><italic>j</italic></sub>, inspired by the objective function of UAMP<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>, the prior for the encoder network that encourages the encoding of structural information for images in the same projection class <italic>P</italic><sub><italic>i</italic></sub> can be expressed as<disp-formula id="Equ5"><label>5</label><alternatives><tex-math id="M55">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{array}{l}{J}_{1}\left(\,f\right)=\mathop{\sum }\limits_{{X}_{i}}\frac{1}{K}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kNN}}\left(\,f\left({X}_{i}\right)\right),{P}_{j}={P}_{i}}^{K} \\ \log \left(1+{{||}\,f(X_{i}({V}_{i},{P}_{i},{u}_{i}))-f({X}_{j}({V}_{j},{P}_{j},{u}_{j})){||}}^{2}\right) \\ +\mathop{\sum }\limits_{{X}_{i}}\frac{1}{N}\mathop{\sum }\limits_{{X}_{j}\ne {X}_{i},{P}_{j}={P}_{i}}^{N}\log \left(1+\frac{1}{{{||}\,f(X_{i}({V}_{i},{P}_{i},{u}_{i}))-f({X}_{j}({V}_{j},{P}_{j},{u}_{j})){||}}^{2}}\right),\end{array}$$\end{document}</tex-math><mml:math id="M56"><mml:mtable><mml:mtr><mml:mtd columnalign="left"><mml:msub><mml:mrow><mml:mi>J</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kNN</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ5.gif" position="anchor"/></alternatives></disp-formula>where kNN refers to the <italic>k</italic> nearest neighbors of the image measured by Euclidean distance in latent space, <italic>K</italic> refers to the number of nearest neighbors, and the second summation in the second term is over all images in the same class as image <italic>X</italic><sub><italic>i</italic></sub> except itself, and <italic>N</italic> refers to the size of the projection class of image <italic>X</italic><sub><italic>i</italic></sub>. For images with similar codes, the attracting prior reaches a minimum when <inline-formula id="IEq24"><alternatives><tex-math id="M57">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$f\left({X}_{i}\right)=f({X}_{j})$$\end{document}</tex-math><mml:math id="M58"><mml:mrow><mml:mi>f</mml:mi><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mo>=</mml:mo><mml:mi>f</mml:mi><mml:mo>(</mml:mo><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq24.gif"/></alternatives></inline-formula>. By contrast, the minimum of the repelling prior is obtained at <inline-formula id="IEq25"><alternatives><tex-math id="M59">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${||f}\left({X}_{i}\right)-f\left({X}_{j}\right){||}\to \infty$$\end{document}</tex-math><mml:math id="M60"><mml:mrow><mml:mi mathvariant="italic">||f</mml:mi><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mi mathvariant="italic">||</mml:mi><mml:mo>→</mml:mo><mml:mi>∞</mml:mi></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq25.gif"/></alternatives></inline-formula>, thus the encoder is forced to amplify the structural differences between <italic>X</italic><sub><italic>i</italic></sub> and <italic>X</italic><sub><italic>j</italic></sub>.</p>
      <p id="Par44">Next let us consider the interclass prior aiming to improve the clustering of images according to structural information while reducing the impact of projection poses. This is achieved by collating the latent codes of different projections of the same 3D structure. The projections with similar latent codes are considered to be from the same structure. The attracting force can be added among them. To encourage the separation of different 3D structures, a repelling prior is added to an image and its <italic>k</italic> farthest point in latent space. Formally, let the kNN of the image <italic>X</italic><sub><italic>i</italic></sub> in latent space be <inline-formula id="IEq26"><alternatives><tex-math id="M61">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\rm{kNN}}\left(f\left({X}_{i}\right)\right)$$\end{document}</tex-math><mml:math id="M62"><mml:mrow><mml:mi mathvariant="normal">kNN</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq26.gif"/></alternatives></inline-formula>, the projection class of image <italic>X</italic><sub><italic>i</italic></sub> be <italic>P</italic><sub><italic>i</italic></sub>, the <italic>k</italic> farthest point of the image <italic>X</italic><sub><italic>i</italic></sub> in latent space be <inline-formula id="IEq27"><alternatives><tex-math id="M63">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\rm{kFP}}\left(f\left({X}_{i}\right)\right)$$\end{document}</tex-math><mml:math id="M64"><mml:mrow><mml:mi mathvariant="normal">kFP</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq27.gif"/></alternatives></inline-formula>, then our prior for encouraging the clustering of images with similar latent codes and different poses can be expressed as<disp-formula id="Equ6"><label>6</label><alternatives><tex-math id="M65">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{array}{l}{J}_{2}\left(\,f\,\right)=\mathop{\sum }\limits_{{X}_{i}}\frac{1}{K}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kNN}}\left(\,f\left({X}_{i}\right)\right),{P}_{j}\ne {P}_{i}}^{K} \\ \log \left(1+{{||}\,f(X_{i}({V}_{i},{P}_{i},{u}_{i}))-f({X}_{j}({V}_{j},{P}_{j},{u}_{j})){||}}^{2}\right) \\ +\mathop{\sum }\limits_{{X}_{i}}\frac{1}{N}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kFP}}\left(\,f\left({X}_{i}\right)\right),{P}_{j}\ne {P}_{i}}^{N}\log \left(1+\frac{1}{{{||}\,f(X_{i}({V}_{i},{P}_{i},{u}_{i}))-f({X}_{j}({V}_{j},{P}_{j},{u}_{j})){||}}^{2}}\right),\end{array}$$\end{document}</tex-math><mml:math id="M66"><mml:mtable><mml:mtr><mml:mtd columnalign="left"><mml:msub><mml:mrow><mml:mi>J</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mspace width="0.25em"/></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kNN</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kFP</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ6.gif" position="anchor"/></alternatives></disp-formula>where the second summation in both terms is over all images that do not belong to the same projection class as <italic>X</italic><sub><italic>i</italic></sub>, <italic>K</italic> refers to the number of nearest neighbors of <italic>X</italic><sub><italic>i</italic></sub> and <italic>N</italic> refers to the number of farthest points of <italic>X</italic><sub><italic>i</italic></sub>, which are both tunable hyperparameters. The complete structural disentanglement prior is the sum of equation (<xref rid="Equ5" ref-type="disp-formula">5</xref>) and equation (<xref rid="Equ6" ref-type="disp-formula">6</xref>), which can be written as<disp-formula id="Equ7"><label>7</label><alternatives><tex-math id="M67">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{array}{rcl}J\left(\,f\,\right)&amp;=&amp;\mathop{\sum }\limits_{{X}_{i}}\frac{1}{{K}_{1}}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kNN}}\left(\,f\left({X}_{i}\right)\right),{P}_{j}={P}_{i}}^{K} \\ &amp;&amp; \log \left(1+{{||}\,f(X_{i})-f({X}_{j}){||}}^{2}\right) \\&amp;&amp; +\,\frac{1}{{N}_{1}}\mathop{\sum }\limits_{{X}_{j}\ne {X}_{i},{P}_{j}={P}_{i}}\log \left(1+\frac{1}{{{||}\,f(X_{i})-f({X}_{j}){||}}^{2}}\right) \\ &amp;&amp; +\,\frac{1}{{K}_{2}}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kNN}}\left(f\left({X}_{i}\right)\right),{P}_{j}\ne {P}_{i}}\log \left(1+{{||}\,f(X_{i})-f({X}_{j}){||}}^{2}\right) \\ &amp;&amp; +\,\frac{1}{{N}_{2}}\mathop{\sum }\limits_{f\left({X}_{j}\right)\in {\rm{kFP}}\left(f\left({X}_{i}\right)\right),{P}_{j}\ne {P}_{i}}^{N}\log \left(1+\frac{1}{{{||}\,f(X_{i})-f({X}_{j}){||}}^{2}}\right),\end{array}$$\end{document}</tex-math><mml:math id="M68"><mml:mtable><mml:mtr><mml:mtd columnalign="right"><mml:mi>J</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mspace width="0.25em"/></mml:mrow></mml:mfenced></mml:mtd><mml:mtd columnalign="center"><mml:mo>=</mml:mo></mml:mtd><mml:mtd columnalign="left"><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>K</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kNN</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"/><mml:mtd columnalign="center"/><mml:mtd columnalign="left"><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"/><mml:mtd columnalign="center"/><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:mspace width="0.25em"/><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"/><mml:mtd columnalign="center"/><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:mspace width="0.25em"/><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>K</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kNN</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:munder><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="right"/><mml:mtd columnalign="center"/><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:mspace width="0.25em"/><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:mfrac><mml:munderover accent="false" accentunder="false"><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced><mml:mo>∈</mml:mo><mml:mi mathvariant="normal">kFP</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:munderover><mml:mi>log</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>X</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ7.gif" position="anchor"/></alternatives></disp-formula>where the first two terms for images with <italic>P</italic><sub><italic>j</italic></sub> = <italic>P</italic><sub><italic>i</italic></sub> are the intraclass comparison, while the last two terms for images with <inline-formula id="IEq28"><alternatives><tex-math id="M69">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${P}_{j}\ne {P}_{i}$$\end{document}</tex-math><mml:math id="M70"><mml:mrow><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>≠</mml:mo><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq28.gif"/></alternatives></inline-formula> are the interclass comparison.</p>
      <p id="Par45">To compute the structural disentanglement latent prior, equation (<xref rid="Equ5" ref-type="disp-formula">5</xref>) can be approximated using a batch of images from the same projection class (intraclass). For equation (<xref rid="Equ6" ref-type="disp-formula">6</xref>), given that a cryo-EM dataset contains hundreds of thousands of images, it is computationally inefficient to compute kNN and kFP for each image over all images. We compute them approximately for each query by using a subset of images from projection classes other than the query’s projection class to ensure interclass comparison. This subset is randomly sampled from a memory bank that stores all latent codes. The distances between the query latent code and samples are then computed and sorted in ascending order. The first <italic>K</italic><sub>2</sub> latent codes with the shortest distances are designated as the nearest neighbors of the query. The last <italic>N</italic><sub>2</sub> latent codes with the longest distances are denoted as the farthest points of the query.</p>
    </sec>
    <sec id="Sec15">
      <title>Data augmentation</title>
      <p id="Par46">The final ingredient to increase the robustness of OPUS-DSD to contrast changes is a data augmentation pipeline. The CTF blurs the cryo-EM 2D projection while strongly modulating its contrast<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>. The encoder might learn to recognize the pattern of the CTF instead of the signal of the underlying structure. To make the network more robust to the defocus variations, we propose to corrupt the pattern of the CTF by constructing input and output image pairs with randomized amplitudes of Fourier transforms. Specifically, the input and output are two images that have been independently constructed by multiplying the random Gaussian function with the Fourier transform of the original image. That is, let the Fourier transform of the constructed image be <inline-formula id="IEq29"><alternatives><tex-math id="M71">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathscr{X}}}_{h,k}^{{\prime} }$$\end{document}</tex-math><mml:math id="M72"><mml:msubsup><mml:mrow><mml:mi mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msubsup></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq29.gif"/></alternatives></inline-formula> and the Fourier transform of the original image be <inline-formula id="IEq30"><alternatives><tex-math id="M73">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathscr{X}}}_{h,k}$$\end{document}</tex-math><mml:math id="M74"><mml:msub><mml:mrow><mml:mi mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq30.gif"/></alternatives></inline-formula>, and the data augmentation process is defined as<disp-formula id="Equ8"><label>8</label><alternatives><tex-math id="M75">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{\mathscr{X}}}_{h,k}^{{\prime} }={e}^{-b{\pi }^{2}{s}^{2}}{{\mathscr{X}}}_{h,k},$$\end{document}</tex-math><mml:math id="M76"><mml:mrow><mml:msubsup><mml:mrow><mml:mi mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msubsup><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi>e</mml:mi></mml:mrow><mml:mrow><mml:mo>−</mml:mo><mml:mi>b</mml:mi><mml:msup><mml:mrow><mml:mi>π</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mi>s</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:msup><mml:msub><mml:mrow><mml:mi mathvariant="script">X</mml:mi></mml:mrow><mml:mrow><mml:mi>h</mml:mi><mml:mo>,</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:mrow></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ8.gif" position="anchor"/></alternatives></disp-formula>where <italic>b</italic> is a uniform random <italic>B</italic> factor in the range [−0.5, 0.5] and <inline-formula id="IEq31"><alternatives><tex-math id="M77">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$s=\sqrt{{h}^{2}+{k}^{2}}$$\end{document}</tex-math><mml:math id="M78"><mml:mrow><mml:mi>s</mml:mi><mml:mo>=</mml:mo><mml:msqrt><mml:mrow><mml:msup><mml:mrow><mml:mi>h</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi>k</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:msqrt></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq31.gif"/></alternatives></inline-formula> is the modulus of the spatial frequency vector of the Fourier transform. The image contrast is sharpened when <italic>b</italic> &lt; 0, while the image contrast is blurred when <italic>b</italic> &gt; 0. The <italic>B</italic> factors applied to input and output are two independently sampled values. We further multiply the Gaussian blurred or sharpened input image with a uniform random constant in the range [0.75, 1.25] to change its overall contrast and brightness. The input image is then fed into the encoder, while the decoder is asked to reconstruct the output image. The neural network thus is forced to reconstruct an image using input with different contrast values. This data augmentation pipeline increases the robustness of the encoder network to the contrast variations of inputs, and reduces the impact of defocus parameters on latent codes.</p>
    </sec>
    <sec id="Sec16">
      <title>Training objectives</title>
      <p id="Par47">The smoothness of latent space is of paramount importance to the generalizability of the generative model. To generate plausible samples during a traversal through the latent space, the generative model needs to smoothly interpolate between training samples. One way to achieve this is by VAE<sup><xref ref-type="bibr" rid="CR14">14</xref></sup>. Instead of producing a deterministic latent code, the encoder approximates a posterior distribution of latent code conditioned on image <italic>X</italic>, <italic>f</italic>(<bold><italic>z</italic></bold>|<italic>X</italic>), which is often assumed to be a diagonal Gaussian distribution for simplicity. The encoder then parameterizes this diagonal Gaussian distribution by outputting its mean and variance. The smoothness of latent space is encouraged by increasing the overlapping between the approximate posterior distributions of images, namely, restraining the deviation of approximate posterior distributions from the standard Gaussian distribution. The default VAE assumes that the reconstruction loss and restraints are of equal weights, while β-VAE introduces a tunable parameter to control the strength of the standard Gaussian restraints<sup><xref ref-type="bibr" rid="CR13">13</xref></sup>. Furthermore, to generate a plausible 3D volume, total variation and LASSO priors are imposed on the reconstructed 3D volume to encourage its smoothness and sparseness<sup><xref ref-type="bibr" rid="CR31">31</xref>,<xref ref-type="bibr" rid="CR32">32</xref></sup>.</p>
      <p id="Par48">As mentioned in the Structural Disentanglement Prior subsection, the pose assignment errors from consensus refinement have an adverse effect on the quality of the 3D reconstruction output by the neural network. We have therefore designed a reconstruction loss that is robust to pose assignment errors by comparing an experimental image with multiple reconstructions obtained at its pose from consensus refinement and neighboring poses. The objective function leveraged by OPUS-DSD with the aforementioned considerations is as follows. Using β-VAE, let <italic>θ</italic> be the projection angle determined by a consensus 3D refinement for each image, <italic>f</italic> be the encoder network, <italic>g</italic> be the decoder network, <italic>F</italic> represent the image formation process given the 3D volume <italic>V</italic>, projection angle <italic>θ</italic>′ and defocus parameters <italic>u</italic>, let the dimension of the 3D volume be <italic>N</italic><sup>3</sup>, and the objective function for learning a neural network to resolve 3D structural heterogeneity can be expressed as<disp-formula id="Equ9"><label>9</label><alternatives><tex-math id="M79">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\begin{array}{l}\mathop{\min }\limits_{f,g}{E}_{f\left({\boldsymbol{z}}|X\right)}-\log \mathop{\sum }\limits_{{\theta }^{{\prime} }\in {NN}(\theta )}\exp -\frac{1}{2}{{||X}-F\left(g\left(V({\boldsymbol{x}}){\rm{|}}{\boldsymbol{z}}\right),{\theta }^{{\prime} },u\right){||}}^{2} \\ +\,\beta {D}_{{{\mathrm{KL}}}}\left(\,f({\boldsymbol{z}}{\rm{|}}X\,){\rm{|}}|{\mathscr{N}}\left(0,I\,\right)\right)+\lambda J\left(\,f({\boldsymbol{z}}{|X}\,)\right) \\ +\, \frac{{\lambda }_{{{\mathrm{tv}}}}}{N}\mathop{\sum }\limits_{\boldsymbol{x}}{{\Big|\Big|}\frac{\partial g\left(V\left({\boldsymbol{x}}\right)|{\boldsymbol{z}}\right)}{\partial {\boldsymbol{x}}}{\Big|\Big|}}_{2}+\frac{{\lambda }_{{l}_{1}}}{N}\mathop{\sum }\limits_{\boldsymbol{x}}{{||g}\left(V\left({\boldsymbol{x}}\right)|{\boldsymbol{z}}\right){||}}_{1},\end{array}$$\end{document}</tex-math><mml:math id="M80"><mml:mtable><mml:mtr><mml:mtd columnalign="left"><mml:munder><mml:mrow><mml:mi>min</mml:mi></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mo>,</mml:mo><mml:mi>g</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mi>E</mml:mi></mml:mrow><mml:mrow><mml:mi>f</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mo>∣</mml:mo><mml:mi>X</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mi>log</mml:mi><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>∈</mml:mo><mml:mi>N</mml:mi><mml:mi>N</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:munder><mml:mi>exp</mml:mi><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:mfrac><mml:msup><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mi>X</mml:mi><mml:mo>−</mml:mo><mml:mi>F</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>g</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi mathvariant="normal">∣</mml:mi><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mo>′</mml:mo></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow></mml:mfenced><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:mspace width="0.25em"/><mml:mi>β</mml:mi><mml:msub><mml:mrow><mml:mi>D</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">KL</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mi mathvariant="normal">∣</mml:mi><mml:mi>X</mml:mi><mml:mspace width="0.25em"/></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi mathvariant="normal">∣</mml:mi><mml:mo>∣</mml:mo><mml:mi mathvariant="script">N</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>I</mml:mi><mml:mspace width="0.25em"/></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>+</mml:mo><mml:mi>λ</mml:mi><mml:mi>J</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mspace width="0.25em"/><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">z</mml:mi><mml:mo>∣</mml:mo><mml:mi>X</mml:mi><mml:mspace width="0.25em"/></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfenced></mml:mtd></mml:mtr><mml:mtr><mml:mtd columnalign="left"><mml:mo>+</mml:mo><mml:mspace width="0.25em"/><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">tv</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:mfrac><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mstyle mathsize="1.61em"><mml:mfenced open="∣"><mml:mrow/></mml:mfenced></mml:mstyle><mml:mstyle mathsize="1.61em"><mml:mfenced open="∣"><mml:mrow/></mml:mfenced></mml:mstyle><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mi>g</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:mfenced><mml:mo>∣</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:mfrac><mml:mstyle mathsize="1.61em"><mml:mfenced open="∣"><mml:mrow/></mml:mfenced></mml:mstyle><mml:mstyle mathsize="1.61em"><mml:mfenced open="∣"><mml:mrow/></mml:mfenced></mml:mstyle></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>N</mml:mi></mml:mrow></mml:mfrac><mml:munder><mml:mrow><mml:mo>∑</mml:mo></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mrow><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:mi>g</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:mfenced><mml:mo>∣</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:mfenced><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:math><graphic xlink:href="41592_2023_2031_Article_Equ9.gif" position="anchor"/></alternatives></disp-formula>where <italic>NN</italic>(<italic>θ</italic>) represents the nearest neighbors of the projection angle <italic>θ</italic>, the first term is the expectation of errors between the ground-truth image <italic>X</italic> and the reconstruction <inline-formula id="IEq32"><alternatives><tex-math id="M81">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$F\left(g\left({V|}{\boldsymbol{z}}\right),\theta {\prime} ,u\right)$$\end{document}</tex-math><mml:math id="M82"><mml:mrow><mml:mi>F</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>g</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mo>∣</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:mfenced><mml:mo>,</mml:mo><mml:mi>θ</mml:mi><mml:mo>′</mml:mo><mml:mo>,</mml:mo><mml:mi>u</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq32.gif"/></alternatives></inline-formula> over the distribution of latent code <bold><italic>z</italic></bold>, <inline-formula id="IEq33"><alternatives><tex-math id="M83">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathscr{N}}\left(0,I\right)$$\end{document}</tex-math><mml:math id="M84"><mml:mrow><mml:mi mathvariant="script">N</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>I</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq33.gif"/></alternatives></inline-formula> is the standard Gaussian distribution, <italic>D</italic><sub>KL</sub> is the Kullback–Leibler (KL) divergence between the distribution given by the encoder network <italic>f</italic> and the standard Gaussian <inline-formula id="IEq34"><alternatives><tex-math id="M85">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\mathscr{N}}\left(0,I\right)$$\end{document}</tex-math><mml:math id="M86"><mml:mrow><mml:mi mathvariant="script">N</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>I</mml:mi></mml:mrow></mml:mfenced></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq34.gif"/></alternatives></inline-formula>, the term <italic>J</italic>(<italic>f</italic>(<bold><italic>z</italic></bold>│<italic>X</italic>)) is the structural disentanglement prior to encourage the encoding of the 3D structural information in latent space, <inline-formula id="IEq35"><alternatives><tex-math id="M87">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\frac{\partial g\left(V\left({\boldsymbol{x}}\right)|{\boldsymbol{z}}\right)}{\partial {\boldsymbol{x}}}$$\end{document}</tex-math><mml:math id="M88"><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mi>g</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>V</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:mfenced><mml:mo>∣</mml:mo><mml:mi mathvariant="bold-italic">z</mml:mi></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:mi mathvariant="bold-italic">x</mml:mi></mml:mrow></mml:mfrac></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq35.gif"/></alternatives></inline-formula> denotes the gradient of the 3D volume at grid point <bold><italic>x</italic></bold>, <italic>β</italic> is the restraint strength for <italic>D</italic><sub>KL</sub>, <italic>λ</italic> is the restraint strength for the structural disentanglement prior, <italic>λ</italic><sub>tv</sub> is the restraint strength for total variation, and <inline-formula id="IEq36"><alternatives><tex-math id="M89">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\lambda }_{{l}_{1}}$$\end{document}</tex-math><mml:math id="M90"><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq36.gif"/></alternatives></inline-formula> is the restraint strength for LASSO. Computing the expectation in equation (<xref rid="Equ9" ref-type="disp-formula">9</xref>) is intractable, and we use a reparameterization trick<sup><xref ref-type="bibr" rid="CR14">14</xref></sup> to approximate the expectation integral.</p>
    </sec>
    <sec id="Sec17">
      <title>Training</title>
      <p id="Par49">Our network was trained using 2D images. The projection pose parameters of 2D images were determined by the consensus 3D refinement in RELION or cryoSPARC<sup><xref ref-type="bibr" rid="CR6">6</xref>,<xref ref-type="bibr" rid="CR41">41</xref></sup>. The 2D images were randomly split into a training set and a validation set using a specified split ratio. The images in the validation set were used to evaluate the reconstruction quality of the neural network only. For the spliceosome and <italic>Pf</italic>80S ribosome with a large amount of data and good signal-to-noise ratios, we used 20% of the images for validation. For the <italic>Sc</italic>80S ribosome and NEXT complex data, 10% of the images were used for validation. The computation of the structural disentanglement prior requires us to perform intraclass and interclass comparisons. Hence, the training images were classified into 48 different projection classes according to their first two Euler angles using HEALPix<sup><xref ref-type="bibr" rid="CR40">40</xref></sup> before being sent to training. At each iteration a projection class was selected uniformly and a batch of images in the selected projection class was sampled by a customized batch sampler. The structural disentanglement prior can be easily computed using such a batching process. The image sample was passed to the encoder, which outputs a sample of the latent distribution <italic>f</italic>(<bold><italic>z</italic></bold>|<italic>X</italic>). The decoder reconstructs a 3D volume according to the latent code. The total variations and LASSO priors were imposed on the reconstructed 3D volume to encourage its smoothness and sparseness<sup><xref ref-type="bibr" rid="CR31">31</xref>,<xref ref-type="bibr" rid="CR32">32</xref></sup>. The 3D volume was rendered into a 2D reconstruction with predetermined pose according to the cryo-EM image formation model. The inputs and reconstructions together with the latent codes were used to construct the training loss as in equation (<xref rid="Equ9" ref-type="disp-formula">9</xref>), which was minimized using the Adam optimizer<sup><xref ref-type="bibr" rid="CR42">42</xref></sup>.</p>
    </sec>
    <sec id="Sec18">
      <title>Implementation</title>
      <p id="Par50">The neural network of OPUS-DSD was implemented in PyTorch with automatic differentiation support<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>. The major computation bottleneck is caused by the 3D convolution autoencoder given that every 2D image has to go through a series of 3D operations. The run time and memory cost of OPUS-DSD was hence almost irrelevant to the size of the 2D images. Using four Nvidia V100 GPUs (graphics processing units), the training of 1,000 images took around 1 min. For the pre-catalytic spliceosome dataset containing 262,816 images, the training took 3 h per epoch (an epoch represents a loop through the whole training set once) using four Nvidia V100 GPUs, and the best results were obtained between 12 and 16 epochs. The 3D convolutional architecture incurred a larger memory cost than cryoDRGN. When the output 3D volume is of a size of 256<sup>3</sup>, an Nvidia V100 GPU with 32 GB memory could process around 16 images at once. However, OPUS-DSD enables the user to specify a smaller output volume to save memory, which was accomplished by resampling intermediate tensors: for example, the resampling of the tensor of 256 × 8<sup>3</sup> in Fig. <xref rid="Fig1" ref-type="fig">1c</xref> to 256 × 6<sup>3</sup> yields an output volume of 192<sup>3</sup>, thus saving memory. Despite the larger computational and memory cost compared with cryoDRGN, the run time of OPUS-DSD should still be acceptable given that it generally converges well before the 20th epoch. For example, on the <italic>Sc</italic>80S ribosome, cryoDRGN took 8.75 h to converge using four GPUs, while OPUS-DSD took 11 h to obtain the results presented here. On the synthetic NEXT complex, cryoDRGN took 3 h with four GPUs to converge, while OPUS-DSD took 8 h to obtain the results reported. Moreover, OPUS-DSD was able to very quickly reconstruct a 3D volume for a given latent code because it generated the whole volume in one pass. In contrast, cryoDRGN is required to reevaluate the neural network at each voxel to produce a final volume. Last, OPUS-DSD implements a routine to estimate the signal-to-noise ratio of a dataset and automatically balance the strengths of regularization penalties and the reconstruction loss. Users can specify the parameters using an absolute scale without worrying about the actual signal-to-noise ratios of the dataset.</p>
    </sec>
    <sec id="Sec19">
      <title>Hyperparameter settings</title>
      <p id="Par51">In our experiments we set the restraint strength for KL divergence to be proportional to the signal-to-noise ratio of the dataset, specifically <italic>λ</italic><sub>KL</sub> = 2 × signal-to-noise ratio. OPUS-DSD can automatically estimate the signal-to-noise ratio during training. The restraint strength for the structural disentanglement prior was also set according to the signal-to-noise ratios of the dataset. For the spliceosome and <italic>Pf</italic>80S ribosome with a high signal-to-noise ratio we set <italic>λ</italic> = 2. For the <italic>Sc</italic>80S ribosome we set <italic>λ</italic> = 1. For the synthetic data and real NEXT complex datasets we set <italic>λ</italic> = 0.5. Furthermore, previous restraint strengths were weighted by a cyclical annealing schedule to avoid posterior collapse<sup><xref ref-type="bibr" rid="CR44">44</xref></sup>. We fixed the restraint strength for the total variation of the 3D volume as <italic>λ</italic><sub>tv</sub> = 1 and the restraint strength for LASSO as <inline-formula id="IEq37"><alternatives><tex-math id="M91">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${\lambda }_{{l}_{1}}=0.3$$\end{document}</tex-math><mml:math id="M92"><mml:mrow><mml:msub><mml:mrow><mml:mi>λ</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0.3</mml:mn></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq37.gif"/></alternatives></inline-formula>. The learning rate was set to 10<sup>−4</sup> and decayed by 0.95 at each epoch for all experiments. The batch size was set to 72 during the training. All training sessions were performed on four Nvidia V100 GPUs. The number of samples for interclass comparison was set to 12,800. The number of kNNs for interclass or intraclass comparison was set to 128 or 4, respectively, while the number of kFPs for interclass comparison was set to 512. The latent codes of particles were updated with a momentum of 0.7. The dimension of latent space can limit the amount of information flowing from encoder to decoder, and was often set to around 10 in the 2D to 3D translation in our experiments.</p>
    </sec>
    <sec id="Sec20">
      <title>Computation protocol</title>
      <p id="Par52">For each system the structural heterogeneity analyses were performed on the same consensus refinement result for different methods. For cryoDRGN, due to the lack of validation metrics, the number of training epochs was chosen based on the quality of the density maps reconstructed. By contrast, OPUS-DSD selected models for further analyses according to the average reconstruction errors using the validation set. The structural heterogeneity was determined by analyzing the 3D density maps reconstructed from the centroids of clusters in latent space generated by the simple Kmeans clustering algorithm<sup><xref ref-type="bibr" rid="CR45">45</xref></sup>. The latent space of different methods was also visualized in 2D using UMAP<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>. The structural heterogeneity was also analyzed using PCA. Kmeans clustering and PCA were carried out in scikit-learn 1.3.0 (ref. <sup><xref ref-type="bibr" rid="CR46">46</xref></sup>). All movies were generated by Chimera<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>.</p>
    </sec>
    <sec id="Sec21">
      <title>Cryo-EM data collection</title>
      <p id="Par53">Recombinant proteins (MTR4, RBM7 and ZCCHC8) of the NEXT complex were overexpressed separately in HEK293 GnTIˉ cells. Cells were infected with 10% volume of recombinant baculovirus at 37 °C, 95 rpm for 20 h before adding sodium butyrate to a final concentration of 10 mM, and then transferred to 30 °C for another 40 h. Cells were collected by centrifugation at 800<italic>g</italic> for 10 min at 4 °C. Recombinant protein cell pellets were mixed and suspended in lysis buffer containing 20 mM HEPES, pH 7.4, 300 mM NaCl, 4% glycerol, 1 mM TCEP and 1% NP-40, 0.1‰ nuclease and lysed using high-pressure homogenizer before centrifugation at 44,000<italic>g</italic> for 30 min at 4 °C. The supernatant was incubated with 1 ml (50% slurry) poly-flag-tag beads for 1 h at 4 °C and then poured into a gravity flow column, and beads were washed with 20 mM HEPES, pH 7.4, 300 mM NaCl and 4% glycerol. Bound proteins were eluted in the buffer containing 20 mM HEPES, pH 7.4, 300 mM NaCl, 4% glycerol and 400 μg ml<sup>−</sup><sup>1</sup> poly-flag-peptide. The NEXT complex was further purified using Superdex 200 Increase 10/300 (GE Healthcare) in a buffered solution containing 20 mM HEPES, pH 7.4, 300 mM NaCl and 4% glycerol. The desired fraction was concentrated to 50 μl. Protein cross-linking was achieved by density gradient centrifugation (10–30% glycerol, 0.2% glutaraldehyde) at 47,000 rpm (SW-55Ti, Beckman) for 8.5 h at 4 °C. Sample after centrifugation was concentrated to a minimal volume and changed to the buffer containing 20 mM HEPES, pH 7.4, and 150 mM NaCl by dialysis. Three microliters of the complex sample were applied to a Cryo Matrix amorphous alloy film R1.2/1.3 300 mesh (Zhenjiang Lehua Technology) that had been glow-discharged and vitrified using Vitrobot (Thermo Fisher Scientific) at 4 °C and 100% humidity. The experimental NEXT dataset was collected using a Titan Krios G3i 300 KV electron microscope (Thermo Fisher Scientific) equipped with a BioQuantum-K3 Summit camera (Gatan) with a 20 eV slit and in super-resolution mode. Micrographs were captured at a nominal magnification of 81,000 and a calibrated pixel size of 0.55 Å. Each video stack received a total electron dose of 50 e<sup>−</sup> per Å<sup>2</sup> in a 2.19-s exposure.</p>
    </sec>
    <sec id="Sec22">
      <title>Synthetic data preparation</title>
      <p id="Par54">The synthetic NEXT dataset consisted of 64,000 2D images of eight different conformations that were generated from the starting conformation by shifting the MTR4 helicase domains relative to the ZCCHC8 center. The density maps for these eight conformations were generated using the molmap command in Chimera from the corresponding atomic models<sup><xref ref-type="bibr" rid="CR47">47</xref></sup>. The 2D projection was obtained by projecting the density map of a conformation onto the 2D plane along a randomly sampled projection angle. The 2D projection was then convolved with a randomly sampled CTF and contaminated by specific levels of noise to generate the final synthetic 2D images. Each conformation contained 8,000 2D images produced in this way.</p>
    </sec>
    <sec id="Sec23">
      <title>Reporting summary</title>
      <p id="Par55">Further information on research design is available in the <xref rid="MOESM2" ref-type="media">Nature Portfolio Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec id="Sec24" sec-type="materials|methods">
    <title>Online content</title>
    <p id="Par56">Any methods, additional references, Nature Portfolio reporting summaries, source data, extended data, supplementary information, acknowledgements, peer review information; details of author contributions and competing interests; and statements of data and code availability are available at 10.1038/s41592-023-02031-6.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <sec id="Sec26">
      <title>Supplementary information</title>
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41592_2023_2031_MOESM1_ESM.pdf">
            <label>Supplementary Information</label>
            <caption>
              <p>Supplementary Table 1 and Fig. 1.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="41592_2023_2031_MOESM2_ESM.pdf">
            <caption>
              <p>Reporting Summary</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="41592_2023_2031_MOESM3_ESM.pdf">
            <caption>
              <p>Peer Review File</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM4">
          <media xlink:href="41592_2023_2031_MOESM4_ESM.mp4">
            <label>Supplementary Video 1</label>
            <caption>
              <p>Traversal along the first principal component of the latent space of the pre-catalytic spliceosome showing the folding of SF3b onto the core and the formation of a chain between SF3b and helicase. Red arrow marks the location of this new chain.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM5">
          <media xlink:href="41592_2023_2031_MOESM5_ESM.mp4">
            <label>Supplementary Video 2</label>
            <caption>
              <p>Traversal along the PC1 of the latent space of the <italic>Pf</italic>80S ribosome showing the docking process of an RNA from LSU to SSU. A green arrow marks the location of this RNA on LSU, while a red arrow marks the location of this RNA on SSU.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM6">
          <media xlink:href="41592_2023_2031_MOESM6_ESM.mp4">
            <label>Supplementary Video 3</label>
            <caption>
              <p>Traversal along the PC1 of the latent space of the <italic>Pf</italic>80S ribosome showing the formation of a chain that connects one of the ends of a peripheral RNA back to SSU. A red arrow marks the location of this new chain.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM7">
          <media xlink:href="41592_2023_2031_MOESM7_ESM.mp4">
            <label>Supplementary Video 4</label>
            <caption>
              <p>Traversal along the PC1 of the latent space of the <italic>Sc</italic>80S ribosome showing the swing of a peripheral RNA. A red arrow marks the location of this RNA in the conformation at the positive end of PC1, while a green arrow marks its location in the conformation at the negative end of PC1.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM8">
          <media xlink:href="41592_2023_2031_MOESM8_ESM.mp4">
            <label>Supplementary Video 5</label>
            <caption>
              <p>Traversal along the PC1 of the latent space of the <italic>Sc</italic>80S ribosome shown by cryoDRGN. A red arrow marks the location of an RNA in the conformation at the positive end of PC1, while a green arrow marks its location in the conformation at the negative end of PC1.</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
    <sec id="Sec27">
      <title>Source data</title>
      <p>
        <supplementary-material content-type="local-data" id="MOESM9">
          <media xlink:href="41592_2023_2031_MOESM9_ESM.xlsx">
            <label>Source Data Figs. 5g,h and 6e,g and Extended Data Fig. 9e,g</label>
            <caption>
              <p>Statistical source data.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM10">
          <media xlink:href="41592_2023_2031_MOESM10_ESM.xlsx">
            <label>Source Data Fig. 5e,f and Extended Data Figs. 6e,f and 7a–c</label>
            <caption>
              <p>Statistical source data.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM11">
          <media xlink:href="41592_2023_2031_MOESM11_ESM.xlsx">
            <label>Source Data Fig. 6a,f,h and Extended Data Figs. 9f,h and 10a,e,f,g1–g4</label>
            <caption>
              <p>Statistical source data.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM12">
          <media xlink:href="41592_2023_2031_MOESM12_ESM.xlsx">
            <label>Source Data Extended Data Fig. 7d,e</label>
            <caption>
              <p>Statistical source data.</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <app-group>
    <app id="App1">
      <sec id="Sec25">
        <title>Extended data</title>
        <p id="Par61">
          <fig id="Fig7">
            <label>Extended Data Fig. 1</label>
            <caption>
              <title>Density maps of the pre-catalytic spliceosome reconstructed by OPUS-DSD’s decoder.</title>
              <p><bold>a)</bold>. Twenty density maps of the pre-catalytic spliceosome generated by OPUS-DSD’s decoder at cluster centers shown in Fig. <xref rid="Fig2" ref-type="fig">2a</xref> as inputs. <bold>b)</bold>. Comparisons between densities of SF3b, Helicase and Core in Class 12 from OPUS-DSD and high-resolution structure from multi-body refinement, together with the consensus model. Class 12 is shown in green and transparent. The high-resolution structures from multi-body refinement are shown in solid colors inside Class 12. Left-to-right three columns: the comparisons focusing on SF3b (purple), Helicase (red) and Core/Foot (yellow), respectively. The consensus structure is shown in solid blue on the right as a reference.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig7_ESM" id="d32e5457"/>
          </fig>
        </p>
        <p id="Par62">
          <fig id="Fig8">
            <label>Extended Data Fig. 2</label>
            <caption>
              <title>A highly mobile RNA identified in Class 8 of Pf80S ribosome by OPUS-DSD.</title>
              <p><bold>a)</bold> and <bold>b)</bold>. The consensus map shown at two different contour levels. <bold>c)</bold>. The density map of Class 8 identified by OPUS-DSD. The maps in a) and c) are at the same contour level, which the map at b) is at a much lower contour level. The RNA strand is visible in Class 8 from OPUS-DSD (c) and the consensus map at a very low contour level (b), while it is absent in consensus map on the same contour level as Class 8 (a), suggesting its high flexibility.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig8_ESM" id="d32e5479"/>
          </fig>
        </p>
        <p id="Par63">
          <fig id="Fig9">
            <label>Extended Data Fig. 3</label>
            <caption>
              <title>Heterogeneity analysis on S.cerevisiae 80S (S.c80S) ribosome (EMPIAR: 10002) by cryoDRGN.</title>
              <p><bold>a)</bold>. UMAP visualization of the 8-dimensional latent space of all particles encoded by cryoDRGN. Solid black dots represent the cluster centers for labeled classes. <bold>b)</bold>. Sixteen density maps reconstructed by cryoDRGN’s decoder using Kmeans clustering centers in its 8-dimensional latent space as inputs. The swinging RNA strand which was revealed in the results of OPUS-DSD can also be observed in cryoDRGN’s results here (red dashed boxes). <bold>c)</bold>. Comparison between the density maps of Class 9 from OPUS-DSD (in green color) and Class 8 from cryoDRGN (in purple color). The density map of Class 9 from OPUS-DSD is more complete in regions marked by red dashed ellipse. Both maps are contoured at the same level.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig9_ESM" id="d32e5501"/>
          </fig>
        </p>
        <p id="Par64">
          <fig id="Fig10">
            <label>Extended Data Fig. 4</label>
            <caption>
              <title>The movements of an RNA strand and the 40S subunit in S.c80S ribosome revealed by OPUS-DSD.</title>
              <p><bold>a)</bold>. The movements of an RNA strand in S.c80S ribosome revealed by OPUS-DSD. The reference density map of Class 9 from OPUS-DSD is colored in green and semi-transparent. The density maps shown in order are Classes 8, 4, 6, and 5, exhibiting increasingly larger displacements in the RNA (as marked by the red dashed boxes) relative to its position in Class 9. The arrows in the same color as the density maps are drawn to highlight the displacements. <bold>b)</bold>. The movement of the 40S subunit in S.c80S ribosome revealed by OPUS-DSD. The reference density map of Class 4 from OPUS-DSD is colored in violet and semi-transparent. The density maps shown in order are Classes 2, 13, 7, and 15, displaying increasingly larger displacements in 40S subunit (marked by red dashed boxes) relative to its position in Class 4. The arrows in the same color as the density maps are drawn to highlight the displacements.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig10_ESM" id="d32e5520"/>
          </fig>
        </p>
        <p id="Par65">
          <fig id="Fig11">
            <label>Extended Data Fig. 5</label>
            <caption>
              <title>Reconstructions of OPUS-DSD and cryoDRGN on synthetic dataset of NEXT complex with a signal-to-noise ratio of 0.05.</title>
              <p><bold>a)</bold>. 3D density maps reconstructed by the decoder of OPUS-DSD using cluster centers shown in Fig. <xref rid="Fig6" ref-type="fig">6b</xref>. <bold>b)</bold>. 3D density maps reconstructed by the decoder of cryoDRGN using cluster centers shown in Fig. <xref rid="Fig6" ref-type="fig">6b</xref>. <bold>c)</bold>. 3D density maps reconstructed by cryoSPARC with particles in each class from OPUS-DSD. <bold>d)</bold>. 3D density maps reconstructed by cryoSPARC with particles in each class from cryoDRGN.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig11_ESM" id="d32e5551"/>
          </fig>
        </p>
        <p id="Par66">
          <fig id="Fig12">
            <label>Extended Data Fig. 6</label>
            <caption>
              <title>Heterogeneity analysis on synthetic dataset of NEXT complex with signal-to-noise ratio of 0.1.</title>
              <p><bold>a)</bold>. The starting atomic model of NEXT complex. <bold>b)</bold>. Ground-truth density maps of NEXT complexes. <bold>c)</bold>. Consensus model reconstructed by cryoSPARC using all particles. <bold>d)</bold>. UMAP visualizations of the 8-dimensional latent spaces of all particles encoded by OPUS-DSD (left panel) and cryoDRGN (right panel). <bold>e)</bold>. Distribution of particles in clusters in the latent space of OPUS-DSD. Bars are colored to match the profiles of the ground-truth density maps in b). Entropy is defined as the average of <inline-formula id="IEq38"><alternatives><tex-math id="M93">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$-{\sum }_{i}{p}_{i}\log {p}_{i}$$\end{document}</tex-math><mml:math id="M94"><mml:mrow><mml:mo>−</mml:mo><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mi>log</mml:mi><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq38.gif"/></alternatives></inline-formula> of each cluster, where <inline-formula id="IEq39"><alternatives><tex-math id="M95">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${p}_{i}=\frac{{n}_{i}}{{\sum }_{i}{n}_{i}}$$\end{document}</tex-math><mml:math id="M96"><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:math><inline-graphic xlink:href="41592_2023_2031_Article_IEq39.gif"/></alternatives></inline-formula>, and <italic>n</italic><sub><italic>i</italic></sub> is the number of particles in the ground-truth conformation <italic>i</italic>. <bold>f)</bold>. Distribution of particles in clusters in the latent space of cryoDRGN. <bold>g)</bold>. 3D density maps reconstructed by particles in each class from OPUS-DSD. <bold>h)</bold>. 3D density maps reconstructed by particles in each class from cryoDRGN.</p>
              <p>
                <xref rid="MOESM10" ref-type="media">Source data</xref>
              </p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig12_ESM" id="d32e5681"/>
          </fig>
        </p>
        <p id="Par67">
          <fig id="Fig13">
            <label>Extended Data Fig. 7</label>
            <caption>
              <title>Contributions of disentanglement prior and data augmentation to the performance of OPUS-DSD.</title>
              <p><bold>a)</bold>. Distribution of particles in the latent space of OPUS-DSD with disentanglement prior and data augmentation on the synthetic data of NEXT complex. <bold>b)</bold>. Distribution of particles in the latent space of OPUS-DSD without disentanglement prior. <bold>c)</bold>. Distribution of particles in the latent space of OPUS-DSD without data augmentation. <bold>d)</bold>. Validation and training losses of S.c80S ribosome with data augmentation in OPUS-DSD. <bold>e)</bold>. Validation and training losses of S.c80S ribosome without data augmentation in OPUS-DSD.</p>
              <p>
                <xref rid="MOESM10" ref-type="media">Source data</xref>
              </p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig13_ESM" id="d32e5714"/>
          </fig>
        </p>
        <p id="Par68">
          <fig id="Fig14">
            <label>Extended Data Fig. 8</label>
            <caption>
              <title>Comparison of unmasked half maps.</title>
              <p><bold>a)</bold>. Unmasked half maps from the results of heterogeneity analyses by OPUS-DSD on the 224,354 particles of NEXT complex. <bold>b)</bold>. Unmasked half maps from the results of heterogeneity analyses by cryoDRGN on the 224,354 particles of NEXT complex.</p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig14_ESM" id="d32e5733"/>
          </fig>
        </p>
        <p id="Par69">
          <fig id="Fig15">
            <label>Extended Data Fig. 9</label>
            <caption>
              <title>Heterogeneity analysis on NEXT complex with focused refinement.</title>
              <p><bold>a)</bold>. Starting consensus model which was refined with a mask without the MTR4 domain using RELION. <bold>b)</bold>. UMAP visualizations of latent spaces learned by OPUS-DSD (left panel) and cryoDRGN (right panel). The dots with numbers are cluster centers found by Kmeans algorithm. <bold>c)</bold>. Ten classes reconstructed by OPUS-DSD at points shown in <bold>b</bold> and the corresponding number of particles in each class. <bold>d)</bold>. Ten classes reconstructed by cryoDRGN and the corresponding number of particles in each class. <bold>e)</bold>. Translation–rotation plot for reconstructions from OPUS-DSD. The movement is measured for the MTR4 domain relative to the ZCCHC8 domain of each conformation by Dyndom using the consensus model as a reference. <bold>f)</bold>. Density map and gold-standard FSCs for 85,570 particles by combining OPUS-DSD’s clusters with small structural variations (grouped by red circle in <bold>e</bold>). <bold>g)</bold>. Translation–rotation plot for reconstructions from cryoDRGN. The movement is measured for the MTR4 domain relative to the ZCCHC8 domain of each conformation by Dyndom using the consensus model as a reference. <bold>h)</bold>. Density map and gold-standard FSCs for 96,466 particles by combining cryoDRGN’s clusters with small structural variations (grouped by blue circle in <bold>g</bold>). <bold>i)</bold>. Unmasked half maps for OPUS-DSD’s cluster in <bold>f)</bold>. <bold>j)</bold>. Unmasked half maps for cryoDRGN’s cluster in <bold>h)</bold>. All maps are contoured at the same level.</p>
              <p>
                <xref rid="MOESM9" ref-type="media">Source data</xref>
              </p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig15_ESM" id="d32e5798"/>
          </fig>
        </p>
        <p id="Par70">
          <fig id="Fig16">
            <label>Extended Data Fig. 10</label>
            <caption>
              <title>Heterogeneity analysis of 84,530 particles of NEXT complex.</title>
              <p><bold>a)</bold>. Starting consensus model and its gold-standard FSCs for all particles. <bold>b)</bold>. UMAP visualizations of latent spaces learned by OPUS-DSD (left panel) and cryoDRGN (right panel). The dots with numbers are cluster centers found by Kmeans algorithm. <bold>c)</bold>. Five classes reconstructed by OPUS-DSD and the corresponding number of particles in each class. <bold>d)</bold>. Five classes reconstructed by cryoDRGN and the corresponding number of particles in each class. <bold>e)</bold>. Density map and gold-standard FSCs for 63,368 particles by combining OPUS-DSD’s Classes 0, 1 and 3. <bold>f)</bold>. Density map and gold-standard FSCs for 68,879 particles by combining cryoDRGN’s Classes 1 ~ 4. <bold>g)</bold>. FSCs for reconstructions after randomly discarding a quarter of 84,530 particles in four parallel trials.</p>
              <p>
                <xref rid="MOESM11" ref-type="media">Source data</xref>
              </p>
            </caption>
            <graphic position="anchor" xlink:href="41592_2023_2031_Fig16_ESM" id="d32e5838"/>
          </fig>
        </p>
      </sec>
    </app>
  </app-group>
  <fn-group>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <sec>
    <sec id="FPar1">
      <title>Extended data</title>
      <p id="Par57">are available for this paper at 10.1038/s41592-023-02031-6.</p>
    </sec>
    <sec id="FPar2" sec-type="supplementary-material">
      <title>Supplementary information</title>
      <p id="Par58">The online version contains supplementary material available at 10.1038/s41592-023-02031-6.</p>
    </sec>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank C. Jia for providing the cryo-EM dataset for the NEXT complex. We also thank the staff at MRICS Cryo-EM Center at Fudan University for their help with data collection. We also acknowledge the open-source software cryoDRGN, upon which OPUS-DSD was built. The research was partially supported by the National Key Research and Development Program of China (No. 2021YFF1200400), and Shanghai Municipal Science and Technology Major Project (No. 2018SHZDZX01) and ZJLab.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>Z.L., Q.W. and J.M. conceived the work. Z.L. designed the algorithm and implemented the software. Z.L. and F.N. performed the experiments. All authors wrote and approved the final paper.</p>
  </notes>
  <notes notes-type="peer-review">
    <title>Peer review</title>
    <sec id="FPar3">
      <title>Peer review information</title>
      <p id="Par59"><italic>Nature Methods</italic> thanks Tim Grant and the other, anonymous, reviewer(s) for their contribution to the peer review of this work. <xref rid="MOESM3" ref-type="media">Peer reviewer reports</xref> are available. Primary Handling Editor: Allison Doerr, in collaboration with the <italic>Nature Methods</italic> team.</p>
    </sec>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>We used the following publicly available datasets: EMPIAR-10180 (structure of a pre-catalytic spliceosome), EMPIAR-10028 (cryo-EM structure of a <italic>Pf</italic>80S ribosome bound to the anti-protozoan drug emetine) and EMPIAR-10002 (<italic>Sc</italic>80S ribosome direct electron detector dataset). Synthetic and real NEXT datasets are deposited in Zenodo at 10.5281/zenodo.8093296 (ref. <sup><xref ref-type="bibr" rid="CR48">48</xref></sup>). Cryo-EM density maps for the real NEXT complex are deposited in the Electron Microscopy DataBank (EMDB) with the accession number EMD-<ext-link ext-link-type="uri" xlink:href="https://www.ebi.ac.uk/pdbe/entry/emdb/EMD-37262">37262</ext-link>. Trained models and heterogeneity analysis results are deposited in Zenodo at 10.5281/zenodo.8143779 (ref. <sup><xref ref-type="bibr" rid="CR49">49</xref></sup>). <xref ref-type="sec" rid="Sec27">Source data</xref> are provided with this paper.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>OPUS-DSD software is deposited in Code Ocean at 10.24433/CO.3046690.v1 (ref. <sup><xref ref-type="bibr" rid="CR50">50</xref></sup>) and is also available at <ext-link ext-link-type="uri" xlink:href="https://github.com/alncat/opusDSD">https://github.com/alncat/opusDSD</ext-link>.</p>
  </notes>
  <notes id="FPar4" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par60">Q.W. is an employee of Harcam Biomedicines who is bound by confidentiality agreements that prevent her from disclosing the competing interests in this work. The other authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <mixed-citation publication-type="other">McCammon, J. A. &amp; Harvey, S. C. <italic>Dynamics of Proteins and Nucleic Acids</italic> (Cambridge Univ. Press, 1988).</mixed-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Glaeser</surname>
            <given-names>RM</given-names>
          </name>
        </person-group>
        <article-title>How good can cryo-EM become?</article-title>
        <source>Nat. Methods</source>
        <year>2016</year>
        <volume>13</volume>
        <fpage>28</fpage>
        <lpage>32</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.3695</pub-id>
        <?supplied-pmid 26716559?>
        <pub-id pub-id-type="pmid">26716559</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Scheres</surname>
            <given-names>SHW</given-names>
          </name>
        </person-group>
        <article-title>A Bayesian view on cryo-EM structure determination</article-title>
        <source>J. Mol. Biol.</source>
        <year>2012</year>
        <volume>415</volume>
        <fpage>406</fpage>
        <lpage>418</lpage>
        <pub-id pub-id-type="doi">10.1016/j.jmb.2011.11.010</pub-id>
        <?supplied-pmid 22100448?>
        <pub-id pub-id-type="pmid">22100448</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cheng</surname>
            <given-names>Y</given-names>
          </name>
        </person-group>
        <article-title>Single-particle cryo-EM at crystallographic resolution</article-title>
        <source>Cell</source>
        <year>2015</year>
        <volume>161</volume>
        <fpage>450</fpage>
        <lpage>457</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2015.03.049</pub-id>
        <?supplied-pmid 25910205?>
        <pub-id pub-id-type="pmid">25910205</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lyumkis</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Brilot</surname>
            <given-names>AF</given-names>
          </name>
          <name>
            <surname>Theobald</surname>
            <given-names>DL</given-names>
          </name>
          <name>
            <surname>Grigorieff</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Likelihood-based classification of cryo-EM images using FREALIGN</article-title>
        <source>J. Struct. Biol.</source>
        <year>2013</year>
        <volume>183</volume>
        <fpage>377</fpage>
        <lpage>388</lpage>
        <pub-id pub-id-type="doi">10.1016/j.jsb.2013.07.005</pub-id>
        <?supplied-pmid 23872434?>
        <pub-id pub-id-type="pmid">23872434</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Scheres</surname>
            <given-names>SHW</given-names>
          </name>
        </person-group>
        <article-title>RELION: implementation of a Bayesian approach to cryo-EM structure determination</article-title>
        <source>J. Struct. Biol.</source>
        <year>2012</year>
        <volume>180</volume>
        <fpage>519</fpage>
        <lpage>530</lpage>
        <pub-id pub-id-type="doi">10.1016/j.jsb.2012.09.006</pub-id>
        <?supplied-pmid 23000701?>
        <pub-id pub-id-type="pmid">23000701</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Nakane</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Kimanius</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Lindahl</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Scheres</surname>
            <given-names>SH</given-names>
          </name>
        </person-group>
        <article-title>Characterisation of molecular motions in cryo-EM single-particle data by multi-body refinement in RELION</article-title>
        <source>eLife</source>
        <year>2018</year>
        <volume>7</volume>
        <fpage>e36861</fpage>
        <pub-id pub-id-type="doi">10.7554/eLife.36861</pub-id>
        <?supplied-pmid 29856314?>
        <pub-id pub-id-type="pmid">29856314</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Punjani</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Fleet</surname>
            <given-names>DJ</given-names>
          </name>
        </person-group>
        <article-title>3D variability analysis: resolving continuous flexibility and discrete heterogeneity from single particle cryo-EM</article-title>
        <source>J. Struct. Biol.</source>
        <year>2021</year>
        <volume>213</volume>
        <fpage>107702</fpage>
        <pub-id pub-id-type="doi">10.1016/j.jsb.2021.107702</pub-id>
        <?supplied-pmid 33582281?>
        <pub-id pub-id-type="pmid">33582281</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <mixed-citation publication-type="other">Gupta, H., Phan, T. H., Yoo, J. &amp; Unser, M. Multi-CryoGAN: reconstruction of continuous conformations in cryo-EM using generative adversarial networks. In <italic>Computer Vision – ECCV 2020 Workshops</italic> (eds Bartoli, A. &amp; Fusiello, A.) 429–444 (ECCV, 2020).</mixed-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Chen</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Ludtke</surname>
            <given-names>SJ</given-names>
          </name>
        </person-group>
        <article-title>Deep learning-based mixed-dimensional Gaussian mixture model for characterizing variability in cryo-EM</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>930</fpage>
        <lpage>936</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-021-01220-5</pub-id>
        <?supplied-pmid 34326541?>
        <pub-id pub-id-type="pmid">34326541</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Punjani</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Fleet</surname>
            <given-names>DJ</given-names>
          </name>
        </person-group>
        <article-title>3D flexible refinement: determining structure and motion of flexible proteins from cryo-EM</article-title>
        <source>Microsc. Microanal.</source>
        <year>2023</year>
        <volume>29</volume>
        <issue>Suppl. 1</issue>
        <fpage>1024</fpage>
        <pub-id pub-id-type="doi">10.1093/micmic/ozad067.518</pub-id>
        <?supplied-pmid 37613218?>
        <pub-id pub-id-type="pmid">37613218</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhong</surname>
            <given-names>ED</given-names>
          </name>
          <name>
            <surname>Bepler</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Berger</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Davis</surname>
            <given-names>JH</given-names>
          </name>
        </person-group>
        <article-title>CryoDRGN: reconstruction of heterogeneous cryo-EM structures using neural networks</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>176</fpage>
        <lpage>185</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-020-01049-4</pub-id>
        <?supplied-pmid 33542510?>
        <pub-id pub-id-type="pmid">33542510</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <mixed-citation publication-type="other">Higgins, I. et al. β-VAE: learning basic visual concepts with a constrained variational framework. In <italic>International Conference on Learning Representations</italic> (ICLR, 2017).</mixed-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <mixed-citation publication-type="other">Kingma, D. P. &amp; Welling, M. Auto-encoding variational Bayes. In <italic>International Conference for Learning Representations</italic> (ICLR, 2014).</mixed-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <mixed-citation publication-type="other">LeCun, Y. &amp; Bengio, Y. Convolutional networks for images, speech, and time series. In <italic>The Handbook of Brain Theory and Neural Networks</italic> (ed. Arbib, M. A.) 255–258 (MIT Press, 1998).</mixed-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ji</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Xu</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Yu</surname>
            <given-names>K</given-names>
          </name>
        </person-group>
        <article-title>3D convolutional neural networks for human action recognition</article-title>
        <source>IEEE Trans. Pattern Anal. Mach. Intell.</source>
        <year>2013</year>
        <volume>35</volume>
        <fpage>221</fpage>
        <lpage>231</lpage>
        <pub-id pub-id-type="doi">10.1109/TPAMI.2012.59</pub-id>
        <?supplied-pmid 22392705?>
        <pub-id pub-id-type="pmid">22392705</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lombardi</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Neural volumes: learning dynamic renderable volumes from images</article-title>
        <source>ACM Trans. Graph.</source>
        <year>2019</year>
        <volume>38</volume>
        <fpage>65</fpage>
        <pub-id pub-id-type="doi">10.1145/3306346.3323020</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <mixed-citation publication-type="other">Jaderberg, M., Simonyan, K., Zisserman, A. &amp; Kavukcuoglu, K. Spatial transformer networks. In <italic>Advances in Neural Information Processing Systems</italic><bold>28</bold> (NeurIPS, 2015).</mixed-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Luo</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Campos-Acevedo</surname>
            <given-names>AA</given-names>
          </name>
          <name>
            <surname>Lv</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Ma</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Sparseness and smoothness regularized imaging for improving the resolution of cryo-EM single-particle reconstruction</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2021</year>
        <volume>118</volume>
        <fpage>e2013756118</fpage>
        <pub-id pub-id-type="doi">10.1073/pnas.2013756118</pub-id>
        <?supplied-pmid 33402531?>
        <pub-id pub-id-type="pmid">33402531</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Plaschka</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Lin</surname>
            <given-names>P-C</given-names>
          </name>
          <name>
            <surname>Nagai</surname>
            <given-names>K</given-names>
          </name>
        </person-group>
        <article-title>Structure of a pre-catalytic spliceosome</article-title>
        <source>Nature</source>
        <year>2017</year>
        <volume>546</volume>
        <fpage>617</fpage>
        <lpage>621</lpage>
        <pub-id pub-id-type="doi">10.1038/nature22799</pub-id>
        <?supplied-pmid 28530653?>
        <pub-id pub-id-type="pmid">28530653</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <mixed-citation publication-type="other">McInnes, L., Healy, J. &amp; Melville, J. UMAP: uniform manifold approximation and projection for dimension reduction. Preprint at <ext-link ext-link-type="uri" xlink:href="https://arxiv.org/abs/1802.03426">https://arxiv.org/abs/1802.03426</ext-link> (2018).</mixed-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Haselbach</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Structure and conformational dynamics of the human spliceosomal Bact complex</article-title>
        <source>Cell</source>
        <year>2018</year>
        <volume>172</volume>
        <fpage>454</fpage>
        <lpage>464</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2018.01.010</pub-id>
        <?supplied-pmid 29361316?>
        <pub-id pub-id-type="pmid">29361316</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wong</surname>
            <given-names>W</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Cryo-EM structure of the <italic>Plasmodium falciparum</italic> 80S ribosome bound to the anti-protozoan drug emetine</article-title>
        <source>eLife</source>
        <year>2014</year>
        <volume>3</volume>
        <fpage>e03080</fpage>
        <pub-id pub-id-type="doi">10.7554/eLife.03080</pub-id>
        <?supplied-pmid 24913268?>
        <pub-id pub-id-type="pmid">24913268</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bai</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Fernandez</surname>
            <given-names>IS</given-names>
          </name>
          <name>
            <surname>McMullan</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Scheres</surname>
            <given-names>SHW</given-names>
          </name>
        </person-group>
        <article-title>Ribosome structures to near-atomic resolution from thirty thousand cryo-EM particles</article-title>
        <source>eLife</source>
        <year>2013</year>
        <volume>2</volume>
        <fpage>e00461</fpage>
        <pub-id pub-id-type="doi">10.7554/eLife.00461</pub-id>
        <?supplied-pmid 23427024?>
        <pub-id pub-id-type="pmid">23427024</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Puno</surname>
            <given-names>MR</given-names>
          </name>
          <name>
            <surname>Lima</surname>
            <given-names>CD</given-names>
          </name>
        </person-group>
        <article-title>Structural basis for MTR4–ZCCHC8 interactions that stimulate the MTR4 helicase in the nuclear exosome-targeting complex</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2018</year>
        <volume>115</volume>
        <fpage>E5506</fpage>
        <lpage>E5515</lpage>
        <pub-id pub-id-type="doi">10.1073/pnas.1803530115</pub-id>
        <?supplied-pmid 29844170?>
        <pub-id pub-id-type="pmid">29844170</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Bai</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Rajendra</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Shi</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Scheres</surname>
            <given-names>SHW</given-names>
          </name>
        </person-group>
        <article-title>Sampling the conformational space of the catalytic subunit of human γ-secretase</article-title>
        <source>eLife</source>
        <year>2015</year>
        <volume>4</volume>
        <fpage>e11182</fpage>
        <pub-id pub-id-type="doi">10.7554/eLife.11182</pub-id>
        <?supplied-pmid 26623517?>
        <pub-id pub-id-type="pmid">26623517</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Chen</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>High-resolution noise substitution to measure overfitting and validate resolution in 3D structure determination by single particle electron cryomicroscopy</article-title>
        <source>Ultramicroscopy</source>
        <year>2013</year>
        <volume>135</volume>
        <fpage>24</fpage>
        <lpage>35</lpage>
        <pub-id pub-id-type="doi">10.1016/j.ultramic.2013.06.004</pub-id>
        <?supplied-pmid 23872039?>
        <pub-id pub-id-type="pmid">23872039</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Punjani</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Fleet</surname>
            <given-names>DJ</given-names>
          </name>
        </person-group>
        <article-title>Non-uniform refinement: adaptive regularization improves single-particle cryo-EM reconstruction</article-title>
        <source>Nat. Methods</source>
        <year>2020</year>
        <volume>17</volume>
        <fpage>1214</fpage>
        <lpage>1221</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-020-00990-8</pub-id>
        <?supplied-pmid 33257830?>
        <pub-id pub-id-type="pmid">33257830</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <mixed-citation publication-type="other">Cohen, T. &amp; Welling, M. Group equivariant convolutional networks. In <italic>Proc. 33rd</italic><italic>International Conference on Machine Learning</italic> (eds Balcan, M. F. &amp; Weinberger, K. Q.) 2990–2999 (PMLR, 2016).</mixed-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Scheres</surname>
            <given-names>SHW</given-names>
          </name>
        </person-group>
        <article-title>Semi-automated selection of cryo-EM particles in RELION-1.3</article-title>
        <source>J. Struct. Biol.</source>
        <year>2015</year>
        <volume>189</volume>
        <fpage>114</fpage>
        <lpage>122</lpage>
        <pub-id pub-id-type="doi">10.1016/j.jsb.2014.11.010</pub-id>
        <?supplied-pmid 25486611?>
        <pub-id pub-id-type="pmid">25486611</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rudin</surname>
            <given-names>LI</given-names>
          </name>
          <name>
            <surname>Osher</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Fatemi</surname>
            <given-names>E</given-names>
          </name>
        </person-group>
        <article-title>Nonlinear total variation based noise removal algorithms</article-title>
        <source>Phys. D Nonlin. Phenom.</source>
        <year>1992</year>
        <volume>60</volume>
        <fpage>259</fpage>
        <lpage>268</lpage>
        <pub-id pub-id-type="doi">10.1016/0167-2789(92)90242-F</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tibshirani</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Regression shrinkage and selection via the lasso</article-title>
        <source>J. R. Stat. Soc. (Methodol.)</source>
        <year>1996</year>
        <volume>58</volume>
        <fpage>267</fpage>
        <lpage>288</lpage>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <mixed-citation publication-type="other">Maas, A. L., Hannun, A. Y. &amp; Ng, A. Y. Rectifier nonlinearities improve neural network acoustic models. In <italic>International Conference on Machine Learning</italic><bold>30</bold>, 3 (ICML, 2013).</mixed-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Goddard</surname>
            <given-names>TD</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>UCSF ChimeraX: meeting modern challenges in visualization and analysis</article-title>
        <source>Protein Sci.</source>
        <year>2018</year>
        <volume>27</volume>
        <fpage>14</fpage>
        <lpage>25</lpage>
        <pub-id pub-id-type="doi">10.1002/pro.3235</pub-id>
        <?supplied-pmid 28710774?>
        <pub-id pub-id-type="pmid">28710774</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Veevers</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Hayward</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Methodological improvements for the analysis of domain movements in large biomolecular complexes</article-title>
        <source>Biophys. Physicobiol.</source>
        <year>2019</year>
        <volume>16</volume>
        <fpage>328</fpage>
        <lpage>336</lpage>
        <pub-id pub-id-type="doi">10.2142/biophysico.16.0_328</pub-id>
        <?supplied-pmid 31984188?>
        <pub-id pub-id-type="pmid">31984188</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rohou</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Grigorieff</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>CTFFIND4: fast and accurate defocus estimation from electron micrographs</article-title>
        <source>J. Struct. Biol.</source>
        <year>2015</year>
        <volume>192</volume>
        <fpage>216</fpage>
        <lpage>221</lpage>
        <pub-id pub-id-type="doi">10.1016/j.jsb.2015.08.008</pub-id>
        <?supplied-pmid 26278980?>
        <pub-id pub-id-type="pmid">26278980</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rosenblatt</surname>
            <given-names>F</given-names>
          </name>
        </person-group>
        <article-title>The perceptron: a probabilistic model for information storage and organization in the brain</article-title>
        <source>Psychol. Rev.</source>
        <year>1958</year>
        <volume>65</volume>
        <fpage>386</fpage>
        <lpage>408</lpage>
        <pub-id pub-id-type="doi">10.1037/h0042519</pub-id>
        <?supplied-pmid 13602029?>
        <pub-id pub-id-type="pmid">13602029</pub-id>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <mixed-citation publication-type="other">Bepler, T., Zhong, E., Kelley, K., Brignole, E. &amp; Berger, B. Explicitly disentangling image content from translation and rotation with spatial-VAE. In <italic>Advances in Neural Information Processing Systems</italic><bold>32</bold> (NeurIPS, 2019).</mixed-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <mixed-citation publication-type="other">Zhong, E. D., Lerer, A., Davis, J. H. &amp; Berger, B. CryoDRGN2: ab initio neural reconstruction of 3D protein structures from real cryo-EM images. In <italic>Proc. IEEE/CVF International Conference on Computer Vision</italic> 4066–4075 (ICCV, 2021).</mixed-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Gorski</surname>
            <given-names>KM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>HEALPix: a framework for high-resolution discretization and fast analysis of data distributed on the sphere</article-title>
        <source>Astrophys. J.</source>
        <year>2005</year>
        <volume>622</volume>
        <fpage>759</fpage>
        <pub-id pub-id-type="doi">10.1086/427976</pub-id>
      </element-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Punjani</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Rubinstein</surname>
            <given-names>JL</given-names>
          </name>
          <name>
            <surname>Fleet</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Brubaker</surname>
            <given-names>MA</given-names>
          </name>
        </person-group>
        <article-title>cryoSPARC: algorithms for rapid unsupervised cryo-EM structure determination</article-title>
        <source>Nat. Methods</source>
        <year>2017</year>
        <volume>14</volume>
        <fpage>290</fpage>
        <lpage>296</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4169</pub-id>
        <?supplied-pmid 28165473?>
        <pub-id pub-id-type="pmid">28165473</pub-id>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <mixed-citation publication-type="other">Kingma, D. P. &amp; Ba, J. Adam: a method for stochastic optimization. In <italic>International Conference for Learning Representations</italic> (ICLR, 2015).</mixed-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <mixed-citation publication-type="other">Paszke, A. et al. PyTorch: an imperative style, high-performance deep learning library. In <italic>Advances in Neural Information Processing Systems</italic><bold>32</bold> (NeurIPS, 2019).</mixed-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <mixed-citation publication-type="other">Fu, H. et al. Cyclical annealing schedule: a simple approach to mitigating KL vanishing. In <italic>Proc. 2019 Conference of</italic><italic>the North American Chapter of the Association for Computational Linguistics: Human Language Technologies, Volume 1 (Long and Short Papers)</italic> (eds Burstein, J. et al) 240–250 (Association for Computational Linguistics, 2019).</mixed-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lloyd</surname>
            <given-names>SP</given-names>
          </name>
        </person-group>
        <article-title>Least squares quantization in PCM</article-title>
        <source>IEEE Trans. Inf. Theory</source>
        <year>1982</year>
        <volume>28</volume>
        <fpage>129</fpage>
        <lpage>137</lpage>
        <pub-id pub-id-type="doi">10.1109/TIT.1982.1056489</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Pedregosa</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Scikit-learn: machine learning in Python</article-title>
        <source>J. Mach. Learn. Res.</source>
        <year>2011</year>
        <volume>12</volume>
        <fpage>2825</fpage>
        <lpage>2830</lpage>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Pettersen</surname>
            <given-names>EF</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>UCSF Chimera: a visualization system for exploratory research and analysis</article-title>
        <source>J. Comput. Chem.</source>
        <year>2004</year>
        <volume>25</volume>
        <fpage>1605</fpage>
        <lpage>1612</lpage>
        <pub-id pub-id-type="doi">10.1002/jcc.20084</pub-id>
        <?supplied-pmid 15264254?>
        <pub-id pub-id-type="pmid">15264254</pub-id>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <mixed-citation publication-type="other">Luo, Z., Ni, F., Wang, Q. &amp; Ma, J. Data for ‘OPUS-DSD: deep structural disentanglement for cryo-EM single particle analysis’. <italic>Zenodo</italic>10.5281/zenodo.8093296 (2023).</mixed-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <mixed-citation publication-type="other">Luo, Z., Ni, F., Ma, J. &amp; Wang, Q. Results for ‘OPUS-DSD: deep structural disentanglement for cryo-EM single particle analysis’. <italic>Zenodo</italic>10.5281/zenodo.8143779 (2023).</mixed-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <mixed-citation publication-type="other">Luo, Z. OPUS-DSD: version 1.0.0. <italic>Code Ocean</italic>10.24433/CO.3046690.v1 (2023).</mixed-citation>
    </ref>
  </ref-list>
</back>
