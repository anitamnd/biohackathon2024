<?DTDIdentifier.IdentifierValue article.dtd?>
<?DTDIdentifier.IdentifierType system?>
<?SourceDTD.DTDName article.dtd?>
<?SourceDTD.Version 1.0?>
<?ConverterInfo.XSLTName bmc2nlmx2.xsl?>
<?ConverterInfo.Version 2?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">BMC Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">BMC Bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>BMC Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="epub">1471-2105</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">3582611</article-id>
    <article-id pub-id-type="publisher-id">1471-2105-13-316</article-id>
    <article-id pub-id-type="pmid">23181553</article-id>
    <article-id pub-id-type="doi">10.1186/1471-2105-13-316</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Software</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>TeraStitcher - A tool for fast automatic 3D-stitching of teravoxel-sized microscopy images</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" corresp="yes" id="A1">
        <name>
          <surname>Bria</surname>
          <given-names>Alessandro</given-names>
        </name>
        <xref ref-type="aff" rid="I1">1</xref>
        <xref ref-type="aff" rid="I2">2</xref>
        <email>a.bria@alice.it</email>
      </contrib>
      <contrib contrib-type="author" id="A2">
        <name>
          <surname>Iannello</surname>
          <given-names>Giulio</given-names>
        </name>
        <xref ref-type="aff" rid="I1">1</xref>
        <email>g.iannello@unicampus.it</email>
      </contrib>
    </contrib-group>
    <aff id="I1"><label>1</label>Center of Integrated Research, University Campus Bio-Medico di Roma, v. Alvaro del Portillo 21, 00128 Roma (RM), Italy</aff>
    <aff id="I2"><label>2</label>Department of Electrical and Information Engineering, University of Cassino and L.M., v. Di Biasio 43, 03043 Cassino (FR), Italy</aff>
    <pub-date pub-type="collection">
      <year>2012</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>27</day>
      <month>11</month>
      <year>2012</year>
    </pub-date>
    <volume>13</volume>
    <fpage>316</fpage>
    <lpage>316</lpage>
    <history>
      <date date-type="received">
        <day>17</day>
        <month>8</month>
        <year>2012</year>
      </date>
      <date date-type="accepted">
        <day>6</day>
        <month>11</month>
        <year>2012</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>Copyright ©2012 Bria and Iannello; licensee BioMed Central Ltd.</copyright-statement>
      <copyright-year>2012</copyright-year>
      <copyright-holder>Bria and Iannello; licensee BioMed Central Ltd.</copyright-holder>
      <license license-type="open-access" xlink:href="http://creativecommons.org/licenses/by/2.0">
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/2.0">http://creativecommons.org/licenses/by/2.0</ext-link>), which permits unrestricted use, distribution, and reproduction in any medium, provided the original work is properly cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="http://www.biomedcentral.com/1471-2105/13/316"/>
    <abstract>
      <sec>
        <title>Background</title>
        <p>Further advances in modern microscopy are leading to teravoxel-sized tiled 3D images at high resolution, thus increasing the dimension of the stitching problem of at least two orders of magnitude. The existing software solutions do not seem adequate to address the additional requirements arising from these datasets, such as the minimization of memory usage and the need to process just a small portion of data.</p>
      </sec>
      <sec>
        <title>Results</title>
        <p>We propose a free and fully automated 3D Stitching tool designed to match the special requirements coming out of teravoxel-sized tiled microscopy images that is able to stitch them in a reasonable time even on workstations with limited resources. The tool was tested on teravoxel-sized whole mouse brain images with micrometer resolution and it was also compared with the state-of-the-art stitching tools on megavoxel-sized publicy available datasets. This comparison confirmed that the solutions we adopted are suited for stitching very large images and also perform well on datasets with different characteristics. Indeed, some of the algorithms embedded in other stitching tools could be easily integrated in our framework if they turned out to be more effective on other classes of images. To this purpose, we designed a software architecture which separates the strategies that use efficiently memory resources from the algorithms which may depend on the characteristics of the acquired images.</p>
      </sec>
      <sec>
        <title>Conclusions</title>
        <p>TeraStitcher is a free tool that enables the stitching of Teravoxel-sized tiled microscopy images even on workstations with relatively limited resources of memory (&lt;8 GB) and processing power. It exploits the knowledge of approximate tile positions and uses ad-hoc strategies and algorithms designed for such very large datasets. The produced images can be saved into a multiresolution representation to be efficiently retrieved and processed. We provide TeraStitcher both as standalone application and as plugin of the free software Vaa3D.</p>
      </sec>
    </abstract>
    <kwd-group>
      <kwd>Stitching</kwd>
      <kwd>3D images</kwd>
      <kwd>Teravoxel-sized images</kwd>
      <kwd>Microscopy</kwd>
      <kwd>Brain imaging</kwd>
    </kwd-group>
  </article-meta>
</front>
<body>
  <sec>
    <title>Background</title>
    <sec>
      <title>Advances in microscopy technologies</title>
      <p>The recent advances in modern microscopy enable three-dimensional imaging of large biological specimens at high resolution. Often, the sample is too large to fit into the field of view of the microscope, so that a combination of multiple overlapping recordings (<italic>tiles</italic>) is needed to enable the reconstruction (<italic>stitching</italic>) of the whole image from the individual image stacks. Software 3D-Stitching tools are needed to assemble tiles since in many cases reliable tile positions are not available. This is true also when motorized stages are used for fast and reproducible acquisition of multiple tiles, since their physical coordinates may not be precise enough to allow direct reconstruction.</p>
      <p>Current microscopy technology can easily require image reconstructions starting from tens of tiles, each with sizes ranging from tens of megavoxels (e.g. 1024×1024×64) to hundreds of megavoxels (e.g. 2048×2048×128). Several stitching tools have been therefore recently developed to deal with such a challenging task, and successful stitching of 3D images of these orders of magnitude has been reported in the literature [<xref ref-type="bibr" rid="B1">1</xref>-<xref ref-type="bibr" rid="B3">3</xref>].</p>
      <p>However, the growing demand to acquire complete and large biological specimens at high resolution has lead to further advances in microscopy. In particular, the class of microscopes based on the technique commonly referred to as ultramicroscopy or light sheet-based microscopy (LSM) [<xref ref-type="bibr" rid="B4">4</xref>] enables fast three-dimensional high resolution imaging of large specimens exploiting their induced fluorescence. Samples are illuminated by a thin sheet of light and the fluorescence emission is observed from the axis (scanning axis) perpendicular to the illumination plane. Objects are then translated along the scanning axis, so obtaining a tile as a stack of 2D slices [<xref ref-type="bibr" rid="B5">5</xref>]. Combining this technique with a special procedure to clear tissue makes it possible to acquire large specimens, such as whole mouse brains [<xref ref-type="bibr" rid="B6">6</xref>]. Recently, at LENS in Florence, it has been developed an improved LSM technique, referred to in the following as <italic>Confocal Light Sheet Microscopy</italic> (briefly CLSM), which is capable of imaging very large volumes (∼cm<sup>3</sup>) with good enough contrast and resolution (∼1 <italic>μ</italic>m) to be used for neuroanatomical studies on the whole mouse brain [<xref ref-type="bibr" rid="B7">7</xref>]. Since a typical field of view of the objective is ≈400×400<italic>μ</italic><italic>m</italic><sup>2</sup> and dimensions of each raw image may be 512×512 pixels, at least 25×25 tiles are needed to cover the whole volume, each composed by 10.000 slices. Actually, the number of tiles is substantially higher, since acquiring overlapped tiles is necessary to enable automatic and very precise stitching. This increases the dimension of the stitching problem of at least two orders of magnitude, leading to acquisitions of hundreds of large tiles and final image sizes ranging from hundreds of gigavoxels to one teravoxel and more.</p>
    </sec>
    <sec>
      <title>Characteristics of teravoxel-sized datasets</title>
      <p>To make acquisitions of such large images viable, computer controlled micropositioning stages must be used to acquire tiles arranged according to a bidimensional grid. Tiles physical coordinates can therefore be recorded during acquisition. Due to the range of movements in each dimension (∼cm), even very small mechanical drifts might make these coordinates not precise enough to enable direct reconstruction of the image. Nevertheless, they can definitely allow a precise control over the overlap between adjacent tiles and the <italic>a posteriori</italic> determination of the Region Of Interest (ROI) for each tile where the overlap occurs.</p>
      <p>With respect to the image content there are two problems that are relevant to stitching. First, images may contain thin structures that are just larger than the resolution of the microscope, which makes mandatory to perform the stitching with high precision to avoid artifacts due to misalignments of a few pixels. Second, since specimens can be selectively labeled with fluorescent markers, regions with very limited or none information content may occur in the acquired volume. Since these regions do not contain useful alignment information, the stitching algorithm should be capable to deal with them.</p>
    </sec>
    <sec>
      <title>Current software solutions</title>
      <p>Different solutions and tools are available for automatic 3D Stitching of large images [<xref ref-type="bibr" rid="B1">1</xref>-<xref ref-type="bibr" rid="B3">3</xref>]. Their common strategy is the following: (i) performing a pairwise registration through a combination of Phase Correlation (PC) and Normalized Cross-Correlation (NCC), both of which provide an image similarity score, but with different computational requirements and performance, so that NCC is generally used to refine the PC results; (ii) finding a globally optimal placement of tiles using similarity scores; (iii) combining all tiles in a larger image, while correcting lighting differences in the overlapping regions.</p>
      <p>Existing 3D-Stitching tools do not seem adequate to address the Stitching of teravoxel-sized datasets because they were designed under the following major assumptions, which are related to the common characteristics of modern high-resolution imaging techniques such as Confocal, Bright field or Electron microscopes. First, the specimen can be very large along the two radial directions only, whereas the extension along the scanning direction is much more limited. This implies that there are at most hundreds of slices per tile instead of thousands. Second, the number of tiles is limited and their spatial placement can be either organized (i.e. prior knowledge of tiles coordinates is available and at least partially reliable) or un-organized (i.e. prior knowledge of tiles coordinates is missing or unreliable). Note that in the latter case, step (i) must be performed for all possible pairs of tiles making the task computationally tractable only if the number of tiles is limited. Finally, as a consequence of previous assumptions, the overall size of datasets can vary from hundreds of megavoxels up to a few gigavoxels.</p>
      <p>For these reasons, the typical stitching tool today addresses some, but not all of the aspects of teravoxel-sized datasets.</p>
    </sec>
    <sec>
      <title>Software design considerations and requirements</title>
      <p>Moving from the considerations discussed so far we give the following general requirements for a stitiching tool capable to deal with teravoxels-sized images.</p>
    </sec>
    <sec>
      <title>(I) Stitching processing pipeline</title>
      <p>Similarly to other state-of-the-art tools, the stitching process has to perform the following main steps: (i) find the relative position between each pair of adjacent stacks (in fact, since in our case tiles are parallel along the axis direction, there are no rotations, and this simply means to find the displacement between them); (ii) find a globally optimal placement of stacks in the final image space; (iii) combine all stacks into a single 3D image and substitute overlapping regions with a blended version of them.</p>
      <p>To effectively deal with the huge dimensions of this class of images one more step to be added is the saving of the resulting 3D image into a multiresolution representation suited for efficient image retrieval and processing.</p>
    </sec>
    <sec>
      <title>(II) Minimization of the overall computational workload</title>
      <p>The computational complexity and memory requirements of the algorithms that process tiles should be minimized, while at the same time multiple I/O operations on the same data should be avoided. Since dataset dimensions is expected to further grow as long as microscope techniques develop their potentials, all algorithms, including for what is concerned with I/O operations, should also be parallelizable to make the whole process scalable.</p>
    </sec>
    <sec>
      <title>(III) Identification of indices measuring the alignment quality</title>
      <p>Since there may be portions of the volume with scarce or none information content, some of the computed displacements at step (i) may be wrong. This produces a redundant set of alignment data of different quality, which should be associated to some quality index and then globally composed minimizing a measure of the overall error.</p>
    </sec>
    <sec>
      <title>(IV) Manual intervention</title>
      <p>When dealing with images with hundreds of tiles, a few wrong computed alignments are likely to occur since thresholds used by the algorithms to deal with alignment quality indices may fail in some cases. In these cases, even if only very few stacks were incorrectly stitched, the entire stitching pipeline should be repeated from the beginning with different settings or the introduced artifacts accepted. In order to avoid this situation, the user should be able to intervene manually by easily detecting and possibly correcting the abnormalities before the final image is produced. To make this possible, stitching steps should be separable thanks to a loading/saving feature for metadata describing their results, which the user should easily edit. A preview-like feature should also be provided to check the effectiveness of the manual intervention on a limited portion of the acquired volume, without processing again all data from scratch.</p>
    </sec>
    <sec>
      <title>(V) Independence of sophisticated content-based analysis of the images</title>
      <p>The stitching process should not depend on sophisticated content-based analysis of the raw images, which is likely to generate too much computational workload on very large datasets. In practice, all algorithms should depend at most linearly on the dataset size. Analyses requiring more than linear algorithms, if any, should be performed on limited regions of the acquired volume, and only after a nonredundant, easy to access representation of the whole 3D image has been generated.</p>
    </sec>
    <sec>
      <title>(VI) Expandability</title>
      <p>Given the wide variety of images in microscopy and the concrete possibility that new techniques will be soon developed to acquire teravoxel-sized datasets, it may be expected that modified, customized or totally new algorithms will be needed in some of all steps of the stitching process. Hence, it is essential that the software structure of the stitching tool provides means for incorporating new capabilities.</p>
    </sec>
  </sec>
  <sec>
    <title>Implementation</title>
    <sec>
      <title>Architecture</title>
      <p>As reported in Figure <xref ref-type="fig" rid="F1">1</xref>, the TeraStitcher tool is structured in a stepwise fashion according to requirement (I). First, a preliminary step that imports data organization is necessary to access data properly and efficiently in subsequent steps. We assume raw data arranged as a tile matrix whose dimensions will be referred to as <italic>vertical</italic> (<italic>V</italic>) and <italic>horizontal</italic> (<italic>H</italic>). Data are stored according to a two-level hierarchical structure where, at the first level, directories contain all tiles of a row or of a column and at the second level directories contain the tile corresponding to that row or column, stored as a sequence of slice images disposed along the <italic>depth</italic> (<italic>D</italic> in the following) direction. This allows us to load just a small portion of data at the time, which is a necessary condition for requirement (II). Note also that directory names and image files names convey the information about tile and slice positions as provided by the controlling software of the microscope, so that this information can be extracted in the import step and used whenever required. Second, the <italic>Pairwise stacks displacements computation</italic> step produces a redundant set of alignment data with associated reliability measures, according to requirement (III). Both redundancy and reliability measures are exploited to select the most reliable displacement for each pair of adjacent stacks (<italic>Displacements projection</italic>), to discard the unreliable displacements (<italic>Displacements thresholding</italic>) and to find an optimal placement of tiles (<italic>Optimal tiles placement</italic>) before merging tiles into a multiresolution representation. The details of each step are discussed in section Algorithms. Third, most steps produce metadata describing their results and/or use these metadata to perform their tasks. At each step, metadata are saved in XML files which the user can edit to manually refine displacements, tile coordinates or other stitching metadata, according to requirement (IV). The details of this approach are given in section Manual intervention.</p>
      <fig id="F1" position="float">
        <label>Figure 1</label>
        <caption>
          <p><bold>The stitching pipeline.</bold> The central column lists both automatic and optional manual steps that compose the pipeline. For each automatic step are shown alongside the corresponding command line arguments as well as their values used in a sample workflow. The left column shows the metadata flow and the most significant portions of XML files for each step. On the right column there are some figures illustrating the elaboration of both data and metadata and the number of data readings and writings. The figure which illustrates the manual refinement after the <italic>Displacements thresholding</italic> step was obtained by using the MATLAB scripts we provide for a more comprehensive analysis of metadata. Stitchable stacks are marked in blue (dark grey) and non stitchable ones are marked in yellow (light grey).</p>
        </caption>
        <graphic xlink:href="1471-2105-13-316-1"/>
      </fig>
      <p>In order to satisfy the expandability requirement (VI), we followed an object-oriented approach in designing the software architecture of our tool. It consists of four modules organized in three layers with growing abstraction levels (see Figure <xref ref-type="fig" rid="F2">2</xref>). At the lowest abstraction level, the <italic>IOManager</italic> and <italic>XML</italic> modules contain input/output routines for data and metadata, respectively. The middle layer contains the <italic>VolumeManager</italic> module, which is responsible to model data organization and to access both data and metadata through functionalities provided by the lower layer. At the top layer, the <italic>Stitcher</italic> module implements the stitching pipeline.</p>
      <fig id="F2" position="float">
        <label>Figure 2</label>
        <caption>
          <p><bold>The software architecture of TeraStitcher.</bold> The architecture of the proposed TeraStitcher tool is composed by four modules organized in three layers with growing abstraction levels. At the lowest abstraction level, the <italic>IOManager</italic> and <italic>XML</italic> modules contain input/output routines for data and metadata, respectively. The middle layer contains the <italic>VolumeManager</italic> module, which is responsible to model data organization and to access both data and metadata through functionalities provided by the lower layer. At the top layer, the <italic>Stitcher</italic> module implements the stitching pipeline.</p>
        </caption>
        <graphic xlink:href="1471-2105-13-316-2"/>
      </fig>
      <p>Let us have a look inside the <italic>Stitcher</italic> module, which is critical when considering the expandability and generality requirements of our tool. The internal structure of <italic>Stitcher</italic> is shown in Figure <xref ref-type="fig" rid="F3">3</xref>. <italic>Stitcher</italic> methods implement the stitching pipeline of Figure <xref ref-type="fig" rid="F1">1</xref> and the corresponding strategies to use efficiently system resources. Two design patterns, <italic>Strategy</italic> and <italic>Abstract Factory</italic>[<xref ref-type="bibr" rid="B8">8</xref>], are used to create a layer of interfaces separating <italic>Stitcher</italic>’s strategies from the actual algorithms and data structures, respectively, since these may depend on the specific characteristics of the acquired images. <italic>Strategy</italic> lets the user determine at runtime which <italic>PairwiseDisplAlgo</italic> and <italic>TilesPlacementAlgo</italic> algorithms should be used, whereas <italic>Abstract Factory</italic> lets a <italic>PairwiseDisplAlgo</italic> produce its own <italic>Displacement</italic>. A concrete subclass of <italic>Displacement</italic> should provide not only spatial information (i.e. the relative position of adjacent tiles), but also one or more displacement reliability measures tailored to the adopted alignment strategy, with values between 0 (totally unreliable displacement) and 1 (reliable displacement). In addition, its <italic>project</italic>(<italic>displ</italic>) and <italic>threshold</italic>(<italic>thres</italic>) methods should use these reliability measures to implement the <italic>Displacement projection</italic> and <italic>Displacement thresholding</italic> steps respectively, as explained in more detail in section Algorithms. So, new implementations of steps 3-6 of the stitching pipeline can easily be embedded within this framework by implementing at most three class interfaces.</p>
      <fig id="F3" position="float">
        <label>Figure 3</label>
        <caption>
          <p><bold>Class diagrams of </bold><bold><italic>VolumeManager </italic></bold><bold>and </bold><bold><italic>Stitcher </italic></bold><bold>modules.</bold> A <italic>StackedVolume</italic> contains as many <italic>Stack</italic> objects as the number of stacks that compose the volume and it is responsible to model data organization. The <italic>Stitcher</italic> methods implement the stitching pipeline and the strategies to use efficiently system resources, by accessing data through the <italic>StackedVolume</italic>. These strategies use the algorithms <italic>TilesPlacementAlgo</italic> and <italic>PairwiseDisplAlgo</italic> that may depend on the specific characteristics of images. Note that <italic>TilesPlacementAlgo</italic> uses <italic>Displacement</italic>s produced by <italic>PairwiseDisplAlgo</italic>. Classes <italic>MST</italic>, <italic>MIP-NCC</italic>, and <italic>MIP-NCC-Displacement</italic> implement the actual algorithms used in our implementation.</p>
        </caption>
        <graphic xlink:href="1471-2105-13-316-3"/>
      </fig>
    </sec>
    <sec>
      <title>Algorithms</title>
      <sec>
        <title>Pairwise stacks displacement computation</title>
        <p>To compute the relative position of a pair of tiles (<italic>Pairwise stacks displacements computation</italic> step) we adopted a multi-MIP-NCC approach (see Figure <xref ref-type="fig" rid="F4">4</xref>). Tiles are split along the <italic>D</italic> direction into substacks of <italic>n</italic><sub><italic>slices</italic></sub> slices, where the parameter <italic>n</italic><sub><italic>slices</italic></sub> can be set by the user with typical values in the range [ 100,200]. For each couple of homologous substacks of two adjacent tiles, the overlapping regions are identified using tile positions provided by the instrument. The information contained in these regions is condensed in three 2D images computed as maximum intensity projections (MIPs) along the three dimensions. Then a 2D-NCC map is computed for each of the three pairs of MIPs in a search region of side 2<italic>δ</italic><sub><italic>search</italic></sub> + 1 pixels centered on the central pixel of the overlapping regions. In this way, two displacements corresponding to NCC peaks are obtained for each direction, for a total of 6 displacements. The most reliable displacement for each direction is then selected and memorized using a combination of two reliability measures extracted from the NCC maps. These measures are the NCC peak value (the higher, the more reliable) and the NCC shape width of the peak (the smaller, the more reliable). The informations collected so far are stored in a <italic>MIP-NCC-Displ</italic> object (see Figure <xref ref-type="fig" rid="F3">3</xref>). Note that pairs of substacks are aligned separately, producing a redundant set of alignment data for each pair of adjacent tiles. Such a redundancy is exploited in the <italic>Displacement projection</italic> step, as explained below.</p>
        <fig id="F4" position="float">
          <label>Figure 4</label>
          <caption>
            <p><bold>Multi-MIP-NCC method.</bold> Each tile is split along the <italic>D</italic> direction into substacks of <italic>n</italic><sub><italic>slices</italic></sub>slices. For each couple of adjacent substacks, three MIPs along the three directions are extracted from the overlapping regions. Then a 2D-NCC map is computed for each pair of homologous MIPs, so obtaining two displacements for each direction. Two reliability measures extracted from the NCC map are used to select for each direction the best of the two available displacements.</p>
          </caption>
          <graphic xlink:href="1471-2105-13-316-4"/>
        </fig>
        <p>Besides the relevant reduction in memory occupancy memory requirements reduction, which is discussed in section Strategies to limit resource requirements, there are two reasons for dividing tiles into substacks. First, since multi-MIP-NCC is based on MIP projections, it works well if the information content of the overlapping regions in not too dense. Hence, it could perform poorly if applied to whole stacks, whose MIPs along the <italic>D</italic> direction could accumulate too much information. Second, working on a few relatively small 2D matrices at the time allows an efficient use of the memory hierarchy. The only minor drawback is a small increase in computational workload, since multiple NCC maps have to be computed along <italic>D</italic>.</p>
      </sec>
      <sec>
        <title>Displacement projection</title>
        <p>Once all substacks of one tile have been aligned with their adjacent homologous, the obtained displacements are combined to give the best displacement for each pair of adjacent tiles. Such a combination is implemented in the <italic>project</italic>(<italic>..</italic>) method of <italic>MIP-NCC-Displ</italic> class and it is done by selecting, for each direction separately, the most reliable single direction displacement. This is possible because each single direction displacement has its own reliability measures, thanks to the adopted <italic>MIP-NCC</italic> approach. Note that, even if independent reliability measures were not available for each direction, one could still select the most reliable displacement among the ones computed for every substack. In any case, multiple substacks alignments provide an advantage, since substacks difficult to stitch are likely to occur.</p>
        <p>It is worth noting that having multiple substacks alignments could also be used to cope with situations where different reliable alignments in <italic>V</italic> and <italic>H</italic> directions are returned by the MIP-NCC algorithm. This would correspond to acquisitions where sample movements in <italic>D</italic> direction where not perfectly parallel and tiles should be someway rearranged before merging. While on the one hand this would require tile resampling with a remarkable increase in computational costs, on the other hand we did not actually observe such shifts along the <italic>D</italic> direction in our acquisitions. For this reasons the tool uses just one displacement (the best in every direction) to align adjacent tiles.</p>
      </sec>
      <sec>
        <title>Displacement thresholding</title>
        <p>After the best displacements have been obtained, their reliability is thresholded: when it is below the given threshold, the default displacement provided by stage coordinates is reestablished and the corresponding reliability measure is set to 0 (totally unreliable). Furthermore, the associated pair of stacks is marked as a <italic>nonstitchable</italic> pair. If all the four pairs associated with a tile are nonstitchable, then the tile itself is marked as nonstitchable, i.e. there’s no way to stitch it to any other stacks, except of using the tile position estimation provided by the instrument. This information is taken into account in the next step.</p>
        <p>We observed from different datasets that good candidate values for displacement threshold are in the range [ 0.7,0.8], as also suggested by the results reported in Table <xref ref-type="table" rid="T1">1</xref>. However, we do not exclude that in the case of low-contrasted or high noisy data these values could be lower.</p>
        <table-wrap position="float" id="T1">
          <label>Table 1</label>
          <caption>
            <p>Comparison of displacements errors and quality measures among different datasets</p>
          </caption>
          <table frame="hsides" rules="groups" border="1">
            <colgroup>
              <col/>
              <col/>
              <col/>
              <col/>
              <col/>
              <col/>
              <col/>
              <col/>
              <col/>
              <col/>
              <col/>
              <col/>
              <col/>
              <col/>
            </colgroup>
            <thead valign="top">
              <tr>
                <th align="left" valign="bottom">
                  <bold>Dataset</bold>
                  <hr/>
                </th>
                <th align="center" valign="bottom">
                  <bold>Tool</bold>
                  <hr/>
                </th>
                <th colspan="6" align="center" valign="bottom">
                  <bold>Error</bold>
                  <hr/>
                </th>
                <th colspan="6" align="center" valign="bottom">
                  <bold>Quality measure</bold>
                  <hr/>
                </th>
              </tr>
              <tr>
                <th align="left" valign="bottom"> <hr/></th>
                <th align="left" valign="bottom"> <hr/></th>
                <th colspan="3" align="center" valign="bottom">
                  <bold>Max</bold>
                  <hr/>
                </th>
                <th colspan="3" align="center" valign="bottom">
                  <bold>Average</bold>
                  <hr/>
                </th>
                <th colspan="3" align="center" valign="bottom">
                  <bold>Min</bold>
                  <hr/>
                </th>
                <th colspan="3" align="center" valign="bottom">
                  <bold>Average</bold>
                  <hr/>
                </th>
              </tr>
              <tr>
                <th align="left"> </th>
                <th align="left"> </th>
                <th align="center">
                  <bold>V</bold>
                </th>
                <th align="center">
                  <bold>H</bold>
                </th>
                <th align="center">
                  <bold>D</bold>
                </th>
                <th align="center">
                  <bold>V</bold>
                </th>
                <th align="center">
                  <bold>H</bold>
                </th>
                <th align="center">
                  <bold>D</bold>
                </th>
                <th align="center">
                  <bold>V</bold>
                </th>
                <th align="center">
                  <bold>H</bold>
                </th>
                <th align="center">
                  <bold>D</bold>
                </th>
                <th align="center">
                  <bold>V</bold>
                </th>
                <th align="center">
                  <bold>H</bold>
                </th>
                <th align="center">
                  <bold>D</bold>
                </th>
              </tr>
            </thead>
            <tbody valign="top">
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">TeraStitcher<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0.86<hr/></td>
                <td align="center" valign="bottom">0.85<hr/></td>
                <td align="center" valign="bottom">0.86<hr/></td>
                <td align="center" valign="bottom">0.87<hr/></td>
                <td align="center" valign="bottom">0.87<hr/></td>
                <td align="center" valign="bottom">0.88<hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">Fiji<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.51<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.63<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom">C. elegans worm<sup>a</sup><hr/></td>
                <td align="center" valign="bottom">XuvStitch<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.72<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.78<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">iStitch<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.94<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.95<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">TeraStitcher<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0.79<hr/></td>
                <td align="center" valign="bottom">0.80<hr/></td>
                <td align="center" valign="bottom">0.64<hr/></td>
                <td align="center" valign="bottom">0.81<hr/></td>
                <td align="center" valign="bottom">0.83<hr/></td>
                <td align="center" valign="bottom">0.73<hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">Fiji<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.55<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.58<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom">Neuron filaments<sup>a</sup><hr/></td>
                <td align="center" valign="bottom">XuvStitch<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.67<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.76<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">iStitch<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">1<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0.3<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.90<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.92<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">TeraStitcher<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0.81<hr/></td>
                <td align="center" valign="bottom">0.88<hr/></td>
                <td align="center" valign="bottom">0.75<hr/></td>
                <td align="center" valign="bottom">0.88<hr/></td>
                <td align="center" valign="bottom">0.92<hr/></td>
                <td align="center" valign="bottom">0.76<hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">Fiji<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">1<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">1<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom">Fruit fly brain<sup>b</sup><hr/></td>
                <td align="center" valign="bottom">XuvStitch<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">1<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">1<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">iStitch<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.95<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.96<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">TeraStitcher<hr/></td>
                <td align="center" valign="bottom">1<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">1<hr/></td>
                <td align="center" valign="bottom">0.5<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0.5<hr/></td>
                <td align="center" valign="bottom">0.71<hr/></td>
                <td align="center" valign="bottom">0.68<hr/></td>
                <td align="center" valign="bottom">0.53<hr/></td>
                <td align="center" valign="bottom">0.73<hr/></td>
                <td align="center" valign="bottom">0.7<hr/></td>
                <td align="center" valign="bottom">0.61<hr/></td>
              </tr>
              <tr>
                <td rowspan="2" align="left" valign="bottom">Portion of mouse cerebellum<sup>c</sup> (axons)<hr/></td>
                <td align="center" valign="bottom">Fiji<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.72<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.73<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="center" valign="bottom">XuvStitch<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.2<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.31<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">iStitch<hr/></td>
                <td align="center" valign="bottom">7<hr/></td>
                <td align="center" valign="bottom">1<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">3.5<hr/></td>
                <td align="center" valign="bottom">0.5<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.95<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.96<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">TeraStitcher<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0.84<hr/></td>
                <td align="center" valign="bottom">0.85<hr/></td>
                <td align="center" valign="bottom">0.87<hr/></td>
                <td align="center" valign="bottom">0.87<hr/></td>
                <td align="center" valign="bottom">0.87<hr/></td>
                <td align="center" valign="bottom">0.89<hr/></td>
              </tr>
              <tr>
                <td rowspan="2" align="left" valign="bottom">Portion of mouse brain<sup>c</sup> (neurons and axons)<hr/></td>
                <td align="center" valign="bottom">Fiji<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.77<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.80<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="center" valign="bottom">XuvStitch<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.90<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.91<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">iStitch<hr/></td>
                <td align="center" valign="bottom">w.a.<sup>d</sup><hr/></td>
                <td align="center" valign="bottom">w.a.<hr/></td>
                <td align="center" valign="bottom">w.a.<hr/></td>
                <td align="center" valign="bottom">w.a.<hr/></td>
                <td align="center" valign="bottom">w.a.<hr/></td>
                <td align="center" valign="bottom">w.a.<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.76<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.78<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">TeraStitcher<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0.76<hr/></td>
                <td align="center" valign="bottom">0.77<hr/></td>
                <td align="center" valign="bottom">0.6<hr/></td>
                <td align="center" valign="bottom">0.8<hr/></td>
                <td align="center" valign="bottom">0.84<hr/></td>
                <td align="center" valign="bottom">0.75<hr/></td>
              </tr>
              <tr>
                <td rowspan="2" align="left" valign="bottom">Whole mouse cerebellum<sup>c</sup> (Purkinje cells and axons)<hr/></td>
                <td align="center" valign="bottom">Fiji<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.78<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.85<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="center" valign="bottom">XuvStitch<hr/></td>
                <td align="center" valign="bottom">3<hr/></td>
                <td align="center" valign="bottom">3<hr/></td>
                <td align="center" valign="bottom">2<hr/></td>
                <td align="center" valign="bottom">0.8<hr/></td>
                <td align="center" valign="bottom">0.8<hr/></td>
                <td align="center" valign="bottom">1<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.75<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.87<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">iStitch<hr/></td>
                <td align="center" valign="bottom">1<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0.2<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.92<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.94<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">TeraStitcher<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0.77<hr/></td>
                <td align="center" valign="bottom">0.75<hr/></td>
                <td align="center" valign="bottom">0.74<hr/></td>
                <td align="center" valign="bottom">0.77<hr/></td>
                <td align="center" valign="bottom">0.77<hr/></td>
                <td align="center" valign="bottom">0.75<hr/></td>
              </tr>
              <tr>
                <td rowspan="2" align="left" valign="bottom">Whole mouse brain<sup>c</sup> (neurons and axons)<hr/></td>
                <td align="center" valign="bottom">Fiji<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.37<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.39<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="center" valign="bottom">XuvStitch<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom">0<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.6<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
                <td align="center" valign="bottom">0.65<hr/></td>
                <td align="center" valign="bottom"> <hr/></td>
              </tr>
              <tr>
                <td align="left"> </td>
                <td align="center">iStitch</td>
                <td align="center">0</td>
                <td align="center">0</td>
                <td align="center">0</td>
                <td align="center">0</td>
                <td align="center">0</td>
                <td align="center">0</td>
                <td align="center"> </td>
                <td align="center">0.77</td>
                <td align="center"> </td>
                <td align="center"> </td>
                <td align="center">0.79</td>
                <td align="center"> </td>
              </tr>
            </tbody>
          </table>
          <table-wrap-foot>
            <p>In this table we report a comparison of displacement errors (in voxels) and quality measures between TeraStitcher and the state-of-the art stitching tools when stitching Megavoxel-sized datasets.</p>
            <p><sup>a</sup>Publicly available dataset downloaded from <ext-link ext-link-type="uri" xlink:href="http://www.vaa3d.org">http://www.vaa3d.org</ext-link>.</p>
            <p><sup>b</sup>Publicly available dataset downloaded from <ext-link ext-link-type="uri" xlink:href="http://www.xuvtools.org">http://www.xuvtools.org</ext-link>.</p>
            <p><sup>c</sup>CLSM dataset (courtesy of F.S. Pavone, L. Sacconi, L. Silvestri) available at <ext-link ext-link-type="uri" xlink:href="http://www.iconfoundation.net">http://www.iconfoundation.net</ext-link>.</p>
            <p><sup>d</sup>Wrong alignment.</p>
          </table-wrap-foot>
        </table-wrap>
      </sec>
      <sec>
        <title>Optimal tiles placement</title>
        <p>Since displacements provided by previous steps are not independent, a globally optimal placement of tiles has to be found before producing the final representation of the whole 3D image. Following [<xref ref-type="bibr" rid="B3">3</xref>], we computed the minimum spanning tree of the undirected weighted graph constituted by the mesh of tiles connected by edges representing tiles displacements. The minimum spanning tree algorithm finds the edges (i.e. the displacements) connecting all tiles without forming cycles and whose total weight is minimum. Weights are computed as the inverse of the displacements reliability measures (see Figure <xref ref-type="fig" rid="F5">5</xref>). In this way, displacements associated to nonstitchable stacks have a weight equal to + <italic>∞</italic> since their reliability was set to 0. This prevents the tree connecting stitchable stacks from passing through nonstitchable ones, unless there is a group of isolated stitchable stacks, in which cases a path including them is provided anyway. If different reliability measures are available along the three directions, as in our case after using MIP-NCC to compute misalignments, the algorithm is applied separately for each direction to find the alignments that are globally optimal for that direction.</p>
        <fig id="F5" position="float">
          <label>Figure 5</label>
          <caption>
            <p><bold>Optimal tiles placement using a minimum spanning tree (MST).</bold> Weighted undirected graph of tiles whose edges represent displacements. Weights are computed as the inverse of displacements reliability measures, yielding + <italic>∞</italic>for the unreliable ones. These prevents the tree connecting stitchable tiles (marked as blue squares) from passing through the nontistchable ones (marked as yellow circles). If different reliability measures are available along the three directions, as in the case of using MIP-NCC to compute misalignments, three minimum spanning trees are obtained for each direction separately. The marked tile in the figure is a nonstitchable tile which is excluded from any MST path traversing stitchable tiles.</p>
          </caption>
          <graphic xlink:href="1471-2105-13-316-5"/>
        </fig>
      </sec>
      <sec>
        <title>Merging and multiresolution generation</title>
        <p>After all relative displacements among tiles have been computed, tile merging is performed.</p>
        <p>Final slices are produced simply copying nonoverlapping regions, while the overlapping ones are substituted by a blended version of them. Blending is performed using two sinusoidal functions phase-shifted by <italic>Π</italic> for weighting the pixels of the two images (see Figure <xref ref-type="fig" rid="F6">6</xref>-b).</p>
        <fig id="F6" position="float">
          <label>Figure 6</label>
          <caption>
            <p><bold>Result of stitching at the border of four overlapping tiles.</bold> Merging without aligning nor blending <bold>(a)</bold> and with aligning and blending <bold>(b)</bold>.</p>
          </caption>
          <graphic xlink:href="1471-2105-13-316-6"/>
        </fig>
        <p>Finally merged slices are saved at several resolutions. At every lower resolution the downsampling is done by computing the mean of an 8-pixels cube of the higher resolution. The resulting image can be saved either as a single stack or in a multistack format with the dimensions of individual stacks decided by the user. The multistack format is provided since it allow a selective access to the higher resolution image, which dramatically improves memory efficiency of further processing.</p>
        <p>All these operations are performed according to a strategy minimizing memory occupancy, which is described in detail in the next section.</p>
      </sec>
    </sec>
    <sec>
      <title>Strategies to limit resource requirements</title>
      <p>In this section we discuss how the entire stitching procedure is organized to minimize both I/O data transfers and memory requirements which are critical problems in processing data of TB size. We will focus on the two stitching steps that process data, which are the <italic>Pairwise stacks displacements computation</italic> and the <italic>Merging and saving tiles into a multiresolution representation</italic> steps. As reported in Figure <xref ref-type="fig" rid="F1">1</xref>, data are read once for each of the two steps. To understand why, one should note that the final representation of the whole 3D image cannot be produced if the precise relative positions of tiles have not been determined. Tile positioning in turn requires that all tile pairs have been properly aligned. Since the entire dataset cannot be kept in memory, all data have to be read at least twice and written back to mass storage once, after the final image representation has been produced.</p>
      <p>Let us refer to <italic>N</italic><sub><italic>slices</italic></sub> as the number of slices per tile and to <italic>N</italic><sub><italic>rows</italic></sub>and <italic>N</italic><sub><italic>cols</italic></sub> as the number of rows and columns of the tile matrix, respectively. Each tile which is not on the matrix border has four adjacent tiles, conventionally referred to as <italic>West</italic>, <italic>North</italic>, <italic>East</italic> and <italic>South</italic>, respectively.</p>
      <p>As mentioned in section Algorithms, in the <italic>Pairwise stacks displacements computation</italic> step the whole volume is processed a layer at the time, each composed by <italic>n</italic><sub><italic>slices</italic></sub>slices at most. For each layer, tiles are read row-wise or column-wise depending on which dimension is smaller. Supposing that stacks are read row-wise, a stack is maintained in memory until its displacements with its <italic>South</italic> and <italic>East</italic> stacks are computed, after which it is released (see Figure <xref ref-type="fig" rid="F7">7</xref>). If border tiles are properly managed skipping alignments with missing adjacent tiles, only <italic>N</italic><sub><italic>cols</italic></sub> + 1 tiles have to be maintained in memory to compute all pairwise displacements, and all data have to be read only once. The column-wise case is symmetric. Hence, this step needs to keep in memory only (min{<italic>N</italic><sub><italic>rows</italic></sub>,<italic>N</italic><sub><italic>cols</italic></sub>} + 1)×<italic>n</italic><sub><italic>slices</italic></sub>slices at the time. Such a quantity can be directly controlled by the user by choosing a small value for <italic>n</italic><sub><italic>slices</italic></sub>.</p>
      <fig id="F7" position="float">
        <label>Figure 7</label>
        <caption>
          <p><bold>Memory management in the pairwise stacks displacements computation step.</bold> The whole volume is processed a layer at the time, each composed by <italic>n</italic><sub><italic>slices</italic></sub>slices. For each layer, stacks are read row-wise when there are more rows than columns (i-iv). A new substack is loaded <bold>(i)</bold> when its <italic>North</italic> substack needs it for displacement computation <bold>(ii)</bold>. After that, the <italic>North</italic> substack can be released <bold>(iii)</bold> and this process is repeated for the next column <bold>(iv)</bold>.</p>
        </caption>
        <graphic xlink:href="1471-2105-13-316-7"/>
      </fig>
      <p>In the <italic>Merging</italic> step, only a small group of slices for each tile are read at the time, following again a row-wise order for tiles, and taking into account for each tile the right displacement along <italic>D</italic> computed after the first step. When one slice group of every tile in row <italic>i</italic> of the tile matrix have been read, adjacent slices in the groups are merged with the algorithm described in section <italic>Algorithms</italic>. This produces a group of horizontal stripes of the slices of the final image representation. These stripes are then merged with the ones previously generated from the slices of the preceding rows, so producing larger stripes of the same group of final slices (Figure <xref ref-type="fig" rid="F8">8</xref>).</p>
      <fig id="F8" position="float">
        <label>Figure 8</label>
        <caption>
          <p><bold>Memory management in the merging step.</bold> The whole volume is processed a layer at the time, each composed by the number of slices needed to generate the lowest resolution (e.g. 32 slices for a reduction of 5 times). For each layer, stacks are read row-wise and merging is performed slice by slice. When one slice group of every tile in row <italic>i</italic> of the tile matrix have been read, adjacent tiles in the groups are merged using the blending algorithm described in the Algorithms section. This produces a horizontal stripe, which is merged with the ones previously generated from the slices of the preceding rows, so producing larger stripes until the whole slice of the final image representation is obtained.</p>
        </caption>
        <graphic xlink:href="1471-2105-13-316-8"/>
      </fig>
      <p>Managing properly the first stripe and repeating this procedure for all rows of the tile grid, a group of complete slices of the final representation is produced and saved back to mass storage. In this way, the memory requirement is to keep in memory only a small number of final slices. The number is determined by the minimal resolution of the whole 3D image that has to be generated and by the downsampling method adopted. Groups of a few tens of slices are enough in practice. Since a resolution reduction of 5 times is enough for efficient access to data, in practice there are 2<sup>5</sup>=32 slices in each group.</p>
      <p>We conclude the section observing that in both steps tiles are divided in multiple groups of slices and each group is processed independently. Parallelization of the whole process is therefore trivial and very efficient. Indeed, if groups of slices of all tiles are distributed on multiple disks and multiple processing units are available, all operations can be parallelized with negligible overhead, including I/O operations.</p>
    </sec>
    <sec>
      <title>Manual intervention</title>
      <p>In this section we discuss how the tool enables easy and fast manual intervention in order to refine stitching metadata such as pairwise displacements, tiles coordinates and stitchable/nonstitchable attributes of stacks. Our solution is based on three principles: (i) using XML files to load/save stitching metadata, (ii) enabling a preview-like feature to stitch selectable portions of data and (iii) providing graphical models of metadata for a more comprehensive analysis. In the following we detail each of these principles.</p>
      <sec>
        <title>XML files editing</title>
        <p>Stitching steps save their metadata into XML files and they can be launched individually by loading an existing XML containing the metadata used by that step. The benefit of this approach is threefold. First, the user can manually refine stitching metadata by simply editing XML files, which structure was designed to provide easy readability and understanding (see Figure <xref ref-type="fig" rid="F1">1</xref>). Second, steps become separable not only logically but also physically by saving/loading the state of the stitching process into/from the XML file. It is then easier to tune single-step parameters without re-executing the previous ones. Third, steps dealing only with metadata can be performed on different machines. This enables manual intervention on any machine when the result does not need to be verified on data (e.g. consider the intervention between <italic>Displacement thresholding</italic> and <italic>Optimal tiles placement</italic> step).</p>
      </sec>
      <sec>
        <title>Preview-like feature</title>
        <p>Each step dealing with data lets the user select the portion of volume to be processed in terms of an interval of stacks rows and/or columns of the tile matrix and/or in terms of an interval of slices along <italic>D</italic> axis. The latter is very useful to verify the quality of stitching before and after any manual intervention. Thanks to the adopted slice-based merging strategy, the tool enables fast stitching of small subset of slices of the whole volume, so obtaining a preview of the final volume in just few seconds. After disabling any activated blending method, the user can then easily detect and locate abnormalities on this preview by visual inspection on stacks borders.</p>
      </sec>
      <sec>
        <title>Graphical models of metadata</title>
        <p>We developed and provide MATLAB scripts that starting from XML files generate graphical models of metadata to be used for a more comprehensive analysis and faster manual intervention. An example is given in Figure <xref ref-type="fig" rid="F1">1</xref> for the <italic>Displacement thresholding</italic> step, where we report a map of stitchable and non stitchable stacks together with their displacements values and reliability measures. From this map, one could observe if the connected region of stitchable stacks does correspond to the shape of the acquired specimen and if the alignment of some nonempty stacks turned out to be particularly difficult along a particular direction. In this way, the user can detect abnormalities directly on metadata and then edit the corresponding XML entry.</p>
      </sec>
    </sec>
  </sec>
  <sec>
    <title>Results and discussion</title>
    <p>In this section we provide four sets of performance data characterizing our stitching tool from both qualitative and quantitative points of view. A comparison between the TeraStitcher tool and the ones presented in [<xref ref-type="bibr" rid="B1">1</xref>-<xref ref-type="bibr" rid="B3">3</xref>] is also provided in both cases.</p>
    <p>First, in Table <xref ref-type="table" rid="T1">1</xref> we report maximum and average displacements errors as well as their corresponding quality measures obtained by stitching tiles from different datasets with our tool and the ones it has to be compared with. The aim of such a comparison is to demonstrate that TeraStitcher performs at least as well as the others from a qualitative point of view. To this purpose, several image stacks from 7 datasets differing in content, bitdepth, lighting conditions, contrast and SNR have been used. Displacements errors were measured taking into account an uncertainty of ±1 voxel of the groundtruth, which was then subtracted from each error. Quality measures were normalized from [ 0,100] to [ 0,1] for <italic>XuvStitch</italic>. The results show that TeraStitcher can stitch both images acquired in CLSM and images acquired with other microscopy techniques with single-pixel precision. Conversely, both <italic>iStitch</italic> and <italic>XuvStitch</italic> didn’t perform well with CLSM images. In fact, the former provided more than one wrong displacement. However, differently from other tools considered here, this tool does not use stage coordinates, which probably made stitching more difficult. As to <italic>XuvStitch</italic>, it provided just wrong displacements in two instances. Moreover, its quality measures were quite low in all the instances of the <italic>Mouse cerebellum</italic> dataset, which would make them not suited to be used as reliability measures. Finally, <italic>Fiji</italic> performed very well in all the instances considered, but its quality measures seemed to be content-dependent and they were very low for 3 of the 7 considered datasets.</p>
    <p>Second, in Table <xref ref-type="table" rid="T2">2</xref> we report a comparison about the execution times and memory occupancy of individual phases as well as of the whole stitching procedure on megavoxel-sized data extracted from the <italic>Whole mouse cerebellum</italic> dataset acquired in CLSM. Measurements have been carried out on a laptop equipped with 4 GB of RAM, 500 GB of disk space, 1 dual-core CPU at 2.53 GHz. We used the following values for TeraStitcher parameters: <italic>n</italic><sub><italic>slices</italic></sub>=100, <italic>δ</italic><sub><italic>search</italic></sub>=16. In order to have a fair comparison, the other tools parameters having the same meaning of <italic>δ</italic><sub><italic>search</italic></sub> were set at the same value. It is worth noting that although <italic>iStitch</italic> implementation does not exploit the knowledge of the approximate relative position of the two stacks as the other tools considered do, it computes an initial relative position on a quite undersampled image (see [<xref ref-type="bibr" rid="B3">3</xref>] for details). For this reason the contribution of this preliminary step to the overall execution time can be considered negligible. The results show that both execution times and memory occupancy of our tool are significantly lower than those of the others, except for <italic>XuvStitch</italic>, whose execution times were comparable with those of TeraStitcher. However, its memory peak becomes significantly higher than that of TeraStitcher when stitching large datasets, as it is shown in the third row of the table, where four stacks of 512×512×600 voxels have been stitched. Another interesting result is that <italic>iStitch</italic> performed better than the other tools when stage coordinates are not provided, probably thanks to the preliminary step on the undersampled image mentioned above, which confirms to be quite effective.</p>
    <table-wrap position="float" id="T2">
      <label>Table 2</label>
      <caption>
        <p>Performance comparison among stitching tools</p>
      </caption>
      <table frame="hsides" rules="groups" border="1">
        <colgroup>
          <col/>
          <col/>
          <col/>
          <col/>
          <col/>
          <col/>
          <col/>
          <col/>
          <col/>
          <col/>
        </colgroup>
        <thead valign="top">
          <tr>
            <th align="left">
              <bold>Data size (MVoxel)</bold>
            </th>
            <th align="center">
              <bold>Stacks</bold>
            </th>
            <th align="center">
              <bold>Tool</bold>
            </th>
            <th align="center">
              <bold>Use of stage coordinates</bold>
            </th>
            <th align="center">
              <bold>Memory peak</bold>
            </th>
            <th align="center">
              <bold>
                <italic>T</italic>
              </bold>
              <sub>
                <bold>
                  <italic>stitching</italic>
                </bold>
              </sub>
              <sup>
                <bold>a</bold>
              </sup>
            </th>
            <th align="center">
              <bold>
                <italic>T</italic>
              </bold>
              <sub>
                <bold>
                  <italic>displ. comp.</italic>
                </bold>
              </sub>
            </th>
            <th align="center">
              <bold>
                <italic>T</italic>
              </bold>
              <sub>
                <bold>
                  <italic>merging</italic>
                </bold>
              </sub>
            </th>
            <th align="center">
              <bold>
                <italic>T</italic>
              </bold>
              <sub>
                <bold>
                  <italic>I</italic>
                </bold>
                <bold>/</bold>
                <bold>
                  <italic>O</italic>
                </bold>
              </sub>
            </th>
            <th align="center">
              <italic>T</italic>
              <sub>
                <italic>total</italic>
              </sub>
            </th>
          </tr>
        </thead>
        <tbody valign="top">
          <tr>
            <td align="left" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom">TeraStitcher<hr/></td>
            <td align="center" valign="bottom">yes<hr/></td>
            <td align="center" valign="bottom">200<hr/></td>
            <td align="center" valign="bottom">4<hr/></td>
            <td align="center" valign="bottom">2<hr/></td>
            <td align="center" valign="bottom">2<hr/></td>
            <td align="center" valign="bottom">7<hr/></td>
            <td align="center" valign="bottom">11<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom">Fiji<hr/></td>
            <td align="center" valign="bottom">yes<hr/></td>
            <td align="center" valign="bottom">450<hr/></td>
            <td align="center" valign="bottom">45<hr/></td>
            <td align="center" valign="bottom">20<hr/></td>
            <td align="center" valign="bottom">25<hr/></td>
            <td align="center" valign="bottom">8<hr/></td>
            <td align="center" valign="bottom">53<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom">Fiji<hr/></td>
            <td align="center" valign="bottom">no<hr/></td>
            <td align="center" valign="bottom">1400<hr/></td>
            <td align="center" valign="bottom">99<hr/></td>
            <td align="center" valign="bottom">75<hr/></td>
            <td align="center" valign="bottom">24<hr/></td>
            <td align="center" valign="bottom">3<hr/></td>
            <td align="center" valign="bottom">102<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom">100<hr/></td>
            <td align="center" valign="bottom">2×200 slices<hr/></td>
            <td align="center" valign="bottom">XuvStitch<hr/></td>
            <td align="center" valign="bottom">yes<hr/></td>
            <td align="center" valign="bottom">400<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">4<hr/></td>
            <td align="center" valign="bottom">16<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">20<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom">XuvStitch<hr/></td>
            <td align="center" valign="bottom">no<hr/></td>
            <td align="center" valign="bottom">950<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">22<hr/></td>
            <td align="center" valign="bottom">16<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">38<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom">iStitch<hr/></td>
            <td align="center" valign="bottom">no<hr/></td>
            <td align="center" valign="bottom">600<hr/></td>
            <td align="center" valign="bottom">11<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">17<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom">TeraStitcher<hr/></td>
            <td align="center" valign="bottom">yes<hr/></td>
            <td align="center" valign="bottom">300<hr/></td>
            <td align="center" valign="bottom">8<hr/></td>
            <td align="center" valign="bottom">4<hr/></td>
            <td align="center" valign="bottom">4<hr/></td>
            <td align="center" valign="bottom">12<hr/></td>
            <td align="center" valign="bottom">20<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom"> <hr/></td>
            <td align="left" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom">Fiji<hr/></td>
            <td align="center" valign="bottom">yes<hr/></td>
            <td align="center" valign="bottom">1300<hr/></td>
            <td align="center" valign="bottom">132<hr/></td>
            <td align="center" valign="bottom">62<hr/></td>
            <td align="center" valign="bottom">71<hr/></td>
            <td align="center" valign="bottom">13<hr/></td>
            <td align="center" valign="bottom">145<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom">200<hr/></td>
            <td align="center" valign="bottom">4×200 slices<hr/></td>
            <td align="center" valign="bottom">XuvStitch<hr/></td>
            <td align="center" valign="bottom">yes<hr/></td>
            <td align="center" valign="bottom">500<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">6<hr/></td>
            <td align="center" valign="bottom">28<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">34<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom">iStitch<hr/></td>
            <td align="center" valign="bottom">no<hr/></td>
            <td align="center" valign="bottom">662<hr/></td>
            <td align="center" valign="bottom">37<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">46<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom">TeraStitcher<hr/></td>
            <td align="center" valign="bottom">yes<hr/></td>
            <td align="center" valign="bottom">300<hr/></td>
            <td align="center" valign="bottom">35<hr/></td>
            <td align="center" valign="bottom">23<hr/></td>
            <td align="center" valign="bottom">12<hr/></td>
            <td align="center" valign="bottom">32<hr/></td>
            <td align="center" valign="bottom">20<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom"> <hr/></td>
            <td align="center" valign="bottom">Fiji<hr/></td>
            <td align="center" valign="bottom">yes<hr/></td>
            <td align="center" valign="bottom">&gt; 3000<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">113<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom">600<hr/></td>
            <td align="center" valign="bottom">4×600 slices<hr/></td>
            <td align="center" valign="bottom">XuvStitch<hr/></td>
            <td align="center" valign="bottom">yes<hr/></td>
            <td align="center" valign="bottom">1200<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">18<hr/></td>
            <td align="center" valign="bottom">80<hr/></td>
            <td align="center" valign="bottom">n.a.<hr/></td>
            <td align="center" valign="bottom">34<hr/></td>
          </tr>
          <tr>
            <td align="left"> </td>
            <td align="center"> </td>
            <td align="center">iStitch</td>
            <td align="center">no</td>
            <td align="center">1900</td>
            <td align="center">143</td>
            <td align="center">n.a.</td>
            <td align="center">n.a.</td>
            <td align="center">n.a.</td>
            <td align="center">46</td>
          </tr>
        </tbody>
      </table>
      <table-wrap-foot>
        <p>In this table we report a comparison of execution times (in seconds) and memory peaks (in MB) between TeraStitcher and the state-of-the art stitching tools when stitching Megavoxel-sized datasets.</p>
        <p><sup>a</sup>Time spent in stitching, net of I/O.</p>
      </table-wrap-foot>
    </table-wrap>
    <p>Third, in Table <xref ref-type="table" rid="T3">3</xref> we report execution times and memory peaks of individual phases when stitching gigavoxel and teravoxel-sized data with TeraStitcher. We could not make a comparison with the other tools because they easily ran out of memory with such data. Measurements have been carried out on a workstation equipped with 96 GB of RAM, 9 TB of disk space, 2 quad-core CPUs at 2.26 GHz and using the following values for TeraStitcher parameters: <italic>n</italic><sub><italic>slices</italic></sub>=100, <italic>δ</italic><sub><italic>search</italic></sub>=25. The first three rows refer to increasing subvolumes of a 3D image of the <italic>Whole mouse cerebellum</italic> dataset. It is apparent that all times are linearly dependent on the image size. The complete image (∼200 gigavoxels) has been processed in about 15 hours (third row in the table). The last row refers to the time needed to process a 1.3 teravoxels image corresponding to about 4 days. Times corresponding to individual substeps are not available in this case.</p>
    <table-wrap position="float" id="T3">
      <label>Table 3</label>
      <caption>
        <p>Performances of TeraStitcher when stitching very large datasets</p>
      </caption>
      <table frame="hsides" rules="groups" border="1">
        <colgroup>
          <col align="left"/>
          <col align="center"/>
          <col align="center"/>
          <col align="center"/>
          <col align="center"/>
          <col align="center"/>
          <col align="center"/>
          <col align="center"/>
        </colgroup>
        <thead valign="top">
          <tr>
            <th align="left">
              <bold>Data size (Gigavoxel)</bold>
            </th>
            <th align="center">
              <bold>Dataset</bold>
            </th>
            <th align="center">
              <bold>Memory peak</bold>
            </th>
            <th align="center">
              <bold>
                <italic>T</italic>
              </bold>
              <sub>
                <bold>
                  <italic>stitching</italic>
                </bold>
              </sub>
            </th>
            <th align="center">
              <bold>
                <italic>T</italic>
              </bold>
              <sub>
                <bold>
                  <italic>displ. comp.</italic>
                </bold>
              </sub>
            </th>
            <th align="center">
              <bold>
                <italic>T</italic>
              </bold>
              <sub>
                <bold>
                  <italic>merging</italic>
                </bold>
              </sub>
            </th>
            <th align="center">
              <bold>
                <italic>T</italic>
              </bold>
              <sub>
                <bold>
                  <italic>I</italic>
                </bold>
                <bold>/</bold>
                <bold>
                  <italic>O</italic>
                </bold>
              </sub>
            </th>
            <th align="center">
              <bold>
                <italic>T</italic>
              </bold>
              <sub>
                <bold>
                  <italic>total</italic>
                </bold>
              </sub>
            </th>
          </tr>
        </thead>
        <tbody valign="top">
          <tr>
            <td align="left" valign="bottom">63,25<hr/></td>
            <td align="center" valign="bottom">Portion of whole mouse cerebellum<hr/></td>
            <td align="center" valign="bottom">821<hr/></td>
            <td align="center" valign="bottom">60<hr/></td>
            <td align="center" valign="bottom">23<hr/></td>
            <td align="center" valign="bottom">37<hr/></td>
            <td align="center" valign="bottom">157<hr/></td>
            <td align="center" valign="bottom">217<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom">126,50<hr/></td>
            <td align="center" valign="bottom">Portion of whole mouse cerebellum<hr/></td>
            <td align="center" valign="bottom">1132<hr/></td>
            <td align="center" valign="bottom">145<hr/></td>
            <td align="center" valign="bottom">68<hr/></td>
            <td align="center" valign="bottom">77<hr/></td>
            <td align="center" valign="bottom">318<hr/></td>
            <td align="center" valign="bottom">433<hr/></td>
          </tr>
          <tr>
            <td align="left" valign="bottom">198,78<hr/></td>
            <td align="center" valign="bottom">Whole mouse cerebellum<hr/></td>
            <td align="center" valign="bottom">1132<hr/></td>
            <td align="center" valign="bottom">232<hr/></td>
            <td align="center" valign="bottom">109<hr/></td>
            <td align="center" valign="bottom">123<hr/></td>
            <td align="center" valign="bottom">539<hr/></td>
            <td align="center" valign="bottom">771<hr/></td>
          </tr>
          <tr>
            <td align="left">1315,04</td>
            <td align="center">Whole mouse brain</td>
            <td align="center">2450</td>
            <td align="center">n.a.<sup>a</sup></td>
            <td align="center">n.a.</td>
            <td align="center">n.a.</td>
            <td align="center">n.a.</td>
            <td align="center">6050</td>
          </tr>
        </tbody>
      </table>
      <table-wrap-foot>
        <p>In this table are shown both execution times (in minutes) and memory peaks (in MB) of the TeraStitcher tool when stitching Gigavoxel and Teravoxel-sized datasets.</p>
        <p><sup>a</sup>Not available.</p>
      </table-wrap-foot>
    </table-wrap>
    <p>Finally, we show in Figure <xref ref-type="fig" rid="F8">8</xref> the result of the stitching process on slices at the border of four overlapping tiles for different datasets. This example is representative of the very good qualitative performance attained by our alignment and blending algorithms.</p>
  </sec>
  <sec sec-type="conclusions">
    <title>Conclusions</title>
    <p>Forthcoming microscopy techniques like Confocal Light Sheet Microscopy are able to acquire tiled images of 1 teravoxel or more. These images pose novel requirements to stitching that are not adequately addressed by existing tools.</p>
    <p>In this paper we have presented a tool designed for automatic 3D stitching of teravoxel-sized tiled images. The tool, initially developed for stitching images generated by the CLSM microscope, is completely general, and suited to be adapted to other instruments capable to acquire images of these dimensions. The central idea is to accurately specify the requirements of the stitching problem when teravoxel-sized images are involved, and then use efficiently the system resources to perform the stitching of these images. To improve the generality of the proposed tool, we defined a software architecture that clearly separates the strategies in common among different datasets from the algorithms that may depend on specific characteristics of the acquired images.</p>
    <p>An implementation of the tool that is capable to perform the stitching of real teravoxel-sized images on workstations with relatively limited memory resources in reasonable time has been presented. It uses specific algorithms well suited for a relatively wide class of images, that substantially reduce memory and computational requirements of some basic steps of the stitching procedure with respect to previous approaches. A comparison with state-of-the-art stitching tools confirms that the solutions adopted are best suited for stitching very large, automatically acquired microscopy images.</p>
  </sec>
  <sec>
    <title>Availability and requirements</title>
    <p>We provide TeraStitcher both as standalone application and as plugin of the free software Vaa3D [<xref ref-type="bibr" rid="B9">9</xref>]. Sources and binaries, as well as some MATLAB scripts for the generation of graphical models for metadata, are freely available at the project home page. An online help is also provided which comprises the detailed description of command line parameters, stitching pipeline, supported data formats, supported stacks organization, and a FAQ section. </p>
    <p>● <bold>Project name</bold>: TeraStitcher</p>
    <p>● <bold>Project home page</bold>: <ext-link ext-link-type="uri" xlink:href="http://code.google.com/p/terastitcher">http://code.google.com/p/terastitcher</ext-link></p>
    <p>● <bold>Operating system</bold>: Platform independent</p>
    <p>● <bold>Programming language</bold>: C++</p>
    <p>● <bold>Other requirements</bold>: OpenCV library 2.2.0 or higher is required for compiling both the standalone application and the plugin of Vaa3D. On the contrary, our binary packages can be directly used since we provide OpenCV precompiled binaries within them.</p>
    <p>● <bold>License</bold>: both source code and binaries are freely available at the project home page for non-commercial purposes only and we require that our work is cited in user’s related studies and publications, if any. A short license agreement which encloses this clause is provided in the header of every source file as well as in the binary packages and before downloading any material related to the project.</p>
  </sec>
  <sec>
    <title>Abbreviations</title>
    <p>LSM: Light Sheet Microscopy; LENS: European Laboratory for Non-linear Spectroscopy; CLSM: Confocal Light Sheet Microscopy; ROI: Region Of Interest; PC: Phase Correlation; NCC: Normalized Cross-Correlation; I/O: Input/Output; V: vertical; H: horizontal; D: depth; GB: GigaByte; TB: TeraByte.</p>
  </sec>
  <sec>
    <title>Competing interests</title>
    <p>The authors declare that they have no competing interests.</p>
  </sec>
  <sec>
    <title>Authors’ contributions</title>
    <p>Both authors worked to the design, development and testing of the TeraStitcher tool. They also equally contributed to write the manuscript. Both authors read and approved the final manuscript.</p>
  </sec>
</body>
<back>
  <sec>
    <title>Acknowledgements</title>
    <p>This work has been carried out in the framework of the Project “Projectome” sponsored by the International Center of Computational Neurophotonics (<ext-link ext-link-type="uri" xlink:href="http://www.iconfoundation.net">http://www.iconfoundation.net</ext-link>). We thank F. S. Pavone, L. Sacconi, and L. Silvestri for designing and building the CLSM microscope and for providing the datasets we used in this work, as well as for the useful discussions that helped us in the requirement analysis of our tool. We also thank the anonymous referees for their valuable comments which substantially helped in improving the first version of this paper.</p>
  </sec>
  <ref-list>
    <ref id="B1">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Preibisch</surname>
          <given-names>S</given-names>
        </name>
        <name>
          <surname>Saalfeld</surname>
          <given-names>S</given-names>
        </name>
        <name>
          <surname>Tomancak</surname>
          <given-names>P</given-names>
        </name>
        <article-title>Globally optimal stitching of tiled 3D microscopic image</article-title>
        <source>Bioinformatics</source>
        <year>2009</year>
        <volume>25</volume>
        <issue>11</issue>
        <fpage>1463</fpage>
        <lpage>1465</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btp184</pub-id>
        <pub-id pub-id-type="pmid">19346324</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B2">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Emmenlauer</surname>
          <given-names>M</given-names>
        </name>
        <name>
          <surname>Ronneberger</surname>
          <given-names>O</given-names>
        </name>
        <name>
          <surname>Ponti</surname>
          <given-names>A</given-names>
        </name>
        <name>
          <surname>Schwarb</surname>
          <given-names>P</given-names>
        </name>
        <name>
          <surname>Griffa</surname>
          <given-names>A</given-names>
        </name>
        <name>
          <surname>Filippi</surname>
          <given-names>A</given-names>
        </name>
        <name>
          <surname>Nitschke</surname>
          <given-names>R</given-names>
        </name>
        <name>
          <surname>Driever</surname>
          <given-names>W</given-names>
        </name>
        <name>
          <surname>Burkhardt</surname>
          <given-names>H</given-names>
        </name>
        <article-title>XuvTools: free, fast and reliable stitching of large 3D datasets</article-title>
        <source>J Micros</source>
        <year>2009</year>
        <volume>233</volume>
        <fpage>42</fpage>
        <lpage>60</lpage>
        <pub-id pub-id-type="doi">10.1111/j.1365-2818.2008.03094.x</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B3">
      <mixed-citation publication-type="book">
        <name>
          <surname>Yu</surname>
          <given-names>Y</given-names>
        </name>
        <name>
          <surname>Peng</surname>
          <given-names>H</given-names>
        </name>
        <article-title>Automated high speed stitching of large 3D microscopic images</article-title>
        <source>Proceedings of IEEE 2011 International Symposium on Biomedical Imaging: From Nano to Macro: March 30-april 2</source>
        <year>2011</year>
        <publisher-name>Chicago</publisher-name>
        <fpage>238</fpage>
        <lpage>241</lpage>
      </mixed-citation>
    </ref>
    <ref id="B4">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Keller</surname>
          <given-names>P</given-names>
        </name>
        <name>
          <surname>Dodt</surname>
          <given-names>H</given-names>
        </name>
        <article-title>Light sheet microscopy of living or cleared specimens</article-title>
        <source>Curr Opin Neurobiology</source>
        <year>2012</year>
        <volume>222</volume>
        <fpage>138</fpage>
        <lpage>143</lpage>
      </mixed-citation>
    </ref>
    <ref id="B5">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Verveer</surname>
          <given-names>P</given-names>
        </name>
        <name>
          <surname>Swoger</surname>
          <given-names>J</given-names>
        </name>
        <name>
          <surname>Pampaloni</surname>
          <given-names>F</given-names>
        </name>
        <name>
          <surname>Greger</surname>
          <given-names>K</given-names>
        </name>
        <name>
          <surname>Marcello</surname>
          <given-names>M</given-names>
        </name>
        <name>
          <surname>Stelzer</surname>
          <given-names>E</given-names>
        </name>
        <article-title>High-resolution three dimensional imaging of large specimens with light sheet based microscopy</article-title>
        <source>Nat Methods</source>
        <year>2007</year>
        <volume>4</volume>
        <fpage>311</fpage>
        <lpage>313</lpage>
        <pub-id pub-id-type="pmid">17339847</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B6">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Dodt</surname>
          <given-names>H</given-names>
        </name>
        <name>
          <surname>Leischner</surname>
          <given-names>U</given-names>
        </name>
        <name>
          <surname>Schierloh</surname>
          <given-names>A</given-names>
        </name>
        <name>
          <surname>Jährling</surname>
          <given-names>N</given-names>
          <suffix>Mauch C</suffix>
        </name>
        <article-title>Ultramicroscopy: three-dimensional visualization of neuronal networks in the whole mouse brain</article-title>
        <source>Nat Methods</source>
        <year>2007</year>
        <volume>4</volume>
        <fpage>331</fpage>
        <lpage>336</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth1036</pub-id>
        <pub-id pub-id-type="pmid">17384643</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B7">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Silvestri</surname>
          <given-names>L</given-names>
        </name>
        <name>
          <surname>Bria</surname>
          <given-names>A</given-names>
        </name>
        <name>
          <surname>Sacconi</surname>
          <given-names>L</given-names>
        </name>
        <name>
          <surname>Iannello</surname>
          <given-names>G</given-names>
        </name>
        <name>
          <surname>Pavone</surname>
          <given-names>F</given-names>
        </name>
        <article-title>Confocal light sheet microscopy: micron-scale neuroanatomy of the entire mouse brain</article-title>
        <source>Optic Express</source>
        <year>2012</year>
        <volume>20</volume>
        <issue>18</issue>
        <fpage>20582</fpage>
        <lpage>20598</lpage>
        <pub-id pub-id-type="doi">10.1364/OE.20.020582</pub-id>
      </mixed-citation>
    </ref>
    <ref id="B8">
      <mixed-citation publication-type="book">
        <name>
          <surname>Gamma</surname>
          <given-names>E</given-names>
        </name>
        <name>
          <surname>Helm</surname>
          <given-names>R</given-names>
        </name>
        <name>
          <surname>Johnson</surname>
          <given-names>R</given-names>
        </name>
        <name>
          <surname>Vlissides</surname>
          <given-names>J</given-names>
        </name>
        <source>Elements of Reusable Object-Oriented Software</source>
        <year>1995</year>
        <publisher-name>Addison-Wesley Boston: Longman Publishing Co.</publisher-name>
      </mixed-citation>
    </ref>
    <ref id="B9">
      <mixed-citation publication-type="journal">
        <name>
          <surname>Peng</surname>
          <given-names>H</given-names>
        </name>
        <name>
          <surname>Ruan</surname>
          <given-names>Z</given-names>
        </name>
        <name>
          <surname>Long</surname>
          <given-names>F</given-names>
        </name>
        <name>
          <surname>Simpson</surname>
          <given-names>J</given-names>
        </name>
        <name>
          <surname>Myers</surname>
          <given-names>E</given-names>
        </name>
        <article-title>V3D enables real-time 3D visualization and quantitative analysis of large-scale biological image data sets</article-title>
        <source>Nat Biotechnol</source>
        <year>2010</year>
        <volume>28</volume>
        <issue>4</issue>
        <fpage>348</fpage>
        <lpage>353</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.1612</pub-id>
        <pub-id pub-id-type="pmid">20231818</pub-id>
      </mixed-citation>
    </ref>
  </ref-list>
</back>
