<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Genome Biol</journal-id>
    <journal-id journal-id-type="iso-abbrev">Genome Biol</journal-id>
    <journal-title-group>
      <journal-title>Genome Biology</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1474-7596</issn>
    <issn pub-type="epub">1474-760X</issn>
    <publisher>
      <publisher-name>BioMed Central</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">7891139</article-id>
    <article-id pub-id-type="publisher-id">2280</article-id>
    <article-id pub-id-type="doi">10.1186/s13059-021-02280-8</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Method</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>iMAP: integration of multiple single-cell datasets by adversarial paired transfer networks</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author" corresp="yes" equal-contrib="yes">
        <name>
          <surname>Wang</surname>
          <given-names>Dongfang</given-names>
        </name>
        <address>
          <email>wangdf19@pku.edu.cn</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author" equal-contrib="yes">
        <name>
          <surname>Hou</surname>
          <given-names>Siyu</given-names>
        </name>
        <address>
          <email>housy17@mails.tsinghua.edu.cn</email>
        </address>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Zhang</surname>
          <given-names>Lei</given-names>
        </name>
        <address>
          <email>leah.zhanglei@szbl.ac.cn</email>
        </address>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Wang</surname>
          <given-names>Xiliang</given-names>
        </name>
        <address>
          <email>wxil@pku.edu.cn</email>
        </address>
        <xref ref-type="aff" rid="Aff4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Liu</surname>
          <given-names>Baolin</given-names>
        </name>
        <address>
          <email>pauling.liu@pku.edu.cn</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-3789-6536</contrib-id>
        <name>
          <surname>Zhang</surname>
          <given-names>Zemin</given-names>
        </name>
        <address>
          <email>zemin@pku.edu.cn</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
        <xref ref-type="aff" rid="Aff4">4</xref>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.11135.37</institution-id><institution-id institution-id-type="ISNI">0000 0001 2256 9319</institution-id><institution>BIOPIC and School of Life Sciences, </institution><institution>Peking University, </institution></institution-wrap>Beijing, China </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.12527.33</institution-id><institution-id institution-id-type="ISNI">0000 0001 0662 3178</institution-id><institution>MOE Key Laboratory for Bioinformatics, BNRIST Bioinformatics Division, Department of Automation, </institution><institution>Tsinghua University, </institution></institution-wrap>Beijing, China </aff>
      <aff id="Aff3"><label>3</label>Institute of Cancer Research, Shenzhen Bay Laboratory, Shenzhen, China </aff>
      <aff id="Aff4"><label>4</label>Analytical Biosciences Limited, Beijing, China </aff>
      <aff id="Aff5"><label>5</label><institution-wrap><institution-id institution-id-type="GRID">grid.11135.37</institution-id><institution-id institution-id-type="ISNI">0000 0001 2256 9319</institution-id><institution>Beijing Advanced Innovation Center for Genomics, Peking-Tsinghua Center for Life Sciences, </institution><institution>Peking University, </institution></institution-wrap>Beijing, China </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>18</day>
      <month>2</month>
      <year>2021</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>18</day>
      <month>2</month>
      <year>2021</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2021</year>
    </pub-date>
    <volume>22</volume>
    <elocation-id>63</elocation-id>
    <history>
      <date date-type="received">
        <day>30</day>
        <month>7</month>
        <year>2020</year>
      </date>
      <date date-type="accepted">
        <day>27</day>
        <month>1</month>
        <year>2021</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2021</copyright-statement>
      <license license-type="OpenAccess">
        <license-p><bold>Open Access</bold>This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons licence, and indicate if changes were made. The images or other third party material in this article are included in the article's Creative Commons licence, unless indicated otherwise in a credit line to the material. If material is not included in the article's Creative Commons licence and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this licence, visit <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>. The Creative Commons Public Domain Dedication waiver (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/publicdomain/zero/1.0/">http://creativecommons.org/publicdomain/zero/1.0/</ext-link>) applies to the data made available in this article, unless otherwise stated in a credit line to the data.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">The integration of single-cell RNA-sequencing datasets from multiple sources is critical for deciphering cell-to-cell heterogeneities and interactions in complex biological systems. We present a novel unsupervised batch effect removal framework, called iMAP, based on both deep autoencoders and generative adversarial networks. Compared with current methods, iMAP shows superior, robust, and scalable performance in terms of both reliably detecting the batch-specific cells and effectively mixing distributions of the batch-shared cell types. Applying iMAP to tumor microenvironment datasets from two platforms, Smart-seq2 and 10x Genomics, we find that iMAP can leverage the powers of both platforms to discover novel cell-cell interactions.</p>
      <sec>
        <title>Supplementary Information</title>
        <p>The online version contains supplementary material available at 10.1186/s13059-021-02280-8.</p>
      </sec>
    </abstract>
    <kwd-group xml:lang="en">
      <title>Keywords</title>
      <kwd>scRNA-seq</kwd>
      <kwd>Data integration</kwd>
      <kwd>Deep learning</kwd>
      <kwd>GAN</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001809</institution-id>
            <institution>National Natural Science Foundation of China</institution>
          </institution-wrap>
        </funding-source>
        <award-id>81988101, 91742203, 91942307, 31991171</award-id>
        <principal-award-recipient>
          <name>
            <surname>Zhang</surname>
            <given-names>Zemin</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>Beijing Municipal Science &amp; Technology Commission</institution>
        </funding-source>
        <award-id>Z201100005320014</award-id>
        <principal-award-recipient>
          <name>
            <surname>Zhang</surname>
            <given-names>Zemin</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2021</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Background</title>
    <p id="Par2">Single-cell RNA-sequencing (scRNA-seq) technologies have profoundly changed our understandings of cell-to-cell heterogeneities in various biological areas [<xref ref-type="bibr" rid="CR1">1</xref>–<xref ref-type="bibr" rid="CR3">3</xref>]. Compared with individual scRNA-seq experiments, integration of datasets from multiple sources can enlighten researchers on more reliable novel discoveries. However, inherent technical differences among experiments may lead to inescapable batch effects, confounding the biological variations [<xref ref-type="bibr" rid="CR4">4</xref>–<xref ref-type="bibr" rid="CR6">6</xref>]. Eliminating the unwanted technical variations among different datasets, but not diminishing those biological differences, is one major challenge for batch effect removal methodologies.</p>
    <p id="Par3">A number of unsupervised batch effect removal methods for scRNA-seq datasets have been developed in recent years, including a class that attempts to model the global relationships between batch effects and gene expression profiles. For examples, Combat [<xref ref-type="bibr" rid="CR7">7</xref>] models the gene expressions as a function of batch origins, and LIGER [<xref ref-type="bibr" rid="CR8">8</xref>] extracts the batch-specific gene factors from the whole expression profiles. Another class of methods is pioneered by the innovative idea of mutual nearest neighbors (MNNs) [<xref ref-type="bibr" rid="CR9">9</xref>] between different batches, with paired cells used as local anchors to help batch correction of their neighborhood. BBKNN [<xref ref-type="bibr" rid="CR10">10</xref>], Scanorama [<xref ref-type="bibr" rid="CR11">11</xref>], and Seurat v3 [<xref ref-type="bibr" rid="CR12">12</xref>] follow this idea but search the MNNs in elaborated dimension-reduced spaces, instead of the original expression vectors. Harmony [<xref ref-type="bibr" rid="CR13">13</xref>] deploys a novel local correction idea that preferentially clusters cells from different batches, thereby better matching the distributions of the shared cell types across datasets. In theory, the former global correction methods may be beneficial to retain the dataset-specific biological variations, but do not fully guarantee the integration of the shared cell types. The performance of latter local corrections highly depends on the qualities of MNNs or matched local clusters. This makes it hard to balance between the identification of the dataset-specific cells and the mixture of the shared cell types. To address this major hurdle, here we develop a new framework to take advantages of both two strategies while overcoming the intrinsic challenges of them.</p>
    <p id="Par4">Our method, called iMAP—Integration of Multiple single-cell datasets by Adversarial Paired-style transfer networks—is a deep learning-based framework for batch effect removal of scRNA-seq datasets. Some studies such as scVI [<xref ref-type="bibr" rid="CR14">14</xref>] and DESC [<xref ref-type="bibr" rid="CR15">15</xref>] have showed the potentials of deep networks, especially the autoencoder structures, on processing scRNA-seq data, but autoencoder-based models usually have difficulties in reconstructing the batch-corrected transcriptomes with high fidelity. iMAP combines the powers of two kinds of state-of-art unsupervised deep network structures—autoencoders and generative adversarial networks (GANs) [<xref ref-type="bibr" rid="CR16">16</xref>]. A novel autoencoder structure is used to build low-dimensional representations of the biological contents of cells disentangled from the technical variations. Then GANs are leveraged to remove the batch effects from the original expression profiles. Compared with other methods, iMAP could both match the distributions of the shared cell types and discern the batch-specific cell types on the benchmark datasets. We also demonstrate the stability of iMAP over the choice of hyperparameters and the effect of stochasticity and provide a framework to interpret the working mechanisms of iMAP. iMAP is scalable on large datasets with the notable speed advantage especially for datasets with cells more than thousands. Finally, we applied iMAP to the integration of tumor-infiltrating immune cell datasets sequenced by Smart-seq2 and 10x Genomics (10x) and discovered novel cell-cell interactions by virtue of the powers of both platforms. iMAP is available as a Python package on github (<ext-link ext-link-type="uri" xlink:href="https://github.com/Svvord/iMAP">https://github.com/Svvord/iMAP</ext-link>).</p>
  </sec>
  <sec id="Sec2">
    <title>Results</title>
    <sec id="Sec3">
      <title>Overview of the iMAP algorithm</title>
      <p id="Par5">Our iMAP framework consists of two stages, including building the batch-ignorant representations for all cells, and then guiding the batch effect removal of the original high-dimensional expression profiles (the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section). We model the measured expression profile <italic>x</italic> of one single cell as a function of two independent factors: the biological variation and measuring process (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a), whose effects would be disentangled by an autoencoder-like deep neural network structure deployed in the stage I. This structure includes three feed-forward multi-layer neural networks: one encoder <italic>E</italic>, extracting low-dimensional representations of biological contents <italic>c</italic> from a cell’s expression profile <italic>x</italic>, and two generators <italic>G</italic><sub>1</sub>, <italic>G</italic><sub>2</sub>, reconstructing the expression profile from <italic>c</italic> and one batch indicator (Fig. <xref rid="Fig1" ref-type="fig">1</xref>b). If we feed the generators with the true batch indicator <italic>b</italic> of one cell, they could reconstruct the original expression profile. By contrast, if a random batch indicator <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \overset{\sim }{b} $$\end{document}</tex-math><mml:math id="M2" display="inline"><mml:mover accent="true"><mml:mi>b</mml:mi><mml:mo stretchy="true">~</mml:mo></mml:mover></mml:math><inline-graphic xlink:href="13059_2021_2280_Article_IEq1.gif"/></alternatives></inline-formula> is inputted, the generators should fabricate a pseudo-cell but with the same biological content as the original true cell. This inspired two loss functions: the reconstruction loss <italic>L</italic><sub><italic>r</italic></sub> and the content loss <italic>L</italic><sub><italic>c</italic></sub> (Fig. <xref rid="Fig1" ref-type="fig">1</xref>c). After training, we expect the encoder to capture batch-ignorant representations from the single-cell transcriptomes. By virtue of these representations and the adversarial networks, we could further remove the batch effects on the original high-dimensional expression profiles in the stage II, using a similar strategy as the pair-based neural style transfer in the computer vision field [<xref ref-type="bibr" rid="CR17">17</xref>]. iMAP extracts the MNN pairs from two batches using the representations obtained from the previous stage, increasingly resulting in much larger number of high-quality MNN pairs compared with that using the original expression profiles. One potential problem of MNN pairs is that they may not fully cover the whole distributions of the shared cell types between two batches. Therefore, iMAP regards the cells in the MNN pairs as initial seeds, and adopts a random walk-based method to enroll new pairs, through successively selecting a cell from the kNNs (<italic>k</italic> nearest neighbors) of the seeds within each batch (Fig. <xref rid="Fig1" ref-type="fig">1</xref>d). These extended pairs are called rwMNN pairs. A GAN-based structure, composed of one generator <italic>G</italic><sup>′</sup> and one discriminator <italic>D</italic><sup>′</sup>, is then trained only on these rwMNN pairs (Fig. <xref rid="Fig1" ref-type="fig">1</xref>e), while all cells could be transformed to remove the batch effects using the trained generator. We argue that the rwMNN pair is of vital importance for the GAN to correctly match the complete cell expression distributions of two batches. In the case of multiple batches, an incremental batch effect removal process is used (the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section).
<fig id="Fig1"><label>Fig. 1</label><caption><p>Overview of the iMAP algorithm. <bold>a</bold> The expression profiles modeled by a function of two independent factors: biological variations and measuring processes. <bold>b</bold> Three feed-forward neural networks deployed for the first stage of iMAP. <bold>c</bold> Information flows and two losses functions used in the first stage. <italic>L</italic><sub><italic>r</italic></sub>, reconstruction loss; <italic>L</italic><sub><italic>c</italic></sub>, content loss. <bold>d</bold> A within-batch random walk-based procedure adopted to extend the MNN pairs. These extended MNN pairs are called rwMNN pairs. <bold>e</bold> A GAN structure used to remove the batch effects based on the rwMNN pairs</p></caption><graphic xlink:href="13059_2021_2280_Fig1_HTML" id="MO1"/></fig></p>
    </sec>
    <sec id="Sec4">
      <title>Benchmark evaluations</title>
      <p id="Par6">We first adopted two publicly available well-controlled datasets to qualitatively and quantitatively evaluate the performance of iMAP, in terms of both well-mixing the distributions of the shared cell types between different batches and identifying those batch-specific cells. Current evaluation metrics of batch effect removal can be classified as cluster-level and single cell-level indices, where the former ones, including ASW (Average silhouette width) and ARI (Adjusted rand index), are easy to compute but cannot reliably evaluate the mixture of cells from different batches within the local neighborhood (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1a). Therefore, we focused on the single cell-level metrics. One famous single cell-level metric, kBET (k-Nearest neighbor batch-effect test) [<xref ref-type="bibr" rid="CR18">18</xref>] assesses the batch mixing by comparing the batch distribution within kNNs of a cell with the global batch distribution, but it ignores the diversity of cell-type proportions of different batches [<xref ref-type="bibr" rid="CR13">13</xref>]. Another single cell-level metric, LISI (Local Inverse Simpson’s Index) [<xref ref-type="bibr" rid="CR13">13</xref>], overcomes the above difficulties and evaluates the mixing of batches and separation of cell types using two indices, i.e., iLISI (integration LISI) and cLISI (cell-type LISI). The possible drawback of LISI is that it is hard to summarize all single cell-level LISI values into a simple statistic for comparing between various methods. We then devised a novel evaluation procedure at the single-cell level, to qualitatively visualize and quantitatively summarize the performance of batch effect removal methods on both the effectiveness of mixing the shared cell types and discerning the batch-specific cell types (the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1b). This procedure includes two local classifiers for each single cell, the first of which would discriminate those cells surrounded by others with the same cell type as “positive” and otherwise “negative.” The second classifier would further pick out the “true positive” cells from those positive ones. The “true positive” cells are the cells which have congruous local batch distribution with the global batch distribution of its cell type. The proportions of positive cells and true positive cells can be used as the summary metrics to quantitatively compare overall performance of batch effect removal methods.</p>
      <p id="Par7">Our first benchmark dataset is composed of two batches, both sequenced using the Smart-seq2 protocol, and consists of four kinds of human dendritic cells (DCs), i.e., CD1C DC, CD141 DC, plasmacytoid DC (pDC), and double negative cells (DoubleNeg) [<xref ref-type="bibr" rid="CR19">19</xref>] (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1). Two types of biologically similar cells, CD1C DC from batch1 and CD141 DC from batch2, were removed to ensure the two sub-datasets contained batch-specific cells [<xref ref-type="bibr" rid="CR6">6</xref>] (See Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S2a for the complete “DC” dataset). So, we named the processed dataset as “DC_rm.” iMAP clearly separates the two batch-specific cell types, and well-integrates other batch-shared cell types (Fig. <xref rid="Fig2" ref-type="fig">2</xref>a). We also performed batch effect removals and visualizations using nine leading batch effect removal methods, including Combat, LIGER, fastMNN, BBKNN, Harmony, Scanorama, Seurat v3, scVI, and DESC (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S2; the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section). And it becomes challenging for some MNN pairs-based methods, such as Seurat v3, fastMNN, Harmony, Scanorama, and BBKNN to reliably discriminate these two biologically similar but batch-specific cell types. In contrast, iMAP, Combat, scVI, and DESC could clearly identify and separate them from others, although the former two methods perform much better integration of two batches (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S3). Quantitative analyses show that only iMAP and Combat give all LISI values closer to the best theoretical values (Fig. <xref rid="Fig2" ref-type="fig">2</xref>b), and the proportions of true positive cells of them (iMAP: 97.6%; Combat: 97.4%) are larger than other methods (Fig. <xref rid="Fig2" ref-type="fig">2</xref>c). This demonstrates that iMAP could effectively identify the batch-specific but biologically similar cell types.
<fig id="Fig2"><label>Fig. 2</label><caption><p>Benchmarks of batch effect removal methods. <bold>a</bold> Visualizations of iMAP batch effect removal results on the “DC_rm” dataset. Three kinds of colors are used to illustrate the cell type, batch, and evaluation information. <bold>b</bold> iLISI values for two cell types and cLISI values obtained by different methods on the “DC_rm” datasets. The dashed lines (the same below) represent the best theoretical LISI values. <bold>c</bold> Quantitative assessments of different batch effect removal methods on the “DC_rm” dataset. Two indices—proportion of positive cells (surrounded by cells with the same cell type) and proportion of true positive cells (surrounded by appropriate fractions of cells from different batches)—are adopted. <bold>d</bold> Visualizations of iMAP batch effect removal results on the “cell_lines” dataset. <bold>e</bold> Distributions of LISI values on the “cell_lines” dataset. <bold>f</bold> Quantitative assessments of different batch effect removal methods on the “cell_lines” dataset. See also Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S2, 3, 4, 5</p></caption><graphic xlink:href="13059_2021_2280_Fig2_HTML" id="MO2"/></fig></p>
      <p id="Par8">The second dataset consists of three sub-datasets, including the “Jurkat” and “293 T” composed of cells from pure cell lines, and the “Mix” which is a 50/50 mix of cells from those two cell lines (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1). We named this dataset as “cell_lines.” iMAP perfectly divides all cells into two components, each including one type of cells, and within each component, cells from two batches, i.e., “Jurkat/Mix” or “293 T/Mix,” are well-mixed (Fig. <xref rid="Fig2" ref-type="fig">2</xref>d). We also performed batch effect removals and visualizations using other batch effect removal methods (DESC was not compared because it was not optimized for processing datasets containing pure cell types) and compared their performances with iMAP. All methods except Combat could discriminate these two cell types, but with various separation capacities. fastMNN, LIGER, and Seurat v3 show inferior division of two cell types. For the integration power, iMAP and Harmony are notably stronger than others, while iMAP makes even better mixture than Harmony (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S4). Quantitative metrics show that iMAP performs the best on this dataset. cLISI values and iLISI values of iMAP are much closer to the best theoretical lines (Fig. <xref rid="Fig2" ref-type="fig">2</xref>e). The proportion of true positive cells of iMAP is 94.2%, and the next best value obtained by Harmony is 82.8%. All others give values less than 75% (Fig. <xref rid="Fig2" ref-type="fig">2</xref>f). We also adopted kBET to evaluate the integration of batch-shared cell types, and iMAP also gives the best performance (the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S5). These demonstrate the ability of iMAP to match the distributions of the same cell type from different batches.</p>
    </sec>
    <sec id="Sec5">
      <title>Integration of human pancreas datasets</title>
      <p id="Par9">Next, we used iMAP to integrate human pancreas cells sequenced by different platforms, further assessing its performance and exploring its algorithmic properties. The whole dataset, named as “panc,” contains five sub-datasets, including “inDrop,” “CEL-seq,” “CEL-seq2,” “Smart-seq2,” and “Fluidigm C1,” indicating the characteristic sequencing protocols they used [<xref ref-type="bibr" rid="CR20">20</xref>–<xref ref-type="bibr" rid="CR24">24</xref>] (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1; the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section). We still removed fractions of cells from some original datasets to ensure that certain batches included batch-specific cell types, for evaluating both the mixture of the distributions of the shared cell types between different batches and identification of those batch-specific cells. Particularly, we removed cells of two cell types with very large number of cells (i.e., “acinar” and “alpha” cells) from the “inDrop” sub-dataset, and “ductal” cells from the “CEL-seq” sub-dataset (See Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S2b for the complete “panc” dataset; see the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section for the exclusion criteria). The updated dataset was named as “panc_rm.” We then performed integration using iMAP and all nine benchmark methods, comparing their performances. As shown in Fig. <xref rid="Fig3" ref-type="fig">3</xref>a, after integration by iMAP, the “acinar” and “alpha” cells are barely mixed with other cells from “inDrop,” and so are the “ductal” cells for “CEL-seq.” At the same time, all cell types are almost perfectly separated from others and the shared cell types from different platforms are well-mixed with each other. However, Harmony, LIGER, and Seurat v3 improperly mix one or more of “acinar,” “alpha,” and “ductal” cells with other cell types, while Combat, Scanorama, fastMNN, BBKNN, scVI, and DESC identify these batch-specific cell types, but with very limited integration of those shared cell types (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S6). Quantitative evaluation also indicates iMAP shows superior performance over all other methods, with 65.8% cells classified as true positive cells, whereas none of others could obtain over 50% of true positive cells (the next best method Seurat v3 has 40.9% true positive cells) (Fig. <xref rid="Fig3" ref-type="fig">3</xref>b). This demonstrates that iMAP can successfully integrate cells from multiple platforms with various numbers of cells and diverse compositions of cell types.
<fig id="Fig3"><label>Fig. 3</label><caption><p>Integration of human pancreas datasets. <bold>a</bold> Visualizations of iMAP batch effect removal results on the “panc_rm” dataset. Three kinds of colors are used to illustrate the cell type, batch, and evaluation information. <bold>b</bold> Quantitative assessments of different batch effect removal methods on the “panc_rm” dataset. See also Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S2, 5, 6. <bold>c</bold> The training process of the “panc_rm” dataset. The changes of loss values versus epochs for all four loss functions of two stages are shown. <bold>d</bold> Running stability of iMAP. We re-ran the iMAP on the “panc_rm” dataset for 20 times, and computed the proportions of positive and true positive cells. The marked black points are the best results obtained by other methods. <bold>e</bold> Stage I increasing the number of MNN pairs. <bold>f</bold> The rwMNN procedure boosting the proportion of true positive cells. The “Smart-seq2” and “inDrop” sub-datasets of the “panc” dataset were used to compare the number of MNN pairs. See also Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S11. <bold>g</bold> Importance scores of selected genes for building the representations of each cell in stage I. <bold>h</bold> Importance scores of selected genes for removing batch effects in stage II</p></caption><graphic xlink:href="13059_2021_2280_Fig3_HTML" id="MO3"/></fig></p>
      <p id="Par10">In summary, on all three benchmark datasets, iMAP shows consistently better performance over all other methods in terms of both the identification of the batch-specific, even biologically similar cell types, and the integration of the shared cell types across multiple batches. To further demonstrate the robustness of iMAP, we additionally used iMAP and all other nine batch effect removal methods on two recently published benchmark datasets [<xref ref-type="bibr" rid="CR25">25</xref>], which sequenced thousands of cells from peripheral blood mononuclear cells and brain tissue respectively, with over ten protocols, covering most of single-cell and/or single-nucleus profiling methods (the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1). iMAP could still provide solid performance on these two complicated datasets (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S7). We also applied iMAP to remove batch effects on five additional datasets with various numbers of cells, various numbers of batches, and different sequencing platforms, where iMAP can all give solid integration performance (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S8; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S9; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1).</p>
    </sec>
    <sec id="Sec6">
      <title>The stability and interpretability of iMAP</title>
      <p id="Par11">We further used the “panc_rm” dataset to demonstrate the stability of iMAP under the effects of hyperparameters and stochasticity. iMAP as a deep learning-based framework involves multiple hyperparameters necessary to be exploited for obtaining the optimal performance for specific dataset, a critical one of which is the number of training epochs. We examined the training process of the two stages of iMAP on the “panc_rm” dataset (Fig. <xref rid="Fig3" ref-type="fig">3</xref>c), observing a sharp decrease of loss values during the first epochs of stage I, which indicates that the network quickly reconstructed the expression profiles and extracted the low-dimensional embeddings of biological contents. After about 50 epochs, the content loss displayed very limited fluctuations. The training for stage II was much harder, especially for the generator. In the beginning the generator loss showed large vibration, while all losses tended to be stable after about 50 epochs. We conclude that the performance of iMAP may have limited changes if the number of training epochs is about 50–200 for both two stages. iMAP is also robust to changes in other hyperparameters (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S10; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S3). Then, we sought to observe the effects of intrinsic stochasticity of iMAP on the performance by re-running the entire iMAP procedure for 20 times on the “panc_rm” dataset. As expected, there existed inevitable fluctuations for both the proportions of positive and true positive cells, although the lower bounds were much higher than the best results obtained by other methods (Fig. <xref rid="Fig3" ref-type="fig">3</xref>d).</p>
      <p id="Par12">As we claimed before, the representations built by stage I would significantly increase the number of MNN pairs between two batches and the rwMNN procedure would exert huge influence over pair-based batch effect removal in the stage II and the final integration results. We first compared the number of pairs between the “inDrop” and “Smart-seq2” sub-datasets using the original expression profiles with that obtained by representations from stage I. The number of MNN pairs obtained after stage I (with the median 8610 over 20 repeat runs) was much higher than that obtained without stage I (median = 3034) (Fig. <xref rid="Fig3" ref-type="fig">3</xref>e), showing representations built by stage I of cells with the same cell type but from different batches are more similar than the original expression profiles of them. We then inspected the effects of rwMNN, observing that the proportion of true positive cells was sharply decreased after eliminating the random walk procedures from stage II (the median value over 20 repeat runs was decreased from 59.5 to 37.6%) (Fig. <xref rid="Fig3" ref-type="fig">3</xref>f). This indicates that rwMNN can better sketch the distribution of cells and assist GAN in capturing and removing the batch effects (see also Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S4 and Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S11).</p>
      <p id="Par13">Finally, we tried to interpret the working mechanisms of our neural networks through assigning importance scores for each gene, to evaluate its impacts on building the representations and removing the batch effects of each cell [<xref ref-type="bibr" rid="CR26">26</xref>] (the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1c, d). The results showed that for the representations built by the encoder in the stage I, the most important genes were usually cell type-specific, and batch-neutral (Fig. <xref rid="Fig3" ref-type="fig">3</xref>g). For example, the gene <italic>GC</italic> was uniquely critical for representations of “alpha” cells, and we observed consistent importance scores across all five platforms (median values for “inDrop,” “Smart-seq2,” “CEL-seq,” “CEL-seq2,” and “Fluidigm C1” were 0.095, 0.095, 0.068, 0.076, and 0.098 respectively). In contrast, the most important genes for batch effect removal of stage II were mainly determined by batches, and most of them showed similar effects across all cell types (Fig. <xref rid="Fig3" ref-type="fig">3</xref>h). In summary, we provide a simple procedure to interpret our deep learning-based model and further prove our two-stage frameworks could convincingly remove the batch effects of scRNA-seq datasets.</p>
    </sec>
    <sec id="Sec7">
      <title>Application of iMAP on large-scale datasets</title>
      <p id="Par14">To demonstrate iMAP’s scalability on datasets with a large number of cells, we ran iMAP on the Tabula Muris dataset [<xref ref-type="bibr" rid="CR27">27</xref>], containing over 100,000 cells, each sequenced by the Smart-seq2 or 10x platform. iMAP could both reliably integrate cells from the same tissues but sequenced by separate platforms and identify cells from platform-specific tissues, such as brain, large intestine, skin, and pancreas, which were exclusively obtained by Smart-seq2 (Fig. <xref rid="Fig4" ref-type="fig">4</xref>a; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S12a). We further confirmed the integration power of iMAP by exploiting the cell types mixture within individual tissues. For example, in the liver tissue, overall seven distinctive cell types were captured by these two platforms, including five platform-specific cell types, i.e., B cell (Smart-seq2), duct epithelial cell (10x), Kupffer cell (Smart-seq2), leukocyte (10x), and natural killer cell (Smart-seq2) (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S12b). We observed that the above five platform-specific cell types were well separated, and platform-shared cell types, i.e., endothelial cell of hepatic sinusoid and hepatocyte, were integrated together (Fig. <xref rid="Fig4" ref-type="fig">4</xref>b). Besides the tissue-specific cells, we also noticed some tissue-shared endothelial cells, mesenchymal cells, and immune cells, indicating their great biological similarities across tissues (Fig. <xref rid="Fig4" ref-type="fig">4</xref>a). However, iMAP still recognized distinctive endothelial cells from hepatic sinusoid, lung, and kidney capillary (Fig. <xref rid="Fig4" ref-type="fig">4</xref>c), indicating the particular functions of these types of cells in biological processes, such as cancer metastasis [<xref ref-type="bibr" rid="CR28">28</xref>, <xref ref-type="bibr" rid="CR29">29</xref>].
<fig id="Fig4"><label>Fig. 4</label><caption><p>Integration of the large-scale Tabula Muris dataset. <bold>a</bold> Visualizations of iMAP batch effect removal results on the Tabula Muris dataset. Platform-specific tissues and tissue-shared cell types are marked. <bold>b</bold> Visualizations of cells from liver (subsets of <bold>a</bold>). Platform-specific cells are marked. <bold>c</bold> Visualizations of endothelial cells (subsets of <bold>a</bold>). <bold>d</bold>, <bold>e</bold> Time performance of iMAP. We ran iMAP multiple times using downsampled cells from Tabula Muris, to test the time cost versus the number of cells (<bold>d</bold>) and the number of batches (<bold>e</bold>). See also Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S12</p></caption><graphic xlink:href="13059_2021_2280_Fig4_HTML" id="MO4"/></fig></p>
      <p id="Par15">Then, we evaluated the time cost of iMAP versus the number of cells by downsampling from 500 to 100,000 cells of Tabula Muris (Fig. <xref rid="Fig4" ref-type="fig">4</xref>d; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S12c). Initially, the time cost increased linearly with respect to the number of cells. As the number exceeded about thousands, the running time kept approximately constant, considering the inescapable instabilities of machines. We further used iMAP to integrate two datasets with 320,642 cord blood and 335,616 bone marrow-derived cells from the Human Cell Atlas, and iMAP can effectively remove the batch effects in a few minutes on a standard Linux server (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S12d, e; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1; the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section). Finally, we simulated the effects of the number of batches on time costs. As shown in Fig. <xref rid="Fig4" ref-type="fig">4</xref>e, the running time increased linearly as the number of batches increased (the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section). In summary, iMAP could scale to large datasets with great integration powers and minimal time increasement with respect to the number of cells.</p>
    </sec>
    <sec id="Sec8">
      <title>iMAP identified mixed immune cell subsets and underappreciated interactions</title>
      <p id="Par16">To examine the ability of iMAP to generate new biological insights, we applied iMAP on a scRNA-seq dataset of tumor-infiltrating immune cells from colorectal cancer (CRC) [<xref ref-type="bibr" rid="CR30">30</xref>], which provides single-cell transcriptomes of over 50,000 immune cells from 18 CRC patients using both Smart-seq2 and 10x platforms. iMAP was adopted to remove the batch effects between two platforms and across different patients (the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section). The major cell types from both platforms were mostly correctly separated and well-integrated as shown by the UMAP embeddings [<xref ref-type="bibr" rid="CR31">31</xref>] plot (Fig. <xref rid="Fig5" ref-type="fig">5</xref>a, Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. 13a). Of note, a small number of CD4<sup>+</sup> effector T cells (CD4-GNLY) were located close to CD8<sup>+</sup> effector T cells (CD8-CX3CR1), mainly due to their similarly high expression of cytotoxicity-related genes (such as <italic>NKG7</italic>, <italic>GNLY</italic>), and their same tissue origin of blood (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S13a, b).
<fig id="Fig5"><label>Fig. 5</label><caption><p>Applications of iMAP on CRC tumor-infiltrating immune cells. <bold>a</bold> Visualizations of major cell types and integration performance of iMAP. <bold>b</bold> Comparisons of the number of detected genes, transcription factors (TFs), ligand-receptor genes, and the percent of ribosome genes, noncoding RNAs between original 10x data, corrected 10x data, and Smart-seq2 data. <bold>c</bold> Comparisons of the dropout-ratio distribution between original 10x data, corrected 10x data, and Smart-seq2 data. <bold>d</bold> Re-analyzed of ILC subsets after batch effect removal. We showed new defined clusters and platform distribution over clusters. <bold>e</bold> New refined CD8<sup>+</sup> T cell cluster with expression of key markers compared between original and corrected 10x data. <bold>f</bold> Significant ligand-receptor pairs (<italic>p</italic> &lt; 0.05) defined between cDCs and T cells. <bold>g</bold> Significant ligand-receptor pairs detected between cDCs and Th1-like cells (CD4-CXCL13) by Smart-seq2 and corrected 10x data. <bold>h</bold> Selected specific pairs identified between cDCs and Th1-like cells by corrected 10x data. See also Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S13</p></caption><graphic xlink:href="13059_2021_2280_Fig5_HTML" id="MO5"/></fig></p>
      <p id="Par17">Given that we can obtain the whole corrected transcriptomes of cells sequenced by 10x, it is possible to compare data from Smart-seq2 with original 10x data and batch-corrected 10x data on a global scale. As described previously, the number of detected genes for each cell obtained by 10x is significantly lower than that obtained by Smart-seq2 [<xref ref-type="bibr" rid="CR30">30</xref>, <xref ref-type="bibr" rid="CR32">32</xref>]. However, after iMAP correction, we recovered the dropout genes by 10x and boosted the number to be almost at the same level as Smart-seq2 (Fig. <xref rid="Fig5" ref-type="fig">5</xref>b). For example, the median number of detected genes across cells from tumor was 3994 for corrected 10x, which was close to the median number 4085 for Smart-seq2. Particularly, the detected number of transcription factors and ligand-receptors were also promoted, which may facilitate further analyses of regulatory and cell-cell interactions (Fig. <xref rid="Fig5" ref-type="fig">5</xref>b). We next systematically checked the dropout-ratio of each gene across all cells in each platform. As expected, the relationship between dropout-ratios of genes acquired by 10x and Smart-seq2 was strongly upper convex. Matching the distribution of gene expression by iMAP made the dropout-ratios between batches much more consistent (Pearson’s correlation = 0.9) (Fig. <xref rid="Fig5" ref-type="fig">5</xref>c). Besides recovering the specific dropout genes by 10x, our method could also appropriately decrease the percentage of ribosome genes and noncoding RNAs (Fig. <xref rid="Fig5" ref-type="fig">5</xref>b), which usually comprise a large number of the whole sequenced transcriptomes obtained by 10x [<xref ref-type="bibr" rid="CR32">32</xref>]. It is worth noting that the corrected 10x data were not just the same as that of Smart-seq2. For example, the variance of the number of detected genes was similar to the original 10x data, both smaller than that of Smart-seq2 (Fig. <xref rid="Fig5" ref-type="fig">5</xref>b). This may indicate iMAP could match the distribution of 10x and Smart-seq2 on average, but does not press to match each single cell.</p>
      <p id="Par18">For specific cell subsets, we noticed certain previously annotated innate lymphoid cells (ILCs), especially the NK-CD16 cells, from 10x were mixed with CD8<sup>+</sup> effector cells after batch correction (Fig. <xref rid="Fig5" ref-type="fig">5</xref>a; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S13b). Such mixture could be caused by the high dropout-ratio of key marker genes for major cell types sequenced by 10x, such as <italic>CD8A</italic>, <italic>CD8B</italic> for CD8<sup>+</sup> T cells, and <italic>CD4</italic> for CD4<sup>+</sup> T cells (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S13c). Another possibility could be the functional similarity of CD16<sup>+</sup> NK cells to their T and NKT counterparts, with the main transcriptomic distinctiveness of these NK cells being devoid of expression of T cell receptors and its associated adapters and co-receptors [<xref ref-type="bibr" rid="CR33">33</xref>]. To better characterize ILCs, we re-clustered the defined ILCs from the original publication using batch effect-removed data and identified overall 5 clusters (Fig. <xref rid="Fig5" ref-type="fig">5</xref>d). The C3_NK-GZMK, C4_ILC3_SLC4A10, and C5-NK_CD103 were nearly identical to original annotations, and cells from 10x and Smart-seq2 were appropriately integrated (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S13d). However, the original NK-CD16 cells were clearly divided into two clusters, with one of them, C1_CD8T, showing significantly high expression of <italic>CD8A</italic>, <italic>CD8B</italic>, <italic>CD3D</italic>, <italic>CD3E</italic>, and <italic>CD3G</italic> (Fig. <xref rid="Fig5" ref-type="fig">5</xref>e). We further found that this cluster was 10x-specific and mainly from the blood, and in the original 10x data, these genes had already been detected sporadically (Fig. <xref rid="Fig5" ref-type="fig">5</xref>e). Therefore, it was reasonable to assume these pre-defined ILCs may be CD8<sup>+</sup> effector T cells, although further evidence, such as TCR information should be considered. Considering that NK cells have attracted many research interests in recent years because of its enormous potentials for cancer immunotherapy [<xref ref-type="bibr" rid="CR34">34</xref>–<xref ref-type="bibr" rid="CR36">36</xref>], it should be careful to discern them from CD8<sup>+</sup> effector T cells, especially with droplet-based sequencing technologies.</p>
      <p id="Par19">Finally, we explored novel cell-cell interactions uncovered by corrected 10x data. We focused on the interactions between DCs and T cells, because of the central roles of DCs in the cell-cell interaction network of the CRC tumor microenvironment [<xref ref-type="bibr" rid="CR30">30</xref>]. We found that 10x could detect a comparable number of significant ligand-receptor pairs between cDC subsets (cDC2-CD1C and cDC1-BATF3) and various kinds of T cell subsets after batch effect removal (the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section; Fig. <xref rid="Fig5" ref-type="fig">5</xref>f). Among CD4<sup>+</sup> T cells, the Th1-like cells (CD4-CXCL13) had the largest number of interaction pairs with both cDC2 and cDC1. Given the pivotal role of these cells in the CRC microenvironment and immunotherapies [<xref ref-type="bibr" rid="CR37">37</xref>], we further dissected the predicted ligand-receptor pairs between cDCs and Th1-like cells. We found a high overlap of significant pairs between cDCs and Th1-like cells identified by Smart-seq2 and corrected 10x data (Fig. <xref rid="Fig5" ref-type="fig">5</xref>g). However, many specific interaction pairs were only captured by corrected 10x data, possibly because of the larger number of cells and distinctive proportions of cell types. For example, cDCs could secrete chemokines, such as <italic>CXCL8</italic>, to recruit Th1-like cells into tumor with the bonding of <italic>CXCR2</italic>. Additionally, the co-stimulatory ligand <italic>TNFSF4</italic> (OX40L) and its receptor <italic>TNFRSF4</italic> (OX40) were also highly expressed in cDCs and Th1-like cells, respectively. Their significant interaction may play an essential role in Th1-like cell activations in the CRC microenvironment [<xref ref-type="bibr" rid="CR38">38</xref>], which may impact the anti-CD40 agonist treatment [<xref ref-type="bibr" rid="CR30">30</xref>]. These observed novel interactions have the potential to facilitate the process of Th1-like cell recruitment and activation. Furthermore, the Th1-like cells in turn could interact with those cDCs through GAS6-AXL, IL24-NOTCH2, and IL6-IL6 receptor pairs, suggesting complex interactions between these cells within immune systems in tumors (Fig. <xref rid="Fig5" ref-type="fig">5</xref>h). Collectively, our iMAP may help tap further potentials of 10x in terms of exploring novel cell-cell interactions.</p>
    </sec>
  </sec>
  <sec id="Sec9">
    <title>Discussion</title>
    <p id="Par20">iMAP addresses the fundamental batch effect removal problem in the application of single-cell transcriptomes. It takes the gene expression profile matrices from different batches as inputs and outputs the corrected expression profiles. Our model combines the powers of both autoencoders and GANs. We deploy a novel autoencoder structure to help build disentangled batch-ignorant representations of cells. Autoencoders can retain the biological contents of cells, which is necessary for identifying the batch-specific cells, while it is difficult for them to well-mix the batch-shared cells. We further train one GAN model using extended MNN pairs between batches. These pairs, named as rwMNN pairs, searched by the representations of autoencoders and extended by a random walk-based procedure, could better encapsulate the underlying distributions of the shared cell types between batches. GANs trained on rwMNN pairs could perfectly mix the distributions of the shared cell types. On multiple benchmark datasets, iMAP shows superior performance in terms of both discerning the batch-specific cells and mixing the batch-shared cell types.</p>
    <p id="Par21">iMAP shows minimal time cost increasement when the cell number exceeds thousands, providing possible huge potentials to apply on very large-scale single-cell studies. The excellent time performance is achieved by elaborated algorithm design and powerful computational performance of GPUs (the “<xref rid="Sec11" ref-type="sec">Methods</xref>” section). However, further improvements are still needed to decrease the time cost with respect to the number of batches. The training of iMAP, like all other deep learning-based models, involves lots of indispensable stochasticity and amounts of tunable hyperparameters implied in the network architectures and optimization procedures. It may require fine-tuning some or all of these parameters to obtain best performance on single specific application, although the default settings could already give solid performance in our tested benchmark datasets. In our current model, one dataset is specified as the anchor, whose expression profile would not be corrected. Further improvements may need to escape the selection of anchor and recover more precise single-cell transcriptomes. Although we propose a framework to interpret the working mechanism of iMAP, the two importance scores are still primarily heuristic and we expect more advancements in the interpretability of deep models for their applications on biological systems.</p>
    <p id="Par22">One main expectancy of integration of datasets from multiple sources is to fully utilize the useful sides of each of the sources. We demonstrate the application of iMAP on one study of CRC tumor-infiltrating immune cells. Cells were sequenced by two complementary scRNA-seq platforms—Smart-seq2 and 10x. iMAP could bring down the dropout-ratio of 10x to the level that is similar to that of Smart-seq2. This helped discriminate a plausible CD8<sup>+</sup> T effectors cell cluster from the previous annotated ILCs. Because of the larger number of cells captured by 10x and boosted number of detected ligand-receptor genes by iMAP, we discovered novel interactions between cDCs and Th1-like T cells, such as OX40L-OX40, which may provide new insights for cancer immunotherapies. Finally, our method may be easily extended to tackle other types of single-cell measurements. We expect this work to be further improved to suit the multi-dimensional nature of the new single cell data.</p>
  </sec>
  <sec id="Sec10">
    <title>Conclusion</title>
    <p id="Par23">We present a novel unsupervised deep learning-based framework, iMAP, to address the essential batch effect removal problems in the application of scRNA-seq technologies. By comparing with nine notable batch effect removal methods and testing over 10 real-world datasets, we show that iMAP has superior and robust performance in terms of both reliably discerning the batch-specific cells and effectively integrating the batch-shared cell types. We also demonstrate the scalability of iMAP on the integration of two mouse cell atlases. The time cost increase is minimum when the cell number exceeds thousands. iMAP could discover novel cell-cell interactions between cDC subsets and T cell subsets when applied to the integration of tumor microenvironment datasets sequenced by Smart-seq2 and 10x.</p>
  </sec>
  <sec id="Sec11">
    <title>Methods</title>
    <sec id="Sec12">
      <title>The iMAP model</title>
      <p id="Par24">The iMAP model was initially inspired by neural style transfer methodologies from the computer vision field [<xref ref-type="bibr" rid="CR17">17</xref>]. The essential objective of style transfer is to transfer natural images to paints plausibly created by one specific artist, while retaining the underlying image contents. Here we regarded different measuring processes of single-cell transcriptomes as specific “painting styles,” and then batch effect removal could be realized by transforming all cells into the same batch style. GAN-based models are current state-of-art frameworks for style transfer of images [<xref ref-type="bibr" rid="CR39">39</xref>]. Although hitherto, available style transfer models are designed specialized for images and not suitable for biological datasets.</p>
      <p id="Par25">The most difficult challenge for batch effect removal is to balance the tradeoff between discerning identification of the batch-specific cell types and sufficient mixing of the batch-shared cell types. To overcome this entangled matter, we formalize our iMAP integration model into two stages, with one stage of representation learning and the other stage of batch effect removal of the original expression profiles. Specially, we elaborate a novel autoencoder structure in the first stage, to build representations of effects of biological variations disentangled from measurement noises on single-cell transcriptomes. These representations could already discriminate the batch-specific cell types and roughly mix those shared between batches. Further in the second stage, we can successfully decipher and eliminate the batch effects on the expression profile of each single cell, by virtue of the strong power of GANs for mixing cell distributions from different batches. To make GANs easily capture and match different modes of shared biological variations across batches, we only employ those cells with plausibly similar biological content in the training process to avoid the possibly detrimental mixture of the batch-specific cells and devise a specialized random walk procedure to fully cover the underlying cell type distributions. Details were further explained below.</p>
      <sec id="Sec13">
        <title>Stage I: Disentangled representations of biological variations and measuring processes</title>
        <p id="Par26">We modeled the measured expression vector as the coupled effects of true biological variations and inevitable measurement noises. Although the measuring process may have distinctive effects on different cell types, it is reasonable to assume the true biological variations are independent of measuring noises. Considering that distilling the underlying biological contents from transcriptome measures is the critical step to remove the batch effects, we first designed a novel autoencoder structure to build representations of biological variations, which are expected to be disentangled from measuring noises.</p>
        <p id="Par27">Three forward neural networks are deployed in this stage, including one content encoder <italic>E</italic>, two generators (decoders) <italic>G</italic><sub>1</sub> and <italic>G</italic><sub>2</sub> (Fig. <xref rid="Fig1" ref-type="fig">1</xref>b). The inputs to the model include the expression vector of one cell denoted as <bold><italic>x</italic></bold>, and its batch indicator vector <italic>b</italic>. One-hot encoding strategy is used to indicate the batch of the cell. For instance, in the case of three batches, cells from the first batch have their batch indicator vector <italic>b</italic> = [1, 0, 0]<sup><italic>T</italic></sup>. The output of the encoder <italic>E</italic> is denoted as <italic>c</italic> = <italic>E</italic>(<italic>x</italic>), which is expected to exclusively represent the biological contents of cells, and be ignorant of the measuring process. The neural network <italic>G</italic><sub>1</sub> is deployed to generate the representation of measurement noise <italic>G</italic><sub>1</sub>(<italic>b</italic>), since the measurement noise cannot be fully captured by a simple one-hot vector. Another generator <italic>G</italic><sub>2</sub> is further used to finish the reconstruction of the original expression vector. The inputs to the generator <italic>G</italic><sub>2</sub> include both <italic>E</italic>(<italic>x</italic>) and <italic>b</italic>, because intuitively, it is possible for the generator to reconstruct the original measured expression vector only if both the biological content and measurement noise are simultaneously provided. The final reconstructed expression vector is <italic>G</italic>(<italic>E</italic>(<italic>x</italic>), <italic>b</italic>) = <italic>f</italic>(<italic>G</italic><sub>1</sub>(<italic>b</italic>) + <italic>G</italic><sub>2</sub>(<italic>E</italic>(<italic>x</italic>), <italic>b</italic>)), where <italic>f</italic> is a non-linear transformation, and is used to match the range of reconstructed vector with the original expression vector. The ReLU function <italic>f</italic>(<italic>x</italic>) = max(0, <italic>x</italic>) can be the default candidate for non-negative expression vectors. The reconstruction loss (<italic>ℇ</italic> represents expectation) can be formalized as:
<disp-formula id="Equa"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {L}_r={\varepsilon}_{x,b}{\left|\left|G\left(E(x),b\right)-x\right|\right|}^2 $$\end{document}</tex-math><mml:math id="M4" display="block"><mml:msub><mml:mi>L</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>ℇ</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mi>b</mml:mi></mml:mrow></mml:msub><mml:msup><mml:mfenced close="|" open="|"><mml:mfenced close="|" open="|"><mml:mrow><mml:mi>G</mml:mi><mml:mfenced close=")" open="(" separators=","><mml:mrow><mml:mi>E</mml:mi><mml:mfenced close=")" open="("><mml:mi>x</mml:mi></mml:mfenced></mml:mrow><mml:mi>b</mml:mi></mml:mfenced><mml:mo>−</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:mfenced></mml:mfenced><mml:mn>2</mml:mn></mml:msup></mml:math><graphic xlink:href="13059_2021_2280_Article_Equa.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par28">The key to successfully extract biological contents of one cell is to disentangle the biological representation <italic>c</italic> from the corresponding cell batch indicator <italic>b</italic>. We achieve this by deliberately generating a random batch indicator vector <inline-formula id="IEq2"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \overset{\sim }{b} $$\end{document}</tex-math><mml:math id="M6" display="inline"><mml:mover accent="true"><mml:mi>b</mml:mi><mml:mo stretchy="true">~</mml:mo></mml:mover></mml:math><inline-graphic xlink:href="13059_2021_2280_Article_IEq2.gif"/></alternatives></inline-formula> for each cell, where randomly selected one element is set to 1 while others to 0. Well-trained generators <italic>G</italic><sub>1</sub> and <italic>G</italic><sub>2</sub>, with <italic>E</italic>(<italic>x</italic>) and <inline-formula id="IEq3"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \overset{\sim }{b} $$\end{document}</tex-math><mml:math id="M8" display="inline"><mml:mover accent="true"><mml:mi>b</mml:mi><mml:mo stretchy="true">~</mml:mo></mml:mover></mml:math><inline-graphic xlink:href="13059_2021_2280_Article_IEq3.gif"/></alternatives></inline-formula> as inputs, should fabricate one cell with the same content as <italic>x</italic>. This inspired our content loss as:
<disp-formula id="Equb"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {L}_c={\varepsilon}_{x,\overset{\sim }{b}}{\left|\left|E\left(G\left(E(x),\overset{\sim }{b}\right)\right)-E(x)\right|\right|}^2 $$\end{document}</tex-math><mml:math id="M10" display="block"><mml:msub><mml:mi>L</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>ℇ</mml:mi><mml:mrow><mml:mi>x</mml:mi><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mi>b</mml:mi><mml:mo stretchy="true">~</mml:mo></mml:mover></mml:mrow></mml:msub><mml:msup><mml:mfenced close="|" open="|"><mml:mfenced close="|" open="|"><mml:mrow><mml:mi>E</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>G</mml:mi><mml:mfenced close=")" open="(" separators=","><mml:mrow><mml:mi>E</mml:mi><mml:mfenced close=")" open="("><mml:mi>x</mml:mi></mml:mfenced></mml:mrow><mml:mover accent="true"><mml:mi>b</mml:mi><mml:mo stretchy="true">~</mml:mo></mml:mover></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>−</mml:mo><mml:mi>E</mml:mi><mml:mfenced close=")" open="("><mml:mi>x</mml:mi></mml:mfenced></mml:mrow></mml:mfenced></mml:mfenced><mml:mn>2</mml:mn></mml:msup></mml:math><graphic xlink:href="13059_2021_2280_Article_Equb.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par29">In summary, the overall loss function of the first stage is:
<disp-formula id="Equc"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \underset{G,E}{\min }{\lambda}_c{L}_c+{\lambda}_r{L}_r $$\end{document}</tex-math><mml:math id="M12" display="block"><mml:munder><mml:mo>min</mml:mo><mml:mrow><mml:mi>G</mml:mi><mml:mo>,</mml:mo><mml:mi>E</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mi>λ</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:msub><mml:mi>L</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>λ</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:msub><mml:mi>L</mml:mi><mml:mi>r</mml:mi></mml:msub><mml:mspace width="0.25em"/></mml:math><graphic xlink:href="13059_2021_2280_Article_Equc.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par30">where <italic>λ</italic><sub><italic>c</italic></sub> and <italic>λ</italic><sub><italic>r</italic></sub> are tunable hyperparameters to make tradeoffs between the content and reconstruction loss. In our experiments, this loss function can be optimized at low operating cost, to obtain sufficiently good representations, especially for the identification of the batch-specific cells. However, the overwhelming researches in the field of deep learning have confirmed that it is hard to generate images indistinguishable from true ones by only optimizing the reconstruction loss of autoencoders [<xref ref-type="bibr" rid="CR40">40</xref>], which inspired us to add the adversarial structures in the stage II, further removing the batch effects from the original expression profiles.</p>
      </sec>
      <sec id="Sec14">
        <title>Stage II: Batch effect removal by GANs</title>
        <p id="Par31">Although in the ideal case, the representations built from the previous stage should be independent of the batch effects, according to our trials, it is hard to retrieve the corrected expression profiles only by the generators <italic>G</italic><sub>1</sub> and <italic>G</italic><sub>2</sub>. Therefore, we further use a GAN-based model to almost perfectly match the data distributions of the shared cell types across different batches and then generate the corrected expression profiles in the stage II. The basic idea here is to transform cells from all other batches to pseudo-cells of one pre-selected “anchor” batch, and the pseudo-cells are expected to be indistinguishable from true cells of the anchor batch. By indistinguishableness, we do not pursue perfect overlap with true cells for each single pseudo-cell, but endeavor to match the distribution of pseudo-cells with the distribution of true cells with the same or similar biological contents.</p>
        <p id="Par32">We adopt a specialized MNN pair-based strategy to guide the integration, for only matching the distributions of cells from the shared cell types between two batches. An MNN pair is defined as a set of two cells from two batches respectively, that each cell is among the <italic>k</italic> nearest across-batch neighbors of the other cell [<xref ref-type="bibr" rid="CR9">9</xref>]. We use the encoder output <italic>E</italic>(<italic>x</italic>) from the stage I to define MNN pairs, because these representations are supposed to be batch effect independent, resulting in a larger number of MNN pairs than using the original expression vectors, as we shown in Fig. <xref rid="Fig3" ref-type="fig">3</xref>e. Other methods based on MNN pairs may regard these pairs as anchors and then use a weighted averaging strategy to correct all other cells. One major potential drawback of the MNN pairs is that it is hard to assure these pairs could cover the complete distributions of cells from the shared cell types (Fig. <xref rid="Fig1" ref-type="fig">1</xref>d). We alternatively develop a novel random walk-based strategy to expand the MNN pair list. As shown in Fig. <xref rid="Fig1" ref-type="fig">1</xref>d, suppose cell <italic>a</italic><sub>1</sub> from batch 1 and cell <italic>a</italic><sub>2</sub> from batch 2 are selected as an MNN pair. Among the <italic>k</italic><sub>1</sub> nearest neighbors of <italic>a</italic><sub>1</sub> from batch 1, we randomly pick one cell <italic>b</italic><sub>1</sub>. The same procedure would give one <italic>b</italic><sub>2</sub> cell from batch 2. Then, the set composed of <italic>b</italic><sub>1</sub> and <italic>b</italic><sub>2</sub> is regarded as an extended MNN pair, and also the next seed pair for random walk expansion. This process is repeated <italic>m</italic> times. For all MNN pairs, we could generate these kinds of new pairs. We call pairs obtained from this procedure as rwMNN pairs. The generated rwMNN pairs can better cover the distributions of matched cell types, which could facilitate the training of GANs (Fig. <xref rid="Fig3" ref-type="fig">3</xref>f). We argue that it is also beneficial to adopt rwMNN pairs for other MNN-based methods (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S11).</p>
        <p id="Par33">Next, we use those rwMNN pairs, denoted as <inline-formula id="IEq4"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {\left\{{\left({x}^{(1)},{x}^{(2)}\right)}_i\right\}}_{i=1}^M $$\end{document}</tex-math><mml:math id="M14" display="inline"><mml:msubsup><mml:mfenced close="}" open="{"><mml:msub><mml:mfenced close=")" open="(" separators=","><mml:msup><mml:mi>x</mml:mi><mml:mfenced close=")" open="("><mml:mn>1</mml:mn></mml:mfenced></mml:msup><mml:msup><mml:mi>x</mml:mi><mml:mfenced close=")" open="("><mml:mn>2</mml:mn></mml:mfenced></mml:msup></mml:mfenced><mml:mi>i</mml:mi></mml:msub></mml:mfenced><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>M</mml:mi></mml:msubsup></mml:math><inline-graphic xlink:href="13059_2021_2280_Article_IEq4.gif"/></alternatives></inline-formula> (the superscript indexing its batch origin) to train the GAN model. This model is composed of two neural networks, one generator <italic>G</italic><sup>′</sup>, mapping cell expression vector <italic>x</italic><sup>(1)</sup> to a pseudo-cell expression vector <italic>G</italic><sup>′</sup>(<italic>x</italic><sup>(1)</sup>), and one discriminator <italic>D</italic><sup>′</sup>, discriminating the pseudo cell from the true expression vector <italic>x</italic><sup>(2)</sup>. The adversarial loss is:
<disp-formula id="Equd"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \underset{G^{\prime }}{\min}\underset{{\mathrm{D}}^{\prime }}{\max }{\boldsymbol{\varepsilon}}_{x^{(2)}}\left[\log {D}^{\prime}\left({x}^{(2)}\right)\right]+{\boldsymbol{\varepsilon}}_{x^{(1)}}\log \left[1-{D}^{\prime}\left({G}^{\prime}\left({x}^{(1)}\right)\right)\right] $$\end{document}</tex-math><mml:math id="M16" display="block"><mml:munder><mml:mo>min</mml:mo><mml:msup><mml:mi>G</mml:mi><mml:mo>′</mml:mo></mml:msup></mml:munder><mml:munder><mml:mo>max</mml:mo><mml:msup><mml:mi mathvariant="normal">D</mml:mi><mml:mo>′</mml:mo></mml:msup></mml:munder><mml:msub><mml:mi mathvariant="normal">ℇ</mml:mi><mml:msup><mml:mi>x</mml:mi><mml:mfenced close=")" open="("><mml:mn>2</mml:mn></mml:mfenced></mml:msup></mml:msub><mml:mfenced close="]" open="["><mml:mrow><mml:mo>log</mml:mo><mml:msup><mml:mi>D</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mfenced close=")" open="("><mml:msup><mml:mi>x</mml:mi><mml:mfenced close=")" open="("><mml:mn>2</mml:mn></mml:mfenced></mml:msup></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>+</mml:mo><mml:msub><mml:mi mathvariant="normal">ℇ</mml:mi><mml:msup><mml:mi>x</mml:mi><mml:mfenced close=")" open="("><mml:mn>1</mml:mn></mml:mfenced></mml:msup></mml:msub><mml:mo>log</mml:mo><mml:mfenced close="]" open="["><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msup><mml:mi>D</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mfenced close=")" open="("><mml:mrow><mml:msup><mml:mi>G</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mfenced close=")" open="("><mml:msup><mml:mi>x</mml:mi><mml:mfenced close=")" open="("><mml:mn>1</mml:mn></mml:mfenced></mml:msup></mml:mfenced></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="13059_2021_2280_Article_Equd.gif" position="anchor"/></alternatives></disp-formula></p>
        <p id="Par34">After training, all cells including those not in the rwMNN list could be transformed by the generator <italic>G</italic><sup>′</sup> to obtain the batch effect removal expression vectors.</p>
      </sec>
      <sec id="Sec15">
        <title>Implementation details</title>
        <p id="Par35">We deploy a total of five neural networks. Compared with the network structures, the specific number of neurons for each layer is of less importance for a reasonable number of input dimensions. By default, the encoder <italic>E</italic> from the first stage is a <italic>d</italic> → 1024 → 512 → <italic>l</italic> three-layer (not including the input layer) network (<italic>d</italic> is the input dimension of expression vectors, and <italic>l</italic> is the dimension of content representations). The decoder <italic>G</italic><sub>1</sub> is a <italic>n</italic> → 512 → 1024 → <italic>d</italic> three-layer network (<italic>n</italic> is the number of batches), and the decoder <italic>G</italic><sub>2</sub> is (<italic>n</italic> + <italic>l</italic>) → 512 → 1024 → <italic>d</italic>. For all networks, the first two layers have a Mish non-linear activation [<xref ref-type="bibr" rid="CR41">41</xref>], while the last layer is a linear transformation. Two parameters <italic>λ</italic><sub><italic>c</italic></sub> = 3, <italic>λ</italic><sub><italic>r</italic></sub> = 1 are used to balance the reconstruction loss and content loss. For the second stage, the generator <italic>G</italic><sup>′</sup> is a “shortcut connection” inspired by ResNet [<xref ref-type="bibr" rid="CR42">42</xref>], which means <italic>G</italic><sup>′</sup>(<italic>x</italic>) = <italic>f</italic>(<italic>F</italic>(<italic>x</italic>) + <italic>x</italic>) (<italic>f</italic> is a ReLU function), and <italic>F</italic> itself is an autoencoder structure, <italic>d</italic> → 1024 → 512 → <italic>l</italic> → 512 → 1024 → <italic>d</italic> (all layers are activated by Mish except the middle one). Be default, <italic>l</italic> is set to 256. The discriminator <italic>D</italic><sup>′</sup> is again a three-layer network <italic>d</italic> → 512 → 512 → 1. To facilitate and stabilize the GAN training process, adversarial losses are optimized via the WGAN-GP [<xref ref-type="bibr" rid="CR43">43</xref>]. We adopt the Adam optimizer [<xref ref-type="bibr" rid="CR44">44</xref>] to train the networks, with the learning rate 0.0005 for first stage and 0.0002 for the second.</p>
        <p id="Par36">In the stage II, we need to enquire the kNNs within batch and MNN pairs between batches for cells. This procedure may be compute-intensive. We randomly sample a maximum of <italic>s</italic> = 3000 cells from each batch to calculate all necessary pairs. Then, a locality sensitive hashing-based Python package “annoy” is adopted to quickly find the approximate nearest neighbors of each cell [<xref ref-type="bibr" rid="CR45">45</xref>]. These make the time cost of the enquiry process is approximately constant with respect to the number of cells in each batch. The overall time cost depends only on the number of batches and network optimization parameters (such as the number of epochs for training). Hyperparameters used in this stage include <italic>k</italic><sub>1</sub> = <italic>s</italic>/100, <italic>k</italic> = <italic>k</italic><sub>1</sub>/2, <italic>m</italic> = 50. All hyperparameters can be tunable by the user, although the default options could provide good enough results in most of our tested cases.</p>
        <p id="Par37">In order to deal with multiple datasets, we use an incremental matching manner. The sub-dataset with the largest total variance is selected as the anchor, and all other sub-datasets are processed in the decreasing order of their total variances. Every sub-dataset integrated to the anchor is appended to the anchor. Intuitively, the preferential integration order should arrange those sub-datasets with larger number of cell types firstly. If this information is available, we encourage the users to provide their own anchor and integration ordering. However, we argue that iMAP can also perform well to some extent even if the anchor sub-dataset lacks specific cell types. We demonstrate this in the “panc_rm” dataset, where the “inDrop” batch was selected as the anchor.</p>
        <p id="Par38">All jobs were run on a Linux server with 2x Intel(R) Xeon(R) CPU E5-2697 v4 @ 2.30GHz, 256G of DDR4 memory, Nvidia GTX 1080Ti GPU.</p>
      </sec>
      <sec id="Sec16">
        <title>Explanations of gene importance</title>
        <p id="Par39">The interpretability has gradually become more and more important in the machine learning community, particularly for the applications on biological researches [<xref ref-type="bibr" rid="CR46">46</xref>]. We adopt SHAP [<xref ref-type="bibr" rid="CR26">26</xref>], a well-designed game theory-based method to interpret the trained neural networks of iMAP, through grading each gene to evaluate its importance for the outputs of one cell. We provide two kinds of scores to interpreting gene’s importance, each for building representations in the stage I and removing batch effects in the stage II, respectively. Specially, a three-layer neural network is connected to the output of encoder from the stage I, and trained to classify the external cell type information, while the encoder would not be trained further. Then SHAP is used to evaluate the importance of each gene for the classification outputs (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1c). The other three-layer neural network is deployed to discriminate the batch-origin of each cell, and SHAP is again used to assign each gene an importance value for the classification of batch (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1d). This importance value is regarded as the surrogate for evaluating the importance of one gene in removing batch effects. We expect these two importance scores could offer primary heuristics about the working mechanisms of iMAP, and the roles of genes on representing biological variations and measuring noises.</p>
      </sec>
      <sec id="Sec17">
        <title>Preprocessing scRNA-seq datasets</title>
        <p id="Par40">Preprocessing of scRNA-seq datasets were performed under the standard Scanpy pipelines [<xref ref-type="bibr" rid="CR47">47</xref>]. Low-quality cells were filtered if the library size or the proportion of mitochondrial gene counts was too large. The input expression vectors for iMAP were log-transformed TPM-like values. Prior to the first stage, we need to select highly variable genes for each batch to help discover the true biological variations from the noisy transcriptomes. Only those genes measured in all batches were considered. The Scanpy API “scanpy.pp.highly_variable_genes” was used to select highly variable genes in each batch respectively, although users could also use their preferred highly variable genes selection method. For the second stage, by default, we also used the selected highly variable genes. It is also possible to deal with the whole transcriptome, as we did for the “CRC” dataset. However, to make our default network structure, which is specially designed for dealing with inputs of highly variable genes (usually about two thousand), suitable to the whole transcriptome (usually about twenty thousand genes), we randomly divided the whole transcriptome into ten parts, each with about two thousand genes, and trained ten separate networks for each of them (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S5). We did not take the pre-processing steps into account to measure the time cost shown in Fig. <xref rid="Fig4" ref-type="fig">4</xref>d, e.</p>
      </sec>
    </sec>
    <sec id="Sec18">
      <title>Benchmarks</title>
      <sec id="Sec19">
        <title>Datasets</title>
        <p id="Par41">Three commonly used scRNA-seq datasets were employed to evaluate the performance of different batch effect removal methods. The first dataset “panc_rm,” includes human pancreas cells measured by 5 different platforms. To measure the ability of different methods to detect the batch-specific cell types, we manually removed “ductal” cells from the “CEL-seq” dataset and “acinar,” “alpha” cells from the “inDrop” dataset. The “ductal” cell type has the largest number of cells in the “CEL-seq” sub-dataset. With their removal, the primary variance of “CEL-seq” may be determined by the second and third most numerous cell type, i.e., “acinar” and “alpha” cells. Then, we further removed these two cell types from another “inDrop” sub-dataset which was selected as the integration anchor. The second dataset “cell_lines,” is composed of three sub-datasets all sequenced by the 10x platform. Two of them are pure cell lines (“Jurkat” and “293 T”), and “Mix” is the equal mixture of “Jurkat” and “293 T.” For the “Mix” dataset, we performed the standard “Seurat” pipeline to cluster and annotate the cells. Those clusters with high expression of <italic>XIST</italic> were set as “293 T” while others as “Jurkat.” The third dataset “DC_rm,” consists of human DCs sequenced by the Smart-seq2 protocol. CD1C DCs in batch 1 and CD141 DCs in batch 2 were also removed, which are biologically similar.</p>
        <p id="Par42">Two recently published benchmark datasets “SCP424_PBMC” and “SCP425_cortex,” which sequenced thousands of cells from peripheral blood mononuclear cells and brain tissue respectively, with over ten protocols, covering most of single-cell and/or single-nucleus profiling methods, were also included for comparison of different methods. The log-10 K data, and meta information were downloaded from the Single Cell Portal (<ext-link ext-link-type="uri" xlink:href="https://singlecell.broadinstitute.org/single_cell">https://singlecell.broadinstitute.org/single_cell</ext-link>; Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1). We also tested the performance of iMAP on five additional datasets, with various numbers of cells, and detailed information can be found in Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1.</p>
        <p id="Par43">To test the performance, especially the time cost of iMAP for large-scale datasets, we ran iMAP on the Tabila Muris dataset, which consists of the mouse cells sequenced by two platforms, e.g., Smart-seq2 and 10x. The “UpdateSeuratObject” function updated the downloaded Seurat object to the version v3. The sequencing platforms were regarded as the batches. Another dataset containing over 600,000 cells from Human Cell Atlas was also adopted to test the scalability of iMAP, and its detailed information can be found in Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1.</p>
        <p id="Par44">The “CRC” dataset was used to test the applications of iMAP on the tumor microenvironments. Nearly 50,000 cells from human colon cancer were sequenced by either Smart-seq2 or 10x platforms. Cells from different patients sequenced by Smart-seq2 show less technical variations than those by 10x [<xref ref-type="bibr" rid="CR30">30</xref>]. Therefore, we regarded all cells from Smart-seq2 as a single batch, and every patient sequenced by 10x was a separate batch. Cell types and tissue sources information were obtained from the original publication.</p>
      </sec>
      <sec id="Sec20">
        <title>Benchmark methods</title>
        <p id="Par45">We compared our method with nine leading scRNA-seq batch effect removal methods: ComBat, scVI, LIGER, fastMNN, BBKNN, Harmony, Scanorama, Seurat v3, and DESC. See Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S2 for detailed version information. Combat and BBKNN correction were performed using the scanpy API “scanpy.pp.combat” and “scnpy.external.pp.bbknn.” scVI was run using the default parameters and obtained latent representations were used for further analysis. The “optimizeALS” parameter of LIGER was set to “<italic>k</italic> = 20.” We used the “SeuratWarpper” versions of fastMNN (“RunFastMNN”) and Harmony (“RunHarmony”). Scanorama was run using the default parameter of “scanorama.correct.” The dimensions parameters of Seurat v3 were all set to “dim = 1:30.” DESC was run with the default parameters, and especially the “louvain_resolution” was set as 1.0. Because some methods cannot give the corrected expression values, we compared them by using the UMAP embeddings. All embeddings were run by using the same parameters of the Python package “umap-learn.”</p>
      </sec>
      <sec id="Sec21">
        <title>Evaluation indices of batch effect removal</title>
        <p id="Par46">There exists an extensive list of batch effect removal evaluation indices in the literature [<xref ref-type="bibr" rid="CR6">6</xref>]. Some widely used include kBET (k-nearest neighbor batch-effect test) [<xref ref-type="bibr" rid="CR18">18</xref>], LISI (Local Inverse Simpson’s Index) [<xref ref-type="bibr" rid="CR13">13</xref>], ASW (average silhouette width), and ARI (adjusted rand index). We argue that ARI and ASW are cluster-level indices and cannot reliably evaluate the mixture of cells from different batch at a local single-cell level (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1a). kBET and LISI evaluate the batch mixing at a local level by comparing the batch distribution with kNNs of a cell with the global batch distribution. kBET has the advantage in evaluating the integration performance of batch-shared cell types, one drawback of which, however, is that when it measures the batch mixture, it is cell type ignorant. This may cause unfair results when the proportions of share cells types are too discrepant in different batches [<xref ref-type="bibr" rid="CR13">13</xref>]. LISI could evaluate both the capacity of identification batch-specific cell types and the integration of batch-shared cell types, but it is hard to summarize all single cell-level LISI values into a simple statistic for comparing between various methods. kBET and LISI are nonetheless reliable metrics when appropriated employed. So, we first used these two kinds of metrics to compare different methods. For kBET, we computed the acceptance rates for each cell type separately and summarized the median value over all tested cells as the final output. For the “DC_rm” and “panc_rm” datasets, only those cell types appearing in all batches were taken into account, and since no cell type appears in all three sub-datasets of “cell_lines,” we computed the acceptance rates for the integration of “Jurkat” and “Mix” and the integration of “293 T” and “Mix,” respectively. One important parameter <italic>k</italic>, the number of nearest neighbors, has a large effect on the results of kBET, and following the kBET paper, a series of <italic>k</italic> values, which are chosen as 5%, 10%, 15%, 20%, and 25% of the total cell numbers, are adopted to run kBET. For LISI, we computed the cLISI and iLISI values for each cell, with the ideal cLISI equal to one. iLISI values of different methods are compared for each cell type separately, because the best values are cell type-specific, and determined by the number of batches having this specific cell type [<xref ref-type="bibr" rid="CR13">13</xref>].</p>
        <p id="Par47">Considering that these indices all have their own limitations in terms of simultaneously evaluating both cell type and batch mixing, we propose two new indices to evaluate the batch mixture. Our evaluation procedure is also based on kNNs of a cell and divided into two successive steps (Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Fig. S1b). Firstly, we classify all cells into “positive” and “negative” cells. “Positive” cells are those surrounded mostly by cells from the same cell type. Be default, one cell is assigned as “positive” only if at least 50% cells of its kNNs are with the same cell type label, otherwise “negative” (<italic>k</italic> is set as the minimum of 100 and the number of cells for this cell type). Then, those positive cells are further discriminated into “true” and “false” positive cells by a second dichotomous classifier. “True” positive cells are those surrounded by appropriate proportions of cells with different batches. We use the three-sigma rule of thumb to measure whether the observed batch distribution of one positive cell’s neighborhood is consistent with the global batch distribution. Considering a cell with cluster label <italic>y</italic>, the number of cells from cell type <italic>y</italic> in all <italic>n</italic> batches are <italic>N</italic><sub>1</sub>, <italic>N</italic><sub>2</sub>, ⋯, <italic>N</italic><sub><italic>n</italic></sub> respectively. We define <italic>p</italic><sub><italic>i</italic></sub> = <italic>N</italic><sub><italic>i</italic></sub>/∑<sub><italic>j</italic></sub><italic>N</italic><sub><italic>j</italic></sub> for <italic>i</italic> = 1, 2, ⋯, <italic>n</italic>. Then, by expectation, if we sample <italic>k</italic> cells from cell type <italic>y</italic>, the number of cells from batch <italic>i</italic> is equal to <italic>kp</italic><sub><italic>i</italic></sub>. We regard a positive cell as true positive if the numbers of its neighbors from different batches are all within the range of 3 standard deviation around the expectation. This is to say, suppose kNNs of one true positive cell have the batch distribution <italic>k</italic><sub>1</sub>, <italic>k</italic><sub>2</sub>, ⋯, <italic>k</italic><sub><italic>N</italic></sub>, then <inline-formula id="IEq5"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ {k}_i\in \left[\max \left(0,k{p}_i-3\sqrt{k{p}_i\left(1-{p}_i\right)}\right),k{p}_i+3\sqrt{k{p}_i\left(1-{p}_i\right)}\right] $$\end{document}</tex-math><mml:math id="M18" display="inline"><mml:msub><mml:mi>k</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>∈</mml:mo><mml:mfenced close="]" open="[" separators=","><mml:mrow><mml:mo>max</mml:mo><mml:mfenced close=")" open="(" separators=","><mml:mn>0</mml:mn><mml:mrow><mml:mi>k</mml:mi><mml:msub><mml:mi>p</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>−</mml:mo><mml:mn>3</mml:mn><mml:msqrt><mml:mrow><mml:mi>k</mml:mi><mml:msub><mml:mi>p</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:msqrt></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>k</mml:mi><mml:msub><mml:mi>p</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:mn>3</mml:mn><mml:msqrt><mml:mrow><mml:mi>k</mml:mi><mml:msub><mml:mi>p</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:msqrt></mml:mrow></mml:mfenced></mml:math><inline-graphic xlink:href="13059_2021_2280_Article_IEq5.gif"/></alternatives></inline-formula> for all <italic>i</italic> = 1, 2, ⋯, <italic>n</italic>. By these two classification procedures, we could automatically identify those cells that are not mixed well. We use the proportions of positive and true positive cells as the quantitative indices to evaluate the performance of batch effect removal of different methods. This two-classifier system also provides an effective tool for visualizations of the batch effect removal results.</p>
      </sec>
    </sec>
    <sec id="Sec22">
      <title>Identification of significant ligand-receptor pairs</title>
      <p id="Par48">We used CellPhoneDB [<xref ref-type="bibr" rid="CR48">48</xref>] to analyze the interactions between different cell types. One pair with <italic>p</italic> value less than 0.05 was regarded as statistically significant.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Information</title>
    <sec id="Sec23">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="13059_2021_2280_MOESM1_ESM.docx">
            <caption>
              <p><bold>Additional file 1: Fig. S1.</bold> Illustrations of evaluation metrics and gene importance scores. <bold>Fig. S2.</bold> Visualizations of iMAP batch effect removal results on the complete ‘DC’ and ‘panc’ dataset. <bold>Fig. S3.</bold> Visualizations of nine benchmark methods on the ‘DC_rm’ dataset. <bold>Fig. S4.</bold> Visualizations of nine benchmark methods on the ‘cell_lines’ dataset. <bold>Fig. S5.</bold> Evaluation of different methods using kBET. <bold>Fig. S6.</bold> Visualizations of nine benchmark methods on the ‘panc_rm’ dataset. <bold>Fig. S7.</bold> The performance of iMAP on the SCP424_PBMC and SCP425_cortex. <bold>Fig. S8.</bold> Visualizations of batch effect removal results of iMAP on four additional datasets. <bold>Fig. S9.</bold> Visualizations of batch effect removal results of iMAP and DESC on the ‘macaque_retina’ dataset. <bold>Fig. S10.</bold> iMAP’s robustness over changes of hyperparameters. <bold>Fig. S11.</bold> rwMNN boosts the performance of original MNN-based correction method. <bold>Fig. S12.</bold> Integration of large-scale datasets by iMAP. <bold>Fig. S13.</bold> Integration of CRC tumor-infiltrating immune cells by iMAP. <bold>Table S1.</bold> Detailed information of scRNA-seq datasets. <bold>Table S2.</bold> The versions of software used. <bold>Table S3.</bold> The effects of the width and the depth of networks. <bold>Table S4.</bold> Ablation studies of iMAP. <bold>Table S5.</bold> Performance of iMAP with input of all genes.</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="13059_2021_2280_MOESM2_ESM.docx">
            <caption>
              <p><bold>Additional file 2.</bold> Review history.</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p>
        <bold>Publisher’s Note</bold>
      </p>
      <p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
    <fn>
      <p>Dongfang Wang and Siyu Hou contributed equally to this work.</p>
    </fn>
  </fn-group>
  <ack>
    <title>Acknowledgements</title>
    <p>We are thankful to all members of the Zhang lab for kind discussions.</p>
    <sec id="FPar1">
      <title>Review history</title>
      <p id="Par49">The review history is available as Additional file <xref rid="MOESM2" ref-type="media">2</xref>.</p>
    </sec>
    <sec id="FPar2">
      <title>Peer review information</title>
      <p id="Par50">Barbara Cheifet was the primary editor of this article and managed its editorial process and peer review in collaboration with the rest of the editorial team.</p>
    </sec>
  </ack>
  <notes notes-type="author-contribution">
    <title>Authors’ contributions</title>
    <p>Z.Z. and D.W. designed this project. D.W. and S.H. conceived the algorithm and developed the software. D.W. and S.H. performed the analysis. D.W., S.H., L.Z., X.W., and B.L. analyzed the CRC data and interpreted the results. D.W. and Z.Z. wrote the manuscript with input from all authors. The authors read and approved the final manuscript.</p>
  </notes>
  <notes notes-type="funding-information">
    <title>Funding</title>
    <p>This project was supported by Beijing Advanced Innovation Center for Genomics, Beijing Municipal Science &amp; Technology Commission, National Natural Science Foundation of China (81988101, 91742203, 91942307, 31991171, and Z201100005320014), and SLS-Qidong Innovation Fund.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Availability of data and materials</title>
    <p>The datasets used in this project are listed in Additional file <xref rid="MOESM1" ref-type="media">1</xref>: Table S1. The latest version of iMAP is freely available as a Python package on github (<ext-link ext-link-type="uri" xlink:href="https://github.com/Svvord/iMAP">https://github.com/Svvord/iMAP</ext-link>) under the MIT license [<xref ref-type="bibr" rid="CR49">49</xref>], and the source codes used to obtain the results presented in this article are available as a Zenodo archive with DOI 10.5281/zenodo.4461029 [<xref ref-type="bibr" rid="CR50">50</xref>].</p>
  </notes>
  <notes id="FPar3">
    <title>Ethics approval and consent to participate</title>
    <p id="Par51">Not applicable</p>
  </notes>
  <notes id="FPar4">
    <title>Consent for publication</title>
    <p id="Par52">Not applicable</p>
  </notes>
  <notes id="FPar5" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par53">X.W. and Z.Z. are either employee or founder of Analytical Biosciences Limited. The remaining authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Papalexi</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Single-cell RNA sequencing to explore immune cell heterogeneity</article-title>
        <source>Nat Rev Immunol</source>
        <year>2018</year>
        <volume>18</volume>
        <fpage>35</fpage>
        <lpage>45</lpage>
        <pub-id pub-id-type="doi">10.1038/nri.2017.76</pub-id>
        <?supplied-pmid 28787399?>
        <pub-id pub-id-type="pmid">28787399</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Pijuan-Sala</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Guibentif</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Gottgens</surname>
            <given-names>B</given-names>
          </name>
        </person-group>
        <article-title>Single-cell transcriptional profiling: a window into embryonic cell-type specification</article-title>
        <source>Nat Rev Mol Cell Biol</source>
        <year>2018</year>
        <volume>19</volume>
        <fpage>399</fpage>
        <lpage>412</lpage>
        <pub-id pub-id-type="doi">10.1038/s41580-018-0002-5</pub-id>
        <?supplied-pmid 29666443?>
        <pub-id pub-id-type="pmid">29666443</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Suva</surname>
            <given-names>ML</given-names>
          </name>
          <name>
            <surname>Tirosh</surname>
            <given-names>I</given-names>
          </name>
        </person-group>
        <article-title>Single-cell RNA sequencing in cancer: lessons learned and emerging challenges</article-title>
        <source>Mol Cell</source>
        <year>2019</year>
        <volume>75</volume>
        <fpage>7</fpage>
        <lpage>12</lpage>
        <pub-id pub-id-type="doi">10.1016/j.molcel.2019.05.003</pub-id>
        <?supplied-pmid 31299208?>
        <pub-id pub-id-type="pmid">31299208</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Leek</surname>
            <given-names>JT</given-names>
          </name>
          <name>
            <surname>Scharpf</surname>
            <given-names>RB</given-names>
          </name>
          <name>
            <surname>Bravo</surname>
            <given-names>HC</given-names>
          </name>
          <name>
            <surname>Simcha</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Langmead</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Johnson</surname>
            <given-names>WE</given-names>
          </name>
          <name>
            <surname>Geman</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Baggerly</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Irizarry</surname>
            <given-names>RA</given-names>
          </name>
        </person-group>
        <article-title>Tackling the widespread and critical impact of batch effects in high-throughput data</article-title>
        <source>Nat Rev Genet</source>
        <year>2010</year>
        <volume>11</volume>
        <fpage>733</fpage>
        <lpage>739</lpage>
        <pub-id pub-id-type="doi">10.1038/nrg2825</pub-id>
        <?supplied-pmid 20838408?>
        <pub-id pub-id-type="pmid">20838408</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stegle</surname>
            <given-names>O</given-names>
          </name>
          <name>
            <surname>Teichmann</surname>
            <given-names>SA</given-names>
          </name>
          <name>
            <surname>Marioni</surname>
            <given-names>JC</given-names>
          </name>
        </person-group>
        <article-title>Computational and analytical challenges in single-cell transcriptomics</article-title>
        <source>Nat Rev Genet</source>
        <year>2015</year>
        <volume>16</volume>
        <fpage>133</fpage>
        <lpage>145</lpage>
        <pub-id pub-id-type="doi">10.1038/nrg3833</pub-id>
        <?supplied-pmid 25628217?>
        <pub-id pub-id-type="pmid">25628217</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tran</surname>
            <given-names>HTN</given-names>
          </name>
          <name>
            <surname>Ang</surname>
            <given-names>KS</given-names>
          </name>
          <name>
            <surname>Chevrier</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Lee</surname>
            <given-names>NYS</given-names>
          </name>
          <name>
            <surname>Goh</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>A benchmark of batch-effect correction methods for single-cell RNA sequencing data</article-title>
        <source>Genome Biol</source>
        <year>2020</year>
        <volume>21</volume>
        <fpage>12</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-019-1850-9</pub-id>
        <?supplied-pmid 31948481?>
        <pub-id pub-id-type="pmid">31948481</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Johnson</surname>
            <given-names>WE</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Rabinovic</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Adjusting batch effects in microarray expression data using empirical Bayes methods</article-title>
        <source>Biostatistics</source>
        <year>2007</year>
        <volume>8</volume>
        <fpage>118</fpage>
        <lpage>127</lpage>
        <pub-id pub-id-type="doi">10.1093/biostatistics/kxj037</pub-id>
        <pub-id pub-id-type="pmid">16632515</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Welch</surname>
            <given-names>JD</given-names>
          </name>
          <name>
            <surname>Kozareva</surname>
            <given-names>V</given-names>
          </name>
          <name>
            <surname>Ferreira</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Vanderburg</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Martin</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Macosko</surname>
            <given-names>EZ</given-names>
          </name>
        </person-group>
        <article-title>Single-cell multi-omic integration compares and contrasts features of brain cell identity</article-title>
        <source>Cell</source>
        <year>2019</year>
        <volume>177</volume>
        <fpage>1873</fpage>
        <lpage>1887</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2019.05.006</pub-id>
        <?supplied-pmid 6716797?>
        <pub-id pub-id-type="pmid">31178122</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Haghverdi</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Lun</surname>
            <given-names>ATL</given-names>
          </name>
          <name>
            <surname>Morgan</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>Marioni</surname>
            <given-names>JC</given-names>
          </name>
        </person-group>
        <article-title>Batch effects in single-cell RNA-sequencing data are corrected by matching mutual nearest neighbors</article-title>
        <source>Nat Biotechnol</source>
        <year>2018</year>
        <volume>36</volume>
        <fpage>421</fpage>
        <lpage>427</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.4091</pub-id>
        <?supplied-pmid 29608177?>
        <pub-id pub-id-type="pmid">29608177</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Polanski</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Young</surname>
            <given-names>MD</given-names>
          </name>
          <name>
            <surname>Miao</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Meyer</surname>
            <given-names>KB</given-names>
          </name>
          <name>
            <surname>Teichmann</surname>
            <given-names>SA</given-names>
          </name>
          <name>
            <surname>Park</surname>
            <given-names>JE</given-names>
          </name>
        </person-group>
        <article-title>BBKNN: fast batch alignment of single cell transcriptomes</article-title>
        <source>Bioinformatics</source>
        <year>2020</year>
        <volume>36</volume>
        <fpage>964</fpage>
        <lpage>965</lpage>
        <?supplied-pmid 31400197?>
        <pub-id pub-id-type="pmid">31400197</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hie</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Bryson</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Berger</surname>
            <given-names>B</given-names>
          </name>
        </person-group>
        <article-title>Efficient integration of heterogeneous single-cell transcriptomes using Scanorama</article-title>
        <source>Nat Biotechnol</source>
        <year>2019</year>
        <volume>37</volume>
        <fpage>685</fpage>
        <lpage>691</lpage>
        <pub-id pub-id-type="doi">10.1038/s41587-019-0113-3</pub-id>
        <?supplied-pmid 31061482?>
        <pub-id pub-id-type="pmid">31061482</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stuart</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Butler</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Hoffman</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Hafemeister</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Papalexi</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Mauck</surname>
            <given-names>WM</given-names>
            <suffix>3rd</suffix>
          </name>
          <name>
            <surname>Hao</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Stoeckius</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Smibert</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Comprehensive integration of single-cell data</article-title>
        <source>Cell</source>
        <year>2019</year>
        <volume>177</volume>
        <fpage>1888</fpage>
        <lpage>1902</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2019.05.031</pub-id>
        <?supplied-pmid 31178118?>
        <pub-id pub-id-type="pmid">31178118</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Korsunsky</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Millard</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Fan</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Slowikowski</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Wei</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Baglaenko</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Brenner</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Loh</surname>
            <given-names>PR</given-names>
          </name>
          <name>
            <surname>Raychaudhuri</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Fast, sensitive and accurate integration of single-cell data with Harmony</article-title>
        <source>Nat Methods</source>
        <year>2019</year>
        <volume>16</volume>
        <fpage>1289</fpage>
        <lpage>1296</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0619-0</pub-id>
        <?supplied-pmid 31740819?>
        <pub-id pub-id-type="pmid">31740819</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lopez</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Regier</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Cole</surname>
            <given-names>MB</given-names>
          </name>
          <name>
            <surname>Jordan</surname>
            <given-names>MI</given-names>
          </name>
          <name>
            <surname>Yosef</surname>
            <given-names>N</given-names>
          </name>
        </person-group>
        <article-title>Deep generative modeling for single-cell transcriptomics</article-title>
        <source>Nat Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>1053</fpage>
        <lpage>1058</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-018-0229-2</pub-id>
        <?supplied-pmid 30504886?>
        <pub-id pub-id-type="pmid">30504886</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Lyu</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Pan</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Stambolian</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Susztak</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Reilly</surname>
            <given-names>MP</given-names>
          </name>
          <name>
            <surname>Hu</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Deep learning enables accurate clustering with batch effect removal in single-cell RNA-seq analysis</article-title>
        <source>Nat Commun</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>2338</fpage>
        <pub-id pub-id-type="doi">10.1038/s41467-020-15851-3</pub-id>
        <?supplied-pmid 32393754?>
        <pub-id pub-id-type="pmid">32393754</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Goodfellow</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Pouget-Abadie</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Mirza</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Xu</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Warde-Farley</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Ozair</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Courville</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Bengio</surname>
            <given-names>Y</given-names>
          </name>
        </person-group>
        <article-title>Generative adversarial nets</article-title>
        <source>Advances in neural information processing systems</source>
        <year>2014</year>
        <fpage>2672</fpage>
        <lpage>2680</lpage>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Gatys</surname>
            <given-names>LA</given-names>
          </name>
          <name>
            <surname>Ecker</surname>
            <given-names>AS</given-names>
          </name>
          <name>
            <surname>Bethge</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Image style transfer using convolutional neural networks</article-title>
        <source>Proceedings of the IEEE conference on computer vision and pattern recognition</source>
        <year>2016</year>
        <fpage>2414</fpage>
        <lpage>2423</lpage>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Buttner</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Miao</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Teichmann</surname>
            <given-names>SA</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>A test metric for assessing single-cell RNA-seq batch correction</article-title>
        <source>Nat Methods</source>
        <year>2019</year>
        <volume>16</volume>
        <fpage>43</fpage>
        <lpage>49</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-018-0254-1</pub-id>
        <?supplied-pmid 30573817?>
        <pub-id pub-id-type="pmid">30573817</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <mixed-citation publication-type="other">Villani A-C, Satija R, Reynolds G, Sarkizova S, Shekhar K, Fletcher J, Griesbeck M, Butler A, Zheng S, Lazo S, et al. Single-cell RNA-seq reveals new types of human blood dendritic cells, monocytes, and progenitors. Science. 2017;356:eaah4573.</mixed-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Grun</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Muraro</surname>
            <given-names>MJ</given-names>
          </name>
          <name>
            <surname>Boisset</surname>
            <given-names>JC</given-names>
          </name>
          <name>
            <surname>Wiebrands</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Lyubimova</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Dharmadhikari</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>van den Born</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>van Es</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Jansen</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Clevers</surname>
            <given-names>H</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>De novo prediction of stem cell identity using single-cell transcriptome data</article-title>
        <source>Cell Stem Cell</source>
        <year>2016</year>
        <volume>19</volume>
        <fpage>266</fpage>
        <lpage>277</lpage>
        <pub-id pub-id-type="doi">10.1016/j.stem.2016.05.010</pub-id>
        <?supplied-pmid 27345837?>
        <pub-id pub-id-type="pmid">27345837</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Muraro</surname>
            <given-names>MJ</given-names>
          </name>
          <name>
            <surname>Dharmadhikari</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Grun</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Groen</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Dielen</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Jansen</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>van Gurp</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Engelse</surname>
            <given-names>MA</given-names>
          </name>
          <name>
            <surname>Carlotti</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>de Koning</surname>
            <given-names>EJ</given-names>
          </name>
          <name>
            <surname>van Oudenaarden</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>A single-cell transcriptome atlas of the human pancreas</article-title>
        <source>Cell Syst</source>
        <year>2016</year>
        <volume>3</volume>
        <fpage>385</fpage>
        <lpage>394</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2016.09.002</pub-id>
        <?supplied-pmid 27693023?>
        <pub-id pub-id-type="pmid">27693023</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lawlor</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>George</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Bolisetty</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Kursawe</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Sun</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Sivakamasundari</surname>
            <given-names>V</given-names>
          </name>
          <name>
            <surname>Kycia</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Robson</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Stitzel</surname>
            <given-names>ML</given-names>
          </name>
        </person-group>
        <article-title>Single-cell transcriptomes identify human islet cell signatures and reveal cell-type-specific expression changes in type 2 diabetes</article-title>
        <source>Genome Res</source>
        <year>2017</year>
        <volume>27</volume>
        <fpage>208</fpage>
        <lpage>222</lpage>
        <pub-id pub-id-type="doi">10.1101/gr.212720.116</pub-id>
        <?supplied-pmid 27864352?>
        <pub-id pub-id-type="pmid">27864352</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Baron</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Veres</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Wolock</surname>
            <given-names>SL</given-names>
          </name>
          <name>
            <surname>Faust</surname>
            <given-names>AL</given-names>
          </name>
          <name>
            <surname>Gaujoux</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Vetere</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Ryu</surname>
            <given-names>JH</given-names>
          </name>
          <name>
            <surname>Wagner</surname>
            <given-names>BK</given-names>
          </name>
          <name>
            <surname>Shen-Orr</surname>
            <given-names>SS</given-names>
          </name>
          <name>
            <surname>Klein</surname>
            <given-names>AM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A single-cell transcriptomic map of the human and mouse pancreas reveals inter- and intra-cell population structure</article-title>
        <source>Cell Syst</source>
        <year>2016</year>
        <volume>3</volume>
        <fpage>346</fpage>
        <lpage>360</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cels.2016.08.011</pub-id>
        <?supplied-pmid 27667365?>
        <pub-id pub-id-type="pmid">27667365</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wang</surname>
            <given-names>YJ</given-names>
          </name>
          <name>
            <surname>Schug</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Won</surname>
            <given-names>K-J</given-names>
          </name>
          <name>
            <surname>Liu</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Naji</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Avrahami</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Golson</surname>
            <given-names>ML</given-names>
          </name>
          <name>
            <surname>Kaestner</surname>
            <given-names>KHJD</given-names>
          </name>
        </person-group>
        <article-title>Single-cell transcriptomics of the human endocrine pancreas</article-title>
        <source>Diabetes.</source>
        <year>2016</year>
        <volume>65</volume>
        <fpage>3028</fpage>
        <lpage>38</lpage>
        <pub-id pub-id-type="doi">10.2337/db16-0405</pub-id>
        <?supplied-pmid 27364731?>
        <pub-id pub-id-type="pmid">27364731</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ding</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Adiconis</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Simmons</surname>
            <given-names>SK</given-names>
          </name>
          <name>
            <surname>Kowalczyk</surname>
            <given-names>MS</given-names>
          </name>
          <name>
            <surname>Hession</surname>
            <given-names>CC</given-names>
          </name>
          <name>
            <surname>Marjanovic</surname>
            <given-names>ND</given-names>
          </name>
          <name>
            <surname>Hughes</surname>
            <given-names>TK</given-names>
          </name>
          <name>
            <surname>Wadsworth</surname>
            <given-names>MH</given-names>
          </name>
          <name>
            <surname>Burks</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Nguyen</surname>
            <given-names>LT</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Systematic comparison of single-cell and single-nucleus RNA-sequencing methods</article-title>
        <source>Nat Biotechnol</source>
        <year>2020</year>
        <volume>38</volume>
        <fpage>737</fpage>
        <lpage>746</lpage>
        <pub-id pub-id-type="doi">10.1038/s41587-020-0465-8</pub-id>
        <?supplied-pmid 32341560?>
        <pub-id pub-id-type="pmid">32341560</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Lundberg</surname>
            <given-names>SM</given-names>
          </name>
          <name>
            <surname>Lee</surname>
            <given-names>S-I</given-names>
          </name>
        </person-group>
        <article-title>A unified approach to interpreting model predictions</article-title>
        <source>Advances in neural information processing systems</source>
        <year>2017</year>
        <fpage>4765</fpage>
        <lpage>4774</lpage>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tabula Muris</surname>
            <given-names>C</given-names>
          </name>
          <collab>Overall c, Logistical c, Organ c, processing, Library p, sequencing, Computational data a, Cell type a, Writing g</collab>
          <etal/>
        </person-group>
        <article-title>Single-cell transcriptomics of 20 mouse organs creates a Tabula Muris</article-title>
        <source>Nature</source>
        <year>2018</year>
        <volume>562</volume>
        <fpage>367</fpage>
        <lpage>372</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-018-0590-4</pub-id>
        <pub-id pub-id-type="pmid">30283141</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Gervaz</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Scholl</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Mainguene</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Poitry</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Gillet</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Wexner</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Angiogenesis of liver metastases: role of sinusoidal endothelial cells</article-title>
        <source>Dis Colon Rectum</source>
        <year>2000</year>
        <volume>43</volume>
        <fpage>980</fpage>
        <lpage>986</lpage>
        <pub-id pub-id-type="doi">10.1007/BF02237364</pub-id>
        <?supplied-pmid 10910247?>
        <pub-id pub-id-type="pmid">10910247</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Benedicto</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Herrero</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Romayor</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Marquez</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Smedsrod</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Olaso</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Arteta</surname>
            <given-names>B</given-names>
          </name>
        </person-group>
        <article-title>Liver sinusoidal endothelial cell ICAM-1 mediated tumor/endothelial crosstalk drives the development of liver metastasis by initiating inflammatory and angiogenic responses</article-title>
        <source>Sci Rep</source>
        <year>2019</year>
        <volume>9</volume>
        <fpage>13111</fpage>
        <pub-id pub-id-type="doi">10.1038/s41598-019-49473-7</pub-id>
        <?supplied-pmid 31511625?>
        <pub-id pub-id-type="pmid">31511625</pub-id>
      </element-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhang</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Skrzypczynska</surname>
            <given-names>KM</given-names>
          </name>
          <name>
            <surname>Fang</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>O’Brien</surname>
            <given-names>SA</given-names>
          </name>
          <name>
            <surname>He</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Kim</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Single-cell analyses inform mechanisms of myeloid-targeted therapies in colon cancer</article-title>
        <source>Cell</source>
        <year>2020</year>
        <volume>181</volume>
        <fpage>442</fpage>
        <lpage>459</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2020.03.048</pub-id>
        <?supplied-pmid 32302573?>
        <pub-id pub-id-type="pmid">32302573</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Becht</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>McInnes</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Healy</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Dutertre</surname>
            <given-names>CA</given-names>
          </name>
          <name>
            <surname>Kwok</surname>
            <given-names>IWH</given-names>
          </name>
          <name>
            <surname>Ng</surname>
            <given-names>LG</given-names>
          </name>
          <name>
            <surname>Ginhoux</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Newell</surname>
            <given-names>EW</given-names>
          </name>
        </person-group>
        <article-title>Dimensionality reduction for visualizing single-cell data using UMAP</article-title>
        <source>Nat Biotechnol.</source>
        <year>2019</year>
        <volume>37</volume>
        <fpage>38</fpage>
        <lpage>44</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.4314</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <mixed-citation publication-type="other">Wang X, He Y, Zhang Q, Ren X, Zhang Z. Direct comparative analysis of 10X Genomics Chromium and Smart-seq2. 2019. Preprint at <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/615013v1">https://www.biorxiv.org/content/10.1101/615013v1</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Abel</surname>
            <given-names>AM</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Thakar</surname>
            <given-names>MS</given-names>
          </name>
          <name>
            <surname>Malarkannan</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Natural killer cells: development, maturation, and clinical utilization</article-title>
        <source>Front Immunol</source>
        <year>2018</year>
        <volume>9</volume>
        <fpage>1869</fpage>
        <pub-id pub-id-type="doi">10.3389/fimmu.2018.01869</pub-id>
        <?supplied-pmid 30150991?>
        <pub-id pub-id-type="pmid">30150991</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Khan</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Arooj</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Wang</surname>
            <given-names>H</given-names>
          </name>
        </person-group>
        <article-title>NK cell-based immune checkpoint inhibition</article-title>
        <source>Front Immunol</source>
        <year>2020</year>
        <volume>11</volume>
        <fpage>167</fpage>
        <pub-id pub-id-type="doi">10.3389/fimmu.2020.00167</pub-id>
        <?supplied-pmid 32117298?>
        <pub-id pub-id-type="pmid">32117298</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cheng</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Xiao</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Sun</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Tian</surname>
            <given-names>Z</given-names>
          </name>
        </person-group>
        <article-title>NK cell-based immunotherapy for malignant diseases</article-title>
        <source>Cell Mol Immunol</source>
        <year>2013</year>
        <volume>10</volume>
        <fpage>230</fpage>
        <lpage>252</lpage>
        <pub-id pub-id-type="doi">10.1038/cmi.2013.10</pub-id>
        <?supplied-pmid 23604045?>
        <pub-id pub-id-type="pmid">23604045</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <mixed-citation publication-type="other">Huntington ND, Cursons J, Rautela J. The cancer-natural killer cell immunity cycle. Nat Rev Cancer. 2020;1–18.</mixed-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhang</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Yu</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Zheng</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Fang</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Gao</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Kang</surname>
            <given-names>B</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Huang</surname>
            <given-names>JY</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Lineage tracking reveals dynamic relationships of T cells in colorectal cancer</article-title>
        <source>Nature</source>
        <year>2018</year>
        <volume>564</volume>
        <fpage>268</fpage>
        <lpage>272</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-018-0694-x</pub-id>
        <?supplied-pmid 30479382?>
        <pub-id pub-id-type="pmid">30479382</pub-id>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Webb</surname>
            <given-names>GJ</given-names>
          </name>
          <name>
            <surname>Hirschfield</surname>
            <given-names>GM</given-names>
          </name>
          <name>
            <surname>Lane</surname>
            <given-names>PJ</given-names>
          </name>
        </person-group>
        <article-title>OX40, OX40L and autoimmunity: a comprehensive review</article-title>
        <source>Clin Rev Allergy Immunol</source>
        <year>2016</year>
        <volume>50</volume>
        <fpage>312</fpage>
        <lpage>332</lpage>
        <pub-id pub-id-type="doi">10.1007/s12016-015-8498-3</pub-id>
        <?supplied-pmid 26215166?>
        <pub-id pub-id-type="pmid">26215166</pub-id>
      </element-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Jing</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Yang</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Feng</surname>
            <given-names>Z</given-names>
          </name>
          <name>
            <surname>Ye</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Yu</surname>
            <given-names>Y</given-names>
          </name>
          <collab>Song MJItov, graphics c</collab>
        </person-group>
        <source>Neural style transfer: a review</source>
        <year>2019</year>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Goodfellow</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Bengio</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Courville</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <source>Deep learning</source>
        <year>2016</year>
        <publisher-loc>Cambridge</publisher-loc>
        <publisher-name>MIT press</publisher-name>
      </element-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>DJapa</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <source>Mish: a self regularized non-monotonic neural activation function</source>
        <year>2019</year>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>He</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>X</given-names>
          </name>
          <name>
            <surname>Ren</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Sun</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Deep residual learning for image recognition</article-title>
        <source>Proceedings of the IEEE conference on computer vision and pattern recognition</source>
        <year>2016</year>
        <fpage>770</fpage>
        <lpage>778</lpage>
      </element-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Gulrajani</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Ahmed</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Arjovsky</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Dumoulin</surname>
            <given-names>V</given-names>
          </name>
          <name>
            <surname>Courville</surname>
            <given-names>AC</given-names>
          </name>
        </person-group>
        <article-title>Improved training of wasserstein gans</article-title>
        <source>Advances in neural information processing systems</source>
        <year>2017</year>
        <fpage>5767</fpage>
        <lpage>5777</lpage>
      </element-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Kingma</surname>
            <given-names>DP</given-names>
          </name>
          <collab>Ba JJapa</collab>
        </person-group>
        <source>Adam: a method for stochastic optimization</source>
        <year>2014</year>
      </element-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Slaney</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Casey</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Locality-sensitive hashing for finding nearest neighbors [lecture notes]</article-title>
        <source>IEEE Signal Process Mag</source>
        <year>2008</year>
        <volume>25</volume>
        <fpage>128</fpage>
        <lpage>31</lpage>
        <pub-id pub-id-type="doi">10.1109/MSP.2007.914237</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Molnar</surname>
            <given-names>C</given-names>
          </name>
        </person-group>
        <source>Interpretable machine learning</source>
        <year>2020</year>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Angerer</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title>
        <source>Genome Biol</source>
        <year>2018</year>
        <volume>19</volume>
        <fpage>15</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-017-1382-0</pub-id>
        <?supplied-pmid 29409532?>
        <pub-id pub-id-type="pmid">29409532</pub-id>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Efremova</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Vento-Tormo</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Teichmann</surname>
            <given-names>SA</given-names>
          </name>
          <name>
            <surname>Vento-Tormo</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>CellPhoneDB: inferring cell-cell communication from combined expression of multi-subunit ligand-receptor complexes</article-title>
        <source>Nat Protoc</source>
        <year>2020</year>
        <volume>15</volume>
        <fpage>1484</fpage>
        <lpage>1506</lpage>
        <pub-id pub-id-type="doi">10.1038/s41596-020-0292-x</pub-id>
        <?supplied-pmid 32103204?>
        <pub-id pub-id-type="pmid">32103204</pub-id>
      </element-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <mixed-citation publication-type="other">Wang DF, Hou SY, Zhang L, Wang XL, Liu BL, Zhang ZM. GitHub. 2021. <ext-link ext-link-type="uri" xlink:href="https://github.com/Svvord/iMAP">https://github.com/Svvord/iMAP</ext-link>. Accessed 13 July 2020.</mixed-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <mixed-citation publication-type="other">Wang DF, Hou SY, Zhang L, Wang XL, Liu BL, Zhang ZM. iMAP: integration of multiple single-cell datasets by adversarial paired transfer networks. Zenodo. 2021. 10.5281/zenodo.4461029.</mixed-citation>
    </ref>
  </ref-list>
</back>
