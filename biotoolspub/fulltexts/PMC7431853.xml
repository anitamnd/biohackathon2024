<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Sci Rep</journal-id>
    <journal-id journal-id-type="iso-abbrev">Sci Rep</journal-id>
    <journal-title-group>
      <journal-title>Scientific Reports</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2045-2322</issn>
    <publisher>
      <publisher-name>Nature Publishing Group UK</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">7431853</article-id>
    <article-id pub-id-type="publisher-id">70850</article-id>
    <article-id pub-id-type="doi">10.1038/s41598-020-70850-0</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Addressing the batch effect issue for LC/MS metabolomics data in data preprocessing</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Liu</surname>
          <given-names>Qin</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Walker</surname>
          <given-names>Douglas</given-names>
        </name>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Uppal</surname>
          <given-names>Karan</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Liu</surname>
          <given-names>Zihe</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Ma</surname>
          <given-names>Chunyu</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Tran</surname>
          <given-names>ViLinh</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Li</surname>
          <given-names>Shuzhao</given-names>
        </name>
        <xref ref-type="aff" rid="Aff4">4</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Jones</surname>
          <given-names>Dean P.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff3">3</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <name>
          <surname>Yu</surname>
          <given-names>Tianwei</given-names>
        </name>
        <address>
          <email>yutianwei@cuhk.edu.cn</email>
        </address>
        <xref ref-type="aff" rid="Aff5">5</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.24516.34</institution-id><institution-id institution-id-type="ISNI">0000000123704535</institution-id><institution>School of Software Engineering, </institution><institution>Tongji University, </institution></institution-wrap>Shanghai, 201804 China </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.59734.3c</institution-id><institution-id institution-id-type="ISNI">0000 0001 0670 2351</institution-id><institution>Department of Environmental Medicine and Public Health, </institution><institution>Icahn School of Medicine at Mount Sinai, </institution></institution-wrap>New York, NY 10029 USA </aff>
      <aff id="Aff3"><label>3</label><institution-wrap><institution-id institution-id-type="GRID">grid.189967.8</institution-id><institution-id institution-id-type="ISNI">0000 0001 0941 6502</institution-id><institution>Department of Medicine, School of Medicine, </institution><institution>Emory University, </institution></institution-wrap>Atlanta, GA 30322 USA </aff>
      <aff id="Aff4"><label>4</label><institution-wrap><institution-id institution-id-type="GRID">grid.249880.f</institution-id><institution-id institution-id-type="ISNI">0000 0004 0374 0039</institution-id><institution>The Jackson Laboratory, </institution></institution-wrap>Farmington, CT 06032 USA </aff>
      <aff id="Aff5"><label>5</label>School of Data Science, The Chinese University of Hong Kong – Shenzhen, Shenzhen, 518172 Guangdong Province China </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>17</day>
      <month>8</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>17</day>
      <month>8</month>
      <year>2020</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2020</year>
    </pub-date>
    <volume>10</volume>
    <elocation-id>13856</elocation-id>
    <history>
      <date date-type="received">
        <day>3</day>
        <month>2</month>
        <year>2020</year>
      </date>
      <date date-type="accepted">
        <day>28</day>
        <month>7</month>
        <year>2020</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2020</copyright-statement>
      <license license-type="OpenAccess">
        <license-p><bold>Open Access</bold>This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">With the growth of metabolomics research, more and more studies are conducted on large numbers of samples. Due to technical limitations of the Liquid Chromatography–Mass Spectrometry (LC/MS) platform, samples often need to be processed in multiple batches. Across different batches, we often observe differences in data characteristics. In this work, we specifically focus on data generated in multiple batches on the same LC/MS machinery. Traditional preprocessing methods treat all samples as a single group. Such practice can result in errors in the alignment of peaks, which cannot be corrected by post hoc application of batch effect correction methods. In this work, we developed a new approach that address the batch effect issue in the preprocessing stage, resulting in better peak detection, alignment and quantification. It can be combined with down-stream batch effect correction methods to further correct for between-batch intensity differences. The method is implemented in the existing workflow of the apLCMS platform. Analyzing data with multiple batches, both generated from standardized quality control (QC) plasma samples and from real biological studies, the new method resulted in feature tables with better consistency, as well as better down-stream analysis results. The method can be a useful addition to the tools available for large studies involving multiple batches. The method is available as part of the apLCMS package. Download link and instructions are at <ext-link ext-link-type="uri" xlink:href="https://mypage.cuhk.edu.cn/academics/yutianwei/apLCMS/">https://mypage.cuhk.edu.cn/academics/yutianwei/apLCMS/</ext-link>.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Data processing</kwd>
      <kwd>Scientific data</kwd>
      <kwd>Computational biology and bioinformatics</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>National Key R</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/100000002</institution-id>
            <institution>National Institutes of Health</institution>
          </institution-wrap>
        </funding-source>
        <award-id>U01CA235493</award-id>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© The Author(s) 2020</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1">
    <title>Introduction</title>
    <p id="Par2">Metabolomics using liquid chromatography-mass spectrometry (LC/MS) is widely used in identifying disease biomarkers, finding drug targets and unravelling complex biological networks. A high-resolution LC/MS profile from a complex biological sample contains thousands of features, and different LC/MS platforms yield profiles of different characteristics. There are a number of computational pipelines that conduct the necessary steps to preprocess LC/MS data, including peak detection, peak quantification, retention time (RT) correction, feature alignment, and weak signal recovery<sup><xref ref-type="bibr" rid="CR1">1</xref>–<xref ref-type="bibr" rid="CR13">13</xref></sup>. Some methods provide utilities to group features that are potentially derived from the same metabolite<sup><xref ref-type="bibr" rid="CR14">14</xref>–<xref ref-type="bibr" rid="CR17">17</xref></sup>. Other data servers and packages are available to annotate features to known metabolites based on m/z and RT information<sup><xref ref-type="bibr" rid="CR18">18</xref>–<xref ref-type="bibr" rid="CR21">21</xref></sup>.
</p>
    <p id="Par3">When the sample size is large, it is often necessary for the samples to be processed in batches. Across the batches, even if the data are generated from the same machine, we often observe different data characteristics. Using traditional data preprocessing approaches, we either treat all the samples as a single batch, or preprocess different batch individually, and then seek to merge the feature tables. As we discuss in the following, both of the approaches have some issues.</p>
    <p id="Par4">If we treat all samples as a single batch, the between-batch data characteristic changes will be considered as random noise. More lenient thresholds have to be used in feature alignment and weak signal recovery, in order to tolerate the between-batch differences. This can result in distinct features being artificially merged as a single feature. On the other hand, if a feature has a large drift in RT across batches, it may be artificially split into two features. The issue of misalignment caused by batch effect has been discussed in more detail by Brunius et al.<sup><xref ref-type="bibr" rid="CR22">22</xref></sup>.</p>
    <p id="Par5">An alternative approach is to preprocess each batch individually, followed by alignment of features between the feature tables from separate batches<sup><xref ref-type="bibr" rid="CR22">22</xref></sup>. This approach allows optimal alignment within each batch. However, without between-batch RT correction and weak signal recovery across batches, low intensity features that are initially identified in a subset of batches cannot be accurately quantified in the remaining batches.</p>
    <p id="Par6">Applying batch effect removal methods after preprocessing can alleviate some of the issues. They include methods that use quality control data to adjust for signal drift and inter-batch and intra-batch variations<sup><xref ref-type="bibr" rid="CR22">22</xref>–<xref ref-type="bibr" rid="CR26">26</xref></sup>, and some methods that use data characteristics without the need for quality control, mainly for between-batch adjustments<sup><xref ref-type="bibr" rid="CR27">27</xref>–<xref ref-type="bibr" rid="CR33">33</xref></sup>. However, such approaches can only adjust signal intensity. They cannot address issues such as misalignment of features across batches<sup><xref ref-type="bibr" rid="CR22">22</xref></sup>, or the incomplete weak signal recovery from the original data.</p>
    <p id="Par7">To tackle the afore-mentioned problems, we propose a new approach that preprocess the data in a two-stage manner. The method directly uses the batch information to allow optimal within-batch and between-batch alignments. Within each batch, every sample contains a small amount of nonlinear RT drift, which is typically addressed by nonlinear curve fitting<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR11">11</xref></sup>. Between batches, there may exist systematic RT drift. Both levels need to be adjusted for in the final data matrix. Another major issue is weak signal recovery across batches, as some peaks are too weak to pass the initial detection threshold, but can be later recovered based on the information of their counterparts in other samples. When such information come from other batches, accurate RT correction is critical for the faithful recovery of the weak signal. In our two-stage approach, the RT adjustment is based on cumulative nonlinear curve-fitting, which allows weak signal recovery across batches. Using a dataset from a quality control sample, a yeast cell line dataset, and a dataset generated from healthy human plasma samples, we show the method offers higher consistency in feature quantification for studies involving multiple batches, yielding better results in down-stream analyses.</p>
  </sec>
  <sec id="Sec2">
    <title>Materials and methods</title>
    <sec id="Sec3">
      <title>The overall workflow</title>
      <p id="Par8">Different from the traditional workflow, the proposed method includes a two-stage procedure (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a). In the traditional workflow used by XCMS<sup><xref ref-type="bibr" rid="CR5">5</xref></sup> and apLCMS<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>, peaks are first identified in the individual profiles based on certain filters, and quantified using certain mathematical peak shape models. Then RT correction is conducted between the profiles, and peaks from different profiles are aligned into features. Then a weak signal recovery step is conducted, in order to capture feature signals that are not strong enough to pass the initial peak detection threshold.<fig id="Fig1"><label>Figure 1</label><caption><p>Illustration of the two-stage preprocessing approach. (<bold>a</bold>) The overall workflow. (<bold>b</bold>) Illustration of the calculation of RT shift for individual samples. (<bold>c</bold>) Example between-batch RT shift calculated from a real dataset.</p></caption><graphic xlink:href="41598_2020_70850_Fig1_HTML" id="MO1"/></fig></p>
      <p id="Par9">The new approach is divided into two stages. In the first stage (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, step 1), the method processes each batch individually by using the common preprocessing workflow that consists of peak detection/quantification, RT adjustment, peak alignment and weak signal recovery. The nonlinear curves for RT adjustment is recorded for each sample.</p>
      <p id="Par10">In the second stage (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, step 2), we generate a batch-level feature matrix for each batch. It is in the same format as the feature matrix from a single sample. For each feature detected in the batch, we keep the m/z value, and take the average RT value in the batch, and the average intensity value in the batch. Then across all the batch-level feature matrices, we conduct another round of RT adjustment and feature alignment (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, step 3). As each batch-level feature matrix is in the same structure as a single sample feature matrix, the RT adjustment and feature alignment can be easily achieved by calling the existing routines. At this stage, tolerance levels different than stage 1 can be used. Then the aligned batch-level features are mapped back to the original within-batch features, and weak signal recovery can be conducted across batches.</p>
      <p id="Par11">There are some challenges in this process. The major challenge is the second-round RT adjustment is conducted on the average RT values from each batch. We need to trace the adjustment back to each single sample in order to conduct weak signal recovery, which we address in the next subsection. The second and smaller challenge is the feature alignments across batch might result in the merging of two features from a batch, in which case we trace back to the feature matrix of the corresponding batch, merge the signal intensities of the corresponding features, and take the mean RT of the corresponding features.</p>
    </sec>
    <sec id="Sec4">
      <title>The RT correction procedure</title>
      <p id="Par12">In the regular preprocessing procedure, RT adjustment is conducted once by nonlinear curve fitting<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR11">11</xref></sup>. However in the two-stage procedure, there are two levels of RT deviation to be considered. One is within batch, and the other is between batch. In our new procedure, for each LC/MS profile, both levels of RT deviations are computed and added together, to create an overall RT correction at the profile level (Fig. <xref rid="Fig1" ref-type="fig">1</xref>b).</p>
      <p id="Par13">First within batch (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, step 1), the sample with the largest number of detected features is selected as the reference. The peak RTs of other samples are adjusted based on this reference sample. For each of the other samples, first a unique match between peaks in the sample and peaks in the reference sample is established based on certain m/z and RT tolerance levels. In the current study, to simplify the comparison between the two-stage and traditional apLCMS, we specified the same tolerance levels for them. Then a nonlinear curve is fitted between the RT difference and the observed RT in the sample to be corrected.</p>
      <p id="Par14">Within the <italic>k</italic>th batch, for the <italic>j</italic>th sample to be corrected, we denote the RTs of the uniquely matched peaks as <inline-formula id="IEq1"><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left\{ {t_{m}^{{\left( {k,j} \right)}} } \right\}_{m = 1, \ldots ,M}$$\end{document}</tex-math><mml:math id="M2"><mml:msub><mml:mfenced close="}" open="{"><mml:msubsup><mml:mi>t</mml:mi><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mfenced></mml:msubsup></mml:mfenced><mml:mrow><mml:mi>m</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mi>M</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41598_2020_70850_Article_IEq1.gif"/></alternatives></inline-formula>, and the RT of the corresponding peaks in the reference sample as <inline-formula id="IEq2"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left\{ {t_{m}^{{\left( {k,0} \right)}} } \right\}_{m = 1, \ldots ,M}$$\end{document}</tex-math><mml:math id="M4"><mml:msub><mml:mfenced close="}" open="{"><mml:msubsup><mml:mi>t</mml:mi><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:mfenced></mml:msubsup></mml:mfenced><mml:mrow><mml:mi>m</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mi>M</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41598_2020_70850_Article_IEq2.gif"/></alternatives></inline-formula>. We obtain a nonlinear curve fit for the deviation, represented by function <italic>f</italic>(),<disp-formula id="Equa"><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \Delta t^{{\left( {k,j} \right)}} = t^{{\left( {k,j} \right)}} - t^{{\left( {k,0} \right)}} = f_{k,j} \left( {t^{{\left( {k,j} \right)}} } \right) + \varepsilon $$\end{document}</tex-math><mml:math id="M6" display="block"><mml:mrow><mml:mi mathvariant="normal">Δ</mml:mi><mml:msup><mml:mi>t</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mfenced></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mfenced></mml:msup><mml:mo>-</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:mfenced></mml:msup><mml:mo>=</mml:mo><mml:msub><mml:mi>f</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:msup><mml:mi>t</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mfenced></mml:msup></mml:mfenced><mml:mo>+</mml:mo><mml:mi>ε</mml:mi></mml:mrow></mml:math><graphic xlink:href="41598_2020_70850_Article_Equa.gif" position="anchor"/></alternatives></disp-formula>using kernel smoothing, and correct the RT of all the peaks in the <italic>j</italic>th sample to <inline-formula id="IEq3"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left\{ {t_{m}^{{\left( {k,j} \right)}} - \hat{f}_{k,j} \left( {t_{m}^{{\left( {k,j} \right)}} } \right)} \right\}_{m = 1, \ldots ,N}$$\end{document}</tex-math><mml:math id="M8"><mml:msub><mml:mfenced close="}" open="{"><mml:mrow><mml:msubsup><mml:mi>t</mml:mi><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mfenced></mml:msubsup><mml:mo>-</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:msubsup><mml:mi>t</mml:mi><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mfenced></mml:msubsup></mml:mfenced></mml:mrow></mml:mfenced><mml:mrow><mml:mi>m</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mi>N</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41598_2020_70850_Article_IEq3.gif"/></alternatives></inline-formula>, where <italic>N</italic> is the number of all the peaks in sample <italic>j</italic>.</p>
      <p id="Par16">After processing each batch, we obtain a batch-level feature table for each batch (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, step 2). In the feature table is the average RT value for each of the features in the batch. Between batches, we conduct a similar curve fit using the average feature RTs within each batch, against a reference batch (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, step 3). The batch with the largest number of aligned features is taken as the reference batch. For the <italic>k</italic>th batch, we denote the average RTs of the uniquely matched features as <inline-formula id="IEq4"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left\{ {\tau_{n}^{\left( k \right)} } \right\}_{n = 1, \ldots ,P}$$\end{document}</tex-math><mml:math id="M10"><mml:msub><mml:mfenced close="}" open="{"><mml:msubsup><mml:mi>τ</mml:mi><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mi>k</mml:mi></mml:mfenced></mml:msubsup></mml:mfenced><mml:mrow><mml:mi>n</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mi>P</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41598_2020_70850_Article_IEq4.gif"/></alternatives></inline-formula>, and the average RTs of the corresponding features in the reference batch <inline-formula id="IEq5"><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left\{ {\tau_{n}^{\left( 0 \right)} } \right\}_{n = 1, \ldots ,P}$$\end{document}</tex-math><mml:math id="M12"><mml:msub><mml:mfenced close="}" open="{"><mml:msubsup><mml:mi>τ</mml:mi><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mn>0</mml:mn></mml:mfenced></mml:msubsup></mml:mfenced><mml:mrow><mml:mi>n</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mi>P</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41598_2020_70850_Article_IEq5.gif"/></alternatives></inline-formula>. We obtain a nonlinear curve fit for the deviation, represented by function <italic>g(),</italic><disp-formula id="Equb"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ \Delta \tau^{\left( k \right)} = \tau^{\left( k \right)} - \tau^{\left( 0 \right)} = g_{k} \left( {\tau^{\left( k \right)} } \right) + \varepsilon $$\end{document}</tex-math><mml:math id="M14" display="block"><mml:mrow><mml:mi mathvariant="normal">Δ</mml:mi><mml:msup><mml:mi>τ</mml:mi><mml:mfenced close=")" open="("><mml:mi>k</mml:mi></mml:mfenced></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mi>τ</mml:mi><mml:mfenced close=")" open="("><mml:mi>k</mml:mi></mml:mfenced></mml:msup><mml:mo>-</mml:mo><mml:msup><mml:mi>τ</mml:mi><mml:mfenced close=")" open="("><mml:mn>0</mml:mn></mml:mfenced></mml:msup><mml:mo>=</mml:mo><mml:msub><mml:mi>g</mml:mi><mml:mi>k</mml:mi></mml:msub><mml:mfenced close=")" open="("><mml:msup><mml:mi>τ</mml:mi><mml:mfenced close=")" open="("><mml:mi>k</mml:mi></mml:mfenced></mml:msup></mml:mfenced><mml:mo>+</mml:mo><mml:mi>ε</mml:mi></mml:mrow></mml:math><graphic xlink:href="41598_2020_70850_Article_Equb.gif" position="anchor"/></alternatives></disp-formula>using kernel smoothing. Some example between-batch RT correction curves from real data (the CHDWB data described later) are shown in Fig. <xref rid="Fig1" ref-type="fig">1</xref>c. In the batch-level feature table, the RT is then corrected to <inline-formula id="IEq6"><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\left\{ {\tau_{n}^{\left( k \right)} - \hat{g}_{k} \left( {\tau_{n}^{\left( k \right)} } \right)} \right\}_{n = 1, \ldots ,N}$$\end{document}</tex-math><mml:math id="M16"><mml:msub><mml:mfenced close="}" open="{"><mml:mrow><mml:msubsup><mml:mi>τ</mml:mi><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mi>k</mml:mi></mml:mfenced></mml:msubsup><mml:mo>-</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>g</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>k</mml:mi></mml:msub><mml:mfenced close=")" open="("><mml:msubsup><mml:mi>τ</mml:mi><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mi>k</mml:mi></mml:mfenced></mml:msubsup></mml:mfenced></mml:mrow></mml:mfenced><mml:mrow><mml:mi>n</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mi>N</mml:mi></mml:mrow></mml:msub></mml:math><inline-graphic xlink:href="41598_2020_70850_Article_IEq6.gif"/></alternatives></inline-formula>. Feature alignment are then conducted using the corrected batch-level RT, and then mapped back to the within-batch feature tables. As all batches share the same RT range, the parameter setting for the kernel smoother is the same for within-batch and cross-batch curve fitting.</p>
    </sec>
    <sec id="Sec5">
      <title>Weak signal recovery procedure</title>
      <p id="Par18">Some features pass the detection threshold in only a subset of the batches. For such features, cross-batch weak signal recovery is needed after alignment. However, in the final data table, the RT is corrected across all batches. We need to adjust the RT points in the original data in order for the weak signal recovery to be reliable. Hence an RT correction is conducted for every LC/MS profile in every batch (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, step 3). For the <italic>j</italic>th profile in the <italic>k</italic>th batch, the corrected RT is obtained by:<disp-formula id="Equc"><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ t_{m, corrected}^{{\left( {k,j} \right)}} = t_{m}^{{\left( {k,j} \right)}} - \hat{f}_{k,j} \left( {t_{m}^{{\left( {k,j} \right)}} } \right) - \hat{g}_{k} \left( {t_{m}^{{\left( {k,j} \right)}} - \hat{f}_{k,j} \left( {t_{m}^{{\left( {k,j} \right)}} } \right)} \right), $$\end{document}</tex-math><mml:math id="M18" display="block"><mml:mrow><mml:msubsup><mml:mi>t</mml:mi><mml:mrow><mml:mi>m</mml:mi><mml:mo>,</mml:mo><mml:mi>c</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mi>r</mml:mi><mml:mi>e</mml:mi><mml:mi>c</mml:mi><mml:mi>t</mml:mi><mml:mi>e</mml:mi><mml:mi>d</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mfenced></mml:msubsup><mml:mo>=</mml:mo><mml:msubsup><mml:mi>t</mml:mi><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mfenced></mml:msubsup><mml:mo>-</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:msubsup><mml:mi>t</mml:mi><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mfenced></mml:msubsup></mml:mfenced><mml:mo>-</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>g</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mi>k</mml:mi></mml:msub><mml:mfenced close=")" open="("><mml:mrow><mml:msubsup><mml:mi>t</mml:mi><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mfenced></mml:msubsup><mml:mo>-</mml:mo><mml:msub><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mfenced close=")" open="("><mml:msubsup><mml:mi>t</mml:mi><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mfenced close=")" open="("><mml:mrow><mml:mi>k</mml:mi><mml:mo>,</mml:mo><mml:mi>j</mml:mi></mml:mrow></mml:mfenced></mml:msubsup></mml:mfenced></mml:mrow></mml:mfenced><mml:mo>,</mml:mo></mml:mrow></mml:math><graphic xlink:href="41598_2020_70850_Article_Equc.gif" position="anchor"/></alternatives></disp-formula>where <italic>m</italic> indexes the RT points (Fig. <xref rid="Fig1" ref-type="fig">1</xref>b). After changing the RT, the weak signal recovery can be conducted as previously described<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>. Briefly, to recover the weak signal for a target m/z and RT pair in an LC/MS profile, a loose tolerance level in m/z and RT is first used to select a local region. Then two-dimensional kernel smoothing is conducted in the region to detect weak peaks. If a weak peak is close enough to the target m/z and RT pair (threshold determined by the peak detection tolerance levels), and the local point density passes a threshold, it is considered the recovered signal of the feature. More details can be found in<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>.</p>
    </sec>
    <sec id="Sec6">
      <title>Datasets</title>
      <p id="Par20">We use three datasets for methods comparison. The first was a standard sample (QSTD) constructed from pooled human plasma which was run repeatedly with different batches of samples for quality control purposes. In this analysis, we took the QSTD sample profiles from 10 batches, each containing 10 runs of the same sample. The data were generated using a C18 column combined with the Thermo Fisher Q Exactive Orbitrap Mass Spectrometer, in negative ion mode.</p>
      <p id="Par21">The second dataset was the ST000868 dataset<sup><xref ref-type="bibr" rid="CR34">34</xref></sup>, downloaded from Metabolomics Workbench<sup><xref ref-type="bibr" rid="CR35">35</xref></sup>. The study compared the metabolomic profile of oak and wine yeast strains. The data were collected in three batches. Each yeast strain was measured 3–6 times in every batch.</p>
      <p id="Par22">The third dataset was a subset of the untargeted metabolomics data from Emory/Georgia Tech Center for Health Discovery and Well Being (CHDWB). The CHDWB metabolomics data was collected on healthy individuals that received preventive care, and the metabolomics data can be requested by submitting a request form to the CHDWB (<ext-link ext-link-type="uri" xlink:href="https://predictivehealth.emory.edu/research/resources.html">https://predictivehealth.emory.edu/research/resources.html</ext-link>)<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>. The study is a prospective longitudinal cohort study. Biological specimen, including blood samples, are collected every year for each participant. Metabolomics was measured on all subjects at baseline. We focused on the baseline metabolomics data and its relation with baseline body mass index (BMI) in this analysis. There were a total of 25 batches in the entire dataset. Within each batch, roughly 20 subjects were measured. The plasma sample from each subject was measured 3 times consecutively. We refer to them as triplets in the following text. The data were generated using a HILIC column combined with the Thermo Fisher Q Exactive Orbitrap Mass Spectrometer, in positive ion mode.</p>
    </sec>
    <sec id="Sec7">
      <title>Packages and parameters</title>
      <p id="Par23">We used apLCMS version 6.6.8 and xcms version 3.10.1, in the environment of R version 4.0.0. The apLCMS package and tutorial is available through <ext-link ext-link-type="uri" xlink:href="https://mypage.cuhk.edu.cn/academics/yutianwei/apLCMS/">https://mypage.cuhk.edu.cn/academics/yutianwei/apLCMS/</ext-link>, and XCMS is downloaded from Bioconductor.</p>
      <p id="Par24">There are three main parameters for this new approach. For the initial detection of peaks in each batch (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, step 1), <italic>p</italic><sub><italic>within_detect</italic></sub> controls the proportion of profiles a feature needs to be detected from, for it to be considered for the next step; <italic>p</italic><sub><italic>within_report</italic></sub> controls the proportion of profiles a feature need to be present after weak signal recovery, for it to be included in the final feature table from the batch. Between the batches (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, step 3), <italic>p</italic><sub><italic>batches</italic></sub> controls the proportion of batches the feature needs to be present, for it to be included in the overall feature table.</p>
      <p id="Par25">For apLCMS, the peak detection and quantification procedure for single LC/MS profile follows the existing method<sup><xref ref-type="bibr" rid="CR11">11</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup>. In this study, the major parameters include min.run = 12, min.pres = 0.5, mz.tol = 1e-5, baseline.correct = 0, min.bw = NA, max.bw = NA, shape.model = "bi-Gaussian", sd.cut = c(0.125, 60), sigma.ratio.lim = c(0.2, 5), moment.power = 1. Other parameters are listed in the R codes in the <xref rid="MOESM1" ref-type="media">Supplementary Material</xref>.</p>
      <p id="Par26">For XCMS, four combinations of peak detection and RT correction methods were used. The parameters were optimized by the method IPO in an objective and dataset-specific manner<sup><xref ref-type="bibr" rid="CR37">37</xref></sup>. XCMS IPO_1 uses optimal parameters found by IPO combining matched filter and orbiwarp. XCMS IPO_2 uses optimal parameters found by IPO combining matched filter and loess smoothing. XCMS IPO_3 uses optimal parameters found by IPO combining centWave and orbiwarp. XCMS IPO_4 uses optimal parameters found by IPO combining centWave and loess smoothing. As the parameters are dataset-specific, their values are listed in the Results and Discussions section.</p>
    </sec>
  </sec>
  <sec id="Sec8">
    <title>Results and discussions</title>
    <p id="Par27">We implemented the method in the existing workflow of the apLCMS package<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>, which conducts both untargeted and hybrid (untargeted/targeted) feature detection<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>. To evaluate the feature detection performance of the proposed two-stage approach, we conducted comparison experiments with the traditional apLCMS approach, as well as the popular preprocessing method XCMS<sup><xref ref-type="bibr" rid="CR19">19</xref></sup>, on three real datasets.</p>
    <sec id="Sec9">
      <title>Results from standard sample (QSTD) data</title>
      <p id="Par28">Using the QSTD data, we compared the performance of the new two-stage apLCMS with tradition apLCMS and XCMS in feature detection and quantification. For apLCMS, we first selected optimal parameter settings for peak detection and kept the parameters the same for both the two-stage and the traditional methods.</p>
      <p id="Par29">For the two-stage approach, we tested two scenarios for within-batch proportion parameters, <italic>p</italic><sub><italic>within_detect</italic></sub> = <italic>p</italic><sub><italic>within_report</italic></sub><italic>, </italic>and 2<italic>p</italic><sub><italic>within_detect</italic></sub> = <italic>p</italic><sub><italic>within_report</italic></sub> . We found the results to be similar with regard to the criteria we used to assess the performance. Thus in the following sections, we report results from using the same values for <italic>p</italic><sub><italic>within_detect</italic></sub> (before weak signal recovery) and <italic>p</italic><sub><italic>within_report</italic></sub> (after weak signal recovery). We used values of 0.2, 0.3, 0.4, 0.6, 0.8 and 1. The second parameter was between-batch detection proportion threshold <italic>p</italic><sub><italic>batches</italic></sub>, i.e. the proportion of batches a feature needed to be present in. We used values of 0.1, 0.2, 0.3, 0.5, 0.7, and 0.9. For the traditional apLCMS procedure, the detection threshold (number of profiles the feature needed to be present in) was set as 5, 10, 15, …., and 95.</p>
      <p id="Par30">For XCMS, we used the IPO package to optimize its parameters under 4 different method combinations. Below are the parameter combinations in each of the 4 settings:</p>
      <p id="Par31">XCMS IPO_1: matched filter parameters: fwhm = 15, snthresh = 1, step = 0.0805, steps = 2, sigma = 6.369, max = 5, mzdiff = 0.639, index = FALSE; peak grouping parameters: method = "density", bw = 0.879999, mzwid = 0.0614; Orbiwarp parameters: method = "obiwarp", plottype = "none", distFunc = "cor_opt", profStep = 1, center = 6, response = 1, gapInit = 0.78, gapExtend = 2.7, factorDiag = 2, factorGap = 1, localAlignment = 0.</p>
      <p id="Par32">XCMS IPO_2: matched filter parameters: same as XCMS IPO_1; peak grouping parameters: method = "density", bw = 0.879999, mzwid = 0.0362; Loess parameters: missing = 3, extra = 3, span = 0.221, smooth = "loess", family = "gaussian".</p>
      <p id="Par33">XCMS IPO_3: centWave parameters: peakwidth = c(3, 129.97), ppm = 10, noise = 0, snthresh = 1, mzdiff = -0.0109, prefilter = c(3,100), mzCenterFun = "wMean", integrate = 1, fitgauss = FALSE, verbose.columns = FALSE; peak grouping parameters: method = "density", bw = 12.4, mzwid = 0.01; Orbiwarp parameters: distFunc = "cor_opt", profStep = 1, center = 7, response = 1, gapInit = 0.54, gapExtend = 2.7, factorDiag = 2, factorGap = 1, localAlignment = 0.</p>
      <p id="Par34">XCMS IPO_4: centWave parameters: same as XCMS IPO_3; peak grouping parameters: bw = 0.25, mzwid = 0.0081; Loess parameters: missing = 5, extra = 1, span = 0.326, smooth = "loess", family = "gaussian".</p>
      <p id="Par35">To achieve different number of features detected by XCMS, while keeping the above parameters fixed, we varied the “minsamp” parameter, which controls the minimum number of samples necessary for a peak group to be detected. We used values of 5, 10, 20, 30, 40, 50, 60, 70, 80, 90.</p>
      <p id="Par36">To evaluate the results, we recorded the total number of zeros in the final data matrix (Fig. <xref rid="Fig2" ref-type="fig">2</xref>a), number of features with m/z matched to known KEGG metabolites using xMSAnnotator<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> allowing adduct ions [M–H]<sup>−</sup>, [M–2H]<sup>2−</sup>, [M–2H + Na]<sup>−</sup>, [M–2H + K]<sup>−</sup>, [M–2H + NH4]<sup>−</sup>, [M–H<sub>2</sub>O–H]<sup>−</sup>, [M–H + Cl]<sup>2−</sup>, [M + Cl]<sup>−</sup>, [M + 2Cl]<sup>2−</sup> (Fig. <xref rid="Fig2" ref-type="fig">2</xref>b), coefficient of variation (CV) in the final data matrix without considering batches with and without considering the zero values (Fig. <xref rid="Fig2" ref-type="fig">2</xref>c,d), and the coefficient of variation (CV) after merging the repeated measurements in each batch to generate a single measurement from each batch, with and without considering the zero values (Fig. <xref rid="Fig2" ref-type="fig">2</xref>e,f). In the calculation of CV, including zero values can reflect feature detection consistency in the CV results, while excluding zero values can reflect feature quantification consistency.<fig id="Fig2"><label>Figure 2</label><caption><p>Comparison of the two-stage preprocessing approach with traditional apLCMS and XCMS using standard sample. Each dot represents a parameter setting. (<bold>a</bold>) Total number of zeros in the final data matrix; (<bold>b</bold>) proportion of features with m/z matched to known metabolites using xMSAnnotator; (<bold>c</bold>) level of variation as measured by coefficient of variation (CV) in the final data matrix without considering batches; (d) level of variation as measured by coefficient of variation (CV) in the final data matrix without considering batches, considering only non-zero values; (e) level of variation as measured by CV after merging each batch; (f) level of variation as measured by CV after merging each batch, considering only non-zero values. In all CV plots, the point is median; vertical bars represent 10th to 90th percentile.</p></caption><graphic xlink:href="41598_2020_70850_Fig2_HTML" id="MO2"/></fig></p>
      <p id="Par37">In untargeted metabolomics data measured by LC/MS, zeros in the final data matrix represent a mixture of true non-presence of the metabolic feature and missing values. It is still a difficult issue to address. Given the measurements here were taken on the same sample, we expect a better method to yield less zeros in the data matrix. However, the proportions of zero also depends on how consistent the LC/MS machinery generates the data, and how aggressive the weak signal recovery is conducted. Thus the results need to be considered together with the level of variation in the CV plots. When weak signal recovery is conducted in an overly aggressive manner taking noise ask signal, although the proportion of zeros may be lower, the inclusion of noise as signal will also worsen the quantification consistency. As shown in Fig. <xref rid="Fig2" ref-type="fig">2</xref>a, when the number of features were large, the two-stage approach (orange) tended to yield smaller proportions of zeros compared to the traditional apLCMS approach (blue) and XCMS (green).</p>
      <p id="Par38">The proportion of features that could be matched were similar for the three methods (Fig. <xref rid="Fig2" ref-type="fig">2</xref>b). Traditional apLCMS was slightly better, and XCMS was slightly inferior. When the detection threshold was loosened, some noise data points were expected to be mis-identified as features. At the same time, some low-abundance metabolites were detected. Thus we expected a higher false-positive rate in the metabolite mapping, which was a trade-off with a higher detection rate over all metabolites in the sample.</p>
      <p id="Par39">In the measurement of the coefficient of variation (CV) before and after merging within batches, as illustrated in Fig. <xref rid="Fig2" ref-type="fig">2</xref>c–f, the two-stage method (orange diamonds) yielded less variation compared to the traditional apLCMS (blue dots) and XCMS (green triangles) when zero was included in the calculation of CV (Fig. <xref rid="Fig2" ref-type="fig">2</xref>c,e). When zero values were excluded, XCMS with matched filter approach yielded better quantification consistency as evidenced by lower CV values (Fig. <xref rid="Fig2" ref-type="fig">2</xref>d). The advantage disappeared when the data from each batch was merged (Fig. <xref rid="Fig2" ref-type="fig">2</xref>f). However with regard to detection consistency, XCMS with matched filter resulted in much higher proportion of zeros (Fig. <xref rid="Fig2" ref-type="fig">2</xref>a). Given the data was collected on the same sample, we expect a feature’s presence should vary little across the files. Overall, the two-stage approach outperformed the traditional apLCMS and XCMS in terms of measurement stability.</p>
    </sec>
    <sec id="Sec10">
      <title>Results from ST000868 dataset</title>
      <p id="Par40">For apLCMS, we used <italic>p</italic><sub><italic>within_detect</italic></sub> = <italic>p</italic><sub><italic>within_report</italic></sub> = <italic>0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, and p</italic><sub><italic>batches</italic></sub> = <italic>0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9.</italic> All other parameter setting were the same as the previous section except min.run = 0.8 and min.pres = 0.4, given the shorter RT range of the data. We note some of the above parameter combinations may result in identical results given the small batch size. For traditional apLCMS, while keeping all other parameters the same as the two-stage approach, we used the detection threshold (number of profiles the feature needed to be present in) of 2, 4, 6, …, 28.</p>
      <p id="Par41">For XCMS, we again used the IPO package to optimize its parameters under 4 different method combinations. Below are the parameter combinations in each of the 4 settings:</p>
      <p id="Par42">XCMS IPO_1: Matched Filter parameters: fwhm = 25, snthresh = 3, step = 0.05, steps = 1, sigma = 10.617, max = 5, mzdiff = 0.75, index = FALSE; peak grouping parameters: method = "density", bw = 38, mzwid = 0.015; Orbiwarp parameters: method = "obiwarp", plottype = "none", distFunc = "cor_opt", profStep = 1, center = 3, response = 1, gapInit = 0, gapExtend = 2.7, factorDiag = 2, factorGap = 1, localAlignment = 0.</p>
      <p id="Par43">XCMS IPO_2: matched Filter parameters: same as XCMS IPO_1; peak grouping parameters: method = "density", bw = 12.4, mzwid = 0.027; Loess parameters: missing = 3, extra = 3, span = 0.22, smooth = "loess", family = "gaussian".</p>
      <p id="Par44">XCMS IPO_3: CentWave parameters: peakwidth = c(10, 50), ppm = 5, noise = 0, snthresh = 1, mzdiff = -0.01, prefilter = c(1, 100), mzCenterFun = "wMean", integrate = 1, fitgauss = FALSE, verbose.columns = FALSE; peak grouping parameters: method = "density", bw = 37.68, mzwid = 0.0001; Orbiwarp parameters: distFunc = "cor_opt", profStep = 1, center = 3, response = 1, gapInit = 0, gapExtend = 2.7, factorDiag = 2, factorGap = 1, localAlignment = 0.</p>
      <p id="Par45">XCMS IPO_4: CentWave parameters: same as XCMS IPO_3; peak grouping parameters: bw = 12.4, mzwid = 0.0001; Loess parameters: missing = 1, extra = 2, span = 0.42, smooth = "loess", family = "gaussian".</p>
      <p id="Par46">To achieve different number of features detected by XCMS, while keeping the above parameters fixed, we varied the “minsamp” parameter, which controls the minimum number of samples necessary for a peak group to be detected. We used values of of 2, 4, 6, …, 28.</p>
      <p id="Par47">To compare the results from the three methods, we compared detection/quantification consistency, matching to known metabolites, and testing results by contrasting the two cell types, as the original study was designed to find the metabolic differences between the genetically different cell types.</p>
      <p id="Par48">Similar to the QSTD data, the two-stage method resulted in smaller proportion of zeros (Fig. <xref rid="Fig3" ref-type="fig">3</xref>a). In the m/z matching to KEGG metabolites using adduct ions [M–H]<sup>−</sup>, [M–2H]<sup>2−</sup>, [M–2H + Na]<sup>−</sup>, [M–2H + K]<sup>−</sup>, [M–2H + NH4]<sup>−</sup>, [M–H<sub>2</sub>O–H]<sup>−</sup>, [M–H + Cl]<sup>2−</sup>, [M + Cl]<sup>−</sup>, [M + 2Cl]<sup>2−</sup>, the methods performed similarly, with XCMS with centWave peak detection yielding slightly higher rate of matching (Fig. <xref rid="Fig3" ref-type="fig">3</xref>b). With regard to CV values after adjusting for cell type and batch, i.e. the variation for each cell type within each batch, the two-stage approach resulted in lower CVs (Fig. <xref rid="Fig3" ref-type="fig">3</xref>c), indicating better detection and quantification consistency.<fig id="Fig3"><label>Figure 3</label><caption><p>Comparison of the two-stage preprocessing approach with traditional apLCMS and XCMS using the ST000868 dataset. Each dot represents a parameter setting. (<bold>a</bold>) Proportion of zeros in the final data matrix before merging triplets for each subject; (<bold>b</bold>) Proportion of features with m/z matched to known metabolites by xMSAnnotator; (<bold>c</bold>) Within-triplet coefficient of variation (CV). Point is median; vertical bars represent 10th to 90th percentile. (<bold>d</bold>) Number of significant features at FDR ≤ 0.2, without batch effect correction; (<bold>e</bold>) Number of significant features at FDR ≤ 0.2, after batch effect correction by ComBat; (<bold>f</bold>) Number of significant features at FDR ≤ 0.2, after batch effect correction by WaveICA.</p></caption><graphic xlink:href="41598_2020_70850_Fig3_HTML" id="MO3"/></fig></p>
      <p id="Par49">We then conducted testing between the two cell types using t-test. All tests were first conducted at the single metabolic feature level, and then the <italic>p</italic> values from all features were subjected to False Discovery Rate (FDR) correction<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>. The tests were limited to features with ≤ 33% zeros in at least one of the cell types. Without batch effect correction, all method yielded relatively few significant metabolites at FDR ≤ 0.2, while the two-stage method tended to detect more significant feature (Fig. <xref rid="Fig3" ref-type="fig">3</xref>d). We then applied two batch effect correction methods. The first was the popular method ComBat<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>, which was originally developed for microarray data, and was later widely used in RNA-seq and metabolomics data. After applying ComBat to each of the data matrices, testing was conducted on the adjusted data. All methods detected more significant metabolic features after the adjustment (Fig. <xref rid="Fig3" ref-type="fig">3</xref>e). The two-stage approach, when combined with ComBat, resulted in more significant metabolic features than the other two methods (Fig. <xref rid="Fig3" ref-type="fig">3</xref>e). Among the four combinations of XCMS, matched filter appeared to result in more significant metabolic features. We notice that the number of significant metabolic features from XCMS-processed data tended to fall close to a horizontal line. This is due to the fact that in XCMS, features detected using a more restrictive minsamp setting are a strict subset of those detected using a looser minsamp setting, when other parameters stay the same. When the threshold ≤ 33% zeros in at least one cell type was applied to the data matrix, some matrices obtained with different minsamp settings yielded similar matrices after filtration.</p>
      <p id="Par50">We applied another recent batch effect correction method that was specifically developed for metabolomics data – WaveICA, which has shown excellent performance when compared to some other existing methods<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>. After applying WaveICA to all the data matrices, the results were similar to ComBat. Again the two-stage approach detected more significant features (Fig. <xref rid="Fig3" ref-type="fig">3</xref>f). Overall, when applied to the ST000868 dataset, the new two-stage approach resulted in more consistent peak detection and better between-cell type testing results.</p>
    </sec>
    <sec id="Sec11">
      <title>Results from the CHDWB data</title>
      <p id="Par51">In this study, we selected six batches from the CHDWB data that evenly spanned the entire dataset: batches 1, 5, 10, 15, 20, 25, which included 115 subjects in total. Between the traditional apLCMS and the new two-stage approach, we kept all other parameters the same, except the detection proportion threshold values. In the two-stage procedure, we applied within-batch detection proportion threshold values 0.2, 0.3, 0.4, 0.6, 0.8, and 1, and between-batch detection proportions 0.15, 0.3, 0.45, 0.6, 0.75, and 0.9. Given there were six batches, the between-batch detection proportions meant we required a feature to be initially detected in at least 1, 2, 3, 4, 5, or 6 batches, respectively. For the traditional apLCMS procedure, we set the detection threshold (number of samples) at 30, 60, 90, 120, 180, 240, and 300. For XCMS, we used the IPO package to optimize its parameters under 4 different method combinations. Below are the parameter combinations in each of the 4 settings:</p>
      <p id="Par52">XCMS IPO_1: Matched Filter parameters: fwhm = 27, snthresh = 1, step = 0.015, steps = 2, sigma = 11.4659, max = 5, mzdiff = 0.77, index = FALSE; peak grouping parameters: method = "density", bw = 0.879999, mzwid = 0.0265; Orbiwarp parameters: method = "obiwarp", plottype = "none", distFunc = "cor_opt", profStep = 1, center = 5, response = 1, gapInit = 0.928, gapExtend = 2.7, factorDiag = 2, factorGap = 1, localAlignment = 0.</p>
      <p id="Par53">XCMS IPO_2: Matched Filter parameters: same as XCMS IPO_1; peak grouping parameters: method = "density", bw = 0.879999, mzwid = 0.0265; Loess parameters: missing = 4, extra = 1, span = 0.05575, smooth = "loess", family = "gaussian".</p>
      <p id="Par54">XCMS IPO_3: CentWave parameters: peakwidth = c(3,110), ppm = 10, noise = 0, snthresh = 1, mzdiff = -0.0175, prefilter = c(3,100), mzCenterFun = "wMean", integrate = 1, fitgauss = FALSE, verbose.columns = FALSE; peak grouping parameters: method = "density", bw = 12.4, mzwid = 0.003; Orbiwarp parameters: distFunc = "cor_opt", profStep = 1, center = 2, response = 1, gapInit = 0.08, gapExtend = 2.7, factorDiag = 2, factorGap = 1, localAlignment = 0.</p>
      <p id="Par55">XCMS IPO_4: CentWave parameters: same as XCMS IPO_3; peak grouping parameters: bw = 22, mzwid = 0.018; Loess parameters: missing = 1, extra = 3, span = 0.2, smooth = "loess", family = "gaussian".</p>
      <p id="Par56">To achieve different number of features detected by XCMS, we varied the “minsamp” parameter, which controls the minimum number of samples necessary for a peak group to be detected. We used values 10, 20, 30, 50, 70, 90, 120, 180, 240, 300.</p>
      <p id="Par57">Some settings resulted in data matrices with more than 10,000 features, which is out of the range a regular untargeted analysis would consider. Thus we limited the following discussion to data matrices with 10,000 features or less. We assessed the results based on following criteria for consistency: Total number of zeros in the final data matrix (Fig. <xref rid="Fig4" ref-type="fig">4</xref>a), features with m/z matched to known metabolites with KEGG IDs using xMSAnnotator, allowing adduct ions [M + H]<sup>+</sup>, [M + NH4]<sup>+</sup>, [M + Na]<sup>+</sup>, [M + ACN + H]<sup>+</sup>, [M + ACN + Na]<sup>+</sup>, [M + 2Na–H]<sup>+</sup>, and [M + K]<sup>+</sup> (Fig. <xref rid="Fig4" ref-type="fig">4</xref>b), and coefficient of variation within the triplet that measured the same sample (Fig. <xref rid="Fig4" ref-type="fig">4</xref>c). As shown in Fig. <xref rid="Fig4" ref-type="fig">4</xref>a, when the total number of features was below 4,000, the two-stage approach and traditional apLCMS yielded smaller proportion of zeros. When the total number of features went larger, the XCMS with centWave and orbiwap combination and the two-stage approach yielded data matrices that tended to have smaller proportions of zeros. Although the data were generated from different subjects, we still expected the core metabolism to be similar across the subjects, and a better method would conduct more consistent feature alignment between samples/batches, resulting in less zeros in the final data matrix. This should be true especially when smaller number of metabolic features are detected, which are more concentrated in core metabolism.<fig id="Fig4"><label>Figure 4</label><caption><p>Comparison of the two-stage approach with traditional apLCMS and XCMS using CHDWB samples. Each dot represents a parameter setting. (<bold>a</bold>) Proportion of zeros in the final data matrix before merging triplets for each subject; (<bold>b</bold>) proportion of features with m/z matched to known metabolites by xMSAnnotator; (<bold>c</bold>) average within-triplet coefficient of variation (CV). Point is median; vertical bars represent 10th–90th percentile. (<bold>d</bold>) Number of significant features at FDR ≤ 0.2, without batch effect correction; (<bold>e</bold>) Number of significant features at FDR ≤ 0.2, after batch effect correction by ComBat; (<bold>f</bold>) Number of significant features at FDR ≤ 0.2, after batch effect correction by WaveICA.</p></caption><graphic xlink:href="41598_2020_70850_Fig4_HTML" id="MO4"/></fig></p>
      <p id="Par58">With regard to features matched to known metabolites, the three methods performed similarly, with the two-stage approach having a slight edge when the number of features detected were smaller, and XCMS with matched filter having slightly more matched features when the number of features went larger (Fig. <xref rid="Fig4" ref-type="fig">4</xref>b). We computed the coefficient of variation (CV) over all the metabolic features within each triplet (subject). As shown in Fig. <xref rid="Fig4" ref-type="fig">4</xref>c, the median CV level tended to be similar for all the approaches when the number of features were smaller (&lt; 4,000), while the two-stage approach had an edge when the number of features were larger. In addition, the distribution of CV tended to be wider for XCMS, indicating part of the metabolic features showed larger variation within triplets.</p>
      <p id="Par59">Next we merged the triplet measures for each subject. The merging was done by taking the average non-zero values in the triplet for each feature. When all three measurements for a feature were zero, the resulting merged measurement was also zero. Using each of the feature table, we first filtered the features using a threshold of &lt; 25% zeros, and then conducted down-stream analysis using the body mass index (BMI) as the outcome variable, while adjusting for age, gender and race. It is well known that BMI is associated with changes in metabolic patterns<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>. We fitted a linear model for each individual metabolic feature (denoted M):<disp-formula id="Equd"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$ BMI = \mu + \beta_{1,i} M_{i} + \beta_{2} Age + \beta_{3} Age^{2} + \beta_{4} Gender + \beta_{5} Race + \varepsilon $$\end{document}</tex-math><mml:math id="M20" display="block"><mml:mrow><mml:mi>B</mml:mi><mml:mi>M</mml:mi><mml:mi>I</mml:mi><mml:mo>=</mml:mo><mml:mi>μ</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>M</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mi>A</mml:mi><mml:mi>g</mml:mi><mml:mi>e</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mn>3</mml:mn></mml:msub><mml:mi>A</mml:mi><mml:mi>g</mml:mi><mml:msup><mml:mi>e</mml:mi><mml:mn>2</mml:mn></mml:msup><mml:mo>+</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mn>4</mml:mn></mml:msub><mml:mi>G</mml:mi><mml:mi>e</mml:mi><mml:mi>n</mml:mi><mml:mi>d</mml:mi><mml:mi>e</mml:mi><mml:mi>r</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mi>β</mml:mi><mml:mn>5</mml:mn></mml:msub><mml:mi>R</mml:mi><mml:mi>a</mml:mi><mml:mi>c</mml:mi><mml:mi>e</mml:mi><mml:mo>+</mml:mo><mml:mi>ε</mml:mi></mml:mrow></mml:math><graphic xlink:href="41598_2020_70850_Article_Equd.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par60">Here the subscript <italic>i</italic> indexes the metabolic feature. The <italic>p</italic> value associated with <italic>β</italic><sub>1,<italic>i</italic></sub> was recorded. Then the <italic>p</italic> values from all features were subjected to False Discovery Rate (FDR) correction<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>.</p>
      <p id="Par61">Without batch effect correction, the two-stage approach yielded higher number of significant features over the entire range of number of features detected (Fig. <xref rid="Fig4" ref-type="fig">4</xref>d). We then applied ComBat<sup><xref ref-type="bibr" rid="CR28">28</xref></sup> to adjust for batch effect in each data matrix before applying the above testing procedure. After the application of ComBat, the two-stage approach showed a trend of increasing number of significant features with the increase of total number of features in the matrix (Fig. <xref rid="Fig4" ref-type="fig">4</xref>e). It was again the method that detected the highest number of significant features across the range of total number of features. Applying the batch effect correction method WaveICA, the results were more mixed. When the number of features were low to moderate (&lt; 5,000), the two-stage approach detected more significant features. When considering larger number of features, two settings of XCMS with centWave+ orbiwarp resulted in higher number of significant features. Overall, the new two-stage approach again resulted in more consistent peak detection and quantification, as well as better down-stream testing result.</p>
      <p id="Par62">Next we considered the biological interpretability of the testing results. For this purpose, we conducted pathway analyses using Mummichog<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>. As Mummichog needed to be conducted manually, we selected a subset of the results for this analysis. We selected four groups of data matrices with ~ 5,000, ~ 4,000, ~ 3,000, and ~ 2000 features, respectively. Because pathway analysis requires a reasonable number of significant features, instead of using FDR, we used features with raw <italic>p</italic> value &lt; 0.05.</p>
      <p id="Par63">As shown in Table <xref rid="Tab1" ref-type="table">1</xref>, in the two groups with lower feature counts (~ 2000 and ~ 3,000), the two-stage approach yielded more significant pathways with at least 5 significant metabolic features (Table <xref rid="Tab1" ref-type="table">1</xref>, last column). In the group of ~ 4,000 features, the two-stage approach tied with traditional apLCMS at 8 significant pathways. In the group with ~ 5,000 features, traditional apLCMS had a slight edge over the two-stage approach. XCMS with centWave+ loess resulted in 5 significant pathways, which was only slightly worse.<table-wrap id="Tab1"><label>Table 1</label><caption><p>Comparison of feature selection and pathway analysis results.</p></caption><table frame="hsides" rules="groups"><thead><tr><th align="left">Method</th><th align="left">Total # features</th><th align="left"># Significant pathways with 5 or more matched significant metabolites</th></tr></thead><tbody><tr><td align="left">Two-stage, P<sub>within.detect</sub> = 0.3 p<sub>batches</sub> = 0.3</td><td align="left">5,024</td><td align="left">6</td></tr><tr><td align="left">Two-stage, P<sub>within.detect</sub> = 0.6 p<sub>batches</sub> = 0.15</td><td align="left">4,988</td><td align="left">5</td></tr><tr><td align="left">Traditional apLCMS, min.profiles = 50</td><td align="left">5,097</td><td align="left"><bold><italic>7</italic></bold></td></tr><tr><td align="left">XCMS matched filter + orbiwarp, minsamp 30</td><td align="left">5,004</td><td align="left">0</td></tr><tr><td align="left">XCMS centWave + orbiwarp, minsamp 300</td><td align="left">5,064</td><td align="left">5</td></tr><tr><td align="left">XCMS centWave + loess, minsamp 240</td><td align="left">5,201</td><td align="left">1</td></tr><tr><td align="left">Two-stage, p<sub>within.detect</sub> = 0.2 p<sub>batches</sub> = 0.45</td><td align="left">4,034</td><td align="left"><bold><italic>8</italic></bold></td></tr><tr><td align="left">Traditional apLCMS, min.profiles = 90</td><td align="left">4,129</td><td align="left"><bold><italic>8</italic></bold></td></tr><tr><td align="left">XCMS centWave + loess, minsamp 300</td><td align="left">4,165</td><td align="left">2</td></tr><tr><td align="left">XCMS matched filter + orbiwarp, minsamp 50</td><td align="left">3,928</td><td align="left">0</td></tr><tr><td align="left">Two-stage, p<sub>within.detect</sub> = 0.3 p<sub>batches</sub> = 0.6</td><td align="left">2,837</td><td align="left"><bold><italic>5</italic></bold></td></tr><tr><td align="left">Traditional apLCMS, Min.profiles = 180</td><td align="left">2,874</td><td align="left">3</td></tr><tr><td align="left">XCMS matched filter + orbiwarp, minsamp 90</td><td align="left">2,789</td><td align="left">0</td></tr><tr><td align="left">Two-stage, p<sub>within.detect</sub> = 0.3 p<sub>batches</sub> = 0.9</td><td align="left">1667</td><td align="left"><bold><italic>5</italic></bold></td></tr><tr><td align="left">Traditional apLCMS, Min.profiles = 300</td><td align="left">1725</td><td align="left">3</td></tr><tr><td align="left">XCMS matched filter + orbiwarp, minsamp 180</td><td align="left">1704</td><td align="left">0</td></tr></tbody></table><table-wrap-foot><p>BMI was used as the outcome variable. Age, age<sup>2</sup>, gender, and race were adjusted for in the model. Metabolic feature selection was conducted using features with &lt; 25% zeros. Pathway analysis was conducted using Mummichog, using metabolic features with <italic>p</italic> &lt; 0.05.</p><p>The bold italic font represents the biggest number of significant pathways in the comparison group</p></table-wrap-foot></table-wrap></p>
      <p id="Par64">Given the settings with ~ 4,000 features yielded the most significant pathways, we further examined the selected pathways by the three methods in this group (Table <xref rid="Tab2" ref-type="table">2</xref>). The two-stage approach and traditional apLCMS each yielded 8 significant pathways with at least 5 matched significant metabolites. Their results largely agreed with each other. The significant pathways tended to be focused on amino acid metabolism, which was expected to be highly relevant to BMI status. The top pathway selected by the two-stage approach also included “Phosphatidylinositol phosphate metabolism”, which is known to be involved in the activation of various pathways. Dysregulation of the metabolism of phosphatidylinositol-3,4,5-triphosphate mediates insulin resistance<sup><xref ref-type="bibr" rid="CR41">41</xref></sup>, which is highly relevant to BMI. The XCMS yielded much fewer significant pathways. The urea cycle pathway was shared with the other two approaches.<table-wrap id="Tab2"><label>Table 2</label><caption><p>Significant pathways with at least 5 matched significant metabolic features for parameter settings where ~ 4,000 features were detected.</p></caption><table frame="hsides" rules="groups"><thead><tr><th align="left">Pathways</th><th align="left">Overlap_size</th><th align="left">Pathway_size</th><th align="left"><italic>p</italic> value</th></tr></thead><tbody><tr><td align="left" colspan="4">Two-stage apLCMS (within-batch proportion 0.3, initially detected in at least 4 batches), 4,034 features</td></tr><tr><td align="left"> Lysine metabolism</td><td align="left">6</td><td align="left">19</td><td char="." align="char">0.00185</td></tr><tr><td align="left"> Phosphatidylinositol phosphate metabolism</td><td align="left">5</td><td align="left">16</td><td char="." align="char">0.00479</td></tr><tr><td align="left"> Butanoate metabolism</td><td align="left">5</td><td align="left">17</td><td char="." align="char">0.00681</td></tr><tr><td align="left"> Glycine, serine, alanine and threonine metabolism</td><td align="left">8</td><td align="left">38</td><td char="." align="char">0.00798</td></tr><tr><td align="left"> Aspartate and asparagine metabolism</td><td align="left">9</td><td align="left">52</td><td char="." align="char">0.01899</td></tr><tr><td align="left"> Urea cycle/amino group metabolism</td><td align="left">7</td><td align="left">40</td><td char="." align="char">0.02756</td></tr><tr><td align="left"> Pyrimidine metabolism</td><td align="left">5</td><td align="left">27</td><td char="." align="char">0.0463</td></tr><tr><td align="left"> Glycerophospholipid metabolism</td><td align="left">8</td><td align="left">53</td><td char="." align="char">0.04966</td></tr><tr><td align="left" colspan="4">Traditional apLCMS (minimum samples detected 90), 4,129 features</td></tr><tr><td align="left"> Butanoate metabolism</td><td align="left">5</td><td align="left">15</td><td char="." align="char">0.00387</td></tr><tr><td align="left"> Glycine, serine, alanine and threonine metabolism</td><td align="left">8</td><td align="left">37</td><td char="." align="char">0.00689</td></tr><tr><td align="left"> Arachidonic acid metabolism</td><td align="left">6</td><td align="left">24</td><td char="." align="char">0.00748</td></tr><tr><td align="left"> Lysine metabolism</td><td align="left">5</td><td align="left">18</td><td char="." align="char">0.0079</td></tr><tr><td align="left"> Vitamin B3 (nicotinate and nicotinamide) metabolism</td><td align="left">5</td><td align="left">18</td><td char="." align="char">0.0079</td></tr><tr><td align="left"> Glycerophospholipid metabolism</td><td align="left">9</td><td align="left">52</td><td char="." align="char">0.01681</td></tr><tr><td align="left"> Urea cycle/amino group metabolism</td><td align="left">7</td><td align="left">43</td><td char="." align="char">0.041</td></tr><tr><td align="left"> Aspartate and asparagine metabolism</td><td align="left">8</td><td align="left">53</td><td char="." align="char">0.04899</td></tr><tr><td align="left" colspan="4">XCMS (centWave + loess, IPO optimized, minimum samples detected 90), 4,165 features</td></tr><tr><td align="left"> C21-steroid hormone biosynthesis and metabolism</td><td align="left">6</td><td align="left">24</td><td char="." align="char">0.00395</td></tr><tr><td align="left"> Urea cycle/amino group metabolism</td><td align="left">5</td><td align="left">30</td><td char="." align="char">0.04353</td></tr></tbody></table></table-wrap></p>
      <p id="Par65">Overall, with this larger dataset generated from real biological subjects, we again demonstrated that the two-stage approach generated data with higher consistency, as compared to the traditional apLCMS and XCMS that treated all the data as a single group.</p>
    </sec>
    <sec id="Sec12">
      <title>Discussions</title>
      <p id="Par66">The two-stage approach is built on top of the existing apLCMS method. It first conducts the entire workflow of within-batch feature detection, RT correction, and feature alignment. Then it conducts between-batch feature alignment, RT correction, and weak signal recovery across batches. The RT correction is conducted in a two-stage manner, by adding together two smooth curves for each LC/MS profile. One curve is within-batch RT deviation, and the other curve is between-batch RT deviation.</p>
      <p id="Par67">The method has a few important parameters. The tuning of the parameters is somewhat heuristic. The situation is similar to the tuning of other parameters in the apLCMS, XCMS, or packages. Different studies may have different purposes. Some studies focus more on the core metabolic network, while others aim at identifying low-abundance metabolites and environmental chemicals. Hence there isn’t a globally optimal choice of the parameters. However, the newly added parameters for two-stage processing have straight-forward interpretations. They are proportions of samples from which the features are detected, either in each batch, or across the batches. The higher the value of <italic>p</italic><sub><italic>within_detect</italic></sub>, the more stringent the within-batch peak detection, the less features detected within each batch. Similarly, <italic>p</italic><sub><italic>within_report</italic></sub> tunes the stringency after within-batch weak signal recovery. A higher <italic>p</italic><sub><italic>within_report</italic></sub> value results in less features reported from each batch. The parameter <italic>p</italic><sub><italic>batch</italic></sub> controls between-batch stringency. A higher <italic>p</italic><sub><italic>batch</italic></sub> value requires an aligned feature to be detected in more batches. Thus increasing the value of <italic>p</italic><sub><italic>batch</italic></sub> results in lower number of features. Given their interpretability, the tuning would be a guided effort by the user.</p>
      <p id="Par68">By combining the two-stage method with batch-effect correction methods ComBat and WaveICA, we found that at least in some datasets, the application of batch-effect correction can further improve the data quality. After the application of the batch-effect correction methods, the two-stage approach still outperformed traditional apLCMS and XCMS. This indicates that addressing batch effect in data preprocessing is important.</p>
      <p id="Par69">Given the total number of samples, the computing time is influenced by the batch size. We examined the computing time using the 100 QC profiles, using an old HP workstation with dual first-generation Xeon E5-2660 CPU. We utilized 10 CPU cores. The computing time was ~ 70 min.</p>
      <p id="Par70">Besides de novo feature detection, a hybrid feature detection method is available in apLCMS, in which a pre-existing database of known feature is used to improve weak signal detection<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>. In the current study, for fairness of comparison, we did not use known feature database. Nonetheless, besides conducting untargeted feature detection, the new two-stage procedure is also adapted to the hybrid feature detection procedure. It is capable of incorporating prior knowledge to boost feature detection.</p>
      <p id="Par71">There are some limitations to the method. The current implementation is limited to apLCMS, and thus limited to high-resolution LC/MS data. We believe the same strategy can be implemented in other packages for wider application, such as GC/MS data. This work was focused on data generated in multiple batches from the same machine. In the CHDWB dataset, we picked batches that were not consecutively collected, and the method worked well. Nonetheless, although there can be some batch effects, we still assume different batches cannot have drastically different characteristics, as reliable feature alignment is necessary for batch effect correction. The issue of combining data from multiple machines is a much more difficult one. We will try to address such issues in future studies.</p>
    </sec>
  </sec>
  <sec id="Sec13">
    <title>Conclusion</title>
    <p id="Par72">We presented a two-stage approach for LC/MS metabolomics data generated in multiple batches. By analyzing data with multiple batches, both generated from a standardized plasma sample and from real biological samples, we showed that the new method improved the consistency of feature detection and quantification. The method is available as part of the apLCMS package. The package can be downloaded at <ext-link ext-link-type="uri" xlink:href="https://github.com/tianwei-yu/apLCMS">https://github.com/tianwei-yu/apLCMS</ext-link>. The instructions are at <ext-link ext-link-type="uri" xlink:href="https://mypage.cuhk.edu.cn/academics/yutianwei/apLCMS/">https://mypage.cuhk.edu.cn/academics/yutianwei/apLCMS/</ext-link>.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec14">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41598_2020_70850_MOESM1_ESM.zip">
            <caption>
              <p>Supplementary information</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p>
        <bold>Publisher's note</bold>
      </p>
      <p>Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <sec>
    <title>Supplementary information</title>
    <p> is available for this paper at 10.1038/s41598-020-70850-0.</p>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>This work was partially supported by NIH grants R01GM124061 and U01CA235493, National Key R&amp;D Program of China Grant No. 2018YFB0505000, Emory/Georgia Tech Center for Health Discovery and Well Being (CHDWB), and a grant from the University Development Fund of CUHK-Shenzhen.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>T.Y. designed the method. D.W, K.U., C.M., V.T., S.L., D.J. provided the data. Q.L., D.W. conducted testing on the data. Q.L., Z.L. and T.Y. drafted the manuscript. All authors reviewed the manuscript.</p>
  </notes>
  <notes notes-type="COI-statement">
    <title>Competing interests</title>
    <p>The authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Aberg</surname>
            <given-names>KM</given-names>
          </name>
          <name>
            <surname>Torgrip</surname>
            <given-names>RJ</given-names>
          </name>
          <name>
            <surname>Kolmert</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Schuppe-Koistinen</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Lindberg</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Feature detection and alignment of hyphenated chromatographic-mass spectrometric data. Extraction of pure ion chromatograms using Kalman tracking</article-title>
        <source>J. Chromatogr. A</source>
        <year>2008</year>
        <volume>1192</volume>
        <fpage>139</fpage>
        <lpage>146</lpage>
        <pub-id pub-id-type="doi">10.1016/j.chroma.2008.03.033</pub-id>
        <?supplied-pmid 18378252?>
        <pub-id pub-id-type="pmid">18378252</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Chae</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Shmookler Reis</surname>
            <given-names>RJ</given-names>
          </name>
          <name>
            <surname>Thaden</surname>
            <given-names>JJ</given-names>
          </name>
        </person-group>
        <article-title>An iterative block-shifting approach to retention time alignment that preserves the shape and area of gas chromatography-mass spectrometry peaks</article-title>
        <source>BMC Bioinform.</source>
        <year>2008</year>
        <volume>9</volume>
        <issue>Suppl 9</issue>
        <fpage>S15</fpage>
        <pub-id pub-id-type="doi">10.1186/1471-2105-9-S9-S15</pub-id>
      </element-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Katajamaa</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Miettinen</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Oresic</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>MZmine: Toolbox for processing and visualization of mass spectrometry based molecular profile data</article-title>
        <source>Bioinformatics (Oxford, England)</source>
        <year>2006</year>
        <volume>22</volume>
        <fpage>634</fpage>
        <lpage>636</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btk039</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>Z</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Nonlinear alignment of chromatograms by means of moving window fast Fourier transfrom cross-correlation</article-title>
        <source>J. Sep. Sci.</source>
        <year>2013</year>
        <volume>36</volume>
        <fpage>1677</fpage>
        <lpage>1684</lpage>
        <pub-id pub-id-type="doi">10.1002/jssc.201201021</pub-id>
        <?supplied-pmid 23436496?>
        <pub-id pub-id-type="pmid">23436496</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Smith</surname>
            <given-names>CA</given-names>
          </name>
          <name>
            <surname>Want</surname>
            <given-names>EJ</given-names>
          </name>
          <name>
            <surname>O'Maille</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Abagyan</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Siuzdak</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>XCMS: processing mass spectrometry data for metabolite profiling using nonlinear peak alignment, matching, and identification</article-title>
        <source>Anal. Chem.</source>
        <year>2006</year>
        <volume>78</volume>
        <fpage>779</fpage>
        <lpage>787</lpage>
        <pub-id pub-id-type="doi">10.1021/ac051437y</pub-id>
        <pub-id pub-id-type="pmid">16448051</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stolt</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Second-order peak detection for multicomponent high-resolution LC/MS data</article-title>
        <source>Anal. Chem.</source>
        <year>2006</year>
        <volume>78</volume>
        <fpage>975</fpage>
        <lpage>983</lpage>
        <pub-id pub-id-type="doi">10.1021/ac050980b</pub-id>
        <?supplied-pmid 16478086?>
        <pub-id pub-id-type="pmid">16478086</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Takahashi</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Morimoto</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Ogasawara</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Kanaya</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>AMDORAP: Non-targeted metabolic profiling based on high-resolution LC–MS</article-title>
        <source>BMC Bioinform.</source>
        <year>2011</year>
        <volume>12</volume>
        <fpage>259</fpage>
        <pub-id pub-id-type="doi">10.1186/1471-2105-12-259</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tautenhahn</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Bottcher</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Neumann</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>Highly sensitive feature detection for high resolution LC/MS</article-title>
        <source>BMC Bioinform.</source>
        <year>2008</year>
        <volume>9</volume>
        <fpage>504</fpage>
        <pub-id pub-id-type="doi">10.1186/1471-2105-9-504</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Trevino</surname>
            <given-names>V</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>GridMass: A fast two-dimensional feature detection method for LC/MS</article-title>
        <source>J. Mass Spectrom.</source>
        <year>2015</year>
        <volume>50</volume>
        <fpage>165</fpage>
        <lpage>174</lpage>
        <pub-id pub-id-type="doi">10.1002/jms.3512</pub-id>
        <?supplied-pmid 25601689?>
        <pub-id pub-id-type="pmid">25601689</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Uppal</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>xMSanalyzer: Automated pipeline for improved feature detection and downstream analysis of large-scale, non-targeted metabolomics data</article-title>
        <source>BMC Bioinform.</source>
        <year>2013</year>
        <volume>14</volume>
        <fpage>15</fpage>
        <pub-id pub-id-type="doi">10.1186/1471-2105-14-15</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Yu</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Park</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Johnson</surname>
            <given-names>JM</given-names>
          </name>
          <name>
            <surname>Jones</surname>
            <given-names>DP</given-names>
          </name>
        </person-group>
        <article-title>apLCMS–adaptive processing of high-resolution LC/MS data</article-title>
        <source>Bioinformatics (Oxford, England)</source>
        <year>2009</year>
        <volume>25</volume>
        <fpage>1930</fpage>
        <lpage>1936</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btp291</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Yu</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Park</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Jones</surname>
            <given-names>DP</given-names>
          </name>
        </person-group>
        <article-title>Hybrid feature detection and information accumulation using high-resolution LC–MS metabolomics data</article-title>
        <source>J. Proteome Res.</source>
        <year>2013</year>
        <volume>12</volume>
        <fpage>1419</fpage>
        <lpage>1427</lpage>
        <pub-id pub-id-type="doi">10.1021/pr301053d</pub-id>
        <?supplied-pmid 23362826?>
        <pub-id pub-id-type="pmid">23362826</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Spicer</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Salek</surname>
            <given-names>RM</given-names>
          </name>
          <name>
            <surname>Moreno</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Canueto</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Steinbeck</surname>
            <given-names>C</given-names>
          </name>
        </person-group>
        <article-title>Navigating freely-available software tools for metabolomics analysis</article-title>
        <source>Metabolomics</source>
        <year>2017</year>
        <volume>13</volume>
        <fpage>106</fpage>
        <pub-id pub-id-type="doi">10.1007/s11306-017-1242-7</pub-id>
        <?supplied-pmid 28890673?>
        <pub-id pub-id-type="pmid">28890673</pub-id>
      </element-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kuhl</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Tautenhahn</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Bottcher</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Larson</surname>
            <given-names>TR</given-names>
          </name>
          <name>
            <surname>Neumann</surname>
            <given-names>S</given-names>
          </name>
        </person-group>
        <article-title>CAMERA: An integrated strategy for compound spectra extraction and annotation of liquid chromatography/mass spectrometry data sets</article-title>
        <source>Anal. Chem.</source>
        <year>2012</year>
        <volume>84</volume>
        <fpage>283</fpage>
        <lpage>289</lpage>
        <pub-id pub-id-type="doi">10.1021/ac202450g</pub-id>
        <?supplied-pmid 22111785?>
        <pub-id pub-id-type="pmid">22111785</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Blazenovic</surname>
            <given-names>I</given-names>
          </name>
          <name>
            <surname>Kind</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Ji</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Fiehn</surname>
            <given-names>O</given-names>
          </name>
        </person-group>
        <article-title>Software tools and approaches for compound identification of LC–MS/MS data in metabolomics</article-title>
        <source>Metabolites</source>
        <year>2018</year>
        <pub-id pub-id-type="doi">10.3390/metabo8020031</pub-id>
        <?supplied-pmid 29748461?>
        <pub-id pub-id-type="pmid">29748461</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Jaeger</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Meret</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Schmitt</surname>
            <given-names>CA</given-names>
          </name>
          <name>
            <surname>Lisec</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Compound annotation in liquid chromatography/high-resolution mass spectrometry based metabolomics: Robust adduct ion determination as a prerequisite to structure prediction in electrospray ionization mass spectra</article-title>
        <source>Rapid. Commun. Mass Spectrom.</source>
        <year>2017</year>
        <volume>31</volume>
        <fpage>1261</fpage>
        <lpage>1266</lpage>
        <pub-id pub-id-type="doi">10.1002/rcm.7905</pub-id>
        <?supplied-pmid 28499062?>
        <pub-id pub-id-type="pmid">28499062</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhang</surname>
            <given-names>W</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>MET-COFEA: A liquid chromatography/mass spectrometry data processing platform for metabolite compound feature extraction and annotation</article-title>
        <source>Anal. Chem.</source>
        <year>2014</year>
        <volume>86</volume>
        <fpage>6245</fpage>
        <lpage>6253</lpage>
        <pub-id pub-id-type="doi">10.1021/ac501162k</pub-id>
        <?supplied-pmid 24856452?>
        <pub-id pub-id-type="pmid">24856452</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Uppal</surname>
            <given-names>K</given-names>
          </name>
          <name>
            <surname>Walker</surname>
            <given-names>DI</given-names>
          </name>
          <name>
            <surname>Jones</surname>
            <given-names>DP</given-names>
          </name>
        </person-group>
        <article-title>xMSannotator: An R package for network-based annotation of high-resolution metabolomics data</article-title>
        <source>Anal. Chem.</source>
        <year>2017</year>
        <volume>89</volume>
        <fpage>1063</fpage>
        <lpage>1067</lpage>
        <pub-id pub-id-type="doi">10.1021/acs.analchem.6b01214</pub-id>
        <?supplied-pmid 27977166?>
        <pub-id pub-id-type="pmid">27977166</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Smith</surname>
            <given-names>CA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>METLIN: A metabolite mass spectral database</article-title>
        <source>Ther. Drug Monit.</source>
        <year>2005</year>
        <volume>27</volume>
        <fpage>747</fpage>
        <lpage>751</lpage>
        <pub-id pub-id-type="doi">10.1097/01.ftd.0000179845.53213.39</pub-id>
        <pub-id pub-id-type="pmid">16404815</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wishart</surname>
            <given-names>DS</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>HMDB: A knowledgebase for the human metabolome</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2009</year>
        <volume>37</volume>
        <fpage>D603</fpage>
        <lpage>610</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkn810</pub-id>
        <?supplied-pmid 18953024?>
        <pub-id pub-id-type="pmid">18953024</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cui</surname>
            <given-names>Q</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Metabolite identification via the Madison Metabolomics Consortium Database</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2008</year>
        <volume>26</volume>
        <fpage>162</fpage>
        <lpage>164</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt0208-162</pub-id>
        <?supplied-pmid 18259166?>
        <pub-id pub-id-type="pmid">18259166</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Brunius</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Shi</surname>
            <given-names>L</given-names>
          </name>
          <name>
            <surname>Landberg</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Large-scale untargeted LC–MS metabolomics data correction using between-batch feature alignment and cluster-based within-batch signal intensity drift correction</article-title>
        <source>Metabolomics</source>
        <year>2016</year>
        <volume>12</volume>
        <fpage>173</fpage>
        <pub-id pub-id-type="doi">10.1007/s11306-016-1124-4</pub-id>
        <?supplied-pmid 27746707?>
        <pub-id pub-id-type="pmid">27746707</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Luan</surname>
            <given-names>H</given-names>
          </name>
          <name>
            <surname>Ji</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Chen</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Cai</surname>
            <given-names>Z</given-names>
          </name>
        </person-group>
        <article-title>statTarget: A streamlined tool for signal drift correction and interpretations of quantitative mass spectrometry-based omics data</article-title>
        <source>Anal. Chim. Acta</source>
        <year>2018</year>
        <volume>1036</volume>
        <fpage>66</fpage>
        <lpage>72</lpage>
        <pub-id pub-id-type="doi">10.1016/j.aca.2018.08.002</pub-id>
        <?supplied-pmid 30253838?>
        <pub-id pub-id-type="pmid">30253838</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kirwan</surname>
            <given-names>JA</given-names>
          </name>
          <name>
            <surname>Broadhurst</surname>
            <given-names>DI</given-names>
          </name>
          <name>
            <surname>Davidson</surname>
            <given-names>RL</given-names>
          </name>
          <name>
            <surname>Viant</surname>
            <given-names>MR</given-names>
          </name>
        </person-group>
        <article-title>Characterising and correcting batch variation in an automated direct infusion mass spectrometry (DIMS) metabolomics workflow</article-title>
        <source>Anal. Bioanal. Chem.</source>
        <year>2013</year>
        <volume>405</volume>
        <fpage>5147</fpage>
        <lpage>5157</lpage>
        <pub-id pub-id-type="doi">10.1007/s00216-013-6856-7</pub-id>
        <?supplied-pmid 23455646?>
        <pub-id pub-id-type="pmid">23455646</pub-id>
      </element-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Kuligowski</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Sanchez-Illana</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Sanjuan-Herraez</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Vento</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Quintas</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Intra-batch effect correction in liquid chromatography-mass spectrometry using quality control samples and support vector regression (QC-SVRC)</article-title>
        <source>Analyst</source>
        <year>2015</year>
        <volume>140</volume>
        <fpage>7810</fpage>
        <lpage>7817</lpage>
        <pub-id pub-id-type="doi">10.1039/c5an01638j</pub-id>
        <?supplied-pmid 26462549?>
        <pub-id pub-id-type="pmid">26462549</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sanchez-Illana</surname>
            <given-names>A</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Evaluation of batch effect elimination using quality control replicates in LC–MS metabolite profiling</article-title>
        <source>Anal. Chim. Acta</source>
        <year>2018</year>
        <volume>1019</volume>
        <fpage>38</fpage>
        <lpage>48</lpage>
        <pub-id pub-id-type="doi">10.1016/j.aca.2018.02.053</pub-id>
        <?supplied-pmid 29625683?>
        <pub-id pub-id-type="pmid">29625683</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Fei</surname>
            <given-names>T</given-names>
          </name>
          <name>
            <surname>Yu</surname>
            <given-names>T</given-names>
          </name>
        </person-group>
        <article-title>scBatch: Batch-effect correction of RNA-seq data through sample distance matrix adjustment</article-title>
        <source>Bioinformatics (Oxford, England)</source>
        <year>2020</year>
        <volume>36</volume>
        <fpage>3115</fpage>
        <lpage>3123</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btaa097</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Johnson</surname>
            <given-names>WE</given-names>
          </name>
          <name>
            <surname>Li</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Rabinovic</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Adjusting batch effects in microarray expression data using empirical Bayes methods</article-title>
        <source>Biostatistics</source>
        <year>2007</year>
        <volume>8</volume>
        <fpage>118</fpage>
        <lpage>127</lpage>
        <pub-id pub-id-type="doi">10.1093/biostatistics/kxj037</pub-id>
        <?supplied-pmid 16632515?>
        <pub-id pub-id-type="pmid">16632515</pub-id>
      </element-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Deng</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>WaveICA: A novel algorithm to remove batch effects for large-scale untargeted metabolomics data based on wavelet analysis</article-title>
        <source>Anal. Chim Acta</source>
        <year>2019</year>
        <volume>1061</volume>
        <fpage>60</fpage>
        <lpage>69</lpage>
        <pub-id pub-id-type="doi">10.1016/j.aca.2019.02.010</pub-id>
        <?supplied-pmid 30926040?>
        <pub-id pub-id-type="pmid">30926040</pub-id>
      </element-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rong</surname>
            <given-names>Z</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>NormAE: Deep adversarial learning model to remove batch effects in liquid chromatography mass spectrometry-based metabolomics data</article-title>
        <source>Anal. Chem.</source>
        <year>2020</year>
        <volume>92</volume>
        <fpage>5082</fpage>
        <lpage>5090</lpage>
        <pub-id pub-id-type="doi">10.1021/acs.analchem.9b05460</pub-id>
        <?supplied-pmid 32207605?>
        <pub-id pub-id-type="pmid">32207605</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Salerno</surname>
            <given-names>S</given-names>
            <suffix>Jr</suffix>
          </name>
          <etal/>
        </person-group>
        <article-title>RRmix: A method for simultaneous batch effect correction and analysis of metabolomics data in the absence of internal standards</article-title>
        <source>PLoS ONE</source>
        <year>2017</year>
        <volume>12</volume>
        <fpage>e0179530</fpage>
        <pub-id pub-id-type="doi">10.1371/journal.pone.0179530</pub-id>
        <?supplied-pmid 28662051?>
        <pub-id pub-id-type="pmid">28662051</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dunn</surname>
            <given-names>WB</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Procedures for large-scale metabolic profiling of serum and plasma using gas chromatography and liquid chromatography coupled to mass spectrometry</article-title>
        <source>Nat. Protoc.</source>
        <year>2011</year>
        <volume>6</volume>
        <fpage>1060</fpage>
        <lpage>1083</lpage>
        <pub-id pub-id-type="doi">10.1038/nprot.2011.335</pub-id>
        <?supplied-pmid 21720319?>
        <pub-id pub-id-type="pmid">21720319</pub-id>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Fan</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Systematic error removal using random forest for normalizing large-scale untargeted lipidomics data</article-title>
        <source>Anal. Chem.</source>
        <year>2019</year>
        <volume>91</volume>
        <fpage>3590</fpage>
        <lpage>3596</lpage>
        <pub-id pub-id-type="doi">10.1021/acs.analchem.8b05592</pub-id>
        <?supplied-pmid 30758187?>
        <pub-id pub-id-type="pmid">30758187</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <mixed-citation publication-type="other"><ext-link ext-link-type="uri" xlink:href="https://www.metabolomicsworkbench.org/data/DRCCMetadata.php?Mode=Study&amp;StudyID=ST000868">https://www.metabolomicsworkbench.org/data/DRCCMetadata.php?Mode=Study&amp;StudyID=ST000868</ext-link>.</mixed-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sud</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Metabolomics Workbench: An international repository for metabolomics data and metadata, metabolite standards, protocols, tutorials and training, and analysis tools</article-title>
        <source>Nucleic Acids Res</source>
        <year>2016</year>
        <volume>44</volume>
        <fpage>D463</fpage>
        <lpage>470</lpage>
        <pub-id pub-id-type="doi">10.1093/nar/gkv1042</pub-id>
        <?supplied-pmid 26467476?>
        <pub-id pub-id-type="pmid">26467476</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tabassum</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A longitudinal study of health improvement in the Atlanta CHDWB Wellness Cohort</article-title>
        <source>J. Pers. Med.</source>
        <year>2014</year>
        <volume>4</volume>
        <fpage>489</fpage>
        <lpage>507</lpage>
        <pub-id pub-id-type="doi">10.3390/jpm4040489</pub-id>
        <?supplied-pmid 25563459?>
        <pub-id pub-id-type="pmid">25563459</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Libiseller</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>IPO: A tool for automated optimization of XCMS parameters</article-title>
        <source>BMC Bioinform.</source>
        <year>2015</year>
        <volume>16</volume>
        <fpage>118</fpage>
        <pub-id pub-id-type="doi">10.1186/s12859-015-0562-8</pub-id>
      </element-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Benjamini</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Hochberg</surname>
            <given-names>Y</given-names>
          </name>
        </person-group>
        <article-title>Controlling the false discovery rate: A practical and powerful approach to multiple testing</article-title>
        <source>J. R. Stat. Soc. B</source>
        <year>1995</year>
        <volume>57</volume>
        <fpage>289</fpage>
        <lpage>300</lpage>
      </element-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ho</surname>
            <given-names>JE</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Metabolomic profiles of body mass index in the Framingham heart study reveal distinct Cardiometabolic phenotypes</article-title>
        <source>PLoS ONE</source>
        <year>2016</year>
        <volume>11</volume>
        <fpage>e0148361</fpage>
        <pub-id pub-id-type="doi">10.1371/journal.pone.0148361</pub-id>
        <?supplied-pmid 26863521?>
        <pub-id pub-id-type="pmid">26863521</pub-id>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Predicting network activity from high throughput metabolomics</article-title>
        <source>PLoS Comput. Biol.</source>
        <year>2013</year>
        <volume>9</volume>
        <fpage>e1003123</fpage>
        <pub-id pub-id-type="doi">10.1371/journal.pcbi.1003123</pub-id>
        <?supplied-pmid 23861661?>
        <pub-id pub-id-type="pmid">23861661</pub-id>
      </element-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Manna</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Jain</surname>
            <given-names>SK</given-names>
          </name>
        </person-group>
        <article-title>Phosphatidylinositol-3,4,5-triphosphate and cellular signaling: Implications for obesity and diabetes</article-title>
        <source>Cell Physiol. Biochem.</source>
        <year>2015</year>
        <volume>35</volume>
        <fpage>1253</fpage>
        <lpage>1275</lpage>
        <pub-id pub-id-type="doi">10.1159/000373949</pub-id>
        <?supplied-pmid 25721445?>
        <pub-id pub-id-type="pmid">25721445</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</back>
