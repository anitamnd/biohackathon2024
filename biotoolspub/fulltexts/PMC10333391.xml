<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Commun</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Commun</journal-id>
    <journal-title-group>
      <journal-title>Nature Communications</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2041-1723</issn>
    <publisher>
      <publisher-name>Nature Publishing Group UK</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10333391</article-id>
    <article-id pub-id-type="pmid">37429865</article-id>
    <article-id pub-id-type="publisher-id">39748</article-id>
    <article-id pub-id-type="doi">10.1038/s41467-023-39748-z</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>nnSVG for the scalable identification of spatially variable genes using nearest-neighbor Gaussian processes</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-3282-1730</contrib-id>
        <name>
          <surname>Weber</surname>
          <given-names>Lukas M.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Saha</surname>
          <given-names>Arkajyoti</given-names>
        </name>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-5046-0289</contrib-id>
        <name>
          <surname>Datta</surname>
          <given-names>Abhirup</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-0086-0687</contrib-id>
        <name>
          <surname>Hansen</surname>
          <given-names>Kasper D.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-7858-0231</contrib-id>
        <name>
          <surname>Hicks</surname>
          <given-names>Stephanie C.</given-names>
        </name>
        <address>
          <email>shicks19@jhu.edu</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.21107.35</institution-id><institution-id institution-id-type="ISNI">0000 0001 2171 9311</institution-id><institution>Department of Biostatistics, </institution><institution>Johns Hopkins Bloomberg School of Public Health, </institution></institution-wrap>Baltimore, MD USA </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.34477.33</institution-id><institution-id institution-id-type="ISNI">0000000122986657</institution-id><institution>Department of Statistics, </institution><institution>University of Washington, </institution></institution-wrap>Seattle, WA USA </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>10</day>
      <month>7</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>10</day>
      <month>7</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2023</year>
    </pub-date>
    <volume>14</volume>
    <elocation-id>4059</elocation-id>
    <history>
      <date date-type="received">
        <day>15</day>
        <month>6</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>23</day>
        <month>6</month>
        <year>2023</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2023</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Feature selection to identify spatially variable genes or other biologically informative genes is a key step during analyses of spatially-resolved transcriptomics data. Here, we propose nnSVG, a scalable approach to identify spatially variable genes based on nearest-neighbor Gaussian processes. Our method (i) identifies genes that vary in expression continuously across the entire tissue or within a priori defined spatial domains, (ii) uses gene-specific estimates of length scale parameters within the Gaussian process models, and (iii) scales linearly with the number of spatial locations. We demonstrate the performance of our method using experimental data from several technological platforms and simulations. A software implementation is available at <ext-link ext-link-type="uri" xlink:href="https://bioconductor.org/packages/nnSVG">https://bioconductor.org/packages/nnSVG</ext-link>.</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">The identification of top spatially variable genes is a key step in the analysis of spatially-resolved transcriptomics data. Here, the authors develop a scalable method based on nearest-neighbor Gaussian processes and evaluate performance compared to existing and baseline methods.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Statistical methods</kwd>
      <kwd>Software</kwd>
      <kwd>Transcriptomics</kwd>
      <kwd>Software</kwd>
      <kwd>Sequencing</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000025</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Institute of Mental Health (NIMH)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>U01MH122849</award-id>
        <principal-award-recipient>
          <name>
            <surname>Hicks</surname>
            <given-names>Stephanie C.</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000051</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Human Genome Research Institute (NHGRI)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>K99HG012229</award-id>
        <principal-award-recipient>
          <name>
            <surname>Hicks</surname>
            <given-names>Stephanie C.</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000066</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Institute of Environmental Health Sciences (NIEHS)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>R01ES033739</award-id>
        <principal-award-recipient>
          <name>
            <surname>Hicks</surname>
            <given-names>Stephanie C.</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>National Science Foundation Division of Mathematical Sciences: DMS-1915803 Chan Zuckerberg Initiative DAF: CZF2019-002443 Chan Zuckerberg Initiative DAF: CZF2018-183446</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© Springer Nature Limited 2023</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1" sec-type="introduction">
    <title>Introduction</title>
    <p id="Par3">Spatially-resolved transcriptomics (SRT) refers to recently developed technologies that measure gene expression in either the full transcriptome or up to thousands of genes at near- or sub-cellular resolution along with spatial coordinates of the measurements, either based on (i) tagging messenger RNA (mRNA) molecules with spatial barcodes followed by sequencing<sup><xref ref-type="bibr" rid="CR1">1</xref>–<xref ref-type="bibr" rid="CR4">4</xref></sup> or (ii) fluorescence imaging-based in situ transcriptomics techniques where mRNA molecules are detected along with their spatial coordinates using sequential rounds of fluorescent barcoding<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR6">6</xref></sup>. These technologies have been used to study the spatial landscape of gene expression in a variety of biological systems, including the brain<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR7">7</xref>,<xref ref-type="bibr" rid="CR8">8</xref></sup>, cancer<sup><xref ref-type="bibr" rid="CR9">9</xref></sup>, and embryonic development<sup><xref ref-type="bibr" rid="CR10">10</xref></sup>.</p>
    <p id="Par4">However, these new platforms also bring new computational challenges<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>. One common analysis task is to identify genes that vary in expression across a tissue, defined as spatially variable genes by Svensson et al.<sup><xref ref-type="bibr" rid="CR12">12</xref></sup> (SVGs). These SVGs can then be further investigated individually as potential markers of biological processes, or used as the input for downstream analyses such as spatially-aware unsupervised clustering<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR14">14</xref></sup> or registering the spatial locations of single-cell RNA sequencing (scRNA-seq) data<sup><xref ref-type="bibr" rid="CR11">11</xref>,<xref ref-type="bibr" rid="CR15">15</xref>,<xref ref-type="bibr" rid="CR16">16</xref></sup>.</p>
    <p id="Par5">To identify SVGs, one approach is to ignore the spatial coordinates and apply methods that rely only on the gene expression, such as feature selection methods used in the analysis of scRNA-seq data, including highly variable genes (HVGs)<sup><xref ref-type="bibr" rid="CR17">17</xref>–<xref ref-type="bibr" rid="CR19">19</xref></sup> or deviance residuals from binomial or Poisson models<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>. A second approach is to use both the gene expression and spatial coordinates to identify genes that vary in expression in a continuous manner, either across the entire tissue or within a priori defined spatial domains, for example, using morphology from histology images, representing a subset of the tissue. Here, we refer to this second set of approaches with continuous spatial variation as methods to detect SVGs. Some examples of these methods include (i) standard spatial statistics measures (Moran’s I statistic<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>, Geary’s C statistic<sup><xref ref-type="bibr" rid="CR22">22</xref></sup>) to rank genes by their spatial autocorrelation, (ii) marked point processes (trendsceek<sup><xref ref-type="bibr" rid="CR23">23</xref></sup>), (iii) Gaussian process (GP) regression (SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, SpatialDE2<sup><xref ref-type="bibr" rid="CR24">24</xref></sup>), (iv) generalized linear spatial models with either an overdispersed Poisson or Gaussian distribution (SPARK<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>) or a zero-inflated negative binomial distribution (BOOST-GP<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>), or (v) nonparametric covariance tests (SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>). These methods make tradeoffs, for example, flexibility in fitting gene-specific parameters (iii, iv) versus improved computational efficiency (v). There are also toolboxes that incorporate some of these methods, for example, MERINGUE<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>, Giotto<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>, within a larger end-to-end analysis framework.</p>
    <p id="Par6">A third approach is to detect changes in the average expression at all spatial coordinates within one spatial domain relative to the average expression at all spatial coordinates in other domains. We refer to these approaches as methods to detect spatial domain marker genes. The spatial domains can be defined a priori, for example using morphology from histology images, or alternatively using an unsupervised clustering algorithm. However, the primary difference between methods to identify SVGs and these approaches are the type of variation in expression. In contrast to methods searching for continuous variation across the tissue (SVGs), these methods search for changes in the mean expression across spatial coordinates within one domain compared to other domains. This is in similar spirit to detecting marker genes between discrete cell populations in scRNA-seq data. An example of this approach is SpaGCN<sup><xref ref-type="bibr" rid="CR14">14</xref></sup>, which first uses the spatial coordinates to identify domains in an unsupervised manner and then performs domain-guided differential expression analysis<sup><xref ref-type="bibr" rid="CR14">14</xref></sup> with a Wilcoxon rank-sum test to identify mean-level changes between the spatial domains. Here, we are interested in methods to identify SVGs, not spatial domain marker genes. Therefore, we focus on methods to identify SVGs in this work.</p>
    <p id="Par7">A key distinguishing characteristic among recent methods to identify SVGs is computational scalability. In particular, SPARK-X scales linearly with the number of spatial locations<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>, while other methods scale cubically (e.g., SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup> and SPARK<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>) or quadratically (SpatialDE2<sup><xref ref-type="bibr" rid="CR24">24</xref></sup>). This is relevant as datasets from the latest SRT platforms such as 10x Genomics Visium<sup><xref ref-type="bibr" rid="CR2">2</xref></sup> and Slide-seqV2<sup><xref ref-type="bibr" rid="CR4">4</xref></sup> contain thousands of spatial locations per tissue sample, with future development moving towards even higher resolution. In addition, a limited set of existing methods, such as SPARK-X, offer the ability to search for continuous variation in expression within a priori defined spatial domains, which can be incorporated as known covariates in statistical models fit for each gene<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. However, SPARK-X uses the same set of kernels and length scale parameters for all genes, which reduces flexibility to identify SVGs from different biological processes with varying spatial ranges in expression within the same tissue sample. In this work, we aimed to address this limitation and develop a computationally scalable approach to identify SVGs that fits a flexible length scale parameter per gene and also allows taking spatial domains into account.</p>
    <p id="Par8">Here, we describe nnSVG, a method to identify SVGs, which is based on statistical advances in computationally scalable parameter estimation in spatial covariance functions in GPs using nearest-neighbor Gaussian process (NNGP) models<sup><xref ref-type="bibr" rid="CR30">30</xref>–<xref ref-type="bibr" rid="CR32">32</xref></sup>. First, we introduce an overview of the methodological framework and then we compare our method to other methods in several SRT datasets including from the 10x Genomics Visium<sup><xref ref-type="bibr" rid="CR2">2</xref></sup>, Spatial Transcriptomics<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, Slide-seqV2<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>, and seqFISH<sup><xref ref-type="bibr" rid="CR33">33</xref></sup> platforms. Our method can search for SVGs across an entire tissue or within a priori defined spatial domains. In addition, unlike existing scalable methods, our approach estimates a gene-specific length scale parameter within the spatial covariance function in the GPs, enabling flexibility in the types of SVGs identified. We demonstrate that our method scales linearly with the number of spatial locations, ensuring the method can be applied to datasets with thousands or more spatial locations. Our methodology is implemented in the nnSVG R package within the Bioconductor framework<sup><xref ref-type="bibr" rid="CR34">34</xref></sup> and can be integrated into workflows using established Bioconductor infrastructure for SRT and scRNA-seq data<sup><xref ref-type="bibr" rid="CR17">17</xref>,<xref ref-type="bibr" rid="CR35">35</xref></sup>.</p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>Overview of the nnSVG model and methodological framework</title>
      <p id="Par9">The nnSVG framework fits a nearest-neighbor Gaussian process (NNGP) model<sup><xref ref-type="bibr" rid="CR30">30</xref>,<xref ref-type="bibr" rid="CR31">31</xref></sup> to the preprocessed expression values for each gene:<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\bf{y}}}}}}}} \sim N({{{{{{{\bf{X}}}}}}}}{{{{{{{\boldsymbol{\beta }}}}}}}},{{{\widetilde{{{{{\boldsymbol{{{\Sigma }}}}}}}}}}}({{{{{{{\boldsymbol{\theta }}}}}}}},{\tau }^{2}))$$\end{document}</tex-math><mml:math id="M2"><mml:mi mathvariant="bold">y</mml:mi><mml:mo>~</mml:mo><mml:mi>N</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">X</mml:mi><mml:mi mathvariant="bold-italic">β</mml:mi><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">Σ</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par10">Here, <bold>y</bold> = (<italic>y</italic><sub>1</sub>, …, <italic>y</italic><sub><italic>N</italic></sub>) represents the normalized and transformed expression values of gene <italic>g</italic> (subscript <italic>g</italic> = 1, …, <italic>G</italic> omitted for simplicity) at the set of <italic>N</italic> spatial locations <bold>s</bold> = (<bold>s</bold><sub><bold>1</bold></sub>, …, <bold>s</bold><sub><bold>N</bold></sub>), which we assume to be in two dimensions, but may in principle be generalized. The <inline-formula id="IEq1"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{\widetilde{{{{{\boldsymbol{{{\Sigma }}}}}}}}}}}({{{{{{{\boldsymbol{\theta }}}}}}}},{\tau }^{2})$$\end{document}</tex-math><mml:math id="M4"><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">Σ</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2023_39748_Article_IEq1.gif"/></alternatives></inline-formula> term represents the NNGP covariance matrix, which offers a scalable (linear-time and storage) approximation to the covariance matrix <bold>Σ</bold>(<bold><italic>θ</italic></bold>, <italic>τ</italic><sup>2</sup>) = <italic>C</italic>(<bold><italic>θ</italic></bold>) + <italic>τ</italic><sup>2</sup><bold>I</bold> from a full GP model, which scales cubically in the number of spatial locations. The GP covariance matrix <italic>C</italic>(<bold><italic>θ</italic></bold>) = (<italic>C</italic><sub><italic>i</italic><italic>j</italic></sub>(<bold><italic>θ</italic></bold>)) (also referred to as a kernel) captures the spatially correlated variation and is parameterized by a vector of parameters <bold><italic>θ</italic></bold>. We assume an exponential covariance function, based on the observation that the widely used squared exponential covariance function (e.g., used in SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>) decays too rapidly with distance in the context of SRT data<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>. The exponential covariance function is defined as:<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${C}_{ij}({{{{{{{\boldsymbol{\theta }}}}}}}})={\sigma }^{2}\exp \left(\frac{-||{{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{i}}}}}}}}}-{{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{j}}}}}}}}}||}{l}\right)$$\end{document}</tex-math><mml:math id="M6"><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mi>exp</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mfrac><mml:mrow><mml:mo>−</mml:mo><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula>with covariance parameters <bold><italic>θ</italic></bold> = (<italic>σ</italic><sup>2</sup>, <italic>l</italic>), and where ∣∣<bold>s</bold><sub><bold>i</bold></sub> − <bold>s</bold><sub><bold>j</bold></sub>∣∣ represents the Euclidean distance between two spatial locations <bold>s</bold><sub><bold>i</bold></sub> and <bold>s</bold><sub><bold>j</bold></sub>. Here, <italic>σ</italic><sup>2</sup> is the spatial component of variance, and <italic>l</italic> is referred to as the length scale (or bandwidth) parameter, which controls the strength of decay of correlation with distance. The parameter <italic>τ</italic><sup>2</sup> (referred to as the nugget) represents the additional nonspatial component of variance.</p>
      <p id="Par11">The design matrix <bold>X</bold><sub>[<italic>N</italic>×<italic>d</italic>]</sub> can include up to <italic>d</italic> − 1 covariates representing known spatial domains or other information at each spatial location. The default is <bold>X</bold> = <bold>1</bold><sub>[<italic>N</italic>×1]</sub>, representing an intercept, with <bold><italic>β</italic></bold> accounting for the mean expression level. We fit a separate model for each gene and obtain maximum likelihood estimates for the parameters <bold><italic>θ</italic></bold> = (<italic>σ</italic><sup>2</sup>, <italic>l</italic>) and <italic>τ</italic><sup>2</sup> using the fast optimization algorithms for NNGP models implemented in the BRISC R package<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>. The main parameter of interest is <italic>σ</italic><sup>2</sup>, on which we perform a likelihood ratio (LR) test comparing the fitted model against a classical linear model that assumes <italic>σ</italic><sup>2</sup> = 0 and hence does not account for the spatial correlation in expression. Finally, we rank genes by the estimated LR statistic values and calculate multiple-testing adjusted approximate <italic>p</italic>-values for statistical significance. We provide a ranked list of genes, which can be used to select either (i) an arbitrary number of top-ranked genes for further investigation or to use as input for downstream analyses, or (ii) a set of statistically significant SVGs based on <italic>p</italic>-values adjusted for false discoveries. In addition, we calculate an effect size defined as propSV = <italic>σ</italic><sup>2</sup>/(<italic>σ</italic><sup>2</sup> + <italic>τ</italic><sup>2</sup>), which is the proportion of spatial variance (<italic>σ</italic><sup>2</sup>) from the total variance (<italic>σ</italic><sup>2</sup> + <italic>τ</italic><sup>2</sup>), as previously defined by Svensson et al.<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>.</p>
    </sec>
    <sec id="Sec4">
      <title>Key innovations of nnSVG</title>
      <p id="Par12">The key innovations of nnSVG compared to existing approaches are as follows. First, since we use NNGPs to fit the models for each gene, the computational complexity and runtime of nnSVG scale linearly with the number of spatial locations while retaining a large proportion of the underlying information<sup><xref ref-type="bibr" rid="CR30">30</xref>,<xref ref-type="bibr" rid="CR31">31</xref></sup>. SPARK-X also achieves linear scalability<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>, while earlier methods (e.g., SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, SPARK<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>) scale cubically with the number of spatial locations and are thus infeasible to apply to large datasets. Second, we demonstrate that because nnSVG estimates a gene-specific length scale parameter within the models, it enables the identification of SVGs associated with distinct biological processes with varying spatial ranges in expression within the same tissue sample. This cannot be achieved with methods that either assume a fixed length scale parameter or a combination of models with fixed length scale parameters across genes (e.g., SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>) or ignore the spatial information. Finally, nnSVG can identify SVGs within spatial domains by including the spatial domains as covariates within the model, which can also be done with SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> but not other existing methods (e.g., SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, SPARK<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>).</p>
    </sec>
    <sec id="Sec5">
      <title>nnSVG recovers biologically informative SVGs with gene-specific length scales</title>
      <p id="Par13">In the following sections, we consider three SRT datasets that contain previously identified biologically informative SVGs: data with (i) variation across cortical layers in the human brain dorsolateral prefrontal cortex (DLPFC)<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> measured with the 10x Genomics Visium platform<sup><xref ref-type="bibr" rid="CR37">37</xref></sup>, (ii) variation across cell type layers in the mouse brain olfactory bulb (OB)<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup> measured with the Spatial Transcriptomics (ST) platform<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, and (iii) variation within a sagittal tissue section of a mouse embryo<sup><xref ref-type="bibr" rid="CR38">38</xref></sup> measured with the seqFISH platform<sup><xref ref-type="bibr" rid="CR33">33</xref></sup>. In the Visium human DLPFC dataset, while the primary variation in expression is across cortical layers, there are also more subtle forms of variation associated with blood vessels and immune processes, which vary in expression across smaller length scales than the main cortical layers<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. We demonstrate that nnSVG identifies SVGs associated with both forms of variation, and that this flexibility stems from how the nnSVG model fits a gene-specific length scale parameter <italic>l</italic> within the covariance function <italic>C</italic>(<bold><italic>θ</italic></bold>) for each gene (see “Methods”). By contrast, methods that assume a fixed length scale parameter (or a combination of models with fixed length scale parameters) across genes may miss these types of discoveries.</p>
      <p id="Par14">Here, we evaluate the performance of nnSVG in recovering SVGs from the Visium human DLPFC<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, ST mouse OB<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup>, and seqFISH mouse embryo<sup><xref ref-type="bibr" rid="CR38">38</xref></sup> datasets, and compare against SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>, which is the only other existing method that also scales linearly with the number of spatial locations, and can therefore be applied to transcriptome-wide datasets with thousands or more spatial locations<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. In addition, we compare with baseline approaches, specifically HVGs<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> and Moran’s I statistic<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>, as nonspatial and spatial baseline methods, respectively (see “Methods”).</p>
    </sec>
    <sec id="Sec6">
      <title>nnSVG in application to human brain dorsolateral prefrontal cortex</title>
      <p id="Par15">Based on previously published analyses<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, the Visium human DLPFC dataset is known to contain a number of biologically informative SVGs, including a large number of SVGs associated with cortical layers (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, top row), as well as a smaller set of SVGs associated with blood vessels and immune processes (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, bottom row). The manually labeled cortical layer labels<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> (which we use as an approximate ground truth for method evaluation) are shown in Supplementary Fig. <xref rid="MOESM1" ref-type="media">S1A</xref>, <xref rid="MOESM1" ref-type="media">B</xref> as a reference. The spatial expression patterns of the blood- and immune-associated SVGs vary over relatively smaller distance ranges than the cortical layer-associated SVGs, which is reflected by the smaller estimated length scale parameters for the blood and immune-associated SVGs (<inline-formula id="IEq2"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat{l}\, &lt; \,0.1$$\end{document}</tex-math><mml:math id="M8"><mml:mover accent="true"><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover><mml:mspace width="0.25em"/><mml:mo>&lt;</mml:mo><mml:mspace width="0.25em"/><mml:mn>0.1</mml:mn></mml:math><inline-graphic xlink:href="41467_2023_39748_Article_IEq2.gif"/></alternatives></inline-formula>) compared to the cortical layer-associated SVGs (<inline-formula id="IEq3"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat{l}\ge 0.1$$\end{document}</tex-math><mml:math id="M10"><mml:mover accent="true"><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover><mml:mo>≥</mml:mo><mml:mn>0.1</mml:mn></mml:math><inline-graphic xlink:href="41467_2023_39748_Article_IEq3.gif"/></alternatives></inline-formula>) from the nnSVG models (Fig. <xref rid="Fig1" ref-type="fig">1</xref>b).<fig id="Fig1"><label>Fig. 1</label><caption><title>nnSVG recovers biologically informative SVGs with gene-specific length scale parameters.</title><p>Using the Visium human DLPFC dataset<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, nnSVG, SPARK-X, HVGs, and Moran’s I were applied to identify SVGs. <bold>a</bold> Spatial expression plots of 6 known biologically informative SVGs, including cortical layer-associated SVGs (top row) and blood- and immune-associated SVGs (bottom row). <bold>b</bold> Distribution of estimated gene-specific length scale parameters from nnSVG, with the 6 SVGs from (<bold>a</bold>) labeled in red. The blood- and immune-associated SVGs have smaller estimated length scale parameters than the cortical layer-associated SVGs. <bold>c</bold> Rank order of the 6 SVGs from (<bold>a</bold>) within the lists of top SVGs. Dashed vertical line divides the genes into the 3 cortical layer-associated SVGs with large length scales (left) and the 3 blood- and immune-associated SVGs with small length scales (right). <bold>d</bold> Estimated likelihood ratio (LR) statistic from nnSVG (<italic>y</italic>-axis) compared to the rank per gene (<italic>x</italic>-axis), with the 6 SVGs from (<bold>a</bold>) labeled, and 134 additional known layer-specific marker genes (from manually guided analyses by Maynard et al.<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>) highlighted (red circles). Orange dashed vertical line indicates rank cutoff for statistically significant SVGs at a multiple-testing-adjusted <italic>p</italic>-value of 0.05 using LR test with 2 degrees of freedom. <bold>e</bold> Estimated effect size (proportion of spatial variance) along <italic>y</italic>-axis compared to the mean log-transformed normalized counts (logcounts) along <italic>x</italic>-axis for top 1000 SVGs from nnSVG, with the 6 SVGs from (<bold>a</bold>) labeled, and estimated LR statistic per gene indicated with color scale. <bold>f</bold> Ranks of top 1000 SVGs from nnSVG (<italic>y</italic>-axis) compared to ranks from baseline methods (<italic>x</italic>-axis) using HVGs (nonspatial baseline method, left) and Moran’s I (spatially-aware baseline method, right), with SVGs from (<bold>a</bold>) highlighted (black circles), and Spearman correlation (text labels).</p></caption><graphic xlink:href="41467_2023_39748_Fig1_HTML" id="d32e1149"/></fig></p>
      <p id="Par16">All four methods successfully identified two out of the three cortical layer-associated SVGs (<italic>MOBP</italic> and <italic>SNAP25</italic>) within the top 100 ranked genes. While nnSVG, HVGs, and Moran’s I ranked the third SVG (<italic>PCP4</italic>) around rank 100, SPARK-X did not rank <italic>PCP4</italic> within the top 1000 genes (Fig. <xref rid="Fig1" ref-type="fig">1</xref>c, left columns). For the three blood and immune-associated SVGs (<italic>HBB</italic>, <italic>IGKC</italic>, <italic>NPY</italic>), we found that HVGs ranked all 3 genes within the top 100, while nnSVG identified two out of the three within the top 100 and the third around rank 300. Moran’s I ranked these three genes at lower ranks (ranks ~ 100−1000), and SPARK-X did not identify any of the three genes within the top 1000 genes (Fig. <xref rid="Fig1" ref-type="fig">1</xref>c, right columns).</p>
      <p id="Par17">To ensure a consistent comparison in these evaluations, we used the same filtering to remove low-expressed genes for both nnSVG and SPARK-X (3396 out of 21,803 genes passed the filtering threshold; see “Methods”). To confirm that the performance of SPARK-X was not affected by the filtering, we also ran nnSVG and SPARK-X without filtering low-expressed genes, in line with the default setting for SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. The performance for nnSVG was comparable for all six SVGs (with and without filtering). However, the performance for SPARK-X dropped for identifying the blood- and immune-associated SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2A)</xref>.</p>
      <p id="Par18">In addition to these 6 SVGs, this dataset also contains a set of 198 known cortical layer-specific marker genes (consisting of 195 additional genes and the 3 cortical layer-associated SVGs from Fig. <xref rid="Fig1" ref-type="fig">1</xref>a) identified by manually guided pseudobulked analyses in the original study<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. Out of these 198 genes, 134 passed filtering for low-expressed genes, and 133 of these 134 were identified as statistically significant SVGs by nnSVG, out of a total of 2198 statistically significant SVGs (from 3396 genes that passed filtering) at an adjusted <italic>p</italic>-value threshold of 0.05. (The likelihood of correctly selecting 133 out of 134 genes by chance in this case is <italic>p</italic> &lt; 10<sup>−16</sup> by Fisher’s exact test and assuming independently selected genes.) All 3 of the blood- and immune-associated SVGs from Fig. <xref rid="Fig1" ref-type="fig">1</xref>a were also included in the set of significant SVGs from nnSVG (Fig. <xref rid="Fig1" ref-type="fig">1</xref>d). By contrast, SPARK-X identified 3394 (out of 3396) genes as statistically significant SVGs, including all 134 of the layer-specific markers that passed filtering, but one of the 3 blood- and immune-associated SVGs (<italic>NPY</italic>) was not included within the set of significant SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2B)</xref>. Using the default filtering for SPARK-X (i.e., no filtering of low-expressed genes), 10,358 genes were identified as significant SVGs, including 187 out of the 198 layer-specific markers, but not including <italic>NPY</italic> (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2C)</xref>. Considering the effect size defined as the estimated proportion of spatial variance from nnSVG, following ref. <sup><xref ref-type="bibr" rid="CR12">12</xref></sup> (see “Methods”), we found that highly ranked SVGs (with large LR statistics) also had higher proportion of spatial variance, which is also related to the mean expression (Fig. <xref rid="Fig1" ref-type="fig">1</xref>e).</p>
      <p id="Par19">As another form of comparison, we evaluated the degree of overlap between nnSVG and the baseline methods. In this dataset, the main biological signals of interest are related to the spatial distributions of the cortical layers and other biological processes, which are characterized by distinct gene expression profiles<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. Therefore, we expect that most SVGs will also be identified as HVGs, and thus a strong agreement between nnSVG and HVGs gives further confidence in the results from nnSVG. When comparing the ranks of the top 1000 SVGs from nnSVG and HVGs, we found relatively close agreement (Fig. <xref rid="Fig1" ref-type="fig">1</xref>f, left panel), along with a high overlap between the sets of top <italic>n</italic> SVGs from nnSVG and top <italic>n</italic> HVGs (<italic>n</italic> = 10, 20, 50, 100, 200) (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2D)</xref>. We found similar results and higher correlation when comparing between nnSVG and Moran’s I (Fig. <xref rid="Fig1" ref-type="fig">1</xref>f, right panel), demonstrating that for most genes, these two methods recover similar spatial information. However, the largest mismatch in ranks between nnSVG and Moran’s I occurs for the 3 blood- and immune-associated SVGs, especially <italic>NPY</italic>, which have relatively small estimated length scale parameters (Fig. <xref rid="Fig1" ref-type="fig">1</xref>b), thus further demonstrating the advantage of the gene-specific length scale parameters in nnSVG and the improved performance in this dataset for genes with small estimated length scales (Fig. <xref rid="Fig1" ref-type="fig">1</xref>c). Further investigation of the estimated length scales and effect sizes per gene revealed that nnSVG tends to outperform (i) HVGs for genes with larger length scales (≥ 0.15), (ii) Moran’s I for genes with smaller length scales (&lt; 0.15), and (iii) both baselines for genes with relatively large effect sizes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S3A</xref>–<xref rid="MOESM1" ref-type="media">C</xref>; expression plots of examples of genes where nnSVG outperforms the baselines shown in Supplementary Fig. <xref rid="MOESM1" ref-type="media">S3D)</xref>. In addition, we observe that all genes with extremely small length scales (&lt; 0.01)—which may be hard to estimate reliably—were either not ranked within the top 1000 SVGs or were removed during our filtering step for low-expressed genes (“Methods”), so these genes did not interfere with the final ranking of top SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S4)</xref>. In contrast, when comparing SPARK-X to the baseline methods, we found smaller overlap and lower correlations using either HVGs and Moran’s I (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2E)</xref>. The SPARK-X results did not substantially change when using default filtering settings for low-expressed genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2F)</xref>.</p>
      <p id="Par20">Finally, we generated spatial expression plots of the top 20 SVGs from nnSVG and SPARK-X, respectively. We observed that most of the top 20 SVGs from nnSVG were related to differences in expression between white matter and gray matter, where gray matter consists of the cortical layers<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> (Supplementary Figs. <xref rid="MOESM1" ref-type="media">S1</xref>, <xref rid="MOESM1" ref-type="media">S5)</xref>. This is consistent with previous analyses showing that the distinction between white matter and gray matter represents the strongest differences in expression patterns in this dataset, consistent with prior biological knowledge of this brain region<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. By contrast, the majority of the top 20 SVGs from SPARK-X are not associated as clearly with the distinction between white matter and gray matter (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S6)</xref>.</p>
    </sec>
    <sec id="Sec7">
      <title>nnSVG in application to mouse brain olfactory bulb</title>
      <p id="Par21">The second dataset we considered is the ST mouse OB dataset<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>. This dataset contains a smaller set of spatial locations at lower spatial resolution, which have been annotated with cell type layer labels<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup> (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7A)</xref>. Similar to the Visium human DLPFC data, we observe variation in the estimated gene-specific length scale parameters from nnSVG (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7B)</xref>, suggesting the need for flexibility in this parameter. We considered 7 known layer-associated SVGs<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, and found that HVGs identified all 7 genes within the top 200 ranked SVGs, while nnSVG, Moran’s I, and SPARK-X identified 5, 3, and 1 out of the 7 genes within the top 200 ranked SVGs, respectively (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7C)</xref>. Overall, nnSVG identified 559 genes as statistically significant SVGs (out of 4216 genes that passed filtering) at an adjusted <italic>p</italic>-value threshold of 0.05 (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7D)</xref>, while SPARK-X identified 2270 (out of 4216) significant SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7E)</xref>. When comparing the top 1000 ranked genes between nnSVG and the baseline methods (HVGs and Moran’s I), we found a higher correlation (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7F)</xref> than when using SPARK-X (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7G)</xref>. Furthermore, when comparing the overlap between the sets of top <italic>n</italic> = 10, 20, 50, 100, 200 SVGs and HVGs, we found nnSVG had a higher overlap with HVGs compared to the overlap between SPARK-X and HVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7H)</xref>. This is expected as most of the biologically informative SVGs in this dataset are related to the spatial distribution of cell type layers<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup>. Finally, we also provide spatial expression plots of the top 20 SVGs from nnSVG (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S8)</xref> to illustrate that most of the top SVGs are associated with the known cell type layers, as expected.</p>
    </sec>
    <sec id="Sec8">
      <title>nnSVG in application to mouse embryo</title>
      <p id="Par22">The third dataset we considered is the seqFISH mouse embryo dataset<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>, which consists of expression measurements of 351 targeted genes summarized at single-cell resolution in a sagittal tissue section from a mouse embryo (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9A)</xref>. Similar to the other datasets, we observed a range of values for the gene-specific length scale parameters from nnSVG (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9B)</xref>. We investigated 12 known highly biologically informative SVGs<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>, and found that nnSVG gave the highest rankings for 7 of these. In addition, nnSVG, HVGs, and Moran’s I identified all 12 of these genes within the top 100 ranked genes, while SPARK-X identified only 9 out of 12 within the top 100 ranked genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9C)</xref>. Overall, both nnSVG and SPARK-X identified all 351 genes as statistically significant SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9D</xref>, <xref rid="MOESM1" ref-type="media">E)</xref>. Similar to the Visium human DLPFC dataset, we also found a relationship between the effect size (proportion of spatial variance) and the mean expression (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9F)</xref>. When comparing the ranks of the 351 genes between nnSVG or SPARK-X and the baseline methods (HVGs and Moran’s I), we found a higher correlation for nnSVG than for SPARK-X (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9G</xref>, <xref rid="MOESM1" ref-type="media">H)</xref>. Similarly, we found that nnSVG had a higher overlap than SPARK-X between the sets of top <italic>n</italic> = 10, 20, 50, 100, 200 SVGs and HVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9I)</xref>. As for the other datasets, this is expected since the biologically informative SVGs in this dataset are related to the spatial distribution of cell types at different developmental stages<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>. Finally, we also provide spatial expression plots of the top 20 SVGs from nnSVG (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S10)</xref>.</p>
    </sec>
    <sec id="Sec9">
      <title>nnSVG identifies SVGs within spatial domains</title>
      <p id="Par23">In this section, we apply nnSVG to an SRT dataset to demonstrate how our method can be used to identify SVGs within an a priori defined spatial domain by including the spatial domains as covariates within the statistical models. Specifically, we consider the Slide-seqV2 mouse hippocampus (HPC) dataset<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>, which contains separate anatomical regions from the mouse HPC and has been annotated with cell type labels by Cable et al.<sup><xref ref-type="bibr" rid="CR39">39</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2</xref>a). We highlight two previously identified SVGs (<italic>Cpne9</italic> and <italic>Rgs14</italic>) from ref. <sup><xref ref-type="bibr" rid="CR39">39</xref></sup>, which exhibit spatial gradients of expression within the CA3 region of the hippocampus (Fig. <xref rid="Fig2" ref-type="fig">2</xref>b). Here, we apply nnSVG, SPARK-X, HVGs, and Moran’s I to identify SVGs and compare their performance.<fig id="Fig2"><label>Fig. 2</label><caption><title>nnSVG recovers biologically informative SVGs within spatial domains.</title><p>Using the Slide-seqV2 mouse hippocampus (HPC) dataset<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>, nnSVG, SPARK-X, HVGs, and Moran’s I were applied to identify SVGs within an a priori defined spatial domain. <bold>a</bold> Computationally labeled cell types per spot (bead) with labels from ref. <sup><xref ref-type="bibr" rid="CR39">39</xref></sup>. <bold>b</bold> Spatial expression plots of 2 known biologically informative SVGs identified by Cable et al.<sup><xref ref-type="bibr" rid="CR39">39</xref></sup> showing spatial gradients of expression within the spatial domain defined by CA3 cell type labels (pink points in (<bold>a</bold>)). <bold>c</bold> Rank order of the 2 SVGs from (<bold>b</bold>) within the lists of top SVGs. <bold>d</bold> Estimated likelihood ratio (LR) statistic from nnSVG (<italic>y</italic>-axis) compared to the rank per gene (<italic>x</italic>-axis), with the 2 SVGs from (<bold>b</bold>) highlighted. Orange dashed vertical line indicates rank cutoff for statistically significant SVGs at a multiple-testing-adjusted <italic>p</italic>-value of 0.05 using LR test with 2 degrees of freedom.</p></caption><graphic xlink:href="41467_2023_39748_Fig2_HTML" id="d32e1504"/></fig></p>
      <p id="Par24">We found that both nnSVG and SPARK-X (which also provides the option to include covariates for spatial domains) rank the <italic>Cpne9</italic> and <italic>Rgs14</italic> genes within the top 300 genes with similar performance (Fig. <xref rid="Fig2" ref-type="fig">2</xref>c). In contrast, while Moran’s I is able to identify <italic>Rgs14</italic> within the top 300 ranked genes, HVGs does not rank <italic>Rgs14</italic> within the top 1000 ranked genes, and neither HVGs or Moran’s I rank the <italic>Cpne9</italic> gene within the top 1000 ranked genes. We note that the performance of the HVGs baseline method differs from the results in the Visium human DLPFC dataset, where HVGs performed well. We also confirmed that using default settings for SPARK-X (no filtering of low-expressed genes) did not substantially change the results for SPARK-X, although nnSVG performed somewhat worse in this case (genes ranked between top 100−500) (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S11A)</xref>. At an adjusted <italic>p</italic>-value threshold of 0.05, nnSVG identified 1024 genes as statistically significant SVGs (out of 8883 genes that passed filtering), including both <italic>Cpne9</italic> and <italic>Rgs14</italic> (Fig. <xref rid="Fig2" ref-type="fig">2</xref>d). SPARK-X identified 2053 (out of 8883) genes as significant SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S11B)</xref>, or 1809 (out of 21,011) without filtering low-expressed genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S11C)</xref>, including both <italic>Cpne9</italic> and <italic>Rgs14</italic> in both cases.</p>
      <p id="Par25">We also compared the performance of nnSVG and SPARK-X to identify SVGs across the entire tissue without incorporating any spatial domain information. This reduced performance for both methods. Both nnSVG and SPARK-X ranked <italic>Cpne9</italic> and <italic>Rgs14</italic> in approximately the top 250 to 1000 genes (compared to the top 300 genes in the models with covariates for the spatial domains) (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S11D)</xref>. In the models without covariates, nnSVG and SPARK-X identified 3217 and 4821 (out of 8883) genes, respectively as statistically significant SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S11E</xref>, <xref rid="MOESM1" ref-type="media">F)</xref>. The reduced performance when excluding the spatial domain covariates is expected, since in this case many additional expression patterns are deemed spatially variable.</p>
      <p id="Par26">In order to further evaluate performance for this dataset, we also investigated an extended list of 74 known SVGs within the CA3 spatial domain from the prior analyses<sup><xref ref-type="bibr" rid="CR39">39</xref></sup> (including <italic>Cpne9</italic> and <italic>Rgs14</italic>). We calculated how many of these 74 genes were identified within the top 1000 SVGs or HVGs by each method, which revealed that nnSVG recovered the highest number (27 out of 74), followed by SPARK-X and Moran’s I (23 out of 74), while HVGs performed poorly and recovered only 3 out of 74 genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S12)</xref>. Finally, we visualized the spatial expression of the top 20 SVGs from both nnSVG and SPARK-X (including spatial domain covariates). For both methods, the majority of these top SVGs are clearly associated with the known spatial domains, in particular the dentate, CA1, CA3, and oligodendrocyte cell type labels (Supplementary Figs. <xref rid="MOESM1" ref-type="media">S13</xref>, <xref rid="MOESM1" ref-type="media">S14)</xref>.</p>
    </sec>
    <sec id="Sec10">
      <title>nnSVG to select genes for downstream clustering</title>
      <p id="Par27">One potential application of methods to identify SVGs is to select a list of genes to use as the input for downstream clustering. Using SVGs instead of (nonspatial) HVGs for downstream clustering has been shown to improve clustering performance in SRT datasets<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>. We compared clustering performance in the Visium human DLPFC dataset using either the top 1000 SVGs (nnSVG, SPARK-X, and Moran’s I) or the top 1000 HVGs, in terms of the adjusted Rand index (which measures the similarity between two sets of cluster labels, with values between 0 and 1, where 1 indicates perfect agreement) between the clustering and the manually annotated cortical layer labels in this dataset (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S15A</xref>–<xref rid="MOESM1" ref-type="media">D)</xref>. We used graph-based clustering from standard single-cell workflows<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> and applied the clustering algorithm to the top 50 principal components (PCs) calculated on the top 1000 SVGs or HVGs. The results demonstrated that nnSVG and Moran’s I (which take spatial information into account) outperformed HVGs (nonspatial). In addition, nnSVG and Moran’s I outperformed SPARK-X, which is consistent with the main results showing that the top SVGs from nnSVG more closely reflect the biological structure in this dataset, compared to SPARK-X (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S15E)</xref>.</p>
    </sec>
    <sec id="Sec11">
      <title>Evaluating nnSVG using simulations</title>
      <p id="Par28">We developed a simulation framework to evaluate the performance of nnSVG in several ways. First, we built a dataset consisting of a set of simulated SVGs with regions of relatively high expression, surrounded by regions of background noise, across several scenarios where we varied the length scale and expression strength. We also simulated a set of noise genes without any spatial expression patterns. We obtained empirical parameters for these scenarios from the Visium human DLPFC dataset—mean and variance of log-transformed normalized expression (logcounts) for the known SVG <italic>MOBP</italic> within the highly expressed region (white matter) and low-expressed region (cortical layers), respectively, as well as proportions of sparsity (zero counts) within both regions. We simulated a total of 1000 genes, consisting of 100 SVGs and 900 noise genes. For the SVGs, we varied the length scale by simulating circular regions of elevated expression with radius 0.25, 0.125, and 0.025 times the width of the tissue section. We varied the expression strength as 1, 1/3, and 1/10 times the average difference between the regions of elevated and low expression, above background noise, for <italic>MOBP</italic>. Supplementary Fig. <xref rid="MOESM1" ref-type="media">S16A</xref> displays the spatial coordinate masks and relative expression strength for each scenario, and Supplementary Fig. <xref rid="MOESM1" ref-type="media">S16B</xref> shows the expression values (logcounts). Then, we evaluated the true positive rate (TPR) and false positive rate (FPR) for identifying the simulated subset of SVGs in each scenario. Our evaluations showed that nnSVG achieved very high TPR in all scenarios except the most difficult scenarios with small length scale and medium to low expression strength. In addition, we observed that nnSVG was conservative with respect to false positives—in the medium length scale, medium expression strength scenario (middle panel), we achieved FPR of 0.003, 0.016, and 0.031 at nominal <italic>p</italic>-value thresholds of 0.01, 0.05, and 0.1 (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S16C)</xref>.</p>
      <p id="Par29">We also developed an ablation simulation study<sup><xref ref-type="bibr" rid="CR41">41</xref></sup> to evaluate the robustness of nnSVG to increasing levels of noise. In this simulation, we extended the medium length scale, medium expression strength scenario by randomly shuffling a progressively increasing subset of spatial coordinates (0%, 10%, ..., 100%) to introduce noise into the spatial expression patterns (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S17A</xref>, <xref rid="MOESM1" ref-type="media">B)</xref>. We evaluated the TPR at each step, and found that nnSVG was highly robust to the noise—the TPR started decreasing at 70% shuffled coordinates, and eventually reached near zero by 90% shuffled coordinates (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S17C)</xref>.</p>
      <p id="Par30">Finally, we performed a set of null simulations using two datasets (Visium human DLPFC and ST mouse OB), where we permuted the order of the spatial coordinates to remove any spatial correlation structure. We observed the spikes in the distributions of the <italic>p</italic>-values near 0 were removed in the null simulations (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S18A</xref>, <xref rid="MOESM1" ref-type="media">B)</xref>, confirming that the significant <italic>p</italic>-values in the main results are due to the spatial correlation in expression. We also evaluated the proportion of false positives in the null simulations, which further confirmed that nnSVG is relatively conservative and generates a low proportion of false positives. Specifically, we evaluated the error control by calculating the proportion of false positives at a <italic>p</italic>-value cutoff of 0.05, which gave values below the nominal value of 0.05 in both null simulations (1.5% and 1.0%, respectively) (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S18C)</xref>.</p>
    </sec>
    <sec id="Sec12">
      <title>Evaluating the <italic>p</italic>-value distributions from nnSVG</title>
      <p id="Par31">Next, we investigated the <italic>p</italic>-value distributions from nnSVG for the transcriptome-wide datasets presented in this work, prior to correcting for false discoveries. If the LR test from nnSVG to assess the statistical significance of SVGs is well calibrated, we expected to see a flat, uniform distribution representing null tests for most of the distribution with a spike close to 0 representing the non-null tests. When we apply filtering to remove lowly expressed genes (default for nnSVG and the main results presented in this work), we found approximately uniform distributions of <italic>p</italic>-values with additional spikes near 0 and 1 for the three datasets Visium human DLPFC, ST mouse OB, and Slide-seqV2 mouse HPC, respectively (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S19A</xref>–<xref rid="MOESM1" ref-type="media">C)</xref>. The spike near 0 represents the subset of significant SVGs in each dataset, as expected, while the spike near 1 suggests that the <italic>p</italic>-values for non-spatially-correlated genes may be somewhat too conservative overall, giving more values near 1 than expected. In particular, we observe that the spike near 1 is much larger when running nnSVG without filtering low-expressed genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S19D</xref>–<xref rid="MOESM1" ref-type="media">F)</xref>, indicating that many of the genes with <italic>p</italic>-values near 1 are low-expressed genes. In this way, while the process of filtering lowly expressed genes can lead to some false negatives (depending on the stringency of filtering), overall, we view this filtering step as helpful as nnSVG still recovers hundreds to thousands of significant SVGs in each dataset after filtering, and the rankings of the top SVGs are relatively unaffected by the stringency of the filtering since these genes tend to be highly expressed (Fig. <xref rid="Fig1" ref-type="fig">1</xref>e).</p>
    </sec>
    <sec id="Sec13">
      <title>nnSVG scales linearly with the number of spatial locations</title>
      <p id="Par32">Here, we illustrate how the computational complexity and runtime of nnSVG scales linearly with the number of spatial locations, which is crucial for identifying SVGs in datasets with thousands or more spatial locations. To demonstrate the linear scalability of nnSVG, we generated simulations by subsampling the numbers of spots (<italic>n</italic> = 200, 500, 1000, 2000, 3639 in Visium human DLPFC, <italic>n</italic> = 1000, 2000, 5000, 10,000, 20,000, 40,000, 53,208 in Slide-seqV2 mouse HPC, where the maximum number in each case is the full number of spots available in the dataset, including low-quality and unannotated spots). We ran nnSVG 10 times for a single gene at each number of spots using a single processor core and recorded runtimes, demonstrating a clear linear trend in the runtimes (Fig. <xref rid="Fig3" ref-type="fig">3</xref>a, b). We also compared the scalability of nnSVG for the Slide-seqV2 mouse HPC dataset with and without covariates for spatial domains included, and observed only a minimal increase in runtimes with covariates included (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S20A</xref>, <xref rid="MOESM1" ref-type="media">B)</xref>. Next, we compared the scalability of both nnSVG and SPARK-X against the earlier cubically scaling methods, SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR42">42</xref></sup> and SPARK<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>, by subsampling spots from the Visium human DLPFC dataset and running each method 10 times for two genes (SPARK and SPARK-X require at least two genes to run without error) using a single core, which clearly demonstrated the cubic scaling of SpatialDE and SPARK (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S20C)</xref>.<fig id="Fig3"><label>Fig. 3</label><caption><title>nnSVG scales linearly with the number of spatial locations.</title><p>The runtime in seconds (<italic>y</italic>-axis) of nnSVG on a single gene (run <italic>n</italic> = 10 times on a single processor core) using downsampled numbers of spots (<italic>x</italic>-axis) with two transcriptome-wide datasets, <bold>a</bold> Visium human DLPFC and <bold>b</bold> Slide-seqV2 mouse HPC, without quality control or filtering of spots. The dashed lines represent linear trends in scalability for each dataset. Boxplots show medians, first and third quartiles, and whiskers extending to the furthest values no more than 1.5 times the interquartile range from each quartile.</p></caption><graphic xlink:href="41467_2023_39748_Fig3_HTML" id="d32e1772"/></fig></p>
      <p id="Par33">Finally, we recorded runtimes for each of the three transcriptome-wide SRT datasets presented in this work (while filtering for lowly expressed genes) using both nnSVG and SPARK-X. We recorded runtimes of 520 s, 2788 s (46 min), and 18,642 s (5 h) for nnSVG for the 3 datasets (ST mouse OB, Visium human DLPFC, Slide-seqV2 mouse HPC), which contained 260, 3582, and 15,003 spots, respectively (after quality control and retaining annotated spots only). This compared to 11, 34, and 119 s for SPARK-X, respectively (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S20D)</xref>. We used 10 processor cores on a high-performance compute cluster for all datasets for nnSVG and the Slide-seqV2 mouse HPC dataset for SPARK-X, and 1 core for the ST mouse OB and Visium human DLPFC datasets for SPARK-X due to the higher efficiency of SPARK-X.</p>
    </sec>
    <sec id="Sec14">
      <title>Deviance residuals from binomial model for baseline method and preprocessing</title>
      <p id="Par34">As an alternative nonspatial baseline instead of HVGs, we also considered deviance residuals from a binomial model, which has been shown to give an improved ranking of genes in the context of scRNA-seq data and is more theoretically justified due to the use of a count-based model<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>. We evaluated the binomial deviance residuals baseline by comparing the rank order of the selected SVGs in the main results against HVGs for each dataset, and found that while the individual rankings changed for some genes, in particular <italic>NPY</italic> in the Visium human DLPFC dataset and <italic>Rgs14</italic> in the Slide-seqV2 mouse HPC dataset, the overall performance and relative ranking of methods was similar to HVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S21)</xref>.</p>
      <p id="Par35">We also evaluated the results from nnSVG using deviance residuals from a binomial model for preprocessing, instead of log-transformed normalized counts (logcounts) for preprocessing<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> used in the main results, which has been shown to give improved performance in the context of scRNA-seq data<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>. We compared the rank order of the selected SVGs from nnSVG using the two preprocessing methods for each dataset, and found that the overall ranking of methods was similar (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S22)</xref>.</p>
    </sec>
    <sec id="Sec15">
      <title>Applying nnSVG to datasets with multiple samples</title>
      <p id="Par36">The nnSVG model has been developed for data from one sample (tissue section) at a time. To evaluate the stability of the rankings of SVGs obtained from multiple samples, we applied nnSVG to each of the additional samples available in the original source for the Visium human DLPFC dataset (12 samples from 3 donors)<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR43">43</xref></sup>. We calculated the Spearman correlation between the rankings from each pair of samples and found that these correlations were relatively high (&gt; 0.8) between samples within donors 1 and 3, respectively, moderate (&gt; 0.75) between samples between donors 1 and 3, and lower within donor 2 and between donor 2 and the other donors (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S23A)</xref>. This reflects the known biological structure from prior analyses of this dataset<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, which found that the samples from donors 1 and 3 had all cortical layers present, while the samples from donor 2 were missing several cortical layers (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S23B</xref>; donors in rows). We also visualized the rank comparisons for the samples with the highest and lowest correlations with sample 151673 (the sample used in the main results) (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S23C</xref>, <xref rid="MOESM1" ref-type="media">D)</xref> to further demonstrate these results.</p>
      <p id="Par37">In order to apply nnSVG to datasets with multiple samples in practice, we have also developed an approach based on averaging the ranks of the SVGs identified within each sample, which has been successfully applied in a new dataset<sup><xref ref-type="bibr" rid="CR44">44</xref></sup> and is described in detail in the package documentation (vignette).</p>
    </sec>
  </sec>
  <sec id="Sec16" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par38">We have introduced nnSVG, a method to identify spatially variable genes (SVGs) in SRT data based on statistical advances in computationally scalable parameter estimation in spatial covariance functions in Gaussian processes using nearest-neighbor Gaussian process (NNGP) models<sup><xref ref-type="bibr" rid="CR30">30</xref>,<xref ref-type="bibr" rid="CR31">31</xref></sup>. In summary, our method (i) identifies genes that vary in expression continuously across the entire tissue or within a priori defined spatial domains, (ii) uses gene-specific estimates of length scale parameters within the Gaussian process models, and (iii) scales linearly with the number of spatial locations (Table <xref rid="Tab1" ref-type="table">1</xref>). We have demonstrated the importance of fitting gene-specific length scale parameters within the GP models in application of SRT datasets to identify genes with different spatial ranges in their expression patterns within the tissue of interest. The linear scalability aspect is crucial for current technological platforms with thousands of spatial locations per tissue sample and for emerging platforms at even higher resolutions, such as 10x Genomics Visium HD. Compared to existing methods, while the runtime for SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> is fast, this method fits a fixed combination of covariance functions and length scale parameters across all genes, thereby leading to reduced flexibility to identify SVGs with different spatial ranges in expression. While earlier methods such as SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup> fit gene-specific length scale parameters, these do not scale linearly with the number of spatial locations. The importance of fitting gene-specific length scale parameters is likely to represent a general finding for the analysis of SRT datasets, with applicability beyond the specific modeling approach used here.<table-wrap id="Tab1"><label>Table 1</label><caption><p>Summary of characteristics of methods included in the performance evaluations and runtime comparisons</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Method</th><th>Spatial information</th><th>Flexible length scale parameters</th><th>Covariates for spatial domains</th><th>Runtime</th></tr></thead><tbody><tr><td>nnSVG</td><td>●</td><td>●</td><td>●</td><td>◐</td></tr><tr><td>SPARK-X</td><td>●</td><td>○</td><td>●</td><td>●</td></tr><tr><td>HVGs</td><td>○</td><td>○</td><td>○</td><td>●</td></tr><tr><td>Moran’s I</td><td>●</td><td>○</td><td>○</td><td>◐</td></tr><tr><td>SpatialDE</td><td>●</td><td>●</td><td>●</td><td>○</td></tr><tr><td>SPARK</td><td>●</td><td>●</td><td>●</td><td>○</td></tr></tbody></table><table-wrap-foot><p>For each method, the columns indicate whether (●) or not (○) the method: (i) takes spatial information into account, (ii) fits models with flexible gene-specific length scale parameters, (iii) provides an option to include covariates for spatial domains in the models, and (iv) provides fast runtimes. Half-filled circles (◐) indicate intermediate scores. The scalable methods are shown in the first 4 rows, and the earlier cubically scaling methods (SpatialDE and SPARK) are shown in the last 2 rows.</p></table-wrap-foot></table-wrap></p>
    <p id="Par39">Furthermore, unlike previous studies introducing methods to identify SVGs<sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR27">27</xref></sup>, we comprehensively evaluated our method against baseline methods. We compared against HVGs, deviance residuals from a binomial model<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>, and Moran’s I statistic<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>, representing both nonspatial and spatial baseline methods, to assess the advantage in terms of performance of applying our more statistically sophisticated (and more computationally intensive) approach instead of relying on simpler baseline methods. We demonstrated the degree of overlap between the nonspatial HVGs and nnSVG in each dataset, with a higher overlap expected in datasets where the biologically informative SVGs are largely related to spatial distributions of cell types. In general, our baseline comparisons demonstrate that HVGs provides excellent performance and computational efficiency in many datasets (despite not using the spatial information directly), especially where the spatial expression patterns are largely due to spatially distributed cell types—while nnSVG provides further improved performance in certain datasets with more complex expression patterns at higher computational cost.</p>
    <p id="Par40">We envision two types of primary applications of nnSVG. First, nnSVG can be used to generate lists of top SVGs during exploratory unsupervised analyses of SRT datasets, with the aim of detecting possible markers of biological processes of interest for further experimental validation. For example, ref. <sup><xref ref-type="bibr" rid="CR8">8</xref></sup> applied this strategy using SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, using extensive computational resources due to the cubic scaling of this method<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. These analyses are more feasible with nnSVG than with existing scalable methods (e.g., SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>), since nnSVG fits a gene-specific length scale parameter while also achieving linear computational scalability. For these types of analyses, the user can either select an arbitrary set of top-ranked SVGs (e.g., top 100 genes) or select a set of statistically significant SVGs with adjusted <italic>p</italic>-values from the LR test.</p>
    <p id="Par41">The second application of nnSVG is to use the set of top-ranked SVGs as the input for further downstream analyses, such as spatially-aware unsupervised clustering, for example<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR14">14</xref></sup>, or registering the spatial locations of scRNA-seq data<sup><xref ref-type="bibr" rid="CR11">11</xref>,<xref ref-type="bibr" rid="CR15">15</xref>,<xref ref-type="bibr" rid="CR16">16</xref></sup>. This type of analysis is analogous to standard workflows for scRNA-seq analyses<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>. In spatial data, we can modify this workflow by replacing the set of top HVGs with the set of top SVGs from nnSVG, and then perform unsupervised clustering on the set of top SVGs. Since the set of SVGs has been generated by methodology that takes spatial information into account, this gives a spatially-aware clustering of cell populations<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR40">40</xref></sup>. Our results demonstrated improved performance compared to using (nonspatial) HVGs for clustering, consistent with previous results<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>.</p>
    <p id="Par42">Our method has some limitations, and we have identified several open directions for future work to extend our approach. First, while our method scales linearly with the number of spatial locations, the computational requirements remain nontrivial. For transcriptome-wide datasets with ≥10,000 spatial locations, runtimes are on the order of several hours when using 10 processor cores on a high-performance compute cluster. Since runtime depends on the number of genes, this can be reduced with more stringent gene filtering. In addition, our implementation is parallelized, allowing the user to select more cores if available, which will reduce runtimes. Future work could aim to further improve runtimes for large datasets, for example using low-rank statistical models that smooth the data into a smaller number of knots or inducing points representing the spatial locations, or further computational optimizations. Second, we observe some small negative values in the estimated LR statistics, which are difficult to interpret. Since this occurs mainly for lower-ranked genes, this does not affect the rankings in the sets of top-ranked SVGs. This could be improved by developing adaptive filtering thresholds that carefully remove low-expressed genes, which could also improve the calibration of <italic>p</italic>-values for low-expressed genes. Similarly, constraints could be placed on low values of the estimated length scale parameter within the models, although we found that these were generally low-expressed genes that were either filtered out or were not ranked as top SVGs. Third, while nnSVG identifies individual SVGs, we have not grouped these into gene groups or metagenes. Future work could develop added functionality to group genes into biologically interpretable metagenes in an unsupervised manner, similar to refs. <sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR27">27</xref></sup>. Fourth, our model has been developed for a single sample (tissue section) at a time. While we have implemented a practical approach to apply nnSVG to multiple-sample datasets based on averaging the ranks of the SVGs identified within each sample, future work could focus on developing a principled statistical approach for multiple-sample datasets, for example by jointly estimating parameters across multiple samples to improve power and robustness. Finally, while we calculate an effect size defined as the proportion of spatial variance (similar to ref. <sup><xref ref-type="bibr" rid="CR12">12</xref></sup>), this definition does not distinguish between technical and biological variance, in contrast to standard effect size definitions in scRNA-seq workflows<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S24)</xref>. Future work could aim to define a modified effect size that decomposes total variance into technical and biological components as well as spatial and nonspatial components, e.g., using a concept of biological spatial variance, which would aid in the interpretation of top-ranked SVGs.</p>
    <p id="Par43">Our method is implemented as an R package within the Bioconductor framework<sup><xref ref-type="bibr" rid="CR34">34</xref></sup>, and is freely available from Bioconductor at <ext-link ext-link-type="uri" xlink:href="https://bioconductor.org/packages/nnSVG">https://bioconductor.org/packages/nnSVG</ext-link>.</p>
  </sec>
  <sec id="Sec17">
    <title>Methods</title>
    <sec id="Sec18">
      <title>Preprocessing</title>
      <p id="Par44">The nnSVG workflow begins with preprocessing steps. For the analyses in this manuscript, we applied standard quality control (QC) to each dataset to filter out low-quality spatial locations (spots), using functions to calculate QC metrics implemented in the scater<sup><xref ref-type="bibr" rid="CR45">45</xref></sup> R/Bioconductor package. The thresholds we used for each QC metric can be found in our code repository (see “Code availability”).</p>
      <p id="Par45">Next, we filter out low-expressed genes and mitochondrial genes. Low-expressed genes are assumed to largely represent noise and to be unlikely to provide significant biological information about spatially-resolved biological processes, so removing them improves computational performance while preserving most of the information. For the analyses in this manuscript, we used the following filtering thresholds. For the Visium human DLPFC dataset, we retained genes with at least 3 unique molecular identifier (UMI) counts in at least 0.5 percent of spatial locations. For the Slide-seqV2 mouse HPC dataset, we retained genes with at least 1 UMI count in at least 1 percent of spatial locations. For the ST mouse OB dataset, we retained genes with at least 5 UMI counts in at least 1 percent of spatial locations. For the seqFISH mouse embryo dataset, no filtering was needed, as this dataset contains a smaller set of targeted genes. By contrast, mitochondrial genes are observed to be very highly expressed in most single-cell datasets, but their expression is generally not considered to be informative for distinguishing cell populations or states, so removing them reduces noise<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>. For the analyses in this manuscript, we removed mitochondrial genes from all datasets. The nnSVG package provides a filtering function for both low-expressed and mitochondrial genes, with default values appropriate for the 10x Genomics Visium platform, which can also be adjusted or disabled by the user.</p>
      <p id="Par46">Next, we normalize and transform the raw UMI counts using the log-transformed normalized counts methodology (also referred to as logcounts) using library size factors implemented in the scran, scuttle, and scater R/Bioconductor packages<sup><xref ref-type="bibr" rid="CR45">45</xref>,<xref ref-type="bibr" rid="CR46">46</xref></sup>. Normalization reduces technical biases between measurements from different spots, while log-transformation transforms the counts to a continuous and approximately normally distributed scale, allowing the NNGP models to be fitted. As an alternative to logcounts, we also demonstrate the use of the binomial deviance residuals methodology implemented in the scry R/Bioconductor package<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>, which has been shown to give improved performance in scRNA-seq data<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>.</p>
    </sec>
    <sec id="Sec19">
      <title>nnSVG model and parameters</title>
      <p id="Par47">In the nnSVG methodology, we assume that the input data consists of preprocessed gene expression measurements for thousands of genes at a set of spatial locations on a tissue slide, with the spatial locations typically also numbering in the thousands. The core of the nnSVG methodology consists of fitting a nearest-neighbor Gaussian process (NNGP) model<sup><xref ref-type="bibr" rid="CR30">30</xref>,<xref ref-type="bibr" rid="CR31">31</xref></sup> to the preprocessed expression measurements for each gene, i.e., one model per gene. This model is defined as:<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\bf{y}}}}}}}} \sim N({{{{{{{\bf{X}}}}}}}}{{{{{{{\boldsymbol{\beta }}}}}}}},{{{\widetilde{{{{{\boldsymbol{{{\Sigma }}}}}}}}}}}({{{{{{{\boldsymbol{\theta }}}}}}}},{\tau }^{2}))$$\end{document}</tex-math><mml:math id="M12"><mml:mi mathvariant="bold">y</mml:mi><mml:mo>~</mml:mo><mml:mi>N</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">X</mml:mi><mml:mi mathvariant="bold-italic">β</mml:mi><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">Σ</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par48">Here, <bold>y</bold> = (<italic>y</italic><sub>1</sub>, …, <italic>y</italic><sub><italic>N</italic></sub>) represents a vector of normalized and transformed expression values for gene <italic>g</italic> (omitting the index <italic>g</italic> = 1, . . . , <italic>G</italic> for simplicity) at a set of spatial locations <bold>s</bold> = (<bold>s</bold><sub><bold>1</bold></sub>, …, <bold>s</bold><sub><bold>N</bold></sub>). The spatial locations are assumed to be two-dimensional, but may in principle be generalized to higher dimensions. The <inline-formula id="IEq4"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{\widetilde{{{{{\boldsymbol{{{\Sigma }}}}}}}}}}}({{{{{{{\boldsymbol{\theta }}}}}}}},{\tau }^{2})$$\end{document}</tex-math><mml:math id="M14"><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">Σ</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2023_39748_Article_IEq4.gif"/></alternatives></inline-formula> term represents the NNGP covariance matrix, which provides a scalable (in linear-time and storage) approximation to the covariance matrix <bold>Σ</bold>(<bold><italic>θ</italic></bold>, <italic>τ</italic><sup>2</sup>) = <italic>C</italic>(<bold><italic>θ</italic></bold>) + <italic>τ</italic><sup>2</sup><bold>I</bold> from a full GP model, which scales cubically in the number of spatial locations. The GP covariance matrix <italic>C</italic>(<bold><italic>θ</italic></bold>) = (<italic>C</italic><sub><italic>i</italic><italic>j</italic></sub>(<bold><italic>θ</italic></bold>)) (also referred to as a kernel) captures the spatially correlated variation and is parameterized by a vector of parameters <bold><italic>θ</italic></bold>. We assume an exponential covariance function, based on the observation that the widely used squared exponential function (e.g., used previously in SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>) decays too rapidly with distance in the context of SRT data<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>. The exponential covariance function (or kernel) is defined as:<disp-formula id="Equ4"><label>4</label><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${C}_{ij}({{{{{{{\boldsymbol{\theta }}}}}}}})=k({{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{i}}}}}}}}},{{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{j}}}}}}}}})={\sigma }^{2}\exp \left(\frac{-||{{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{i}}}}}}}}}-{{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{j}}}}}}}}}||}{l}\right)$$\end{document}</tex-math><mml:math id="M16"><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>k</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mi>exp</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mfrac><mml:mrow><mml:mo>−</mml:mo><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ4.gif" position="anchor"/></alternatives></disp-formula>with covariance parameters <bold><italic>θ</italic></bold> = (<italic>σ</italic><sup>2</sup>, <italic>l</italic>), and where ∣∣<bold>s</bold><sub><bold>i</bold></sub> − <bold>s</bold><sub><bold>j</bold></sub>∣∣ represents the Euclidean distance between two spatial locations <bold>s</bold><sub><bold>i</bold></sub> and <bold>s</bold><sub><bold>j</bold></sub>. In this parameterization, <italic>σ</italic><sup>2</sup> represents the spatial component of variance, and <italic>l</italic> is referred to as the length scale (or bandwidth) parameter, which controls the strength of decay of correlation with distance. The final parameter <italic>τ</italic><sup>2</sup> in equation (3) is referred to as the nugget, which represents the additional nonspatial component of variance.</p>
      <p id="Par49">Alternatively, the Gaussian process model <bold>y</bold> ~ <italic>N</italic>(<bold>X</bold><bold><italic>β</italic></bold>, <italic>C</italic>(<bold><italic>θ</italic></bold>) + <italic>τ</italic><sup>2</sup><bold>I</bold>) may also be written as:<disp-formula id="Equ5"><label>5</label><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$y({{{{{{{\bf{s}}}}}}}})={m}_{{{{{{{{\boldsymbol{\theta }}}}}}}}}({{{{{{{\bf{s}}}}}}}})+w({{{{{{{\bf{s}}}}}}}})+\epsilon ({{{{{{{\bf{s}}}}}}}}),\qquad \epsilon ({{{{{{{\bf{s}}}}}}}}) \mathop{\sim} \limits^{iid} N \left(0,{\tau }^{2}\right)$$\end{document}</tex-math><mml:math id="M18"><mml:mi>y</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mi>w</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mi>ϵ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mspace width="2.0em"/><mml:mi>ϵ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mover accent="true"><mml:mrow><mml:mo>~</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>i</mml:mi><mml:mi>d</mml:mi></mml:mrow></mml:mover><mml:mi>N</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ5.gif" position="anchor"/></alternatives></disp-formula>where <italic>w</italic>(<bold>s</bold>) follows a Gaussian process, <italic>w</italic>(<bold>s</bold>) ~ <italic>G</italic><italic>P</italic>(0, <italic>C</italic><sub><bold><italic>θ</italic></bold></sub>(. , . )), and <italic>m</italic><sub><bold><italic>θ</italic></bold></sub>(<bold>s</bold>) = <bold>x</bold>(<bold>s</bold>)<sup>T</sup><bold><italic>β</italic></bold>.</p>
      <p id="Par50">In most applications of nnSVG, we assume an intercept-only model, where <bold>X</bold> = <bold>X</bold><sub>[<italic>N</italic>×1]</sub> = <bold>1</bold><sub>[<italic>N</italic>×1]</sub> and <bold><italic>β</italic></bold> accounts for the mean expression level. In this case, we are interested in identifying genes with any statistically significant spatial correlation in expression.</p>
      <p id="Par51">However, in some datasets, we are also interested in identifying SVGs within spatial domains, i.e., regions of the tissue slide corresponding to anatomical features or tissue types, which have been defined a priori, for example using morphology from histology images, or alternatively using unsupervised clustering. The nnSVG methodology facilitates these types of analyses by allowing the user to provide <bold>X</bold> as an <bold>X</bold><sub>[<italic>N</italic>×<italic>d</italic>]</sub> design matrix containing up to <italic>d</italic> − 1 covariates, with covariate columns consisting of indicator variables for the spatial domains at each spatial location, or other known values per spatial location.</p>
      <p id="Par52">Our key parameter of interest in the model is <italic>σ</italic><sup>2</sup>. We perform model fitting and parameter estimation using the fast optimization algorithms for NNGP models implemented in the BRISC R package<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>, which we use to obtain maximum likelihood parameter estimates for the covariance parameters <bold><italic>θ</italic></bold> = (<italic>σ</italic><sup>2</sup>, <italic>l</italic>) and <italic>τ</italic><sup>2</sup>, as well as the log-likelihoods of the fitted models. The computational complexity of the model fitting is <inline-formula id="IEq5"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\mathcal{O}}}}}}}}(n*{m}^{3})$$\end{document}</tex-math><mml:math id="M20"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">O</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>*</mml:mo><mml:msup><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2023_39748_Article_IEq5.gif"/></alternatives></inline-formula>, where <italic>n</italic> = number of spatial locations, <italic>m</italic> = number of nearest neighbors, and the initial steps of ordering coordinates and calculating nearest neighbors are performed once only and are re-used for all genes. Note that BRISC also provides the option to obtain precise bootstrap estimates for the parameter estimates, which we do not use here, due to the computational tradeoff when fitting thousands of models (one model per gene) for SRT data.</p>
      <p id="Par53">Within the BRISC algorithm<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>, we use the parameter choices order = “AMMD” (approximate maximum minimum distance ordering of coordinates, see ref. <sup><xref ref-type="bibr" rid="CR47">47</xref></sup> for details) and n.neighbors = 10 (10 nearest neighbors, which has been shown to retain a large proportion of information<sup><xref ref-type="bibr" rid="CR30">30</xref></sup>) as default values, while also allowing the user to adjust these choices. Additional details are provided in the nnSVG and BRISC package documentation.</p>
      <p id="Par54">Next, we perform inference on the estimated <italic>σ</italic><sup>2</sup> parameters per gene, where we test <italic>H</italic><sub>0</sub>: <italic>σ</italic><sup>2</sup> = 0 vs. <italic>H</italic><sub>1</sub>: <italic>σ</italic><sup>2</sup> &gt; 0. We use a likelihood ratio test (LR) for the inference, where we compare the log-likelihood of the fitted model against a classical linear model that assumes <italic>σ</italic><sup>2</sup> = 0 and hence does not account for spatial correlation in the data. We use the estimated LR statistics to generate an overall ranking of SVGs in terms of the strength of their spatial expression patterns. We also calculate approximate <italic>p</italic>-values for statistical significance per gene using an asymptotic <italic>χ</italic><sup>2</sup> distribution with two degrees of freedom (since there are 2 fewer parameters, <bold><italic>θ</italic></bold> = (<italic>σ</italic><sup>2</sup>, <italic>l</italic>) in the simpler model) and apply the Benjamini-Hochberg method<sup><xref ref-type="bibr" rid="CR48">48</xref></sup> to adjust the <italic>p</italic>-values for multiple testing across genes. The user can then select either (i) an arbitrary number of top-ranked SVGs (e.g., top 100 or 1000) for further investigation or to use as the input for downstream analysis methods, analogous to scRNA-seq workflows<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, or (ii) a set of statistically significant SVGs by applying a threshold (e.g., 0.05) to the multiple testing adjusted <italic>p</italic>-values.</p>
      <p id="Par55">Since the nnSVG methodology fits a separate model for each gene, the length scale parameter <italic>l</italic> is estimated individually per gene. This flexibility is the most important reason explaining the improved performance of nnSVG compared to other scalable methods, since the gene-specific length scale parameter allows nnSVG to identify SVGs from distinct biological processes with different spatial ranges in expression within the same tissue slide.</p>
      <p id="Par56">Finally, we also calculate an estimated effect size per gene, defined as the proportion of spatial variance (out of total variance), i.e., the proportion of variance explained by spatial dependencies, as previously defined by ref. <sup><xref ref-type="bibr" rid="CR12">12</xref></sup>:<disp-formula id="Equ6"><label>6</label><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\rm{propSV}}}}}}}}=\frac{{\sigma }^{2}}{{\sigma }^{2}+{\tau }^{2}}$$\end{document}</tex-math><mml:math id="M22"><mml:mi mathvariant="normal">propSV</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msup><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ6.gif" position="anchor"/></alternatives></disp-formula></p>
    </sec>
    <sec id="Sec20">
      <title>Computational implementation</title>
      <p id="Par57">nnSVG is implemented as an R package within the Bioconductor<sup><xref ref-type="bibr" rid="CR34">34</xref></sup> framework, using the BRISC R package<sup><xref ref-type="bibr" rid="CR32">32</xref></sup> for model fitting and parameter estimation, and the BiocParallel R package<sup><xref ref-type="bibr" rid="CR49">49</xref></sup> for parallelization. We extended the BRISC package (version 1.0.4) to apply these methods to SRT data, in particular, to extract the fitted log-likelihoods (for the LR tests) and to improve runtime when fitting thousands of models (one per gene) by re-using the ordering of spatial coordinates and calculating nearest neighbors.</p>
      <p id="Par58">The nnSVG package re-uses existing infrastructure for scRNA-seq and SRT data within the Bioconductor framework<sup><xref ref-type="bibr" rid="CR17">17</xref>,<xref ref-type="bibr" rid="CR35">35</xref></sup>, e.g., the SpatialExperiment object structure<sup><xref ref-type="bibr" rid="CR35">35</xref></sup> to load input data and store results, which streamlines integration into existing Bioconductor-based analysis workflows.</p>
    </sec>
    <sec id="Sec21">
      <title>Visium human DLPFC dataset</title>
      <p id="Par59">The Visium human DLPFC dataset consists of a single sample of human brain tissue from the dorsolateral prefrontal cortex (DLPFC) region, measured with the 10x Genomics Visium platform<sup><xref ref-type="bibr" rid="CR50">50</xref></sup>. This dataset was published by Maynard et al.<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> and previously released through the spatialLIBD R/Bioconductor package<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>. The Visium platform measures transcriptome-wide gene expression at a hexagonal grid of spatial locations (referred to as spots) on a tissue slide, with overall dimensions 6.5 mm × 6.5 mm, spots 55 μm in diameter, and 100 μm between spot centers<sup><xref ref-type="bibr" rid="CR50">50</xref></sup>. The dataset used here consists of one biological sample (sample 151673) from one donor, out of the 12 samples (3 donors) in the original study by Maynard et al.<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. This sample contains transcriptome-wide gene expression measurements at 3639 spots overlapping with the tissue area. We use all 12 samples for the additional multiple-sample analyses. In the original study, spots were manually annotated with labels for the six cortical layers and white matter<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, which we use as approximate ground truth labels for method evaluation.</p>
    </sec>
    <sec id="Sec22">
      <title>Slide-seqV2 mouse HPC dataset</title>
      <p id="Par60">The Slide-seqV2 mouse HPC dataset consists of gene expression measurements in a tissue sample from the mouse hippocampus (HPC), measured with the Slide-seqV2<sup><xref ref-type="bibr" rid="CR4">4</xref></sup> platform and published by Stickels et al.<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>. Spot-level annotations for cell types were generated computationally by Cable et al.<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>, which we use here to define spatial domains representing anatomical regions within the hippocampus (in particular the region defined by CA3 cell type labels). This dataset consists of a total of 53,208 spatial locations (referred to as beads for this platform), 15,003 of which have been annotated with cell type labels by Cable et al.<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>. In the analyses of this dataset, we are especially interested in genes with spatial gradients of expression within the CA3 region of the hippocampus, which have previously been identified by Cable et al.<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>.</p>
    </sec>
    <sec id="Sec23">
      <title>ST mouse OB dataset</title>
      <p id="Par61">The ST mouse OB dataset was generated by Ståhl et al.<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, consisting of gene expression measurements in the olfactory bulb (OB) region of the mouse brain. This technological platform (Spatial Transcriptomics) was subsequently further developed (e.g., to increase resolution and simplify experimental procedures) by 10x Genomics as the Visium platform. Therefore, ST represents an earlier iteration of the 10x Genomics Visium platform. The ST mouse OB dataset consists of transcriptome-wide gene expression measurements at 260 spatial locations (referred to as spots) after quality control filtering, from a single sample from the original study<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, and has previously been re-analyzed in several studies including<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>.</p>
    </sec>
    <sec id="Sec24">
      <title>seqFISH mouse embryo dataset</title>
      <p id="Par62">The seqFISH mouse embryo dataset consists of expression measurements of 351 targeted genes within a sagittal tissue section of a mouse embryo from a study investigating mouse organogenesis<sup><xref ref-type="bibr" rid="CR38">38</xref></sup> using the seqFISH platform<sup><xref ref-type="bibr" rid="CR33">33</xref></sup>. The seqFISH platform is a molecule-based SRT platform, which allows individual mRNA molecules to be identified at sub-cellular resolution. In the subset of the data used here, these measurements are summarized at single-cell resolution. The data used here consists of the cells from a single embryo and section (embryo 1, z-slice 2) from the original study<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>.</p>
    </sec>
    <sec id="Sec25">
      <title>Baseline methods</title>
      <p id="Par63">We compared performance against the following baseline methods: (i) highly variable genes (HVGs)<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, (ii) deviance residuals under a binomial model<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>, and (iii) Moran’s I statistic<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>.</p>
      <p id="Par64">HVGs are widely used in scRNA-seq analysis workflows, with implementations provided in the Bioconductor<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, Seurat<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>, and Scanpy<sup><xref ref-type="bibr" rid="CR19">19</xref></sup> frameworks. Here, we used the standard definition of HVGs from ref. <sup><xref ref-type="bibr" rid="CR17">17</xref></sup> implemented in the modelGeneVar() function in the scran R/Bioconductor package<sup><xref ref-type="bibr" rid="CR46">46</xref></sup>. In this definition, the HVGs methodology fits a mean-variance trend to the log-transformed normalized expression values (logcounts) per gene and ranks genes by excess biological variation, defined as the excess variance above the trend for each gene, under the assumption that the trend represents technical variance<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>. To apply HVGs to SRT data, we calculate the gene-specific means and variances by treating each spot as equivalent to a cell. This method does not make use of any spatial information.</p>
      <p id="Par65">The deviance residuals methodology assumes a binomial model (i.e., count-based instead of log-transforming to continuous values) and ranks genes by the deviance residuals from the fitted binomial models<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>. Compared to HVGs, this approach has been shown to give an improved ranking of genes in scRNA-seq data, and is more theoretically justified due to the use of a count-based model<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>. We apply this method to SRT data by treating each spot as equivalent to a cell. As for HVGs, this method does not make use of any spatial information.</p>
      <p id="Par66">Moran’s I statistic<sup><xref ref-type="bibr" rid="CR21">21</xref></sup> is a standard statistical measure of spatial autocorrelation, which can be calculated from the log-transformed normalized expression values for each gene. Values range from +1 (perfect spatial correlation) to 0 (no spatial correlation) to −1 (perfect spatial anticorrelation). In SRT data, the values for most genes are between 0 and 1, and negative values usually do not have a clear biological meaning. We use Moran’s I statistic to rank genes as SVGs, with the highest values (close to +1) representing the top-ranked SVGs. The Moran’s I formula requires an assumed weights matrix, which we calculate as the inverse squared Euclidean distances between spots, which is consistent with implementations provided in the Seurat workflow<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> and in the 10x Genomics Space Ranger/Loupe software (which also includes truncation at 36 neighbors)<sup><xref ref-type="bibr" rid="CR51">51</xref></sup>. We use the Rfast2 R package<sup><xref ref-type="bibr" rid="CR52">52</xref></sup> to calculate the Moran’s I statistic values.</p>
    </sec>
    <sec id="Sec26">
      <title>Reporting summary</title>
      <p id="Par67">Further information on research design is available in the <xref rid="MOESM3" ref-type="media">Nature Portfolio Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec27">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41467_2023_39748_MOESM1_ESM.pdf">
            <caption>
              <p>Supplementary Information</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="41467_2023_39748_MOESM2_ESM.pdf">
            <caption>
              <p>Peer review file</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="41467_2023_39748_MOESM3_ESM.pdf">
            <caption>
              <p>Reporting Summary</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <sec>
    <title>Supplementary information</title>
    <p>The online version contains supplementary material available at 10.1038/s41467-023-39748-z.</p>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank our collaborators at the Lieber Institute for Brain Development for input and feedback on the application of methods to identify SVGs in SRT data and ongoing collaborations which generated the ideas for the methods developed in this manuscript. We also thank the maintainers of the Joint High Performance Computing Exchange (JHPCE) compute cluster at Johns Hopkins Bloomberg School of Public Health for providing essential computing resources. Research reported in this publication was supported by the National Institute of Mental Health (NIMH) of the National Institutes of Health (NIH) under the award number U01MH122849 (S.C.H., L.M.W.), the National Human Genome Research Institute (NHGRI) of the NIH under the award number K99HG012229 (L.M.W.), the National Institute of Environmental Health Sciences (NIEHS) of the NIH under the award R01ES033739 (A.D.), National Science Foundation Division of Mathematical Sciences grant DMS-1915803 (A.D.), and CZF2019-002443 and CZF2018-183446 (S.C.H., K.D.H.) from the Chan Zuckerberg Initiative DAF, an advised fund of Silicon Valley Community Foundation.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>L.M.W. developed the nnSVG methodological framework using BRISC and LR tests for SRT data, implemented the nnSVG software package, performed analyses, created figures, and drafted text. A.S. extended the BRISC software package for use within the nnSVG framework, and provided input on the methodological framework, software implementation, and text. A.D. provided advice on the application of NNGP models to SRT data, and provided input on the methodological framework and text. K.D.H. provided input on the methodological framework, software implementation, analyses, figures, and text. S.C.H. supervised the project; provided input on the methodological framework, software implementation, analyses, figures, and text; and drafted text. All authors approved the final manuscript.</p>
  </notes>
  <notes notes-type="peer-review">
    <title>Peer review</title>
    <sec id="FPar1">
      <title>Peer review information</title>
      <p id="Par68"><italic>Nature Communications</italic> thanks Lu Zhang, Alma Andersson and the other, anonymous, reviewer(s) for their contribution to the peer review of this work. A peer review file is available.</p>
    </sec>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>The datasets used for the analyses in this manuscript can be downloaded in SpatialExperiment format<sup><xref ref-type="bibr" rid="CR35">35</xref></sup> from the STexampleData Bioconductor package<sup><xref ref-type="bibr" rid="CR53">53</xref></sup>, which includes annotation labels from the original sources, and the spatialLIBD Bioconductor package<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>. The original datasets and annotations are sourced from refs. <sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR43">43</xref></sup> (Visium human DLPFC dataset), refs. <sup><xref ref-type="bibr" rid="CR4">4</xref>,<xref ref-type="bibr" rid="CR39">39</xref></sup> (Slide-seqV2 mouse HPC dataset), ref. <sup><xref ref-type="bibr" rid="CR1">1</xref></sup> (ST mouse OB dataset), and ref. <sup><xref ref-type="bibr" rid="CR38">38</xref></sup> (seqFISH mouse embryo dataset). Source data files to reproduce figures in the manuscript are also available from Figshare at 10.6084/m9.figshare.23561439.v2. All other data supporting the findings of this study are available within the article and its supplementary files. Any additional requests for information can be directed to, and will be fulfilled by, the lead contact.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>nnSVG is freely available as an R package from Bioconductor (as of 2023-06-14: nnSVG version 1.4.1 available in Bioconductor release version 3.17) at <ext-link ext-link-type="uri" xlink:href="https://bioconductor.org/packages/nnSVG">https://bioconductor.org/packages/nnSVG</ext-link>. The package is also available from GitHub at <ext-link ext-link-type="uri" xlink:href="https://github.com/lmweber/nnSVG">https://github.com/lmweber/nnSVG</ext-link>. Code to reproduce all preprocessing, analyses, and figures in this manuscript is available from GitHub at <ext-link ext-link-type="uri" xlink:href="https://github.com/lmweber/nnSVG-analyses">https://github.com/lmweber/nnSVG-analyses</ext-link>. An archived version of this code repository as of the time of publication is also available<sup><xref ref-type="bibr" rid="CR54">54</xref></sup>. We used nnSVG version 1.3.10 for the analyses in this manuscript.</p>
  </notes>
  <notes id="FPar2" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par69">The authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ståhl</surname>
            <given-names>PL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Visualization and analysis of gene expression in tissue sections by spatial transcriptomics</article-title>
        <source>Science</source>
        <year>2016</year>
        <volume>353</volume>
        <fpage>78</fpage>
        <lpage>82</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aaf2403</pub-id>
        <?supplied-pmid 27365449?>
        <pub-id pub-id-type="pmid">27365449</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <mixed-citation publication-type="other">10x Genomics. <italic>10x Genomics Visium Spatial Gene Expression Solution</italic> (2022).</mixed-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rodriques</surname>
            <given-names>SG</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Slide-seq: a scalable technology for measuring genome-wide expression at high spatial resolution</article-title>
        <source>Science</source>
        <year>2019</year>
        <volume>363</volume>
        <fpage>1463</fpage>
        <lpage>1467</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aaw1219</pub-id>
        <?supplied-pmid 30923225?>
        <pub-id pub-id-type="pmid">30923225</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stickels</surname>
            <given-names>RR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Highly sensitive spatial transcriptomics at near-cellular resolution with Slide-seqV2</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2020</year>
        <volume>39</volume>
        <fpage>313</fpage>
        <lpage>319</lpage>
        <pub-id pub-id-type="doi">10.1038/s41587-020-0739-1</pub-id>
        <?supplied-pmid 33288904?>
        <pub-id pub-id-type="pmid">33288904</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Eng</surname>
            <given-names>C-HL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Transcriptome-scale super-resolved imaging in tissues by RNA seqFISH+</article-title>
        <source>Nature</source>
        <year>2019</year>
        <volume>568</volume>
        <fpage>235</fpage>
        <lpage>239</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-019-1049-y</pub-id>
        <?supplied-pmid 30911168?>
        <pub-id pub-id-type="pmid">30911168</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Xia</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Fan</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Emanuel</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Hao</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Zhuang</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Spatial transcriptome profiling by MERFISH reveals subcellular RNA compartmentalization and cell cycle-dependent gene expression</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2019</year>
        <volume>116</volume>
        <fpage>19490</fpage>
        <lpage>19499</lpage>
        <pub-id pub-id-type="doi">10.1073/pnas.1912459116</pub-id>
        <?supplied-pmid 31501331?>
        <pub-id pub-id-type="pmid">31501331</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ortiz</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Molecular atlas of the adult mouse brain</article-title>
        <source>Sci. Adv.</source>
        <year>2020</year>
        <volume>6</volume>
        <fpage>eabb3446</fpage>
        <pub-id pub-id-type="doi">10.1126/sciadv.abb3446</pub-id>
        <?supplied-pmid 32637622?>
        <pub-id pub-id-type="pmid">32637622</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Maynard</surname>
            <given-names>KR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Transcriptome-scale spatial gene expression in the human dorsolateral prefrontal cortex</article-title>
        <source>Nat. Neurosci.</source>
        <year>2021</year>
        <volume>24</volume>
        <fpage>425</fpage>
        <lpage>436</lpage>
        <pub-id pub-id-type="doi">10.1038/s41593-020-00787-0</pub-id>
        <?supplied-pmid 33558695?>
        <pub-id pub-id-type="pmid">33558695</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ji</surname>
            <given-names>AL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Multimodal analysis of composition and spatial architecture in human squamous cell carcinoma</article-title>
        <source>Cell</source>
        <year>2020</year>
        <volume>182</volume>
        <fpage>1661</fpage>
        <lpage>1662</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2020.08.043</pub-id>
        <?supplied-pmid 32946785?>
        <pub-id pub-id-type="pmid">32946785</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Mantri</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Spatiotemporal single-cell RNA sequencing of developing hearts reveals interplay between cellular differentiation and morphogenesis</article-title>
        <source>Nat. Commun.</source>
        <year>2021</year>
        <volume>12</volume>
        <fpage>1771</fpage>
        <pub-id pub-id-type="doi">10.1038/s41467-021-21892-z</pub-id>
        <?supplied-pmid 33741943?>
        <pub-id pub-id-type="pmid">33741943</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hu</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Statistical and machine learning methods for spatially resolved transcriptomics with histology</article-title>
        <source>Comput. Struct. Biotechnol. J.</source>
        <year>2021</year>
        <volume>19</volume>
        <fpage>3829</fpage>
        <lpage>3841</lpage>
        <pub-id pub-id-type="doi">10.1016/j.csbj.2021.06.052</pub-id>
        <?supplied-pmid 34285782?>
        <pub-id pub-id-type="pmid">34285782</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Svensson</surname>
            <given-names>V</given-names>
          </name>
          <name>
            <surname>Teichmann</surname>
            <given-names>SA</given-names>
          </name>
          <name>
            <surname>Stegle</surname>
            <given-names>O</given-names>
          </name>
        </person-group>
        <article-title>SpatialDE: identification of spatially variable genes</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>343</fpage>
        <lpage>346</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4636</pub-id>
        <?supplied-pmid 29553579?>
        <pub-id pub-id-type="pmid">29553579</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <mixed-citation publication-type="other">Zhao, E. et al. Spatial transcriptomics at subspot resolution with BayesSpace. <italic>Nat. Biotechnol.</italic><bold>39</bold>, 1375–1384 (2021).</mixed-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hu</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>SpaGCN: Integrating gene expression, spatial location and histology to identify spatial domains and spatially variable genes by graph convolutional network</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>1342</fpage>
        <lpage>1351</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-021-01255-8</pub-id>
        <?supplied-pmid 34711970?>
        <pub-id pub-id-type="pmid">34711970</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Farrell</surname>
            <given-names>JA</given-names>
          </name>
          <name>
            <surname>Gennert</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Schier</surname>
            <given-names>AF</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Spatial reconstruction of single-cell gene expression data</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2015</year>
        <volume>33</volume>
        <fpage>495</fpage>
        <lpage>502</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.3192</pub-id>
        <?supplied-pmid 25867923?>
        <pub-id pub-id-type="pmid">25867923</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Achim</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>High-throughput spatial mapping of single-cell RNA-seq data to tissue of origin</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2015</year>
        <volume>33</volume>
        <fpage>503</fpage>
        <lpage>509</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.3209</pub-id>
        <?supplied-pmid 25867922?>
        <pub-id pub-id-type="pmid">25867922</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Amezquita</surname>
            <given-names>RA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Orchestrating single-cell analysis with Bioconductor</article-title>
        <source>Nat. Methods</source>
        <year>2019</year>
        <volume>17</volume>
        <fpage>137</fpage>
        <lpage>145</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0654-x</pub-id>
        <?supplied-pmid 31792435?>
        <pub-id pub-id-type="pmid">31792435</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hao</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Integrated analysis of multimodal single-cell data</article-title>
        <source>Cell</source>
        <year>2021</year>
        <volume>184</volume>
        <fpage>3573–3587.e29</fpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2021.04.048</pub-id>
        <?supplied-pmid 34062119?>
        <pub-id pub-id-type="pmid">34062119</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Angerer</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title>
        <source>Genome Biol.</source>
        <year>2018</year>
        <volume>19</volume>
        <fpage>15</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-017-1382-0</pub-id>
        <?supplied-pmid 29409532?>
        <pub-id pub-id-type="pmid">29409532</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Townes</surname>
            <given-names>FW</given-names>
          </name>
          <name>
            <surname>Hicks</surname>
            <given-names>SC</given-names>
          </name>
          <name>
            <surname>Aryee</surname>
            <given-names>MJ</given-names>
          </name>
          <name>
            <surname>Irizarry</surname>
            <given-names>RA</given-names>
          </name>
        </person-group>
        <article-title>Feature selection and dimension reduction for single-cell RNA-Seq based on a multinomial model</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>21</volume>
        <fpage>179</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-020-02109-w</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Moran</surname>
            <given-names>PAP</given-names>
          </name>
        </person-group>
        <article-title>Notes on continuous stochastic phenomena</article-title>
        <source>Biometrika</source>
        <year>1950</year>
        <volume>37</volume>
        <fpage>17</fpage>
        <lpage>23</lpage>
        <pub-id pub-id-type="doi">10.1093/biomet/37.1-2.17</pub-id>
        <?supplied-pmid 15420245?>
        <pub-id pub-id-type="pmid">15420245</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Geary</surname>
            <given-names>RC</given-names>
          </name>
        </person-group>
        <article-title>The contiguity ratio and statistical mapping</article-title>
        <source>Incorporated Statistician</source>
        <year>1954</year>
        <volume>5</volume>
        <fpage>115</fpage>
        <lpage>146</lpage>
        <pub-id pub-id-type="doi">10.2307/2986645</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Edsgärd</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Johnsson</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Sandberg</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Identification of spatial expression trends in single-cell gene expression data</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>339</fpage>
        <lpage>342</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4634</pub-id>
        <?supplied-pmid 29553578?>
        <pub-id pub-id-type="pmid">29553578</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <mixed-citation publication-type="other">Kats, I., Vento-Tormo, R. &amp; Stegle, O. SpatialDE2: fast and localized variance component analysis of spatial transcriptomics. Preprint at <italic>bioRxiv</italic>10.1101/2021.10.27.466045 (2021).</mixed-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sun</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Zhu</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Zhou</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Statistical analysis of spatial expression patterns for spatially resolved transcriptomic studies</article-title>
        <source>Nat. Methods</source>
        <year>2020</year>
        <volume>17</volume>
        <fpage>193</fpage>
        <lpage>200</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0701-7</pub-id>
        <?supplied-pmid 31988518?>
        <pub-id pub-id-type="pmid">31988518</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Xie</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Xiao</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Bayesian modeling of spatial molecular profiling data via Gaussian process</article-title>
        <source>Bioinformatics</source>
        <year>2021</year>
        <volume>37</volume>
        <fpage>4129</fpage>
        <lpage>4136</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btab455</pub-id>
        <?supplied-pmid 34146105?>
        <pub-id pub-id-type="pmid">34146105</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhu</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Sun</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Zhou</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>SPARK-X: non-parametric modeling enables scalable and robust detection of spatial expression patterns for large spatial transcriptomic studies</article-title>
        <source>Genome Biol.</source>
        <year>2021</year>
        <volume>22</volume>
        <fpage>184</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-021-02404-0</pub-id>
        <?supplied-pmid 34154649?>
        <pub-id pub-id-type="pmid">34154649</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <mixed-citation publication-type="other">Miller, B. F., Bambah-Mukku, D., Dulac, C., Zhuang, X. &amp; Fan, J. Characterizing spatial gene expression heterogeneity in spatially resolved single-cell transcriptomics data with nonuniform cellular densities. <italic>Genome Res.</italic><bold>31</bold>, 1843–1855 (2021).</mixed-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dries</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Giotto: a toolbox for integrative analysis and visualization of spatial expression data</article-title>
        <source>Genome Biol.</source>
        <year>2021</year>
        <volume>22</volume>
        <fpage>78</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-021-02286-2</pub-id>
        <?supplied-pmid 33685491?>
        <pub-id pub-id-type="pmid">33685491</pub-id>
      </element-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Datta</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Banerjee</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Finley</surname>
            <given-names>AO</given-names>
          </name>
          <name>
            <surname>Gelfand</surname>
            <given-names>AE</given-names>
          </name>
        </person-group>
        <article-title>Hierarchical nearest-neighbor Gaussian process models for large geostatistical datasets</article-title>
        <source>J. Am. Stat. Assoc.</source>
        <year>2016</year>
        <volume>111</volume>
        <fpage>800</fpage>
        <lpage>812</lpage>
        <pub-id pub-id-type="doi">10.1080/01621459.2015.1044091</pub-id>
        <?supplied-pmid 29720777?>
        <pub-id pub-id-type="pmid">29720777</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Finley</surname>
            <given-names>AO</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Efficient algorithms for Bayesian nearest neighbor Gaussian processes</article-title>
        <source>J. Comput. Graph. Stat.</source>
        <year>2019</year>
        <volume>28</volume>
        <fpage>401</fpage>
        <lpage>414</lpage>
        <pub-id pub-id-type="doi">10.1080/10618600.2018.1537924</pub-id>
        <?supplied-pmid 31543693?>
        <pub-id pub-id-type="pmid">31543693</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Saha</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Datta</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>BRISC: bootstrap for rapid inference on spatial covariances</article-title>
        <source>Stat</source>
        <year>2018</year>
        <volume>7</volume>
        <fpage>e184</fpage>
        <pub-id pub-id-type="doi">10.1002/sta4.184</pub-id>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Shah</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Lubeck</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Zhou</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Cai</surname>
            <given-names>L</given-names>
          </name>
        </person-group>
        <article-title>In situ transcription profiling of single cells reveals spatial organization of cells in the mouse hippocampus</article-title>
        <source>Neuron</source>
        <year>2016</year>
        <volume>92</volume>
        <fpage>342</fpage>
        <lpage>357</lpage>
        <pub-id pub-id-type="doi">10.1016/j.neuron.2016.10.001</pub-id>
        <?supplied-pmid 27764670?>
        <pub-id pub-id-type="pmid">27764670</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Huber</surname>
            <given-names>W</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Orchestrating high-throughput genomic analysis with Bioconductor</article-title>
        <source>Nat. Methods</source>
        <year>2015</year>
        <volume>12</volume>
        <fpage>115</fpage>
        <lpage>121</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.3252</pub-id>
        <?supplied-pmid 25633503?>
        <pub-id pub-id-type="pmid">25633503</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Righelli</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>SpatialExperiment: infrastructure for spatially resolved transcriptomics data in R using Bioconductor</article-title>
        <source>Bioinformatics</source>
        <year>2022</year>
        <volume>38</volume>
        <fpage>3128</fpage>
        <lpage>3131</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btac299</pub-id>
        <?supplied-pmid 35482478?>
        <pub-id pub-id-type="pmid">35482478</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Townes</surname>
            <given-names>FW</given-names>
          </name>
          <name>
            <surname>Engelhardt</surname>
            <given-names>BE</given-names>
          </name>
        </person-group>
        <article-title>Nonnegative spatial factorization applied to spatial genomics</article-title>
        <source>Nat. Methods</source>
        <year>2022</year>
        <volume>20</volume>
        <fpage>229</fpage>
        <lpage>238</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-022-01687-w</pub-id>
        <?supplied-pmid 36587187?>
        <pub-id pub-id-type="pmid">36587187</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <mixed-citation publication-type="other">10x Genomics. <italic>Visium Spatial Proteomics</italic> (2022).</mixed-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lohoff</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Integration of spatial and single-cell transcriptomic data elucidates mouse organogenesis</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2021</year>
        <volume>1</volume>
        <fpage>1</fpage>
      </element-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cable</surname>
            <given-names>DM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Robust decomposition of cell type mixtures in spatial transcriptomics</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2021</year>
        <volume>1</volume>
        <fpage>1</fpage>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <mixed-citation publication-type="other">Li, Y. et al. Benchmarking computational integration methods for spatial transcriptomics data. Preprint at <italic>bioRxiv</italic>10.1101/2021.08.27.457741 (2022).</mixed-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Andersson</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Lundeberg</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>sepal: Identifying transcript profiles with spatial patterns by diffusion-based modeling</article-title>
        <source>Bioinformatics</source>
        <year>2021</year>
        <volume>37</volume>
        <fpage>2644</fpage>
        <lpage>2650</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btab164</pub-id>
        <?supplied-pmid 33704427?>
        <pub-id pub-id-type="pmid">33704427</pub-id>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <mixed-citation publication-type="other">Corso, D., Malfait, M., Moses, L. &amp; Sales, G. spatialDE: R wrapper for SpatialDE. <italic>R/Bioconductor package</italic> (2023).</mixed-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <mixed-citation publication-type="other">Pardo, B. et al. spatialLIBD: an R/Bioconductor package to visualize spatially-resolved transcriptomics data. <italic>BMC Genom.</italic><bold>23</bold>, 434 (2022).</mixed-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <mixed-citation publication-type="other">Weber, L. M. et al. The gene expression landscape of the human locus coeruleus revealed by single-nucleus and spatially-resolved transcriptomics. <italic>eLife</italic><bold>12</bold>, 10.7554/eLife.84628.1 (2023).</mixed-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>McCarthy</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Campbell</surname>
            <given-names>KR</given-names>
          </name>
          <name>
            <surname>Lun</surname>
            <given-names>ATL</given-names>
          </name>
          <name>
            <surname>Wills</surname>
            <given-names>QF</given-names>
          </name>
        </person-group>
        <article-title>Scater: pre-processing, quality control, normalization and visualization of single-cell RNA-seq data in R</article-title>
        <source>Bioinformatics</source>
        <year>2017</year>
        <volume>33</volume>
        <fpage>1179</fpage>
        <lpage>1186</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btw777</pub-id>
        <?supplied-pmid 28088763?>
        <pub-id pub-id-type="pmid">28088763</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lun</surname>
            <given-names>ATL</given-names>
          </name>
          <name>
            <surname>McCarthy</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Marioni</surname>
            <given-names>JC</given-names>
          </name>
        </person-group>
        <article-title>A step-by-step workflow for low-level analysis of single-cell RNA-seq data with Bioconductor</article-title>
        <source>F1000Research</source>
        <year>2016</year>
        <volume>5</volume>
        <fpage>2122</fpage>
        <?supplied-pmid 27909575?>
        <pub-id pub-id-type="pmid">27909575</pub-id>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Guinness</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Permutation and grouping methods for sharpening Gaussian process approximations</article-title>
        <source>Technometrics</source>
        <year>2018</year>
        <volume>60</volume>
        <fpage>415</fpage>
        <lpage>429</lpage>
        <pub-id pub-id-type="doi">10.1080/00401706.2018.1437476</pub-id>
        <?supplied-pmid 31447491?>
        <pub-id pub-id-type="pmid">31447491</pub-id>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Benjamini</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Hochberg</surname>
            <given-names>Y</given-names>
          </name>
        </person-group>
        <article-title>Controlling the false discovery rate: a practical and powerful approach to multiple testing</article-title>
        <source>J. R. Stat. Soc.</source>
        <year>1995</year>
        <volume>57</volume>
        <fpage>289</fpage>
        <lpage>300</lpage>
      </element-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <mixed-citation publication-type="other">Morgan, M. et al. BiocParallel: Bioconductor facilities for parallel evaluation. <italic>R/Bioconductor package</italic> (2023).</mixed-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <mixed-citation publication-type="other">10x Genomics. <italic>Spatial Gene Expression Datasets</italic> (2022).</mixed-citation>
    </ref>
    <ref id="CR51">
      <label>51.</label>
      <mixed-citation publication-type="other">10x Genomics. <italic>Space Ranger: Spatial Gene Expression</italic> (2022).</mixed-citation>
    </ref>
    <ref id="CR52">
      <label>52.</label>
      <mixed-citation publication-type="other">Papadakis, M., Tsagris, M., Fafalios, S. &amp; Dimitriadis, M. Rfast2: a collection of efficient and extremely fast R functions II. <italic>R package</italic> (2023).</mixed-citation>
    </ref>
    <ref id="CR53">
      <label>53.</label>
      <mixed-citation publication-type="other">Weber, L. M. STexampleData. <italic>R/Bioconductor package</italic> (2023).</mixed-citation>
    </ref>
    <ref id="CR54">
      <label>54.</label>
      <mixed-citation publication-type="other">Weber, L. M. nnSVG-analyses; version 1.0.0. 10.5281/zenodo.8040654. <italic>GitHub Repository</italic> (2023).</mixed-citation>
    </ref>
  </ref-list>
</back>
<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//Springer-Verlag//DTD A++ V2.4//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName A++V2.4.dtd?>
<?SourceDTD.Version 2.4?>
<?ConverterInfo.XSLTName springer2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<processing-meta base-tagset="archiving" mathml-version="3.0" table-model="xhtml" tagset-family="jats">
  <restricted-by>pmc</restricted-by>
</processing-meta>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Nat Commun</journal-id>
    <journal-id journal-id-type="iso-abbrev">Nat Commun</journal-id>
    <journal-title-group>
      <journal-title>Nature Communications</journal-title>
    </journal-title-group>
    <issn pub-type="epub">2041-1723</issn>
    <publisher>
      <publisher-name>Nature Publishing Group UK</publisher-name>
      <publisher-loc>London</publisher-loc>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">10333391</article-id>
    <article-id pub-id-type="pmid">37429865</article-id>
    <article-id pub-id-type="publisher-id">39748</article-id>
    <article-id pub-id-type="doi">10.1038/s41467-023-39748-z</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Article</subject>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>nnSVG for the scalable identification of spatially variable genes using nearest-neighbor Gaussian processes</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-3282-1730</contrib-id>
        <name>
          <surname>Weber</surname>
          <given-names>Lukas M.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Saha</surname>
          <given-names>Arkajyoti</given-names>
        </name>
        <xref ref-type="aff" rid="Aff2">2</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-5046-0289</contrib-id>
        <name>
          <surname>Datta</surname>
          <given-names>Abhirup</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-0086-0687</contrib-id>
        <name>
          <surname>Hansen</surname>
          <given-names>Kasper D.</given-names>
        </name>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <contrib contrib-type="author" corresp="yes">
        <contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-7858-0231</contrib-id>
        <name>
          <surname>Hicks</surname>
          <given-names>Stephanie C.</given-names>
        </name>
        <address>
          <email>shicks19@jhu.edu</email>
        </address>
        <xref ref-type="aff" rid="Aff1">1</xref>
      </contrib>
      <aff id="Aff1"><label>1</label><institution-wrap><institution-id institution-id-type="GRID">grid.21107.35</institution-id><institution-id institution-id-type="ISNI">0000 0001 2171 9311</institution-id><institution>Department of Biostatistics, </institution><institution>Johns Hopkins Bloomberg School of Public Health, </institution></institution-wrap>Baltimore, MD USA </aff>
      <aff id="Aff2"><label>2</label><institution-wrap><institution-id institution-id-type="GRID">grid.34477.33</institution-id><institution-id institution-id-type="ISNI">0000000122986657</institution-id><institution>Department of Statistics, </institution><institution>University of Washington, </institution></institution-wrap>Seattle, WA USA </aff>
    </contrib-group>
    <pub-date pub-type="epub">
      <day>10</day>
      <month>7</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>10</day>
      <month>7</month>
      <year>2023</year>
    </pub-date>
    <pub-date pub-type="collection">
      <year>2023</year>
    </pub-date>
    <volume>14</volume>
    <elocation-id>4059</elocation-id>
    <history>
      <date date-type="received">
        <day>15</day>
        <month>6</month>
        <year>2022</year>
      </date>
      <date date-type="accepted">
        <day>23</day>
        <month>6</month>
        <year>2023</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author(s) 2023</copyright-statement>
      <license>
        <ali:license_ref specific-use="textmining" content-type="ccbylicense">https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
        <license-p><bold>Open Access</bold> This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article’s Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article’s Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>.</license-p>
      </license>
    </permissions>
    <abstract id="Abs1">
      <p id="Par1">Feature selection to identify spatially variable genes or other biologically informative genes is a key step during analyses of spatially-resolved transcriptomics data. Here, we propose nnSVG, a scalable approach to identify spatially variable genes based on nearest-neighbor Gaussian processes. Our method (i) identifies genes that vary in expression continuously across the entire tissue or within a priori defined spatial domains, (ii) uses gene-specific estimates of length scale parameters within the Gaussian process models, and (iii) scales linearly with the number of spatial locations. We demonstrate the performance of our method using experimental data from several technological platforms and simulations. A software implementation is available at <ext-link ext-link-type="uri" xlink:href="https://bioconductor.org/packages/nnSVG">https://bioconductor.org/packages/nnSVG</ext-link>.</p>
    </abstract>
    <abstract id="Abs2" abstract-type="web-summary">
      <p id="Par2">The identification of top spatially variable genes is a key step in the analysis of spatially-resolved transcriptomics data. Here, the authors develop a scalable method based on nearest-neighbor Gaussian processes and evaluate performance compared to existing and baseline methods.</p>
    </abstract>
    <kwd-group kwd-group-type="npg-subject">
      <title>Subject terms</title>
      <kwd>Statistical methods</kwd>
      <kwd>Software</kwd>
      <kwd>Transcriptomics</kwd>
      <kwd>Software</kwd>
      <kwd>Sequencing</kwd>
    </kwd-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000025</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Institute of Mental Health (NIMH)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>U01MH122849</award-id>
        <principal-award-recipient>
          <name>
            <surname>Hicks</surname>
            <given-names>Stephanie C.</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000051</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Human Genome Research Institute (NHGRI)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>K99HG012229</award-id>
        <principal-award-recipient>
          <name>
            <surname>Hicks</surname>
            <given-names>Stephanie C.</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution-wrap>
            <institution-id institution-id-type="FundRef">https://doi.org/10.13039/100000066</institution-id>
            <institution>U.S. Department of Health &amp; Human Services | NIH | National Institute of Environmental Health Sciences (NIEHS)</institution>
          </institution-wrap>
        </funding-source>
        <award-id>R01ES033739</award-id>
        <principal-award-recipient>
          <name>
            <surname>Hicks</surname>
            <given-names>Stephanie C.</given-names>
          </name>
        </principal-award-recipient>
      </award-group>
    </funding-group>
    <funding-group>
      <award-group>
        <funding-source>
          <institution>National Science Foundation Division of Mathematical Sciences: DMS-1915803 Chan Zuckerberg Initiative DAF: CZF2019-002443 Chan Zuckerberg Initiative DAF: CZF2018-183446</institution>
        </funding-source>
      </award-group>
    </funding-group>
    <custom-meta-group>
      <custom-meta>
        <meta-name>issue-copyright-statement</meta-name>
        <meta-value>© Springer Nature Limited 2023</meta-value>
      </custom-meta>
    </custom-meta-group>
  </article-meta>
</front>
<body>
  <sec id="Sec1" sec-type="introduction">
    <title>Introduction</title>
    <p id="Par3">Spatially-resolved transcriptomics (SRT) refers to recently developed technologies that measure gene expression in either the full transcriptome or up to thousands of genes at near- or sub-cellular resolution along with spatial coordinates of the measurements, either based on (i) tagging messenger RNA (mRNA) molecules with spatial barcodes followed by sequencing<sup><xref ref-type="bibr" rid="CR1">1</xref>–<xref ref-type="bibr" rid="CR4">4</xref></sup> or (ii) fluorescence imaging-based in situ transcriptomics techniques where mRNA molecules are detected along with their spatial coordinates using sequential rounds of fluorescent barcoding<sup><xref ref-type="bibr" rid="CR5">5</xref>,<xref ref-type="bibr" rid="CR6">6</xref></sup>. These technologies have been used to study the spatial landscape of gene expression in a variety of biological systems, including the brain<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR7">7</xref>,<xref ref-type="bibr" rid="CR8">8</xref></sup>, cancer<sup><xref ref-type="bibr" rid="CR9">9</xref></sup>, and embryonic development<sup><xref ref-type="bibr" rid="CR10">10</xref></sup>.</p>
    <p id="Par4">However, these new platforms also bring new computational challenges<sup><xref ref-type="bibr" rid="CR11">11</xref></sup>. One common analysis task is to identify genes that vary in expression across a tissue, defined as spatially variable genes by Svensson et al.<sup><xref ref-type="bibr" rid="CR12">12</xref></sup> (SVGs). These SVGs can then be further investigated individually as potential markers of biological processes, or used as the input for downstream analyses such as spatially-aware unsupervised clustering<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR14">14</xref></sup> or registering the spatial locations of single-cell RNA sequencing (scRNA-seq) data<sup><xref ref-type="bibr" rid="CR11">11</xref>,<xref ref-type="bibr" rid="CR15">15</xref>,<xref ref-type="bibr" rid="CR16">16</xref></sup>.</p>
    <p id="Par5">To identify SVGs, one approach is to ignore the spatial coordinates and apply methods that rely only on the gene expression, such as feature selection methods used in the analysis of scRNA-seq data, including highly variable genes (HVGs)<sup><xref ref-type="bibr" rid="CR17">17</xref>–<xref ref-type="bibr" rid="CR19">19</xref></sup> or deviance residuals from binomial or Poisson models<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>. A second approach is to use both the gene expression and spatial coordinates to identify genes that vary in expression in a continuous manner, either across the entire tissue or within a priori defined spatial domains, for example, using morphology from histology images, representing a subset of the tissue. Here, we refer to this second set of approaches with continuous spatial variation as methods to detect SVGs. Some examples of these methods include (i) standard spatial statistics measures (Moran’s I statistic<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>, Geary’s C statistic<sup><xref ref-type="bibr" rid="CR22">22</xref></sup>) to rank genes by their spatial autocorrelation, (ii) marked point processes (trendsceek<sup><xref ref-type="bibr" rid="CR23">23</xref></sup>), (iii) Gaussian process (GP) regression (SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, SpatialDE2<sup><xref ref-type="bibr" rid="CR24">24</xref></sup>), (iv) generalized linear spatial models with either an overdispersed Poisson or Gaussian distribution (SPARK<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>) or a zero-inflated negative binomial distribution (BOOST-GP<sup><xref ref-type="bibr" rid="CR26">26</xref></sup>), or (v) nonparametric covariance tests (SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>). These methods make tradeoffs, for example, flexibility in fitting gene-specific parameters (iii, iv) versus improved computational efficiency (v). There are also toolboxes that incorporate some of these methods, for example, MERINGUE<sup><xref ref-type="bibr" rid="CR28">28</xref></sup>, Giotto<sup><xref ref-type="bibr" rid="CR29">29</xref></sup>, within a larger end-to-end analysis framework.</p>
    <p id="Par6">A third approach is to detect changes in the average expression at all spatial coordinates within one spatial domain relative to the average expression at all spatial coordinates in other domains. We refer to these approaches as methods to detect spatial domain marker genes. The spatial domains can be defined a priori, for example using morphology from histology images, or alternatively using an unsupervised clustering algorithm. However, the primary difference between methods to identify SVGs and these approaches are the type of variation in expression. In contrast to methods searching for continuous variation across the tissue (SVGs), these methods search for changes in the mean expression across spatial coordinates within one domain compared to other domains. This is in similar spirit to detecting marker genes between discrete cell populations in scRNA-seq data. An example of this approach is SpaGCN<sup><xref ref-type="bibr" rid="CR14">14</xref></sup>, which first uses the spatial coordinates to identify domains in an unsupervised manner and then performs domain-guided differential expression analysis<sup><xref ref-type="bibr" rid="CR14">14</xref></sup> with a Wilcoxon rank-sum test to identify mean-level changes between the spatial domains. Here, we are interested in methods to identify SVGs, not spatial domain marker genes. Therefore, we focus on methods to identify SVGs in this work.</p>
    <p id="Par7">A key distinguishing characteristic among recent methods to identify SVGs is computational scalability. In particular, SPARK-X scales linearly with the number of spatial locations<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>, while other methods scale cubically (e.g., SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup> and SPARK<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>) or quadratically (SpatialDE2<sup><xref ref-type="bibr" rid="CR24">24</xref></sup>). This is relevant as datasets from the latest SRT platforms such as 10x Genomics Visium<sup><xref ref-type="bibr" rid="CR2">2</xref></sup> and Slide-seqV2<sup><xref ref-type="bibr" rid="CR4">4</xref></sup> contain thousands of spatial locations per tissue sample, with future development moving towards even higher resolution. In addition, a limited set of existing methods, such as SPARK-X, offer the ability to search for continuous variation in expression within a priori defined spatial domains, which can be incorporated as known covariates in statistical models fit for each gene<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. However, SPARK-X uses the same set of kernels and length scale parameters for all genes, which reduces flexibility to identify SVGs from different biological processes with varying spatial ranges in expression within the same tissue sample. In this work, we aimed to address this limitation and develop a computationally scalable approach to identify SVGs that fits a flexible length scale parameter per gene and also allows taking spatial domains into account.</p>
    <p id="Par8">Here, we describe nnSVG, a method to identify SVGs, which is based on statistical advances in computationally scalable parameter estimation in spatial covariance functions in GPs using nearest-neighbor Gaussian process (NNGP) models<sup><xref ref-type="bibr" rid="CR30">30</xref>–<xref ref-type="bibr" rid="CR32">32</xref></sup>. First, we introduce an overview of the methodological framework and then we compare our method to other methods in several SRT datasets including from the 10x Genomics Visium<sup><xref ref-type="bibr" rid="CR2">2</xref></sup>, Spatial Transcriptomics<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, Slide-seqV2<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>, and seqFISH<sup><xref ref-type="bibr" rid="CR33">33</xref></sup> platforms. Our method can search for SVGs across an entire tissue or within a priori defined spatial domains. In addition, unlike existing scalable methods, our approach estimates a gene-specific length scale parameter within the spatial covariance function in the GPs, enabling flexibility in the types of SVGs identified. We demonstrate that our method scales linearly with the number of spatial locations, ensuring the method can be applied to datasets with thousands or more spatial locations. Our methodology is implemented in the nnSVG R package within the Bioconductor framework<sup><xref ref-type="bibr" rid="CR34">34</xref></sup> and can be integrated into workflows using established Bioconductor infrastructure for SRT and scRNA-seq data<sup><xref ref-type="bibr" rid="CR17">17</xref>,<xref ref-type="bibr" rid="CR35">35</xref></sup>.</p>
  </sec>
  <sec id="Sec2" sec-type="results">
    <title>Results</title>
    <sec id="Sec3">
      <title>Overview of the nnSVG model and methodological framework</title>
      <p id="Par9">The nnSVG framework fits a nearest-neighbor Gaussian process (NNGP) model<sup><xref ref-type="bibr" rid="CR30">30</xref>,<xref ref-type="bibr" rid="CR31">31</xref></sup> to the preprocessed expression values for each gene:<disp-formula id="Equ1"><label>1</label><alternatives><tex-math id="M1">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\bf{y}}}}}}}} \sim N({{{{{{{\bf{X}}}}}}}}{{{{{{{\boldsymbol{\beta }}}}}}}},{{{\widetilde{{{{{\boldsymbol{{{\Sigma }}}}}}}}}}}({{{{{{{\boldsymbol{\theta }}}}}}}},{\tau }^{2}))$$\end{document}</tex-math><mml:math id="M2"><mml:mi mathvariant="bold">y</mml:mi><mml:mo>~</mml:mo><mml:mi>N</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">X</mml:mi><mml:mi mathvariant="bold-italic">β</mml:mi><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">Σ</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ1.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par10">Here, <bold>y</bold> = (<italic>y</italic><sub>1</sub>, …, <italic>y</italic><sub><italic>N</italic></sub>) represents the normalized and transformed expression values of gene <italic>g</italic> (subscript <italic>g</italic> = 1, …, <italic>G</italic> omitted for simplicity) at the set of <italic>N</italic> spatial locations <bold>s</bold> = (<bold>s</bold><sub><bold>1</bold></sub>, …, <bold>s</bold><sub><bold>N</bold></sub>), which we assume to be in two dimensions, but may in principle be generalized. The <inline-formula id="IEq1"><alternatives><tex-math id="M3">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{\widetilde{{{{{\boldsymbol{{{\Sigma }}}}}}}}}}}({{{{{{{\boldsymbol{\theta }}}}}}}},{\tau }^{2})$$\end{document}</tex-math><mml:math id="M4"><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">Σ</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2023_39748_Article_IEq1.gif"/></alternatives></inline-formula> term represents the NNGP covariance matrix, which offers a scalable (linear-time and storage) approximation to the covariance matrix <bold>Σ</bold>(<bold><italic>θ</italic></bold>, <italic>τ</italic><sup>2</sup>) = <italic>C</italic>(<bold><italic>θ</italic></bold>) + <italic>τ</italic><sup>2</sup><bold>I</bold> from a full GP model, which scales cubically in the number of spatial locations. The GP covariance matrix <italic>C</italic>(<bold><italic>θ</italic></bold>) = (<italic>C</italic><sub><italic>i</italic><italic>j</italic></sub>(<bold><italic>θ</italic></bold>)) (also referred to as a kernel) captures the spatially correlated variation and is parameterized by a vector of parameters <bold><italic>θ</italic></bold>. We assume an exponential covariance function, based on the observation that the widely used squared exponential covariance function (e.g., used in SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>) decays too rapidly with distance in the context of SRT data<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>. The exponential covariance function is defined as:<disp-formula id="Equ2"><label>2</label><alternatives><tex-math id="M5">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${C}_{ij}({{{{{{{\boldsymbol{\theta }}}}}}}})={\sigma }^{2}\exp \left(\frac{-||{{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{i}}}}}}}}}-{{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{j}}}}}}}}}||}{l}\right)$$\end{document}</tex-math><mml:math id="M6"><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mi>exp</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mfrac><mml:mrow><mml:mo>−</mml:mo><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ2.gif" position="anchor"/></alternatives></disp-formula>with covariance parameters <bold><italic>θ</italic></bold> = (<italic>σ</italic><sup>2</sup>, <italic>l</italic>), and where ∣∣<bold>s</bold><sub><bold>i</bold></sub> − <bold>s</bold><sub><bold>j</bold></sub>∣∣ represents the Euclidean distance between two spatial locations <bold>s</bold><sub><bold>i</bold></sub> and <bold>s</bold><sub><bold>j</bold></sub>. Here, <italic>σ</italic><sup>2</sup> is the spatial component of variance, and <italic>l</italic> is referred to as the length scale (or bandwidth) parameter, which controls the strength of decay of correlation with distance. The parameter <italic>τ</italic><sup>2</sup> (referred to as the nugget) represents the additional nonspatial component of variance.</p>
      <p id="Par11">The design matrix <bold>X</bold><sub>[<italic>N</italic>×<italic>d</italic>]</sub> can include up to <italic>d</italic> − 1 covariates representing known spatial domains or other information at each spatial location. The default is <bold>X</bold> = <bold>1</bold><sub>[<italic>N</italic>×1]</sub>, representing an intercept, with <bold><italic>β</italic></bold> accounting for the mean expression level. We fit a separate model for each gene and obtain maximum likelihood estimates for the parameters <bold><italic>θ</italic></bold> = (<italic>σ</italic><sup>2</sup>, <italic>l</italic>) and <italic>τ</italic><sup>2</sup> using the fast optimization algorithms for NNGP models implemented in the BRISC R package<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>. The main parameter of interest is <italic>σ</italic><sup>2</sup>, on which we perform a likelihood ratio (LR) test comparing the fitted model against a classical linear model that assumes <italic>σ</italic><sup>2</sup> = 0 and hence does not account for the spatial correlation in expression. Finally, we rank genes by the estimated LR statistic values and calculate multiple-testing adjusted approximate <italic>p</italic>-values for statistical significance. We provide a ranked list of genes, which can be used to select either (i) an arbitrary number of top-ranked genes for further investigation or to use as input for downstream analyses, or (ii) a set of statistically significant SVGs based on <italic>p</italic>-values adjusted for false discoveries. In addition, we calculate an effect size defined as propSV = <italic>σ</italic><sup>2</sup>/(<italic>σ</italic><sup>2</sup> + <italic>τ</italic><sup>2</sup>), which is the proportion of spatial variance (<italic>σ</italic><sup>2</sup>) from the total variance (<italic>σ</italic><sup>2</sup> + <italic>τ</italic><sup>2</sup>), as previously defined by Svensson et al.<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>.</p>
    </sec>
    <sec id="Sec4">
      <title>Key innovations of nnSVG</title>
      <p id="Par12">The key innovations of nnSVG compared to existing approaches are as follows. First, since we use NNGPs to fit the models for each gene, the computational complexity and runtime of nnSVG scale linearly with the number of spatial locations while retaining a large proportion of the underlying information<sup><xref ref-type="bibr" rid="CR30">30</xref>,<xref ref-type="bibr" rid="CR31">31</xref></sup>. SPARK-X also achieves linear scalability<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>, while earlier methods (e.g., SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, SPARK<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>) scale cubically with the number of spatial locations and are thus infeasible to apply to large datasets. Second, we demonstrate that because nnSVG estimates a gene-specific length scale parameter within the models, it enables the identification of SVGs associated with distinct biological processes with varying spatial ranges in expression within the same tissue sample. This cannot be achieved with methods that either assume a fixed length scale parameter or a combination of models with fixed length scale parameters across genes (e.g., SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>) or ignore the spatial information. Finally, nnSVG can identify SVGs within spatial domains by including the spatial domains as covariates within the model, which can also be done with SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> but not other existing methods (e.g., SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, SPARK<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>).</p>
    </sec>
    <sec id="Sec5">
      <title>nnSVG recovers biologically informative SVGs with gene-specific length scales</title>
      <p id="Par13">In the following sections, we consider three SRT datasets that contain previously identified biologically informative SVGs: data with (i) variation across cortical layers in the human brain dorsolateral prefrontal cortex (DLPFC)<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> measured with the 10x Genomics Visium platform<sup><xref ref-type="bibr" rid="CR37">37</xref></sup>, (ii) variation across cell type layers in the mouse brain olfactory bulb (OB)<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup> measured with the Spatial Transcriptomics (ST) platform<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, and (iii) variation within a sagittal tissue section of a mouse embryo<sup><xref ref-type="bibr" rid="CR38">38</xref></sup> measured with the seqFISH platform<sup><xref ref-type="bibr" rid="CR33">33</xref></sup>. In the Visium human DLPFC dataset, while the primary variation in expression is across cortical layers, there are also more subtle forms of variation associated with blood vessels and immune processes, which vary in expression across smaller length scales than the main cortical layers<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. We demonstrate that nnSVG identifies SVGs associated with both forms of variation, and that this flexibility stems from how the nnSVG model fits a gene-specific length scale parameter <italic>l</italic> within the covariance function <italic>C</italic>(<bold><italic>θ</italic></bold>) for each gene (see “Methods”). By contrast, methods that assume a fixed length scale parameter (or a combination of models with fixed length scale parameters) across genes may miss these types of discoveries.</p>
      <p id="Par14">Here, we evaluate the performance of nnSVG in recovering SVGs from the Visium human DLPFC<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, ST mouse OB<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup>, and seqFISH mouse embryo<sup><xref ref-type="bibr" rid="CR38">38</xref></sup> datasets, and compare against SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>, which is the only other existing method that also scales linearly with the number of spatial locations, and can therefore be applied to transcriptome-wide datasets with thousands or more spatial locations<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. In addition, we compare with baseline approaches, specifically HVGs<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> and Moran’s I statistic<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>, as nonspatial and spatial baseline methods, respectively (see “Methods”).</p>
    </sec>
    <sec id="Sec6">
      <title>nnSVG in application to human brain dorsolateral prefrontal cortex</title>
      <p id="Par15">Based on previously published analyses<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, the Visium human DLPFC dataset is known to contain a number of biologically informative SVGs, including a large number of SVGs associated with cortical layers (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, top row), as well as a smaller set of SVGs associated with blood vessels and immune processes (Fig. <xref rid="Fig1" ref-type="fig">1</xref>a, bottom row). The manually labeled cortical layer labels<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> (which we use as an approximate ground truth for method evaluation) are shown in Supplementary Fig. <xref rid="MOESM1" ref-type="media">S1A</xref>, <xref rid="MOESM1" ref-type="media">B</xref> as a reference. The spatial expression patterns of the blood- and immune-associated SVGs vary over relatively smaller distance ranges than the cortical layer-associated SVGs, which is reflected by the smaller estimated length scale parameters for the blood and immune-associated SVGs (<inline-formula id="IEq2"><alternatives><tex-math id="M7">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat{l}\, &lt; \,0.1$$\end{document}</tex-math><mml:math id="M8"><mml:mover accent="true"><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover><mml:mspace width="0.25em"/><mml:mo>&lt;</mml:mo><mml:mspace width="0.25em"/><mml:mn>0.1</mml:mn></mml:math><inline-graphic xlink:href="41467_2023_39748_Article_IEq2.gif"/></alternatives></inline-formula>) compared to the cortical layer-associated SVGs (<inline-formula id="IEq3"><alternatives><tex-math id="M9">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$\hat{l}\ge 0.1$$\end{document}</tex-math><mml:math id="M10"><mml:mover accent="true"><mml:mrow><mml:mi>l</mml:mi></mml:mrow><mml:mrow><mml:mo>^</mml:mo></mml:mrow></mml:mover><mml:mo>≥</mml:mo><mml:mn>0.1</mml:mn></mml:math><inline-graphic xlink:href="41467_2023_39748_Article_IEq3.gif"/></alternatives></inline-formula>) from the nnSVG models (Fig. <xref rid="Fig1" ref-type="fig">1</xref>b).<fig id="Fig1"><label>Fig. 1</label><caption><title>nnSVG recovers biologically informative SVGs with gene-specific length scale parameters.</title><p>Using the Visium human DLPFC dataset<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, nnSVG, SPARK-X, HVGs, and Moran’s I were applied to identify SVGs. <bold>a</bold> Spatial expression plots of 6 known biologically informative SVGs, including cortical layer-associated SVGs (top row) and blood- and immune-associated SVGs (bottom row). <bold>b</bold> Distribution of estimated gene-specific length scale parameters from nnSVG, with the 6 SVGs from (<bold>a</bold>) labeled in red. The blood- and immune-associated SVGs have smaller estimated length scale parameters than the cortical layer-associated SVGs. <bold>c</bold> Rank order of the 6 SVGs from (<bold>a</bold>) within the lists of top SVGs. Dashed vertical line divides the genes into the 3 cortical layer-associated SVGs with large length scales (left) and the 3 blood- and immune-associated SVGs with small length scales (right). <bold>d</bold> Estimated likelihood ratio (LR) statistic from nnSVG (<italic>y</italic>-axis) compared to the rank per gene (<italic>x</italic>-axis), with the 6 SVGs from (<bold>a</bold>) labeled, and 134 additional known layer-specific marker genes (from manually guided analyses by Maynard et al.<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>) highlighted (red circles). Orange dashed vertical line indicates rank cutoff for statistically significant SVGs at a multiple-testing-adjusted <italic>p</italic>-value of 0.05 using LR test with 2 degrees of freedom. <bold>e</bold> Estimated effect size (proportion of spatial variance) along <italic>y</italic>-axis compared to the mean log-transformed normalized counts (logcounts) along <italic>x</italic>-axis for top 1000 SVGs from nnSVG, with the 6 SVGs from (<bold>a</bold>) labeled, and estimated LR statistic per gene indicated with color scale. <bold>f</bold> Ranks of top 1000 SVGs from nnSVG (<italic>y</italic>-axis) compared to ranks from baseline methods (<italic>x</italic>-axis) using HVGs (nonspatial baseline method, left) and Moran’s I (spatially-aware baseline method, right), with SVGs from (<bold>a</bold>) highlighted (black circles), and Spearman correlation (text labels).</p></caption><graphic xlink:href="41467_2023_39748_Fig1_HTML" id="d32e1149"/></fig></p>
      <p id="Par16">All four methods successfully identified two out of the three cortical layer-associated SVGs (<italic>MOBP</italic> and <italic>SNAP25</italic>) within the top 100 ranked genes. While nnSVG, HVGs, and Moran’s I ranked the third SVG (<italic>PCP4</italic>) around rank 100, SPARK-X did not rank <italic>PCP4</italic> within the top 1000 genes (Fig. <xref rid="Fig1" ref-type="fig">1</xref>c, left columns). For the three blood and immune-associated SVGs (<italic>HBB</italic>, <italic>IGKC</italic>, <italic>NPY</italic>), we found that HVGs ranked all 3 genes within the top 100, while nnSVG identified two out of the three within the top 100 and the third around rank 300. Moran’s I ranked these three genes at lower ranks (ranks ~ 100−1000), and SPARK-X did not identify any of the three genes within the top 1000 genes (Fig. <xref rid="Fig1" ref-type="fig">1</xref>c, right columns).</p>
      <p id="Par17">To ensure a consistent comparison in these evaluations, we used the same filtering to remove low-expressed genes for both nnSVG and SPARK-X (3396 out of 21,803 genes passed the filtering threshold; see “Methods”). To confirm that the performance of SPARK-X was not affected by the filtering, we also ran nnSVG and SPARK-X without filtering low-expressed genes, in line with the default setting for SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>. The performance for nnSVG was comparable for all six SVGs (with and without filtering). However, the performance for SPARK-X dropped for identifying the blood- and immune-associated SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2A)</xref>.</p>
      <p id="Par18">In addition to these 6 SVGs, this dataset also contains a set of 198 known cortical layer-specific marker genes (consisting of 195 additional genes and the 3 cortical layer-associated SVGs from Fig. <xref rid="Fig1" ref-type="fig">1</xref>a) identified by manually guided pseudobulked analyses in the original study<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. Out of these 198 genes, 134 passed filtering for low-expressed genes, and 133 of these 134 were identified as statistically significant SVGs by nnSVG, out of a total of 2198 statistically significant SVGs (from 3396 genes that passed filtering) at an adjusted <italic>p</italic>-value threshold of 0.05. (The likelihood of correctly selecting 133 out of 134 genes by chance in this case is <italic>p</italic> &lt; 10<sup>−16</sup> by Fisher’s exact test and assuming independently selected genes.) All 3 of the blood- and immune-associated SVGs from Fig. <xref rid="Fig1" ref-type="fig">1</xref>a were also included in the set of significant SVGs from nnSVG (Fig. <xref rid="Fig1" ref-type="fig">1</xref>d). By contrast, SPARK-X identified 3394 (out of 3396) genes as statistically significant SVGs, including all 134 of the layer-specific markers that passed filtering, but one of the 3 blood- and immune-associated SVGs (<italic>NPY</italic>) was not included within the set of significant SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2B)</xref>. Using the default filtering for SPARK-X (i.e., no filtering of low-expressed genes), 10,358 genes were identified as significant SVGs, including 187 out of the 198 layer-specific markers, but not including <italic>NPY</italic> (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2C)</xref>. Considering the effect size defined as the estimated proportion of spatial variance from nnSVG, following ref. <sup><xref ref-type="bibr" rid="CR12">12</xref></sup> (see “Methods”), we found that highly ranked SVGs (with large LR statistics) also had higher proportion of spatial variance, which is also related to the mean expression (Fig. <xref rid="Fig1" ref-type="fig">1</xref>e).</p>
      <p id="Par19">As another form of comparison, we evaluated the degree of overlap between nnSVG and the baseline methods. In this dataset, the main biological signals of interest are related to the spatial distributions of the cortical layers and other biological processes, which are characterized by distinct gene expression profiles<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. Therefore, we expect that most SVGs will also be identified as HVGs, and thus a strong agreement between nnSVG and HVGs gives further confidence in the results from nnSVG. When comparing the ranks of the top 1000 SVGs from nnSVG and HVGs, we found relatively close agreement (Fig. <xref rid="Fig1" ref-type="fig">1</xref>f, left panel), along with a high overlap between the sets of top <italic>n</italic> SVGs from nnSVG and top <italic>n</italic> HVGs (<italic>n</italic> = 10, 20, 50, 100, 200) (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2D)</xref>. We found similar results and higher correlation when comparing between nnSVG and Moran’s I (Fig. <xref rid="Fig1" ref-type="fig">1</xref>f, right panel), demonstrating that for most genes, these two methods recover similar spatial information. However, the largest mismatch in ranks between nnSVG and Moran’s I occurs for the 3 blood- and immune-associated SVGs, especially <italic>NPY</italic>, which have relatively small estimated length scale parameters (Fig. <xref rid="Fig1" ref-type="fig">1</xref>b), thus further demonstrating the advantage of the gene-specific length scale parameters in nnSVG and the improved performance in this dataset for genes with small estimated length scales (Fig. <xref rid="Fig1" ref-type="fig">1</xref>c). Further investigation of the estimated length scales and effect sizes per gene revealed that nnSVG tends to outperform (i) HVGs for genes with larger length scales (≥ 0.15), (ii) Moran’s I for genes with smaller length scales (&lt; 0.15), and (iii) both baselines for genes with relatively large effect sizes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S3A</xref>–<xref rid="MOESM1" ref-type="media">C</xref>; expression plots of examples of genes where nnSVG outperforms the baselines shown in Supplementary Fig. <xref rid="MOESM1" ref-type="media">S3D)</xref>. In addition, we observe that all genes with extremely small length scales (&lt; 0.01)—which may be hard to estimate reliably—were either not ranked within the top 1000 SVGs or were removed during our filtering step for low-expressed genes (“Methods”), so these genes did not interfere with the final ranking of top SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S4)</xref>. In contrast, when comparing SPARK-X to the baseline methods, we found smaller overlap and lower correlations using either HVGs and Moran’s I (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2E)</xref>. The SPARK-X results did not substantially change when using default filtering settings for low-expressed genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S2F)</xref>.</p>
      <p id="Par20">Finally, we generated spatial expression plots of the top 20 SVGs from nnSVG and SPARK-X, respectively. We observed that most of the top 20 SVGs from nnSVG were related to differences in expression between white matter and gray matter, where gray matter consists of the cortical layers<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> (Supplementary Figs. <xref rid="MOESM1" ref-type="media">S1</xref>, <xref rid="MOESM1" ref-type="media">S5)</xref>. This is consistent with previous analyses showing that the distinction between white matter and gray matter represents the strongest differences in expression patterns in this dataset, consistent with prior biological knowledge of this brain region<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. By contrast, the majority of the top 20 SVGs from SPARK-X are not associated as clearly with the distinction between white matter and gray matter (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S6)</xref>.</p>
    </sec>
    <sec id="Sec7">
      <title>nnSVG in application to mouse brain olfactory bulb</title>
      <p id="Par21">The second dataset we considered is the ST mouse OB dataset<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>. This dataset contains a smaller set of spatial locations at lower spatial resolution, which have been annotated with cell type layer labels<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup> (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7A)</xref>. Similar to the Visium human DLPFC data, we observe variation in the estimated gene-specific length scale parameters from nnSVG (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7B)</xref>, suggesting the need for flexibility in this parameter. We considered 7 known layer-associated SVGs<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, and found that HVGs identified all 7 genes within the top 200 ranked SVGs, while nnSVG, Moran’s I, and SPARK-X identified 5, 3, and 1 out of the 7 genes within the top 200 ranked SVGs, respectively (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7C)</xref>. Overall, nnSVG identified 559 genes as statistically significant SVGs (out of 4216 genes that passed filtering) at an adjusted <italic>p</italic>-value threshold of 0.05 (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7D)</xref>, while SPARK-X identified 2270 (out of 4216) significant SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7E)</xref>. When comparing the top 1000 ranked genes between nnSVG and the baseline methods (HVGs and Moran’s I), we found a higher correlation (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7F)</xref> than when using SPARK-X (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7G)</xref>. Furthermore, when comparing the overlap between the sets of top <italic>n</italic> = 10, 20, 50, 100, 200 SVGs and HVGs, we found nnSVG had a higher overlap with HVGs compared to the overlap between SPARK-X and HVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S7H)</xref>. This is expected as most of the biologically informative SVGs in this dataset are related to the spatial distribution of cell type layers<sup><xref ref-type="bibr" rid="CR1">1</xref>,<xref ref-type="bibr" rid="CR12">12</xref></sup>. Finally, we also provide spatial expression plots of the top 20 SVGs from nnSVG (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S8)</xref> to illustrate that most of the top SVGs are associated with the known cell type layers, as expected.</p>
    </sec>
    <sec id="Sec8">
      <title>nnSVG in application to mouse embryo</title>
      <p id="Par22">The third dataset we considered is the seqFISH mouse embryo dataset<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>, which consists of expression measurements of 351 targeted genes summarized at single-cell resolution in a sagittal tissue section from a mouse embryo (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9A)</xref>. Similar to the other datasets, we observed a range of values for the gene-specific length scale parameters from nnSVG (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9B)</xref>. We investigated 12 known highly biologically informative SVGs<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>, and found that nnSVG gave the highest rankings for 7 of these. In addition, nnSVG, HVGs, and Moran’s I identified all 12 of these genes within the top 100 ranked genes, while SPARK-X identified only 9 out of 12 within the top 100 ranked genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9C)</xref>. Overall, both nnSVG and SPARK-X identified all 351 genes as statistically significant SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9D</xref>, <xref rid="MOESM1" ref-type="media">E)</xref>. Similar to the Visium human DLPFC dataset, we also found a relationship between the effect size (proportion of spatial variance) and the mean expression (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9F)</xref>. When comparing the ranks of the 351 genes between nnSVG or SPARK-X and the baseline methods (HVGs and Moran’s I), we found a higher correlation for nnSVG than for SPARK-X (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9G</xref>, <xref rid="MOESM1" ref-type="media">H)</xref>. Similarly, we found that nnSVG had a higher overlap than SPARK-X between the sets of top <italic>n</italic> = 10, 20, 50, 100, 200 SVGs and HVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S9I)</xref>. As for the other datasets, this is expected since the biologically informative SVGs in this dataset are related to the spatial distribution of cell types at different developmental stages<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>. Finally, we also provide spatial expression plots of the top 20 SVGs from nnSVG (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S10)</xref>.</p>
    </sec>
    <sec id="Sec9">
      <title>nnSVG identifies SVGs within spatial domains</title>
      <p id="Par23">In this section, we apply nnSVG to an SRT dataset to demonstrate how our method can be used to identify SVGs within an a priori defined spatial domain by including the spatial domains as covariates within the statistical models. Specifically, we consider the Slide-seqV2 mouse hippocampus (HPC) dataset<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>, which contains separate anatomical regions from the mouse HPC and has been annotated with cell type labels by Cable et al.<sup><xref ref-type="bibr" rid="CR39">39</xref></sup> (Fig. <xref rid="Fig2" ref-type="fig">2</xref>a). We highlight two previously identified SVGs (<italic>Cpne9</italic> and <italic>Rgs14</italic>) from ref. <sup><xref ref-type="bibr" rid="CR39">39</xref></sup>, which exhibit spatial gradients of expression within the CA3 region of the hippocampus (Fig. <xref rid="Fig2" ref-type="fig">2</xref>b). Here, we apply nnSVG, SPARK-X, HVGs, and Moran’s I to identify SVGs and compare their performance.<fig id="Fig2"><label>Fig. 2</label><caption><title>nnSVG recovers biologically informative SVGs within spatial domains.</title><p>Using the Slide-seqV2 mouse hippocampus (HPC) dataset<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>, nnSVG, SPARK-X, HVGs, and Moran’s I were applied to identify SVGs within an a priori defined spatial domain. <bold>a</bold> Computationally labeled cell types per spot (bead) with labels from ref. <sup><xref ref-type="bibr" rid="CR39">39</xref></sup>. <bold>b</bold> Spatial expression plots of 2 known biologically informative SVGs identified by Cable et al.<sup><xref ref-type="bibr" rid="CR39">39</xref></sup> showing spatial gradients of expression within the spatial domain defined by CA3 cell type labels (pink points in (<bold>a</bold>)). <bold>c</bold> Rank order of the 2 SVGs from (<bold>b</bold>) within the lists of top SVGs. <bold>d</bold> Estimated likelihood ratio (LR) statistic from nnSVG (<italic>y</italic>-axis) compared to the rank per gene (<italic>x</italic>-axis), with the 2 SVGs from (<bold>b</bold>) highlighted. Orange dashed vertical line indicates rank cutoff for statistically significant SVGs at a multiple-testing-adjusted <italic>p</italic>-value of 0.05 using LR test with 2 degrees of freedom.</p></caption><graphic xlink:href="41467_2023_39748_Fig2_HTML" id="d32e1504"/></fig></p>
      <p id="Par24">We found that both nnSVG and SPARK-X (which also provides the option to include covariates for spatial domains) rank the <italic>Cpne9</italic> and <italic>Rgs14</italic> genes within the top 300 genes with similar performance (Fig. <xref rid="Fig2" ref-type="fig">2</xref>c). In contrast, while Moran’s I is able to identify <italic>Rgs14</italic> within the top 300 ranked genes, HVGs does not rank <italic>Rgs14</italic> within the top 1000 ranked genes, and neither HVGs or Moran’s I rank the <italic>Cpne9</italic> gene within the top 1000 ranked genes. We note that the performance of the HVGs baseline method differs from the results in the Visium human DLPFC dataset, where HVGs performed well. We also confirmed that using default settings for SPARK-X (no filtering of low-expressed genes) did not substantially change the results for SPARK-X, although nnSVG performed somewhat worse in this case (genes ranked between top 100−500) (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S11A)</xref>. At an adjusted <italic>p</italic>-value threshold of 0.05, nnSVG identified 1024 genes as statistically significant SVGs (out of 8883 genes that passed filtering), including both <italic>Cpne9</italic> and <italic>Rgs14</italic> (Fig. <xref rid="Fig2" ref-type="fig">2</xref>d). SPARK-X identified 2053 (out of 8883) genes as significant SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S11B)</xref>, or 1809 (out of 21,011) without filtering low-expressed genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S11C)</xref>, including both <italic>Cpne9</italic> and <italic>Rgs14</italic> in both cases.</p>
      <p id="Par25">We also compared the performance of nnSVG and SPARK-X to identify SVGs across the entire tissue without incorporating any spatial domain information. This reduced performance for both methods. Both nnSVG and SPARK-X ranked <italic>Cpne9</italic> and <italic>Rgs14</italic> in approximately the top 250 to 1000 genes (compared to the top 300 genes in the models with covariates for the spatial domains) (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S11D)</xref>. In the models without covariates, nnSVG and SPARK-X identified 3217 and 4821 (out of 8883) genes, respectively as statistically significant SVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S11E</xref>, <xref rid="MOESM1" ref-type="media">F)</xref>. The reduced performance when excluding the spatial domain covariates is expected, since in this case many additional expression patterns are deemed spatially variable.</p>
      <p id="Par26">In order to further evaluate performance for this dataset, we also investigated an extended list of 74 known SVGs within the CA3 spatial domain from the prior analyses<sup><xref ref-type="bibr" rid="CR39">39</xref></sup> (including <italic>Cpne9</italic> and <italic>Rgs14</italic>). We calculated how many of these 74 genes were identified within the top 1000 SVGs or HVGs by each method, which revealed that nnSVG recovered the highest number (27 out of 74), followed by SPARK-X and Moran’s I (23 out of 74), while HVGs performed poorly and recovered only 3 out of 74 genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S12)</xref>. Finally, we visualized the spatial expression of the top 20 SVGs from both nnSVG and SPARK-X (including spatial domain covariates). For both methods, the majority of these top SVGs are clearly associated with the known spatial domains, in particular the dentate, CA1, CA3, and oligodendrocyte cell type labels (Supplementary Figs. <xref rid="MOESM1" ref-type="media">S13</xref>, <xref rid="MOESM1" ref-type="media">S14)</xref>.</p>
    </sec>
    <sec id="Sec10">
      <title>nnSVG to select genes for downstream clustering</title>
      <p id="Par27">One potential application of methods to identify SVGs is to select a list of genes to use as the input for downstream clustering. Using SVGs instead of (nonspatial) HVGs for downstream clustering has been shown to improve clustering performance in SRT datasets<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>. We compared clustering performance in the Visium human DLPFC dataset using either the top 1000 SVGs (nnSVG, SPARK-X, and Moran’s I) or the top 1000 HVGs, in terms of the adjusted Rand index (which measures the similarity between two sets of cluster labels, with values between 0 and 1, where 1 indicates perfect agreement) between the clustering and the manually annotated cortical layer labels in this dataset (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S15A</xref>–<xref rid="MOESM1" ref-type="media">D)</xref>. We used graph-based clustering from standard single-cell workflows<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> and applied the clustering algorithm to the top 50 principal components (PCs) calculated on the top 1000 SVGs or HVGs. The results demonstrated that nnSVG and Moran’s I (which take spatial information into account) outperformed HVGs (nonspatial). In addition, nnSVG and Moran’s I outperformed SPARK-X, which is consistent with the main results showing that the top SVGs from nnSVG more closely reflect the biological structure in this dataset, compared to SPARK-X (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S15E)</xref>.</p>
    </sec>
    <sec id="Sec11">
      <title>Evaluating nnSVG using simulations</title>
      <p id="Par28">We developed a simulation framework to evaluate the performance of nnSVG in several ways. First, we built a dataset consisting of a set of simulated SVGs with regions of relatively high expression, surrounded by regions of background noise, across several scenarios where we varied the length scale and expression strength. We also simulated a set of noise genes without any spatial expression patterns. We obtained empirical parameters for these scenarios from the Visium human DLPFC dataset—mean and variance of log-transformed normalized expression (logcounts) for the known SVG <italic>MOBP</italic> within the highly expressed region (white matter) and low-expressed region (cortical layers), respectively, as well as proportions of sparsity (zero counts) within both regions. We simulated a total of 1000 genes, consisting of 100 SVGs and 900 noise genes. For the SVGs, we varied the length scale by simulating circular regions of elevated expression with radius 0.25, 0.125, and 0.025 times the width of the tissue section. We varied the expression strength as 1, 1/3, and 1/10 times the average difference between the regions of elevated and low expression, above background noise, for <italic>MOBP</italic>. Supplementary Fig. <xref rid="MOESM1" ref-type="media">S16A</xref> displays the spatial coordinate masks and relative expression strength for each scenario, and Supplementary Fig. <xref rid="MOESM1" ref-type="media">S16B</xref> shows the expression values (logcounts). Then, we evaluated the true positive rate (TPR) and false positive rate (FPR) for identifying the simulated subset of SVGs in each scenario. Our evaluations showed that nnSVG achieved very high TPR in all scenarios except the most difficult scenarios with small length scale and medium to low expression strength. In addition, we observed that nnSVG was conservative with respect to false positives—in the medium length scale, medium expression strength scenario (middle panel), we achieved FPR of 0.003, 0.016, and 0.031 at nominal <italic>p</italic>-value thresholds of 0.01, 0.05, and 0.1 (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S16C)</xref>.</p>
      <p id="Par29">We also developed an ablation simulation study<sup><xref ref-type="bibr" rid="CR41">41</xref></sup> to evaluate the robustness of nnSVG to increasing levels of noise. In this simulation, we extended the medium length scale, medium expression strength scenario by randomly shuffling a progressively increasing subset of spatial coordinates (0%, 10%, ..., 100%) to introduce noise into the spatial expression patterns (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S17A</xref>, <xref rid="MOESM1" ref-type="media">B)</xref>. We evaluated the TPR at each step, and found that nnSVG was highly robust to the noise—the TPR started decreasing at 70% shuffled coordinates, and eventually reached near zero by 90% shuffled coordinates (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S17C)</xref>.</p>
      <p id="Par30">Finally, we performed a set of null simulations using two datasets (Visium human DLPFC and ST mouse OB), where we permuted the order of the spatial coordinates to remove any spatial correlation structure. We observed the spikes in the distributions of the <italic>p</italic>-values near 0 were removed in the null simulations (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S18A</xref>, <xref rid="MOESM1" ref-type="media">B)</xref>, confirming that the significant <italic>p</italic>-values in the main results are due to the spatial correlation in expression. We also evaluated the proportion of false positives in the null simulations, which further confirmed that nnSVG is relatively conservative and generates a low proportion of false positives. Specifically, we evaluated the error control by calculating the proportion of false positives at a <italic>p</italic>-value cutoff of 0.05, which gave values below the nominal value of 0.05 in both null simulations (1.5% and 1.0%, respectively) (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S18C)</xref>.</p>
    </sec>
    <sec id="Sec12">
      <title>Evaluating the <italic>p</italic>-value distributions from nnSVG</title>
      <p id="Par31">Next, we investigated the <italic>p</italic>-value distributions from nnSVG for the transcriptome-wide datasets presented in this work, prior to correcting for false discoveries. If the LR test from nnSVG to assess the statistical significance of SVGs is well calibrated, we expected to see a flat, uniform distribution representing null tests for most of the distribution with a spike close to 0 representing the non-null tests. When we apply filtering to remove lowly expressed genes (default for nnSVG and the main results presented in this work), we found approximately uniform distributions of <italic>p</italic>-values with additional spikes near 0 and 1 for the three datasets Visium human DLPFC, ST mouse OB, and Slide-seqV2 mouse HPC, respectively (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S19A</xref>–<xref rid="MOESM1" ref-type="media">C)</xref>. The spike near 0 represents the subset of significant SVGs in each dataset, as expected, while the spike near 1 suggests that the <italic>p</italic>-values for non-spatially-correlated genes may be somewhat too conservative overall, giving more values near 1 than expected. In particular, we observe that the spike near 1 is much larger when running nnSVG without filtering low-expressed genes (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S19D</xref>–<xref rid="MOESM1" ref-type="media">F)</xref>, indicating that many of the genes with <italic>p</italic>-values near 1 are low-expressed genes. In this way, while the process of filtering lowly expressed genes can lead to some false negatives (depending on the stringency of filtering), overall, we view this filtering step as helpful as nnSVG still recovers hundreds to thousands of significant SVGs in each dataset after filtering, and the rankings of the top SVGs are relatively unaffected by the stringency of the filtering since these genes tend to be highly expressed (Fig. <xref rid="Fig1" ref-type="fig">1</xref>e).</p>
    </sec>
    <sec id="Sec13">
      <title>nnSVG scales linearly with the number of spatial locations</title>
      <p id="Par32">Here, we illustrate how the computational complexity and runtime of nnSVG scales linearly with the number of spatial locations, which is crucial for identifying SVGs in datasets with thousands or more spatial locations. To demonstrate the linear scalability of nnSVG, we generated simulations by subsampling the numbers of spots (<italic>n</italic> = 200, 500, 1000, 2000, 3639 in Visium human DLPFC, <italic>n</italic> = 1000, 2000, 5000, 10,000, 20,000, 40,000, 53,208 in Slide-seqV2 mouse HPC, where the maximum number in each case is the full number of spots available in the dataset, including low-quality and unannotated spots). We ran nnSVG 10 times for a single gene at each number of spots using a single processor core and recorded runtimes, demonstrating a clear linear trend in the runtimes (Fig. <xref rid="Fig3" ref-type="fig">3</xref>a, b). We also compared the scalability of nnSVG for the Slide-seqV2 mouse HPC dataset with and without covariates for spatial domains included, and observed only a minimal increase in runtimes with covariates included (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S20A</xref>, <xref rid="MOESM1" ref-type="media">B)</xref>. Next, we compared the scalability of both nnSVG and SPARK-X against the earlier cubically scaling methods, SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR42">42</xref></sup> and SPARK<sup><xref ref-type="bibr" rid="CR25">25</xref></sup>, by subsampling spots from the Visium human DLPFC dataset and running each method 10 times for two genes (SPARK and SPARK-X require at least two genes to run without error) using a single core, which clearly demonstrated the cubic scaling of SpatialDE and SPARK (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S20C)</xref>.<fig id="Fig3"><label>Fig. 3</label><caption><title>nnSVG scales linearly with the number of spatial locations.</title><p>The runtime in seconds (<italic>y</italic>-axis) of nnSVG on a single gene (run <italic>n</italic> = 10 times on a single processor core) using downsampled numbers of spots (<italic>x</italic>-axis) with two transcriptome-wide datasets, <bold>a</bold> Visium human DLPFC and <bold>b</bold> Slide-seqV2 mouse HPC, without quality control or filtering of spots. The dashed lines represent linear trends in scalability for each dataset. Boxplots show medians, first and third quartiles, and whiskers extending to the furthest values no more than 1.5 times the interquartile range from each quartile.</p></caption><graphic xlink:href="41467_2023_39748_Fig3_HTML" id="d32e1772"/></fig></p>
      <p id="Par33">Finally, we recorded runtimes for each of the three transcriptome-wide SRT datasets presented in this work (while filtering for lowly expressed genes) using both nnSVG and SPARK-X. We recorded runtimes of 520 s, 2788 s (46 min), and 18,642 s (5 h) for nnSVG for the 3 datasets (ST mouse OB, Visium human DLPFC, Slide-seqV2 mouse HPC), which contained 260, 3582, and 15,003 spots, respectively (after quality control and retaining annotated spots only). This compared to 11, 34, and 119 s for SPARK-X, respectively (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S20D)</xref>. We used 10 processor cores on a high-performance compute cluster for all datasets for nnSVG and the Slide-seqV2 mouse HPC dataset for SPARK-X, and 1 core for the ST mouse OB and Visium human DLPFC datasets for SPARK-X due to the higher efficiency of SPARK-X.</p>
    </sec>
    <sec id="Sec14">
      <title>Deviance residuals from binomial model for baseline method and preprocessing</title>
      <p id="Par34">As an alternative nonspatial baseline instead of HVGs, we also considered deviance residuals from a binomial model, which has been shown to give an improved ranking of genes in the context of scRNA-seq data and is more theoretically justified due to the use of a count-based model<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>. We evaluated the binomial deviance residuals baseline by comparing the rank order of the selected SVGs in the main results against HVGs for each dataset, and found that while the individual rankings changed for some genes, in particular <italic>NPY</italic> in the Visium human DLPFC dataset and <italic>Rgs14</italic> in the Slide-seqV2 mouse HPC dataset, the overall performance and relative ranking of methods was similar to HVGs (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S21)</xref>.</p>
      <p id="Par35">We also evaluated the results from nnSVG using deviance residuals from a binomial model for preprocessing, instead of log-transformed normalized counts (logcounts) for preprocessing<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> used in the main results, which has been shown to give improved performance in the context of scRNA-seq data<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>. We compared the rank order of the selected SVGs from nnSVG using the two preprocessing methods for each dataset, and found that the overall ranking of methods was similar (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S22)</xref>.</p>
    </sec>
    <sec id="Sec15">
      <title>Applying nnSVG to datasets with multiple samples</title>
      <p id="Par36">The nnSVG model has been developed for data from one sample (tissue section) at a time. To evaluate the stability of the rankings of SVGs obtained from multiple samples, we applied nnSVG to each of the additional samples available in the original source for the Visium human DLPFC dataset (12 samples from 3 donors)<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR43">43</xref></sup>. We calculated the Spearman correlation between the rankings from each pair of samples and found that these correlations were relatively high (&gt; 0.8) between samples within donors 1 and 3, respectively, moderate (&gt; 0.75) between samples between donors 1 and 3, and lower within donor 2 and between donor 2 and the other donors (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S23A)</xref>. This reflects the known biological structure from prior analyses of this dataset<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, which found that the samples from donors 1 and 3 had all cortical layers present, while the samples from donor 2 were missing several cortical layers (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S23B</xref>; donors in rows). We also visualized the rank comparisons for the samples with the highest and lowest correlations with sample 151673 (the sample used in the main results) (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S23C</xref>, <xref rid="MOESM1" ref-type="media">D)</xref> to further demonstrate these results.</p>
      <p id="Par37">In order to apply nnSVG to datasets with multiple samples in practice, we have also developed an approach based on averaging the ranks of the SVGs identified within each sample, which has been successfully applied in a new dataset<sup><xref ref-type="bibr" rid="CR44">44</xref></sup> and is described in detail in the package documentation (vignette).</p>
    </sec>
  </sec>
  <sec id="Sec16" sec-type="discussion">
    <title>Discussion</title>
    <p id="Par38">We have introduced nnSVG, a method to identify spatially variable genes (SVGs) in SRT data based on statistical advances in computationally scalable parameter estimation in spatial covariance functions in Gaussian processes using nearest-neighbor Gaussian process (NNGP) models<sup><xref ref-type="bibr" rid="CR30">30</xref>,<xref ref-type="bibr" rid="CR31">31</xref></sup>. In summary, our method (i) identifies genes that vary in expression continuously across the entire tissue or within a priori defined spatial domains, (ii) uses gene-specific estimates of length scale parameters within the Gaussian process models, and (iii) scales linearly with the number of spatial locations (Table <xref rid="Tab1" ref-type="table">1</xref>). We have demonstrated the importance of fitting gene-specific length scale parameters within the GP models in application of SRT datasets to identify genes with different spatial ranges in their expression patterns within the tissue of interest. The linear scalability aspect is crucial for current technological platforms with thousands of spatial locations per tissue sample and for emerging platforms at even higher resolutions, such as 10x Genomics Visium HD. Compared to existing methods, while the runtime for SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup> is fast, this method fits a fixed combination of covariance functions and length scale parameters across all genes, thereby leading to reduced flexibility to identify SVGs with different spatial ranges in expression. While earlier methods such as SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup> fit gene-specific length scale parameters, these do not scale linearly with the number of spatial locations. The importance of fitting gene-specific length scale parameters is likely to represent a general finding for the analysis of SRT datasets, with applicability beyond the specific modeling approach used here.<table-wrap id="Tab1"><label>Table 1</label><caption><p>Summary of characteristics of methods included in the performance evaluations and runtime comparisons</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Method</th><th>Spatial information</th><th>Flexible length scale parameters</th><th>Covariates for spatial domains</th><th>Runtime</th></tr></thead><tbody><tr><td>nnSVG</td><td>●</td><td>●</td><td>●</td><td>◐</td></tr><tr><td>SPARK-X</td><td>●</td><td>○</td><td>●</td><td>●</td></tr><tr><td>HVGs</td><td>○</td><td>○</td><td>○</td><td>●</td></tr><tr><td>Moran’s I</td><td>●</td><td>○</td><td>○</td><td>◐</td></tr><tr><td>SpatialDE</td><td>●</td><td>●</td><td>●</td><td>○</td></tr><tr><td>SPARK</td><td>●</td><td>●</td><td>●</td><td>○</td></tr></tbody></table><table-wrap-foot><p>For each method, the columns indicate whether (●) or not (○) the method: (i) takes spatial information into account, (ii) fits models with flexible gene-specific length scale parameters, (iii) provides an option to include covariates for spatial domains in the models, and (iv) provides fast runtimes. Half-filled circles (◐) indicate intermediate scores. The scalable methods are shown in the first 4 rows, and the earlier cubically scaling methods (SpatialDE and SPARK) are shown in the last 2 rows.</p></table-wrap-foot></table-wrap></p>
    <p id="Par39">Furthermore, unlike previous studies introducing methods to identify SVGs<sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR27">27</xref></sup>, we comprehensively evaluated our method against baseline methods. We compared against HVGs, deviance residuals from a binomial model<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>, and Moran’s I statistic<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>, representing both nonspatial and spatial baseline methods, to assess the advantage in terms of performance of applying our more statistically sophisticated (and more computationally intensive) approach instead of relying on simpler baseline methods. We demonstrated the degree of overlap between the nonspatial HVGs and nnSVG in each dataset, with a higher overlap expected in datasets where the biologically informative SVGs are largely related to spatial distributions of cell types. In general, our baseline comparisons demonstrate that HVGs provides excellent performance and computational efficiency in many datasets (despite not using the spatial information directly), especially where the spatial expression patterns are largely due to spatially distributed cell types—while nnSVG provides further improved performance in certain datasets with more complex expression patterns at higher computational cost.</p>
    <p id="Par40">We envision two types of primary applications of nnSVG. First, nnSVG can be used to generate lists of top SVGs during exploratory unsupervised analyses of SRT datasets, with the aim of detecting possible markers of biological processes of interest for further experimental validation. For example, ref. <sup><xref ref-type="bibr" rid="CR8">8</xref></sup> applied this strategy using SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>, using extensive computational resources due to the cubic scaling of this method<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. These analyses are more feasible with nnSVG than with existing scalable methods (e.g., SPARK-X<sup><xref ref-type="bibr" rid="CR27">27</xref></sup>), since nnSVG fits a gene-specific length scale parameter while also achieving linear computational scalability. For these types of analyses, the user can either select an arbitrary set of top-ranked SVGs (e.g., top 100 genes) or select a set of statistically significant SVGs with adjusted <italic>p</italic>-values from the LR test.</p>
    <p id="Par41">The second application of nnSVG is to use the set of top-ranked SVGs as the input for further downstream analyses, such as spatially-aware unsupervised clustering, for example<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR13">13</xref>,<xref ref-type="bibr" rid="CR14">14</xref></sup>, or registering the spatial locations of scRNA-seq data<sup><xref ref-type="bibr" rid="CR11">11</xref>,<xref ref-type="bibr" rid="CR15">15</xref>,<xref ref-type="bibr" rid="CR16">16</xref></sup>. This type of analysis is analogous to standard workflows for scRNA-seq analyses<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>. In spatial data, we can modify this workflow by replacing the set of top HVGs with the set of top SVGs from nnSVG, and then perform unsupervised clustering on the set of top SVGs. Since the set of SVGs has been generated by methodology that takes spatial information into account, this gives a spatially-aware clustering of cell populations<sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR40">40</xref></sup>. Our results demonstrated improved performance compared to using (nonspatial) HVGs for clustering, consistent with previous results<sup><xref ref-type="bibr" rid="CR40">40</xref></sup>.</p>
    <p id="Par42">Our method has some limitations, and we have identified several open directions for future work to extend our approach. First, while our method scales linearly with the number of spatial locations, the computational requirements remain nontrivial. For transcriptome-wide datasets with ≥10,000 spatial locations, runtimes are on the order of several hours when using 10 processor cores on a high-performance compute cluster. Since runtime depends on the number of genes, this can be reduced with more stringent gene filtering. In addition, our implementation is parallelized, allowing the user to select more cores if available, which will reduce runtimes. Future work could aim to further improve runtimes for large datasets, for example using low-rank statistical models that smooth the data into a smaller number of knots or inducing points representing the spatial locations, or further computational optimizations. Second, we observe some small negative values in the estimated LR statistics, which are difficult to interpret. Since this occurs mainly for lower-ranked genes, this does not affect the rankings in the sets of top-ranked SVGs. This could be improved by developing adaptive filtering thresholds that carefully remove low-expressed genes, which could also improve the calibration of <italic>p</italic>-values for low-expressed genes. Similarly, constraints could be placed on low values of the estimated length scale parameter within the models, although we found that these were generally low-expressed genes that were either filtered out or were not ranked as top SVGs. Third, while nnSVG identifies individual SVGs, we have not grouped these into gene groups or metagenes. Future work could develop added functionality to group genes into biologically interpretable metagenes in an unsupervised manner, similar to refs. <sup><xref ref-type="bibr" rid="CR12">12</xref>,<xref ref-type="bibr" rid="CR27">27</xref></sup>. Fourth, our model has been developed for a single sample (tissue section) at a time. While we have implemented a practical approach to apply nnSVG to multiple-sample datasets based on averaging the ranks of the SVGs identified within each sample, future work could focus on developing a principled statistical approach for multiple-sample datasets, for example by jointly estimating parameters across multiple samples to improve power and robustness. Finally, while we calculate an effect size defined as the proportion of spatial variance (similar to ref. <sup><xref ref-type="bibr" rid="CR12">12</xref></sup>), this definition does not distinguish between technical and biological variance, in contrast to standard effect size definitions in scRNA-seq workflows<sup><xref ref-type="bibr" rid="CR17">17</xref></sup> (Supplementary Fig. <xref rid="MOESM1" ref-type="media">S24)</xref>. Future work could aim to define a modified effect size that decomposes total variance into technical and biological components as well as spatial and nonspatial components, e.g., using a concept of biological spatial variance, which would aid in the interpretation of top-ranked SVGs.</p>
    <p id="Par43">Our method is implemented as an R package within the Bioconductor framework<sup><xref ref-type="bibr" rid="CR34">34</xref></sup>, and is freely available from Bioconductor at <ext-link ext-link-type="uri" xlink:href="https://bioconductor.org/packages/nnSVG">https://bioconductor.org/packages/nnSVG</ext-link>.</p>
  </sec>
  <sec id="Sec17">
    <title>Methods</title>
    <sec id="Sec18">
      <title>Preprocessing</title>
      <p id="Par44">The nnSVG workflow begins with preprocessing steps. For the analyses in this manuscript, we applied standard quality control (QC) to each dataset to filter out low-quality spatial locations (spots), using functions to calculate QC metrics implemented in the scater<sup><xref ref-type="bibr" rid="CR45">45</xref></sup> R/Bioconductor package. The thresholds we used for each QC metric can be found in our code repository (see “Code availability”).</p>
      <p id="Par45">Next, we filter out low-expressed genes and mitochondrial genes. Low-expressed genes are assumed to largely represent noise and to be unlikely to provide significant biological information about spatially-resolved biological processes, so removing them improves computational performance while preserving most of the information. For the analyses in this manuscript, we used the following filtering thresholds. For the Visium human DLPFC dataset, we retained genes with at least 3 unique molecular identifier (UMI) counts in at least 0.5 percent of spatial locations. For the Slide-seqV2 mouse HPC dataset, we retained genes with at least 1 UMI count in at least 1 percent of spatial locations. For the ST mouse OB dataset, we retained genes with at least 5 UMI counts in at least 1 percent of spatial locations. For the seqFISH mouse embryo dataset, no filtering was needed, as this dataset contains a smaller set of targeted genes. By contrast, mitochondrial genes are observed to be very highly expressed in most single-cell datasets, but their expression is generally not considered to be informative for distinguishing cell populations or states, so removing them reduces noise<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>. For the analyses in this manuscript, we removed mitochondrial genes from all datasets. The nnSVG package provides a filtering function for both low-expressed and mitochondrial genes, with default values appropriate for the 10x Genomics Visium platform, which can also be adjusted or disabled by the user.</p>
      <p id="Par46">Next, we normalize and transform the raw UMI counts using the log-transformed normalized counts methodology (also referred to as logcounts) using library size factors implemented in the scran, scuttle, and scater R/Bioconductor packages<sup><xref ref-type="bibr" rid="CR45">45</xref>,<xref ref-type="bibr" rid="CR46">46</xref></sup>. Normalization reduces technical biases between measurements from different spots, while log-transformation transforms the counts to a continuous and approximately normally distributed scale, allowing the NNGP models to be fitted. As an alternative to logcounts, we also demonstrate the use of the binomial deviance residuals methodology implemented in the scry R/Bioconductor package<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>, which has been shown to give improved performance in scRNA-seq data<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>.</p>
    </sec>
    <sec id="Sec19">
      <title>nnSVG model and parameters</title>
      <p id="Par47">In the nnSVG methodology, we assume that the input data consists of preprocessed gene expression measurements for thousands of genes at a set of spatial locations on a tissue slide, with the spatial locations typically also numbering in the thousands. The core of the nnSVG methodology consists of fitting a nearest-neighbor Gaussian process (NNGP) model<sup><xref ref-type="bibr" rid="CR30">30</xref>,<xref ref-type="bibr" rid="CR31">31</xref></sup> to the preprocessed expression measurements for each gene, i.e., one model per gene. This model is defined as:<disp-formula id="Equ3"><label>3</label><alternatives><tex-math id="M11">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\bf{y}}}}}}}} \sim N({{{{{{{\bf{X}}}}}}}}{{{{{{{\boldsymbol{\beta }}}}}}}},{{{\widetilde{{{{{\boldsymbol{{{\Sigma }}}}}}}}}}}({{{{{{{\boldsymbol{\theta }}}}}}}},{\tau }^{2}))$$\end{document}</tex-math><mml:math id="M12"><mml:mi mathvariant="bold">y</mml:mi><mml:mo>~</mml:mo><mml:mi>N</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">X</mml:mi><mml:mi mathvariant="bold-italic">β</mml:mi><mml:mo>,</mml:mo><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">Σ</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ3.gif" position="anchor"/></alternatives></disp-formula></p>
      <p id="Par48">Here, <bold>y</bold> = (<italic>y</italic><sub>1</sub>, …, <italic>y</italic><sub><italic>N</italic></sub>) represents a vector of normalized and transformed expression values for gene <italic>g</italic> (omitting the index <italic>g</italic> = 1, . . . , <italic>G</italic> for simplicity) at a set of spatial locations <bold>s</bold> = (<bold>s</bold><sub><bold>1</bold></sub>, …, <bold>s</bold><sub><bold>N</bold></sub>). The spatial locations are assumed to be two-dimensional, but may in principle be generalized to higher dimensions. The <inline-formula id="IEq4"><alternatives><tex-math id="M13">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{\widetilde{{{{{\boldsymbol{{{\Sigma }}}}}}}}}}}({{{{{{{\boldsymbol{\theta }}}}}}}},{\tau }^{2})$$\end{document}</tex-math><mml:math id="M14"><mml:mover accent="true"><mml:mrow><mml:mi mathvariant="bold-italic">Σ</mml:mi></mml:mrow><mml:mo>~</mml:mo></mml:mover><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2023_39748_Article_IEq4.gif"/></alternatives></inline-formula> term represents the NNGP covariance matrix, which provides a scalable (in linear-time and storage) approximation to the covariance matrix <bold>Σ</bold>(<bold><italic>θ</italic></bold>, <italic>τ</italic><sup>2</sup>) = <italic>C</italic>(<bold><italic>θ</italic></bold>) + <italic>τ</italic><sup>2</sup><bold>I</bold> from a full GP model, which scales cubically in the number of spatial locations. The GP covariance matrix <italic>C</italic>(<bold><italic>θ</italic></bold>) = (<italic>C</italic><sub><italic>i</italic><italic>j</italic></sub>(<bold><italic>θ</italic></bold>)) (also referred to as a kernel) captures the spatially correlated variation and is parameterized by a vector of parameters <bold><italic>θ</italic></bold>. We assume an exponential covariance function, based on the observation that the widely used squared exponential function (e.g., used previously in SpatialDE<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>) decays too rapidly with distance in the context of SRT data<sup><xref ref-type="bibr" rid="CR36">36</xref></sup>. The exponential covariance function (or kernel) is defined as:<disp-formula id="Equ4"><label>4</label><alternatives><tex-math id="M15">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${C}_{ij}({{{{{{{\boldsymbol{\theta }}}}}}}})=k({{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{i}}}}}}}}},{{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{j}}}}}}}}})={\sigma }^{2}\exp \left(\frac{-||{{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{i}}}}}}}}}-{{{{{{{{\bf{s}}}}}}}}}_{{{{{{{{\bf{j}}}}}}}}}||}{l}\right)$$\end{document}</tex-math><mml:math id="M16"><mml:msub><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>k</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mi>exp</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mfrac><mml:mrow><mml:mo>−</mml:mo><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">i</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold">j</mml:mi></mml:mrow></mml:msub><mml:mo>∣</mml:mo><mml:mo>∣</mml:mo></mml:mrow><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ4.gif" position="anchor"/></alternatives></disp-formula>with covariance parameters <bold><italic>θ</italic></bold> = (<italic>σ</italic><sup>2</sup>, <italic>l</italic>), and where ∣∣<bold>s</bold><sub><bold>i</bold></sub> − <bold>s</bold><sub><bold>j</bold></sub>∣∣ represents the Euclidean distance between two spatial locations <bold>s</bold><sub><bold>i</bold></sub> and <bold>s</bold><sub><bold>j</bold></sub>. In this parameterization, <italic>σ</italic><sup>2</sup> represents the spatial component of variance, and <italic>l</italic> is referred to as the length scale (or bandwidth) parameter, which controls the strength of decay of correlation with distance. The final parameter <italic>τ</italic><sup>2</sup> in equation (3) is referred to as the nugget, which represents the additional nonspatial component of variance.</p>
      <p id="Par49">Alternatively, the Gaussian process model <bold>y</bold> ~ <italic>N</italic>(<bold>X</bold><bold><italic>β</italic></bold>, <italic>C</italic>(<bold><italic>θ</italic></bold>) + <italic>τ</italic><sup>2</sup><bold>I</bold>) may also be written as:<disp-formula id="Equ5"><label>5</label><alternatives><tex-math id="M17">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$$y({{{{{{{\bf{s}}}}}}}})={m}_{{{{{{{{\boldsymbol{\theta }}}}}}}}}({{{{{{{\bf{s}}}}}}}})+w({{{{{{{\bf{s}}}}}}}})+\epsilon ({{{{{{{\bf{s}}}}}}}}),\qquad \epsilon ({{{{{{{\bf{s}}}}}}}}) \mathop{\sim} \limits^{iid} N \left(0,{\tau }^{2}\right)$$\end{document}</tex-math><mml:math id="M18"><mml:mi>y</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="bold-italic">θ</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mi>w</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mi>ϵ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mspace width="2.0em"/><mml:mi>ϵ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi mathvariant="bold">s</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mover accent="true"><mml:mrow><mml:mo>~</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>i</mml:mi><mml:mi>d</mml:mi></mml:mrow></mml:mover><mml:mi>N</mml:mi><mml:mfenced close=")" open="("><mml:mrow><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ5.gif" position="anchor"/></alternatives></disp-formula>where <italic>w</italic>(<bold>s</bold>) follows a Gaussian process, <italic>w</italic>(<bold>s</bold>) ~ <italic>G</italic><italic>P</italic>(0, <italic>C</italic><sub><bold><italic>θ</italic></bold></sub>(. , . )), and <italic>m</italic><sub><bold><italic>θ</italic></bold></sub>(<bold>s</bold>) = <bold>x</bold>(<bold>s</bold>)<sup>T</sup><bold><italic>β</italic></bold>.</p>
      <p id="Par50">In most applications of nnSVG, we assume an intercept-only model, where <bold>X</bold> = <bold>X</bold><sub>[<italic>N</italic>×1]</sub> = <bold>1</bold><sub>[<italic>N</italic>×1]</sub> and <bold><italic>β</italic></bold> accounts for the mean expression level. In this case, we are interested in identifying genes with any statistically significant spatial correlation in expression.</p>
      <p id="Par51">However, in some datasets, we are also interested in identifying SVGs within spatial domains, i.e., regions of the tissue slide corresponding to anatomical features or tissue types, which have been defined a priori, for example using morphology from histology images, or alternatively using unsupervised clustering. The nnSVG methodology facilitates these types of analyses by allowing the user to provide <bold>X</bold> as an <bold>X</bold><sub>[<italic>N</italic>×<italic>d</italic>]</sub> design matrix containing up to <italic>d</italic> − 1 covariates, with covariate columns consisting of indicator variables for the spatial domains at each spatial location, or other known values per spatial location.</p>
      <p id="Par52">Our key parameter of interest in the model is <italic>σ</italic><sup>2</sup>. We perform model fitting and parameter estimation using the fast optimization algorithms for NNGP models implemented in the BRISC R package<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>, which we use to obtain maximum likelihood parameter estimates for the covariance parameters <bold><italic>θ</italic></bold> = (<italic>σ</italic><sup>2</sup>, <italic>l</italic>) and <italic>τ</italic><sup>2</sup>, as well as the log-likelihoods of the fitted models. The computational complexity of the model fitting is <inline-formula id="IEq5"><alternatives><tex-math id="M19">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\mathcal{O}}}}}}}}(n*{m}^{3})$$\end{document}</tex-math><mml:math id="M20"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">O</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>*</mml:mo><mml:msup><mml:mrow><mml:mi>m</mml:mi></mml:mrow><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:math><inline-graphic xlink:href="41467_2023_39748_Article_IEq5.gif"/></alternatives></inline-formula>, where <italic>n</italic> = number of spatial locations, <italic>m</italic> = number of nearest neighbors, and the initial steps of ordering coordinates and calculating nearest neighbors are performed once only and are re-used for all genes. Note that BRISC also provides the option to obtain precise bootstrap estimates for the parameter estimates, which we do not use here, due to the computational tradeoff when fitting thousands of models (one model per gene) for SRT data.</p>
      <p id="Par53">Within the BRISC algorithm<sup><xref ref-type="bibr" rid="CR32">32</xref></sup>, we use the parameter choices order = “AMMD” (approximate maximum minimum distance ordering of coordinates, see ref. <sup><xref ref-type="bibr" rid="CR47">47</xref></sup> for details) and n.neighbors = 10 (10 nearest neighbors, which has been shown to retain a large proportion of information<sup><xref ref-type="bibr" rid="CR30">30</xref></sup>) as default values, while also allowing the user to adjust these choices. Additional details are provided in the nnSVG and BRISC package documentation.</p>
      <p id="Par54">Next, we perform inference on the estimated <italic>σ</italic><sup>2</sup> parameters per gene, where we test <italic>H</italic><sub>0</sub>: <italic>σ</italic><sup>2</sup> = 0 vs. <italic>H</italic><sub>1</sub>: <italic>σ</italic><sup>2</sup> &gt; 0. We use a likelihood ratio test (LR) for the inference, where we compare the log-likelihood of the fitted model against a classical linear model that assumes <italic>σ</italic><sup>2</sup> = 0 and hence does not account for spatial correlation in the data. We use the estimated LR statistics to generate an overall ranking of SVGs in terms of the strength of their spatial expression patterns. We also calculate approximate <italic>p</italic>-values for statistical significance per gene using an asymptotic <italic>χ</italic><sup>2</sup> distribution with two degrees of freedom (since there are 2 fewer parameters, <bold><italic>θ</italic></bold> = (<italic>σ</italic><sup>2</sup>, <italic>l</italic>) in the simpler model) and apply the Benjamini-Hochberg method<sup><xref ref-type="bibr" rid="CR48">48</xref></sup> to adjust the <italic>p</italic>-values for multiple testing across genes. The user can then select either (i) an arbitrary number of top-ranked SVGs (e.g., top 100 or 1000) for further investigation or to use as the input for downstream analysis methods, analogous to scRNA-seq workflows<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, or (ii) a set of statistically significant SVGs by applying a threshold (e.g., 0.05) to the multiple testing adjusted <italic>p</italic>-values.</p>
      <p id="Par55">Since the nnSVG methodology fits a separate model for each gene, the length scale parameter <italic>l</italic> is estimated individually per gene. This flexibility is the most important reason explaining the improved performance of nnSVG compared to other scalable methods, since the gene-specific length scale parameter allows nnSVG to identify SVGs from distinct biological processes with different spatial ranges in expression within the same tissue slide.</p>
      <p id="Par56">Finally, we also calculate an estimated effect size per gene, defined as the proportion of spatial variance (out of total variance), i.e., the proportion of variance explained by spatial dependencies, as previously defined by ref. <sup><xref ref-type="bibr" rid="CR12">12</xref></sup>:<disp-formula id="Equ6"><label>6</label><alternatives><tex-math id="M21">\documentclass[12pt]{minimal}
				\usepackage{amsmath}
				\usepackage{wasysym} 
				\usepackage{amsfonts} 
				\usepackage{amssymb} 
				\usepackage{amsbsy}
				\usepackage{mathrsfs}
				\usepackage{upgreek}
				\setlength{\oddsidemargin}{-69pt}
				\begin{document}$${{{{{{{\rm{propSV}}}}}}}}=\frac{{\sigma }^{2}}{{\sigma }^{2}+{\tau }^{2}}$$\end{document}</tex-math><mml:math id="M22"><mml:mi mathvariant="normal">propSV</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msup><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mrow><mml:msup><mml:mrow><mml:mi>σ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>+</mml:mo><mml:msup><mml:mrow><mml:mi>τ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mfrac></mml:math><graphic xlink:href="41467_2023_39748_Article_Equ6.gif" position="anchor"/></alternatives></disp-formula></p>
    </sec>
    <sec id="Sec20">
      <title>Computational implementation</title>
      <p id="Par57">nnSVG is implemented as an R package within the Bioconductor<sup><xref ref-type="bibr" rid="CR34">34</xref></sup> framework, using the BRISC R package<sup><xref ref-type="bibr" rid="CR32">32</xref></sup> for model fitting and parameter estimation, and the BiocParallel R package<sup><xref ref-type="bibr" rid="CR49">49</xref></sup> for parallelization. We extended the BRISC package (version 1.0.4) to apply these methods to SRT data, in particular, to extract the fitted log-likelihoods (for the LR tests) and to improve runtime when fitting thousands of models (one per gene) by re-using the ordering of spatial coordinates and calculating nearest neighbors.</p>
      <p id="Par58">The nnSVG package re-uses existing infrastructure for scRNA-seq and SRT data within the Bioconductor framework<sup><xref ref-type="bibr" rid="CR17">17</xref>,<xref ref-type="bibr" rid="CR35">35</xref></sup>, e.g., the SpatialExperiment object structure<sup><xref ref-type="bibr" rid="CR35">35</xref></sup> to load input data and store results, which streamlines integration into existing Bioconductor-based analysis workflows.</p>
    </sec>
    <sec id="Sec21">
      <title>Visium human DLPFC dataset</title>
      <p id="Par59">The Visium human DLPFC dataset consists of a single sample of human brain tissue from the dorsolateral prefrontal cortex (DLPFC) region, measured with the 10x Genomics Visium platform<sup><xref ref-type="bibr" rid="CR50">50</xref></sup>. This dataset was published by Maynard et al.<sup><xref ref-type="bibr" rid="CR8">8</xref></sup> and previously released through the spatialLIBD R/Bioconductor package<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>. The Visium platform measures transcriptome-wide gene expression at a hexagonal grid of spatial locations (referred to as spots) on a tissue slide, with overall dimensions 6.5 mm × 6.5 mm, spots 55 μm in diameter, and 100 μm between spot centers<sup><xref ref-type="bibr" rid="CR50">50</xref></sup>. The dataset used here consists of one biological sample (sample 151673) from one donor, out of the 12 samples (3 donors) in the original study by Maynard et al.<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>. This sample contains transcriptome-wide gene expression measurements at 3639 spots overlapping with the tissue area. We use all 12 samples for the additional multiple-sample analyses. In the original study, spots were manually annotated with labels for the six cortical layers and white matter<sup><xref ref-type="bibr" rid="CR8">8</xref></sup>, which we use as approximate ground truth labels for method evaluation.</p>
    </sec>
    <sec id="Sec22">
      <title>Slide-seqV2 mouse HPC dataset</title>
      <p id="Par60">The Slide-seqV2 mouse HPC dataset consists of gene expression measurements in a tissue sample from the mouse hippocampus (HPC), measured with the Slide-seqV2<sup><xref ref-type="bibr" rid="CR4">4</xref></sup> platform and published by Stickels et al.<sup><xref ref-type="bibr" rid="CR4">4</xref></sup>. Spot-level annotations for cell types were generated computationally by Cable et al.<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>, which we use here to define spatial domains representing anatomical regions within the hippocampus (in particular the region defined by CA3 cell type labels). This dataset consists of a total of 53,208 spatial locations (referred to as beads for this platform), 15,003 of which have been annotated with cell type labels by Cable et al.<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>. In the analyses of this dataset, we are especially interested in genes with spatial gradients of expression within the CA3 region of the hippocampus, which have previously been identified by Cable et al.<sup><xref ref-type="bibr" rid="CR39">39</xref></sup>.</p>
    </sec>
    <sec id="Sec23">
      <title>ST mouse OB dataset</title>
      <p id="Par61">The ST mouse OB dataset was generated by Ståhl et al.<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, consisting of gene expression measurements in the olfactory bulb (OB) region of the mouse brain. This technological platform (Spatial Transcriptomics) was subsequently further developed (e.g., to increase resolution and simplify experimental procedures) by 10x Genomics as the Visium platform. Therefore, ST represents an earlier iteration of the 10x Genomics Visium platform. The ST mouse OB dataset consists of transcriptome-wide gene expression measurements at 260 spatial locations (referred to as spots) after quality control filtering, from a single sample from the original study<sup><xref ref-type="bibr" rid="CR1">1</xref></sup>, and has previously been re-analyzed in several studies including<sup><xref ref-type="bibr" rid="CR12">12</xref></sup>.</p>
    </sec>
    <sec id="Sec24">
      <title>seqFISH mouse embryo dataset</title>
      <p id="Par62">The seqFISH mouse embryo dataset consists of expression measurements of 351 targeted genes within a sagittal tissue section of a mouse embryo from a study investigating mouse organogenesis<sup><xref ref-type="bibr" rid="CR38">38</xref></sup> using the seqFISH platform<sup><xref ref-type="bibr" rid="CR33">33</xref></sup>. The seqFISH platform is a molecule-based SRT platform, which allows individual mRNA molecules to be identified at sub-cellular resolution. In the subset of the data used here, these measurements are summarized at single-cell resolution. The data used here consists of the cells from a single embryo and section (embryo 1, z-slice 2) from the original study<sup><xref ref-type="bibr" rid="CR38">38</xref></sup>.</p>
    </sec>
    <sec id="Sec25">
      <title>Baseline methods</title>
      <p id="Par63">We compared performance against the following baseline methods: (i) highly variable genes (HVGs)<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, (ii) deviance residuals under a binomial model<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>, and (iii) Moran’s I statistic<sup><xref ref-type="bibr" rid="CR21">21</xref></sup>.</p>
      <p id="Par64">HVGs are widely used in scRNA-seq analysis workflows, with implementations provided in the Bioconductor<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>, Seurat<sup><xref ref-type="bibr" rid="CR18">18</xref></sup>, and Scanpy<sup><xref ref-type="bibr" rid="CR19">19</xref></sup> frameworks. Here, we used the standard definition of HVGs from ref. <sup><xref ref-type="bibr" rid="CR17">17</xref></sup> implemented in the modelGeneVar() function in the scran R/Bioconductor package<sup><xref ref-type="bibr" rid="CR46">46</xref></sup>. In this definition, the HVGs methodology fits a mean-variance trend to the log-transformed normalized expression values (logcounts) per gene and ranks genes by excess biological variation, defined as the excess variance above the trend for each gene, under the assumption that the trend represents technical variance<sup><xref ref-type="bibr" rid="CR17">17</xref></sup>. To apply HVGs to SRT data, we calculate the gene-specific means and variances by treating each spot as equivalent to a cell. This method does not make use of any spatial information.</p>
      <p id="Par65">The deviance residuals methodology assumes a binomial model (i.e., count-based instead of log-transforming to continuous values) and ranks genes by the deviance residuals from the fitted binomial models<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>. Compared to HVGs, this approach has been shown to give an improved ranking of genes in scRNA-seq data, and is more theoretically justified due to the use of a count-based model<sup><xref ref-type="bibr" rid="CR20">20</xref></sup>. We apply this method to SRT data by treating each spot as equivalent to a cell. As for HVGs, this method does not make use of any spatial information.</p>
      <p id="Par66">Moran’s I statistic<sup><xref ref-type="bibr" rid="CR21">21</xref></sup> is a standard statistical measure of spatial autocorrelation, which can be calculated from the log-transformed normalized expression values for each gene. Values range from +1 (perfect spatial correlation) to 0 (no spatial correlation) to −1 (perfect spatial anticorrelation). In SRT data, the values for most genes are between 0 and 1, and negative values usually do not have a clear biological meaning. We use Moran’s I statistic to rank genes as SVGs, with the highest values (close to +1) representing the top-ranked SVGs. The Moran’s I formula requires an assumed weights matrix, which we calculate as the inverse squared Euclidean distances between spots, which is consistent with implementations provided in the Seurat workflow<sup><xref ref-type="bibr" rid="CR18">18</xref></sup> and in the 10x Genomics Space Ranger/Loupe software (which also includes truncation at 36 neighbors)<sup><xref ref-type="bibr" rid="CR51">51</xref></sup>. We use the Rfast2 R package<sup><xref ref-type="bibr" rid="CR52">52</xref></sup> to calculate the Moran’s I statistic values.</p>
    </sec>
    <sec id="Sec26">
      <title>Reporting summary</title>
      <p id="Par67">Further information on research design is available in the <xref rid="MOESM3" ref-type="media">Nature Portfolio Reporting Summary</xref> linked to this article.</p>
    </sec>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary information</title>
    <sec id="Sec27">
      <p>
        <supplementary-material content-type="local-data" id="MOESM1">
          <media xlink:href="41467_2023_39748_MOESM1_ESM.pdf">
            <caption>
              <p>Supplementary Information</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM2">
          <media xlink:href="41467_2023_39748_MOESM2_ESM.pdf">
            <caption>
              <p>Peer review file</p>
            </caption>
          </media>
        </supplementary-material>
        <supplementary-material content-type="local-data" id="MOESM3">
          <media xlink:href="41467_2023_39748_MOESM3_ESM.pdf">
            <caption>
              <p>Reporting Summary</p>
            </caption>
          </media>
        </supplementary-material>
      </p>
    </sec>
  </sec>
</body>
<back>
  <fn-group>
    <fn>
      <p><bold>Publisher’s note</bold> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p>
    </fn>
  </fn-group>
  <sec>
    <title>Supplementary information</title>
    <p>The online version contains supplementary material available at 10.1038/s41467-023-39748-z.</p>
  </sec>
  <ack>
    <title>Acknowledgements</title>
    <p>We thank our collaborators at the Lieber Institute for Brain Development for input and feedback on the application of methods to identify SVGs in SRT data and ongoing collaborations which generated the ideas for the methods developed in this manuscript. We also thank the maintainers of the Joint High Performance Computing Exchange (JHPCE) compute cluster at Johns Hopkins Bloomberg School of Public Health for providing essential computing resources. Research reported in this publication was supported by the National Institute of Mental Health (NIMH) of the National Institutes of Health (NIH) under the award number U01MH122849 (S.C.H., L.M.W.), the National Human Genome Research Institute (NHGRI) of the NIH under the award number K99HG012229 (L.M.W.), the National Institute of Environmental Health Sciences (NIEHS) of the NIH under the award R01ES033739 (A.D.), National Science Foundation Division of Mathematical Sciences grant DMS-1915803 (A.D.), and CZF2019-002443 and CZF2018-183446 (S.C.H., K.D.H.) from the Chan Zuckerberg Initiative DAF, an advised fund of Silicon Valley Community Foundation.</p>
  </ack>
  <notes notes-type="author-contribution">
    <title>Author contributions</title>
    <p>L.M.W. developed the nnSVG methodological framework using BRISC and LR tests for SRT data, implemented the nnSVG software package, performed analyses, created figures, and drafted text. A.S. extended the BRISC software package for use within the nnSVG framework, and provided input on the methodological framework, software implementation, and text. A.D. provided advice on the application of NNGP models to SRT data, and provided input on the methodological framework and text. K.D.H. provided input on the methodological framework, software implementation, analyses, figures, and text. S.C.H. supervised the project; provided input on the methodological framework, software implementation, analyses, figures, and text; and drafted text. All authors approved the final manuscript.</p>
  </notes>
  <notes notes-type="peer-review">
    <title>Peer review</title>
    <sec id="FPar1">
      <title>Peer review information</title>
      <p id="Par68"><italic>Nature Communications</italic> thanks Lu Zhang, Alma Andersson and the other, anonymous, reviewer(s) for their contribution to the peer review of this work. A peer review file is available.</p>
    </sec>
  </notes>
  <notes notes-type="data-availability">
    <title>Data availability</title>
    <p>The datasets used for the analyses in this manuscript can be downloaded in SpatialExperiment format<sup><xref ref-type="bibr" rid="CR35">35</xref></sup> from the STexampleData Bioconductor package<sup><xref ref-type="bibr" rid="CR53">53</xref></sup>, which includes annotation labels from the original sources, and the spatialLIBD Bioconductor package<sup><xref ref-type="bibr" rid="CR43">43</xref></sup>. The original datasets and annotations are sourced from refs. <sup><xref ref-type="bibr" rid="CR8">8</xref>,<xref ref-type="bibr" rid="CR43">43</xref></sup> (Visium human DLPFC dataset), refs. <sup><xref ref-type="bibr" rid="CR4">4</xref>,<xref ref-type="bibr" rid="CR39">39</xref></sup> (Slide-seqV2 mouse HPC dataset), ref. <sup><xref ref-type="bibr" rid="CR1">1</xref></sup> (ST mouse OB dataset), and ref. <sup><xref ref-type="bibr" rid="CR38">38</xref></sup> (seqFISH mouse embryo dataset). Source data files to reproduce figures in the manuscript are also available from Figshare at 10.6084/m9.figshare.23561439.v2. All other data supporting the findings of this study are available within the article and its supplementary files. Any additional requests for information can be directed to, and will be fulfilled by, the lead contact.</p>
  </notes>
  <notes notes-type="data-availability">
    <title>Code availability</title>
    <p>nnSVG is freely available as an R package from Bioconductor (as of 2023-06-14: nnSVG version 1.4.1 available in Bioconductor release version 3.17) at <ext-link ext-link-type="uri" xlink:href="https://bioconductor.org/packages/nnSVG">https://bioconductor.org/packages/nnSVG</ext-link>. The package is also available from GitHub at <ext-link ext-link-type="uri" xlink:href="https://github.com/lmweber/nnSVG">https://github.com/lmweber/nnSVG</ext-link>. Code to reproduce all preprocessing, analyses, and figures in this manuscript is available from GitHub at <ext-link ext-link-type="uri" xlink:href="https://github.com/lmweber/nnSVG-analyses">https://github.com/lmweber/nnSVG-analyses</ext-link>. An archived version of this code repository as of the time of publication is also available<sup><xref ref-type="bibr" rid="CR54">54</xref></sup>. We used nnSVG version 1.3.10 for the analyses in this manuscript.</p>
  </notes>
  <notes id="FPar2" notes-type="COI-statement">
    <title>Competing interests</title>
    <p id="Par69">The authors declare no competing interests.</p>
  </notes>
  <ref-list id="Bib1">
    <title>References</title>
    <ref id="CR1">
      <label>1.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ståhl</surname>
            <given-names>PL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Visualization and analysis of gene expression in tissue sections by spatial transcriptomics</article-title>
        <source>Science</source>
        <year>2016</year>
        <volume>353</volume>
        <fpage>78</fpage>
        <lpage>82</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aaf2403</pub-id>
        <?supplied-pmid 27365449?>
        <pub-id pub-id-type="pmid">27365449</pub-id>
      </element-citation>
    </ref>
    <ref id="CR2">
      <label>2.</label>
      <mixed-citation publication-type="other">10x Genomics. <italic>10x Genomics Visium Spatial Gene Expression Solution</italic> (2022).</mixed-citation>
    </ref>
    <ref id="CR3">
      <label>3.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rodriques</surname>
            <given-names>SG</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Slide-seq: a scalable technology for measuring genome-wide expression at high spatial resolution</article-title>
        <source>Science</source>
        <year>2019</year>
        <volume>363</volume>
        <fpage>1463</fpage>
        <lpage>1467</lpage>
        <pub-id pub-id-type="doi">10.1126/science.aaw1219</pub-id>
        <?supplied-pmid 30923225?>
        <pub-id pub-id-type="pmid">30923225</pub-id>
      </element-citation>
    </ref>
    <ref id="CR4">
      <label>4.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Stickels</surname>
            <given-names>RR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Highly sensitive spatial transcriptomics at near-cellular resolution with Slide-seqV2</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2020</year>
        <volume>39</volume>
        <fpage>313</fpage>
        <lpage>319</lpage>
        <pub-id pub-id-type="doi">10.1038/s41587-020-0739-1</pub-id>
        <?supplied-pmid 33288904?>
        <pub-id pub-id-type="pmid">33288904</pub-id>
      </element-citation>
    </ref>
    <ref id="CR5">
      <label>5.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Eng</surname>
            <given-names>C-HL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Transcriptome-scale super-resolved imaging in tissues by RNA seqFISH+</article-title>
        <source>Nature</source>
        <year>2019</year>
        <volume>568</volume>
        <fpage>235</fpage>
        <lpage>239</lpage>
        <pub-id pub-id-type="doi">10.1038/s41586-019-1049-y</pub-id>
        <?supplied-pmid 30911168?>
        <pub-id pub-id-type="pmid">30911168</pub-id>
      </element-citation>
    </ref>
    <ref id="CR6">
      <label>6.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Xia</surname>
            <given-names>C</given-names>
          </name>
          <name>
            <surname>Fan</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Emanuel</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Hao</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Zhuang</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Spatial transcriptome profiling by MERFISH reveals subcellular RNA compartmentalization and cell cycle-dependent gene expression</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2019</year>
        <volume>116</volume>
        <fpage>19490</fpage>
        <lpage>19499</lpage>
        <pub-id pub-id-type="doi">10.1073/pnas.1912459116</pub-id>
        <?supplied-pmid 31501331?>
        <pub-id pub-id-type="pmid">31501331</pub-id>
      </element-citation>
    </ref>
    <ref id="CR7">
      <label>7.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ortiz</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Molecular atlas of the adult mouse brain</article-title>
        <source>Sci. Adv.</source>
        <year>2020</year>
        <volume>6</volume>
        <fpage>eabb3446</fpage>
        <pub-id pub-id-type="doi">10.1126/sciadv.abb3446</pub-id>
        <?supplied-pmid 32637622?>
        <pub-id pub-id-type="pmid">32637622</pub-id>
      </element-citation>
    </ref>
    <ref id="CR8">
      <label>8.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Maynard</surname>
            <given-names>KR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Transcriptome-scale spatial gene expression in the human dorsolateral prefrontal cortex</article-title>
        <source>Nat. Neurosci.</source>
        <year>2021</year>
        <volume>24</volume>
        <fpage>425</fpage>
        <lpage>436</lpage>
        <pub-id pub-id-type="doi">10.1038/s41593-020-00787-0</pub-id>
        <?supplied-pmid 33558695?>
        <pub-id pub-id-type="pmid">33558695</pub-id>
      </element-citation>
    </ref>
    <ref id="CR9">
      <label>9.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Ji</surname>
            <given-names>AL</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Multimodal analysis of composition and spatial architecture in human squamous cell carcinoma</article-title>
        <source>Cell</source>
        <year>2020</year>
        <volume>182</volume>
        <fpage>1661</fpage>
        <lpage>1662</lpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2020.08.043</pub-id>
        <?supplied-pmid 32946785?>
        <pub-id pub-id-type="pmid">32946785</pub-id>
      </element-citation>
    </ref>
    <ref id="CR10">
      <label>10.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Mantri</surname>
            <given-names>M</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Spatiotemporal single-cell RNA sequencing of developing hearts reveals interplay between cellular differentiation and morphogenesis</article-title>
        <source>Nat. Commun.</source>
        <year>2021</year>
        <volume>12</volume>
        <fpage>1771</fpage>
        <pub-id pub-id-type="doi">10.1038/s41467-021-21892-z</pub-id>
        <?supplied-pmid 33741943?>
        <pub-id pub-id-type="pmid">33741943</pub-id>
      </element-citation>
    </ref>
    <ref id="CR11">
      <label>11.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hu</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Statistical and machine learning methods for spatially resolved transcriptomics with histology</article-title>
        <source>Comput. Struct. Biotechnol. J.</source>
        <year>2021</year>
        <volume>19</volume>
        <fpage>3829</fpage>
        <lpage>3841</lpage>
        <pub-id pub-id-type="doi">10.1016/j.csbj.2021.06.052</pub-id>
        <?supplied-pmid 34285782?>
        <pub-id pub-id-type="pmid">34285782</pub-id>
      </element-citation>
    </ref>
    <ref id="CR12">
      <label>12.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Svensson</surname>
            <given-names>V</given-names>
          </name>
          <name>
            <surname>Teichmann</surname>
            <given-names>SA</given-names>
          </name>
          <name>
            <surname>Stegle</surname>
            <given-names>O</given-names>
          </name>
        </person-group>
        <article-title>SpatialDE: identification of spatially variable genes</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>343</fpage>
        <lpage>346</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4636</pub-id>
        <?supplied-pmid 29553579?>
        <pub-id pub-id-type="pmid">29553579</pub-id>
      </element-citation>
    </ref>
    <ref id="CR13">
      <label>13.</label>
      <mixed-citation publication-type="other">Zhao, E. et al. Spatial transcriptomics at subspot resolution with BayesSpace. <italic>Nat. Biotechnol.</italic><bold>39</bold>, 1375–1384 (2021).</mixed-citation>
    </ref>
    <ref id="CR14">
      <label>14.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hu</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>SpaGCN: Integrating gene expression, spatial location and histology to identify spatial domains and spatially variable genes by graph convolutional network</article-title>
        <source>Nat. Methods</source>
        <year>2021</year>
        <volume>18</volume>
        <fpage>1342</fpage>
        <lpage>1351</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-021-01255-8</pub-id>
        <?supplied-pmid 34711970?>
        <pub-id pub-id-type="pmid">34711970</pub-id>
      </element-citation>
    </ref>
    <ref id="CR15">
      <label>15.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Satija</surname>
            <given-names>R</given-names>
          </name>
          <name>
            <surname>Farrell</surname>
            <given-names>JA</given-names>
          </name>
          <name>
            <surname>Gennert</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Schier</surname>
            <given-names>AF</given-names>
          </name>
          <name>
            <surname>Regev</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>Spatial reconstruction of single-cell gene expression data</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2015</year>
        <volume>33</volume>
        <fpage>495</fpage>
        <lpage>502</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.3192</pub-id>
        <?supplied-pmid 25867923?>
        <pub-id pub-id-type="pmid">25867923</pub-id>
      </element-citation>
    </ref>
    <ref id="CR16">
      <label>16.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Achim</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>High-throughput spatial mapping of single-cell RNA-seq data to tissue of origin</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2015</year>
        <volume>33</volume>
        <fpage>503</fpage>
        <lpage>509</lpage>
        <pub-id pub-id-type="doi">10.1038/nbt.3209</pub-id>
        <?supplied-pmid 25867922?>
        <pub-id pub-id-type="pmid">25867922</pub-id>
      </element-citation>
    </ref>
    <ref id="CR17">
      <label>17.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Amezquita</surname>
            <given-names>RA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Orchestrating single-cell analysis with Bioconductor</article-title>
        <source>Nat. Methods</source>
        <year>2019</year>
        <volume>17</volume>
        <fpage>137</fpage>
        <lpage>145</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0654-x</pub-id>
        <?supplied-pmid 31792435?>
        <pub-id pub-id-type="pmid">31792435</pub-id>
      </element-citation>
    </ref>
    <ref id="CR18">
      <label>18.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Hao</surname>
            <given-names>Y</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Integrated analysis of multimodal single-cell data</article-title>
        <source>Cell</source>
        <year>2021</year>
        <volume>184</volume>
        <fpage>3573–3587.e29</fpage>
        <pub-id pub-id-type="doi">10.1016/j.cell.2021.04.048</pub-id>
        <?supplied-pmid 34062119?>
        <pub-id pub-id-type="pmid">34062119</pub-id>
      </element-citation>
    </ref>
    <ref id="CR19">
      <label>19.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Wolf</surname>
            <given-names>FA</given-names>
          </name>
          <name>
            <surname>Angerer</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Theis</surname>
            <given-names>FJ</given-names>
          </name>
        </person-group>
        <article-title>SCANPY: large-scale single-cell gene expression data analysis</article-title>
        <source>Genome Biol.</source>
        <year>2018</year>
        <volume>19</volume>
        <fpage>15</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-017-1382-0</pub-id>
        <?supplied-pmid 29409532?>
        <pub-id pub-id-type="pmid">29409532</pub-id>
      </element-citation>
    </ref>
    <ref id="CR20">
      <label>20.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Townes</surname>
            <given-names>FW</given-names>
          </name>
          <name>
            <surname>Hicks</surname>
            <given-names>SC</given-names>
          </name>
          <name>
            <surname>Aryee</surname>
            <given-names>MJ</given-names>
          </name>
          <name>
            <surname>Irizarry</surname>
            <given-names>RA</given-names>
          </name>
        </person-group>
        <article-title>Feature selection and dimension reduction for single-cell RNA-Seq based on a multinomial model</article-title>
        <source>Genome Biol.</source>
        <year>2019</year>
        <volume>21</volume>
        <fpage>179</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-020-02109-w</pub-id>
      </element-citation>
    </ref>
    <ref id="CR21">
      <label>21.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Moran</surname>
            <given-names>PAP</given-names>
          </name>
        </person-group>
        <article-title>Notes on continuous stochastic phenomena</article-title>
        <source>Biometrika</source>
        <year>1950</year>
        <volume>37</volume>
        <fpage>17</fpage>
        <lpage>23</lpage>
        <pub-id pub-id-type="doi">10.1093/biomet/37.1-2.17</pub-id>
        <?supplied-pmid 15420245?>
        <pub-id pub-id-type="pmid">15420245</pub-id>
      </element-citation>
    </ref>
    <ref id="CR22">
      <label>22.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Geary</surname>
            <given-names>RC</given-names>
          </name>
        </person-group>
        <article-title>The contiguity ratio and statistical mapping</article-title>
        <source>Incorporated Statistician</source>
        <year>1954</year>
        <volume>5</volume>
        <fpage>115</fpage>
        <lpage>146</lpage>
        <pub-id pub-id-type="doi">10.2307/2986645</pub-id>
      </element-citation>
    </ref>
    <ref id="CR23">
      <label>23.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Edsgärd</surname>
            <given-names>D</given-names>
          </name>
          <name>
            <surname>Johnsson</surname>
            <given-names>P</given-names>
          </name>
          <name>
            <surname>Sandberg</surname>
            <given-names>R</given-names>
          </name>
        </person-group>
        <article-title>Identification of spatial expression trends in single-cell gene expression data</article-title>
        <source>Nat. Methods</source>
        <year>2018</year>
        <volume>15</volume>
        <fpage>339</fpage>
        <lpage>342</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.4634</pub-id>
        <?supplied-pmid 29553578?>
        <pub-id pub-id-type="pmid">29553578</pub-id>
      </element-citation>
    </ref>
    <ref id="CR24">
      <label>24.</label>
      <mixed-citation publication-type="other">Kats, I., Vento-Tormo, R. &amp; Stegle, O. SpatialDE2: fast and localized variance component analysis of spatial transcriptomics. Preprint at <italic>bioRxiv</italic>10.1101/2021.10.27.466045 (2021).</mixed-citation>
    </ref>
    <ref id="CR25">
      <label>25.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Sun</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Zhu</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Zhou</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>Statistical analysis of spatial expression patterns for spatially resolved transcriptomic studies</article-title>
        <source>Nat. Methods</source>
        <year>2020</year>
        <volume>17</volume>
        <fpage>193</fpage>
        <lpage>200</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-019-0701-7</pub-id>
        <?supplied-pmid 31988518?>
        <pub-id pub-id-type="pmid">31988518</pub-id>
      </element-citation>
    </ref>
    <ref id="CR26">
      <label>26.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>Q</given-names>
          </name>
          <name>
            <surname>Zhang</surname>
            <given-names>M</given-names>
          </name>
          <name>
            <surname>Xie</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Xiao</surname>
            <given-names>G</given-names>
          </name>
        </person-group>
        <article-title>Bayesian modeling of spatial molecular profiling data via Gaussian process</article-title>
        <source>Bioinformatics</source>
        <year>2021</year>
        <volume>37</volume>
        <fpage>4129</fpage>
        <lpage>4136</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btab455</pub-id>
        <?supplied-pmid 34146105?>
        <pub-id pub-id-type="pmid">34146105</pub-id>
      </element-citation>
    </ref>
    <ref id="CR27">
      <label>27.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Zhu</surname>
            <given-names>J</given-names>
          </name>
          <name>
            <surname>Sun</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Zhou</surname>
            <given-names>X</given-names>
          </name>
        </person-group>
        <article-title>SPARK-X: non-parametric modeling enables scalable and robust detection of spatial expression patterns for large spatial transcriptomic studies</article-title>
        <source>Genome Biol.</source>
        <year>2021</year>
        <volume>22</volume>
        <fpage>184</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-021-02404-0</pub-id>
        <?supplied-pmid 34154649?>
        <pub-id pub-id-type="pmid">34154649</pub-id>
      </element-citation>
    </ref>
    <ref id="CR28">
      <label>28.</label>
      <mixed-citation publication-type="other">Miller, B. F., Bambah-Mukku, D., Dulac, C., Zhuang, X. &amp; Fan, J. Characterizing spatial gene expression heterogeneity in spatially resolved single-cell transcriptomics data with nonuniform cellular densities. <italic>Genome Res.</italic><bold>31</bold>, 1843–1855 (2021).</mixed-citation>
    </ref>
    <ref id="CR29">
      <label>29.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Dries</surname>
            <given-names>R</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Giotto: a toolbox for integrative analysis and visualization of spatial expression data</article-title>
        <source>Genome Biol.</source>
        <year>2021</year>
        <volume>22</volume>
        <fpage>78</fpage>
        <pub-id pub-id-type="doi">10.1186/s13059-021-02286-2</pub-id>
        <?supplied-pmid 33685491?>
        <pub-id pub-id-type="pmid">33685491</pub-id>
      </element-citation>
    </ref>
    <ref id="CR30">
      <label>30.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Datta</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Banerjee</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Finley</surname>
            <given-names>AO</given-names>
          </name>
          <name>
            <surname>Gelfand</surname>
            <given-names>AE</given-names>
          </name>
        </person-group>
        <article-title>Hierarchical nearest-neighbor Gaussian process models for large geostatistical datasets</article-title>
        <source>J. Am. Stat. Assoc.</source>
        <year>2016</year>
        <volume>111</volume>
        <fpage>800</fpage>
        <lpage>812</lpage>
        <pub-id pub-id-type="doi">10.1080/01621459.2015.1044091</pub-id>
        <?supplied-pmid 29720777?>
        <pub-id pub-id-type="pmid">29720777</pub-id>
      </element-citation>
    </ref>
    <ref id="CR31">
      <label>31.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Finley</surname>
            <given-names>AO</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Efficient algorithms for Bayesian nearest neighbor Gaussian processes</article-title>
        <source>J. Comput. Graph. Stat.</source>
        <year>2019</year>
        <volume>28</volume>
        <fpage>401</fpage>
        <lpage>414</lpage>
        <pub-id pub-id-type="doi">10.1080/10618600.2018.1537924</pub-id>
        <?supplied-pmid 31543693?>
        <pub-id pub-id-type="pmid">31543693</pub-id>
      </element-citation>
    </ref>
    <ref id="CR32">
      <label>32.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Saha</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Datta</surname>
            <given-names>A</given-names>
          </name>
        </person-group>
        <article-title>BRISC: bootstrap for rapid inference on spatial covariances</article-title>
        <source>Stat</source>
        <year>2018</year>
        <volume>7</volume>
        <fpage>e184</fpage>
        <pub-id pub-id-type="doi">10.1002/sta4.184</pub-id>
      </element-citation>
    </ref>
    <ref id="CR33">
      <label>33.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Shah</surname>
            <given-names>S</given-names>
          </name>
          <name>
            <surname>Lubeck</surname>
            <given-names>E</given-names>
          </name>
          <name>
            <surname>Zhou</surname>
            <given-names>W</given-names>
          </name>
          <name>
            <surname>Cai</surname>
            <given-names>L</given-names>
          </name>
        </person-group>
        <article-title>In situ transcription profiling of single cells reveals spatial organization of cells in the mouse hippocampus</article-title>
        <source>Neuron</source>
        <year>2016</year>
        <volume>92</volume>
        <fpage>342</fpage>
        <lpage>357</lpage>
        <pub-id pub-id-type="doi">10.1016/j.neuron.2016.10.001</pub-id>
        <?supplied-pmid 27764670?>
        <pub-id pub-id-type="pmid">27764670</pub-id>
      </element-citation>
    </ref>
    <ref id="CR34">
      <label>34.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Huber</surname>
            <given-names>W</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Orchestrating high-throughput genomic analysis with Bioconductor</article-title>
        <source>Nat. Methods</source>
        <year>2015</year>
        <volume>12</volume>
        <fpage>115</fpage>
        <lpage>121</lpage>
        <pub-id pub-id-type="doi">10.1038/nmeth.3252</pub-id>
        <?supplied-pmid 25633503?>
        <pub-id pub-id-type="pmid">25633503</pub-id>
      </element-citation>
    </ref>
    <ref id="CR35">
      <label>35.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Righelli</surname>
            <given-names>D</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>SpatialExperiment: infrastructure for spatially resolved transcriptomics data in R using Bioconductor</article-title>
        <source>Bioinformatics</source>
        <year>2022</year>
        <volume>38</volume>
        <fpage>3128</fpage>
        <lpage>3131</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btac299</pub-id>
        <?supplied-pmid 35482478?>
        <pub-id pub-id-type="pmid">35482478</pub-id>
      </element-citation>
    </ref>
    <ref id="CR36">
      <label>36.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Townes</surname>
            <given-names>FW</given-names>
          </name>
          <name>
            <surname>Engelhardt</surname>
            <given-names>BE</given-names>
          </name>
        </person-group>
        <article-title>Nonnegative spatial factorization applied to spatial genomics</article-title>
        <source>Nat. Methods</source>
        <year>2022</year>
        <volume>20</volume>
        <fpage>229</fpage>
        <lpage>238</lpage>
        <pub-id pub-id-type="doi">10.1038/s41592-022-01687-w</pub-id>
        <?supplied-pmid 36587187?>
        <pub-id pub-id-type="pmid">36587187</pub-id>
      </element-citation>
    </ref>
    <ref id="CR37">
      <label>37.</label>
      <mixed-citation publication-type="other">10x Genomics. <italic>Visium Spatial Proteomics</italic> (2022).</mixed-citation>
    </ref>
    <ref id="CR38">
      <label>38.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lohoff</surname>
            <given-names>T</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Integration of spatial and single-cell transcriptomic data elucidates mouse organogenesis</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2021</year>
        <volume>1</volume>
        <fpage>1</fpage>
      </element-citation>
    </ref>
    <ref id="CR39">
      <label>39.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Cable</surname>
            <given-names>DM</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Robust decomposition of cell type mixtures in spatial transcriptomics</article-title>
        <source>Nat. Biotechnol.</source>
        <year>2021</year>
        <volume>1</volume>
        <fpage>1</fpage>
      </element-citation>
    </ref>
    <ref id="CR40">
      <label>40.</label>
      <mixed-citation publication-type="other">Li, Y. et al. Benchmarking computational integration methods for spatial transcriptomics data. Preprint at <italic>bioRxiv</italic>10.1101/2021.08.27.457741 (2022).</mixed-citation>
    </ref>
    <ref id="CR41">
      <label>41.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Andersson</surname>
            <given-names>A</given-names>
          </name>
          <name>
            <surname>Lundeberg</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>sepal: Identifying transcript profiles with spatial patterns by diffusion-based modeling</article-title>
        <source>Bioinformatics</source>
        <year>2021</year>
        <volume>37</volume>
        <fpage>2644</fpage>
        <lpage>2650</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btab164</pub-id>
        <?supplied-pmid 33704427?>
        <pub-id pub-id-type="pmid">33704427</pub-id>
      </element-citation>
    </ref>
    <ref id="CR42">
      <label>42.</label>
      <mixed-citation publication-type="other">Corso, D., Malfait, M., Moses, L. &amp; Sales, G. spatialDE: R wrapper for SpatialDE. <italic>R/Bioconductor package</italic> (2023).</mixed-citation>
    </ref>
    <ref id="CR43">
      <label>43.</label>
      <mixed-citation publication-type="other">Pardo, B. et al. spatialLIBD: an R/Bioconductor package to visualize spatially-resolved transcriptomics data. <italic>BMC Genom.</italic><bold>23</bold>, 434 (2022).</mixed-citation>
    </ref>
    <ref id="CR44">
      <label>44.</label>
      <mixed-citation publication-type="other">Weber, L. M. et al. The gene expression landscape of the human locus coeruleus revealed by single-nucleus and spatially-resolved transcriptomics. <italic>eLife</italic><bold>12</bold>, 10.7554/eLife.84628.1 (2023).</mixed-citation>
    </ref>
    <ref id="CR45">
      <label>45.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>McCarthy</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Campbell</surname>
            <given-names>KR</given-names>
          </name>
          <name>
            <surname>Lun</surname>
            <given-names>ATL</given-names>
          </name>
          <name>
            <surname>Wills</surname>
            <given-names>QF</given-names>
          </name>
        </person-group>
        <article-title>Scater: pre-processing, quality control, normalization and visualization of single-cell RNA-seq data in R</article-title>
        <source>Bioinformatics</source>
        <year>2017</year>
        <volume>33</volume>
        <fpage>1179</fpage>
        <lpage>1186</lpage>
        <pub-id pub-id-type="doi">10.1093/bioinformatics/btw777</pub-id>
        <?supplied-pmid 28088763?>
        <pub-id pub-id-type="pmid">28088763</pub-id>
      </element-citation>
    </ref>
    <ref id="CR46">
      <label>46.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Lun</surname>
            <given-names>ATL</given-names>
          </name>
          <name>
            <surname>McCarthy</surname>
            <given-names>DJ</given-names>
          </name>
          <name>
            <surname>Marioni</surname>
            <given-names>JC</given-names>
          </name>
        </person-group>
        <article-title>A step-by-step workflow for low-level analysis of single-cell RNA-seq data with Bioconductor</article-title>
        <source>F1000Research</source>
        <year>2016</year>
        <volume>5</volume>
        <fpage>2122</fpage>
        <?supplied-pmid 27909575?>
        <pub-id pub-id-type="pmid">27909575</pub-id>
      </element-citation>
    </ref>
    <ref id="CR47">
      <label>47.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Guinness</surname>
            <given-names>J</given-names>
          </name>
        </person-group>
        <article-title>Permutation and grouping methods for sharpening Gaussian process approximations</article-title>
        <source>Technometrics</source>
        <year>2018</year>
        <volume>60</volume>
        <fpage>415</fpage>
        <lpage>429</lpage>
        <pub-id pub-id-type="doi">10.1080/00401706.2018.1437476</pub-id>
        <?supplied-pmid 31447491?>
        <pub-id pub-id-type="pmid">31447491</pub-id>
      </element-citation>
    </ref>
    <ref id="CR48">
      <label>48.</label>
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Benjamini</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Hochberg</surname>
            <given-names>Y</given-names>
          </name>
        </person-group>
        <article-title>Controlling the false discovery rate: a practical and powerful approach to multiple testing</article-title>
        <source>J. R. Stat. Soc.</source>
        <year>1995</year>
        <volume>57</volume>
        <fpage>289</fpage>
        <lpage>300</lpage>
      </element-citation>
    </ref>
    <ref id="CR49">
      <label>49.</label>
      <mixed-citation publication-type="other">Morgan, M. et al. BiocParallel: Bioconductor facilities for parallel evaluation. <italic>R/Bioconductor package</italic> (2023).</mixed-citation>
    </ref>
    <ref id="CR50">
      <label>50.</label>
      <mixed-citation publication-type="other">10x Genomics. <italic>Spatial Gene Expression Datasets</italic> (2022).</mixed-citation>
    </ref>
    <ref id="CR51">
      <label>51.</label>
      <mixed-citation publication-type="other">10x Genomics. <italic>Space Ranger: Spatial Gene Expression</italic> (2022).</mixed-citation>
    </ref>
    <ref id="CR52">
      <label>52.</label>
      <mixed-citation publication-type="other">Papadakis, M., Tsagris, M., Fafalios, S. &amp; Dimitriadis, M. Rfast2: a collection of efficient and extremely fast R functions II. <italic>R package</italic> (2023).</mixed-citation>
    </ref>
    <ref id="CR53">
      <label>53.</label>
      <mixed-citation publication-type="other">Weber, L. M. STexampleData. <italic>R/Bioconductor package</italic> (2023).</mixed-citation>
    </ref>
    <ref id="CR54">
      <label>54.</label>
      <mixed-citation publication-type="other">Weber, L. M. nnSVG-analyses; version 1.0.0. 10.5281/zenodo.8040654. <italic>GitHub Repository</italic> (2023).</mixed-citation>
    </ref>
  </ref-list>
</back>
