<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD Journal Publishing DTD v2.3 20070202//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName journalpublishing.dtd?>
<?SourceDTD.Version 2.3?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 2?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">Bioinformatics</journal-id>
    <journal-id journal-id-type="publisher-id">bioinformatics</journal-id>
    <journal-id journal-id-type="hwp">bioinfo</journal-id>
    <journal-title-group>
      <journal-title>Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1367-4803</issn>
    <issn pub-type="epub">1367-4811</issn>
    <publisher>
      <publisher-name>Oxford University Press</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">4230234</article-id>
    <article-id pub-id-type="pmid">24845653</article-id>
    <article-id pub-id-type="doi">10.1093/bioinformatics/btu340</article-id>
    <article-id pub-id-type="publisher-id">btu340</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Original Papers</subject>
        <subj-group subj-group-type="heading">
          <subject>Data and Text Mining</subject>
        </subj-group>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>Exploration and retrieval of whole-metagenome sequencing samples</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Seth</surname>
          <given-names>Sohan</given-names>
        </name>
        <xref ref-type="aff" rid="btu340-AFF1">
          <sup>1</sup>
        </xref>
        <xref ref-type="corresp" rid="btu340-COR1">*</xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Välimäki</surname>
          <given-names>Niko</given-names>
        </name>
        <xref ref-type="aff" rid="btu340-AFF1">
          <sup>2</sup>
        </xref>
        <xref ref-type="aff" rid="btu340-AFF1">
          <sup>3</sup>
        </xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Kaski</surname>
          <given-names>Samuel</given-names>
        </name>
        <xref ref-type="aff" rid="btu340-AFF1">
          <sup>1</sup>
        </xref>
        <xref ref-type="aff" rid="btu340-AFF1">
          <sup>3</sup>
        </xref>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Honkela</surname>
          <given-names>Antti</given-names>
        </name>
        <xref ref-type="aff" rid="btu340-AFF1">
          <sup>3</sup>
        </xref>
        <xref ref-type="corresp" rid="btu340-COR1">*</xref>
      </contrib>
      <aff id="btu340-AFF1"><sup>1</sup>Helsinki Institute for Information Technology HIIT, Department of Information and Computer Science, Aalto University, Espoo, Finland, <sup>2</sup>Genome-Scale Biology Program and Department of Medical Genetics, University of Helsinki, Helsinki, Finland, and <sup>3</sup>Helsinki Institute for Information Technology HIIT, Department of Computer Science, University of Helsinki, Helsinki, Finland</aff>
    </contrib-group>
    <author-notes>
      <corresp id="btu340-COR1">*To whom correspondence should be addressed.</corresp>
      <fn id="FN1">
        <p>Associate Editor: Jonathan Wren</p>
      </fn>
    </author-notes>
    <pub-date pub-type="ppub">
      <day>01</day>
      <month>9</month>
      <year>2014</year>
    </pub-date>
    <pub-date pub-type="epub">
      <day>19</day>
      <month>5</month>
      <year>2014</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>19</day>
      <month>5</month>
      <year>2014</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on the
							<pub-date pub-type="epub"/>. -->
    <volume>30</volume>
    <issue>17</issue>
    <fpage>2471</fpage>
    <lpage>2479</lpage>
    <history>
      <date date-type="received">
        <day>13</day>
        <month>11</month>
        <year>2013</year>
      </date>
      <date date-type="rev-recd">
        <day>30</day>
        <month>4</month>
        <year>2014</year>
      </date>
      <date date-type="accepted">
        <day>11</day>
        <month>5</month>
        <year>2014</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author 2014. Published by Oxford University Press.</copyright-statement>
      <copyright-year>2014</copyright-year>
      <license license-type="creative-commons" xlink:href="http://creativecommons.org/licenses/by/3.0/">
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<uri xlink:type="simple" xlink:href="http://creativecommons.org/licenses/by/3.0/">http://creativecommons.org/licenses/by/3.0/</uri>), which permits unrestricted reuse, distribution, and reproduction in any medium, provided the original work is properly cited.</license-p>
      </license>
    </permissions>
    <abstract>
      <p><bold>Motivation:</bold> Over the recent years, the field of whole-metagenome shotgun sequencing has witnessed significant growth owing to the high-throughput sequencing technologies that allow sequencing genomic samples cheaper, faster and with better coverage than before. This technical advancement has initiated the trend of sequencing multiple samples in different conditions or environments to explore the similarities and dissimilarities of the microbial communities. Examples include the human microbiome project and various studies of the human intestinal tract. With the availability of ever larger databases of such measurements, finding samples similar to a given query sample is becoming a central operation.</p>
      <p><bold>Results:</bold> In this article, we develop a content-based exploration and retrieval method for whole-metagenome sequencing samples. We apply a distributed string mining framework to efficiently extract all informative sequence <italic>k</italic>-mers from a pool of metagenomic samples and use them to measure the dissimilarity between two samples. We evaluate the performance of the proposed approach on two human gut metagenome datasets as well as human microbiome project metagenomic samples. We observe significant enrichment for diseased gut samples in results of queries with another diseased sample and high accuracy in discriminating between different body sites even though the method is unsupervised.</p>
      <p><bold>Availability and implementation:</bold> A software implementation of the DSM framework is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/HIITMetagenomics/dsm-framework">https://github.com/HIITMetagenomics/dsm-framework</ext-link>.</p>
      <p><bold>Contact:</bold><email>sohan.seth@hiit.fi</email> or <email>antti.honkela@hiit.fi</email></p>
      <p><bold>Supplementary information:</bold><ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu340/-/DC1">Supplementary data</ext-link> are available at <italic>Bioinformatics</italic> online.</p>
    </abstract>
    <counts>
      <page-count count="9"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec>
    <title>1 INTRODUCTION</title>
    <p>Metagenomics is the study of microbial communities in their natural habitat using genomics techniques (<xref rid="btu340-B28" ref-type="bibr">Tyson <italic>et al.</italic>, 2004</xref>). It is undergoing a boom owing to the proliferation of high-throughput sequencing technologies. Many studies focus at targeted sequencing of specific marker genes such as the 16S rRNA gene in bacteria, but recently there has been a growing interest in whole-metagenome sequencing (e.g. <xref rid="btu340-B6" ref-type="bibr">Human Microbiome Project Consortium, 2012</xref>; <xref rid="btu340-B19" ref-type="bibr">Qin <italic>et al.</italic>, 2010</xref>). Although targeted studies provide data for phylogenetic profiling at a lower cost, whole metagenomes provide much more information, for example, about the collective metabolism (<xref rid="btu340-B5" ref-type="bibr">Greenblum <italic>et al.</italic>, 2012</xref>) and the population genetics of the community (<xref rid="btu340-B23" ref-type="bibr">Schloissnig <italic>et al.</italic>, 2013</xref>). Recent studies have also found associations between features of whole human gut metagenomes and type II diabetes (<xref rid="btu340-B20" ref-type="bibr">Qin <italic>et al.</italic>, 2012</xref>). New data are accumulating rapidly, with a popular web-based MG-RAST server (<xref rid="btu340-B15" ref-type="bibr">Meyer <italic>et al.</italic>, 2008</xref>) listing almost 3000 public whole metagenomes.</p>
    <p>Analyzing whole-metagenome shotgun (WMS) sequencing data is very challenging. The original sample typically contains genetic material from hundreds to thousands of bacterial species of different abundances (<xref rid="btu340-B10" ref-type="bibr">Li <italic>et al.</italic>, 2012</xref>), most of which have not been fully sequenced previously. After sequencing, we obtain a huge collection of short sequence reads whose species of origin is unknown. Although significant progress has been made, analysis relying on either the limited previously annotated genomes, or assembling the reads into novel more complete genomes, remains difficult and inefficient, and potentially susceptible to annotation biases.</p>
    <p>In this article, we introduce an efficient purely data-driven feature extraction and selection method as well as similarity measures for WMS sequencing datasets, and apply them in retrieval of similar datasets. Such content-based retrieval is an extremely powerful tool for exploration of the data and generating hypotheses of disease associations, as previously demonstrated with gene expression data (<xref rid="btu340-B2" ref-type="bibr">Caldas <italic>et al.</italic>, 2009</xref>, <xref rid="btu340-B3" ref-type="bibr">2012</xref>). Retrieval from existing databases makes it possible to automatically explore a much greater variety of hypotheses than relying solely on the more common specifically designed focused studies.</p>
    <p>Content-based similarity measures and retrieval of similar metagenomic datasets have been suggested previously (<xref rid="btu340-B7" ref-type="bibr">Jiang <italic>et al.</italic>, 2012</xref>; <xref rid="btu340-B11" ref-type="bibr">Liu <italic>et al.</italic>, 2011</xref>; <xref rid="btu340-B17" ref-type="bibr">Mitra <italic>et al.</italic>, 2009</xref>; <xref rid="btu340-B27" ref-type="bibr">Su <italic>et al.</italic>, 2012</xref>), based on quantifying abundances over a relatively small number of predetermined features requiring existing annotation. Up to some thousands of known taxa, genes or metabolic pathways have been used. We introduce similarity measures that are based solely on raw sequencing reads, and hence, unbiased and insensitive to the quality of the existing annotation. A similar measure has been previously suggested by <xref rid="btu340-B12" ref-type="bibr">Maillet <italic>et al.</italic> (2012)</xref>, but only for pairwise comparisons using a method that is computationally too expensive to scale to even modestly large datasets. Furthermore, instead of considering all sequences of particular length, also known as <italic>k</italic>-mers, as has been done earlier for other tasks and by <xref rid="btu340-B12" ref-type="bibr">Maillet <italic>et al.</italic> (2012)</xref>, we employ an efficient distributed string mining (DSM) algorithm to find informative subsequences that can be of <italic>any</italic> length.</p>
    <p>To deal with the large number of features, some feature selection is necessary. Previous approaches for detecting relevant features in metagenomic data have been based on direct comparison of two classes of samples. Again, most of these methods work on up to some thousands of features (<xref rid="btu340-B18" ref-type="bibr">Parks and Beiko, 2010</xref>; <xref rid="btu340-B24" ref-type="bibr">Segata <italic>et al.</italic>, 2011</xref>; <xref rid="btu340-B30" ref-type="bibr">White <italic>et al.</italic>, 2009</xref>), with the notable exception of one study (<xref rid="btu340-B20" ref-type="bibr">Qin <italic>et al.</italic>, 2012</xref>) where quantification and association testing was done for &gt;4.3 million predefined genes. Without feature selection, one can use short <italic>k</italic>-mers (<xref rid="btu340-B1" ref-type="bibr">Baran and Halperin, 2012</xref>) or limit to a set of <italic>k</italic>-mers that are likely to be informative, such as <italic>k</italic>-mers associated with well-characterised protein families (<xref rid="btu340-B4" ref-type="bibr">Edwards <italic>et al.</italic>, 2012</xref>). Although there are no previous examples of unsupervised feature selection for metagenomics, it is a common practice in information retrieval with text documents (<xref rid="btu340-B31" ref-type="bibr">Yang and Pedersen, 1997</xref>); a particularly relevant method assesses the entropy of the distribution of documents in which a specific term occurs (<xref rid="btu340-B9" ref-type="bibr">Largeron <italic>et al.</italic>, 2011</xref>).</p>
    <p>We evaluate the performance of the proposed unsupervised, unconstrained retrieval method on synthetic data, as well as metagenomic samples from human body sites (<xref rid="btu340-B6" ref-type="bibr">Human Microbiome Project Consortium, 2012</xref>; <xref rid="btu340-B19" ref-type="bibr">Qin <italic>et al.</italic>, 2010</xref>, <xref rid="btu340-B20" ref-type="bibr">2012</xref>). To evaluate the performance of the retrieval engine, we use external validation based on a ground truth similarity between two samples. To simplify this process, we consider a binary similarity, which is crude but easily accessible. The human gut samples in (<xref rid="btu340-B19" ref-type="bibr">Qin <italic>et al.</italic>, 2010</xref>, <xref rid="btu340-B20" ref-type="bibr">2012</xref>) come from studies exploring the change in bacterial species composition between healthy persons and either inflammatory bowel disease (IBD) or type II diabetes. We utilize disease state to construct a binary ground truth. Thus, we study if, given the metagenomic sample of a person with a disease, the retrieval finds metagenomic samples related by having the same disease. In the body site data (<xref rid="btu340-B6" ref-type="bibr">Human Microbiome Project Consortium, 2012</xref>), we use the body sites as ground truth to investigate whether it is possible to identify the bacterial communities at different body sites in an unsupervised setting without the need of reference genomes. It should be noted that especially for the gut data, two samples may be related in other ways too. The external validation with one simple ground truth nonetheless provides an objective platform for comparing different methods. Given that the method is unsupervised and hence completely oblivious of the disease labels, if such retrieval is successful, it is a promising starting point for developing methods for leveraging data from earlier patients in early detection of disease and personalized medicine.</p>
  </sec>
  <sec id="SEC2">
    <title>2 APPROACH</title>
    <p>Our objective is to extract and select suitable features for representing WMS sequencing samples and to form a pairwise dissimilarity measure for a collection of such samples. Given this dissimilarity, one can query with a sample and retrieve other samples that are similar to it (<xref ref-type="fig" rid="btu340-F1">Fig. 1</xref>). The measure needs to be reasonably rapidly computable, yet captures relevant differences between the samples, and does all this with as little prior biological knowledge and annotations as possible, as detailed quantitative prior knowledge is typically not yet available for metagenomics.
<fig id="btu340-F1" position="float"><label>Fig. 1.</label><caption><p>Given a set of metagenomic samples, our objective is to be able to retrieve relevant samples to a query sample. For this, we need to extract relevant features and evaluate a pairwise similarity (or dissimilarity) measure. The samples are then ranked in the order of increasing dissimilarity from the query</p></caption><graphic xlink:href="btu340f1p"/></fig></p>
    <p>Evaluating dissimilarity requires representing the metagenomic sample in a suitable feature space. A standard choice for representing objects over strings is to estimate the <italic>k</italic>-mer frequency values, where a <italic>k</italic>-mer here is a string of <italic>k</italic> letters from the DNA alphabet {A,C,T,G}. Therefore, there are 4<italic><sup>k</sup></italic> possible <italic>k</italic>-mers for any given <italic>k</italic>. It is a standard practice to set <italic>k</italic> to a specific value, typically a small value to keep the estimation problem tractable both computationally and statistically. A larger <italic>k</italic> would give better discriminability but not without bounds, as for finite dataset sizes there simply are not enough data to estimate long <italic>k</italic>-mers. We argue that instead of setting <italic>k</italic> to a particular value, it is more effective to estimate all possible <italic>k</italic>-mers for all possible <italic>k</italic> which the data supports. This makes the problem more challenging, as the number of such observed different <italic>k</italic>-mers for large <italic>k</italic> becomes very large, and they become more susceptible to sequencing errors. Focusing on <italic>k</italic>-mers appearing more than once in a sample helps significantly because it is relatively rare to have the exactly same sequencing errors in two independent reads.</p>
    <p>To make the method computationally efficient, we treat each <italic>k</italic>-mer as an independent feature. We compute a Bayesian estimate of their relative frequencies across samples. The employed prior helps in suppressing noise caused by small observed read counts. In the <italic>filtering</italic> step, the abundance distribution of each <italic>k</italic>-mer over samples is used to judge informativeness of the <italic>k</italic>-mer for retrieval; a <italic>k</italic>-mer with constant abundance does not have discriminative power and, in the other extreme, a <italic>k</italic>-mer which is present in only one sample cannot generalize over samples. We show that the filtering step significantly improves the retrieval performance with most datasets and distance measures. Finally, we compute the dissimilarity between two samples across the features as a weighted average of distances between relative frequencies of individual <italic>k</italic>-mers. Treating each <italic>k</italic>-mer as an independent feature allows us to execute these steps fast and on the fly without storing the intermediate results. Such simplified distance measures are necessary to guarantee scalability given the extremely high dimensionality of the <italic>k</italic>-mer features.</p>
    <p>To summarize, we introduce methods to (i) estimate the frequencies of a large number of <italic>k</italic>-mers over multiple samples, (ii) decide if a <italic>k</italic>-mer is informative or uninformative in the context of a retrieval task, (iii) compute a distance metric using the filtered <italic>k</italic>-mer frequencies, and (iv) execute these steps fast without explicitly storing the frequency values. <xref ref-type="fig" rid="btu340-F2">Figure 2</xref> summarizes the method.
<fig id="btu340-F2" position="float"><label>Fig. 2.</label><caption><p>Processing steps of our method. Given a collection of metagenomic samples, we use the collection as an input to the DSM method (4). For the method, we estimate the frequency of each <italic>k</italic>-mer <xref ref-type="disp-formula" rid="btu340-M1">(1</xref>, <xref ref-type="disp-formula" rid="btu340-M2">2)</xref>, evaluate if the <italic>k</italic>-mer is informative or not <xref ref-type="disp-formula" rid="btu340-M3">(3)</xref>, and compute the needed dissimilarities (5). Finally, in this article we evaluate the performance considering the existing annotations as ground truth; annotations are not needed for the retrieval in general</p></caption><graphic xlink:href="btu340f2p"/></fig></p>
  </sec>
  <sec>
    <title>3 METHODS</title>
    <sec id="SEC3.1">
      <title>3.1 Estimating <italic>k</italic>-mer frequencies: normalization, regularization and filtering</title>
      <p>To perform the feature selection or filtering, we first compute Bayesian estimates of the relative frequencies <inline-formula><mml:math id="I1"><mml:mrow><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> of each <italic>k</italic>-mer <italic>w</italic> over samples <inline-formula><mml:math id="I2"><mml:mrow><mml:mi>s</mml:mi><mml:mo>∈</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:math></inline-formula> using observed frequencies <inline-formula><mml:math id="I3"><mml:mrow><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> of the <italic>k</italic>-mers. These are distributions over samples for each <italic>k</italic>-mer that are computed independently for each <italic>k</italic>-mer for reasons of computational efficiency.</p>
      <p>Even if the relative abundance of a <italic>k</italic>-mer is the same in every sample, the observed frequencies may differ because of different sequencing depth or coverage in different samples. To tackle this issue, we employ normalization: we normalize the frequency <inline-formula><mml:math id="I4"><mml:mrow><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> by a sample-specific constant σ(<italic>s</italic>), which is proportional to the total number of base pairs in a sample, and <inline-formula><mml:math id="I5"><mml:mrow><mml:mi>σ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math></inline-formula> for the largest sample in the collection in terms of total base pair count, obtaining
<disp-formula id="btu340-M1"><label>(1)</label><mml:math id="MM1"><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mover accent="true"><mml:mi>f</mml:mi><mml:mo>^</mml:mo></mml:mover><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>/</mml:mo><mml:mi>σ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula>
The σ(<italic>s</italic>) can be interpreted probabilistically as the probability of observing a sequence in the actual sample, assuming every sample had the same number of base pairs to start with, but some have been lost in the processing.</p>
      <p>To estimate the relative frequencies, we place a conjugate symmetric Dirichlet prior on the parameters of the multinomial distribution over the observed counts. The common choice of uniform prior distribution corresponds to a Dirichlet distribution with all parameters equal to 1. This yields a posterior mean estimate of the relative frequency values as
<disp-formula id="btu340-M2"><label>(2)</label><mml:math id="MM2"><mml:mrow><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mstyle displaystyle="true"><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>s</mml:mi><mml:mo>′</mml:mo><mml:mo>∈</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:munder><mml:mrow><mml:mrow><mml:mo stretchy="true">[</mml:mo><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo>′</mml:mo><mml:mo>,</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo stretchy="true">]</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula>
The Dirichlet prior with all parameters equal to 1 is ubiquitous in document retrieval. It is particularly suitable for metagenomics owing to the following observations: First, the DSM algorithm (described below) trades off low <italic>k</italic>-mer counts for speed and ignores any <italic>k</italic>-mers that are present only once in a sample. The pseudocount from the prior makes up for this missing count. Second, adding pseudocounts assists in playing down the significance of rare <italic>k</italic>-mers that may appear due to sequencing errors in the filtering step without affecting other <italic>k</italic>-mers too much.</p>
      <p>Finally, given the massive number of potential <italic>k</italic>-mers, it is crucially important to improve signal-to-noise ratio by focusing on the informative ones. For the unsupervised tasks of comparing the samples, obviously only <italic>k</italic>-mers that distinguish between the samples are informative. As a concrete example, consider a <italic>k</italic>-mer that is present in all samples with a similar abundance. It certainly does not give information useful for comparing samples. In the other extreme, if a <italic>k</italic>-mer is present in one specific sample, but not in any other, it is potentially a spurious <italic>k</italic>-mer due to sequencing error, and in any case does not help in comparing samples either. On the other hand, if a <italic>k</italic>-mer is present in some samples, but not all, then it gives information that those samples are similar in a specific sense. Informativeness in this sense can be measured by the entropy <italic>H</italic> of the distribution of the <italic>k</italic>-mer over the samples: we filter the <italic>k</italic>-mers based on the conditional entropies
<disp-formula id="btu340-M3"><label>(3)</label><mml:math id="MM3"><mml:mrow><mml:mi>H</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>S</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mi>log</mml:mi><mml:mo>⁡</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mo stretchy="false">|</mml:mo><mml:mi>S</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>s</mml:mi><mml:mo>∈</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:munder><mml:mi>p</mml:mi></mml:mstyle><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mi>log</mml:mi><mml:mo>⁡</mml:mo><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">|</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>;</mml:mo></mml:mrow></mml:math></disp-formula>
a <italic>k</italic>-mer is taken into account in distance computation only if the normalized entropy is lower than a certain threshold <italic>e</italic>. By design <inline-formula><mml:math id="I6"><mml:mrow><mml:mn>0</mml:mn><mml:mo>≤</mml:mo><mml:mi>H</mml:mi><mml:mo>≤</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:math></inline-formula>. Notice that in standard <italic>information theory</italic> terminology higher entropy implies higher information. However, in our context an informative <italic>k</italic>-mer has low entropy. Also, due to the Bayesian estimation, a spurious <italic>k</italic>-mer having only small counts will have large conditional entropy and will be filtered out.</p>
      <p>The optimal value of threshold <italic>e</italic> varies with datasets. It can be ‘optimized’ in a supervised manner by utilizing a <italic>training set</italic> where we have labeled samples. In the absence of a labeled set, we suggest taking the ‘average’ of distance metrics computed over the potential thresholds as the final metric. We refer to the final metrics in the two cases as <italic>optimized metric</italic> and <italic>average metric</italic>. In our experimental set-up, we randomly make a 50–50 split of a given dataset in training <inline-formula><mml:math id="I7"><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>tr</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> and testing <inline-formula><mml:math id="I8"><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>te</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> sets: <inline-formula><mml:math id="I9"><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>tr</mml:mtext></mml:mrow></mml:msub><mml:mo>∩</mml:mo><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>te</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mo>∅</mml:mo></mml:mrow></mml:math></inline-formula> and <inline-formula><mml:math id="I10"><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>tr</mml:mtext></mml:mrow></mml:msub><mml:mo>∪</mml:mo><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>te</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:math></inline-formula>. We use <inline-formula><mml:math id="I11"><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>tr</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> to optimize the entropy threshold: we query with samples in <inline-formula><mml:math id="I12"><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>tr</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> and retrieve relevant samples within the same set to observe which entropy threshold results in the best retrieval result (see Section 3.4 for details). While comparing the performance of two methods we always present the evaluation over <inline-formula><mml:math id="I13"><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>te</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula>: we query with samples within <inline-formula><mml:math id="I14"><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>te</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula>, and we retrieve relevant samples from <italic>S</italic> (not just <inline-formula><mml:math id="I15"><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>te</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula>). Notice that the training set can also be used to judge the importance of individual features.</p>
    </sec>
    <sec id="SEC3.2">
      <title>3.2 Algorithms to extract informative <italic>k</italic>-mers</title>
      <p>Our main computational challenge is to extract all informative <italic>k</italic>-mers from large-scale datasets in feasible time and space. Recall that the filtering step relies on knowledge over multiple samples to decide if the respective <italic>k</italic>-mer is informative for the retrieval task or not. Because the typical collections of WMS samples are huge in size, we cannot assume that even the plain input fits into the main memory of any single machine. To process these large-scale datasets, the computation needs to be done either using external memory (i.e. disk) or in a distributed manner (i.e. a computer cluster). We review two approaches: <italic>k-mer counting</italic> (<xref rid="btu340-B13" ref-type="bibr">Marais and Kingsford, 2011</xref>; <xref rid="btu340-B22" ref-type="bibr">Rizk <italic>et al.</italic>, 2013</xref>) and DSM (<xref rid="btu340-B29" ref-type="bibr">Välimäki and Puglisi, 2012</xref>). The first one is a standard approach in the literature for fixed <italic>k</italic>, but has several limitations when applied in our context of multiple samples and large-scale data. We show that the latter approach is more flexible in this context and can also be generalized to extract informative <italic>k</italic>-mers over all values of <italic>k</italic> simultaneously.</p>
      <p>Jellyfish (<xref rid="btu340-B13" ref-type="bibr">Marais and Kingsford, 2011</xref>) and DSK (<xref rid="btu340-B22" ref-type="bibr">Rizk <italic>et al.</italic>, 2013</xref>) are examples of recent algorithmic improvements in <italic>k</italic>-mer counting. Both tools use hash tables to compute the <italic>k</italic>-mer distribution for a given (fixed) <italic>k</italic>. In both tools, space efficiency is achieved by keeping most of the hash table on disk. The main drawback with these disk-based approaches is that they are aimed at counting <italic>k</italic>-mers in a single sample and extending them over to multiple samples is non-trivial. For example, Jellyfish could, in principle, be extended to count <italic>k</italic>-mers over multiple samples: the authors give a roughly linear time algorithm to merge two or more hash tables. However, the intermediate <italic>k</italic>-mer counts would need to be stored on disk, which requires significant amount of additional space, and the merge phase is not parallelized (<xref rid="btu340-B13" ref-type="bibr">Marais and Kingsford, 2011</xref>, User manual, Section Bugs).</p>
      <p>The decision whether a particular <italic>k</italic>-mer is informative or not is made by looking at its frequency over all the given WMS samples. We tackle this problem by a DSM framework (<xref rid="btu340-B29" ref-type="bibr">Välimäki and Puglisi, 2012</xref>) that can handle multi-sample inputs by utilizing a computer cluster. The main advantages of this framework are that (i) load balancing divides the data and computation over multiple cluster nodes, (ii) intermediate <italic>k</italic>-mer counts are not stored explicitly and (iii) there is no additional disk I/O strain, except reading through the input once. These advantages allow terabyte-scale data analysis on a cluster having limited main memory per node, but a sufficient number of nodes available to facilitate the computation in distributed manner. We extend the DSM framework to be compatible with our definition of informative <italic>k</italic>-mers (see the above subsection). It allows us to extract the informative <italic>k</italic>-mers either for a fixed <italic>k</italic> or over all values of <italic>k</italic> in feasible time.</p>
      <p>The DSM framework is based on a client-server model. The clients have one-to-one correspondence to the given samples, each client being responsible for computing the frequencies within the designated sample. The client-side computation relies heavily on <italic>suffix sorting</italic> techniques and on space-efficient data structures for strings (<xref rid="btu340-B29" ref-type="bibr">Välimäki and Puglisi, 2012</xref>): the input data are first preprocessed into a compressed representation, which replaces the input data and acts as an efficient search structure. The server-side computation is more straightforward: the server simply merges the (sorted) input from the clients, computes the entropies and updates the distance matrices. <xref ref-type="fig" rid="btu340-F3">Figure 3</xref> gives a toy example of the client–server interaction. Two crucial observations are needed to keep the whole computation and transmission costs feasible. First, the informative <italic>k</italic>-mers can be seen as a subset of <italic>left</italic><italic>–</italic><italic>right-branching</italic> substrings, i.e. substrings whose instances have differentiating continuation on both left and right. More formally: substring <italic>w</italic> of string <italic>T</italic>[1,<italic>n</italic>] is called <italic>right-branching</italic> if there exists two symbols <italic>a</italic> and <italic>b</italic> such that <inline-formula><mml:math id="I16"><mml:mrow><mml:mi>a</mml:mi><mml:mo>≠</mml:mo><mml:mi>b</mml:mi></mml:mrow></mml:math></inline-formula> and both <italic>wa</italic> and <italic>wb</italic> are substrings of <italic>T</italic>. Similarly, a substring <italic>w</italic> is <italic>left-branching</italic> if <italic>aw</italic> and <inline-formula><mml:math id="I17"><mml:mrow><mml:mi>b</mml:mi><mml:mi>w</mml:mi><mml:mo>,</mml:mo><mml:mtext>
</mml:mtext><mml:mi>a</mml:mi><mml:mo>≠</mml:mo><mml:mi>b</mml:mi></mml:mrow></mml:math></inline-formula>, are substrings of <italic>T</italic>. If a substring is both left-branching and right-branching, we say it is <italic>left</italic><italic>–</italic><italic>right-branching</italic>. Second, for any string of length <italic>n</italic>, there are at most <italic>O</italic>(<italic>n</italic>) left–right-branching substrings, and the total length of all such substrings is bounded by <inline-formula><mml:math id="I18"><mml:mrow><mml:mi>O</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mi>log</mml:mi><mml:mo>⁡</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> (<xref rid="btu340-B8" ref-type="bibr">Kärkkäinen <italic>et al.</italic>, 2009</xref>, Theorem 1).
<fig id="btu340-F3" position="float"><label>Fig. 3.</label><caption><p>Technical overview of our DSM framework consisting of client (left) and server (right) processes. The client-side processes are responsible for computing the substring frequencies within each sample <inline-formula><mml:math id="I19"><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mi>d</mml:mi></mml:msub></mml:mrow></mml:math></inline-formula> separately. Substrings and their frequencies are found using a depth-first-traversal over a (compressed) suffix tree. Frequency information is transmitted over to the server-side by streaming it as a balanced-parenthesis representation of a sorted trie. For example, the trie on the left results as the parenthesis representation given in the middle. The server reads the client-streams and merges the (already sorted) tries in recursive manner: at each node, the server computes the entropy based on the received values and updates the affected pairwise distances. Load balancing on the server-side is achieved by hashing the prefix of the substring so that each server corresponds to a certain range of hash values</p></caption><graphic xlink:href="btu340f3p"/></fig></p>
      <p>The first observation allows us to reduce the client-side computation to a smaller set of substrings: it is easy to see that if <italic>k</italic>-mer <italic>w</italic>, having frequency <inline-formula><mml:math id="I20"><mml:mrow><mml:mi>f</mml:mi><mml:mo>′</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>≥</mml:mo><mml:mn>2</mml:mn></mml:mrow></mml:math></inline-formula>, is non-branching, then there exists a substring <inline-formula><mml:math id="I21"><mml:mrow><mml:mi>w</mml:mi><mml:mo>′</mml:mo></mml:mrow></mml:math></inline-formula> of length <inline-formula><mml:math id="I22"><mml:mrow><mml:mi>k</mml:mi><mml:mo>′</mml:mo><mml:mo>&gt;</mml:mo><mml:mi>k</mml:mi></mml:mrow></mml:math></inline-formula> that is left–right-branching and has exactly the same frequency, i.e. <inline-formula><mml:math id="I23"><mml:mrow><mml:mi>f</mml:mi><mml:mo>′</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>f</mml:mi><mml:mo>′</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>w</mml:mi><mml:mo>′</mml:mo><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula>. It follows that the frequency of non-branching <italic>k</italic>-mers can be deduced from the branching <inline-formula><mml:math id="I24"><mml:mrow><mml:mi>k</mml:mi><mml:mo>′</mml:mo></mml:mrow></mml:math></inline-formula>-mers, and the left–right-branching substrings contain all the necessary information for us to detect informative <italic>k</italic>-mers. The second observation guarantees a feasible transmission cost between clients and servers: the upper bound for the concatenation of all left–right-branching substrings also acts as an upper bound for both the server-side running time and the amount of communication needed. The drawback of restricting to left–right-branching substrings is that the informative <italic>k</italic>-mers that we are able to detect have to appear at least twice in a sample, although this limit may be useful in pruning spurious <italic>k</italic>-mers introduced by sequencing errors. More detailed explanation and analysis of the DSM framework is given in <xref rid="btu340-B29" ref-type="bibr">Välimäki and Puglisi (2012)</xref>. A software implementation of the DSM framework is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/HIITMetagenomics/dsm-framework">https://github.com/HIITMetagenomics/dsm-framework</ext-link>.</p>
    </sec>
    <sec id="SEC3.3">
      <title>3.3 Dissimilarity metrics</title>
      <p>Having extracted the informative <italic>k</italic>-mers, we use them to compute the dissimilarity between two metagenomic samples. We consider three dissimilarity metrics that can be computed easily over a large number of <italic>k</italic>-mers in sequential manner, i.e. one <italic>k</italic>-mer at a time, and without storing all the <italic>k</italic>-mer frequencies explicitly. To utilize the natural variance structure of the <italic>k</italic>-mers—some are more abundant than others—we weight the relative frequencies of each <italic>k</italic>-mer by their respective total counts, i.e. we utilize the absolute frequencies <inline-formula><mml:math id="I25"><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo>,</mml:mo><mml:mi>w</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula> as defined in <xref ref-type="disp-formula" rid="btu340-M1">(1)</xref>.</p>
      <p>We mainly use the simple Jaccard distance that does not consider abundances at all, only whether a <italic>k</italic>-mer occurs or not. Given two sets <italic>s</italic><sub>1</sub> and <italic>s</italic><sub>2</sub> of <italic>k</italic>-mers detected as present in two different samples, Jaccard distance measures how many elements are shared between these two sets. Mathematically, it is defined as
<disp-formula><mml:math id="UM1"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mtext>count</mml:mtext></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>∩</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>∪</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">|</mml:mo></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mrow></mml:math></disp-formula>
Despite its simplicity, we observe that Jaccard distance performs well; a potential reason is its robustness to measurement noise and effectiveness when two metagenomic samples differ in terms of presence and absence of certain species or functionalities. We assume a <italic>k</italic>-mer is present in a sample if its frequency is &gt;2.</p>
      <p>We also experiment with two metrics that use the abundance information:</p>
      <p>I. <italic>Variance-stabilized Euclidean distance:</italic> An obvious distance measure between two metagenomic samples <italic>s</italic><sub>1</sub> and <italic>s</italic><sub>2</sub> is the Euclidean distance between their respective <italic>k</italic>-mer frequencies. We consider the distance metric
<disp-formula><mml:math id="UM2"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mtext>sqrt</mml:mtext></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munder><mml:mo>∑</mml:mo><mml:mi>w</mml:mi></mml:munder><mml:mrow><mml:msup><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msqrt><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>w</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msqrt><mml:mo>−</mml:mo><mml:msqrt><mml:mrow><mml:mi>f</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>w</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msqrt><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup></mml:mrow></mml:mstyle></mml:mrow></mml:math></disp-formula>
which can be computed sequentially as new informative <italic>k</italic>-mers are extracted. The square root transformation is the <italic>variance stabilizing transformation</italic> for Poisson distribution—a popular model for quantitative sequencing data.</p>
      <p>II. <italic>Log transformed Euclidean distance:</italic> We also consider the same metric but with log transformation, which is a popular approach in document retrieval, i.e.
<disp-formula><mml:math id="UM3"><mml:mrow><mml:msub><mml:mi>D</mml:mi><mml:mrow><mml:mtext>log</mml:mtext></mml:mrow></mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mstyle displaystyle="true"><mml:munder><mml:mo>∑</mml:mo><mml:mi>w</mml:mi></mml:munder><mml:mrow><mml:msup><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mtext>log</mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>w</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:mi>log</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>f</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>w</mml:mi><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo>.</mml:mo></mml:mrow></mml:mstyle></mml:mrow></mml:math></disp-formula>
The motivation for using the log transformation is that it decreases sensitivity to high frequency counts: some <italic>k</italic>-mers are present in high abundance in almost every genome, for instance <italic>k</italic>-mers from the marker gene, and the log transformation reduces their effect in the metric.</p>
    </sec>
    <sec id="SEC3.4">
      <title>3.4 Evaluation metric</title>
      <p>We evaluate the performance of the dissimilarity metric in terms of its performance in the task of retrieving relevant samples given a query metagenomics sample. The ground truth for relevance is either the disease class (disease versus not) or the known body site: samples from the same class are considered relevant.</p>
      <p>For measuring retrieval performance, we use an evaluation metric which is popular in document retrieval, the mean average precision (MAP) (<xref rid="btu340-B26" ref-type="bibr">Smucker <italic>et al.</italic>, 2007</xref>). Given a query <italic>q</italic>, the retrieval method ranks the samples in an increasing order of their dissimilarities from <italic>q</italic>. Given one has retrieved the top (closest) <inline-formula><mml:math id="I26"><mml:mrow><mml:mi>n</mml:mi><mml:mo>∈</mml:mo><mml:mo>{</mml:mo><mml:mn>1</mml:mn><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:mi>N</mml:mi><mml:mo>}</mml:mo></mml:mrow></mml:math></inline-formula> samples the precision @ <italic>n</italic> is defined as
<disp-formula><mml:math id="UM4"><mml:mrow><mml:mtext>Precision</mml:mtext><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo>;</mml:mo><mml:mi>q</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mtext>number of relevant samples in</mml:mtext><mml:mspace width=".2em"/><mml:mi>n</mml:mi><mml:mspace width=".2em"/><mml:mtext>retrieved samples</mml:mtext></mml:mrow><mml:mi>n</mml:mi></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula>
and MAP defined using <italic>average precision</italic> as,
<disp-formula><mml:math id="UM5"><mml:mrow><mml:mtext>MAP=</mml:mtext><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mi>Q</mml:mi><mml:mo>|</mml:mo></mml:mrow></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>q</mml:mi><mml:mi>ε</mml:mi><mml:mi>Q</mml:mi></mml:mrow></mml:munder><mml:mrow><mml:mtext>AveP</mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mi>q</mml:mi><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mtext>AveP</mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mi>q</mml:mi><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:msub><mml:mi>m</mml:mi><mml:mi>q</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mstyle displaystyle="true"><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>R</mml:mi><mml:mi>q</mml:mi></mml:msub></mml:mrow></mml:munder><mml:mrow><mml:mtext>Precision</mml:mtext><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>n</mml:mi><mml:mo>;</mml:mo><mml:mi>q</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:mrow></mml:math></disp-formula>
Here, <italic>Q</italic> is the set of all queries, <italic>m<sub>q</sub></italic> is the number of relevant samples to query <italic>q</italic> and <italic>R<sub>q</sub></italic> is the set of locations in the ranked list where a relevant sample appears. It is straightforward that a higher MAP implies better performance. To judge if two MAP values are significantly different or not, we employ the randomization test described in <xref rid="btu340-B26" ref-type="bibr">Smucker et al. (2007)</xref>: for each query, this test randomly reassigns the AvePs achieved by two methods to one another, and computes the difference between the resulting MAP for multiple such reassignments to get a distribution, against which the true MAP value is tested in terms of <italic>P</italic>-value. In case two samples share the same dissimilarity from a query sample, we employ the modification suggested in <xref rid="btu340-B14" ref-type="bibr">McSherry and Najork (2008)</xref> to break ties. When computing the mean, we follow a leave-one-out cross-validation type approach using each sample as a query, and retrieving from the rest of the collection. For simulated data and human gut samples, we only query with the positive samples in the testing set <inline-formula><mml:math id="I27"><mml:mrow><mml:mi>q</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>te</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula>, whereas for body site samples we query with each sample in the testing set. For both cases we retrieve from the entire set <inline-formula><mml:math id="I28"><mml:mrow><mml:mi>S</mml:mi><mml:mi mathvariant="normal">∖</mml:mi><mml:mo>{</mml:mo><mml:mi>q</mml:mi><mml:mo>}</mml:mo></mml:mrow></mml:math></inline-formula>. Although choosing the entropy threshold in a supervised setting, we query from <inline-formula><mml:math id="I29"><mml:mrow><mml:mi>q</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>tr</mml:mtext></mml:mrow></mml:msub></mml:mrow></mml:math></inline-formula> and retrieve from <inline-formula><mml:math id="I30"><mml:mrow><mml:msub><mml:mi>S</mml:mi><mml:mrow><mml:mtext>tr</mml:mtext></mml:mrow></mml:msub><mml:mi mathvariant="normal">∖</mml:mi><mml:mo>{</mml:mo><mml:mi>q</mml:mi><mml:mo>}</mml:mo></mml:mrow></mml:math></inline-formula>.</p>
    </sec>
    <sec id="SEC3.5">
      <title>3.5 Synthetic data generation</title>
      <p>To test the method, we simulated four datasets containing samples from separate classes, with the interpretation that samples from the same class are relevant. In all the datasets we have two classes: both classes of samples have the same species composition but different relative abundances. We used MetaSim (<xref rid="btu340-B21" ref-type="bibr">Richter <italic>et al.</italic>, 2008</xref>) to generate Illumina reads of length 80 using the error configuration file provided by the developers. Each dataset contains 200 samples: 98 of them belong to the <italic>positive</italic> class and the rest belong to the <italic>negative</italic> class. For each dataset, we used the same 100 species from the following genera: acetobacter, acetobacterium, acidiphilium, acidithiobacillus, acinetobacter, bacillus, bacteroides, bifidobacterium, chlamydia, chlamydophila, clostridium, escherichia, haloarcula, halobacterium, lactobacillus, pasteurella, salmonella, staphylococcus and streptococcus. The abundance profiles were generated from two Dirichlet distributions; one for positive and the other for negative class. The parameters of the Dirichlet distributions were shared between two classes: for half of the species (randomly chosen) the same parameters were used for both classes and for the other half of the species the parameters were randomly permuted. For example, given five species the assigned parameters could be: (0.3, 0.2, 0.6, 0.1 and 0.9) and (0.9, 0.2, 0.3, 0.1 and 0.6) where the parameters for the second and fourth species are the same, but for the other species they were permuted. The exact species and corresponding parameter values can be downloaded from <ext-link ext-link-type="uri" xlink:href="https://github.com/HIITMetagenomics">https://github.com/HIITMetagenomics</ext-link>. The resulting datasets are—HIGH-C, relatively easy data with high coverage (10<italic>e</italic>6 reads/sample); LOW-C, relatively difficult data with low coverage (2<italic>e</italic>6 reads/sample); MIXED-C, mixed data with half the samples from HIGH-C and the rest from LOW-C to simulate varying sequencing depth; and HIGH-VAR, relatively difficult data with same coverage as HIGH-C but additional noise in the class distributions to simulate more overlap between classes. To elaborate, the relative abundance of species is <inline-formula><mml:math id="I31"><mml:mrow><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mtext>HIGH-VAR</mml:mtext></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mn>0.5</mml:mn><mml:mtext>
</mml:mtext><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mtext>HIGH</mml:mtext></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mn>0.5</mml:mn><mml:mtext>
</mml:mtext><mml:mi>n</mml:mi><mml:mi>o</mml:mi><mml:mi>i</mml:mi><mml:mi>s</mml:mi><mml:mi>e</mml:mi></mml:mrow></mml:math></inline-formula> where <italic>noise</italic> is generated from a symmetric Dirichlet distribution with all parameters equal to 1.</p>
    </sec>
  </sec>
  <sec>
    <title>4 RESULTS</title>
    <p>We evaluated the retrieval performance on three human metagenomics datasets:
<list list-type="order"><list-item><p>MetaHIT (<xref rid="btu340-B19" ref-type="bibr">Qin <italic>et al.</italic>, 2010</xref>), 124 metagenomic samples from 99 healthy people and 25 patients with IBD syndrome. Each sample has on average 65 ± 21 million reads. Our goal was to retrieve IBD-positive patients.</p></list-item><list-item><p>T2D Phase II (<xref rid="btu340-B20" ref-type="bibr">Qin <italic>et al.</italic>, 2012</xref>), 199 metagenomic samples from 100 healthy people and 99 patients with type II diabetes. Each sample has on average 47 ± 11 million reads. Our goal was to retrieve patients with diabetes. We chose to explore the phase II data instead of the phase I data, as the former has higher coverage; about 40% more reads than the latter.</p></list-item><list-item><p>HMP (<xref rid="btu340-B6" ref-type="bibr">Human Microbiome Project Consortium, 2012</xref>), 435 metagenomic samples from 10 different body sites (see <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu340/-/DC1">Supplementary Table S1</ext-link>). Of 690 samples that passed the QC assessment (<ext-link ext-link-type="uri" xlink:href="http://www.hmpdacc.org/HMASM/">http://www.hmpdacc.org/HMASM/</ext-link>), we discarded 255 samples that had &lt;1% of the number of reads of the largest sample.</p></list-item></list>
</p>
    <p>To recapitulate, for MetaHIT and T2D-P2, our goal is to observe if given a positive sample, e.g. from a patient with a particular disease, one can retrieve relevant samples, i.e. with similar disease; whereas for HMP, our goal is to observe if given a sample from a particular body site, one can retrieve relevant samples, i.e. samples from the same body site. For all data, we applied a quality threshold of 30 and ignored any base pairs with quality less than the threshold. <xref ref-type="table" rid="btu340-T1">Table 1</xref> gives an overview of the computational resources required for each dataset. Additionally, number of <italic>k</italic>-mers used by different methods for each dataset are available in the <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu340/-/DC1">Supplementary Fig. S1</ext-link>.
<table-wrap id="btu340-T1" position="float"><label>Table 1.</label><caption><p>Computational resources required by the DSM on different datasets</p></caption><table frame="hsides" rules="groups"><thead align="left"><tr><th rowspan="1" colspan="1"/><th rowspan="1" colspan="1">HIGH-C</th><th rowspan="1" colspan="1">MetaHIT</th><th rowspan="1" colspan="1">T2D-P2</th><th rowspan="1" colspan="1">HMP</th></tr></thead><tbody align="left"><tr><td rowspan="1" colspan="1">Input size (GB)</td><td rowspan="1" colspan="1">149</td><td rowspan="1" colspan="1">536</td><td rowspan="1" colspan="1">786</td><td rowspan="1" colspan="1">3353</td></tr><tr><td rowspan="1" colspan="1">Samples</td><td rowspan="1" colspan="1">200</td><td rowspan="1" colspan="1">124</td><td rowspan="1" colspan="1">199</td><td rowspan="1" colspan="1">435</td></tr><tr><td rowspan="1" colspan="1">Preproc. (h)</td><td rowspan="1" colspan="1">0.4</td><td rowspan="1" colspan="1">3.6</td><td rowspan="1" colspan="1">10</td><td rowspan="1" colspan="1">65</td></tr><tr><td rowspan="1" colspan="1">Total memory (GB)</td><td rowspan="1" colspan="1">117</td><td rowspan="1" colspan="1">209</td><td rowspan="1" colspan="1">610</td><td rowspan="1" colspan="1">2885</td></tr><tr><td colspan="5" rowspan="1">All <italic>k</italic></td></tr><tr><td rowspan="1" colspan="1">    Wall clock (h)</td><td rowspan="1" colspan="1">4.9</td><td rowspan="1" colspan="1">2.0</td><td rowspan="1" colspan="1">8.0</td><td rowspan="1" colspan="1">53</td></tr><tr><td rowspan="1" colspan="1">    CPU time (h)</td><td rowspan="1" colspan="1">149</td><td rowspan="1" colspan="1">187</td><td rowspan="1" colspan="1">1137</td><td rowspan="1" colspan="1">20 000</td></tr><tr><td colspan="5" rowspan="1"><italic>k</italic> = 21</td></tr><tr><td rowspan="1" colspan="1">    Wall clock (h)</td><td rowspan="1" colspan="1">1.8</td><td rowspan="1" colspan="1">0.4</td><td rowspan="1" colspan="1">2.8</td><td rowspan="1" colspan="1">12</td></tr><tr><td rowspan="1" colspan="1">    CPU time (h)</td><td rowspan="1" colspan="1">10</td><td rowspan="1" colspan="1">74</td><td rowspan="1" colspan="1">279</td><td rowspan="1" colspan="1">4000</td></tr></tbody></table><table-wrap-foot><fn id="btu340-TF1"><p><italic>Note:</italic> We report wall-clock times and total CPU times for both fixed <italic>k</italic> = 21 and over all <italic>k</italic>. Preprocessing is done only once, separately from the actual computation. Total memory is the memory requirement over all computation nodes. Experiments were run on a cluster of Dell PowerEdge M610 nodes having 32 GB of RAM and 16 cores. Simulated data and MetaHIT were run using up to eight nodes. T2D-P2 was run using 32 nodes allowing more parallelization at the server-side. HMP was run on a cluster of 20 nodes with 2 × 10-core Xeon CPUs and 256 GB RAM.</p></fn></table-wrap-foot></table-wrap></p>
    <p><italic>Retrieval of samples with similar annotation:</italic> We applied the proposed approach and a number of alternatives for retrieval of similar samples from the same dataset and evaluated by how many of the retrieved samples had the same annotation: class label, disease state or body site. A comparison of the obtained MAP values averaged over queries by all positive samples is shown in <xref ref-type="fig" rid="btu340-F4">Figure 4</xref>. The results show the performance achieved by the ‘optimized metric’. The alternatives we considered were—(i) retrieval performance based on the proposed distances between frequencies of 21-mers appearing in known protein families (FIGfams) with added pseudocounts but without entropy filtering (<xref rid="btu340-B16" ref-type="bibr">Meyer <italic>et al.</italic>, 2009</xref>); (ii) retrieval based on Bray–Curtis dissimilarity between relative species abundances estimated using MetaPhlAn (<xref rid="btu340-B25" ref-type="bibr">Segata <italic>et al.</italic>, 2012</xref>) (each feature is a species found in at least one samples; no regularization added); and (iii) retrieval based on <inline-formula><mml:math id="I32"><mml:mrow><mml:msubsup><mml:mi>d</mml:mi><mml:mi>S</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:mo stretchy="false">|</mml:mo><mml:msub><mml:mi>M</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mrow></mml:math></inline-formula> distances between relative frequencies of 3-mers (<xref rid="btu340-B7" ref-type="bibr">Jiang <italic>et al.</italic>, 2012</xref>).
<fig id="btu340-F4" position="float"><label>Fig. 4.</label><caption><p>Retrieval performance comparison of the proposed approach using all <italic>k</italic>-mers (‘Ak’) against the following base measures: (1) ‘FIG’: retrieval performance using known protein family, (2) ‘Abd’: Bray–Curtis dissimilarity between relative estimated abundance, (3) ‘3’: <inline-formula><mml:math id="I33"><mml:mrow><mml:msubsup><mml:mi>d</mml:mi><mml:mi>S</mml:mi><mml:mn>2</mml:mn></mml:msubsup></mml:mrow></mml:math></inline-formula> distance between relative abundance of 3-mers. ‘Ak’ uses the ‘optimized metric’ over 101 equally spaced threshold values between 0 and 1. Each error bar shows the MAP value along with the standard error. The grey horizontal line shows retrieval by chance: MAP computed over zero similarity metric. An arrow (if present) over a method indicates whether the performance of the corresponding method is significantly better (↑) or worse (↓) than ‘Ak’: The stars denote significance level: 0 &lt;*** &lt; 0.001 &lt;** &lt; 0.01 &lt;* &lt; 0.05. For the synthetic datasets (in the bottom row), the relative abundance is known from experimental design. We present this result as ‘T’. For MetaHIT, we present the performance for both Jaccard and log metric, as the latter performs much better compared with the former</p></caption><graphic xlink:href="btu340f4p"/></fig></p>
    <p>For the simulated data, the two classes differ only by the relative species abundance; thus, retrieval based on ground truth abundance can be considered to give an upper limit for the performance. For HIGH-C and HIGH-VAR, the proposed method performs closer to the ground truth performance than any other methods, although the difference from ground truth performance is still statistically significant. For LOW-C, the performance of all methods, except the protein family based comparison, drop compared with HIGH-C, whereas for MIXED-C the performance is again close to HIGH-C despite the presence of low coverage samples. This is an encouraging observation showing the robustness of the proposed approach to varying sequencing depths.</p>
    <p>For the real datasets, the proposed approach yielded statistically significantly higher MAP than any of the alternatives (<inline-formula><mml:math id="I36"><mml:mrow><mml:mi>P</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0.05</mml:mn></mml:mrow></mml:math></inline-formula>) for all the datasets, except T2D-P2 where protein family based comparison works equally well. Interestingly, the abundance-based retrieval performs relatively poorly here, suggesting that the differences between the classes cannot be easily captured by species composition alone, while the proposed <italic>k</italic>-mer features can provide a better separation. Retrieval based on the known protein family performed fairly well, but slightly worse than the proposed approach on MetaHIT. We observe that for MetaHIT, Jaccard metric performs poorly; however, a change of metric to log significantly improves the performance for all methods. Otherwise, all metrics usually work equally well over different datasets.</p>
    <p><italic>Effect of using specific or unspecific k-</italic>mer <italic>length:</italic> We next compared the proposed approach of using all <italic>k</italic>-mers to using a specific <italic>k</italic>. The retrieval performance using ‘optimized metric’ is shown in <xref ref-type="fig" rid="btu340-F5">Figure 5</xref> (and <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu340/-/DC1">Supplementary Fig. S2</ext-link>). The figures show the complete distribution of average precision values over different queries whose mean is the MAP of <xref ref-type="fig" rid="btu340-F4">Figure 4</xref>. The performance of the proposed method is usually better than with any individual <italic>k</italic>. Thus, the proposed method appears to be a relatively safe choice that does not suffer from catastrophically bad performance on any of the datasets.
<fig id="btu340-F5" position="float"><label>Fig. 5.</label><caption><p>Comparison of best performances for different <italic>k</italic>-mer lengths. The figures show the performance over queries by all positive samples as a violin plot. All methods use the ‘optimized metric’ chosen over 101 equally spaced threshold values between 0 and 1: the box denotes the MAP value. The horizontal lines show retrieval by chance: AveP computed over zero dissimilarity metric. Straight line is the mean, and dotted lines are 5 and 95% quantiles, respectively, when number of relevant samples differ for different queries. An arrow (if present) over a method implies whether the corresponding method performs significantly better (↑) or worse (↓) than ‘All’: The stars denote significance level: 0 &lt;*** &lt; 0.001 &lt;** &lt; 0.01 &lt;* &lt; 0.05. We observe that the considering all <italic>k</italic>-mers usually perform equally well with respect to considering a single <italic>k</italic></p></caption><graphic xlink:href="btu340f5p"/></fig></p>
    <p><italic>Effect of the entropy filtering</italic>: Next, we evaluated the efficacy of filtering the informative <italic>k</italic>-mers against retrieval performance without the filtering operation. The results are presented in <xref ref-type="fig" rid="btu340-F6">Figure 6</xref> (and <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu340/-/DC1">Supplementary Fig. S3</ext-link>). We observed that entropy filtering usually improved retrieval performance for all tested <italic>k</italic>-mer lengths when using the ‘optimized metric’, although the improvement might not always be statistically significant. Although ‘average metric’ often provides significant performance, it might not always improve over performance without filtering. Also, retrieval performance of FIGfam may or may not improve with entropy filtering (‘optimized metric’ and ‘average metric’ selected in the same way as other methods).
<fig id="btu340-F6" position="float"><label>Fig. 6.</label><caption><p>Comparison of the best retrieval performance achieved with ‘optimized metric’ (middle), ‘average metric’ (right) and without entropy filtering (left), for proposed approach ‘All’, individual <italic>k</italic>s as well as FIGfam-based distance metric. The metrics are ‘optimized’/‘averaged’ over 101 equally spaced threshold values between 0 and 1. Each error bar line shows the MAP value along with the standard error. The grey horizontal line shows retrieval by chance: MAP computed over zero dissimilarity metric. An arrow (if present) over a method implies whether the performance of the corresponding method (top: ‘average metric’, bottom: ‘optimized metric’) is better (↑) or worse (↓) than when entropy filtering is employed: The stars denote significance level: 0 &lt;*** &lt; 0.001 &lt;** &lt; 0.01 &lt;* &lt; 0.05. We observe that filtering has a positive impact on the retrieval performance</p></caption><graphic xlink:href="btu340f6p"/></fig></p>
    <p><italic>Comparison across different metrics:</italic> Finally, we evaluated the retrieval performance over different dissimilarity metrics. We presented the performance using ‘optimized metric’ for different metrics in <xref ref-type="fig" rid="btu340-F7">Figure 7</xref> (and <ext-link ext-link-type="uri" xlink:href="http://bioinformatics.oxfordjournals.org/lookup/suppl/doi:10.1093/bioinformatics/btu340/-/DC1">Supplementary Fig. S4</ext-link>). We observed that the simple presence-/absence-based metric <italic>D</italic><sub>count</sub> performed at least as well as abundance-sensitive log and sqrt metrics, except for the MetaHIT data for which the other metrics performed better.
<fig id="btu340-F7" position="float"><label>Fig. 7.</label><caption><p>Comparison of the best retrieval performance for different distance metrics using all <italic>k</italic>-mers. They show a violin plot of the average performances over queries by all positive samples in the datasets. The ‘optimized metrics’ have been selected over 101 equally spaced threshold values between 0 and 1: the box denotes the MAP value. The horizontal lines show retrieval by chance: AveP computed over zero dissimilarity metric. Straight line is the mean, and dotted lines are 5 and 95% quantiles, respectively, when number of relevant samples differ for different queries. An arrow (if present) over a method implies whether the corresponding method performs significantly better (↑) or worse (↓) than the other methods (denoted by their colors): The stars denote significance level: 0 &lt;*** &lt; 0.001 &lt;** &lt; 0.01 &lt;* &lt; 0.05. We observe that different distance metrics usually demonstrate similar performance</p></caption><graphic xlink:href="btu340f7p"/></fig></p>
  </sec>
  <sec>
    <title>5 CONCLUSION</title>
    <p>In the wake of collecting multiple samples from similar environments, information retrieval for metagenomic samples is expected to become a handy tool in metagenomics research. In this article, we have addressed the problem of retrieving relevant metagenomic samples given a query sample from the same collection. The novelty of the proposed approach is that it is unsupervised, and does not rely on the availability of reference databases. We have suggested employing <italic>k</italic>-mer frequencies as feature representation; however, rather than exploring <italic>k</italic>-mers of a fixed <italic>k</italic>, we have scanned through all possible <italic>k</italic>-mers of all possible <italic>k</italic>’s using DSM, and have proposed appropriate filtering technique to discard uninformative <italic>k</italic>-mers. Being reference-free, our method is capable of focusing on novel sequence markers, such as ones identifying novel bacterial strains. On the other hand, sensitivity especially on low-coverage species may be lower than using reference-based approaches. Like most read-counting-based approaches, our method can be sensitive to technical variation and changing biases in the sequencing process. For most reliable results, the dataset should be measured as uniformly as possible. The distributed algorithm relies on dedicated cluster hardware having sufficient total amount of main memory. The development of an efficient secondary memory-based algorithm is an important topic of future work. The overall computational requirements scale in near-linear manner as described by <xref rid="btu340-B29" ref-type="bibr">Välimäki and Puglisi (2012)</xref>. We have evaluated our method on both real and simulated data, and observed that the approach can effectively retrieve relevant metagenomic samples, outperforming both the FIGfams method based on known highly informative protein families as well as retrieval based on species composition of the samples.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material id="PMC_1" content-type="local-data">
      <caption>
        <title>Supplementary Data</title>
      </caption>
      <media mimetype="text" mime-subtype="html" xlink:href="supp_30_17_2471__index.html"/>
      <media xlink:role="associated-file" mimetype="application" mime-subtype="pdf" xlink:href="supp_btu340_draft-supplement.pdf"/>
    </supplementary-material>
  </sec>
</body>
<back>
  <ack>
    <title>ACKNOWLEDGEMENTS</title>
    <p>The authors thank Ahmed Sobih for his help with the MetaPhlAn experiments on MetaHIT and T2D-P2. Part of the calculations presented above was performed using computer resources within the Aalto University School of Science ‘Science-IT’ project.</p>
    <p><italic>Funding</italic>: This work was supported by the <funding-source>Academy of Finland</funding-source> (project numbers <award-id>140057</award-id>, <award-id>250345</award-id>, <award-id>259440</award-id>, and <funding-source>the Finnish Centre of Excellence in Computational Inference Research COIN</funding-source>, <award-id>251170</award-id>.</p>
    <p><italic>Conflicts of interest</italic>: none declared.</p>
  </ack>
  <ref-list>
    <title>REFERENCES</title>
    <ref id="btu340-B1">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Baran</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Halperin</surname>
            <given-names>E</given-names>
          </name>
        </person-group>
        <article-title>Joint analysis of multiple metagenomic samples</article-title>
        <source>PLoS Comput. Biol.</source>
        <year>2012</year>
        <volume>8</volume>
        <fpage>e1002373</fpage>
        <pub-id pub-id-type="pmid">22359490</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B2">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Caldas</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Probabilistic retrieval and visualization of biologically relevant microarray experiments</article-title>
        <source>Bioinformatics</source>
        <year>2009</year>
        <volume>25</volume>
        <fpage>i145</fpage>
        <lpage>i153</lpage>
        <pub-id pub-id-type="pmid">19477980</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B3">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Caldas</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Data-driven information retrieval in heterogeneous collections of transcriptomics data links SIM2s to malignant pleural mesothelioma</article-title>
        <source>Bioinformatics</source>
        <year>2012</year>
        <volume>28</volume>
        <fpage>246</fpage>
        <lpage>253</lpage>
        <pub-id pub-id-type="pmid">22106335</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B4">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Edwards</surname>
            <given-names>RA</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Real time metagenomics: using <italic>k</italic>-mers to annotate metagenomes</article-title>
        <source>Bioinformatics</source>
        <year>2012</year>
        <volume>28</volume>
        <fpage>3316</fpage>
        <lpage>3317</lpage>
        <pub-id pub-id-type="pmid">23047562</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B5">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Greenblum</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Metagenomic systems biology of the human gut microbiome reveals topological shifts associated with obesity and inflammatory bowel disease</article-title>
        <source>Proc. Natl Acad. Sci. USA</source>
        <year>2012</year>
        <volume>109</volume>
        <fpage>594</fpage>
        <lpage>599</lpage>
        <pub-id pub-id-type="pmid">22184244</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B6">
      <element-citation publication-type="journal">
        <collab>Human Microbiome Project Consortium</collab>
        <article-title>Structure, function and diversity of the healthy human microbiome</article-title>
        <source>Nature</source>
        <year>2012</year>
        <volume>486</volume>
        <fpage>207</fpage>
        <lpage>214</lpage>
        <pub-id pub-id-type="pmid">22699609</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B7">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Jiang</surname>
            <given-names>B</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Comparison of metagenomic samples using sequence signatures</article-title>
        <source>BMC Genomics</source>
        <year>2012</year>
        <volume>13</volume>
        <fpage>730</fpage>
        <pub-id pub-id-type="pmid">23268604</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B8">
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Kärkkäinen</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Permuted longest common prefix array</article-title>
        <source>Proceedings of Combinatorial Pattern Matching</source>
        <year>2009</year>
        <comment>LNCS 5577. Springer, pp. 181–192</comment>
      </element-citation>
    </ref>
    <ref id="btu340-B9">
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Largeron</surname>
            <given-names>C</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Entropy based feature selection for text categorization</article-title>
        <source>Proceedings of the 2011 ACM Symposium on Applied Computing - SAC 11</source>
        <year>2011</year>
        <comment>Association for Computing Machinery<italic>,</italic> pp. 924–928</comment>
      </element-citation>
    </ref>
    <ref id="btu340-B10">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Li</surname>
            <given-names>K</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Analyses of the microbial diversity across the human microbiome</article-title>
        <source>PLoS One</source>
        <year>2012</year>
        <volume>7</volume>
        <fpage>e32118</fpage>
        <pub-id pub-id-type="pmid">22719823</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B11">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Liu</surname>
            <given-names>Z</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Sparse distance-based learning for simultaneous multiclass classification and feature selection of metagenomic data</article-title>
        <source>Bioinformatics</source>
        <year>2011</year>
        <volume>27</volume>
        <fpage>3242</fpage>
        <lpage>3249</lpage>
        <pub-id pub-id-type="pmid">21984758</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B12">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Maillet</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Compareads: comparing huge metagenomic experiments</article-title>
        <source>BMC Bioinformatics</source>
        <year>2012</year>
        <volume>13</volume>
        <issue>Suppl. 19</issue>
        <fpage>S10</fpage>
        <pub-id pub-id-type="pmid">23282463</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B13">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Marais</surname>
            <given-names>G</given-names>
          </name>
          <name>
            <surname>Kingsford</surname>
            <given-names>C</given-names>
          </name>
        </person-group>
        <article-title>A fast, lock-free approach for efficient parallel counting of occurrences of <italic>k</italic>-mers</article-title>
        <source>Bioinformatics</source>
        <year>2011</year>
        <volume>27</volume>
        <fpage>764</fpage>
        <lpage>770</lpage>
        <pub-id pub-id-type="pmid">21217122</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B14">
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>McSherry</surname>
            <given-names>F</given-names>
          </name>
          <name>
            <surname>Najork</surname>
            <given-names>M</given-names>
          </name>
        </person-group>
        <article-title>Computing information retrieval performance measures efficiently in the presence of tied scores</article-title>
        <source>Proceedings of the IR research, 30th European conference on Advances in information retrieval</source>
        <year>2008</year>
        <comment>ECIR’08. Springer-Verlag, Berlin, Heidelberg, pp. 414–421</comment>
      </element-citation>
    </ref>
    <ref id="btu340-B15">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Meyer</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>The metagenomics RAST server a public resource for the automatic phylogenetic and functional analysis of metagenomes</article-title>
        <source>BMC Bioinformatics</source>
        <year>2008</year>
        <volume>9</volume>
        <fpage>386</fpage>
        <pub-id pub-id-type="pmid">18803844</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B16">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Meyer</surname>
            <given-names>F</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>FIGfams: yet another set of protein families</article-title>
        <source>Nucleic Acids Res.</source>
        <year>2009</year>
        <volume>37</volume>
        <fpage>6643</fpage>
        <lpage>6654</lpage>
        <pub-id pub-id-type="pmid">19762480</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B17">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Mitra</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Visual and statistical comparison of metagenomes</article-title>
        <source>Bioinformatics</source>
        <year>2009</year>
        <volume>25</volume>
        <fpage>1849</fpage>
        <lpage>1855</lpage>
        <pub-id pub-id-type="pmid">19515961</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B18">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Parks</surname>
            <given-names>DH</given-names>
          </name>
          <name>
            <surname>Beiko</surname>
            <given-names>RG</given-names>
          </name>
        </person-group>
        <article-title>Identifying biologically relevant differences between metagenomic communities</article-title>
        <source>Bioinformatics</source>
        <year>2010</year>
        <volume>26</volume>
        <fpage>715</fpage>
        <lpage>721</lpage>
        <pub-id pub-id-type="pmid">20130030</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B19">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Qin</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A human gut microbial gene catalogue established by metagenomic sequencing</article-title>
        <source>Nature</source>
        <year>2010</year>
        <volume>464</volume>
        <fpage>59</fpage>
        <lpage>65</lpage>
        <pub-id pub-id-type="pmid">20203603</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B20">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Qin</surname>
            <given-names>J</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A metagenome-wide association study of gut microbiota in type 2 diabetes</article-title>
        <source>Nature</source>
        <year>2012</year>
        <volume>490</volume>
        <fpage>55</fpage>
        <lpage>60</lpage>
        <pub-id pub-id-type="pmid">23023125</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B21">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Richter</surname>
            <given-names>DC</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>MetaSim: a sequencing simulator for genomics and metagenomics</article-title>
        <source>PLoS One</source>
        <year>2008</year>
        <volume>3</volume>
        <fpage>e3373</fpage>
        <pub-id pub-id-type="pmid">18841204</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B22">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Rizk</surname>
            <given-names>G</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>DSK: <italic>k</italic>-mer counting with very low memory usage</article-title>
        <source>Bioinformatics</source>
        <year>2013</year>
        <volume>29</volume>
        <fpage>652</fpage>
        <lpage>653</lpage>
        <pub-id pub-id-type="pmid">23325618</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B23">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Schloissnig</surname>
            <given-names>S</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Genomic variation landscape of the human gut microbiome</article-title>
        <source>Nature</source>
        <year>2013</year>
        <volume>493</volume>
        <fpage>45</fpage>
        <lpage>50</lpage>
        <pub-id pub-id-type="pmid">23222524</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B24">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Segata</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Metagenomic biomarker discovery and explanation</article-title>
        <source>Genome Biol.</source>
        <year>2011</year>
        <volume>12</volume>
        <fpage>R60</fpage>
        <pub-id pub-id-type="pmid">21702898</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B25">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Segata</surname>
            <given-names>N</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Metagenomic microbial community profiling using unique clade-specific marker genes</article-title>
        <source>Nat. Methods</source>
        <year>2012</year>
        <volume>9</volume>
        <fpage>811</fpage>
        <lpage>814</lpage>
        <pub-id pub-id-type="pmid">22688413</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B26">
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Smucker</surname>
            <given-names>MD</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>A comparison of statistical significance tests for information retrieval evaluation</article-title>
        <source>Proceedings of the Sixteenth ACM Conference on Conference on Information and Knowledge Management. CIKM’07</source>
        <year>2007</year>
        <publisher-loc>New York, NY</publisher-loc>
        <publisher-name>ACM</publisher-name>
        <fpage>623</fpage>
        <lpage>632</lpage>
      </element-citation>
    </ref>
    <ref id="btu340-B27">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Su</surname>
            <given-names>X</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Meta-Storms: efficient search for similar microbial communities based on a novel indexing scheme and similarity score for metagenomic data</article-title>
        <source>Bioinformatics</source>
        <year>2012</year>
        <volume>28</volume>
        <fpage>2493</fpage>
        <lpage>2501</lpage>
        <pub-id pub-id-type="pmid">22843983</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B28">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>Tyson</surname>
            <given-names>GW</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Community structure and metabolism through reconstruction of microbial genomes from the environment</article-title>
        <source>Nature</source>
        <year>2004</year>
        <volume>428</volume>
        <fpage>37</fpage>
        <lpage>43</lpage>
        <pub-id pub-id-type="pmid">14961025</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B29">
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Välimäki</surname>
            <given-names>N</given-names>
          </name>
          <name>
            <surname>Puglisi</surname>
            <given-names>SJ</given-names>
          </name>
        </person-group>
        <article-title>Distributed string mining for high-throughput sequencing data</article-title>
        <source>12th Workshop on Algorithms in Bioinformatics (WABI)</source>
        <year>2012</year>
        <comment>LNCS 7534, Springer-Verlag, pp. 441–452</comment>
      </element-citation>
    </ref>
    <ref id="btu340-B30">
      <element-citation publication-type="journal">
        <person-group person-group-type="author">
          <name>
            <surname>White</surname>
            <given-names>JR</given-names>
          </name>
          <etal/>
        </person-group>
        <article-title>Statistical methods for detecting differentially abundant features in clinical metagenomic samples</article-title>
        <source>PLoS Comput. Biol.</source>
        <year>2009</year>
        <volume>5</volume>
        <fpage>e1000352</fpage>
        <pub-id pub-id-type="pmid">19360128</pub-id>
      </element-citation>
    </ref>
    <ref id="btu340-B31">
      <element-citation publication-type="book">
        <person-group person-group-type="author">
          <name>
            <surname>Yang</surname>
            <given-names>Y</given-names>
          </name>
          <name>
            <surname>Pedersen</surname>
            <given-names>JO</given-names>
          </name>
        </person-group>
        <article-title>A comparative study on feature selection in text categorization</article-title>
        <source>Proceedings of the Fourteenth International Conference on Machine Learning (ICML’97)</source>
        <year>1997</year>
        <publisher-name>Morgan Kaufmann Publishers Inc.</publisher-name>
        <fpage>412</fpage>
        <lpage>420</lpage>
      </element-citation>
    </ref>
  </ref-list>
</back>
