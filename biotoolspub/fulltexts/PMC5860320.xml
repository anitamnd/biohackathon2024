<?properties open_access?>
<?DTDIdentifier.IdentifierValue -//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.1 20151215//EN?>
<?DTDIdentifier.IdentifierType public?>
<?SourceDTD.DTDName JATS-journalpublishing1.dtd?>
<?SourceDTD.Version 1.1?>
<?ConverterInfo.XSLTName jp2nlmx2.xsl?>
<?ConverterInfo.Version 1?>
<front>
  <journal-meta>
    <journal-id journal-id-type="nlm-ta">Bioinformatics</journal-id>
    <journal-id journal-id-type="iso-abbrev">Bioinformatics</journal-id>
    <journal-id journal-id-type="publisher-id">bioinformatics</journal-id>
    <journal-title-group>
      <journal-title>Bioinformatics</journal-title>
    </journal-title-group>
    <issn pub-type="ppub">1367-4803</issn>
    <issn pub-type="epub">1367-4811</issn>
    <publisher>
      <publisher-name>Oxford University Press</publisher-name>
    </publisher>
  </journal-meta>
  <article-meta>
    <article-id pub-id-type="pmcid">5860320</article-id>
    <article-id pub-id-type="pmid">28961740</article-id>
    <article-id pub-id-type="doi">10.1093/bioinformatics/btx500</article-id>
    <article-id pub-id-type="publisher-id">btx500</article-id>
    <article-categories>
      <subj-group subj-group-type="heading">
        <subject>Applications Notes</subject>
        <subj-group subj-group-type="category-toc-heading">
          <subject>Bioimage Informatics</subject>
        </subj-group>
      </subj-group>
    </article-categories>
    <title-group>
      <article-title>EMHP: an accurate automated hole masking algorithm for single-particle cryo-EM image processing</article-title>
    </title-group>
    <contrib-group>
      <contrib contrib-type="author">
        <name>
          <surname>Berndsen</surname>
          <given-names>Zachary</given-names>
        </name>
        <xref ref-type="author-notes" rid="btx500-FM2"/>
        <xref ref-type="aff" rid="btx500-aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <contrib-id contrib-id-type="orcid" authenticated="false">http://orcid.org/0000-0002-3255-0264</contrib-id>
        <name>
          <surname>Bowman</surname>
          <given-names>Charles</given-names>
        </name>
        <xref ref-type="corresp" rid="btx500-cor1"/>
        <xref ref-type="author-notes" rid="btx500-FM2"/>
        <!--<email>bowman@scripps.edu</email>-->
        <xref ref-type="aff" rid="btx500-aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Jang</surname>
          <given-names>Haerin</given-names>
        </name>
        <xref ref-type="aff" rid="btx500-aff1"/>
      </contrib>
      <contrib contrib-type="author">
        <name>
          <surname>Ward</surname>
          <given-names>Andrew B</given-names>
        </name>
        <xref ref-type="aff" rid="btx500-aff1"/>
      </contrib>
    </contrib-group>
    <contrib-group>
      <contrib contrib-type="editor">
        <name>
          <surname>Murphy</surname>
          <given-names>Robert</given-names>
        </name>
        <role>Associate Editor</role>
      </contrib>
    </contrib-group>
    <aff id="btx500-aff1">Department of Integrative Structural and Computational Biology, The Scripps Research Institute, La Jolla, CA, USA</aff>
    <author-notes>
      <corresp id="btx500-cor1">To whom correspondence should be addressed. Email: <email>bowman@scripps.edu</email></corresp>
      <fn id="btx500-FM2">
        <p>The authors wish it to be known that, in their opinion, Zachary Berndsen and Charles Bowman authors should be regarded as joint First Authors.</p>
      </fn>
    </author-notes>
    <pub-date pub-type="ppub">
      <day>01</day>
      <month>12</month>
      <year>2017</year>
    </pub-date>
    <pub-date pub-type="epub" iso-8601-date="2017-08-07">
      <day>07</day>
      <month>8</month>
      <year>2017</year>
    </pub-date>
    <pub-date pub-type="pmc-release">
      <day>07</day>
      <month>8</month>
      <year>2017</year>
    </pub-date>
    <!-- PMC Release delay is 0 months and 0 days and was based on the <pub-date pub-type="epub"/>. -->
    <volume>33</volume>
    <issue>23</issue>
    <fpage>3824</fpage>
    <lpage>3826</lpage>
    <history>
      <date date-type="received">
        <day>10</day>
        <month>3</month>
        <year>2017</year>
      </date>
      <date date-type="rev-recd">
        <day>17</day>
        <month>7</month>
        <year>2017</year>
      </date>
      <date date-type="accepted">
        <day>04</day>
        <month>8</month>
        <year>2017</year>
      </date>
    </history>
    <permissions>
      <copyright-statement>© The Author 2017. Published by Oxford University Press.</copyright-statement>
      <copyright-year>2017</copyright-year>
      <license xlink:href="http://creativecommons.org/licenses/by/4.0/" license-type="cc-by">
        <license-p>This is an Open Access article distributed under the terms of the Creative Commons Attribution License (<ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">http://creativecommons.org/licenses/by/4.0/</ext-link>), which permits unrestricted reuse, distribution, and reproduction in any medium, provided the original work is properly cited.</license-p>
      </license>
    </permissions>
    <self-uri xlink:href="btx500.pdf"/>
    <abstract>
      <title>Abstract</title>
      <sec id="s1">
        <title>Summary</title>
        <p>The Electron Microscopy Hole Punch (EMHP) is a streamlined suite of tools for quick assessment, sorting and hole masking of electron micrographs. With recent advances in single-particle electron cryo-microscopy (cryo-EM) data processing allowing for the rapid determination of protein structures using a smaller computational footprint, we saw the need for a fast and simple tool for data pre-processing that could run independent of existing high-performance computing (HPC) infrastructures. EMHP provides a data preprocessing platform in a small package that requires minimal python dependencies to function.</p>
      </sec>
      <sec id="s2">
        <title>Availability and implementation</title>
        <p><ext-link ext-link-type="uri" xlink:href="https://www.bitbucket.org/chazbot/emhp">https://www.bitbucket.org/chazbot/emhp</ext-link> Apache 2.0 License</p>
      </sec>
      <sec id="s4">
        <title>Supplementary information</title>
        <p><xref ref-type="supplementary-material" rid="sup1">Supplementary data</xref> are available at <italic>Bioinformatics</italic> online.</p>
      </sec>
    </abstract>
    <funding-group>
      <award-group award-type="grant">
        <funding-source>
          <named-content content-type="funder-name">Bill and Melinda Gates Foundation</named-content>
          <named-content content-type="funder-identifier">10.13039/100000865</named-content>
        </funding-source>
      </award-group>
    </funding-group>
    <counts>
      <page-count count="3"/>
    </counts>
  </article-meta>
</front>
<body>
  <sec>
    <title>1 Introduction</title>
    <p>The recent surge in popularity of single-particle cryo-EM as a tool for molecular structure determination alongside advances in software that have reduced the computational infrastructure needed to process single-particle datasets (<xref rid="btx500-B1" ref-type="bibr">Kimanius <italic>et al.</italic>, 2016</xref>) have created the need for a more streamlined suite of tools to locally facilitate initial data treatment and make processing more attainable at the workstation level.</p>
    <p>Current technical limitations inherent to the process of structure determination via single-particle cryo-EM require collecting very large datasets—often several thousands of images. This task is facilitated by automated imaging software, however downstream preprocessing steps such as quality assessment and masking of individual images are still performed manually by the researcher and can become quite cumbersome. EMHP focuses on streamlining this preprocessing stage—specifically image assessment, masking and pick filtering in preparation for single-particle analysis.</p>
    <p>The need for hole masking in images stems from the fundamentals of cryo-EM sample preparation and data processing. Samples are traditionally prepared for imaging by flash freezing a few microliters of solution on copper mesh grids coated in holey carbon. The hole patterns suspend particles in a thin meniscus of vitreous ice, ideal for high resolution imaging, and are often used by automated collection software to assist in exposure targeting. (<xref rid="btx500-B4" ref-type="bibr">Suloway <italic>et al.</italic>, 2005</xref>) While images are ideally taken entirely over these holes of thin ice, it is still often necessary to collect around the edges of the holes due to low particle densities, preferential particle distribution, or contrast transfer function (CTF) estimation limitations. For these reasons, many images in a cryo-EM dataset contain sections of thick carbon support present in one or more quadrants of the image.</p>
    <p>While automated particle selection algorithms allow for rapid selection of single particle projections from within larger images, these algorithms can have difficulty discriminating between particles on carbon and particles in ice, resulting in the inclusion of many false positives into the initial particle stack which can increase computation times and have adverse effects on downstream processing.</p>
    <p>Here we present a fast and accurate algorithm for detecting carbon supports in cryo-EM images, along with a small suite of tools for image assessment and pick filtering that allow users to preprocess their data rapidly and with minimal overhead while providing results in a format readable or easily converted to be readable by common single-particle cryo-EM processing packages. (<xref rid="btx500-B1" ref-type="bibr">Kimanius <italic>et al.</italic>, 2016</xref>, <xref rid="btx500-B5" ref-type="bibr">Tang <italic>et al.</italic>, 2007</xref>) Our algorithm shows improved performance over existing hole-finding algorithms and can be easily executed in a minimal or non-HPC environment making it more accessible to users.</p>
  </sec>
  <sec>
    <title>2 Software package overview</title>
    <p>The software included in the EMHP package is coded using Python 2.7 and relies on packages that are freely available. EMHP uses the .mrc file parser methods implemented in pyami via Appion, (<xref rid="btx500-B2" ref-type="bibr">Lander <italic>et al.</italic>, 2009</xref>) which are included in the code repository for convenience. The package includes a Tkinter-based GUI image assessor, an implementation of the automatic hole masker and particle filter, a Tkinter-based GUI for manual hole masking, and a script that applies already computed masks to images.</p>
    <sec>
      <title>2.1 Algorithm description</title>
      <p>We based our hole-finding algorithm on two main assumptions: that carbon holes are milled consistently to specifications and that edge of the holes have more detectable textural features than the vitreous ice and particles within. First, the image is decimated 10X, Gaussian filtered and normalized via contrast stretching (<xref ref-type="fig" rid="btx500-F1">Fig. 1A</xref>). Next, a standard Sobel filter is applied, which detects the many small edges along the rim of the carbon hole. (<xref ref-type="fig" rid="btx500-F1">Fig. 1B</xref>) A series of smoothing filters and thresholding operations are performed to amplify areas of concentrated signal produced during Sobel filtering, while diminishing sparse signal from particles or features in ice and on carbon. The first round of smoothing is performed on the image (<xref ref-type="fig" rid="btx500-F1">Fig. 1C</xref>), and all pixels below the first threshold parameter are set to zero. (<xref ref-type="fig" rid="btx500-F1">Fig. 1D</xref>) This image is then subjected to another round of smoothing and binarized using the second threshold value. (<xref ref-type="fig" rid="btx500-F1">Fig. 1E</xref>) We found that the first round smoothing and thresholding tends to eliminate signal from within the ice while the second round eliminates signal from within the carbon support. Finally, the image is decimated another 10X and a circle with dimensions set by the pixel size of the image and diameter of the hole is fit to the binary image with the assumption that the largest match will be along the carbon edge. The fitting is performed exhaustively Θ(n<sup>2</sup>), but is sped up considerably by the decimation steps. The coordinates of the best fit circle are then extrapolated back to the original image and the mask is shifted toward or away from the edge of the hole based on user input. This final binary mask is used to filter out particle picks that lie on top of the carbon support (<xref ref-type="fig" rid="btx500-F1">Fig. 1F</xref>). We have also included an option to filter picks that are within a user defined distance from the edge of the image, usually set to the desired box size used during single particle processing. Users can adjust several filter and threshold parameters to tune performance for their dataset, and we have found that the most impactful parameter is the intensity cutoff used in the second thresholding step, which controls the width and shape of the final binary edge used for circle fitting. Descriptions of all parameters and examples of their effects can be found in <xref ref-type="supplementary-material" rid="sup1">Supplementary Materials</xref>.
</p>
      <fig id="btx500-F1" orientation="portrait" position="float">
        <label>Fig. 1</label>
        <caption>
          <p>EMHP automasking example. The image after (<bold>A</bold>) Gaussian filter and contrast stretching, (<bold>B</bold>) after applying a Sobel filter, (<bold>C</bold>) after one round of smoothing, (<bold>D</bold>) after applying a user-defined threshold and (<bold>E</bold>) after another round of smoothing and binary thresholding. (<bold>F</bold>) The final image after circle fitting, masking and pick filtering. Green single particle picks are included, while red picks are excluded due to the mask or proximity to the edge</p>
        </caption>
        <graphic xlink:href="btx500f1"/>
      </fig>
    </sec>
    <sec>
      <title>2.2 Test dataset and methods</title>
      <p>For a concrete evaluation of the algorithm‘s effectiveness, we conducted two performance tests on a set of 100 images chosen at random from a previously published dataset covering a defocus range of -1.4 to -3.6 μm (<xref rid="btx500-B3" ref-type="bibr">Lee <italic>et al.</italic>, 2016</xref>). We compare performance of the most commonly used automasker, em_hole_finder<bold>,</bold> currently incorporated into the Appion web-based software suite (<xref rid="btx500-B2" ref-type="bibr">Lander <italic>et al.</italic>, 2009</xref>) with the EMHP automasking algorithm. To do this, masks were carefully constructed manually and a set of particle picks generated with DoG Picker (<xref rid="btx500-B6" ref-type="bibr">Voss <italic>et al.</italic>, 2009</xref>) were assigned to either ice or carbon. Next, both algorithms were used to classify the same set of picks and the sensitivity (true positive rate), specificity (true negative rate), and average runtime per image were calculated for each (<xref rid="btx500-T1" ref-type="table">Table 1</xref>). These 100 test images have been included in the code repository for testing and benchmarking.
<table-wrap id="btx500-T1" orientation="portrait" position="float"><label>Table 1.</label><caption><p>Benchmark comparisons using em_hole_finder and EMHP</p></caption><table frame="hsides" rules="groups"><colgroup span="1"><col valign="top" align="left" span="1"/><col valign="top" align="char" char="." span="1"/><col valign="top" align="char" char="." span="1"/><col valign="top" align="left" span="1"/></colgroup><thead><tr><th rowspan="1" colspan="1">Algorithm</th><th rowspan="1" colspan="1">Sensitivity</th><th rowspan="1" colspan="1">Specificity</th><th rowspan="1" colspan="1">Time/Image (s)</th></tr></thead><tbody><tr><td rowspan="1" colspan="1">EMHP</td><td rowspan="1" colspan="1">0.990</td><td rowspan="1" colspan="1">0.991</td><td rowspan="1" colspan="1">.44–3.17</td></tr><tr><td rowspan="1" colspan="1">em_hole_finder</td><td rowspan="1" colspan="1">0.785</td><td rowspan="1" colspan="1">0.990</td><td rowspan="1" colspan="1">1.34</td></tr></tbody></table><table-wrap-foot><fn id="tblfn1"><p><italic>Note</italic>: EMHP per-image calculation times reported as a range with the minimum bound representing the program run in multithreaded (16×) mode. This mode is not available in em_hole_finder at time of submission.</p></fn></table-wrap-foot></table-wrap></p>
      <p>To further justify the utility of masking we performed a single round of 2 D-classification using GPU-accelerated RELION-2.0 on the full particle stack from the test dataset, this same stack filtered using manually produced masks, and a stack that is the same size as the masked stack made from a random subset of particles. Around 40% of the particle picks were filtered out during masking, and it is therefore not surprising that 2 D-classification ran 1.8X faster, however the masked dataset still ran 1.1X faster than the unmasked dataset of equivalent size, illustrating that the inclusion of false positives does slow down 2 D-classification. Additionally, 36% of the particles selected after 2 D-classification from the unmasked data set were false positive picks on carbon, implying that 2 D-classification alone cannot completely sort out picks on carbon.</p>
    </sec>
  </sec>
  <sec>
    <title>3 Conclusions</title>
    <p>The EMHP automasking algorithm shows improved sensitivity compared to em_hole_finder. This highlights the main shortcoming of em_hole_finder, the tendency to over-mask thereby excluding a substantial number of true positives from the initial particle stack. The two algorithms performed equivalently in terms of specificity.</p>
    <p>We would like to note that over the course of testing and extensive in-house use, we found that the EMHP algorithm has trouble with edge detection in two specific situations: when carbon edges are poorly manufactured (overly jagged or un-circular), or when particle density at the very edge of the carbon holes is excessively high. In comparison, we observe that em_hole_finder does not have additional issues with poorly manufactured edges, but tends to over-mask when presented with dense patches of particles along the edges. To get around these performance limitations, the EMHP suite also includes tools for sorting images before masking and applying manually placed circular masks.</p>
    <p>Rapid advances in single-particle cryo-EM data processing software and hardware capabilities are bringing state-of-the-art structure determination capabilities to the desktop. EMHP provides a simple python package for single-particle cryo-EM image preprocessing that is accessible to users of all experience levels while requiring minimal computational overhead.</p>
  </sec>
  <sec>
    <title>Funding</title>
    <p>This work has been supported by the Bill and Melinda Gates Foundation and the Collaboration for AIDS Vaccine Discovery (OPP1115782).</p>
    <p><italic>Conflict of Interest</italic>: none declared.</p>
  </sec>
  <sec sec-type="supplementary-material">
    <title>Supplementary Material</title>
    <supplementary-material content-type="local-data" id="sup1">
      <label>Supplementary Data</label>
      <media xlink:href="btx500_emhp_supp_revised_sub.pdf">
        <caption>
          <p>Click here for additional data file.</p>
        </caption>
      </media>
    </supplementary-material>
  </sec>
</body>
<back>
  <ref-list>
    <title>References</title>
    <ref id="btx500-B1">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Kimanius</surname><given-names>D.</given-names></name></person-group><etal>et al</etal> (<year>2016</year>) 
<article-title>Accelerated cryo-EM structure determination with parallelisation using GPUs in RELION-2</article-title>. <source>eLife</source>, <volume>55</volume>, <fpage>e18722</fpage>.</mixed-citation>
    </ref>
    <ref id="btx500-B2">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Lander</surname><given-names>G.C.</given-names></name></person-group><etal>et al</etal> (<year>2009</year>) 
<article-title>Appion: an integrated, database-driven pipeline to facilitate EM image processing</article-title>. <source>J. Struct. Biol</source>., <volume>166</volume>, <fpage>95</fpage>–<lpage>102</lpage>.<pub-id pub-id-type="pmid">19263523</pub-id></mixed-citation>
    </ref>
    <ref id="btx500-B3">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Lee</surname><given-names>J.H.</given-names></name></person-group><etal>et al</etal> (<year>2016</year>) 
<article-title>Cryo-EM structure of a native, fully glycosylated, cleaved HIV-1 envelope trimer</article-title>. <source>Science</source>, <volume>351</volume>, <fpage>1043</fpage>–<lpage>1048</lpage>.<pub-id pub-id-type="pmid">26941313</pub-id></mixed-citation>
    </ref>
    <ref id="btx500-B4">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Suloway</surname><given-names>C.</given-names></name></person-group><etal>et al</etal> (<year>2005</year>) 
<article-title>Automated molecular microscopy: the new Leginon system</article-title>. <source>J. Struct. Biol</source>., <volume>151</volume>, <fpage>41</fpage>–<lpage>60</lpage>.<pub-id pub-id-type="pmid">15890530</pub-id></mixed-citation>
    </ref>
    <ref id="btx500-B5">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Tang</surname><given-names>G.</given-names></name></person-group><etal>et al</etal> (<year>2007</year>) 
<article-title>EMAN2: an extensible image processing suite for electron microscopy</article-title>. <source>J. Struct. Biol</source>., <volume>157</volume>, <fpage>38</fpage>–<lpage>46</lpage>.<pub-id pub-id-type="pmid">16859925</pub-id></mixed-citation>
    </ref>
    <ref id="btx500-B6">
      <mixed-citation publication-type="journal"><person-group person-group-type="author"><name name-style="western"><surname>Voss</surname><given-names>N.R.</given-names></name></person-group><etal>et al</etal> (<year>2009</year>) 
<article-title>DoG Picker and TiltPicker: software tools to facilitate particle selection in single particle electron microscopy</article-title>. <source>J. Struct. Biol</source>., <volume>166</volume>, <fpage>205</fpage>–<lpage>213</lpage>.<pub-id pub-id-type="pmid">19374019</pub-id></mixed-citation>
    </ref>
  </ref-list>
</back>
